{
    "active_lock_reason": null,
    "assignee": null,
    "assignees": [],
    "author_association": "NONE",
    "body": "### Description\n\n(I'm using Neovim v0.11.2 + LazyVim + Mason pinned to v1. IIRC there are still some unresolved issues with the new vim.lsp ecosystem, so first, sorry if this issue doesn't belong here.)\n\nlspconfig correctly adds `yarn exec` upon first start https://github.com/neovim/nvim-lspconfig/blob/036885e8e5456d3907626b634693234f628afef6/lua/lspconfig/configs/eslint.lua#L129:\n```\n> vim.lsp.get_clients({ name = 'eslint' })[1].config.cmd\n< { \"yarn\", \"exec\", \"vscode-eslint-language-server\", \"--stdio\" }\n> vim.lsp._enabled_configs\n< {}\n```\nAnd I could confirm the command with `ps aux`.\n\nHowever after executing `:LspRestart eslint`,\n```\n> vim.lsp.get_clients({ name = 'eslint' })[1].config.cmd\n< { \"yarn\", \"exec\", \"vscode-eslint-language-server\", \"--stdio\" }\n> vim.lsp._enabled_configs.eslint.resolved_config.cmd\n< { \"vscode-eslint-language-server\", \"--stdio\" }\n```\n`vim.lsp._enabled_configs` somehow got populated with an `eslint.resolved_config`, where `cmd` didn't have the `yarn exec` prefix. I'd see an '[lspconfig] Unable to find ESLint library.' notification, and `ps aux` also said the vscode-eslint-language-server was executed with `node` directly.\n\nI understand 'The configs in this repo are UNSUPPORTED and provided only as a starting point', but this might be some more generic issue with built-in LSP and config modifications in `on_new_config`?\n\nI'm also aware of https://github.com/neovim/nvim-lspconfig/issues/3705 and https://github.com/neovim/neovim/issues/32287, but I'm not entirely sure if it's something that'll resolve this problem and whether there's anything we can do in the interim?",
    "closed_at": null,
    "closed_by": null,
    "comment_data": [
        {
            "author_association": "MEMBER",
            "body": "is this the same as https://github.com/neovim/nvim-lspconfig/issues/3858 ?\n\nanything in `nvim-lspconfig/lua/lspconfig/*` is deprecated. so it's more useful to discussion the `lsp/*` case, which based on that issue has the same problem.",
            "created_at": "2025-06-06T12:37:12Z",
            "html_url": "https://github.com/neovim/nvim-lspconfig/issues/3889#issuecomment-2949136962",
            "id": 2949136962,
            "issue_url": "https://api.github.com/repos/neovim/nvim-lspconfig/issues/3889",
            "node_id": "IC_kwDODTQC186vyEJC",
            "performed_via_github_app": null,
            "reactions": {
                "+1": 0,
                "-1": 0,
                "confused": 0,
                "eyes": 0,
                "heart": 0,
                "hooray": 0,
                "laugh": 0,
                "rocket": 0,
                "total_count": 0,
                "url": "https://api.github.com/repos/neovim/nvim-lspconfig/issues/comments/2949136962/reactions"
            },
            "updated_at": "2025-06-06T12:37:12Z",
            "url": "https://api.github.com/repos/neovim/nvim-lspconfig/issues/comments/2949136962",
            "user": {
                "avatar_url": "https://avatars.githubusercontent.com/u/1359421?v=4",
                "events_url": "https://api.github.com/users/justinmk/events{/privacy}",
                "followers_url": "https://api.github.com/users/justinmk/followers",
                "following_url": "https://api.github.com/users/justinmk/following{/other_user}",
                "gists_url": "https://api.github.com/users/justinmk/gists{/gist_id}",
                "gravatar_id": "",
                "html_url": "https://github.com/justinmk",
                "id": 1359421,
                "login": "justinmk",
                "node_id": "MDQ6VXNlcjEzNTk0MjE=",
                "organizations_url": "https://api.github.com/users/justinmk/orgs",
                "received_events_url": "https://api.github.com/users/justinmk/received_events",
                "repos_url": "https://api.github.com/users/justinmk/repos",
                "site_admin": false,
                "starred_url": "https://api.github.com/users/justinmk/starred{/owner}{/repo}",
                "subscriptions_url": "https://api.github.com/users/justinmk/subscriptions",
                "type": "User",
                "url": "https://api.github.com/users/justinmk",
                "user_view_type": "public"
            }
        },
        {
            "author_association": "NONE",
            "body": "> is this the same as [#3858](https://github.com/neovim/nvim-lspconfig/issues/3858) ?\n\nI saw #3858 too but I don't think it's the same issue. In #3858, they couldn't get eslint running at all without the tweaks they mentioned, while I only have issue restarting eslint. It also seems that their issue only happens with the new vim.lsp.config API.\n\nI can use the config below and my playground project at https://github.com/Frederick888/playground/tree/eslint-yarn4 to reproduce both:\n\n```lua\n-- DO NOT change the paths and don't remove the colorscheme\nlocal root = vim.fn.fnamemodify('./.repro', ':p')\n\n-- set stdpaths to use .repro\nfor _, name in ipairs({ 'config', 'data', 'state', 'cache' }) do\n  vim.env[('XDG_%s_HOME'):format(name:upper())] = root .. '/' .. name\nend\n\n-- bootstrap lazy\nlocal lazypath = root .. '/plugins/lazy.nvim'\nif not vim.loop.fs_stat(lazypath) then\n  vim.fn.system({ 'git', 'clone', '--filter=blob:none', 'https://github.com/folke/lazy.nvim.git', lazypath })\nend\nvim.opt.runtimepath:prepend(lazypath)\n\n-- install plugins\nlocal plugins = {\n  \"folke/tokyonight.nvim\",\n  -- add any other plugins here\n  \"neovim/nvim-lspconfig\"\n}\nrequire(\"lazy\").setup(plugins, {\n  root = root .. \"/plugins\",\n})\n\nvim.cmd.colorscheme(\"tokyonight\")\n-- add anything else here\n\n-- reproduce https://github.com/neovim/nvim-lspconfig/issues/3858 with:\n-- vim.lsp.enable('eslint')\n-- reproduce https://github.com/neovim/nvim-lspconfig/issues/3889 with:\nrequire('lspconfig').eslint.setup({})\n```\n\nClone the playground project, set up corepack, run `yarn install`, and finally `nvim -u repro.lua packages/shared/src/index.ts`.\n\nI also did a bisect for my own issue, and e4d1c8bf9077ecf617ce18f27738658a7d76ac95 was the first bad commit. Perhaps it's not a good idea to use Neovim v0.11.2+ with the legacy API.",
            "created_at": "2025-06-06T14:25:51Z",
            "html_url": "https://github.com/neovim/nvim-lspconfig/issues/3889#issuecomment-2949431926",
            "id": 2949431926,
            "issue_url": "https://api.github.com/repos/neovim/nvim-lspconfig/issues/3889",
            "node_id": "IC_kwDODTQC186vzMJ2",
            "performed_via_github_app": null,
            "reactions": {
                "+1": 0,
                "-1": 0,
                "confused": 0,
                "eyes": 0,
                "heart": 0,
                "hooray": 0,
                "laugh": 0,
                "rocket": 0,
                "total_count": 0,
                "url": "https://api.github.com/repos/neovim/nvim-lspconfig/issues/comments/2949431926/reactions"
            },
            "updated_at": "2025-06-06T14:25:51Z",
            "url": "https://api.github.com/repos/neovim/nvim-lspconfig/issues/comments/2949431926",
            "user": {
                "avatar_url": "https://avatars.githubusercontent.com/u/4507647?v=4",
                "events_url": "https://api.github.com/users/Frederick888/events{/privacy}",
                "followers_url": "https://api.github.com/users/Frederick888/followers",
                "following_url": "https://api.github.com/users/Frederick888/following{/other_user}",
                "gists_url": "https://api.github.com/users/Frederick888/gists{/gist_id}",
                "gravatar_id": "",
                "html_url": "https://github.com/Frederick888",
                "id": 4507647,
                "login": "Frederick888",
                "node_id": "MDQ6VXNlcjQ1MDc2NDc=",
                "organizations_url": "https://api.github.com/users/Frederick888/orgs",
                "received_events_url": "https://api.github.com/users/Frederick888/received_events",
                "repos_url": "https://api.github.com/users/Frederick888/repos",
                "site_admin": false,
                "starred_url": "https://api.github.com/users/Frederick888/starred{/owner}{/repo}",
                "subscriptions_url": "https://api.github.com/users/Frederick888/subscriptions",
                "type": "User",
                "url": "https://api.github.com/users/Frederick888",
                "user_view_type": "public"
            }
        },
        {
            "author_association": "MEMBER",
            "body": "> Perhaps it's not a good idea to use Neovim v0.11.2+ with the legacy API.\n\nIt should work just fine. But everything in `lua/lspconfig/*` will be deleted, so fixing any issues there is low-priority, though PR welcome.",
            "created_at": "2025-06-06T16:57:44Z",
            "html_url": "https://github.com/neovim/nvim-lspconfig/issues/3889#issuecomment-2949877639",
            "id": 2949877639,
            "issue_url": "https://api.github.com/repos/neovim/nvim-lspconfig/issues/3889",
            "node_id": "IC_kwDODTQC186v04-H",
            "performed_via_github_app": null,
            "reactions": {
                "+1": 0,
                "-1": 0,
                "confused": 0,
                "eyes": 0,
                "heart": 0,
                "hooray": 0,
                "laugh": 0,
                "rocket": 0,
                "total_count": 0,
                "url": "https://api.github.com/repos/neovim/nvim-lspconfig/issues/comments/2949877639/reactions"
            },
            "updated_at": "2025-06-06T16:57:44Z",
            "url": "https://api.github.com/repos/neovim/nvim-lspconfig/issues/comments/2949877639",
            "user": {
                "avatar_url": "https://avatars.githubusercontent.com/u/1359421?v=4",
                "events_url": "https://api.github.com/users/justinmk/events{/privacy}",
                "followers_url": "https://api.github.com/users/justinmk/followers",
                "following_url": "https://api.github.com/users/justinmk/following{/other_user}",
                "gists_url": "https://api.github.com/users/justinmk/gists{/gist_id}",
                "gravatar_id": "",
                "html_url": "https://github.com/justinmk",
                "id": 1359421,
                "login": "justinmk",
                "node_id": "MDQ6VXNlcjEzNTk0MjE=",
                "organizations_url": "https://api.github.com/users/justinmk/orgs",
                "received_events_url": "https://api.github.com/users/justinmk/received_events",
                "repos_url": "https://api.github.com/users/justinmk/repos",
                "site_admin": false,
                "starred_url": "https://api.github.com/users/justinmk/starred{/owner}{/repo}",
                "subscriptions_url": "https://api.github.com/users/justinmk/subscriptions",
                "type": "User",
                "url": "https://api.github.com/users/justinmk",
                "user_view_type": "public"
            }
        },
        {
            "author_association": "NONE",
            "body": "I just spent a bit more time on this and realised actually both this and #3858 were caused by the fact that `before_init` cannot modify `config.cmd`, which is already part of the discussion at https://github.com/neovim/neovim/issues/32287 (code ref: https://github.com/neovim/neovim/blob/93925fe0208fcd640eb6c5f2822f994a427f3795/runtime/lua/vim/lsp/client.lua#L456-L466).\n\nI could add a few hacky lines into that file and both issues would go away:\n```diff\ndiff --git a/runtime/lua/vim/lsp/client.lua b/runtime/lua/vim/lsp/client.lua\nindex 1f88524..533ff6b 100644\n--- a/runtime/lua/vim/lsp/client.lua\n+++ b/runtime/lua/vim/lsp/client.lua\n@@ -453,8 +453,11 @@ function Client.create(config)\n     end,\n   }\n \n   -- Start the RPC client.\n+  if type(config.before_init) == 'function' then\n+    config.before_init({}, config)\n+  end\n   local config_cmd = config.cmd\n   if type(config_cmd) == 'function' then\n     self.rpc = config_cmd(dispatchers)\n   else\n```\n\nAs per the discussion, the Yarn PnP detection should be made part of `config.cmd` using its function form. However that can't be easily done as it needs the `root_dir` in string, which is only [resolved](https://github.com/neovim/neovim/blob/93925fe0208fcd640eb6c5f2822f994a427f3795/runtime/lua/vim/lsp.lua#L558) later through `vim.lsp.start()`'s `FileType` autocmd by calling the `root_dir` function in `lsp/eslint.lua`.\n\nThe best remedy I have right now is to always use cwd or something here:\n\n```diff\ndiff --git a/lsp/eslint.lua b/lsp/eslint.lua\nindex 61c00e0..d925ba0 100644\n--- a/lsp/eslint.lua\n+++ b/lsp/eslint.lua\n@@ -34,9 +34,21 @@\n local util = require 'lspconfig.util'\n local lsp = vim.lsp\n \n return {\n-  cmd = { 'vscode-eslint-language-server', '--stdio' },\n+  cmd = function(dispatchers)\n+    local eslint_cmd = { 'vscode-eslint-language-server', '--stdio' }\n+    local root_dir = vim.uv.cwd()\n+\n+    -- Support Yarn2 (PnP) projects\n+    local pnp_cjs = root_dir .. '/.pnp.cjs'\n+    local pnp_js = root_dir .. '/.pnp.js'\n+    if vim.uv.fs_stat(pnp_cjs) or vim.uv.fs_stat(pnp_js) then\n+      eslint_cmd = { 'yarn', 'exec', unpack(eslint_cmd) }\n+    end\n+\n+    return vim.lsp.rpc.start(eslint_cmd, dispatchers)\n+  end,\n   filetypes = {\n     'javascript',\n     'javascriptreact',\n     'javascript.jsx',\n@@ -146,16 +158,8 @@ return {\n           config.settings.experimental.useFlatConfig = true\n           break\n         end\n       end\n-\n-      -- Support Yarn2 (PnP) projects\n-      local pnp_cjs = root_dir .. '/.pnp.cjs'\n-      local pnp_js = root_dir .. '/.pnp.js'\n-      if vim.uv.fs_stat(pnp_cjs) or vim.uv.fs_stat(pnp_js) then\n-        local cmd = config.cmd\n-        config.cmd = vim.list_extend({ 'yarn', 'exec' }, cmd)\n-      end\n     end\n   end,\n   handlers = {\n     ['eslint/openDoc'] = function(_, result)\n```\n\nI'm not sure if we should do this or wait for a potentially better option from https://github.com/neovim/neovim/issues/32287.",
            "created_at": "2025-06-10T10:29:02Z",
            "html_url": "https://github.com/neovim/nvim-lspconfig/issues/3889#issuecomment-2958573165",
            "id": 2958573165,
            "issue_url": "https://api.github.com/repos/neovim/nvim-lspconfig/issues/3889",
            "node_id": "IC_kwDODTQC186wWD5t",
            "performed_via_github_app": null,
            "reactions": {
                "+1": 0,
                "-1": 0,
                "confused": 0,
                "eyes": 0,
                "heart": 0,
                "hooray": 0,
                "laugh": 0,
                "rocket": 0,
                "total_count": 0,
                "url": "https://api.github.com/repos/neovim/nvim-lspconfig/issues/comments/2958573165/reactions"
            },
            "updated_at": "2025-06-10T10:29:02Z",
            "url": "https://api.github.com/repos/neovim/nvim-lspconfig/issues/comments/2958573165",
            "user": {
                "avatar_url": "https://avatars.githubusercontent.com/u/4507647?v=4",
                "events_url": "https://api.github.com/users/Frederick888/events{/privacy}",
                "followers_url": "https://api.github.com/users/Frederick888/followers",
                "following_url": "https://api.github.com/users/Frederick888/following{/other_user}",
                "gists_url": "https://api.github.com/users/Frederick888/gists{/gist_id}",
                "gravatar_id": "",
                "html_url": "https://github.com/Frederick888",
                "id": 4507647,
                "login": "Frederick888",
                "node_id": "MDQ6VXNlcjQ1MDc2NDc=",
                "organizations_url": "https://api.github.com/users/Frederick888/orgs",
                "received_events_url": "https://api.github.com/users/Frederick888/received_events",
                "repos_url": "https://api.github.com/users/Frederick888/repos",
                "site_admin": false,
                "starred_url": "https://api.github.com/users/Frederick888/starred{/owner}{/repo}",
                "subscriptions_url": "https://api.github.com/users/Frederick888/subscriptions",
                "type": "User",
                "url": "https://api.github.com/users/Frederick888",
                "user_view_type": "public"
            }
        },
        {
            "author_association": "MEMBER",
            "body": "> The best remedy I have right now is to always use cwd or something here:\n\nUsing CWD is fragile, but if the eslint LS requires a CLI arg then there is no other way to handle this. So, your patch LGTM, pr welcome.",
            "created_at": "2025-06-10T14:08:51Z",
            "html_url": "https://github.com/neovim/nvim-lspconfig/issues/3889#issuecomment-2959410872",
            "id": 2959410872,
            "issue_url": "https://api.github.com/repos/neovim/nvim-lspconfig/issues/3889",
            "node_id": "IC_kwDODTQC186wZQa4",
            "performed_via_github_app": null,
            "reactions": {
                "+1": 0,
                "-1": 0,
                "confused": 0,
                "eyes": 0,
                "heart": 0,
                "hooray": 0,
                "laugh": 0,
                "rocket": 0,
                "total_count": 0,
                "url": "https://api.github.com/repos/neovim/nvim-lspconfig/issues/comments/2959410872/reactions"
            },
            "updated_at": "2025-06-10T14:08:51Z",
            "url": "https://api.github.com/repos/neovim/nvim-lspconfig/issues/comments/2959410872",
            "user": {
                "avatar_url": "https://avatars.githubusercontent.com/u/1359421?v=4",
                "events_url": "https://api.github.com/users/justinmk/events{/privacy}",
                "followers_url": "https://api.github.com/users/justinmk/followers",
                "following_url": "https://api.github.com/users/justinmk/following{/other_user}",
                "gists_url": "https://api.github.com/users/justinmk/gists{/gist_id}",
                "gravatar_id": "",
                "html_url": "https://github.com/justinmk",
                "id": 1359421,
                "login": "justinmk",
                "node_id": "MDQ6VXNlcjEzNTk0MjE=",
                "organizations_url": "https://api.github.com/users/justinmk/orgs",
                "received_events_url": "https://api.github.com/users/justinmk/received_events",
                "repos_url": "https://api.github.com/users/justinmk/repos",
                "site_admin": false,
                "starred_url": "https://api.github.com/users/justinmk/starred{/owner}{/repo}",
                "subscriptions_url": "https://api.github.com/users/justinmk/subscriptions",
                "type": "User",
                "url": "https://api.github.com/users/justinmk",
                "user_view_type": "public"
            }
        }
    ],
    "comments": 5,
    "comments_url": "https://api.github.com/repos/neovim/nvim-lspconfig/issues/3889/comments",
    "created_at": "2025-06-05T02:27:08Z",
    "events_url": "https://api.github.com/repos/neovim/nvim-lspconfig/issues/3889/events",
    "html_url": "https://github.com/neovim/nvim-lspconfig/issues/3889",
    "id": 3119638890,
    "labels": [
        {
            "color": "f9d0c4",
            "default": true,
            "description": "Something isn't working",
            "id": 1674892761,
            "name": "bug",
            "node_id": "MDU6TGFiZWwxNjc0ODkyNzYx",
            "url": "https://api.github.com/repos/neovim/nvim-lspconfig/labels/bug"
        }
    ],
    "labels_url": "https://api.github.com/repos/neovim/nvim-lspconfig/issues/3889/labels{/name}",
    "locked": false,
    "milestone": null,
    "node_id": "I_kwDODTQC18658elq",
    "number": 3889,
    "performed_via_github_app": null,
    "reactions": {
        "+1": 0,
        "-1": 0,
        "confused": 0,
        "eyes": 0,
        "heart": 0,
        "hooray": 0,
        "laugh": 0,
        "rocket": 0,
        "total_count": 0,
        "url": "https://api.github.com/repos/neovim/nvim-lspconfig/issues/3889/reactions"
    },
    "repository_url": "https://api.github.com/repos/neovim/nvim-lspconfig",
    "state": "open",
    "state_reason": null,
    "sub_issues_summary": {
        "completed": 0,
        "percent_completed": 0,
        "total": 0
    },
    "timeline_url": "https://api.github.com/repos/neovim/nvim-lspconfig/issues/3889/timeline",
    "title": "`:LspRestart eslint` results in 'Unable to find ESLint library' when using Yarn PnP (using lua/lspconfig/ with Nvim 0.11.2)",
    "type": null,
    "updated_at": "2025-06-10T14:08:51Z",
    "url": "https://api.github.com/repos/neovim/nvim-lspconfig/issues/3889",
    "user": {
        "avatar_url": "https://avatars.githubusercontent.com/u/4507647?v=4",
        "events_url": "https://api.github.com/users/Frederick888/events{/privacy}",
        "followers_url": "https://api.github.com/users/Frederick888/followers",
        "following_url": "https://api.github.com/users/Frederick888/following{/other_user}",
        "gists_url": "https://api.github.com/users/Frederick888/gists{/gist_id}",
        "gravatar_id": "",
        "html_url": "https://github.com/Frederick888",
        "id": 4507647,
        "login": "Frederick888",
        "node_id": "MDQ6VXNlcjQ1MDc2NDc=",
        "organizations_url": "https://api.github.com/users/Frederick888/orgs",
        "received_events_url": "https://api.github.com/users/Frederick888/received_events",
        "repos_url": "https://api.github.com/users/Frederick888/repos",
        "site_admin": false,
        "starred_url": "https://api.github.com/users/Frederick888/starred{/owner}{/repo}",
        "subscriptions_url": "https://api.github.com/users/Frederick888/subscriptions",
        "type": "User",
        "url": "https://api.github.com/users/Frederick888",
        "user_view_type": "public"
    }
}