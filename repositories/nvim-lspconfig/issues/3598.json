{
    "active_lock_reason": null,
    "assignee": null,
    "assignees": [],
    "author_association": "NONE",
    "body": "### Summary\n\nLSPs started in single file mode are passed `workspace/didChangeWorkspaceFolders` which causes them to scan the whole disk.\n\n### Description\n\nMinimal vimrc:\n\n```\n-- Bootstrap lazy.nvim\nlocal lazypath = vim.fn.stdpath(\"data\") .. \"/lazy/lazy.nvim\"\nif not (vim.uv or vim.loop).fs_stat(lazypath) then\n  local lazyrepo = \"https://github.com/folke/lazy.nvim.git\"\n  local out = vim.fn.system({ \"git\", \"clone\", \"--filter=blob:none\", \"--branch=stable\", lazyrepo, lazypath })\n  if vim.v.shell_error ~= 0 then\n    vim.api.nvim_echo({\n      { \"Failed to clone lazy.nvim:\\n\", \"ErrorMsg\" },\n      { out, \"WarningMsg\" },\n      { \"\\nPress any key to exit...\" },\n    }, true, {})\n    vim.fn.getchar()\n    os.exit(1)\n  end\nend\nvim.opt.rtp:prepend(lazypath)\n\nvim.lsp.set_log_level(\"debug\")\n\nrequire(\"lazy\").setup({\n    { \"neovim/nvim-lspconfig\",\n      config = function()\n\trequire(\"lspconfig\").pyright.setup {\n\t\ton_attach = on_attach,\n\t}\n      end,\n    }\n})\n```\n\nRelevant parts of lsp.log\n\n```\n[DEBUG][2025-01-31 19:04:04] .../vim/lsp/rpc.lua:286\t\"rpc.send\"\t{  id = 1,  jsonrpc = \"2.0\",  method = \"initialize\",  params = {    capabilities = {      general = {        positionEncodings = { \"utf-16\" }      },      textDocument = {        callHierarchy = {          dynamicRegistration = false        },        codeAction = {          codeActionLiteralSupport = {            codeActionKind = {              valueSet = { \"\", \"quickfix\", \"refactor\", \"refactor.extract\", \"refactor.inline\", \"refactor.rewrite\", \"source\", \"source.organizeImports\" }            }          },          dataSupport = true,          dynamicRegistration = true,          isPreferredSupport = true,          resolveSupport = {            properties = { \"edit\" }          }        },        completion = {          completionItem = {            commitCharactersSupport = false,            deprecatedSupport = false,            documentationFormat = { \"markdown\", \"plaintext\" },            preselectSupport = false,            snippetSupport = false          },          completionItemKind = {            valueSet = { 1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13, 14, 15, 16, 17, 18, 19, 20, 21, 22, 23, 24, 25 }          },          completionList = {            itemDefaults = { \"editRange\", \"insertTextFormat\", \"insertTextMode\", \"data\" }          },          contextSupport = false,          dynamicRegistration = false        },        declaration = {          linkSupport = true        },        definition = {          dynamicRegistration = true,          linkSupport = true        },        diagnostic = {          dynamicRegistration = false        },        documentHighlight = {          dynamicRegistration = false        },        documentSymbol = {          dynamicRegistration = false,          hierarchicalDocumentSymbolSupport = true,          symbolKind = {            valueSet = { 1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13, 14, 15, 16, 17, 18, 19, 20, 21, 22, 23, 24, 25, 26 }          }        },        formatting = {          dynamicRegistration = true        },        hover = {          contentFormat = { \"markdown\", \"plaintext\" },          dynamicRegistration = true        },        implementation = {          linkSupport = true        },        inlayHint = {          dynamicRegistration = true,          resolveSupport = {            properties = { \"textEdits\", \"tooltip\", \"location\", \"command\" }          }        },        publishDiagnostics = {          dataSupport = true,          relatedInformation = true,          tagSupport = {            valueSet = { 1, 2 }          }        },        rangeFormatting = {          dynamicRegistration = true        },        references = {          dynamicRegistration = false        },        rename = {          dynamicRegistration = true,          prepareSupport = true        },        semanticTokens = {          augmentsSyntaxTokens = true,          dynamicRegistration = false,          formats = { \"relative\" },          multilineTokenSupport = false,          overlappingTokenSupport = true,          requests = {            full = {              delta = true            },            range = false          },          serverCancelSupport = false,          tokenModifiers = { \"declaration\", \"definition\", \"readonly\", \"static\", \"deprecated\", \"abstract\", \"async\", \"modification\", \"documentation\", \"defaultLibrary\" },          tokenTypes = { \"namespace\", \"type\", \"class\", \"enum\", \"interface\", \"struct\", \"typeParameter\", \"parameter\", \"variable\", \"property\", \"enumMember\", \"event\", \"function\", \"method\", \"macro\", \"keyword\", \"modifier\", \"comment\", \"string\", \"number\", \"regexp\", \"operator\", \"decorator\" }        },        signatureHelp = {          dynamicRegistration = false,          signatureInformation = {            activeParameterSupport = true,            documentationFormat = { \"markdown\", \"plaintext\" },            parameterInformation = {              labelOffsetSupport = true            }          }        },        synchronization = {          didSave = true,          dynamicRegistration = false,          willSave = true,          willSaveWaitUntil = true        },        typeDefinition = {          linkSupport = true        }      },      window = {        showDocument = {          support = true        },        showMessage = {          messageActionItem = {            additionalPropertiesSupport = false          }        },        workDoneProgress = true      },      workspace = {        applyEdit = true,        configuration = true,        didChangeConfiguration = {          dynamicRegistration = false        },        didChangeWatchedFiles = {          dynamicRegistration = true,          relativePatternSupport = true        },        inlayHint = {          refreshSupport = true        },        semanticTokens = {          refreshSupport = true        },        symbol = {          dynamicRegistration = false,          symbolKind = {            valueSet = { 1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13, 14, 15, 16, 17, 18, 19, 20, 21, 22, 23, 24, 25, 26 }          }        },        workspaceEdit = {          resourceOperations = { \"rename\", \"create\", \"delete\" }        },        workspaceFolders = true      }    },    clientInfo = {      name = \"Neovim\",      version = \"0.10.4\"    },    initializationOptions = vim.empty_dict(),    processId = 19623,    rootPath = vim.NIL,    rootUri = vim.NIL,    trace = \"off\",    workDoneToken = \"1\",    workspaceFolders = vim.NIL  }}\n```\n\nThe LSP is correctly started with rootPath = nil and workspaceFolders = nil. \n\nImmediately afterwards though, we have a:\n\n```\n[DEBUG][2025-01-31 19:04:04] .../vim/lsp/rpc.lua:286\t\"rpc.send\"\t{  jsonrpc = \"2.0\",  method = \"workspace/didChangeWorkspaceFolders\",  params = {    event = {      added = { {          name = \"/Users/xrisk\",          uri = \"file:///Users/xrisk\"        } },      removed = {}    }  }}\n```\n\nAfter which Pyright starts scanning all the files in my disk. A random example:\n\n```\n[DEBUG][2025-01-31 19:04:08] .../vim/lsp/rpc.lua:286\t\"rpc.send\"\t{  jsonrpc = \"2.0\",  method = \"workspace/didChangeWatchedFiles\",  params = {    changes = { {        type = 1,        uri = \"file:///Users/xrisk/Library/Preferences/ContextStoreAgent.plist\"      } }  }}\n```\n\nSome relevant parts from manager.lua that seem responsible are:\n\nhttps://github.com/neovim/nvim-lspconfig/blob/ead2fbc4893fdd062e1dd0842679a48bfb7bac5c/lua/lspconfig/manager.lua#L104-L106\n\nwhich seems to unconditionally trigger a `_notify_workspace_folder_added`, without checking the value of `single_file`.\n\nCommenting out this block seems to fix this issue.\n\nSome other problematic parts seem to be:\n\nhttps://github.com/neovim/nvim-lspconfig/blob/ead2fbc4893fdd062e1dd0842679a48bfb7bac5c/lua/lspconfig/manager.lua#L134-L142\n\nWhich attaches a workspace folder when reusing a client, without checking the value of `single_file`. `root_dir` here is the “pseudo-root”, so is not NIL.\n\n\n——\n\nIt seems that this bit of the code is deprecated though (https://github.com/neovim/nvim-lspconfig/issues/3531#issuecomment-2565863378). I can send a PR for this, otherwise.\n\n                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           \n\n",
    "closed_at": null,
    "closed_by": null,
    "comment_data": [
        {
            "author_association": "NONE",
            "body": "FYI, this does not reproduce with the new vim.lsp api.\n\n```\nvim.lsp.config.basedpyright = {\n  cmd = {\n    'basedpyright-langserver',\n    '--stdio',\n  },\n  root_markers = { '.pyrightconfig.json', 'pyproject.toml' },\n  filetypes = { 'python' },\n}\n\nvim.lsp.enable('basedpyright’)\n```",
            "created_at": "2025-01-31T15:11:11Z",
            "html_url": "https://github.com/neovim/nvim-lspconfig/issues/3598#issuecomment-2627580074",
            "id": 2627580074,
            "issue_url": "https://api.github.com/repos/neovim/nvim-lspconfig/issues/3598",
            "node_id": "IC_kwDODTQC186cnbCq",
            "performed_via_github_app": null,
            "reactions": {
                "+1": 0,
                "-1": 0,
                "confused": 0,
                "eyes": 0,
                "heart": 0,
                "hooray": 0,
                "laugh": 0,
                "rocket": 0,
                "total_count": 0,
                "url": "https://api.github.com/repos/neovim/nvim-lspconfig/issues/comments/2627580074/reactions"
            },
            "updated_at": "2025-01-31T15:11:11Z",
            "url": "https://api.github.com/repos/neovim/nvim-lspconfig/issues/comments/2627580074",
            "user": {
                "avatar_url": "https://avatars.githubusercontent.com/u/10669859?v=4",
                "events_url": "https://api.github.com/users/xrisk/events{/privacy}",
                "followers_url": "https://api.github.com/users/xrisk/followers",
                "following_url": "https://api.github.com/users/xrisk/following{/other_user}",
                "gists_url": "https://api.github.com/users/xrisk/gists{/gist_id}",
                "gravatar_id": "",
                "html_url": "https://github.com/xrisk",
                "id": 10669859,
                "login": "xrisk",
                "node_id": "MDQ6VXNlcjEwNjY5ODU5",
                "organizations_url": "https://api.github.com/users/xrisk/orgs",
                "received_events_url": "https://api.github.com/users/xrisk/received_events",
                "repos_url": "https://api.github.com/users/xrisk/repos",
                "site_admin": false,
                "starred_url": "https://api.github.com/users/xrisk/starred{/owner}{/repo}",
                "subscriptions_url": "https://api.github.com/users/xrisk/subscriptions",
                "type": "User",
                "url": "https://api.github.com/users/xrisk",
                "user_view_type": "public"
            }
        },
        {
            "author_association": "MEMBER",
            "body": "\n\nTry `vim.lsp.config` in Nvim 0.11 (unreleased) https://github.com/neovim/neovim/pull/31031 \n",
            "created_at": "2025-01-31T17:19:18Z",
            "html_url": "https://github.com/neovim/nvim-lspconfig/issues/3598#issuecomment-2627848988",
            "id": 2627848988,
            "issue_url": "https://api.github.com/repos/neovim/nvim-lspconfig/issues/3598",
            "node_id": "IC_kwDODTQC186cocsc",
            "performed_via_github_app": null,
            "reactions": {
                "+1": 0,
                "-1": 0,
                "confused": 0,
                "eyes": 0,
                "heart": 0,
                "hooray": 0,
                "laugh": 0,
                "rocket": 0,
                "total_count": 0,
                "url": "https://api.github.com/repos/neovim/nvim-lspconfig/issues/comments/2627848988/reactions"
            },
            "updated_at": "2025-01-31T17:19:18Z",
            "url": "https://api.github.com/repos/neovim/nvim-lspconfig/issues/comments/2627848988",
            "user": {
                "avatar_url": "https://avatars.githubusercontent.com/u/1359421?v=4",
                "events_url": "https://api.github.com/users/justinmk/events{/privacy}",
                "followers_url": "https://api.github.com/users/justinmk/followers",
                "following_url": "https://api.github.com/users/justinmk/following{/other_user}",
                "gists_url": "https://api.github.com/users/justinmk/gists{/gist_id}",
                "gravatar_id": "",
                "html_url": "https://github.com/justinmk",
                "id": 1359421,
                "login": "justinmk",
                "node_id": "MDQ6VXNlcjEzNTk0MjE=",
                "organizations_url": "https://api.github.com/users/justinmk/orgs",
                "received_events_url": "https://api.github.com/users/justinmk/received_events",
                "repos_url": "https://api.github.com/users/justinmk/repos",
                "site_admin": false,
                "starred_url": "https://api.github.com/users/justinmk/starred{/owner}{/repo}",
                "subscriptions_url": "https://api.github.com/users/justinmk/subscriptions",
                "type": "User",
                "url": "https://api.github.com/users/justinmk",
                "user_view_type": "public"
            }
        },
        {
            "author_association": "NONE",
            "body": "@justinmk I did https://github.com/neovim/nvim-lspconfig/issues/3598#issuecomment-2627580074 it doesn’t reproduce. Is this worth fixing given that this is deprecated?",
            "created_at": "2025-01-31T17:26:35Z",
            "html_url": "https://github.com/neovim/nvim-lspconfig/issues/3598#issuecomment-2627861276",
            "id": 2627861276,
            "issue_url": "https://api.github.com/repos/neovim/nvim-lspconfig/issues/3598",
            "node_id": "IC_kwDODTQC186cofsc",
            "performed_via_github_app": null,
            "reactions": {
                "+1": 0,
                "-1": 0,
                "confused": 0,
                "eyes": 0,
                "heart": 0,
                "hooray": 0,
                "laugh": 0,
                "rocket": 0,
                "total_count": 0,
                "url": "https://api.github.com/repos/neovim/nvim-lspconfig/issues/comments/2627861276/reactions"
            },
            "updated_at": "2025-01-31T17:26:35Z",
            "url": "https://api.github.com/repos/neovim/nvim-lspconfig/issues/comments/2627861276",
            "user": {
                "avatar_url": "https://avatars.githubusercontent.com/u/10669859?v=4",
                "events_url": "https://api.github.com/users/xrisk/events{/privacy}",
                "followers_url": "https://api.github.com/users/xrisk/followers",
                "following_url": "https://api.github.com/users/xrisk/following{/other_user}",
                "gists_url": "https://api.github.com/users/xrisk/gists{/gist_id}",
                "gravatar_id": "",
                "html_url": "https://github.com/xrisk",
                "id": 10669859,
                "login": "xrisk",
                "node_id": "MDQ6VXNlcjEwNjY5ODU5",
                "organizations_url": "https://api.github.com/users/xrisk/orgs",
                "received_events_url": "https://api.github.com/users/xrisk/received_events",
                "repos_url": "https://api.github.com/users/xrisk/repos",
                "site_admin": false,
                "starred_url": "https://api.github.com/users/xrisk/starred{/owner}{/repo}",
                "subscriptions_url": "https://api.github.com/users/xrisk/subscriptions",
                "type": "User",
                "url": "https://api.github.com/users/xrisk",
                "user_view_type": "public"
            }
        },
        {
            "author_association": "MEMBER",
            "body": "Sorry I missed that :D That is good news. We can keep this open, but will probably close all of these nvim-lspconfig \"framework\" issues once Nvim 0.11 is released.\n\nnvim-lspconfig will continue to be the source of truth for most \"configs\". Just the \"framework\" part is no longer needed in Nvim 0.11.",
            "created_at": "2025-01-31T17:29:19Z",
            "html_url": "https://github.com/neovim/nvim-lspconfig/issues/3598#issuecomment-2627865707",
            "id": 2627865707,
            "issue_url": "https://api.github.com/repos/neovim/nvim-lspconfig/issues/3598",
            "node_id": "IC_kwDODTQC186cogxr",
            "performed_via_github_app": null,
            "reactions": {
                "+1": 0,
                "-1": 0,
                "confused": 0,
                "eyes": 0,
                "heart": 0,
                "hooray": 0,
                "laugh": 0,
                "rocket": 0,
                "total_count": 0,
                "url": "https://api.github.com/repos/neovim/nvim-lspconfig/issues/comments/2627865707/reactions"
            },
            "updated_at": "2025-01-31T17:29:19Z",
            "url": "https://api.github.com/repos/neovim/nvim-lspconfig/issues/comments/2627865707",
            "user": {
                "avatar_url": "https://avatars.githubusercontent.com/u/1359421?v=4",
                "events_url": "https://api.github.com/users/justinmk/events{/privacy}",
                "followers_url": "https://api.github.com/users/justinmk/followers",
                "following_url": "https://api.github.com/users/justinmk/following{/other_user}",
                "gists_url": "https://api.github.com/users/justinmk/gists{/gist_id}",
                "gravatar_id": "",
                "html_url": "https://github.com/justinmk",
                "id": 1359421,
                "login": "justinmk",
                "node_id": "MDQ6VXNlcjEzNTk0MjE=",
                "organizations_url": "https://api.github.com/users/justinmk/orgs",
                "received_events_url": "https://api.github.com/users/justinmk/received_events",
                "repos_url": "https://api.github.com/users/justinmk/repos",
                "site_admin": false,
                "starred_url": "https://api.github.com/users/justinmk/starred{/owner}{/repo}",
                "subscriptions_url": "https://api.github.com/users/justinmk/subscriptions",
                "type": "User",
                "url": "https://api.github.com/users/justinmk",
                "user_view_type": "public"
            }
        }
    ],
    "comments": 4,
    "comments_url": "https://api.github.com/repos/neovim/nvim-lspconfig/issues/3598/comments",
    "created_at": "2025-01-31T14:14:34Z",
    "events_url": "https://api.github.com/repos/neovim/nvim-lspconfig/issues/3598/events",
    "html_url": "https://github.com/neovim/nvim-lspconfig/issues/3598",
    "id": 2823622609,
    "labels": [
        {
            "color": "f9d0c4",
            "default": true,
            "description": "Something isn't working",
            "id": 1674892761,
            "name": "bug",
            "node_id": "MDU6TGFiZWwxNjc0ODkyNzYx",
            "url": "https://api.github.com/repos/neovim/nvim-lspconfig/labels/bug"
        }
    ],
    "labels_url": "https://api.github.com/repos/neovim/nvim-lspconfig/issues/3598/labels{/name}",
    "locked": false,
    "milestone": null,
    "node_id": "I_kwDODTQC186oTQ_R",
    "number": 3598,
    "performed_via_github_app": null,
    "reactions": {
        "+1": 0,
        "-1": 0,
        "confused": 0,
        "eyes": 0,
        "heart": 0,
        "hooray": 0,
        "laugh": 0,
        "rocket": 0,
        "total_count": 0,
        "url": "https://api.github.com/repos/neovim/nvim-lspconfig/issues/3598/reactions"
    },
    "repository_url": "https://api.github.com/repos/neovim/nvim-lspconfig",
    "state": "open",
    "state_reason": null,
    "sub_issues_summary": {
        "completed": 0,
        "percent_completed": 0,
        "total": 0
    },
    "timeline_url": "https://api.github.com/repos/neovim/nvim-lspconfig/issues/3598/timeline",
    "title": "LSP should not be passed `workspace/didChangeWorkspaceFolders` when started in single file mode",
    "updated_at": "2025-01-31T17:29:21Z",
    "url": "https://api.github.com/repos/neovim/nvim-lspconfig/issues/3598",
    "user": {
        "avatar_url": "https://avatars.githubusercontent.com/u/10669859?v=4",
        "events_url": "https://api.github.com/users/xrisk/events{/privacy}",
        "followers_url": "https://api.github.com/users/xrisk/followers",
        "following_url": "https://api.github.com/users/xrisk/following{/other_user}",
        "gists_url": "https://api.github.com/users/xrisk/gists{/gist_id}",
        "gravatar_id": "",
        "html_url": "https://github.com/xrisk",
        "id": 10669859,
        "login": "xrisk",
        "node_id": "MDQ6VXNlcjEwNjY5ODU5",
        "organizations_url": "https://api.github.com/users/xrisk/orgs",
        "received_events_url": "https://api.github.com/users/xrisk/received_events",
        "repos_url": "https://api.github.com/users/xrisk/repos",
        "site_admin": false,
        "starred_url": "https://api.github.com/users/xrisk/starred{/owner}{/repo}",
        "subscriptions_url": "https://api.github.com/users/xrisk/subscriptions",
        "type": "User",
        "url": "https://api.github.com/users/xrisk",
        "user_view_type": "public"
    }
}