{
    "active_lock_reason": null,
    "assignee": null,
    "assignees": [],
    "author_association": "NONE",
    "body": "### Description\n\nWith the migration to a new way of configuring LSPs I noticed a change in behavior when working with multiple TypeScript projects tied together using [project references](https://www.typescriptlang.org/docs/handbook/project-references.html).\n\nWhen using `require('lspconfig').<lsp-name>.setup(...)` and opening files from different projects there is only one client instance.\n\nBut with `vim.lsp.config` + `vim.lsp.enable` a new separate client instance is started for each project.\n\nThe issue is that with multiple instances finding references doesn't work reliably across all projects even when all of them are loaded.\n\nI've tried `ts_ls` and `vtsls`, they both behave the same way before and after.\n\nHere is a repository to demonstrate the issue: https://github.com/faergeek/nvim-ts-workspace-folders-repro\n\nSteps to reproduce:\n\n1. Clone the repo\n2. `npm install -g typescript typescript-language-server` as per [configs.md](https://github.com/neovim/nvim-lspconfig/blob/master/doc/configs.md#ts_ls)\n3. Run `nvim --clean -u init.new.lua -O a/index.ts b/index.ts`, which uses the new way of configuration. Run `:LspInfo`. There will be two `ts_ls` instances under `vim.lsp: Active Clients`.\n4. Run `nvim --clean -u init.old.lua -O a/index.ts b/index.ts`, which uses the old way. Run `:LspInfo`. There will be just one `ts_ls` instance under `vim.lsp: Active Clients`.\n\nWith the old way any unrelated project will also be added to the same instance as well (from a completely different repository in a parent directory, for example), which doesn't seem right, but I don't know if it actually causes any issues.\n\nBased on `:help vim.lsp.Config` possible workaround outside of nvim-lspconfig would be either defining a custom `reuse_client` implementation or just setting `root_dir` to a cwd, for example:\n\n```lua\nvim.lsp.config('vtsls', {\n  root_dir = vim.uv.cwd(),\n})\n```\n\nI don't know what would be a generic solution to this other than looking for root markers top-down instead of bottom-up when detecting `root_dir`.",
    "closed_at": null,
    "closed_by": null,
    "comment_data": [
        {
            "author_association": "MEMBER",
            "body": "This is decided by `reuse_client`. Its default condition is here: https://github.com/neovim/neovim/blob/0d658660c29e920e74c4dade3819d80dccad0dde/runtime/lua/vim/lsp.lua#L146\n\n> I don't know what would be a generic solution to this other than looking for root markers top-down instead of bottom-up when detecting `root_dir`.\n\nCan you try defining a custom `reuse_client` predicate? \n\nbtw, `root_markers` is prioritized in-order so another option would be to list `.git` (and/or `package.json`) first, instead of near the end:\n\nhttps://github.com/neovim/nvim-lspconfig/blob/463b16bd6a347a129367a7fd00ebcdd9442d9a96/lsp/ts_ls.lua#L84\n\nIf you see a way to improve the default `reuse_client`, or anything else, let us know :)",
            "created_at": "2025-06-16T15:03:56Z",
            "html_url": "https://github.com/neovim/nvim-lspconfig/issues/3910#issuecomment-2977013816",
            "id": 2977013816,
            "issue_url": "https://api.github.com/repos/neovim/nvim-lspconfig/issues/3910",
            "node_id": "IC_kwDODTQC186xcaA4",
            "performed_via_github_app": null,
            "reactions": {
                "+1": 0,
                "-1": 0,
                "confused": 0,
                "eyes": 0,
                "heart": 0,
                "hooray": 0,
                "laugh": 0,
                "rocket": 0,
                "total_count": 0,
                "url": "https://api.github.com/repos/neovim/nvim-lspconfig/issues/comments/2977013816/reactions"
            },
            "updated_at": "2025-06-16T15:03:56Z",
            "url": "https://api.github.com/repos/neovim/nvim-lspconfig/issues/comments/2977013816",
            "user": {
                "avatar_url": "https://avatars.githubusercontent.com/u/1359421?v=4",
                "events_url": "https://api.github.com/users/justinmk/events{/privacy}",
                "followers_url": "https://api.github.com/users/justinmk/followers",
                "following_url": "https://api.github.com/users/justinmk/following{/other_user}",
                "gists_url": "https://api.github.com/users/justinmk/gists{/gist_id}",
                "gravatar_id": "",
                "html_url": "https://github.com/justinmk",
                "id": 1359421,
                "login": "justinmk",
                "node_id": "MDQ6VXNlcjEzNTk0MjE=",
                "organizations_url": "https://api.github.com/users/justinmk/orgs",
                "received_events_url": "https://api.github.com/users/justinmk/received_events",
                "repos_url": "https://api.github.com/users/justinmk/repos",
                "site_admin": false,
                "starred_url": "https://api.github.com/users/justinmk/starred{/owner}{/repo}",
                "subscriptions_url": "https://api.github.com/users/justinmk/subscriptions",
                "type": "User",
                "url": "https://api.github.com/users/justinmk",
                "user_view_type": "public"
            }
        }
    ],
    "comments": 1,
    "comments_url": "https://api.github.com/repos/neovim/nvim-lspconfig/issues/3910/comments",
    "created_at": "2025-06-15T11:35:34Z",
    "events_url": "https://api.github.com/repos/neovim/nvim-lspconfig/issues/3910/events",
    "html_url": "https://github.com/neovim/nvim-lspconfig/issues/3910",
    "id": 3147395547,
    "labels": [
        {
            "color": "f9d0c4",
            "default": true,
            "description": "Something isn't working",
            "id": 1674892761,
            "name": "bug",
            "node_id": "MDU6TGFiZWwxNjc0ODkyNzYx",
            "url": "https://api.github.com/repos/neovim/nvim-lspconfig/labels/bug"
        }
    ],
    "labels_url": "https://api.github.com/repos/neovim/nvim-lspconfig/issues/3910/labels{/name}",
    "locked": false,
    "milestone": null,
    "node_id": "I_kwDODTQC1867mXHb",
    "number": 3910,
    "performed_via_github_app": null,
    "reactions": {
        "+1": 0,
        "-1": 0,
        "confused": 0,
        "eyes": 0,
        "heart": 0,
        "hooray": 0,
        "laugh": 0,
        "rocket": 0,
        "total_count": 0,
        "url": "https://api.github.com/repos/neovim/nvim-lspconfig/issues/3910/reactions"
    },
    "repository_url": "https://api.github.com/repos/neovim/nvim-lspconfig",
    "state": "open",
    "state_reason": null,
    "sub_issues_summary": {
        "completed": 0,
        "percent_completed": 0,
        "total": 0
    },
    "timeline_url": "https://api.github.com/repos/neovim/nvim-lspconfig/issues/3910/timeline",
    "title": "New client instances are being started per `tsconfig.json` in a multi-project TypeScript codebase",
    "type": null,
    "updated_at": "2025-06-16T15:03:56Z",
    "url": "https://api.github.com/repos/neovim/nvim-lspconfig/issues/3910",
    "user": {
        "avatar_url": "https://avatars.githubusercontent.com/u/3524621?v=4",
        "events_url": "https://api.github.com/users/faergeek/events{/privacy}",
        "followers_url": "https://api.github.com/users/faergeek/followers",
        "following_url": "https://api.github.com/users/faergeek/following{/other_user}",
        "gists_url": "https://api.github.com/users/faergeek/gists{/gist_id}",
        "gravatar_id": "",
        "html_url": "https://github.com/faergeek",
        "id": 3524621,
        "login": "faergeek",
        "node_id": "MDQ6VXNlcjM1MjQ2MjE=",
        "organizations_url": "https://api.github.com/users/faergeek/orgs",
        "received_events_url": "https://api.github.com/users/faergeek/received_events",
        "repos_url": "https://api.github.com/users/faergeek/repos",
        "site_admin": false,
        "starred_url": "https://api.github.com/users/faergeek/starred{/owner}{/repo}",
        "subscriptions_url": "https://api.github.com/users/faergeek/subscriptions",
        "type": "User",
        "url": "https://api.github.com/users/faergeek",
        "user_view_type": "public"
    }
}