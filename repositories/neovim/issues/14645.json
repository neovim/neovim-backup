{
    "active_lock_reason": null,
    "assignee": null,
    "assignees": [],
    "author_association": "NONE",
    "body": "### Actual behaviour\r\n\r\nCalling `vim.lsp.buf.formatting` on a buffer opened on different windows, regardless if it's on the same or different tab, causes the non focused window(s) to reset its position to the top of the file. \r\n\r\n### Expected behaviour\r\n\r\nAvoid changing the position of the non focused windows.\r\n",
    "closed_at": null,
    "comment_data": [
        {
            "author_association": "MEMBER",
            "body": "I'm not sure we can fix this, this is due to `nvim_buf_set_lines` replacing the lines. When the cursor was in the replacement region, it will be set to the top of the replaced region. In case all lines change in a buffer, it will be set to the top of the buffer",
            "created_at": "2021-05-27T06:47:51Z",
            "html_url": "https://github.com/neovim/neovim/issues/14645#issuecomment-849376646",
            "id": 849376646,
            "issue_url": "https://api.github.com/repos/neovim/neovim/issues/14645",
            "node_id": "MDEyOklzc3VlQ29tbWVudDg0OTM3NjY0Ng==",
            "performed_via_github_app": null,
            "reactions": {
                "+1": 0,
                "-1": 0,
                "confused": 0,
                "eyes": 0,
                "heart": 0,
                "hooray": 0,
                "laugh": 0,
                "rocket": 0,
                "total_count": 0,
                "url": "https://api.github.com/repos/neovim/neovim/issues/comments/849376646/reactions"
            },
            "updated_at": "2021-05-27T06:47:51Z",
            "url": "https://api.github.com/repos/neovim/neovim/issues/comments/849376646",
            "user": {
                "avatar_url": "https://avatars.githubusercontent.com/u/292349?v=4",
                "events_url": "https://api.github.com/users/folke/events{/privacy}",
                "followers_url": "https://api.github.com/users/folke/followers",
                "following_url": "https://api.github.com/users/folke/following{/other_user}",
                "gists_url": "https://api.github.com/users/folke/gists{/gist_id}",
                "gravatar_id": "",
                "html_url": "https://github.com/folke",
                "id": 292349,
                "login": "folke",
                "node_id": "MDQ6VXNlcjI5MjM0OQ==",
                "organizations_url": "https://api.github.com/users/folke/orgs",
                "received_events_url": "https://api.github.com/users/folke/received_events",
                "repos_url": "https://api.github.com/users/folke/repos",
                "site_admin": false,
                "starred_url": "https://api.github.com/users/folke/starred{/owner}{/repo}",
                "subscriptions_url": "https://api.github.com/users/folke/subscriptions",
                "type": "User",
                "url": "https://api.github.com/users/folke"
            }
        },
        {
            "author_association": "MEMBER",
            "body": "What we can do, is save the cursor position in `apply_text_edits`, before `set_lines` and then try restoring it afterwards?",
            "created_at": "2021-05-27T06:49:04Z",
            "html_url": "https://github.com/neovim/neovim/issues/14645#issuecomment-849377382",
            "id": 849377382,
            "issue_url": "https://api.github.com/repos/neovim/neovim/issues/14645",
            "node_id": "MDEyOklzc3VlQ29tbWVudDg0OTM3NzM4Mg==",
            "performed_via_github_app": null,
            "reactions": {
                "+1": 0,
                "-1": 0,
                "confused": 0,
                "eyes": 0,
                "heart": 0,
                "hooray": 0,
                "laugh": 0,
                "rocket": 0,
                "total_count": 0,
                "url": "https://api.github.com/repos/neovim/neovim/issues/comments/849377382/reactions"
            },
            "updated_at": "2021-05-27T06:49:31Z",
            "url": "https://api.github.com/repos/neovim/neovim/issues/comments/849377382",
            "user": {
                "avatar_url": "https://avatars.githubusercontent.com/u/292349?v=4",
                "events_url": "https://api.github.com/users/folke/events{/privacy}",
                "followers_url": "https://api.github.com/users/folke/followers",
                "following_url": "https://api.github.com/users/folke/following{/other_user}",
                "gists_url": "https://api.github.com/users/folke/gists{/gist_id}",
                "gravatar_id": "",
                "html_url": "https://github.com/folke",
                "id": 292349,
                "login": "folke",
                "node_id": "MDQ6VXNlcjI5MjM0OQ==",
                "organizations_url": "https://api.github.com/users/folke/orgs",
                "received_events_url": "https://api.github.com/users/folke/received_events",
                "repos_url": "https://api.github.com/users/folke/repos",
                "site_admin": false,
                "starred_url": "https://api.github.com/users/folke/starred{/owner}{/repo}",
                "subscriptions_url": "https://api.github.com/users/folke/subscriptions",
                "type": "User",
                "url": "https://api.github.com/users/folke"
            }
        },
        {
            "author_association": "CONTRIBUTOR",
            "body": "Hi @folke, could you show me an example config to do that? Mine is:\r\n\r\n```lua\r\nif client.resolved_capabilities.document_formatting then\r\n  vim.api.nvim_command [[augroup Format]]\r\n  vim.api.nvim_command [[autocmd! * <buffer>]]\r\n  vim.api.nvim_command [[autocmd BufWritePre <buffer> lua vim.lsp.buf.formatting_sync(nil, 1000)]]\r\n  vim.api.nvim_command [[augroup END]]\r\nend\r\n```",
            "created_at": "2021-07-09T06:25:12Z",
            "html_url": "https://github.com/neovim/neovim/issues/14645#issuecomment-876947484",
            "id": 876947484,
            "issue_url": "https://api.github.com/repos/neovim/neovim/issues/14645",
            "node_id": "MDEyOklzc3VlQ29tbWVudDg3Njk0NzQ4NA==",
            "performed_via_github_app": null,
            "reactions": {
                "+1": 0,
                "-1": 0,
                "confused": 0,
                "eyes": 0,
                "heart": 0,
                "hooray": 0,
                "laugh": 0,
                "rocket": 0,
                "total_count": 0,
                "url": "https://api.github.com/repos/neovim/neovim/issues/comments/876947484/reactions"
            },
            "updated_at": "2021-07-09T06:25:12Z",
            "url": "https://api.github.com/repos/neovim/neovim/issues/comments/876947484",
            "user": {
                "avatar_url": "https://avatars.githubusercontent.com/u/1332805?v=4",
                "events_url": "https://api.github.com/users/craftzdog/events{/privacy}",
                "followers_url": "https://api.github.com/users/craftzdog/followers",
                "following_url": "https://api.github.com/users/craftzdog/following{/other_user}",
                "gists_url": "https://api.github.com/users/craftzdog/gists{/gist_id}",
                "gravatar_id": "",
                "html_url": "https://github.com/craftzdog",
                "id": 1332805,
                "login": "craftzdog",
                "node_id": "MDQ6VXNlcjEzMzI4MDU=",
                "organizations_url": "https://api.github.com/users/craftzdog/orgs",
                "received_events_url": "https://api.github.com/users/craftzdog/received_events",
                "repos_url": "https://api.github.com/users/craftzdog/repos",
                "site_admin": false,
                "starred_url": "https://api.github.com/users/craftzdog/starred{/owner}{/repo}",
                "subscriptions_url": "https://api.github.com/users/craftzdog/subscriptions",
                "type": "User",
                "url": "https://api.github.com/users/craftzdog"
            }
        },
        {
            "author_association": "MEMBER",
            "body": "@craftzdog to do what? :)\r\n\r\nYou mean what I was referring to as a possible fix? That would be using the api to save the cursor position, calling format and resetting it. So you would need to write that code to use it.\r\n\r\nEither way, I think this problem may be fixed by #13703\r\n\r\n",
            "created_at": "2021-07-09T09:28:57Z",
            "html_url": "https://github.com/neovim/neovim/issues/14645#issuecomment-877050716",
            "id": 877050716,
            "issue_url": "https://api.github.com/repos/neovim/neovim/issues/14645",
            "node_id": "MDEyOklzc3VlQ29tbWVudDg3NzA1MDcxNg==",
            "performed_via_github_app": null,
            "reactions": {
                "+1": 0,
                "-1": 0,
                "confused": 0,
                "eyes": 0,
                "heart": 1,
                "hooray": 0,
                "laugh": 0,
                "rocket": 0,
                "total_count": 1,
                "url": "https://api.github.com/repos/neovim/neovim/issues/comments/877050716/reactions"
            },
            "updated_at": "2021-07-09T09:28:57Z",
            "url": "https://api.github.com/repos/neovim/neovim/issues/comments/877050716",
            "user": {
                "avatar_url": "https://avatars.githubusercontent.com/u/292349?v=4",
                "events_url": "https://api.github.com/users/folke/events{/privacy}",
                "followers_url": "https://api.github.com/users/folke/followers",
                "following_url": "https://api.github.com/users/folke/following{/other_user}",
                "gists_url": "https://api.github.com/users/folke/gists{/gist_id}",
                "gravatar_id": "",
                "html_url": "https://github.com/folke",
                "id": 292349,
                "login": "folke",
                "node_id": "MDQ6VXNlcjI5MjM0OQ==",
                "organizations_url": "https://api.github.com/users/folke/orgs",
                "received_events_url": "https://api.github.com/users/folke/received_events",
                "repos_url": "https://api.github.com/users/folke/repos",
                "site_admin": false,
                "starred_url": "https://api.github.com/users/folke/starred{/owner}{/repo}",
                "subscriptions_url": "https://api.github.com/users/folke/subscriptions",
                "type": "User",
                "url": "https://api.github.com/users/folke"
            }
        },
        {
            "author_association": "CONTRIBUTOR",
            "body": "Thanks! I hope it'll be merged soon.",
            "created_at": "2021-07-15T08:49:04Z",
            "html_url": "https://github.com/neovim/neovim/issues/14645#issuecomment-880517334",
            "id": 880517334,
            "issue_url": "https://api.github.com/repos/neovim/neovim/issues/14645",
            "node_id": "MDEyOklzc3VlQ29tbWVudDg4MDUxNzMzNA==",
            "performed_via_github_app": null,
            "reactions": {
                "+1": 0,
                "-1": 0,
                "confused": 0,
                "eyes": 0,
                "heart": 0,
                "hooray": 0,
                "laugh": 0,
                "rocket": 0,
                "total_count": 0,
                "url": "https://api.github.com/repos/neovim/neovim/issues/comments/880517334/reactions"
            },
            "updated_at": "2021-07-15T08:49:04Z",
            "url": "https://api.github.com/repos/neovim/neovim/issues/comments/880517334",
            "user": {
                "avatar_url": "https://avatars.githubusercontent.com/u/1332805?v=4",
                "events_url": "https://api.github.com/users/craftzdog/events{/privacy}",
                "followers_url": "https://api.github.com/users/craftzdog/followers",
                "following_url": "https://api.github.com/users/craftzdog/following{/other_user}",
                "gists_url": "https://api.github.com/users/craftzdog/gists{/gist_id}",
                "gravatar_id": "",
                "html_url": "https://github.com/craftzdog",
                "id": 1332805,
                "login": "craftzdog",
                "node_id": "MDQ6VXNlcjEzMzI4MDU=",
                "organizations_url": "https://api.github.com/users/craftzdog/orgs",
                "received_events_url": "https://api.github.com/users/craftzdog/received_events",
                "repos_url": "https://api.github.com/users/craftzdog/repos",
                "site_admin": false,
                "starred_url": "https://api.github.com/users/craftzdog/starred{/owner}{/repo}",
                "subscriptions_url": "https://api.github.com/users/craftzdog/subscriptions",
                "type": "User",
                "url": "https://api.github.com/users/craftzdog"
            }
        },
        {
            "author_association": "CONTRIBUTOR",
            "body": "As a temporary workaround, you should be able to use this:\r\n\r\n```lua\r\nlocal api = vim.api\r\nlocal fn = vim.fn\r\nlocal lsp = vim.lsp\r\nlocal format_mark_ns = api.nvim_create_namespace('')\r\n\r\nfunction format_buffer()\r\n  local bufnr = api.nvim_win_get_buf(0)\r\n  local windows = fn.win_findbuf(bufnr)\r\n  local marks = {}\r\n\r\n  for _, window in ipairs(windows) do\r\n    local line, col = unpack(api.nvim_win_get_cursor(window))\r\n\r\n    marks[window] =\r\n      api.nvim_buf_set_extmark(bufnr, format_mark_ns, line - 1, col, {})\r\n  end\r\n\r\n  lsp.buf.formatting_sync(nil, 1000)\r\n\r\n  for _, window in ipairs(windows) do\r\n    local mark = marks[window]\r\n\r\n    local line, col =\r\n      unpack(api.nvim_buf_get_extmark_by_id(bufnr, format_mark_ns, mark, {}))\r\n\r\n    if line and col then\r\n      api.nvim_win_set_cursor(window, { line + 1, col })\r\n    end\r\n  end\r\n\r\n  api.nvim_buf_clear_namespace(bufnr, format_mark_ns, 0, -1)\r\nend\r\n```\r\n\r\nYou then have to run this function in the appropriate `autocmd`. For example:\r\n\r\n```vim\r\nBufWritePre *.rs lua format_buffer()\r\n```\r\n\r\nThis should then ensure your cursors are restored properly after formatting. It also supports multiple windows showing the same buffer, and will restore each independently.\r\n\r\nMind you that I only started testing this last night, so there may be bugs.",
            "created_at": "2021-08-02T13:05:19Z",
            "html_url": "https://github.com/neovim/neovim/issues/14645#issuecomment-891009309",
            "id": 891009309,
            "issue_url": "https://api.github.com/repos/neovim/neovim/issues/14645",
            "node_id": "IC_kwDOAPphoM41G7kd",
            "performed_via_github_app": null,
            "reactions": {
                "+1": 0,
                "-1": 0,
                "confused": 0,
                "eyes": 0,
                "heart": 0,
                "hooray": 0,
                "laugh": 0,
                "rocket": 0,
                "total_count": 0,
                "url": "https://api.github.com/repos/neovim/neovim/issues/comments/891009309/reactions"
            },
            "updated_at": "2021-08-02T13:05:30Z",
            "url": "https://api.github.com/repos/neovim/neovim/issues/comments/891009309",
            "user": {
                "avatar_url": "https://avatars.githubusercontent.com/u/86065?v=4",
                "events_url": "https://api.github.com/users/yorickpeterse/events{/privacy}",
                "followers_url": "https://api.github.com/users/yorickpeterse/followers",
                "following_url": "https://api.github.com/users/yorickpeterse/following{/other_user}",
                "gists_url": "https://api.github.com/users/yorickpeterse/gists{/gist_id}",
                "gravatar_id": "",
                "html_url": "https://github.com/yorickpeterse",
                "id": 86065,
                "login": "yorickpeterse",
                "node_id": "MDQ6VXNlcjg2MDY1",
                "organizations_url": "https://api.github.com/users/yorickpeterse/orgs",
                "received_events_url": "https://api.github.com/users/yorickpeterse/received_events",
                "repos_url": "https://api.github.com/users/yorickpeterse/repos",
                "site_admin": false,
                "starred_url": "https://api.github.com/users/yorickpeterse/starred{/owner}{/repo}",
                "subscriptions_url": "https://api.github.com/users/yorickpeterse/subscriptions",
                "type": "User",
                "url": "https://api.github.com/users/yorickpeterse"
            }
        },
        {
            "author_association": "CONTRIBUTOR",
            "body": "Thanks, @YorickPeterse! I've tried it but got the following error:\r\n\r\n```\r\nError detected while processing BufWritePre Autocommands for \"<buffer=1>\":\r\nE5108: Error executing lua [string \":lua\"]:30: Cursor position outside buffer\r\n```\r\n\r\nFor some reason, `line` is always the last line when retrieved from:\r\n\r\n```lua\r\nlocal line, col =\r\n      unpack(api.nvim_buf_get_extmark_by_id(bufnr, format_mark_ns, mark, {}))\r\n```\r\n",
            "created_at": "2021-08-04T07:44:30Z",
            "html_url": "https://github.com/neovim/neovim/issues/14645#issuecomment-892441647",
            "id": 892441647,
            "issue_url": "https://api.github.com/repos/neovim/neovim/issues/14645",
            "node_id": "IC_kwDOAPphoM41MZQv",
            "performed_via_github_app": null,
            "reactions": {
                "+1": 0,
                "-1": 0,
                "confused": 0,
                "eyes": 0,
                "heart": 0,
                "hooray": 0,
                "laugh": 0,
                "rocket": 0,
                "total_count": 0,
                "url": "https://api.github.com/repos/neovim/neovim/issues/comments/892441647/reactions"
            },
            "updated_at": "2021-08-04T07:44:30Z",
            "url": "https://api.github.com/repos/neovim/neovim/issues/comments/892441647",
            "user": {
                "avatar_url": "https://avatars.githubusercontent.com/u/1332805?v=4",
                "events_url": "https://api.github.com/users/craftzdog/events{/privacy}",
                "followers_url": "https://api.github.com/users/craftzdog/followers",
                "following_url": "https://api.github.com/users/craftzdog/following{/other_user}",
                "gists_url": "https://api.github.com/users/craftzdog/gists{/gist_id}",
                "gravatar_id": "",
                "html_url": "https://github.com/craftzdog",
                "id": 1332805,
                "login": "craftzdog",
                "node_id": "MDQ6VXNlcjEzMzI4MDU=",
                "organizations_url": "https://api.github.com/users/craftzdog/orgs",
                "received_events_url": "https://api.github.com/users/craftzdog/received_events",
                "repos_url": "https://api.github.com/users/craftzdog/repos",
                "site_admin": false,
                "starred_url": "https://api.github.com/users/craftzdog/starred{/owner}{/repo}",
                "subscriptions_url": "https://api.github.com/users/craftzdog/subscriptions",
                "type": "User",
                "url": "https://api.github.com/users/craftzdog"
            }
        },
        {
            "author_association": "CONTRIBUTOR",
            "body": "@craftzdog I haven't run into that error so far, so I'm not sure what would cause it. If you have an easy way to reproduce the issue (preferably something that doesn't require installing a ton of dependencies) that would help :smiley: ",
            "created_at": "2021-08-04T12:35:56Z",
            "html_url": "https://github.com/neovim/neovim/issues/14645#issuecomment-892621048",
            "id": 892621048,
            "issue_url": "https://api.github.com/repos/neovim/neovim/issues/14645",
            "node_id": "IC_kwDOAPphoM41NFD4",
            "performed_via_github_app": null,
            "reactions": {
                "+1": 0,
                "-1": 0,
                "confused": 0,
                "eyes": 0,
                "heart": 0,
                "hooray": 0,
                "laugh": 0,
                "rocket": 0,
                "total_count": 0,
                "url": "https://api.github.com/repos/neovim/neovim/issues/comments/892621048/reactions"
            },
            "updated_at": "2021-08-04T12:35:56Z",
            "url": "https://api.github.com/repos/neovim/neovim/issues/comments/892621048",
            "user": {
                "avatar_url": "https://avatars.githubusercontent.com/u/86065?v=4",
                "events_url": "https://api.github.com/users/yorickpeterse/events{/privacy}",
                "followers_url": "https://api.github.com/users/yorickpeterse/followers",
                "following_url": "https://api.github.com/users/yorickpeterse/following{/other_user}",
                "gists_url": "https://api.github.com/users/yorickpeterse/gists{/gist_id}",
                "gravatar_id": "",
                "html_url": "https://github.com/yorickpeterse",
                "id": 86065,
                "login": "yorickpeterse",
                "node_id": "MDQ6VXNlcjg2MDY1",
                "organizations_url": "https://api.github.com/users/yorickpeterse/orgs",
                "received_events_url": "https://api.github.com/users/yorickpeterse/received_events",
                "repos_url": "https://api.github.com/users/yorickpeterse/repos",
                "site_admin": false,
                "starred_url": "https://api.github.com/users/yorickpeterse/starred{/owner}{/repo}",
                "subscriptions_url": "https://api.github.com/users/yorickpeterse/subscriptions",
                "type": "User",
                "url": "https://api.github.com/users/yorickpeterse"
            }
        },
        {
            "author_association": "CONTRIBUTOR",
            "body": "@craftzdog I finally ran into the error. Using the following should fix it:\r\n\r\n```lua\r\nlocal bufnr = api.nvim_win_get_buf(0)\r\nlocal windows = fn.win_findbuf(bufnr)\r\nlocal marks = {}\r\n                                                                              \r\n-- Until https://github.com/neovim/neovim/issues/14645 is solved, I use this\r\n-- code to ensure the cursor position is properly restored after formatting a\r\n-- buffer. The approach used supports restoring cursors for different windows\r\n-- using the same buffer.\r\nfor _, window in ipairs(windows) do\r\n  local line, col = unpack(api.nvim_win_get_cursor(window))\r\n                                                                              \r\n  marks[window] =\r\n    api.nvim_buf_set_extmark(bufnr, format_mark_ns, line - 1, col, {})\r\nend\r\n                                                                              \r\nlsp.buf.formatting_sync(nil, 1000)\r\n                                                                              \r\nfor _, window in ipairs(windows) do\r\n  local mark = marks[window]\r\n                                                                              \r\n  local line, col =\r\n    unpack(api.nvim_buf_get_extmark_by_id(bufnr, format_mark_ns, mark, {}))\r\n                                                                              \r\n  local max_line_index = api.nvim_buf_line_count(bufnr) - 1\r\n                                                                              \r\n  if line and col and line <= max_line_index then\r\n    api.nvim_win_set_cursor(window, { line + 1, col })\r\n  end\r\nend\r\n                                                                              \r\napi.nvim_buf_clear_namespace(bufnr, format_mark_ns, 0, -1)\r\n```\r\n\r\nThe change here is this:\r\n\r\n```diff\r\n@@ -86,7 +86,9 @@ function M.format_buffer()\r\n     local line, col =\r\n       unpack(api.nvim_buf_get_extmark_by_id(bufnr, format_mark_ns, mark, {}))\r\n \r\n-    if line and col then\r\n+    local max_line_index = api.nvim_buf_line_count(bufnr) - 1\r\n+\r\n+    if line and col and line <= max_line_index then\r\n       api.nvim_win_set_cursor(window, { line + 1, col })\r\n     end\r\n   end\r\n```",
            "created_at": "2021-08-05T21:18:30Z",
            "html_url": "https://github.com/neovim/neovim/issues/14645#issuecomment-893816076",
            "id": 893816076,
            "issue_url": "https://api.github.com/repos/neovim/neovim/issues/14645",
            "node_id": "IC_kwDOAPphoM41Ro0M",
            "performed_via_github_app": null,
            "reactions": {
                "+1": 0,
                "-1": 0,
                "confused": 0,
                "eyes": 0,
                "heart": 0,
                "hooray": 0,
                "laugh": 0,
                "rocket": 0,
                "total_count": 0,
                "url": "https://api.github.com/repos/neovim/neovim/issues/comments/893816076/reactions"
            },
            "updated_at": "2021-08-05T21:18:30Z",
            "url": "https://api.github.com/repos/neovim/neovim/issues/comments/893816076",
            "user": {
                "avatar_url": "https://avatars.githubusercontent.com/u/86065?v=4",
                "events_url": "https://api.github.com/users/yorickpeterse/events{/privacy}",
                "followers_url": "https://api.github.com/users/yorickpeterse/followers",
                "following_url": "https://api.github.com/users/yorickpeterse/following{/other_user}",
                "gists_url": "https://api.github.com/users/yorickpeterse/gists{/gist_id}",
                "gravatar_id": "",
                "html_url": "https://github.com/yorickpeterse",
                "id": 86065,
                "login": "yorickpeterse",
                "node_id": "MDQ6VXNlcjg2MDY1",
                "organizations_url": "https://api.github.com/users/yorickpeterse/orgs",
                "received_events_url": "https://api.github.com/users/yorickpeterse/received_events",
                "repos_url": "https://api.github.com/users/yorickpeterse/repos",
                "site_admin": false,
                "starred_url": "https://api.github.com/users/yorickpeterse/starred{/owner}{/repo}",
                "subscriptions_url": "https://api.github.com/users/yorickpeterse/subscriptions",
                "type": "User",
                "url": "https://api.github.com/users/yorickpeterse"
            }
        },
        {
            "author_association": "CONTRIBUTOR",
            "body": "Thanks for the update.\r\nI still don't know why but, `lsp.buf.formatting_sync(nil, 1000)` affects the return value of `api.nvim_buf_get_extmark_by_id`.\r\nWhy not simply store the cursor positions in tables like so?\r\n\r\n```lua\r\nlocal pos = {}\r\n...\r\npos[window] =  { line - 1, col }\r\n```\r\n\r\nIt worked:\r\n\r\n```lua\r\nfunction format_buffer()\r\n  local bufnr = api.nvim_win_get_buf(0)\r\n  local windows = fn.win_findbuf(bufnr)\r\n  local marks = {}\r\n  local pos = {}\r\n\r\n  for _, window in ipairs(windows) do\r\n    local line, col = unpack(api.nvim_win_get_cursor(window))\r\n    pos[window] =  { line - 1, col }\r\n  end\r\n\r\n  lsp.buf.formatting_sync(nil, 1000)\r\n\r\n  for _, window in ipairs(windows) do\r\n    local line, col = unpack(pos[window])\r\n    local max_line_index = api.nvim_buf_line_count(bufnr) - 1\r\n    if line and col and line <= max_line_index then\r\n      api.nvim_win_set_cursor(window, { line + 1, col })\r\n    end\r\n  end\r\n\r\n  api.nvim_buf_clear_namespace(bufnr, format_mark_ns, 0, -1)\r\nend\r\n```\r\n\r\nCan I also restore the window scroll position? I couldn't find an API for doing that.",
            "created_at": "2021-08-06T06:18:00Z",
            "html_url": "https://github.com/neovim/neovim/issues/14645#issuecomment-894030349",
            "id": 894030349,
            "issue_url": "https://api.github.com/repos/neovim/neovim/issues/14645",
            "node_id": "IC_kwDOAPphoM41SdIN",
            "performed_via_github_app": null,
            "reactions": {
                "+1": 0,
                "-1": 0,
                "confused": 0,
                "eyes": 0,
                "heart": 0,
                "hooray": 0,
                "laugh": 0,
                "rocket": 0,
                "total_count": 0,
                "url": "https://api.github.com/repos/neovim/neovim/issues/comments/894030349/reactions"
            },
            "updated_at": "2021-08-06T06:27:30Z",
            "url": "https://api.github.com/repos/neovim/neovim/issues/comments/894030349",
            "user": {
                "avatar_url": "https://avatars.githubusercontent.com/u/1332805?v=4",
                "events_url": "https://api.github.com/users/craftzdog/events{/privacy}",
                "followers_url": "https://api.github.com/users/craftzdog/followers",
                "following_url": "https://api.github.com/users/craftzdog/following{/other_user}",
                "gists_url": "https://api.github.com/users/craftzdog/gists{/gist_id}",
                "gravatar_id": "",
                "html_url": "https://github.com/craftzdog",
                "id": 1332805,
                "login": "craftzdog",
                "node_id": "MDQ6VXNlcjEzMzI4MDU=",
                "organizations_url": "https://api.github.com/users/craftzdog/orgs",
                "received_events_url": "https://api.github.com/users/craftzdog/received_events",
                "repos_url": "https://api.github.com/users/craftzdog/repos",
                "site_admin": false,
                "starred_url": "https://api.github.com/users/craftzdog/starred{/owner}{/repo}",
                "subscriptions_url": "https://api.github.com/users/craftzdog/subscriptions",
                "type": "User",
                "url": "https://api.github.com/users/craftzdog"
            }
        },
        {
            "author_association": "CONTRIBUTOR",
            "body": "@craftzdog Your approach isn't going to work if the line you had your cursor on is now an entirely different line. Consider this for example:\r\n\r\n```\r\n1: foo\r\n2: bar\r\n3: baz|\r\n4: quix\r\n```\r\n\r\nHere `|` is the cursor. Now let's say we format the code and it ends up like this:\r\n\r\n```\r\n1: foo bar baz quix\r\n```\r\n\r\nSimply restoring according to the line number would not work, as there is no line 3. Even if there was (e.g. they are empty), you'd end up with this:\r\n\r\n```\r\n1: foo bar baz quix\r\n2:\r\n3: |\r\n4: \r\n```\r\n\r\nBut that's not what you want: you want the cursor to be as close as possible to the _code_ that you had it pointed to. So this:\r\n\r\n```\r\n1: foo bar baz| quix\r\n```\r\n\r\nUsing extmarks this can be achieved (most of the time at least). Either way this is getting a bit offtopic. If the script doesn't work feel free to adjust it according to your needs; it's just a temporary hack that's better than nothing :smiley: ",
            "created_at": "2021-08-06T16:15:08Z",
            "html_url": "https://github.com/neovim/neovim/issues/14645#issuecomment-894367033",
            "id": 894367033,
            "issue_url": "https://api.github.com/repos/neovim/neovim/issues/14645",
            "node_id": "IC_kwDOAPphoM41TvU5",
            "performed_via_github_app": null,
            "reactions": {
                "+1": 0,
                "-1": 0,
                "confused": 0,
                "eyes": 0,
                "heart": 0,
                "hooray": 0,
                "laugh": 0,
                "rocket": 0,
                "total_count": 0,
                "url": "https://api.github.com/repos/neovim/neovim/issues/comments/894367033/reactions"
            },
            "updated_at": "2021-08-06T16:15:08Z",
            "url": "https://api.github.com/repos/neovim/neovim/issues/comments/894367033",
            "user": {
                "avatar_url": "https://avatars.githubusercontent.com/u/86065?v=4",
                "events_url": "https://api.github.com/users/yorickpeterse/events{/privacy}",
                "followers_url": "https://api.github.com/users/yorickpeterse/followers",
                "following_url": "https://api.github.com/users/yorickpeterse/following{/other_user}",
                "gists_url": "https://api.github.com/users/yorickpeterse/gists{/gist_id}",
                "gravatar_id": "",
                "html_url": "https://github.com/yorickpeterse",
                "id": 86065,
                "login": "yorickpeterse",
                "node_id": "MDQ6VXNlcjg2MDY1",
                "organizations_url": "https://api.github.com/users/yorickpeterse/orgs",
                "received_events_url": "https://api.github.com/users/yorickpeterse/received_events",
                "repos_url": "https://api.github.com/users/yorickpeterse/repos",
                "site_admin": false,
                "starred_url": "https://api.github.com/users/yorickpeterse/starred{/owner}{/repo}",
                "subscriptions_url": "https://api.github.com/users/yorickpeterse/subscriptions",
                "type": "User",
                "url": "https://api.github.com/users/yorickpeterse"
            }
        },
        {
            "author_association": "CONTRIBUTOR",
            "body": "Thank you for the explanation, that makes sense!\r\nNow, I need to know why `lsp.buf.formatting_sync(nil, 1000)` breaks the extmarks.",
            "created_at": "2021-08-10T06:01:07Z",
            "html_url": "https://github.com/neovim/neovim/issues/14645#issuecomment-895751675",
            "id": 895751675,
            "issue_url": "https://api.github.com/repos/neovim/neovim/issues/14645",
            "node_id": "IC_kwDOAPphoM41ZBX7",
            "performed_via_github_app": null,
            "reactions": {
                "+1": 0,
                "-1": 0,
                "confused": 0,
                "eyes": 0,
                "heart": 0,
                "hooray": 0,
                "laugh": 0,
                "rocket": 0,
                "total_count": 0,
                "url": "https://api.github.com/repos/neovim/neovim/issues/comments/895751675/reactions"
            },
            "updated_at": "2021-08-10T06:01:07Z",
            "url": "https://api.github.com/repos/neovim/neovim/issues/comments/895751675",
            "user": {
                "avatar_url": "https://avatars.githubusercontent.com/u/1332805?v=4",
                "events_url": "https://api.github.com/users/craftzdog/events{/privacy}",
                "followers_url": "https://api.github.com/users/craftzdog/followers",
                "following_url": "https://api.github.com/users/craftzdog/following{/other_user}",
                "gists_url": "https://api.github.com/users/craftzdog/gists{/gist_id}",
                "gravatar_id": "",
                "html_url": "https://github.com/craftzdog",
                "id": 1332805,
                "login": "craftzdog",
                "node_id": "MDQ6VXNlcjEzMzI4MDU=",
                "organizations_url": "https://api.github.com/users/craftzdog/orgs",
                "received_events_url": "https://api.github.com/users/craftzdog/received_events",
                "repos_url": "https://api.github.com/users/craftzdog/repos",
                "site_admin": false,
                "starred_url": "https://api.github.com/users/craftzdog/starred{/owner}{/repo}",
                "subscriptions_url": "https://api.github.com/users/craftzdog/subscriptions",
                "type": "User",
                "url": "https://api.github.com/users/craftzdog"
            }
        },
        {
            "author_association": "CONTRIBUTOR",
            "body": "Confirmed that the latest build fixed the issue ðŸŽ‰",
            "created_at": "2021-09-29T02:23:54Z",
            "html_url": "https://github.com/neovim/neovim/issues/14645#issuecomment-929769748",
            "id": 929769748,
            "issue_url": "https://api.github.com/repos/neovim/neovim/issues/14645",
            "node_id": "IC_kwDOAPphoM43aykU",
            "performed_via_github_app": null,
            "reactions": {
                "+1": 0,
                "-1": 0,
                "confused": 0,
                "eyes": 0,
                "heart": 0,
                "hooray": 0,
                "laugh": 0,
                "rocket": 0,
                "total_count": 0,
                "url": "https://api.github.com/repos/neovim/neovim/issues/comments/929769748/reactions"
            },
            "updated_at": "2021-09-29T02:23:54Z",
            "url": "https://api.github.com/repos/neovim/neovim/issues/comments/929769748",
            "user": {
                "avatar_url": "https://avatars.githubusercontent.com/u/1332805?v=4",
                "events_url": "https://api.github.com/users/craftzdog/events{/privacy}",
                "followers_url": "https://api.github.com/users/craftzdog/followers",
                "following_url": "https://api.github.com/users/craftzdog/following{/other_user}",
                "gists_url": "https://api.github.com/users/craftzdog/gists{/gist_id}",
                "gravatar_id": "",
                "html_url": "https://github.com/craftzdog",
                "id": 1332805,
                "login": "craftzdog",
                "node_id": "MDQ6VXNlcjEzMzI4MDU=",
                "organizations_url": "https://api.github.com/users/craftzdog/orgs",
                "received_events_url": "https://api.github.com/users/craftzdog/received_events",
                "repos_url": "https://api.github.com/users/craftzdog/repos",
                "site_admin": false,
                "starred_url": "https://api.github.com/users/craftzdog/starred{/owner}{/repo}",
                "subscriptions_url": "https://api.github.com/users/craftzdog/subscriptions",
                "type": "User",
                "url": "https://api.github.com/users/craftzdog"
            }
        },
        {
            "author_association": "CONTRIBUTOR",
            "body": "@craftzdog Just to check: do you mean the latest `master` fixes the issue described by OP, or that it fixes my extmarks hack?",
            "created_at": "2021-09-29T13:44:20Z",
            "html_url": "https://github.com/neovim/neovim/issues/14645#issuecomment-930189944",
            "id": 930189944,
            "issue_url": "https://api.github.com/repos/neovim/neovim/issues/14645",
            "node_id": "IC_kwDOAPphoM43cZJ4",
            "performed_via_github_app": null,
            "reactions": {
                "+1": 0,
                "-1": 0,
                "confused": 0,
                "eyes": 0,
                "heart": 0,
                "hooray": 0,
                "laugh": 0,
                "rocket": 0,
                "total_count": 0,
                "url": "https://api.github.com/repos/neovim/neovim/issues/comments/930189944/reactions"
            },
            "updated_at": "2021-09-29T13:44:20Z",
            "url": "https://api.github.com/repos/neovim/neovim/issues/comments/930189944",
            "user": {
                "avatar_url": "https://avatars.githubusercontent.com/u/86065?v=4",
                "events_url": "https://api.github.com/users/yorickpeterse/events{/privacy}",
                "followers_url": "https://api.github.com/users/yorickpeterse/followers",
                "following_url": "https://api.github.com/users/yorickpeterse/following{/other_user}",
                "gists_url": "https://api.github.com/users/yorickpeterse/gists{/gist_id}",
                "gravatar_id": "",
                "html_url": "https://github.com/yorickpeterse",
                "id": 86065,
                "login": "yorickpeterse",
                "node_id": "MDQ6VXNlcjg2MDY1",
                "organizations_url": "https://api.github.com/users/yorickpeterse/orgs",
                "received_events_url": "https://api.github.com/users/yorickpeterse/received_events",
                "repos_url": "https://api.github.com/users/yorickpeterse/repos",
                "site_admin": false,
                "starred_url": "https://api.github.com/users/yorickpeterse/starred{/owner}{/repo}",
                "subscriptions_url": "https://api.github.com/users/yorickpeterse/subscriptions",
                "type": "User",
                "url": "https://api.github.com/users/yorickpeterse"
            }
        },
        {
            "author_association": "CONTRIBUTOR",
            "body": "Sorry, I was wrong. I tried the latest `master`. The cursor position still moves up to the beginning on formatting. I was editing a file that is not formatted on save.\r\n\r\nBy the way, how do you format your code?\r\nI use `lspconfig` with `diagnosticls` and `prettier` like so:\r\n\r\n```lua\r\nlocal on_attach = function(client, bufnr)\r\n  if client.resolved_capabilities.document_formatting then\r\n    vim.api.nvim_command [[augroup Format]]\r\n    vim.api.nvim_command [[autocmd! * <buffer>]]\r\n    vim.api.nvim_command [[autocmd BufWritePre <buffer> lua format_buffer()]]\r\n    vim.api.nvim_command [[augroup END]]\r\n  end\r\nend\r\n\r\nnvim_lsp.diagnosticls.setup {\r\n  on_attach = on_attach,\r\n  filetypes = { 'javascript', 'javascriptreact', 'json' },\r\n  init_options = {\r\n    formatters = {\r\n      prettier = {\r\n        command = 'prettier_d_slim',\r\n        rootPatterns = { '.git' },\r\n        -- requiredFiles: { 'prettier.config.js' },\r\n        args = { '--stdin', '--stdin-filepath', '%filename' }\r\n      }\r\n    },\r\n    formatFiletypes = {\r\n      javascript = 'prettier',\r\n      javascriptreact = 'prettier',\r\n      json = 'prettier',\r\n    }\r\n  }\r\n}\r\n```",
            "created_at": "2021-09-30T02:33:40Z",
            "html_url": "https://github.com/neovim/neovim/issues/14645#issuecomment-930700794",
            "id": 930700794,
            "issue_url": "https://api.github.com/repos/neovim/neovim/issues/14645",
            "node_id": "IC_kwDOAPphoM43eV36",
            "performed_via_github_app": null,
            "reactions": {
                "+1": 0,
                "-1": 0,
                "confused": 0,
                "eyes": 0,
                "heart": 0,
                "hooray": 0,
                "laugh": 0,
                "rocket": 0,
                "total_count": 0,
                "url": "https://api.github.com/repos/neovim/neovim/issues/comments/930700794/reactions"
            },
            "updated_at": "2021-09-30T02:33:40Z",
            "url": "https://api.github.com/repos/neovim/neovim/issues/comments/930700794",
            "user": {
                "avatar_url": "https://avatars.githubusercontent.com/u/1332805?v=4",
                "events_url": "https://api.github.com/users/craftzdog/events{/privacy}",
                "followers_url": "https://api.github.com/users/craftzdog/followers",
                "following_url": "https://api.github.com/users/craftzdog/following{/other_user}",
                "gists_url": "https://api.github.com/users/craftzdog/gists{/gist_id}",
                "gravatar_id": "",
                "html_url": "https://github.com/craftzdog",
                "id": 1332805,
                "login": "craftzdog",
                "node_id": "MDQ6VXNlcjEzMzI4MDU=",
                "organizations_url": "https://api.github.com/users/craftzdog/orgs",
                "received_events_url": "https://api.github.com/users/craftzdog/received_events",
                "repos_url": "https://api.github.com/users/craftzdog/repos",
                "site_admin": false,
                "starred_url": "https://api.github.com/users/craftzdog/starred{/owner}{/repo}",
                "subscriptions_url": "https://api.github.com/users/craftzdog/subscriptions",
                "type": "User",
                "url": "https://api.github.com/users/craftzdog"
            }
        },
        {
            "author_association": "CONTRIBUTOR",
            "body": "@craftzdog Ah. I use the following for formatting:\r\n\r\n- https://gitlab.com/yorickpeterse/dotfiles/-/blob/9834832f56c333f56b8bee7d81dea3bd445cf5c2/dotfiles/.config/nvim/lua/dotfiles/hooks.lua#L92\r\n- https://gitlab.com/yorickpeterse/dotfiles/-/blob/9834832f56c333f56b8bee7d81dea3bd445cf5c2/dotfiles/.config/nvim/lua/dotfiles/hooks.lua#L28",
            "created_at": "2021-09-30T20:51:12Z",
            "html_url": "https://github.com/neovim/neovim/issues/14645#issuecomment-931656862",
            "id": 931656862,
            "issue_url": "https://api.github.com/repos/neovim/neovim/issues/14645",
            "node_id": "IC_kwDOAPphoM43h_Se",
            "performed_via_github_app": null,
            "reactions": {
                "+1": 0,
                "-1": 0,
                "confused": 0,
                "eyes": 0,
                "heart": 0,
                "hooray": 0,
                "laugh": 0,
                "rocket": 0,
                "total_count": 0,
                "url": "https://api.github.com/repos/neovim/neovim/issues/comments/931656862/reactions"
            },
            "updated_at": "2021-09-30T20:51:12Z",
            "url": "https://api.github.com/repos/neovim/neovim/issues/comments/931656862",
            "user": {
                "avatar_url": "https://avatars.githubusercontent.com/u/86065?v=4",
                "events_url": "https://api.github.com/users/yorickpeterse/events{/privacy}",
                "followers_url": "https://api.github.com/users/yorickpeterse/followers",
                "following_url": "https://api.github.com/users/yorickpeterse/following{/other_user}",
                "gists_url": "https://api.github.com/users/yorickpeterse/gists{/gist_id}",
                "gravatar_id": "",
                "html_url": "https://github.com/yorickpeterse",
                "id": 86065,
                "login": "yorickpeterse",
                "node_id": "MDQ6VXNlcjg2MDY1",
                "organizations_url": "https://api.github.com/users/yorickpeterse/orgs",
                "received_events_url": "https://api.github.com/users/yorickpeterse/received_events",
                "repos_url": "https://api.github.com/users/yorickpeterse/repos",
                "site_admin": false,
                "starred_url": "https://api.github.com/users/yorickpeterse/starred{/owner}{/repo}",
                "subscriptions_url": "https://api.github.com/users/yorickpeterse/subscriptions",
                "type": "User",
                "url": "https://api.github.com/users/yorickpeterse"
            }
        },
        {
            "author_association": "CONTRIBUTOR",
            "body": "From Matrix per @mjlbach:\r\n\r\n```\r\nIf you're interesting in debugging this (which would be great)\r\n\r\n    check the fix_cursor function is not the culprit,\r\n    check the ranges touched by the formatter\r\n    check the position pre and post of the extmark\r\n```\r\n\r\nI'll see if I can do some further debugging this week.",
            "created_at": "2021-11-02T23:56:51Z",
            "html_url": "https://github.com/neovim/neovim/issues/14645#issuecomment-958460188",
            "id": 958460188,
            "issue_url": "https://api.github.com/repos/neovim/neovim/issues/14645",
            "node_id": "IC_kwDOAPphoM45IPEc",
            "performed_via_github_app": null,
            "reactions": {
                "+1": 0,
                "-1": 0,
                "confused": 0,
                "eyes": 0,
                "heart": 0,
                "hooray": 0,
                "laugh": 0,
                "rocket": 0,
                "total_count": 0,
                "url": "https://api.github.com/repos/neovim/neovim/issues/comments/958460188/reactions"
            },
            "updated_at": "2021-11-02T23:56:51Z",
            "url": "https://api.github.com/repos/neovim/neovim/issues/comments/958460188",
            "user": {
                "avatar_url": "https://avatars.githubusercontent.com/u/86065?v=4",
                "events_url": "https://api.github.com/users/yorickpeterse/events{/privacy}",
                "followers_url": "https://api.github.com/users/yorickpeterse/followers",
                "following_url": "https://api.github.com/users/yorickpeterse/following{/other_user}",
                "gists_url": "https://api.github.com/users/yorickpeterse/gists{/gist_id}",
                "gravatar_id": "",
                "html_url": "https://github.com/yorickpeterse",
                "id": 86065,
                "login": "yorickpeterse",
                "node_id": "MDQ6VXNlcjg2MDY1",
                "organizations_url": "https://api.github.com/users/yorickpeterse/orgs",
                "received_events_url": "https://api.github.com/users/yorickpeterse/received_events",
                "repos_url": "https://api.github.com/users/yorickpeterse/repos",
                "site_admin": false,
                "starred_url": "https://api.github.com/users/yorickpeterse/starred{/owner}{/repo}",
                "subscriptions_url": "https://api.github.com/users/yorickpeterse/subscriptions",
                "type": "User",
                "url": "https://api.github.com/users/yorickpeterse"
            }
        },
        {
            "author_association": "CONTRIBUTOR",
            "body": "Thanks, I'll find time to debug this.",
            "created_at": "2021-11-05T02:43:18Z",
            "html_url": "https://github.com/neovim/neovim/issues/14645#issuecomment-961584687",
            "id": 961584687,
            "issue_url": "https://api.github.com/repos/neovim/neovim/issues/14645",
            "node_id": "IC_kwDOAPphoM45UJ4v",
            "performed_via_github_app": null,
            "reactions": {
                "+1": 0,
                "-1": 0,
                "confused": 0,
                "eyes": 0,
                "heart": 0,
                "hooray": 0,
                "laugh": 0,
                "rocket": 0,
                "total_count": 0,
                "url": "https://api.github.com/repos/neovim/neovim/issues/comments/961584687/reactions"
            },
            "updated_at": "2021-11-05T02:43:18Z",
            "url": "https://api.github.com/repos/neovim/neovim/issues/comments/961584687",
            "user": {
                "avatar_url": "https://avatars.githubusercontent.com/u/1332805?v=4",
                "events_url": "https://api.github.com/users/craftzdog/events{/privacy}",
                "followers_url": "https://api.github.com/users/craftzdog/followers",
                "following_url": "https://api.github.com/users/craftzdog/following{/other_user}",
                "gists_url": "https://api.github.com/users/craftzdog/gists{/gist_id}",
                "gravatar_id": "",
                "html_url": "https://github.com/craftzdog",
                "id": 1332805,
                "login": "craftzdog",
                "node_id": "MDQ6VXNlcjEzMzI4MDU=",
                "organizations_url": "https://api.github.com/users/craftzdog/orgs",
                "received_events_url": "https://api.github.com/users/craftzdog/received_events",
                "repos_url": "https://api.github.com/users/craftzdog/repos",
                "site_admin": false,
                "starred_url": "https://api.github.com/users/craftzdog/starred{/owner}{/repo}",
                "subscriptions_url": "https://api.github.com/users/craftzdog/subscriptions",
                "type": "User",
                "url": "https://api.github.com/users/craftzdog"
            }
        },
        {
            "author_association": "CONTRIBUTOR",
            "body": "Related\r\nhttps://github.com/neovim/neovim/pull/16038\r\nhttps://github.com/neovim/neovim/pull/15561",
            "created_at": "2021-11-20T08:50:20Z",
            "html_url": "https://github.com/neovim/neovim/issues/14645#issuecomment-974617669",
            "id": 974617669,
            "issue_url": "https://api.github.com/repos/neovim/neovim/issues/14645",
            "node_id": "IC_kwDOAPphoM46F3xF",
            "performed_via_github_app": null,
            "reactions": {
                "+1": 1,
                "-1": 0,
                "confused": 0,
                "eyes": 0,
                "heart": 0,
                "hooray": 0,
                "laugh": 0,
                "rocket": 0,
                "total_count": 1,
                "url": "https://api.github.com/repos/neovim/neovim/issues/comments/974617669/reactions"
            },
            "updated_at": "2021-11-20T08:50:20Z",
            "url": "https://api.github.com/repos/neovim/neovim/issues/comments/974617669",
            "user": {
                "avatar_url": "https://avatars.githubusercontent.com/u/629908?v=4",
                "events_url": "https://api.github.com/users/hrsh7th/events{/privacy}",
                "followers_url": "https://api.github.com/users/hrsh7th/followers",
                "following_url": "https://api.github.com/users/hrsh7th/following{/other_user}",
                "gists_url": "https://api.github.com/users/hrsh7th/gists{/gist_id}",
                "gravatar_id": "",
                "html_url": "https://github.com/hrsh7th",
                "id": 629908,
                "login": "hrsh7th",
                "node_id": "MDQ6VXNlcjYyOTkwOA==",
                "organizations_url": "https://api.github.com/users/hrsh7th/orgs",
                "received_events_url": "https://api.github.com/users/hrsh7th/received_events",
                "repos_url": "https://api.github.com/users/hrsh7th/repos",
                "site_admin": false,
                "starred_url": "https://api.github.com/users/hrsh7th/starred{/owner}{/repo}",
                "subscriptions_url": "https://api.github.com/users/hrsh7th/subscriptions",
                "type": "User",
                "url": "https://api.github.com/users/hrsh7th"
            }
        },
        {
            "author_association": "CONTRIBUTOR",
            "body": "This doesn't seem to be the case when I open main.c, split the window, and call format on the original window. I need a more clear reproduction case (not null-ls, EFM, or any of these adapter servers)",
            "created_at": "2021-12-31T17:02:31Z",
            "html_url": "https://github.com/neovim/neovim/issues/14645#issuecomment-1003418619",
            "id": 1003418619,
            "issue_url": "https://api.github.com/repos/neovim/neovim/issues/14645",
            "node_id": "IC_kwDOAPphoM47zvP7",
            "performed_via_github_app": null,
            "reactions": {
                "+1": 0,
                "-1": 0,
                "confused": 0,
                "eyes": 0,
                "heart": 0,
                "hooray": 0,
                "laugh": 0,
                "rocket": 0,
                "total_count": 0,
                "url": "https://api.github.com/repos/neovim/neovim/issues/comments/1003418619/reactions"
            },
            "updated_at": "2021-12-31T17:02:31Z",
            "url": "https://api.github.com/repos/neovim/neovim/issues/comments/1003418619",
            "user": {
                "avatar_url": "https://avatars.githubusercontent.com/u/13316262?v=4",
                "events_url": "https://api.github.com/users/mjlbach/events{/privacy}",
                "followers_url": "https://api.github.com/users/mjlbach/followers",
                "following_url": "https://api.github.com/users/mjlbach/following{/other_user}",
                "gists_url": "https://api.github.com/users/mjlbach/gists{/gist_id}",
                "gravatar_id": "",
                "html_url": "https://github.com/mjlbach",
                "id": 13316262,
                "login": "mjlbach",
                "node_id": "MDQ6VXNlcjEzMzE2MjYy",
                "organizations_url": "https://api.github.com/users/mjlbach/orgs",
                "received_events_url": "https://api.github.com/users/mjlbach/received_events",
                "repos_url": "https://api.github.com/users/mjlbach/repos",
                "site_admin": false,
                "starred_url": "https://api.github.com/users/mjlbach/starred{/owner}{/repo}",
                "subscriptions_url": "https://api.github.com/users/mjlbach/subscriptions",
                "type": "User",
                "url": "https://api.github.com/users/mjlbach"
            }
        },
        {
            "author_association": "CONTRIBUTOR",
            "body": "@mjlbach You should be able to reproduce it using the following Rust file:\r\n\r\n```rust\r\nfn main() {\r\n    println!(\r\n        \"{}\",\r\n        42\r\n    );\r\n}\r\n```\r\n\r\nOpen this file in two vertical splits. In the right split, move the cursor to `4`. In the left split, move the cursor to the `p` in `println!`. So like this:\r\n\r\n```\r\nfn main() {       |  fn main() {\r\n    [p]rintln!(   |      println!(\r\n        \"{}\",     |          \"{}\",\r\n        42        |          [4]2\r\n    );            |      );\r\n}                 |  }\r\n```\r\n\r\nWhere `[X]` it the block/visual cursor position.\r\n\r\nThen format the file. If you move the cursor back to the right split, it's moved to the start of the file; instead of being located at `4`. With my extmarks hack it sort of works but not always (e.g. in this case the cursor ends up at `)` and not `4`, but most of the time it's where I would expect it).",
            "created_at": "2021-12-31T20:41:34Z",
            "html_url": "https://github.com/neovim/neovim/issues/14645#issuecomment-1003448585",
            "id": 1003448585,
            "issue_url": "https://api.github.com/repos/neovim/neovim/issues/14645",
            "node_id": "IC_kwDOAPphoM47z2kJ",
            "performed_via_github_app": null,
            "reactions": {
                "+1": 0,
                "-1": 0,
                "confused": 0,
                "eyes": 0,
                "heart": 0,
                "hooray": 0,
                "laugh": 0,
                "rocket": 0,
                "total_count": 0,
                "url": "https://api.github.com/repos/neovim/neovim/issues/comments/1003448585/reactions"
            },
            "updated_at": "2021-12-31T20:44:40Z",
            "url": "https://api.github.com/repos/neovim/neovim/issues/comments/1003448585",
            "user": {
                "avatar_url": "https://avatars.githubusercontent.com/u/86065?v=4",
                "events_url": "https://api.github.com/users/yorickpeterse/events{/privacy}",
                "followers_url": "https://api.github.com/users/yorickpeterse/followers",
                "following_url": "https://api.github.com/users/yorickpeterse/following{/other_user}",
                "gists_url": "https://api.github.com/users/yorickpeterse/gists{/gist_id}",
                "gravatar_id": "",
                "html_url": "https://github.com/yorickpeterse",
                "id": 86065,
                "login": "yorickpeterse",
                "node_id": "MDQ6VXNlcjg2MDY1",
                "organizations_url": "https://api.github.com/users/yorickpeterse/orgs",
                "received_events_url": "https://api.github.com/users/yorickpeterse/received_events",
                "repos_url": "https://api.github.com/users/yorickpeterse/repos",
                "site_admin": false,
                "starred_url": "https://api.github.com/users/yorickpeterse/starred{/owner}{/repo}",
                "subscriptions_url": "https://api.github.com/users/yorickpeterse/subscriptions",
                "type": "User",
                "url": "https://api.github.com/users/yorickpeterse"
            }
        },
        {
            "author_association": "CONTRIBUTOR",
            "body": "I don't think fix_cursor is the issue, I'm not exactly sure where in the vim codebase the cursor is adjusted when switching back to another window. fix_cursor was only triggered on the primary window and correctly adjusts the cursor position.",
            "created_at": "2022-01-02T14:49:05Z",
            "html_url": "https://github.com/neovim/neovim/issues/14645#issuecomment-1003727114",
            "id": 1003727114,
            "issue_url": "https://api.github.com/repos/neovim/neovim/issues/14645",
            "node_id": "IC_kwDOAPphoM4706kK",
            "performed_via_github_app": null,
            "reactions": {
                "+1": 0,
                "-1": 0,
                "confused": 0,
                "eyes": 0,
                "heart": 0,
                "hooray": 0,
                "laugh": 0,
                "rocket": 0,
                "total_count": 0,
                "url": "https://api.github.com/repos/neovim/neovim/issues/comments/1003727114/reactions"
            },
            "updated_at": "2022-01-02T14:49:05Z",
            "url": "https://api.github.com/repos/neovim/neovim/issues/comments/1003727114",
            "user": {
                "avatar_url": "https://avatars.githubusercontent.com/u/13316262?v=4",
                "events_url": "https://api.github.com/users/mjlbach/events{/privacy}",
                "followers_url": "https://api.github.com/users/mjlbach/followers",
                "following_url": "https://api.github.com/users/mjlbach/following{/other_user}",
                "gists_url": "https://api.github.com/users/mjlbach/gists{/gist_id}",
                "gravatar_id": "",
                "html_url": "https://github.com/mjlbach",
                "id": 13316262,
                "login": "mjlbach",
                "node_id": "MDQ6VXNlcjEzMzE2MjYy",
                "organizations_url": "https://api.github.com/users/mjlbach/orgs",
                "received_events_url": "https://api.github.com/users/mjlbach/received_events",
                "repos_url": "https://api.github.com/users/mjlbach/repos",
                "site_admin": false,
                "starred_url": "https://api.github.com/users/mjlbach/starred{/owner}{/repo}",
                "subscriptions_url": "https://api.github.com/users/mjlbach/subscriptions",
                "type": "User",
                "url": "https://api.github.com/users/mjlbach"
            }
        },
        {
            "author_association": "CONTRIBUTOR",
            "body": "Found that formatting with `nvim_lsp.diagnosticls` breaks the extmarks.\r\nUsing `prettier.nvim` and `null-ls.nvim` instead of `nvim_lsp.diagnosticls` solved the issue.\r\nMy configuration looks like so:\r\n\r\n```lua\r\nlocal null_ls = require('null-ls')\r\n\r\nnull_ls.setup({\r\n  on_attach = function(client, bufnr)\r\n    if client.server_capabilities.documentFormattingProvider then\r\n      vim.api.nvim_command [[augroup Format]]\r\n      vim.api.nvim_command [[autocmd! * <buffer>]]\r\n      vim.api.nvim_command [[autocmd BufWritePre <buffer> lua vim.lsp.buf.formatting_seq_sync()]]\r\n      vim.api.nvim_command [[augroup END]]\r\n    end\r\n  end\r\n})\r\n\r\nlocal prettier = require('prettier')\r\n\r\nprettier.setup {\r\n  bin = 'prettier',\r\n  filetypes = {\r\n    \"css\",\r\n    \"javascript\",\r\n    \"javascriptreact\",\r\n    \"json\",\r\n    \"scss\",\r\n    \"less\"\r\n  }\r\n}\r\n```\r\n\r\nThanks!",
            "created_at": "2022-07-08T02:49:32Z",
            "html_url": "https://github.com/neovim/neovim/issues/14645#issuecomment-1178482114",
            "id": 1178482114,
            "issue_url": "https://api.github.com/repos/neovim/neovim/issues/14645",
            "node_id": "IC_kwDOAPphoM5GPjXC",
            "performed_via_github_app": null,
            "reactions": {
                "+1": 1,
                "-1": 0,
                "confused": 0,
                "eyes": 0,
                "heart": 0,
                "hooray": 0,
                "laugh": 0,
                "rocket": 0,
                "total_count": 1,
                "url": "https://api.github.com/repos/neovim/neovim/issues/comments/1178482114/reactions"
            },
            "updated_at": "2022-07-08T02:49:32Z",
            "url": "https://api.github.com/repos/neovim/neovim/issues/comments/1178482114",
            "user": {
                "avatar_url": "https://avatars.githubusercontent.com/u/1332805?v=4",
                "events_url": "https://api.github.com/users/craftzdog/events{/privacy}",
                "followers_url": "https://api.github.com/users/craftzdog/followers",
                "following_url": "https://api.github.com/users/craftzdog/following{/other_user}",
                "gists_url": "https://api.github.com/users/craftzdog/gists{/gist_id}",
                "gravatar_id": "",
                "html_url": "https://github.com/craftzdog",
                "id": 1332805,
                "login": "craftzdog",
                "node_id": "MDQ6VXNlcjEzMzI4MDU=",
                "organizations_url": "https://api.github.com/users/craftzdog/orgs",
                "received_events_url": "https://api.github.com/users/craftzdog/received_events",
                "repos_url": "https://api.github.com/users/craftzdog/repos",
                "site_admin": false,
                "starred_url": "https://api.github.com/users/craftzdog/starred{/owner}{/repo}",
                "subscriptions_url": "https://api.github.com/users/craftzdog/subscriptions",
                "type": "User",
                "url": "https://api.github.com/users/craftzdog"
            }
        },
        {
            "author_association": "NONE",
            "body": "So, this is kind of (kind of) old problem. Has it been fixed by any of the latest releases? I'm on NVIM v0.8.2 and this bug is still there",
            "created_at": "2023-02-16T18:42:02Z",
            "html_url": "https://github.com/neovim/neovim/issues/14645#issuecomment-1433554080",
            "id": 1433554080,
            "issue_url": "https://api.github.com/repos/neovim/neovim/issues/14645",
            "node_id": "IC_kwDOAPphoM5Vckyg",
            "performed_via_github_app": null,
            "reactions": {
                "+1": 3,
                "-1": 0,
                "confused": 0,
                "eyes": 1,
                "heart": 0,
                "hooray": 0,
                "laugh": 0,
                "rocket": 0,
                "total_count": 4,
                "url": "https://api.github.com/repos/neovim/neovim/issues/comments/1433554080/reactions"
            },
            "updated_at": "2023-02-16T18:42:02Z",
            "url": "https://api.github.com/repos/neovim/neovim/issues/comments/1433554080",
            "user": {
                "avatar_url": "https://avatars.githubusercontent.com/u/2270425?v=4",
                "events_url": "https://api.github.com/users/danielo515/events{/privacy}",
                "followers_url": "https://api.github.com/users/danielo515/followers",
                "following_url": "https://api.github.com/users/danielo515/following{/other_user}",
                "gists_url": "https://api.github.com/users/danielo515/gists{/gist_id}",
                "gravatar_id": "",
                "html_url": "https://github.com/danielo515",
                "id": 2270425,
                "login": "danielo515",
                "node_id": "MDQ6VXNlcjIyNzA0MjU=",
                "organizations_url": "https://api.github.com/users/danielo515/orgs",
                "received_events_url": "https://api.github.com/users/danielo515/received_events",
                "repos_url": "https://api.github.com/users/danielo515/repos",
                "site_admin": false,
                "starred_url": "https://api.github.com/users/danielo515/starred{/owner}{/repo}",
                "subscriptions_url": "https://api.github.com/users/danielo515/subscriptions",
                "type": "User",
                "url": "https://api.github.com/users/danielo515"
            }
        },
        {
            "author_association": "NONE",
            "body": "This is still an issue, and it seems `vim.lsp.buf.formatting_seq_sync()` is deprecated.",
            "created_at": "2023-08-12T14:42:59Z",
            "html_url": "https://github.com/neovim/neovim/issues/14645#issuecomment-1675945202",
            "id": 1675945202,
            "issue_url": "https://api.github.com/repos/neovim/neovim/issues/14645",
            "node_id": "IC_kwDOAPphoM5j5OTy",
            "performed_via_github_app": null,
            "reactions": {
                "+1": 0,
                "-1": 0,
                "confused": 0,
                "eyes": 0,
                "heart": 0,
                "hooray": 0,
                "laugh": 0,
                "rocket": 0,
                "total_count": 0,
                "url": "https://api.github.com/repos/neovim/neovim/issues/comments/1675945202/reactions"
            },
            "updated_at": "2023-08-12T14:42:59Z",
            "url": "https://api.github.com/repos/neovim/neovim/issues/comments/1675945202",
            "user": {
                "avatar_url": "https://avatars.githubusercontent.com/u/3134479?v=4",
                "events_url": "https://api.github.com/users/Pezhvak/events{/privacy}",
                "followers_url": "https://api.github.com/users/Pezhvak/followers",
                "following_url": "https://api.github.com/users/Pezhvak/following{/other_user}",
                "gists_url": "https://api.github.com/users/Pezhvak/gists{/gist_id}",
                "gravatar_id": "",
                "html_url": "https://github.com/Pezhvak",
                "id": 3134479,
                "login": "Pezhvak",
                "node_id": "MDQ6VXNlcjMxMzQ0Nzk=",
                "organizations_url": "https://api.github.com/users/Pezhvak/orgs",
                "received_events_url": "https://api.github.com/users/Pezhvak/received_events",
                "repos_url": "https://api.github.com/users/Pezhvak/repos",
                "site_admin": false,
                "starred_url": "https://api.github.com/users/Pezhvak/starred{/owner}{/repo}",
                "subscriptions_url": "https://api.github.com/users/Pezhvak/subscriptions",
                "type": "User",
                "url": "https://api.github.com/users/Pezhvak"
            }
        }
    ],
    "comments": 25,
    "comments_url": "https://api.github.com/repos/neovim/neovim/issues/14645/comments",
    "created_at": "2021-05-26T14:13:01Z",
    "events_url": "https://api.github.com/repos/neovim/neovim/issues/14645/events",
    "html_url": "https://github.com/neovim/neovim/issues/14645",
    "id": 902456739,
    "labels": [
        {
            "color": "f9d0c4",
            "default": true,
            "description": "issues reporting wrong behavior",
            "id": 77997474,
            "name": "bug",
            "node_id": "MDU6TGFiZWw3Nzk5NzQ3NA==",
            "url": "https://api.github.com/repos/neovim/neovim/labels/bug"
        },
        {
            "color": "c5def5",
            "default": false,
            "description": null,
            "id": 662566370,
            "name": "lsp",
            "node_id": "MDU6TGFiZWw2NjI1NjYzNzA=",
            "url": "https://api.github.com/repos/neovim/neovim/labels/lsp"
        }
    ],
    "labels_url": "https://api.github.com/repos/neovim/neovim/issues/14645/labels{/name}",
    "locked": false,
    "milestone": {
        "closed_at": null,
        "closed_issues": 572,
        "created_at": "2014-05-10T20:43:04Z",
        "creator": {
            "avatar_url": "https://avatars.githubusercontent.com/u/1359421?v=4",
            "events_url": "https://api.github.com/users/justinmk/events{/privacy}",
            "followers_url": "https://api.github.com/users/justinmk/followers",
            "following_url": "https://api.github.com/users/justinmk/following{/other_user}",
            "gists_url": "https://api.github.com/users/justinmk/gists{/gist_id}",
            "gravatar_id": "",
            "html_url": "https://github.com/justinmk",
            "id": 1359421,
            "login": "justinmk",
            "node_id": "MDQ6VXNlcjEzNTk0MjE=",
            "organizations_url": "https://api.github.com/users/justinmk/orgs",
            "received_events_url": "https://api.github.com/users/justinmk/received_events",
            "repos_url": "https://api.github.com/users/justinmk/repos",
            "site_admin": false,
            "starred_url": "https://api.github.com/users/justinmk/starred{/owner}{/repo}",
            "subscriptions_url": "https://api.github.com/users/justinmk/subscriptions",
            "type": "User",
            "url": "https://api.github.com/users/justinmk"
        },
        "description": "Low priority. Not planned for the current target, may be reassigned.",
        "due_on": null,
        "html_url": "https://github.com/neovim/neovim/milestone/6",
        "id": 655037,
        "labels_url": "https://api.github.com/repos/neovim/neovim/milestones/6/labels",
        "node_id": "MDk6TWlsZXN0b25lNjU1MDM3",
        "number": 6,
        "open_issues": 420,
        "state": "open",
        "title": "backlog",
        "updated_at": "2023-08-12T16:52:48Z",
        "url": "https://api.github.com/repos/neovim/neovim/milestones/6"
    },
    "node_id": "MDU6SXNzdWU5MDI0NTY3Mzk=",
    "number": 14645,
    "performed_via_github_app": null,
    "reactions": {
        "+1": 10,
        "-1": 0,
        "confused": 0,
        "eyes": 0,
        "heart": 0,
        "hooray": 0,
        "laugh": 0,
        "rocket": 0,
        "total_count": 10,
        "url": "https://api.github.com/repos/neovim/neovim/issues/14645/reactions"
    },
    "repository_url": "https://api.github.com/repos/neovim/neovim",
    "state": "open",
    "state_reason": null,
    "timeline_url": "https://api.github.com/repos/neovim/neovim/issues/14645/timeline",
    "title": "`vim.lsp.buf.formatting` resets position of same buffer on different window",
    "updated_at": "2023-08-12T14:42:59Z",
    "url": "https://api.github.com/repos/neovim/neovim/issues/14645",
    "user": {
        "avatar_url": "https://avatars.githubusercontent.com/u/11579064?v=4",
        "events_url": "https://api.github.com/users/alexisquintero/events{/privacy}",
        "followers_url": "https://api.github.com/users/alexisquintero/followers",
        "following_url": "https://api.github.com/users/alexisquintero/following{/other_user}",
        "gists_url": "https://api.github.com/users/alexisquintero/gists{/gist_id}",
        "gravatar_id": "",
        "html_url": "https://github.com/alexisquintero",
        "id": 11579064,
        "login": "alexisquintero",
        "node_id": "MDQ6VXNlcjExNTc5MDY0",
        "organizations_url": "https://api.github.com/users/alexisquintero/orgs",
        "received_events_url": "https://api.github.com/users/alexisquintero/received_events",
        "repos_url": "https://api.github.com/users/alexisquintero/repos",
        "site_admin": false,
        "starred_url": "https://api.github.com/users/alexisquintero/starred{/owner}{/repo}",
        "subscriptions_url": "https://api.github.com/users/alexisquintero/subscriptions",
        "type": "User",
        "url": "https://api.github.com/users/alexisquintero"
    }
}