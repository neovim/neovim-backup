{
    "active_lock_reason": null,
    "assignee": null,
    "assignees": [],
    "author_association": "NONE",
    "body": "### Neovim version (nvim -v)\r\n\r\nNVIM v0.8.0-dev+141-g55187de11\r\n\r\n### Vim (not Nvim) behaves the same?\r\n\r\nN/A\r\n\r\n### Operating system/version\r\n\r\nN/A\r\n\r\n### Terminal name/version\r\n\r\nN/A\r\n\r\n### $TERM environment variable\r\n\r\nN/A\r\n\r\n### Installation\r\n\r\nN/A\r\n\r\n### How to reproduce the issue\r\n\r\nGiven the following steps in lua:\r\n\r\n```lua\r\nvim.api.nvim_buf_set_text(0, 0, 0, 0, 0, {'one'})\r\nvim.api.nvim_input('ciw')\r\nvim.api.nvim_buf_set_text(0, 0, 0, 0, 0, {'two'})\r\nvim.api.nvim_input('<Esc>u')\r\nvim.api.nvim_input('.')\r\n```\r\n\r\n### Expected behavior\r\n\r\nThe buffer contains \"two\".\r\n\r\n\r\n\r\n\r\n### Actual behavior\r\n\r\nThe buffer is empty (the ciw was repeated, but not the insertion).\r\n\r\n`nvim_buf_set_text` should only update dot repeat if the change is in one continuous region (someone typing or deleting). The changes should be accumulated until there is a discontunity.\r\n\r\nEssentially, if `start == end` (insertion), or `replacement == [\"\"]` (deletion), dot-repeat should accumulate just like `nvim_input` in insert mode. \r\n\r\n## Background\r\nThis is very important for vscode-neovim to improve reliablility and remove significant workarounds and bloat. \r\nhttps://github.com/vscode-neovim/vscode-neovim/pull/992\r\n\r\nVscode handles typing in insert mode, and then sends document changes to nvim via `nvim_buf_set_text` or `nvim_buf_set_lines`. However, because neovim does not properly record dot repeat, a workaround is currently needed that opens a scratch buffer, replays the changes by typing, and then returns to the original buffer. ",
    "closed_at": null,
    "closed_by": null,
    "comment_data": [
        {
            "author_association": "CONTRIBUTOR",
            "body": "I try to share my knowledges.\r\n\r\n1. nvim-cmp uses `feedkeys` function to modify current line with updating dot-repeat register.\r\n2. coc.nvim uses `complete` function to modify current line with updating dot-repeat register.\r\n\r\nIn vim, I don't know of any function that modifies the dot-repeat register in a function intended to modify the text of the buffer.\r\n\r\nBut as one of the plugin author, I think this feature is very useful.",
            "created_at": "2022-08-19T14:14:19Z",
            "html_url": "https://github.com/neovim/neovim/issues/19806#issuecomment-1220730978",
            "id": 1220730978,
            "issue_url": "https://api.github.com/repos/neovim/neovim/issues/19806",
            "node_id": "IC_kwDOAPphoM5IwuBi",
            "performed_via_github_app": null,
            "reactions": {
                "+1": 2,
                "-1": 0,
                "confused": 0,
                "eyes": 0,
                "heart": 0,
                "hooray": 0,
                "laugh": 0,
                "rocket": 0,
                "total_count": 2,
                "url": "https://api.github.com/repos/neovim/neovim/issues/comments/1220730978/reactions"
            },
            "updated_at": "2022-08-19T14:14:19Z",
            "url": "https://api.github.com/repos/neovim/neovim/issues/comments/1220730978",
            "user": {
                "avatar_url": "https://avatars.githubusercontent.com/u/629908?v=4",
                "events_url": "https://api.github.com/users/hrsh7th/events{/privacy}",
                "followers_url": "https://api.github.com/users/hrsh7th/followers",
                "following_url": "https://api.github.com/users/hrsh7th/following{/other_user}",
                "gists_url": "https://api.github.com/users/hrsh7th/gists{/gist_id}",
                "gravatar_id": "",
                "html_url": "https://github.com/hrsh7th",
                "id": 629908,
                "login": "hrsh7th",
                "node_id": "MDQ6VXNlcjYyOTkwOA==",
                "organizations_url": "https://api.github.com/users/hrsh7th/orgs",
                "received_events_url": "https://api.github.com/users/hrsh7th/received_events",
                "repos_url": "https://api.github.com/users/hrsh7th/repos",
                "site_admin": false,
                "starred_url": "https://api.github.com/users/hrsh7th/starred{/owner}{/repo}",
                "subscriptions_url": "https://api.github.com/users/hrsh7th/subscriptions",
                "type": "User",
                "url": "https://api.github.com/users/hrsh7th",
                "user_view_type": "public"
            }
        },
        {
            "author_association": "NONE",
            "body": "This feature could also be partially resolved by manually writing to the dot repeat register. Technically, this is possible by using operatorfunc to trigger a nvim_input, but the problem is **there is no way to recover the way insert mode was entered**.\n\nFor example, if you type `ciwtest`, `getreg(\".\")` will return \"test\", not \"ciwtest\". Thus, it is impossible to fully reconstruct the dotrepeat sequence in order to overwrite the register.\n\nAny other suggestions on how to do this, or can progress be made on the issue? Thanks!",
            "created_at": "2024-02-03T20:40:15Z",
            "html_url": "https://github.com/neovim/neovim/issues/19806#issuecomment-1925450185",
            "id": 1925450185,
            "issue_url": "https://api.github.com/repos/neovim/neovim/issues/19806",
            "node_id": "IC_kwDOAPphoM5yxAnJ",
            "performed_via_github_app": null,
            "reactions": {
                "+1": 0,
                "-1": 0,
                "confused": 0,
                "eyes": 0,
                "heart": 0,
                "hooray": 0,
                "laugh": 0,
                "rocket": 0,
                "total_count": 0,
                "url": "https://api.github.com/repos/neovim/neovim/issues/comments/1925450185/reactions"
            },
            "updated_at": "2024-02-03T20:40:48Z",
            "url": "https://api.github.com/repos/neovim/neovim/issues/comments/1925450185",
            "user": {
                "avatar_url": "https://avatars.githubusercontent.com/u/16546293?v=4",
                "events_url": "https://api.github.com/users/theol0403/events{/privacy}",
                "followers_url": "https://api.github.com/users/theol0403/followers",
                "following_url": "https://api.github.com/users/theol0403/following{/other_user}",
                "gists_url": "https://api.github.com/users/theol0403/gists{/gist_id}",
                "gravatar_id": "",
                "html_url": "https://github.com/theol0403",
                "id": 16546293,
                "login": "theol0403",
                "node_id": "MDQ6VXNlcjE2NTQ2Mjkz",
                "organizations_url": "https://api.github.com/users/theol0403/orgs",
                "received_events_url": "https://api.github.com/users/theol0403/received_events",
                "repos_url": "https://api.github.com/users/theol0403/repos",
                "site_admin": false,
                "starred_url": "https://api.github.com/users/theol0403/starred{/owner}{/repo}",
                "subscriptions_url": "https://api.github.com/users/theol0403/subscriptions",
                "type": "User",
                "url": "https://api.github.com/users/theol0403",
                "user_view_type": "public"
            }
        },
        {
            "author_association": "MEMBER",
            "body": "The current interface for any script/client that wants to dot-repeat text input is to use `nvim_paste`. However, `nvim_paste` doesn't have a way to \"replace\" text (unlik `nvim_buf_set_text`).\r\n\r\nhttps://github.com/neovim/neovim/pull/30438 implements a reliable (internal) framework for setting up dot repeat. That opens the door for potentially enabling dot-repeat for things like `nvim_buf_set_text`.\r\n\r\nI think we should probably replace all of these functions with 2 APIs: https://github.com/neovim/neovim/issues/30450\r\n\r\n- `nvim_text_put`\r\n- `nvim_text_set`\r\n\r\nAnd this time, include an `opts` parameter so that we don't need to keep adding new APIs....",
            "created_at": "2024-09-21T11:06:55Z",
            "html_url": "https://github.com/neovim/neovim/issues/19806#issuecomment-2365146298",
            "id": 2365146298,
            "issue_url": "https://api.github.com/repos/neovim/neovim/issues/19806",
            "node_id": "IC_kwDOAPphoM6M-US6",
            "performed_via_github_app": null,
            "reactions": {
                "+1": 8,
                "-1": 0,
                "confused": 0,
                "eyes": 0,
                "heart": 0,
                "hooray": 0,
                "laugh": 0,
                "rocket": 0,
                "total_count": 8,
                "url": "https://api.github.com/repos/neovim/neovim/issues/comments/2365146298/reactions"
            },
            "updated_at": "2024-09-21T11:39:38Z",
            "url": "https://api.github.com/repos/neovim/neovim/issues/comments/2365146298",
            "user": {
                "avatar_url": "https://avatars.githubusercontent.com/u/1359421?v=4",
                "events_url": "https://api.github.com/users/justinmk/events{/privacy}",
                "followers_url": "https://api.github.com/users/justinmk/followers",
                "following_url": "https://api.github.com/users/justinmk/following{/other_user}",
                "gists_url": "https://api.github.com/users/justinmk/gists{/gist_id}",
                "gravatar_id": "",
                "html_url": "https://github.com/justinmk",
                "id": 1359421,
                "login": "justinmk",
                "node_id": "MDQ6VXNlcjEzNTk0MjE=",
                "organizations_url": "https://api.github.com/users/justinmk/orgs",
                "received_events_url": "https://api.github.com/users/justinmk/received_events",
                "repos_url": "https://api.github.com/users/justinmk/repos",
                "site_admin": false,
                "starred_url": "https://api.github.com/users/justinmk/starred{/owner}{/repo}",
                "subscriptions_url": "https://api.github.com/users/justinmk/subscriptions",
                "type": "User",
                "url": "https://api.github.com/users/justinmk",
                "user_view_type": "public"
            }
        }
    ],
    "comments": 3,
    "comments_url": "https://api.github.com/repos/neovim/neovim/issues/19806/comments",
    "created_at": "2022-08-16T19:34:22Z",
    "events_url": "https://api.github.com/repos/neovim/neovim/issues/19806/events",
    "html_url": "https://github.com/neovim/neovim/issues/19806",
    "id": 1340793556,
    "labels": [
        {
            "color": "f9d0c4",
            "default": true,
            "description": "issues reporting wrong behavior",
            "id": 77997474,
            "name": "bug",
            "node_id": "MDU6TGFiZWw3Nzk5NzQ3NA==",
            "url": "https://api.github.com/repos/neovim/neovim/labels/bug"
        },
        {
            "color": "c5def5",
            "default": false,
            "description": "libnvim, Nvim RPC API",
            "id": 103819671,
            "name": "api",
            "node_id": "MDU6TGFiZWwxMDM4MTk2NzE=",
            "url": "https://api.github.com/repos/neovim/neovim/labels/api"
        },
        {
            "color": "FBCA04",
            "default": false,
            "description": "issue needs attention from an expert, or PR proposes significant changes to architecture or API",
            "id": 212680983,
            "name": "needs:discussion",
            "node_id": "MDU6TGFiZWwyMTI2ODA5ODM=",
            "url": "https://api.github.com/repos/neovim/neovim/labels/needs:discussion"
        },
        {
            "color": "C5DEF5",
            "default": false,
            "description": "",
            "id": 5826991063,
            "name": "insert-mode",
            "node_id": "LA_kwDOAPphoM8AAAABW1DT1w",
            "url": "https://api.github.com/repos/neovim/neovim/labels/insert-mode"
        }
    ],
    "labels_url": "https://api.github.com/repos/neovim/neovim/issues/19806/labels{/name}",
    "locked": false,
    "milestone": null,
    "node_id": "I_kwDOAPphoM5P6uLU",
    "number": 19806,
    "performed_via_github_app": null,
    "reactions": {
        "+1": 4,
        "-1": 0,
        "confused": 0,
        "eyes": 0,
        "heart": 0,
        "hooray": 0,
        "laugh": 0,
        "rocket": 0,
        "total_count": 4,
        "url": "https://api.github.com/repos/neovim/neovim/issues/19806/reactions"
    },
    "repository_url": "https://api.github.com/repos/neovim/neovim",
    "state": "open",
    "state_reason": null,
    "sub_issues_summary": {
        "completed": 0,
        "percent_completed": 0,
        "total": 0
    },
    "timeline_url": "https://api.github.com/repos/neovim/neovim/issues/19806/timeline",
    "title": "nvim_buf_set_text in insert mode should update dot repeat",
    "updated_at": "2025-01-19T11:15:31Z",
    "url": "https://api.github.com/repos/neovim/neovim/issues/19806",
    "user": {
        "avatar_url": "https://avatars.githubusercontent.com/u/16546293?v=4",
        "events_url": "https://api.github.com/users/theol0403/events{/privacy}",
        "followers_url": "https://api.github.com/users/theol0403/followers",
        "following_url": "https://api.github.com/users/theol0403/following{/other_user}",
        "gists_url": "https://api.github.com/users/theol0403/gists{/gist_id}",
        "gravatar_id": "",
        "html_url": "https://github.com/theol0403",
        "id": 16546293,
        "login": "theol0403",
        "node_id": "MDQ6VXNlcjE2NTQ2Mjkz",
        "organizations_url": "https://api.github.com/users/theol0403/orgs",
        "received_events_url": "https://api.github.com/users/theol0403/received_events",
        "repos_url": "https://api.github.com/users/theol0403/repos",
        "site_admin": false,
        "starred_url": "https://api.github.com/users/theol0403/starred{/owner}{/repo}",
        "subscriptions_url": "https://api.github.com/users/theol0403/subscriptions",
        "type": "User",
        "url": "https://api.github.com/users/theol0403",
        "user_view_type": "public"
    }
}