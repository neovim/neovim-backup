{
    "active_lock_reason": null,
    "assignee": null,
    "assignees": [],
    "author_association": "CONTRIBUTOR",
    "body": "<!-- Before reporting: search existing issues and check the FAQ. -->\r\n\r\n- `nvim --version`: NVIM v0.4.4\r\n- `vim -u DEFAULTS` (version: 8.1) behaves differently? No\r\n- Operating system/version: macOS\r\n- Terminal name/version: alacritty 0.5.0\r\n- `$TERM`: xterm-256color\r\n\r\n### Steps to reproduce using `nvim -u NORC`\r\n\r\nPut the following in `nvim/ftplugin/tex/folding.vim` or `nvim/after/ftplugin/tex/folding.vim`\r\n\r\n```vim\r\nsetlocal foldmethod=expr\r\nsetlocal foldexpr=LaTeXFoldsExpr(v:lnum)\r\n\r\n\" Sections to be folded\r\nlet g:LaTeXFolds_fold_sections = [\r\n  \\ 'part',\r\n  \\ 'chapter',\r\n  \\ 'section',\r\n  \\ 'subsection',\r\n  \\ 'subsubsection'\r\n  \\ ]\r\n\r\n\" Join all section names in a single regex\r\nlet s:sections_regex = '^\\s*\\\\\\(' . join(g:LaTeXFolds_fold_sections, '\\|') . '\\){\\(.*\\)}\\s*$'\r\n\r\nfunction! s:find_sections()\r\n  \" This function finds which sections in g:LaTeXFolds_fold_sections are\r\n  \" actually present in the document, and returns a dictionary where the keys\r\n  \" are the section names and the values are their foldlevel in the document.\r\n\r\n  let fold_levels = {}\r\n\r\n  let level = 1\r\n  for section in g:LaTeXFolds_fold_sections\r\n    let i = 1\r\n    while i <= line('$')\r\n      if getline(i) =~# '^\\s*\\\\' . section . '{.*'\r\n        let fold_levels[section] = level\r\n        let level += 1\r\n        break\r\n      endif\r\n      let i += 1\r\n    endwhile\r\n  endfor\r\n\r\n  return fold_levels\r\nendfunction\r\n\r\n\" s:find_sections() returns a dictionary where the keys are the section names\r\n\" and the values are their foldlevel in the document.\r\nlet s:fold_levels = s:find_sections()\r\n\r\nfunction! LaTeXFoldsExpr(lnum)\r\n  let line = getline(a:lnum)\r\n\r\n  \" If the line is blank return the fold level of the previous or the next\r\n  \" line, whichever is the lowest.\r\n  if line =~ '^\\s*$' | return '-1' | endif\r\n\r\n  \" Let \\begin{document} and \\end{document} remain unfolded\r\n  if line =~# '^\\s*\\\\\\(begin\\|end\\)\\s*{document}' | return '0' | endif\r\n\r\n  \" If this is a 'regular' line, return the fold level of the previous line\r\n  if line !~# s:sections_regex | return '=' | endif\r\n\r\n  \" If I get here it means the line contains a sectioning command. Find which\r\n  \" one it is and return its fold level.\r\n  let line_section = substitute(line, s:sections_regex, '\\1', '')\r\n  return '>' . s:fold_levels[line_section]\r\nendfunction\r\n```\r\n and open the LaTeX document\r\n\r\n```latex\r\n\\documentclass{book}\r\n\r\n\\begin{document}\r\n\r\n\\chapter{A chapter}\r\n\r\n\\subsection{A subsection after a chapter, no section in between}\r\n\r\nFoo bar baz.\r\n\r\n\\section{A section}\r\n\r\nFoo bar baz.\r\n\r\n\\section{Another section}\r\n\r\nFoo bar baz.\r\n\r\n\\chapter{Another chapter}\r\n\r\nFoo bar baz.\r\n\r\n\\end{document}\r\n```\r\n\r\n### Actual behaviour\r\n\r\nI have 3 questions:\r\n\r\n1. line 7 of the test document contains a `subsection` (fold level = 3) right after a chapter (fold level = 1), with no sections in between. Now when I first open the document, this is what I get:\r\n\r\n[![enter image description here][1]][1]\r\n\r\nyou can see that the fold text of that line contains 3 dashes, same as lines that contain sections. That indicates that neovim thinks that is a second level fold, instead of a third level one, as it should be.\r\n\r\nIndeed, once I toggle the fold with `za`, I don't get to see its contents, instead the fold is now recognized as a level 3 fold, and another dash appears (I'm not going to post another screenshot, it's easy to check that that's what happens).\r\n\r\nOnce that fold is expanded for the first time it then behaves as expected. I suspect that is a bug, correct?\r\n\r\n2. I return `-1` on every blank line. That means the fold level of that line is not yet defined, and it will be set to the fold level of the line before it or after it, whichever is smallest.\r\n\r\nIf that's what's happening, then why does line 14 have a foldlevel of 1, when lines 13 and 15 both have a fold level of 2 (to get the foldlevel of a line simply run `:echo foldlevel(14)`)? \r\n\r\n\r\n3. line 18, which is also blank, is assigned the foldlevel of 1, which is correct since the following line, line 19, starts a new chapter, i.e. a level 1 fold. But then why is it that the fold associated with the first chapter doesn't include it?\r\n\r\n[![enter image description here][2]][2]\r\n\r\nShouldn't lines 5-18 all be in the same level 1 fold? I suspect what is happening is line 18 is in its own level 1 fold, and the fold associated with the first chapter goes from line 5 to 17.\r\n\r\n\r\n  [1]: https://i.stack.imgur.com/JSvIG.png\r\n  [2]: https://i.stack.imgur.com/Svq2b.png\r\n\r\n### Expected behaviour\r\n\r\n1. The subsection gets unfolded when I toggle the fold with `za`;\r\n2. `:echo foldlevel(14)` returns `2`;\r\n3. Lines 5-18 are all in the same level 1 fold.\r\n",
    "closed_at": null,
    "closed_by": {
        "avatar_url": "https://avatars.githubusercontent.com/u/59321248?v=4",
        "events_url": "https://api.github.com/users/noib3/events{/privacy}",
        "followers_url": "https://api.github.com/users/noib3/followers",
        "following_url": "https://api.github.com/users/noib3/following{/other_user}",
        "gists_url": "https://api.github.com/users/noib3/gists{/gist_id}",
        "gravatar_id": "",
        "html_url": "https://github.com/noib3",
        "id": 59321248,
        "login": "noib3",
        "node_id": "MDQ6VXNlcjU5MzIxMjQ4",
        "organizations_url": "https://api.github.com/users/noib3/orgs",
        "received_events_url": "https://api.github.com/users/noib3/received_events",
        "repos_url": "https://api.github.com/users/noib3/repos",
        "site_admin": false,
        "starred_url": "https://api.github.com/users/noib3/starred{/owner}{/repo}",
        "subscriptions_url": "https://api.github.com/users/noib3/subscriptions",
        "type": "User",
        "url": "https://api.github.com/users/noib3",
        "user_view_type": "public"
    },
    "comment_data": [
        {
            "author_association": "MEMBER",
            "body": "For questions about usage/configuration, try https://vi.stackexchange.com or https://neovim.io/#chat. The issue tracker is for bugs and feature requests. Thanks.",
            "created_at": "2020-09-07T18:25:45Z",
            "html_url": "https://github.com/neovim/neovim/issues/12864#issuecomment-688465698",
            "id": 688465698,
            "issue_url": "https://api.github.com/repos/neovim/neovim/issues/12864",
            "node_id": "MDEyOklzc3VlQ29tbWVudDY4ODQ2NTY5OA==",
            "performed_via_github_app": null,
            "reactions": {
                "+1": 0,
                "-1": 0,
                "confused": 0,
                "eyes": 0,
                "heart": 0,
                "hooray": 0,
                "laugh": 0,
                "rocket": 0,
                "total_count": 0,
                "url": "https://api.github.com/repos/neovim/neovim/issues/comments/688465698/reactions"
            },
            "updated_at": "2020-09-07T18:25:45Z",
            "url": "https://api.github.com/repos/neovim/neovim/issues/comments/688465698",
            "user": {
                "avatar_url": "https://avatars.githubusercontent.com/u/1359421?v=4",
                "events_url": "https://api.github.com/users/justinmk/events{/privacy}",
                "followers_url": "https://api.github.com/users/justinmk/followers",
                "following_url": "https://api.github.com/users/justinmk/following{/other_user}",
                "gists_url": "https://api.github.com/users/justinmk/gists{/gist_id}",
                "gravatar_id": "",
                "html_url": "https://github.com/justinmk",
                "id": 1359421,
                "login": "justinmk",
                "node_id": "MDQ6VXNlcjEzNTk0MjE=",
                "organizations_url": "https://api.github.com/users/justinmk/orgs",
                "received_events_url": "https://api.github.com/users/justinmk/received_events",
                "repos_url": "https://api.github.com/users/justinmk/repos",
                "site_admin": false,
                "starred_url": "https://api.github.com/users/justinmk/starred{/owner}{/repo}",
                "subscriptions_url": "https://api.github.com/users/justinmk/subscriptions",
                "type": "User",
                "url": "https://api.github.com/users/justinmk",
                "user_view_type": "public"
            }
        },
        {
            "author_association": "CONTRIBUTOR",
            "body": "> For questions about usage/configuration, try https://vi.stackexchange.com or https://neovim.io/#chat\r\n\r\n@justinmk I probably worded my issue in the wrong by making it sound like a question, but I think points 1. and 2. are bugs, not just questions about neovim usage. Maybe even point 3, but I'm not sure about it.\r\n\r\nI think this issue should be reopened.\r\n\r\nP.S. I already posted this in https://vi.stackexchange.com and I've been told these are probably bugs, hence why I posted this here.",
            "created_at": "2020-09-07T20:30:17Z",
            "html_url": "https://github.com/neovim/neovim/issues/12864#issuecomment-688501066",
            "id": 688501066,
            "issue_url": "https://api.github.com/repos/neovim/neovim/issues/12864",
            "node_id": "MDEyOklzc3VlQ29tbWVudDY4ODUwMTA2Ng==",
            "performed_via_github_app": null,
            "reactions": {
                "+1": 0,
                "-1": 0,
                "confused": 0,
                "eyes": 0,
                "heart": 0,
                "hooray": 0,
                "laugh": 0,
                "rocket": 0,
                "total_count": 0,
                "url": "https://api.github.com/repos/neovim/neovim/issues/comments/688501066/reactions"
            },
            "updated_at": "2020-09-07T20:30:17Z",
            "url": "https://api.github.com/repos/neovim/neovim/issues/comments/688501066",
            "user": {
                "avatar_url": "https://avatars.githubusercontent.com/u/59321248?v=4",
                "events_url": "https://api.github.com/users/noib3/events{/privacy}",
                "followers_url": "https://api.github.com/users/noib3/followers",
                "following_url": "https://api.github.com/users/noib3/following{/other_user}",
                "gists_url": "https://api.github.com/users/noib3/gists{/gist_id}",
                "gravatar_id": "",
                "html_url": "https://github.com/noib3",
                "id": 59321248,
                "login": "noib3",
                "node_id": "MDQ6VXNlcjU5MzIxMjQ4",
                "organizations_url": "https://api.github.com/users/noib3/orgs",
                "received_events_url": "https://api.github.com/users/noib3/received_events",
                "repos_url": "https://api.github.com/users/noib3/repos",
                "site_admin": false,
                "starred_url": "https://api.github.com/users/noib3/starred{/owner}{/repo}",
                "subscriptions_url": "https://api.github.com/users/noib3/subscriptions",
                "type": "User",
                "url": "https://api.github.com/users/noib3",
                "user_view_type": "public"
            }
        },
        {
            "author_association": "MEMBER",
            "body": "Ok, consider reporting the bugs to https://github.com/vim/vim and link to it from here. cc @chrisbra",
            "created_at": "2020-09-07T20:34:05Z",
            "html_url": "https://github.com/neovim/neovim/issues/12864#issuecomment-688502091",
            "id": 688502091,
            "issue_url": "https://api.github.com/repos/neovim/neovim/issues/12864",
            "node_id": "MDEyOklzc3VlQ29tbWVudDY4ODUwMjA5MQ==",
            "performed_via_github_app": null,
            "reactions": {
                "+1": 0,
                "-1": 0,
                "confused": 0,
                "eyes": 0,
                "heart": 0,
                "hooray": 0,
                "laugh": 0,
                "rocket": 0,
                "total_count": 0,
                "url": "https://api.github.com/repos/neovim/neovim/issues/comments/688502091/reactions"
            },
            "updated_at": "2020-09-07T20:34:05Z",
            "url": "https://api.github.com/repos/neovim/neovim/issues/comments/688502091",
            "user": {
                "avatar_url": "https://avatars.githubusercontent.com/u/1359421?v=4",
                "events_url": "https://api.github.com/users/justinmk/events{/privacy}",
                "followers_url": "https://api.github.com/users/justinmk/followers",
                "following_url": "https://api.github.com/users/justinmk/following{/other_user}",
                "gists_url": "https://api.github.com/users/justinmk/gists{/gist_id}",
                "gravatar_id": "",
                "html_url": "https://github.com/justinmk",
                "id": 1359421,
                "login": "justinmk",
                "node_id": "MDQ6VXNlcjEzNTk0MjE=",
                "organizations_url": "https://api.github.com/users/justinmk/orgs",
                "received_events_url": "https://api.github.com/users/justinmk/received_events",
                "repos_url": "https://api.github.com/users/justinmk/repos",
                "site_admin": false,
                "starred_url": "https://api.github.com/users/justinmk/starred{/owner}{/repo}",
                "subscriptions_url": "https://api.github.com/users/justinmk/subscriptions",
                "type": "User",
                "url": "https://api.github.com/users/justinmk",
                "user_view_type": "public"
            }
        }
    ],
    "comments": 3,
    "comments_url": "https://api.github.com/repos/neovim/neovim/issues/12864/comments",
    "created_at": "2020-09-06T22:01:53Z",
    "events_url": "https://api.github.com/repos/neovim/neovim/issues/12864/events",
    "html_url": "https://github.com/neovim/neovim/issues/12864",
    "id": 694544679,
    "labels": [
        {
            "color": "F9D0C4",
            "default": false,
            "description": "wrong behavior inherited from vim",
            "id": 154310492,
            "name": "bug-vim",
            "node_id": "MDU6TGFiZWwxNTQzMTA0OTI=",
            "url": "https://api.github.com/repos/neovim/neovim/labels/bug-vim"
        },
        {
            "color": "c5def5",
            "default": false,
            "description": "Nvim core functionality or code",
            "id": 858327504,
            "name": "core",
            "node_id": "MDU6TGFiZWw4NTgzMjc1MDQ=",
            "url": "https://api.github.com/repos/neovim/neovim/labels/core"
        },
        {
            "color": "FBCA04",
            "default": false,
            "description": "upstream issue that must be fixed in Vim first",
            "id": 2639399975,
            "name": "needs:vim-patch",
            "node_id": "MDU6TGFiZWwyNjM5Mzk5OTc1",
            "url": "https://api.github.com/repos/neovim/neovim/labels/needs:vim-patch"
        }
    ],
    "labels_url": "https://api.github.com/repos/neovim/neovim/issues/12864/labels{/name}",
    "locked": false,
    "milestone": {
        "closed_at": null,
        "closed_issues": 260,
        "created_at": "2014-11-26T22:13:11Z",
        "creator": {
            "avatar_url": "https://avatars.githubusercontent.com/u/1359421?v=4",
            "events_url": "https://api.github.com/users/justinmk/events{/privacy}",
            "followers_url": "https://api.github.com/users/justinmk/followers",
            "following_url": "https://api.github.com/users/justinmk/following{/other_user}",
            "gists_url": "https://api.github.com/users/justinmk/gists{/gist_id}",
            "gravatar_id": "",
            "html_url": "https://github.com/justinmk",
            "id": 1359421,
            "login": "justinmk",
            "node_id": "MDQ6VXNlcjEzNTk0MjE=",
            "organizations_url": "https://api.github.com/users/justinmk/orgs",
            "received_events_url": "https://api.github.com/users/justinmk/received_events",
            "repos_url": "https://api.github.com/users/justinmk/repos",
            "site_admin": false,
            "starred_url": "https://api.github.com/users/justinmk/starred{/owner}{/repo}",
            "subscriptions_url": "https://api.github.com/users/justinmk/subscriptions",
            "type": "User",
            "url": "https://api.github.com/users/justinmk",
            "user_view_type": "public"
        },
        "description": "We don't plan to work on this, but will accept high quality contributions from someone who will own the feature and follow up on bug reports.",
        "due_on": null,
        "html_url": "https://github.com/neovim/neovim/milestone/9",
        "id": 881978,
        "labels_url": "https://api.github.com/repos/neovim/neovim/milestones/9/labels",
        "node_id": "MDk6TWlsZXN0b25lODgxOTc4",
        "number": 9,
        "open_issues": 297,
        "state": "open",
        "title": "needs-owner",
        "updated_at": "2025-01-20T17:56:23Z",
        "url": "https://api.github.com/repos/neovim/neovim/milestones/9"
    },
    "node_id": "MDU6SXNzdWU2OTQ1NDQ2Nzk=",
    "number": 12864,
    "performed_via_github_app": null,
    "reactions": {
        "+1": 0,
        "-1": 0,
        "confused": 0,
        "eyes": 0,
        "heart": 0,
        "hooray": 0,
        "laugh": 0,
        "rocket": 0,
        "total_count": 0,
        "url": "https://api.github.com/repos/neovim/neovim/issues/12864/reactions"
    },
    "repository_url": "https://api.github.com/repos/neovim/neovim",
    "state": "open",
    "state_reason": null,
    "sub_issues_summary": {
        "completed": 0,
        "percent_completed": 0,
        "total": 0
    },
    "timeline_url": "https://api.github.com/repos/neovim/neovim/issues/12864/timeline",
    "title": "expression folding (foldexpr) bug",
    "updated_at": "2025-01-19T11:50:07Z",
    "url": "https://api.github.com/repos/neovim/neovim/issues/12864",
    "user": {
        "avatar_url": "https://avatars.githubusercontent.com/u/59321248?v=4",
        "events_url": "https://api.github.com/users/noib3/events{/privacy}",
        "followers_url": "https://api.github.com/users/noib3/followers",
        "following_url": "https://api.github.com/users/noib3/following{/other_user}",
        "gists_url": "https://api.github.com/users/noib3/gists{/gist_id}",
        "gravatar_id": "",
        "html_url": "https://github.com/noib3",
        "id": 59321248,
        "login": "noib3",
        "node_id": "MDQ6VXNlcjU5MzIxMjQ4",
        "organizations_url": "https://api.github.com/users/noib3/orgs",
        "received_events_url": "https://api.github.com/users/noib3/received_events",
        "repos_url": "https://api.github.com/users/noib3/repos",
        "site_admin": false,
        "starred_url": "https://api.github.com/users/noib3/starred{/owner}{/repo}",
        "subscriptions_url": "https://api.github.com/users/noib3/subscriptions",
        "type": "User",
        "url": "https://api.github.com/users/noib3",
        "user_view_type": "public"
    }
}