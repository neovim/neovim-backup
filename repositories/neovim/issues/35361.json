{
    "active_lock_reason": null,
    "assignee": null,
    "assignees": [],
    "author_association": "NONE",
    "body": "### Problem\n\nWhen lsp attached to a large file, I found that the memory went up to 1.3 GB.\n\nTherefore I wanted to disable lsp so that the memory can go down.\n\nI used `:lua vim.lsp.stop_client(1)` or `:lua vim.lsp.buf_detach_client(x, x)` to stop the client or detach from a buffer.\n\nAfter doing the command, I used `:lus print(vim.inspect(vim.lsp.get_clients()))` to ensure that there is no lsp clients.\n\nBut the memory was still 1.3 GB, it did not go down.\n\n### Steps to reproduce using \"nvim -u minimal_init.lua\"\n\nTo reproduce this, you need a large json file (200MB or more).\n\n```lua\n--- CHANGE THESE\nlocal pattern = 'json'\n-- NOTE: update this to the bin path\nlocal cmd ={ 'vscode-json-language-server', '--stdio' }\n-- Add files/folders here that indicate the root of a project\nlocal root_markers = {'.git'}\n-- Change to table with settings if required\nlocal settings = vim.empty_dict()\n\nvim.api.nvim_create_autocmd('FileType', {\n  pattern = pattern,\n  callback = function(args)\n    local match = vim.fs.find(root_markers, { path = args.file, upward = true })[1]\n    local root_dir = match and vim.fn.fnamemodify(match, ':p:h') or nil\n    vim.lsp.start({\n      name = 'jsonls',\n      cmd = cmd,\n      root_dir = root_dir,\n      settings = settings\n    })\n  end\n})\n```\n\nMemory after starting up nvim with `nvim -u repro.lua large_file.json`:\n\n<img width=\"1246\" height=\"67\" alt=\"Image\" src=\"https://github.com/user-attachments/assets/434c7577-5d17-4f28-8369-9996a2384ddf\" />\n\nMemory after stop the client:\n\n<img width=\"1242\" height=\"105\" alt=\"Image\" src=\"https://github.com/user-attachments/assets/f1d52ffa-7aef-40ac-b4c1-43865fa7dd41\" />\n\nMemory without lsp enabled (`nvim -u empty.lua large_file.json`):\n\n<img width=\"1247\" height=\"104\" alt=\"Image\" src=\"https://github.com/user-attachments/assets/743459f8-1ab4-4fd8-a893-54bae5ef6e92\" />\n\n### Expected behavior\n\nThe memory should go down when detached or stopped.\n\n### Nvim version (nvim -v)\n\n0.11.2\n\n### Language server name/version\n\nvscode-json-language-server/4.10.0\n\n### Operating system/version\n\nmacOS 14\n\n### Log file\n\n_No response_",
    "closed_at": "2025-08-17T18:18:47Z",
    "closed_by": {
        "avatar_url": "https://avatars.githubusercontent.com/u/1359421?v=4",
        "events_url": "https://api.github.com/users/justinmk/events{/privacy}",
        "followers_url": "https://api.github.com/users/justinmk/followers",
        "following_url": "https://api.github.com/users/justinmk/following{/other_user}",
        "gists_url": "https://api.github.com/users/justinmk/gists{/gist_id}",
        "gravatar_id": "",
        "html_url": "https://github.com/justinmk",
        "id": 1359421,
        "login": "justinmk",
        "node_id": "MDQ6VXNlcjEzNTk0MjE=",
        "organizations_url": "https://api.github.com/users/justinmk/orgs",
        "received_events_url": "https://api.github.com/users/justinmk/received_events",
        "repos_url": "https://api.github.com/users/justinmk/repos",
        "site_admin": false,
        "starred_url": "https://api.github.com/users/justinmk/starred{/owner}{/repo}",
        "subscriptions_url": "https://api.github.com/users/justinmk/subscriptions",
        "type": "User",
        "url": "https://api.github.com/users/justinmk",
        "user_view_type": "public"
    },
    "comment_data": [
        {
            "author_association": "MEMBER",
            "body": "Stopping a client doesn't necessarily free whatever is actually using that data. Usually, the LS (`vscode-json-language-server`) is what uses memory, not Nvim itself. If Nvim is using memory that implies that a plugin is storing data, or maybe you loaded a quickfix buffer which still exists, or diagnostics, etc.\n\n\nAlso, macos Activity Monitor isn't necessarily an accurate representation since the OS may keep memory reserved for an app even if the app freed the memory. Check the \"Real Memory\" and \"Private Memory\" columns, not just the \"Memory\" column.\n\nAlso see if `collectgarbage('collect')` changes the behavior.\n\nHere's a test script that demonstrates before/after `collectgarbage('collect')` :\n\n```lua\nlocal junk = {}\n\nfor i = 1, 200 do\n  local t = {}\n  for j = 1, 100000 do\n    t[j] = j\n  end\n  junk[i] = t\nend\n\nprint('Allocated ~200 MB of Lua table data. Press ENTER to free...')\nvim.fn.getchar()\njunk = nil\ncollectgarbage('collect')\n```",
            "created_at": "2025-08-17T18:17:49Z",
            "html_url": "https://github.com/neovim/neovim/issues/35361#issuecomment-3194565218",
            "id": 3194565218,
            "issue_url": "https://api.github.com/repos/neovim/neovim/issues/35361",
            "node_id": "IC_kwDOAPphoM6-aTJi",
            "performed_via_github_app": null,
            "reactions": {
                "+1": 0,
                "-1": 0,
                "confused": 0,
                "eyes": 0,
                "heart": 0,
                "hooray": 0,
                "laugh": 0,
                "rocket": 0,
                "total_count": 0,
                "url": "https://api.github.com/repos/neovim/neovim/issues/comments/3194565218/reactions"
            },
            "updated_at": "2025-08-17T18:19:58Z",
            "url": "https://api.github.com/repos/neovim/neovim/issues/comments/3194565218",
            "user": {
                "avatar_url": "https://avatars.githubusercontent.com/u/1359421?v=4",
                "events_url": "https://api.github.com/users/justinmk/events{/privacy}",
                "followers_url": "https://api.github.com/users/justinmk/followers",
                "following_url": "https://api.github.com/users/justinmk/following{/other_user}",
                "gists_url": "https://api.github.com/users/justinmk/gists{/gist_id}",
                "gravatar_id": "",
                "html_url": "https://github.com/justinmk",
                "id": 1359421,
                "login": "justinmk",
                "node_id": "MDQ6VXNlcjEzNTk0MjE=",
                "organizations_url": "https://api.github.com/users/justinmk/orgs",
                "received_events_url": "https://api.github.com/users/justinmk/received_events",
                "repos_url": "https://api.github.com/users/justinmk/repos",
                "site_admin": false,
                "starred_url": "https://api.github.com/users/justinmk/starred{/owner}{/repo}",
                "subscriptions_url": "https://api.github.com/users/justinmk/subscriptions",
                "type": "User",
                "url": "https://api.github.com/users/justinmk",
                "user_view_type": "public"
            }
        },
        {
            "author_association": "MEMBER",
            "body": "Closing this since repro steps starting with `nvim --clean` aren't actually provided, so I assume this is related to a plugin or OS memory behavior as mentioned above.\n\n\nIf there's a memory leak in `vim.diagnostic` or some other builtin Nvim module, we want to fix that, but need exact repro steps.",
            "created_at": "2025-08-17T18:18:46Z",
            "html_url": "https://github.com/neovim/neovim/issues/35361#issuecomment-3194565716",
            "id": 3194565716,
            "issue_url": "https://api.github.com/repos/neovim/neovim/issues/35361",
            "node_id": "IC_kwDOAPphoM6-aTRU",
            "performed_via_github_app": null,
            "reactions": {
                "+1": 0,
                "-1": 0,
                "confused": 0,
                "eyes": 0,
                "heart": 0,
                "hooray": 0,
                "laugh": 0,
                "rocket": 0,
                "total_count": 0,
                "url": "https://api.github.com/repos/neovim/neovim/issues/comments/3194565716/reactions"
            },
            "updated_at": "2025-08-17T18:20:04Z",
            "url": "https://api.github.com/repos/neovim/neovim/issues/comments/3194565716",
            "user": {
                "avatar_url": "https://avatars.githubusercontent.com/u/1359421?v=4",
                "events_url": "https://api.github.com/users/justinmk/events{/privacy}",
                "followers_url": "https://api.github.com/users/justinmk/followers",
                "following_url": "https://api.github.com/users/justinmk/following{/other_user}",
                "gists_url": "https://api.github.com/users/justinmk/gists{/gist_id}",
                "gravatar_id": "",
                "html_url": "https://github.com/justinmk",
                "id": 1359421,
                "login": "justinmk",
                "node_id": "MDQ6VXNlcjEzNTk0MjE=",
                "organizations_url": "https://api.github.com/users/justinmk/orgs",
                "received_events_url": "https://api.github.com/users/justinmk/received_events",
                "repos_url": "https://api.github.com/users/justinmk/repos",
                "site_admin": false,
                "starred_url": "https://api.github.com/users/justinmk/starred{/owner}{/repo}",
                "subscriptions_url": "https://api.github.com/users/justinmk/subscriptions",
                "type": "User",
                "url": "https://api.github.com/users/justinmk",
                "user_view_type": "public"
            }
        },
        {
            "author_association": "NONE",
            "body": "@justinmk \n\nThe memory usage was got by `top` of Arch Linux.\n\n1. Memory usage `nvim --clean large_json_ file` on Arch Linux: 2.3% \n2. Memory usage after using `:source repro.lua`: 2.3%\n3. Memory usage after using `:e large_json_file`: 12.8%\n4. Memory usage after using `:lua vim.lsp.stop_client(1)`: 12.8%\n5. Memory usage after using `:lua collectgarbage('collect')`: 7.0%\n\nAfter stoping the lsp, the memory usage was still higher than before. Any ideas?\n\nI've checked that there is no lsp related process running after step 4.",
            "created_at": "2025-08-18T12:41:26Z",
            "html_url": "https://github.com/neovim/neovim/issues/35361#issuecomment-3196593427",
            "id": 3196593427,
            "issue_url": "https://api.github.com/repos/neovim/neovim/issues/35361",
            "node_id": "IC_kwDOAPphoM6-iCUT",
            "performed_via_github_app": null,
            "reactions": {
                "+1": 0,
                "-1": 0,
                "confused": 0,
                "eyes": 0,
                "heart": 0,
                "hooray": 0,
                "laugh": 0,
                "rocket": 0,
                "total_count": 0,
                "url": "https://api.github.com/repos/neovim/neovim/issues/comments/3196593427/reactions"
            },
            "updated_at": "2025-08-18T12:41:26Z",
            "url": "https://api.github.com/repos/neovim/neovim/issues/comments/3196593427",
            "user": {
                "avatar_url": "https://avatars.githubusercontent.com/u/58209855?v=4",
                "events_url": "https://api.github.com/users/Kaiser-Yang/events{/privacy}",
                "followers_url": "https://api.github.com/users/Kaiser-Yang/followers",
                "following_url": "https://api.github.com/users/Kaiser-Yang/following{/other_user}",
                "gists_url": "https://api.github.com/users/Kaiser-Yang/gists{/gist_id}",
                "gravatar_id": "",
                "html_url": "https://github.com/Kaiser-Yang",
                "id": 58209855,
                "login": "Kaiser-Yang",
                "node_id": "MDQ6VXNlcjU4MjA5ODU1",
                "organizations_url": "https://api.github.com/users/Kaiser-Yang/orgs",
                "received_events_url": "https://api.github.com/users/Kaiser-Yang/received_events",
                "repos_url": "https://api.github.com/users/Kaiser-Yang/repos",
                "site_admin": false,
                "starred_url": "https://api.github.com/users/Kaiser-Yang/starred{/owner}{/repo}",
                "subscriptions_url": "https://api.github.com/users/Kaiser-Yang/subscriptions",
                "type": "User",
                "url": "https://api.github.com/users/Kaiser-Yang",
                "user_view_type": "public"
            }
        },
        {
            "author_association": "MEMBER",
            "body": "again,\n\n> the OS may keep memory reserved for an app even if the app freed the memory\n\n",
            "created_at": "2025-08-18T15:07:52Z",
            "html_url": "https://github.com/neovim/neovim/issues/35361#issuecomment-3197319989",
            "id": 3197319989,
            "issue_url": "https://api.github.com/repos/neovim/neovim/issues/35361",
            "node_id": "IC_kwDOAPphoM6-kzs1",
            "performed_via_github_app": null,
            "reactions": {
                "+1": 0,
                "-1": 0,
                "confused": 0,
                "eyes": 0,
                "heart": 0,
                "hooray": 0,
                "laugh": 0,
                "rocket": 0,
                "total_count": 0,
                "url": "https://api.github.com/repos/neovim/neovim/issues/comments/3197319989/reactions"
            },
            "updated_at": "2025-08-18T15:07:52Z",
            "url": "https://api.github.com/repos/neovim/neovim/issues/comments/3197319989",
            "user": {
                "avatar_url": "https://avatars.githubusercontent.com/u/1359421?v=4",
                "events_url": "https://api.github.com/users/justinmk/events{/privacy}",
                "followers_url": "https://api.github.com/users/justinmk/followers",
                "following_url": "https://api.github.com/users/justinmk/following{/other_user}",
                "gists_url": "https://api.github.com/users/justinmk/gists{/gist_id}",
                "gravatar_id": "",
                "html_url": "https://github.com/justinmk",
                "id": 1359421,
                "login": "justinmk",
                "node_id": "MDQ6VXNlcjEzNTk0MjE=",
                "organizations_url": "https://api.github.com/users/justinmk/orgs",
                "received_events_url": "https://api.github.com/users/justinmk/received_events",
                "repos_url": "https://api.github.com/users/justinmk/repos",
                "site_admin": false,
                "starred_url": "https://api.github.com/users/justinmk/starred{/owner}{/repo}",
                "subscriptions_url": "https://api.github.com/users/justinmk/subscriptions",
                "type": "User",
                "url": "https://api.github.com/users/justinmk",
                "user_view_type": "public"
            }
        },
        {
            "author_association": "NONE",
            "body": " @justinmk \n\nwhy do you confirm it is the os that keeps the memory\n\nif I use some tools to make the memory shortage and nvim still use higher memory than without lsp\n\ncan this make it clear nvim did not release rather than the os kept the memory",
            "created_at": "2025-08-18T16:03:01Z",
            "html_url": "https://github.com/neovim/neovim/issues/35361#issuecomment-3197527290",
            "id": 3197527290,
            "issue_url": "https://api.github.com/repos/neovim/neovim/issues/35361",
            "node_id": "IC_kwDOAPphoM6-lmT6",
            "performed_via_github_app": null,
            "reactions": {
                "+1": 0,
                "-1": 0,
                "confused": 0,
                "eyes": 0,
                "heart": 0,
                "hooray": 0,
                "laugh": 0,
                "rocket": 0,
                "total_count": 0,
                "url": "https://api.github.com/repos/neovim/neovim/issues/comments/3197527290/reactions"
            },
            "updated_at": "2025-08-18T16:03:10Z",
            "url": "https://api.github.com/repos/neovim/neovim/issues/comments/3197527290",
            "user": {
                "avatar_url": "https://avatars.githubusercontent.com/u/58209855?v=4",
                "events_url": "https://api.github.com/users/Kaiser-Yang/events{/privacy}",
                "followers_url": "https://api.github.com/users/Kaiser-Yang/followers",
                "following_url": "https://api.github.com/users/Kaiser-Yang/following{/other_user}",
                "gists_url": "https://api.github.com/users/Kaiser-Yang/gists{/gist_id}",
                "gravatar_id": "",
                "html_url": "https://github.com/Kaiser-Yang",
                "id": 58209855,
                "login": "Kaiser-Yang",
                "node_id": "MDQ6VXNlcjU4MjA5ODU1",
                "organizations_url": "https://api.github.com/users/Kaiser-Yang/orgs",
                "received_events_url": "https://api.github.com/users/Kaiser-Yang/received_events",
                "repos_url": "https://api.github.com/users/Kaiser-Yang/repos",
                "site_admin": false,
                "starred_url": "https://api.github.com/users/Kaiser-Yang/starred{/owner}{/repo}",
                "subscriptions_url": "https://api.github.com/users/Kaiser-Yang/subscriptions",
                "type": "User",
                "url": "https://api.github.com/users/Kaiser-Yang",
                "user_view_type": "public"
            }
        },
        {
            "author_association": "MEMBER",
            "body": "Nothing is clear, but without specific repro steps it is quite valid to assume this is the normal Linux/macos behavior that has confused 1000s of users over the years.",
            "created_at": "2025-08-18T17:33:54Z",
            "html_url": "https://github.com/neovim/neovim/issues/35361#issuecomment-3197828011",
            "id": 3197828011,
            "issue_url": "https://api.github.com/repos/neovim/neovim/issues/35361",
            "node_id": "IC_kwDOAPphoM6-mvur",
            "performed_via_github_app": null,
            "reactions": {
                "+1": 0,
                "-1": 0,
                "confused": 0,
                "eyes": 0,
                "heart": 0,
                "hooray": 0,
                "laugh": 0,
                "rocket": 0,
                "total_count": 0,
                "url": "https://api.github.com/repos/neovim/neovim/issues/comments/3197828011/reactions"
            },
            "updated_at": "2025-08-18T17:33:54Z",
            "url": "https://api.github.com/repos/neovim/neovim/issues/comments/3197828011",
            "user": {
                "avatar_url": "https://avatars.githubusercontent.com/u/1359421?v=4",
                "events_url": "https://api.github.com/users/justinmk/events{/privacy}",
                "followers_url": "https://api.github.com/users/justinmk/followers",
                "following_url": "https://api.github.com/users/justinmk/following{/other_user}",
                "gists_url": "https://api.github.com/users/justinmk/gists{/gist_id}",
                "gravatar_id": "",
                "html_url": "https://github.com/justinmk",
                "id": 1359421,
                "login": "justinmk",
                "node_id": "MDQ6VXNlcjEzNTk0MjE=",
                "organizations_url": "https://api.github.com/users/justinmk/orgs",
                "received_events_url": "https://api.github.com/users/justinmk/received_events",
                "repos_url": "https://api.github.com/users/justinmk/repos",
                "site_admin": false,
                "starred_url": "https://api.github.com/users/justinmk/starred{/owner}{/repo}",
                "subscriptions_url": "https://api.github.com/users/justinmk/subscriptions",
                "type": "User",
                "url": "https://api.github.com/users/justinmk",
                "user_view_type": "public"
            }
        }
    ],
    "comments": 6,
    "comments_url": "https://api.github.com/repos/neovim/neovim/issues/35361/comments",
    "created_at": "2025-08-17T05:47:51Z",
    "events_url": "https://api.github.com/repos/neovim/neovim/issues/35361/events",
    "html_url": "https://github.com/neovim/neovim/issues/35361",
    "id": 3327989823,
    "labels": [
        {
            "color": "FEF2C0",
            "default": false,
            "description": "performance, latency, cpu/memory usage",
            "id": 101930601,
            "name": "performance",
            "node_id": "MDU6TGFiZWwxMDE5MzA2MDE=",
            "url": "https://api.github.com/repos/neovim/neovim/labels/performance"
        },
        {
            "color": "c5def5",
            "default": false,
            "description": null,
            "id": 662566370,
            "name": "lsp",
            "node_id": "MDU6TGFiZWw2NjI1NjYzNzA=",
            "url": "https://api.github.com/repos/neovim/neovim/labels/lsp"
        }
    ],
    "labels_url": "https://api.github.com/repos/neovim/neovim/issues/35361/labels{/name}",
    "locked": false,
    "milestone": null,
    "node_id": "I_kwDOAPphoM7GXRg_",
    "number": 35361,
    "performed_via_github_app": null,
    "reactions": {
        "+1": 0,
        "-1": 0,
        "confused": 0,
        "eyes": 0,
        "heart": 0,
        "hooray": 0,
        "laugh": 0,
        "rocket": 0,
        "total_count": 0,
        "url": "https://api.github.com/repos/neovim/neovim/issues/35361/reactions"
    },
    "repository_url": "https://api.github.com/repos/neovim/neovim",
    "state": "closed",
    "state_reason": "not_planned",
    "sub_issues_summary": {
        "completed": 0,
        "percent_completed": 0,
        "total": 0
    },
    "timeline_url": "https://api.github.com/repos/neovim/neovim/issues/35361/timeline",
    "title": "LSP: memory has not been released after detaching or stopping a lsp client",
    "type": {
        "color": "red",
        "created_at": "2024-01-25T10:10:19Z",
        "description": "An unexpected problem or behavior",
        "id": 597163,
        "is_enabled": true,
        "name": "Bug",
        "node_id": "IT_kwDOAGK_Pc4ACRyr",
        "updated_at": "2024-07-26T10:12:30Z"
    },
    "updated_at": "2025-08-18T17:33:54Z",
    "url": "https://api.github.com/repos/neovim/neovim/issues/35361",
    "user": {
        "avatar_url": "https://avatars.githubusercontent.com/u/58209855?v=4",
        "events_url": "https://api.github.com/users/Kaiser-Yang/events{/privacy}",
        "followers_url": "https://api.github.com/users/Kaiser-Yang/followers",
        "following_url": "https://api.github.com/users/Kaiser-Yang/following{/other_user}",
        "gists_url": "https://api.github.com/users/Kaiser-Yang/gists{/gist_id}",
        "gravatar_id": "",
        "html_url": "https://github.com/Kaiser-Yang",
        "id": 58209855,
        "login": "Kaiser-Yang",
        "node_id": "MDQ6VXNlcjU4MjA5ODU1",
        "organizations_url": "https://api.github.com/users/Kaiser-Yang/orgs",
        "received_events_url": "https://api.github.com/users/Kaiser-Yang/received_events",
        "repos_url": "https://api.github.com/users/Kaiser-Yang/repos",
        "site_admin": false,
        "starred_url": "https://api.github.com/users/Kaiser-Yang/starred{/owner}{/repo}",
        "subscriptions_url": "https://api.github.com/users/Kaiser-Yang/subscriptions",
        "type": "User",
        "url": "https://api.github.com/users/Kaiser-Yang",
        "user_view_type": "public"
    }
}