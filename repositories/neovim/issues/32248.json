{
    "active_lock_reason": null,
    "assignee": null,
    "assignees": [],
    "author_association": "CONTRIBUTOR",
    "body": "### Problem\n\nWhen a server responds to the `textDocument/inlay_hint` response with inlay hints they aren't correctly being updated in the current buffer when recieved.\n\n### Steps to reproduce using \"nvim -u minimal_init.lua\"\n\nYou can reproduce this, but you'd need a few things installed\n\n- The Scala language server [Metals](https://scalameta.org/metals/) (most easily done with [cs install metals](https://get-coursier.io/))\n- create a `inlay.worksheet.sc` file (the name is important so it matches the minimal conf)\n\nInside of these file you can have the following:\n\n`inlay.worksheet.sc`\n\n```scala\nval x = 3\n```\n\nThe minimal init file looks like this:\n\n```lua\nlocal pattern = 'scala'\nlocal cmd = { 'metals' }\n-- Add files/folders here that indicate the root of a project\nlocal root_markers = { 'inlay.worksheet.sc' }\n\nlocal settings = {\n  metals = {\n    enableSemanticHighlighting = false,\n  }\n}\n\nvim.api.nvim_create_autocmd('FileType', {\n  pattern = pattern,\n  callback = function(args)\n    local match = vim.fs.find(root_markers, { path = args.file, upward = true })[1]\n    local root_dir = match and vim.fn.fnamemodify(match, ':p:h') or nil\n    vim.lsp.start({\n      name = 'metals',\n      cmd = cmd,\n      root_dir = root_dir,\n      settings = settings\n    })\n  end\n})\n```\n\nNow open the file and let Metals fully load everything. Once completed you can do `:lua vim.lsp.inlay_hint.enable(true)` which will show you the evaluation and the inlay hint of `// : Int = 3`. It should look like this:\n\n<img width=\"175\" alt=\"Image\" src=\"https://github.com/user-attachments/assets/b524aac2-6403-49bc-9213-a307c3a0a3ae\" />\n\nNow, if you change the `3` in the file to a `4` and hit save, there will be a couple things that happen. Firstly a request for inlay hints is sent and a new set of inlay hints are received with the new evaluation being `//: Int = 4` however, the buffer won't be updated here. The logs for this are down below.\n\n\n```\n[Trace - 04:04:03 PM] Sending request 'workspace/inlayHint/refresh - (22)'\nParams: null\n\n[Trace - 04:04:03 PM] Received request 'textDocument/inlayHint - (13)'\nParams: {\n  \"textDocument\": {\n    \"uri\": \"file:///Users/ckipp/Documents/scratch/inlay/inlay.worksheet.sc\"\n  },\n  \"range\": {\n    \"start\": {\n      \"line\": 0,\n      \"character\": 0\n    },\n    \"end\": {\n      \"line\": 1,\n      \"character\": 0\n    }\n  }\n}\n\n\n[Trace - 04:04:03 PM] Received response 'workspace/inlayHint/refresh - (22)' in 1ms\nResult: null\nError: null\n\n[Trace - 04:04:03 PM] Sending response 'textDocument/inlayHint - (13)'. Processing request took 0ms\nResult: [\n  {\n    \"position\": {\n      \"line\": 0,\n      \"character\": 9\n    },\n    \"label\": \" // : Int \\u003d 4\",\n    \"tooltip\": \"x: Int \\u003d 4\"\n  }\n]\n```\n\n\n### Expected behavior\n\nWhen the client receives new inlay hints I expect it to update the current buffer when inlay hints are enabled. As you can see in the logs the `textDocument/inlayHint` is received with new hints, but it's not displayed.\n\nSort of an aside, but I'm confused why a `workspace/inlayHint/refresh` is always sent as well. Nothing changed in the workspace configuration to trigger this and [according to the spec](https://microsoft.github.io/language-server-protocol/specifications/lsp/3.17/specification/#workspace_inlayHint_refresh)\n\n> This is useful if a server detects a configuration change which requires a re-calculation of all inlay hints.\n\nIn this situation, it was just a file change, so all workspace hints should really be refreshed should they?\n\n### Nvim version (nvim -v)\n\nNVIM v0.10.4\n\n### Language server name/version\n\nmetals 1.5.1\n\n### Operating system/version\n\nMac OS but any has the same\n\n### Log file\n\n_No response_\n\nEDIT:\n\nIf you are actually using metals to try and debug this, we have a mechanism to see nicely formatting logs. You should see a `.metals/` created in the current dir and if you create a `lsp.trace.json` file in that directory and then start the server again you'll see it populated with all the LSP logs.",
    "closed_at": null,
    "closed_by": null,
    "comment_data": [
        {
            "author_association": "MEMBER",
            "body": "Always test latest HEAD.",
            "created_at": "2025-01-29T16:09:04Z",
            "html_url": "https://github.com/neovim/neovim/issues/32248#issuecomment-2622073619",
            "id": 2622073619,
            "issue_url": "https://api.github.com/repos/neovim/neovim/issues/32248",
            "node_id": "IC_kwDOAPphoM6cSasT",
            "performed_via_github_app": null,
            "reactions": {
                "+1": 0,
                "-1": 0,
                "confused": 0,
                "eyes": 0,
                "heart": 0,
                "hooray": 0,
                "laugh": 0,
                "rocket": 0,
                "total_count": 0,
                "url": "https://api.github.com/repos/neovim/neovim/issues/comments/2622073619/reactions"
            },
            "updated_at": "2025-01-29T16:09:04Z",
            "url": "https://api.github.com/repos/neovim/neovim/issues/comments/2622073619",
            "user": {
                "avatar_url": "https://avatars.githubusercontent.com/u/1359421?v=4",
                "events_url": "https://api.github.com/users/justinmk/events{/privacy}",
                "followers_url": "https://api.github.com/users/justinmk/followers",
                "following_url": "https://api.github.com/users/justinmk/following{/other_user}",
                "gists_url": "https://api.github.com/users/justinmk/gists{/gist_id}",
                "gravatar_id": "",
                "html_url": "https://github.com/justinmk",
                "id": 1359421,
                "login": "justinmk",
                "node_id": "MDQ6VXNlcjEzNTk0MjE=",
                "organizations_url": "https://api.github.com/users/justinmk/orgs",
                "received_events_url": "https://api.github.com/users/justinmk/received_events",
                "repos_url": "https://api.github.com/users/justinmk/repos",
                "site_admin": false,
                "starred_url": "https://api.github.com/users/justinmk/starred{/owner}{/repo}",
                "subscriptions_url": "https://api.github.com/users/justinmk/subscriptions",
                "type": "User",
                "url": "https://api.github.com/users/justinmk",
                "user_view_type": "public"
            }
        },
        {
            "author_association": "CONTRIBUTOR",
            "body": "> Always test latest HEAD.\n\nJust confirming with `NVIM v0.11.0-dev-1658+g216ec73972` that I have the same exact behavior.",
            "created_at": "2025-01-29T19:20:46Z",
            "html_url": "https://github.com/neovim/neovim/issues/32248#issuecomment-2622629478",
            "id": 2622629478,
            "issue_url": "https://api.github.com/repos/neovim/neovim/issues/32248",
            "node_id": "IC_kwDOAPphoM6cUiZm",
            "performed_via_github_app": null,
            "reactions": {
                "+1": 1,
                "-1": 0,
                "confused": 0,
                "eyes": 0,
                "heart": 0,
                "hooray": 0,
                "laugh": 0,
                "rocket": 0,
                "total_count": 1,
                "url": "https://api.github.com/repos/neovim/neovim/issues/comments/2622629478/reactions"
            },
            "updated_at": "2025-01-29T19:20:46Z",
            "url": "https://api.github.com/repos/neovim/neovim/issues/comments/2622629478",
            "user": {
                "avatar_url": "https://avatars.githubusercontent.com/u/13974112?v=4",
                "events_url": "https://api.github.com/users/ckipp01/events{/privacy}",
                "followers_url": "https://api.github.com/users/ckipp01/followers",
                "following_url": "https://api.github.com/users/ckipp01/following{/other_user}",
                "gists_url": "https://api.github.com/users/ckipp01/gists{/gist_id}",
                "gravatar_id": "",
                "html_url": "https://github.com/ckipp01",
                "id": 13974112,
                "login": "ckipp01",
                "node_id": "MDQ6VXNlcjEzOTc0MTEy",
                "organizations_url": "https://api.github.com/users/ckipp01/orgs",
                "received_events_url": "https://api.github.com/users/ckipp01/received_events",
                "repos_url": "https://api.github.com/users/ckipp01/repos",
                "site_admin": false,
                "starred_url": "https://api.github.com/users/ckipp01/starred{/owner}{/repo}",
                "subscriptions_url": "https://api.github.com/users/ckipp01/subscriptions",
                "type": "User",
                "url": "https://api.github.com/users/ckipp01",
                "user_view_type": "public"
            }
        },
        {
            "author_association": "MEMBER",
            "body": "@p00f @catlee ",
            "created_at": "2025-01-30T10:27:10Z",
            "html_url": "https://github.com/neovim/neovim/issues/32248#issuecomment-2624093761",
            "id": 2624093761,
            "issue_url": "https://api.github.com/repos/neovim/neovim/issues/32248",
            "node_id": "IC_kwDOAPphoM6caH5B",
            "performed_via_github_app": null,
            "reactions": {
                "+1": 0,
                "-1": 0,
                "confused": 0,
                "eyes": 0,
                "heart": 0,
                "hooray": 0,
                "laugh": 0,
                "rocket": 0,
                "total_count": 0,
                "url": "https://api.github.com/repos/neovim/neovim/issues/comments/2624093761/reactions"
            },
            "updated_at": "2025-01-30T10:27:10Z",
            "url": "https://api.github.com/repos/neovim/neovim/issues/comments/2624093761",
            "user": {
                "avatar_url": "https://avatars.githubusercontent.com/u/1359421?v=4",
                "events_url": "https://api.github.com/users/justinmk/events{/privacy}",
                "followers_url": "https://api.github.com/users/justinmk/followers",
                "following_url": "https://api.github.com/users/justinmk/following{/other_user}",
                "gists_url": "https://api.github.com/users/justinmk/gists{/gist_id}",
                "gravatar_id": "",
                "html_url": "https://github.com/justinmk",
                "id": 1359421,
                "login": "justinmk",
                "node_id": "MDQ6VXNlcjEzNTk0MjE=",
                "organizations_url": "https://api.github.com/users/justinmk/orgs",
                "received_events_url": "https://api.github.com/users/justinmk/received_events",
                "repos_url": "https://api.github.com/users/justinmk/repos",
                "site_admin": false,
                "starred_url": "https://api.github.com/users/justinmk/starred{/owner}{/repo}",
                "subscriptions_url": "https://api.github.com/users/justinmk/subscriptions",
                "type": "User",
                "url": "https://api.github.com/users/justinmk",
                "user_view_type": "public"
            }
        }
    ],
    "comments": 3,
    "comments_url": "https://api.github.com/repos/neovim/neovim/issues/32248/comments",
    "created_at": "2025-01-29T15:08:11Z",
    "events_url": "https://api.github.com/repos/neovim/neovim/issues/32248/events",
    "html_url": "https://github.com/neovim/neovim/issues/32248",
    "id": 2818490657,
    "labels": [
        {
            "color": "c5def5",
            "default": false,
            "description": null,
            "id": 662566370,
            "name": "lsp",
            "node_id": "MDU6TGFiZWw2NjI1NjYzNzA=",
            "url": "https://api.github.com/repos/neovim/neovim/labels/lsp"
        }
    ],
    "labels_url": "https://api.github.com/repos/neovim/neovim/issues/32248/labels{/name}",
    "locked": false,
    "milestone": {
        "closed_at": null,
        "closed_issues": 691,
        "created_at": "2014-05-10T20:43:04Z",
        "creator": {
            "avatar_url": "https://avatars.githubusercontent.com/u/1359421?v=4",
            "events_url": "https://api.github.com/users/justinmk/events{/privacy}",
            "followers_url": "https://api.github.com/users/justinmk/followers",
            "following_url": "https://api.github.com/users/justinmk/following{/other_user}",
            "gists_url": "https://api.github.com/users/justinmk/gists{/gist_id}",
            "gravatar_id": "",
            "html_url": "https://github.com/justinmk",
            "id": 1359421,
            "login": "justinmk",
            "node_id": "MDQ6VXNlcjEzNTk0MjE=",
            "organizations_url": "https://api.github.com/users/justinmk/orgs",
            "received_events_url": "https://api.github.com/users/justinmk/received_events",
            "repos_url": "https://api.github.com/users/justinmk/repos",
            "site_admin": false,
            "starred_url": "https://api.github.com/users/justinmk/starred{/owner}{/repo}",
            "subscriptions_url": "https://api.github.com/users/justinmk/subscriptions",
            "type": "User",
            "url": "https://api.github.com/users/justinmk",
            "user_view_type": "public"
        },
        "description": "Low priority items. We plan to work on this but don't have a target date.",
        "due_on": null,
        "html_url": "https://github.com/neovim/neovim/milestone/6",
        "id": 655037,
        "labels_url": "https://api.github.com/repos/neovim/neovim/milestones/6/labels",
        "node_id": "MDk6TWlsZXN0b25lNjU1MDM3",
        "number": 6,
        "open_issues": 634,
        "state": "open",
        "title": "backlog",
        "updated_at": "2025-02-03T17:13:43Z",
        "url": "https://api.github.com/repos/neovim/neovim/milestones/6"
    },
    "node_id": "I_kwDOAPphoM6n_sEh",
    "number": 32248,
    "performed_via_github_app": null,
    "reactions": {
        "+1": 0,
        "-1": 0,
        "confused": 0,
        "eyes": 0,
        "heart": 0,
        "hooray": 0,
        "laugh": 0,
        "rocket": 0,
        "total_count": 0,
        "url": "https://api.github.com/repos/neovim/neovim/issues/32248/reactions"
    },
    "repository_url": "https://api.github.com/repos/neovim/neovim",
    "state": "open",
    "state_reason": null,
    "sub_issues_summary": {
        "completed": 0,
        "percent_completed": 0,
        "total": 0
    },
    "timeline_url": "https://api.github.com/repos/neovim/neovim/issues/32248/timeline",
    "title": "LSP: `textDocument/inlay_hint` not being correctly published when recieved",
    "updated_at": "2025-01-30T10:38:03Z",
    "url": "https://api.github.com/repos/neovim/neovim/issues/32248",
    "user": {
        "avatar_url": "https://avatars.githubusercontent.com/u/13974112?v=4",
        "events_url": "https://api.github.com/users/ckipp01/events{/privacy}",
        "followers_url": "https://api.github.com/users/ckipp01/followers",
        "following_url": "https://api.github.com/users/ckipp01/following{/other_user}",
        "gists_url": "https://api.github.com/users/ckipp01/gists{/gist_id}",
        "gravatar_id": "",
        "html_url": "https://github.com/ckipp01",
        "id": 13974112,
        "login": "ckipp01",
        "node_id": "MDQ6VXNlcjEzOTc0MTEy",
        "organizations_url": "https://api.github.com/users/ckipp01/orgs",
        "received_events_url": "https://api.github.com/users/ckipp01/received_events",
        "repos_url": "https://api.github.com/users/ckipp01/repos",
        "site_admin": false,
        "starred_url": "https://api.github.com/users/ckipp01/starred{/owner}{/repo}",
        "subscriptions_url": "https://api.github.com/users/ckipp01/subscriptions",
        "type": "User",
        "url": "https://api.github.com/users/ckipp01",
        "user_view_type": "public"
    }
}