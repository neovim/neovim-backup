{
    "active_lock_reason": null,
    "assignee": null,
    "assignees": [],
    "author_association": "NONE",
    "body": "### Describe the bug\r\n\r\nI noticed that with some language servers (e.g. sumneko_lua) after calling `vim.lsp.buf.format()` entries in `:changes` are marked as invalid (`-invalid-`). This only seems to happen for lsp's sending the whole formatted document as response instead of actual text edits.\r\n\r\n### Steps to reproduce\r\n\r\n1. open new lua file with attached lsp \"sumneko_lua\"\r\n2.  insert two lines: \r\n<pre>print(\"1\")\r\nprint(\"2\")\r\n</pre>\r\n3. `:lua vim.lsp.buf.format()`\r\n4. open changes list with `:changes`\r\n\r\n### Expected behavior\r\n\r\ncalling `:changes` should result in \r\n\r\n<pre>\r\nchange line  col text\r\n    2     1    9 print(\"1\")\r\n    1     2    7 print(\"2\")\r\n>\r\n</pre>\r\n\r\nbut instead shows\r\n\r\n<pre>\r\nchange line  col text\r\n    3     1    9 print(\"1\")\r\n    2     1    0 print(\"1\")\r\n    1     3    0 -invalid-\r\n>\r\n</pre>\r\n\r\n### Neovim version (nvim -v)\r\n\r\nv0.9.0-dev-581+gcb9d68fe6\r\n\r\n### Vim (not Nvim) behaves the same?\r\n\r\nna\r\n\r\n### Operating system/version\r\n\r\n5.15.0-10056-tuxedo\r\n\r\n### Terminal name/version\r\n\r\nkonsole 21.12.3\r\n\r\n### $TERM environment variable\r\n\r\nxterm-256color\r\n\r\n### Installation\r\n\r\nbuild from repo",
    "closed_at": null,
    "closed_by": null,
    "comment_data": [
        {
            "author_association": "NONE",
            "body": "other vim features are affected too:\r\n- jumplist: all entries are collapsed to the first line in buffer\r\n- marks: all lowercase entries are removed\r\n- extmarks: all entries are collapsed to last line",
            "created_at": "2023-01-14T13:16:30Z",
            "html_url": "https://github.com/neovim/neovim/issues/21783#issuecomment-1382735867",
            "id": 1382735867,
            "issue_url": "https://api.github.com/repos/neovim/neovim/issues/21783",
            "node_id": "IC_kwDOAPphoM5Sat_7",
            "performed_via_github_app": null,
            "reactions": {
                "+1": 0,
                "-1": 0,
                "confused": 0,
                "eyes": 0,
                "heart": 0,
                "hooray": 0,
                "laugh": 0,
                "rocket": 0,
                "total_count": 0,
                "url": "https://api.github.com/repos/neovim/neovim/issues/comments/1382735867/reactions"
            },
            "updated_at": "2023-01-14T13:47:07Z",
            "url": "https://api.github.com/repos/neovim/neovim/issues/comments/1382735867",
            "user": {
                "avatar_url": "https://avatars.githubusercontent.com/u/80337370?v=4",
                "events_url": "https://api.github.com/users/Baehn/events{/privacy}",
                "followers_url": "https://api.github.com/users/Baehn/followers",
                "following_url": "https://api.github.com/users/Baehn/following{/other_user}",
                "gists_url": "https://api.github.com/users/Baehn/gists{/gist_id}",
                "gravatar_id": "",
                "html_url": "https://github.com/Baehn",
                "id": 80337370,
                "login": "Baehn",
                "node_id": "MDQ6VXNlcjgwMzM3Mzcw",
                "organizations_url": "https://api.github.com/users/Baehn/orgs",
                "received_events_url": "https://api.github.com/users/Baehn/received_events",
                "repos_url": "https://api.github.com/users/Baehn/repos",
                "site_admin": false,
                "starred_url": "https://api.github.com/users/Baehn/starred{/owner}{/repo}",
                "subscriptions_url": "https://api.github.com/users/Baehn/subscriptions",
                "type": "User",
                "url": "https://api.github.com/users/Baehn",
                "user_view_type": "public"
            }
        },
        {
            "author_association": "MEMBER",
            "body": "> only seems to happen for lsp's sending the whole formatted document as response instead of actual text edits.\r\n\r\nwhat can we do about that?",
            "created_at": "2023-01-16T11:40:18Z",
            "html_url": "https://github.com/neovim/neovim/issues/21783#issuecomment-1383921517",
            "id": 1383921517,
            "issue_url": "https://api.github.com/repos/neovim/neovim/issues/21783",
            "node_id": "IC_kwDOAPphoM5SfPdt",
            "performed_via_github_app": null,
            "reactions": {
                "+1": 0,
                "-1": 0,
                "confused": 0,
                "eyes": 0,
                "heart": 0,
                "hooray": 0,
                "laugh": 0,
                "rocket": 0,
                "total_count": 0,
                "url": "https://api.github.com/repos/neovim/neovim/issues/comments/1383921517/reactions"
            },
            "updated_at": "2023-01-16T11:40:18Z",
            "url": "https://api.github.com/repos/neovim/neovim/issues/comments/1383921517",
            "user": {
                "avatar_url": "https://avatars.githubusercontent.com/u/1359421?v=4",
                "events_url": "https://api.github.com/users/justinmk/events{/privacy}",
                "followers_url": "https://api.github.com/users/justinmk/followers",
                "following_url": "https://api.github.com/users/justinmk/following{/other_user}",
                "gists_url": "https://api.github.com/users/justinmk/gists{/gist_id}",
                "gravatar_id": "",
                "html_url": "https://github.com/justinmk",
                "id": 1359421,
                "login": "justinmk",
                "node_id": "MDQ6VXNlcjEzNTk0MjE=",
                "organizations_url": "https://api.github.com/users/justinmk/orgs",
                "received_events_url": "https://api.github.com/users/justinmk/received_events",
                "repos_url": "https://api.github.com/users/justinmk/repos",
                "site_admin": false,
                "starred_url": "https://api.github.com/users/justinmk/starred{/owner}{/repo}",
                "subscriptions_url": "https://api.github.com/users/justinmk/subscriptions",
                "type": "User",
                "url": "https://api.github.com/users/justinmk",
                "user_view_type": "public"
            }
        },
        {
            "author_association": "NONE",
            "body": "> what can we do about that?\r\n\r\nyou don't think that this is something neovim should handle? Looking at the lsp specification I'm not sure if this is actually prohibited.  For example, one could compute the actual diff to the current buffer and then apply this as text edits.",
            "created_at": "2023-01-16T18:31:27Z",
            "html_url": "https://github.com/neovim/neovim/issues/21783#issuecomment-1384425227",
            "id": 1384425227,
            "issue_url": "https://api.github.com/repos/neovim/neovim/issues/21783",
            "node_id": "IC_kwDOAPphoM5ShKcL",
            "performed_via_github_app": null,
            "reactions": {
                "+1": 0,
                "-1": 0,
                "confused": 0,
                "eyes": 0,
                "heart": 0,
                "hooray": 0,
                "laugh": 0,
                "rocket": 0,
                "total_count": 0,
                "url": "https://api.github.com/repos/neovim/neovim/issues/comments/1384425227/reactions"
            },
            "updated_at": "2023-01-16T18:31:27Z",
            "url": "https://api.github.com/repos/neovim/neovim/issues/comments/1384425227",
            "user": {
                "avatar_url": "https://avatars.githubusercontent.com/u/80337370?v=4",
                "events_url": "https://api.github.com/users/Baehn/events{/privacy}",
                "followers_url": "https://api.github.com/users/Baehn/followers",
                "following_url": "https://api.github.com/users/Baehn/following{/other_user}",
                "gists_url": "https://api.github.com/users/Baehn/gists{/gist_id}",
                "gravatar_id": "",
                "html_url": "https://github.com/Baehn",
                "id": 80337370,
                "login": "Baehn",
                "node_id": "MDQ6VXNlcjgwMzM3Mzcw",
                "organizations_url": "https://api.github.com/users/Baehn/orgs",
                "received_events_url": "https://api.github.com/users/Baehn/received_events",
                "repos_url": "https://api.github.com/users/Baehn/repos",
                "site_admin": false,
                "starred_url": "https://api.github.com/users/Baehn/starred{/owner}{/repo}",
                "subscriptions_url": "https://api.github.com/users/Baehn/subscriptions",
                "type": "User",
                "url": "https://api.github.com/users/Baehn",
                "user_view_type": "public"
            }
        },
        {
            "author_association": "MEMBER",
            "body": "> For example, one could compute the actual diff to the current buffer and then apply this as text edits.\r\n\r\ni mean yeah we could do that, or ... the language server could do that, since that is its job üòè ",
            "created_at": "2023-01-16T20:15:19Z",
            "html_url": "https://github.com/neovim/neovim/issues/21783#issuecomment-1384512487",
            "id": 1384512487,
            "issue_url": "https://api.github.com/repos/neovim/neovim/issues/21783",
            "node_id": "IC_kwDOAPphoM5Shfvn",
            "performed_via_github_app": null,
            "reactions": {
                "+1": 0,
                "-1": 0,
                "confused": 0,
                "eyes": 0,
                "heart": 0,
                "hooray": 0,
                "laugh": 0,
                "rocket": 0,
                "total_count": 0,
                "url": "https://api.github.com/repos/neovim/neovim/issues/comments/1384512487/reactions"
            },
            "updated_at": "2023-01-16T20:15:19Z",
            "url": "https://api.github.com/repos/neovim/neovim/issues/comments/1384512487",
            "user": {
                "avatar_url": "https://avatars.githubusercontent.com/u/1359421?v=4",
                "events_url": "https://api.github.com/users/justinmk/events{/privacy}",
                "followers_url": "https://api.github.com/users/justinmk/followers",
                "following_url": "https://api.github.com/users/justinmk/following{/other_user}",
                "gists_url": "https://api.github.com/users/justinmk/gists{/gist_id}",
                "gravatar_id": "",
                "html_url": "https://github.com/justinmk",
                "id": 1359421,
                "login": "justinmk",
                "node_id": "MDQ6VXNlcjEzNTk0MjE=",
                "organizations_url": "https://api.github.com/users/justinmk/orgs",
                "received_events_url": "https://api.github.com/users/justinmk/received_events",
                "repos_url": "https://api.github.com/users/justinmk/repos",
                "site_admin": false,
                "starred_url": "https://api.github.com/users/justinmk/starred{/owner}{/repo}",
                "subscriptions_url": "https://api.github.com/users/justinmk/subscriptions",
                "type": "User",
                "url": "https://api.github.com/users/justinmk",
                "user_view_type": "public"
            }
        },
        {
            "author_association": "NONE",
            "body": "I noticed that if I use vim.lsp.buf.format in a lua file, the marks disappear. I found this issue and if I understood correctly there is a limitation in the lua language server---which indeed I don't have issues with python and other language servers.\r\n\r\nI'm wondering if there is any suggestion of a temporary workaround to avoid having the marks disappear for lua files when running the autoformating? \r\n \r\n EDIT:\r\n I found this plugin which seems to solve the issue:\r\n https://github.com/stevearc/conform.nvim\r\n \"Diffs the format results and applies the changes using the same utilities as LSP formatting. This preserves extmarks, folds, and cursor/window position.\"",
            "created_at": "2023-10-30T23:08:48Z",
            "html_url": "https://github.com/neovim/neovim/issues/21783#issuecomment-1786184936",
            "id": 1786184936,
            "issue_url": "https://api.github.com/repos/neovim/neovim/issues/21783",
            "node_id": "IC_kwDOAPphoM5qdwTo",
            "performed_via_github_app": null,
            "reactions": {
                "+1": 0,
                "-1": 0,
                "confused": 0,
                "eyes": 1,
                "heart": 0,
                "hooray": 0,
                "laugh": 0,
                "rocket": 0,
                "total_count": 1,
                "url": "https://api.github.com/repos/neovim/neovim/issues/comments/1786184936/reactions"
            },
            "updated_at": "2023-11-02T06:26:32Z",
            "url": "https://api.github.com/repos/neovim/neovim/issues/comments/1786184936",
            "user": {
                "avatar_url": "https://avatars.githubusercontent.com/u/7735345?v=4",
                "events_url": "https://api.github.com/users/marconetto/events{/privacy}",
                "followers_url": "https://api.github.com/users/marconetto/followers",
                "following_url": "https://api.github.com/users/marconetto/following{/other_user}",
                "gists_url": "https://api.github.com/users/marconetto/gists{/gist_id}",
                "gravatar_id": "",
                "html_url": "https://github.com/marconetto",
                "id": 7735345,
                "login": "marconetto",
                "node_id": "MDQ6VXNlcjc3MzUzNDU=",
                "organizations_url": "https://api.github.com/users/marconetto/orgs",
                "received_events_url": "https://api.github.com/users/marconetto/received_events",
                "repos_url": "https://api.github.com/users/marconetto/repos",
                "site_admin": false,
                "starred_url": "https://api.github.com/users/marconetto/starred{/owner}{/repo}",
                "subscriptions_url": "https://api.github.com/users/marconetto/subscriptions",
                "type": "User",
                "url": "https://api.github.com/users/marconetto",
                "user_view_type": "public"
            }
        },
        {
            "author_association": "NONE",
            "body": "bug still exists in version 0.12. Maybe should add some option such as nochangelist to function nvim_buf_set_lines, or add global option vim.o.nochangelist supress change list modified.\nIt look like happen with emmylua_ls, but clangd lsp is OK.",
            "created_at": "2026-01-04T07:56:55Z",
            "html_url": "https://github.com/neovim/neovim/issues/21783#issuecomment-3707840804",
            "id": 3707840804,
            "issue_url": "https://api.github.com/repos/neovim/neovim/issues/21783",
            "node_id": "IC_kwDOAPphoM7dASkk",
            "performed_via_github_app": null,
            "reactions": {
                "+1": 0,
                "-1": 0,
                "confused": 0,
                "eyes": 0,
                "heart": 0,
                "hooray": 0,
                "laugh": 0,
                "rocket": 0,
                "total_count": 0,
                "url": "https://api.github.com/repos/neovim/neovim/issues/comments/3707840804/reactions"
            },
            "updated_at": "2026-01-04T08:19:34Z",
            "url": "https://api.github.com/repos/neovim/neovim/issues/comments/3707840804",
            "user": {
                "avatar_url": "https://avatars.githubusercontent.com/u/14259857?v=4",
                "events_url": "https://api.github.com/users/wunoman/events{/privacy}",
                "followers_url": "https://api.github.com/users/wunoman/followers",
                "following_url": "https://api.github.com/users/wunoman/following{/other_user}",
                "gists_url": "https://api.github.com/users/wunoman/gists{/gist_id}",
                "gravatar_id": "",
                "html_url": "https://github.com/wunoman",
                "id": 14259857,
                "login": "wunoman",
                "node_id": "MDQ6VXNlcjE0MjU5ODU3",
                "organizations_url": "https://api.github.com/users/wunoman/orgs",
                "received_events_url": "https://api.github.com/users/wunoman/received_events",
                "repos_url": "https://api.github.com/users/wunoman/repos",
                "site_admin": false,
                "starred_url": "https://api.github.com/users/wunoman/starred{/owner}{/repo}",
                "subscriptions_url": "https://api.github.com/users/wunoman/subscriptions",
                "type": "User",
                "url": "https://api.github.com/users/wunoman",
                "user_view_type": "public"
            }
        }
    ],
    "comments": 6,
    "comments_url": "https://api.github.com/repos/neovim/neovim/issues/21783/comments",
    "created_at": "2023-01-13T12:18:12Z",
    "events_url": "https://api.github.com/repos/neovim/neovim/issues/21783/events",
    "html_url": "https://github.com/neovim/neovim/issues/21783",
    "id": 1532219525,
    "issue_dependencies_summary": {
        "blocked_by": 0,
        "blocking": 0,
        "total_blocked_by": 0,
        "total_blocking": 0
    },
    "labels": [
        {
            "color": "FEF2C0",
            "default": false,
            "description": "Needs a third-party / external change or fix",
            "id": 101945532,
            "name": "status:blocked-external",
            "node_id": "MDU6TGFiZWwxMDE5NDU1MzI=",
            "url": "https://api.github.com/repos/neovim/neovim/labels/status:blocked-external"
        },
        {
            "color": "c5def5",
            "default": false,
            "description": null,
            "id": 662566370,
            "name": "lsp",
            "node_id": "MDU6TGFiZWw2NjI1NjYzNzA=",
            "url": "https://api.github.com/repos/neovim/neovim/labels/lsp"
        }
    ],
    "labels_url": "https://api.github.com/repos/neovim/neovim/issues/21783/labels{/name}",
    "locked": false,
    "milestone": {
        "closed_at": null,
        "closed_issues": 300,
        "created_at": "2014-11-26T22:13:11Z",
        "creator": {
            "avatar_url": "https://avatars.githubusercontent.com/u/1359421?v=4",
            "events_url": "https://api.github.com/users/justinmk/events{/privacy}",
            "followers_url": "https://api.github.com/users/justinmk/followers",
            "following_url": "https://api.github.com/users/justinmk/following{/other_user}",
            "gists_url": "https://api.github.com/users/justinmk/gists{/gist_id}",
            "gravatar_id": "",
            "html_url": "https://github.com/justinmk",
            "id": 1359421,
            "login": "justinmk",
            "node_id": "MDQ6VXNlcjEzNTk0MjE=",
            "organizations_url": "https://api.github.com/users/justinmk/orgs",
            "received_events_url": "https://api.github.com/users/justinmk/received_events",
            "repos_url": "https://api.github.com/users/justinmk/repos",
            "site_admin": false,
            "starred_url": "https://api.github.com/users/justinmk/starred{/owner}{/repo}",
            "subscriptions_url": "https://api.github.com/users/justinmk/subscriptions",
            "type": "User",
            "url": "https://api.github.com/users/justinmk",
            "user_view_type": "public"
        },
        "description": "We don't plan to work on this, but will accept high quality contributions from someone who will own the feature and follow up on bug reports.",
        "due_on": null,
        "html_url": "https://github.com/neovim/neovim/milestone/9",
        "id": 881978,
        "labels_url": "https://api.github.com/repos/neovim/neovim/milestones/9/labels",
        "node_id": "MDk6TWlsZXN0b25lODgxOTc4",
        "number": 9,
        "open_issues": 361,
        "state": "open",
        "title": "needs-owner",
        "updated_at": "2026-01-02T06:50:20Z",
        "url": "https://api.github.com/repos/neovim/neovim/milestones/9"
    },
    "node_id": "I_kwDOAPphoM5bU9CF",
    "number": 21783,
    "performed_via_github_app": null,
    "reactions": {
        "+1": 1,
        "-1": 0,
        "confused": 0,
        "eyes": 0,
        "heart": 0,
        "hooray": 0,
        "laugh": 0,
        "rocket": 0,
        "total_count": 1,
        "url": "https://api.github.com/repos/neovim/neovim/issues/21783/reactions"
    },
    "repository_url": "https://api.github.com/repos/neovim/neovim",
    "state": "open",
    "state_reason": null,
    "sub_issues_summary": {
        "completed": 0,
        "percent_completed": 0,
        "total": 0
    },
    "timeline_url": "https://api.github.com/repos/neovim/neovim/issues/21783/timeline",
    "title": " vim.lsp.buf.format() invalidates changes list",
    "type": null,
    "updated_at": "2026-01-04T08:19:34Z",
    "url": "https://api.github.com/repos/neovim/neovim/issues/21783",
    "user": {
        "avatar_url": "https://avatars.githubusercontent.com/u/80337370?v=4",
        "events_url": "https://api.github.com/users/Baehn/events{/privacy}",
        "followers_url": "https://api.github.com/users/Baehn/followers",
        "following_url": "https://api.github.com/users/Baehn/following{/other_user}",
        "gists_url": "https://api.github.com/users/Baehn/gists{/gist_id}",
        "gravatar_id": "",
        "html_url": "https://github.com/Baehn",
        "id": 80337370,
        "login": "Baehn",
        "node_id": "MDQ6VXNlcjgwMzM3Mzcw",
        "organizations_url": "https://api.github.com/users/Baehn/orgs",
        "received_events_url": "https://api.github.com/users/Baehn/received_events",
        "repos_url": "https://api.github.com/users/Baehn/repos",
        "site_admin": false,
        "starred_url": "https://api.github.com/users/Baehn/starred{/owner}{/repo}",
        "subscriptions_url": "https://api.github.com/users/Baehn/subscriptions",
        "type": "User",
        "url": "https://api.github.com/users/Baehn",
        "user_view_type": "public"
    }
}