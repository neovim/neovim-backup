{
    "active_lock_reason": null,
    "assignee": null,
    "assignees": [],
    "author_association": "NONE",
    "body": "### Problem\r\n\r\nhi folks, i just ran into a weird visual mode (i dont have a clear idea about it, sorry for the terrible issue title), in which every keypress will be appended to the buffer; while in a 'regular' visual mode, keypress will trigger rhs.\r\n\r\n### Steps to reproduce\r\n\r\n1. `$ nvim --clean +'inoremap <c-x> <cmd>so test.lua<cr>'`\r\n2. `i`\r\n3. `<c-x>`\r\n4. `j` #weird thing happends here\r\n\r\n<details>\r\n\r\n<summary>test.lua</summary>\r\n\r\n```\r\nlocal api = vim.api\r\n\r\nlocal function keycode(raw) return api.nvim_replace_termcodes(raw, true, true, true) end\r\n\r\nlocal function ensure_mode(mode)\r\n  local held = api.nvim_get_mode().mode\r\n  if mode ~= held then error(string.format(\"expecting in %s mode, actually %s\", mode, held)) end\r\nend\r\n\r\nlocal win_id = api.nvim_get_current_win()\r\napi.nvim_buf_set_lines(api.nvim_win_get_buf(win_id), 0, 1, false, { \"abcdef\" })\r\n\r\nensure_mode(\"i\")\r\napi.nvim_feedkeys(keycode(\"<esc>\"), \"nx\", false)\r\n-- vim.cmd.stopinsert() -- makes the following assertion failed\r\nensure_mode(\"n\")\r\napi.nvim_win_set_cursor(win_id, { 1, 0 })\r\napi.nvim_feedkeys(\"v\", \"nx\", false)\r\n-- vim.cmd('normal! v') -- makes no difference\r\nensure_mode(\"v\")\r\napi.nvim_win_set_cursor(win_id, { 1, 4 })\r\n```\r\n\r\n</details>\r\n\r\n### Expected behavior\r\n\r\nin the 4 step, `j` should behave like `vmap j`\r\n\r\n### Neovim version (nvim -v)\r\n\r\n0.9.0\r\n\r\n### Vim (not Nvim) behaves the same?\r\n\r\nN/A\r\n\r\n### Operating system/version\r\n\r\narchlinux\r\n\r\n### Terminal name/version\r\n\r\nst 0.9\r\n\r\n### $TERM environment variable\r\n\r\nst-256color\r\n\r\n### Installation\r\n\r\nsystem package manager",
    "closed_at": null,
    "closed_by": null,
    "comment_data": [
        {
            "author_association": "MEMBER",
            "body": "Hmm, using `feedkeys()` with `x` flag to do anything in Insert mode leads to strange behavior.",
            "created_at": "2023-05-09T08:22:02Z",
            "html_url": "https://github.com/neovim/neovim/issues/23549#issuecomment-1539669873",
            "id": 1539669873,
            "issue_url": "https://api.github.com/repos/neovim/neovim/issues/23549",
            "node_id": "IC_kwDOAPphoM5bxX9x",
            "performed_via_github_app": null,
            "reactions": {
                "+1": 0,
                "-1": 0,
                "confused": 0,
                "eyes": 0,
                "heart": 0,
                "hooray": 0,
                "laugh": 0,
                "rocket": 0,
                "total_count": 0,
                "url": "https://api.github.com/repos/neovim/neovim/issues/comments/1539669873/reactions"
            },
            "updated_at": "2023-05-09T08:22:02Z",
            "url": "https://api.github.com/repos/neovim/neovim/issues/comments/1539669873",
            "user": {
                "avatar_url": "https://avatars.githubusercontent.com/u/35768171?v=4",
                "events_url": "https://api.github.com/users/zeertzjq/events{/privacy}",
                "followers_url": "https://api.github.com/users/zeertzjq/followers",
                "following_url": "https://api.github.com/users/zeertzjq/following{/other_user}",
                "gists_url": "https://api.github.com/users/zeertzjq/gists{/gist_id}",
                "gravatar_id": "",
                "html_url": "https://github.com/zeertzjq",
                "id": 35768171,
                "login": "zeertzjq",
                "node_id": "MDQ6VXNlcjM1NzY4MTcx",
                "organizations_url": "https://api.github.com/users/zeertzjq/orgs",
                "received_events_url": "https://api.github.com/users/zeertzjq/received_events",
                "repos_url": "https://api.github.com/users/zeertzjq/repos",
                "site_admin": false,
                "starred_url": "https://api.github.com/users/zeertzjq/starred{/owner}{/repo}",
                "subscriptions_url": "https://api.github.com/users/zeertzjq/subscriptions",
                "type": "User",
                "url": "https://api.github.com/users/zeertzjq",
                "user_view_type": "public"
            }
        },
        {
            "author_association": "NONE",
            "body": "thanks for investigating this!\r\ni had also tried to use `vim.cmd.stopinsert()` instead, and got such error:\r\n```\r\nE5113: Error while calling lua chunk: test.lua:7: expecting in n mode, act\r\nually i\r\nstack traceback:\r\n        [C]: in function 'error'\r\n        test.lua:7: in function 'ensure_mode'\r\n        test.lua:16: in main chunk\r\n```",
            "created_at": "2023-05-09T08:47:03Z",
            "html_url": "https://github.com/neovim/neovim/issues/23549#issuecomment-1539707293",
            "id": 1539707293,
            "issue_url": "https://api.github.com/repos/neovim/neovim/issues/23549",
            "node_id": "IC_kwDOAPphoM5bxhGd",
            "performed_via_github_app": null,
            "reactions": {
                "+1": 0,
                "-1": 0,
                "confused": 0,
                "eyes": 0,
                "heart": 0,
                "hooray": 0,
                "laugh": 0,
                "rocket": 0,
                "total_count": 0,
                "url": "https://api.github.com/repos/neovim/neovim/issues/comments/1539707293/reactions"
            },
            "updated_at": "2023-05-09T08:47:03Z",
            "url": "https://api.github.com/repos/neovim/neovim/issues/comments/1539707293",
            "user": {
                "avatar_url": "https://avatars.githubusercontent.com/u/6236829?v=4",
                "events_url": "https://api.github.com/users/haolian9/events{/privacy}",
                "followers_url": "https://api.github.com/users/haolian9/followers",
                "following_url": "https://api.github.com/users/haolian9/following{/other_user}",
                "gists_url": "https://api.github.com/users/haolian9/gists{/gist_id}",
                "gravatar_id": "",
                "html_url": "https://github.com/haolian9",
                "id": 6236829,
                "login": "haolian9",
                "node_id": "MDQ6VXNlcjYyMzY4Mjk=",
                "organizations_url": "https://api.github.com/users/haolian9/orgs",
                "received_events_url": "https://api.github.com/users/haolian9/received_events",
                "repos_url": "https://api.github.com/users/haolian9/repos",
                "site_admin": false,
                "starred_url": "https://api.github.com/users/haolian9/starred{/owner}{/repo}",
                "subscriptions_url": "https://api.github.com/users/haolian9/subscriptions",
                "type": "User",
                "url": "https://api.github.com/users/haolian9",
                "user_view_type": "public"
            }
        },
        {
            "author_association": "NONE",
            "body": "Notes :\r\n\r\n- Removing the two lines\r\n\r\n```lua\r\nensure_mode(\"i\")\r\napi.nvim_feedkeys(keycode(\"<esc>\"), \"nx\", false)\r\n```\r\nand using\r\n```shell\r\n$ nvim --clean +'inoremap <c-x> <esc><cmd>so test.lua<cr>'\r\n```\r\nmakes it work as expected.\r\n- With the original code, it seems that `<esc>`  must be pressed again to return to the \"real\" visual mode.",
            "created_at": "2023-05-11T08:17:41Z",
            "html_url": "https://github.com/neovim/neovim/issues/23549#issuecomment-1543548671",
            "id": 1543548671,
            "issue_url": "https://api.github.com/repos/neovim/neovim/issues/23549",
            "node_id": "IC_kwDOAPphoM5cAK7_",
            "performed_via_github_app": null,
            "reactions": {
                "+1": 0,
                "-1": 0,
                "confused": 0,
                "eyes": 0,
                "heart": 0,
                "hooray": 0,
                "laugh": 0,
                "rocket": 0,
                "total_count": 0,
                "url": "https://api.github.com/repos/neovim/neovim/issues/comments/1543548671/reactions"
            },
            "updated_at": "2023-05-11T20:00:17Z",
            "url": "https://api.github.com/repos/neovim/neovim/issues/comments/1543548671",
            "user": {
                "avatar_url": "https://avatars.githubusercontent.com/u/11246966?v=4",
                "events_url": "https://api.github.com/users/georgejean/events{/privacy}",
                "followers_url": "https://api.github.com/users/georgejean/followers",
                "following_url": "https://api.github.com/users/georgejean/following{/other_user}",
                "gists_url": "https://api.github.com/users/georgejean/gists{/gist_id}",
                "gravatar_id": "",
                "html_url": "https://github.com/georgejean",
                "id": 11246966,
                "login": "georgejean",
                "node_id": "MDQ6VXNlcjExMjQ2OTY2",
                "organizations_url": "https://api.github.com/users/georgejean/orgs",
                "received_events_url": "https://api.github.com/users/georgejean/received_events",
                "repos_url": "https://api.github.com/users/georgejean/repos",
                "site_admin": false,
                "starred_url": "https://api.github.com/users/georgejean/starred{/owner}{/repo}",
                "subscriptions_url": "https://api.github.com/users/georgejean/subscriptions",
                "type": "User",
                "url": "https://api.github.com/users/georgejean",
                "user_view_type": "public"
            }
        },
        {
            "author_association": "NONE",
            "body": "hey @georgejean thanks for your rescue! but in my usecase it's not doable, i have this map\r\n```\r\nvim.keymap.set({'i', 'n', 'v', 's'}, '<tab>', goto_next_placeholder_within_the_expanded_snippet_region)\r\n```\r\nso i have to send `<esc>` through lua apis in that rhs callback.",
            "created_at": "2023-05-11T09:44:45Z",
            "html_url": "https://github.com/neovim/neovim/issues/23549#issuecomment-1543681094",
            "id": 1543681094,
            "issue_url": "https://api.github.com/repos/neovim/neovim/issues/23549",
            "node_id": "IC_kwDOAPphoM5cArRG",
            "performed_via_github_app": null,
            "reactions": {
                "+1": 0,
                "-1": 0,
                "confused": 0,
                "eyes": 0,
                "heart": 0,
                "hooray": 0,
                "laugh": 0,
                "rocket": 0,
                "total_count": 0,
                "url": "https://api.github.com/repos/neovim/neovim/issues/comments/1543681094/reactions"
            },
            "updated_at": "2023-05-11T09:44:45Z",
            "url": "https://api.github.com/repos/neovim/neovim/issues/comments/1543681094",
            "user": {
                "avatar_url": "https://avatars.githubusercontent.com/u/6236829?v=4",
                "events_url": "https://api.github.com/users/haolian9/events{/privacy}",
                "followers_url": "https://api.github.com/users/haolian9/followers",
                "following_url": "https://api.github.com/users/haolian9/following{/other_user}",
                "gists_url": "https://api.github.com/users/haolian9/gists{/gist_id}",
                "gravatar_id": "",
                "html_url": "https://github.com/haolian9",
                "id": 6236829,
                "login": "haolian9",
                "node_id": "MDQ6VXNlcjYyMzY4Mjk=",
                "organizations_url": "https://api.github.com/users/haolian9/orgs",
                "received_events_url": "https://api.github.com/users/haolian9/received_events",
                "repos_url": "https://api.github.com/users/haolian9/repos",
                "site_admin": false,
                "starred_url": "https://api.github.com/users/haolian9/starred{/owner}{/repo}",
                "subscriptions_url": "https://api.github.com/users/haolian9/subscriptions",
                "type": "User",
                "url": "https://api.github.com/users/haolian9",
                "user_view_type": "public"
            }
        },
        {
            "author_association": "NONE",
            "body": "Ok.\r\nI've tried a minimal example (test2.lua):\r\n```nvim\r\nlocal api = vim.api\r\n\r\nlocal function keycode(raw)\r\n\treturn api.nvim_replace_termcodes(raw, true, true, true)\r\nend\r\n\r\napi.nvim_feedkeys(keycode(\"<esc>\"),\"x\", false)\r\napi.nvim_echo({{api.nvim_get_mode().mode}},false,{})\r\n```\r\nTesting with\r\n```shell\r\nnvim --clean +'inoremap <c-x> <cmd>so test2.lua<cr>'\r\n```\r\nconfirms the normal mode but it is rather a strange insert mode.\r\nThe issue seems to come from the line which doesn't correctly exit insert mode.\r\n\r\nSorry, my limited knowledge doesn't allow me to help further. ",
            "created_at": "2023-05-11T13:53:42Z",
            "html_url": "https://github.com/neovim/neovim/issues/23549#issuecomment-1544032474",
            "id": 1544032474,
            "issue_url": "https://api.github.com/repos/neovim/neovim/issues/23549",
            "node_id": "IC_kwDOAPphoM5cCBDa",
            "performed_via_github_app": null,
            "reactions": {
                "+1": 1,
                "-1": 0,
                "confused": 0,
                "eyes": 0,
                "heart": 0,
                "hooray": 0,
                "laugh": 0,
                "rocket": 0,
                "total_count": 1,
                "url": "https://api.github.com/repos/neovim/neovim/issues/comments/1544032474/reactions"
            },
            "updated_at": "2023-05-11T13:53:42Z",
            "url": "https://api.github.com/repos/neovim/neovim/issues/comments/1544032474",
            "user": {
                "avatar_url": "https://avatars.githubusercontent.com/u/11246966?v=4",
                "events_url": "https://api.github.com/users/georgejean/events{/privacy}",
                "followers_url": "https://api.github.com/users/georgejean/followers",
                "following_url": "https://api.github.com/users/georgejean/following{/other_user}",
                "gists_url": "https://api.github.com/users/georgejean/gists{/gist_id}",
                "gravatar_id": "",
                "html_url": "https://github.com/georgejean",
                "id": 11246966,
                "login": "georgejean",
                "node_id": "MDQ6VXNlcjExMjQ2OTY2",
                "organizations_url": "https://api.github.com/users/georgejean/orgs",
                "received_events_url": "https://api.github.com/users/georgejean/received_events",
                "repos_url": "https://api.github.com/users/georgejean/repos",
                "site_admin": false,
                "starred_url": "https://api.github.com/users/georgejean/starred{/owner}{/repo}",
                "subscriptions_url": "https://api.github.com/users/georgejean/subscriptions",
                "type": "User",
                "url": "https://api.github.com/users/georgejean",
                "user_view_type": "public"
            }
        },
        {
            "author_association": "MEMBER",
            "body": "I don't think exiting Insert mode should be allowed here.",
            "created_at": "2023-05-11T15:54:13Z",
            "html_url": "https://github.com/neovim/neovim/issues/23549#issuecomment-1544249815",
            "id": 1544249815,
            "issue_url": "https://api.github.com/repos/neovim/neovim/issues/23549",
            "node_id": "IC_kwDOAPphoM5cC2HX",
            "performed_via_github_app": null,
            "reactions": {
                "+1": 0,
                "-1": 0,
                "confused": 0,
                "eyes": 0,
                "heart": 0,
                "hooray": 0,
                "laugh": 0,
                "rocket": 0,
                "total_count": 0,
                "url": "https://api.github.com/repos/neovim/neovim/issues/comments/1544249815/reactions"
            },
            "updated_at": "2023-05-12T01:38:17Z",
            "url": "https://api.github.com/repos/neovim/neovim/issues/comments/1544249815",
            "user": {
                "avatar_url": "https://avatars.githubusercontent.com/u/35768171?v=4",
                "events_url": "https://api.github.com/users/zeertzjq/events{/privacy}",
                "followers_url": "https://api.github.com/users/zeertzjq/followers",
                "following_url": "https://api.github.com/users/zeertzjq/following{/other_user}",
                "gists_url": "https://api.github.com/users/zeertzjq/gists{/gist_id}",
                "gravatar_id": "",
                "html_url": "https://github.com/zeertzjq",
                "id": 35768171,
                "login": "zeertzjq",
                "node_id": "MDQ6VXNlcjM1NzY4MTcx",
                "organizations_url": "https://api.github.com/users/zeertzjq/orgs",
                "received_events_url": "https://api.github.com/users/zeertzjq/received_events",
                "repos_url": "https://api.github.com/users/zeertzjq/repos",
                "site_admin": false,
                "starred_url": "https://api.github.com/users/zeertzjq/starred{/owner}{/repo}",
                "subscriptions_url": "https://api.github.com/users/zeertzjq/subscriptions",
                "type": "User",
                "url": "https://api.github.com/users/zeertzjq",
                "user_view_type": "public"
            }
        }
    ],
    "comments": 6,
    "comments_url": "https://api.github.com/repos/neovim/neovim/issues/23549/comments",
    "created_at": "2023-05-09T05:14:57Z",
    "events_url": "https://api.github.com/repos/neovim/neovim/issues/23549/events",
    "html_url": "https://github.com/neovim/neovim/issues/23549",
    "id": 1701348422,
    "labels": [
        {
            "color": "F9D0C4",
            "default": false,
            "description": "wrong behavior inherited from vim",
            "id": 154310492,
            "name": "bug-vim",
            "node_id": "MDU6TGFiZWwxNTQzMTA0OTI=",
            "url": "https://api.github.com/repos/neovim/neovim/labels/bug-vim"
        },
        {
            "color": "FBCA04",
            "default": false,
            "description": "upstream issue that must be fixed in Vim first",
            "id": 2639399975,
            "name": "needs:vim-patch",
            "node_id": "MDU6TGFiZWwyNjM5Mzk5OTc1",
            "url": "https://api.github.com/repos/neovim/neovim/labels/needs:vim-patch"
        }
    ],
    "labels_url": "https://api.github.com/repos/neovim/neovim/issues/23549/labels{/name}",
    "locked": false,
    "milestone": null,
    "node_id": "I_kwDOAPphoM5laIRG",
    "number": 23549,
    "performed_via_github_app": null,
    "reactions": {
        "+1": 0,
        "-1": 0,
        "confused": 0,
        "eyes": 0,
        "heart": 0,
        "hooray": 0,
        "laugh": 0,
        "rocket": 0,
        "total_count": 0,
        "url": "https://api.github.com/repos/neovim/neovim/issues/23549/reactions"
    },
    "repository_url": "https://api.github.com/repos/neovim/neovim",
    "state": "open",
    "state_reason": null,
    "sub_issues_summary": {
        "completed": 0,
        "percent_completed": 0,
        "total": 0
    },
    "timeline_url": "https://api.github.com/repos/neovim/neovim/issues/23549/timeline",
    "title": "weird visual mode",
    "updated_at": "2025-01-19T11:48:46Z",
    "url": "https://api.github.com/repos/neovim/neovim/issues/23549",
    "user": {
        "avatar_url": "https://avatars.githubusercontent.com/u/6236829?v=4",
        "events_url": "https://api.github.com/users/haolian9/events{/privacy}",
        "followers_url": "https://api.github.com/users/haolian9/followers",
        "following_url": "https://api.github.com/users/haolian9/following{/other_user}",
        "gists_url": "https://api.github.com/users/haolian9/gists{/gist_id}",
        "gravatar_id": "",
        "html_url": "https://github.com/haolian9",
        "id": 6236829,
        "login": "haolian9",
        "node_id": "MDQ6VXNlcjYyMzY4Mjk=",
        "organizations_url": "https://api.github.com/users/haolian9/orgs",
        "received_events_url": "https://api.github.com/users/haolian9/received_events",
        "repos_url": "https://api.github.com/users/haolian9/repos",
        "site_admin": false,
        "starred_url": "https://api.github.com/users/haolian9/starred{/owner}{/repo}",
        "subscriptions_url": "https://api.github.com/users/haolian9/subscriptions",
        "type": "User",
        "url": "https://api.github.com/users/haolian9",
        "user_view_type": "public"
    }
}