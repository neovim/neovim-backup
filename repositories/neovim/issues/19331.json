{
    "active_lock_reason": null,
    "assignee": null,
    "assignees": [],
    "author_association": "MEMBER",
    "body": "### Neovim version (nvim -v)\r\n\r\nN/A\r\n\r\n### Vim (not Nvim) behaves the same?\r\n\r\nN/A\r\n\r\n### Operating system/version\r\n\r\nsourcehut CI openbsd/latest\r\n\r\n### Terminal name/version\r\n\r\nN/A\r\n\r\n### $TERM environment variable\r\n\r\nN/A\r\n\r\n### Installation\r\n\r\nN/A\r\n\r\n### How to reproduce the issue\r\n\r\nRun oldtests on OpenBSD\r\n\r\n### Expected behavior\r\n\r\nTests pass\r\n\r\n### Actual behavior\r\n\r\nTest failure is (<https://builds.sr.ht/~jmk/job/799797>):\r\n```\r\nFailures: \r\n\tFrom test_excmd.vim:\r\n\tFound errors in Test_language_cmd():\r\n\tfunction RunTheTest[40]..Test_language_cmd line 3: command did not fail: language ctype non_existing_lang\r\n\tfunction RunTheTest[40]..Test_language_cmd line 4: command did not fail: language time non_existing_lang\r\n```",
    "closed_at": null,
    "closed_by": null,
    "comment_data": [
        {
            "author_association": "CONTRIBUTOR",
            "body": "Can confirm, we are seeing those failures in OpenBSD ports too.",
            "created_at": "2022-10-03T14:09:59Z",
            "html_url": "https://github.com/neovim/neovim/issues/19331#issuecomment-1265501639",
            "id": 1265501639,
            "issue_url": "https://api.github.com/repos/neovim/neovim/issues/19331",
            "node_id": "IC_kwDOAPphoM5LbgXH",
            "performed_via_github_app": null,
            "reactions": {
                "+1": 0,
                "-1": 0,
                "confused": 0,
                "eyes": 0,
                "heart": 0,
                "hooray": 0,
                "laugh": 0,
                "rocket": 0,
                "total_count": 0,
                "url": "https://api.github.com/repos/neovim/neovim/issues/comments/1265501639/reactions"
            },
            "updated_at": "2022-10-03T14:09:59Z",
            "url": "https://api.github.com/repos/neovim/neovim/issues/comments/1265501639",
            "user": {
                "avatar_url": "https://avatars.githubusercontent.com/u/604955?v=4",
                "events_url": "https://api.github.com/users/vext01/events{/privacy}",
                "followers_url": "https://api.github.com/users/vext01/followers",
                "following_url": "https://api.github.com/users/vext01/following{/other_user}",
                "gists_url": "https://api.github.com/users/vext01/gists{/gist_id}",
                "gravatar_id": "",
                "html_url": "https://github.com/vext01",
                "id": 604955,
                "login": "vext01",
                "node_id": "MDQ6VXNlcjYwNDk1NQ==",
                "organizations_url": "https://api.github.com/users/vext01/orgs",
                "received_events_url": "https://api.github.com/users/vext01/received_events",
                "repos_url": "https://api.github.com/users/vext01/repos",
                "site_admin": false,
                "starred_url": "https://api.github.com/users/vext01/starred{/owner}{/repo}",
                "subscriptions_url": "https://api.github.com/users/vext01/subscriptions",
                "type": "User",
                "url": "https://api.github.com/users/vext01",
                "user_view_type": "public"
            }
        },
        {
            "author_association": "CONTRIBUTOR",
            "body": "The following is for Windows CI, not OpenBSD.\r\n\r\nAlthough the CI log says only `:language time` command failed to fail, that's misleading.  It turns out whatever is on the second line will cause this error.  Doesn't matter if it's `:lang ctype non_existing_lang` or just `:lang non_existing_lang`.\r\n\r\nI used this block for the oldtest:\r\n```\r\n\" Test for the :language command\r\nfunc Test_language_cmd()\r\n  \" CheckNotMSWindows  \" FIXME: why does this fail on Windows CI?\r\n  CheckFeature multi_lang\r\n\r\n  call assert_fails('language ctype non_existing_lang', 'E197:')\r\n  call assert_fails('language ctype non_existing_lang', 'E197:')\r\n  call assert_fails('language time non_existing_lang', 'E197:')\r\n  call assert_fails('language non_existing_lang', 'E197:')\r\nendfunc\r\n```\r\n\r\nAnd I got this [error log][1]:\r\n```\r\nFailures: \r\n\tFrom test_excmd.vim:\r\n\tFound errors in Test_language_cmd():\r\n\tcommand line..script D:/a/neovim/neovim/src/nvim/testdir/runtest.vim[437]..function RunTheTest[44]..Test_language_cmd line 5: command did not fail: language ctype non_existing_lang\r\n\tcommand line..script D:/a/neovim/neovim/src/nvim/testdir/runtest.vim[437]..function RunTheTest[44]..Test_language_cmd line 6: command did not fail: language time non_existing_lang\r\n\tcommand line..script D:/a/neovim/neovim/src/nvim/testdir/runtest.vim[437]..function RunTheTest[44]..Test_language_cmd line 7: command did not fail: language non_existing_lang\r\n```\r\n\r\nMy guess is: there is something wrong with either `assert_fails` or with how oldtests is using `assert_fails`.  Because inside the same test, if the error caused by the `{cmd}` of one `assert_fails({cmd})` is the same as the error caused by a previous `assert_fails`, then it's not registered as a fail.\r\n\r\nI don't know anything about oldtests to proceed further.\r\n\r\n[1]: https://github.com/3N4N/neovim/actions/runs/4363114712/jobs/7628810883#step:10:5498",
            "created_at": "2023-03-08T10:14:50Z",
            "html_url": "https://github.com/neovim/neovim/issues/19331#issuecomment-1459934612",
            "id": 1459934612,
            "issue_url": "https://api.github.com/repos/neovim/neovim/issues/19331",
            "node_id": "IC_kwDOAPphoM5XBNWU",
            "performed_via_github_app": null,
            "reactions": {
                "+1": 0,
                "-1": 0,
                "confused": 0,
                "eyes": 0,
                "heart": 0,
                "hooray": 0,
                "laugh": 0,
                "rocket": 0,
                "total_count": 0,
                "url": "https://api.github.com/repos/neovim/neovim/issues/comments/1459934612/reactions"
            },
            "updated_at": "2023-03-13T08:21:49Z",
            "url": "https://api.github.com/repos/neovim/neovim/issues/comments/1459934612",
            "user": {
                "avatar_url": "https://avatars.githubusercontent.com/u/32037751?v=4",
                "events_url": "https://api.github.com/users/3N4N/events{/privacy}",
                "followers_url": "https://api.github.com/users/3N4N/followers",
                "following_url": "https://api.github.com/users/3N4N/following{/other_user}",
                "gists_url": "https://api.github.com/users/3N4N/gists{/gist_id}",
                "gravatar_id": "",
                "html_url": "https://github.com/3N4N",
                "id": 32037751,
                "login": "3N4N",
                "node_id": "MDQ6VXNlcjMyMDM3NzUx",
                "organizations_url": "https://api.github.com/users/3N4N/orgs",
                "received_events_url": "https://api.github.com/users/3N4N/received_events",
                "repos_url": "https://api.github.com/users/3N4N/repos",
                "site_admin": false,
                "starred_url": "https://api.github.com/users/3N4N/starred{/owner}{/repo}",
                "subscriptions_url": "https://api.github.com/users/3N4N/subscriptions",
                "type": "User",
                "url": "https://api.github.com/users/3N4N",
                "user_view_type": "public"
            }
        },
        {
            "author_association": "CONTRIBUTOR",
            "body": "I said:\r\n> My guess is: there is something wrong with either assert_fails or with how oldtests is using assert_fails.\r\n\r\nThat is incorrect.  Because I tested with a new functional test:\r\n\r\n```\r\nlocal helpers = require('test.functional.helpers')(after_each)\r\nlocal clear, feed_command, feed, ok, eval =\r\n  helpers.clear, helpers.feed_command, helpers.feed, helpers.ok, helpers.eval\r\n\r\nlocal Screen = require('test.functional.ui.screen')\r\n\r\ndescribe(':lang', function()\r\n  before_each(clear)\r\n\r\n  it('errors E197 on wrong language', function()\r\n    local screen = Screen.new(500, 10)\r\n    screen:attach()\r\n\r\n    feed_command('language time')\r\n    screen:snapshot_util()\r\n\r\n    feed_command('language time non_existing_lang')\r\n    screen:snapshot_util()\r\n\r\n    feed_command('language ctype non_existing_lang')\r\n    screen:snapshot_util()\r\n\r\n    feed_command('language non_existing_lang')\r\n    screen:snapshot_util()\r\n    screen:expect{\r\n      any=[[Executing command: .?& { Get%-Content .* | & sort }]]\r\n    }\r\n  end)\r\nend)\r\n```\r\n\r\nAnd the [error log][1] is this:\r\n```RUN      T1 :lang errors E197 on wrong language: \r\nscreen:expect{grid=[[\r\n  ^                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    |\r\n  </snip>\r\n  Current time language: \"en_US.UTF-8\"                                                                                                                                                                                                                                                                                                                                                                                                                                                                                |\r\n]], attr_ids={\r\n  [1] = {foreground = Screen.colors.Blue, bold = true};\r\n}}\r\n\r\n\r\nscreen:expect{grid=[[\r\n  ^                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    |\r\n  </snip>\r\n  {2:E197: Cannot set language to \"non_existing_lang\"}                                                                                                                                                                                                                                                                                                                                                                                                                                                                    |\r\n]], attr_ids={\r\n  [1] = {foreground = Screen.colors.Blue, bold = true};\r\n  [2] = {background = Screen.colors.Red1, foreground = Screen.colors.Grey100};\r\n}}\r\n\r\n\r\nscreen:expect{grid=[[\r\n  ^                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    |\r\n  </snip>\r\n  :language ctype non_existing_lang                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   |\r\n]], attr_ids={\r\n  [1] = {foreground = Screen.colors.Blue, bold = true};\r\n}}\r\n\r\n\r\nscreen:expect{grid=[[\r\n  ^                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    |\r\n  </snip>\r\n  :language non_existing_lang                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         |\r\n]], attr_ids={\r\n  [1] = {foreground = Screen.colors.Blue, bold = true};\r\n}}\r\n\r\n11625.00 ms FAIL\r\ntest/functional/ex_cmds/lang_spec.lua:25: Failed to match any screen lines.\r\nExpected (anywhere): \"Executing command: .?& { Get%-Content .* | & sort }\"\r\nActual:\r\n  |^                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    |\r\n  </snip>\r\n  |:language non_existing_lang                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         |\r\n\r\nstack traceback:\r\n\ttest\\functional\\ui\\screen.lua:622: in function '_wait'\r\n\ttest\\functional\\ui\\screen.lua:352: in function 'expect'\r\n\ttest/functional/ex_cmds/lang_spec.lua:25: in function <test/functional/ex_cmds/lang_spec.lua:10>\r\n```\r\n\r\nNOTE that for all `:lang` commands after the first one, the output does NOT include `E197:` error output (unlike [Linux test log][2]).  So the issue is not with `assert_fails` nor with how oldtests is set up.  The issue is somewhere else.  Where?  I donno.\r\n\r\n[1]: https://github.com/3N4N/neovim/actions/runs/4363821610/jobs/7630383394#step:9:222\r\n[2]: https://github.com/3N4N/neovim/actions/runs/4363821610/jobs/7630383856#step:12:35",
            "created_at": "2023-03-08T11:47:14Z",
            "html_url": "https://github.com/neovim/neovim/issues/19331#issuecomment-1460038210",
            "id": 1460038210,
            "issue_url": "https://api.github.com/repos/neovim/neovim/issues/19331",
            "node_id": "IC_kwDOAPphoM5XBmpC",
            "performed_via_github_app": null,
            "reactions": {
                "+1": 0,
                "-1": 0,
                "confused": 0,
                "eyes": 0,
                "heart": 0,
                "hooray": 0,
                "laugh": 0,
                "rocket": 0,
                "total_count": 0,
                "url": "https://api.github.com/repos/neovim/neovim/issues/comments/1460038210/reactions"
            },
            "updated_at": "2023-03-08T12:05:49Z",
            "url": "https://api.github.com/repos/neovim/neovim/issues/comments/1460038210",
            "user": {
                "avatar_url": "https://avatars.githubusercontent.com/u/32037751?v=4",
                "events_url": "https://api.github.com/users/3N4N/events{/privacy}",
                "followers_url": "https://api.github.com/users/3N4N/followers",
                "following_url": "https://api.github.com/users/3N4N/following{/other_user}",
                "gists_url": "https://api.github.com/users/3N4N/gists{/gist_id}",
                "gravatar_id": "",
                "html_url": "https://github.com/3N4N",
                "id": 32037751,
                "login": "3N4N",
                "node_id": "MDQ6VXNlcjMyMDM3NzUx",
                "organizations_url": "https://api.github.com/users/3N4N/orgs",
                "received_events_url": "https://api.github.com/users/3N4N/received_events",
                "repos_url": "https://api.github.com/users/3N4N/repos",
                "site_admin": false,
                "starred_url": "https://api.github.com/users/3N4N/starred{/owner}{/repo}",
                "subscriptions_url": "https://api.github.com/users/3N4N/subscriptions",
                "type": "User",
                "url": "https://api.github.com/users/3N4N",
                "user_view_type": "public"
            }
        },
        {
            "author_association": "CONTRIBUTOR",
            "body": "Turns out in Windows CI, nvim is allowing `non_existing_lang` for `:lang` value.\r\n\r\nI changed my lua functional test to print the value of `:lang ctype` after executing `language ctype non_existing_lang`:\r\n```\r\nlocal helpers = require('test.functional.helpers')(after_each)\r\nlocal clear, feed_command, feed, ok, eval =\r\n  helpers.clear, helpers.feed_command, helpers.feed, helpers.ok, helpers.eval\r\n\r\nlocal Screen = require('test.functional.ui.screen')\r\n\r\ndescribe(':lang', function()\r\n  before_each(clear)\r\n\r\n  it('errors E197 on wrong language', function()\r\n    local screen = Screen.new(500, 10)\r\n    screen:attach()\r\n\r\n    feed_command('language')\r\n    screen:snapshot_util()\r\n\r\n    feed_command('language time non_existing_lang')\r\n    screen:snapshot_util()\r\n\r\n    feed_command('language ctype non_existing_lang')\r\n    screen:snapshot_util()\r\n\r\n    feed_command('language ctype')\r\n    screen:snapshot_util()\r\n\r\n    feed_command('language non_existing_lang')\r\n    screen:snapshot_util()\r\n    screen:expect{\r\n      any=[[Executing command: .?& { Get%-Content .* | & sort }]]\r\n    }\r\n  end)\r\nend)\r\n```\r\n\r\nAnd the [error log][1] shows that `:lang ctype` was successfully set to `non_existing_lang`.\r\n\r\n[1]: https://github.com/3N4N/neovim/actions/runs/4364006674/jobs/7630795838#step:9:288",
            "created_at": "2023-03-08T12:05:31Z",
            "html_url": "https://github.com/neovim/neovim/issues/19331#issuecomment-1460057356",
            "id": 1460057356,
            "issue_url": "https://api.github.com/repos/neovim/neovim/issues/19331",
            "node_id": "IC_kwDOAPphoM5XBrUM",
            "performed_via_github_app": null,
            "reactions": {
                "+1": 0,
                "-1": 0,
                "confused": 0,
                "eyes": 0,
                "heart": 0,
                "hooray": 0,
                "laugh": 0,
                "rocket": 0,
                "total_count": 0,
                "url": "https://api.github.com/repos/neovim/neovim/issues/comments/1460057356/reactions"
            },
            "updated_at": "2023-03-13T12:00:44Z",
            "url": "https://api.github.com/repos/neovim/neovim/issues/comments/1460057356",
            "user": {
                "avatar_url": "https://avatars.githubusercontent.com/u/32037751?v=4",
                "events_url": "https://api.github.com/users/3N4N/events{/privacy}",
                "followers_url": "https://api.github.com/users/3N4N/followers",
                "following_url": "https://api.github.com/users/3N4N/following{/other_user}",
                "gists_url": "https://api.github.com/users/3N4N/gists{/gist_id}",
                "gravatar_id": "",
                "html_url": "https://github.com/3N4N",
                "id": 32037751,
                "login": "3N4N",
                "node_id": "MDQ6VXNlcjMyMDM3NzUx",
                "organizations_url": "https://api.github.com/users/3N4N/orgs",
                "received_events_url": "https://api.github.com/users/3N4N/received_events",
                "repos_url": "https://api.github.com/users/3N4N/repos",
                "site_admin": false,
                "starred_url": "https://api.github.com/users/3N4N/starred{/owner}{/repo}",
                "subscriptions_url": "https://api.github.com/users/3N4N/subscriptions",
                "type": "User",
                "url": "https://api.github.com/users/3N4N",
                "user_view_type": "public"
            }
        },
        {
            "author_association": "CONTRIBUTOR",
            "body": "Huh.  Turns out it might be a problem with ucrt library.  Both MSVC and [MSYS/UCRT64][3] use that C runtime library and in both cases Windows CI [fails this oldtest][4].  But [MSYS/MINGW64][1] uses msvcrt, and it [passes the oldtest][2].\r\n\r\nI haven't found any documented case of this scenario for ucrt.  The [closest case I found][5] was supposedly fixed in 2019.\r\n\r\nEDIT: Found [another documented case][6] which says `setlocale()` accepts bogus locale values in older ucrt versions.\r\n\r\nUpdate: Yep!  I ran the CI on `windows-latest` workflow image and this bug isn't raised there.  Tried with both [MSVC][7] and [MSYS/UCRT64][8].  Looks like ucrt is updated in `windows-latest`.\r\n\r\n\r\n[1]: https://github.com/3N4N/neovim/actions/runs/4366190668/jobs/7635856118#step:4:1\r\n[2]: https://github.com/3N4N/neovim/actions/runs/4366190668/jobs/7635856118#step:9:27\r\n[3]: https://github.com/3N4N/neovim/actions/runs/4365878932/jobs/7635115204#step:4:1\r\n[4]: https://github.com/3N4N/neovim/actions/runs/4365878932/jobs/7635115204#step:9:75\r\n[5]: https://developercommunity.visualstudio.com/t/setlocalelc-numeric-iso-latin-16-fails-then-succee/519486\r\n[6]: https://developercommunity.visualstudio.com/t/setlocale-succeeds-for-bogus-locale-names-in-older/1652241\r\n[7]: https://github.com/3N4N/neovim/actions/runs/4366899977/jobs/7637513822\r\n[8]: https://github.com/3N4N/neovim/actions/runs/4366749677/jobs/7637165760",
            "created_at": "2023-03-08T16:25:14Z",
            "html_url": "https://github.com/neovim/neovim/issues/19331#issuecomment-1460454186",
            "id": 1460454186,
            "issue_url": "https://api.github.com/repos/neovim/neovim/issues/19331",
            "node_id": "IC_kwDOAPphoM5XDMMq",
            "performed_via_github_app": null,
            "reactions": {
                "+1": 0,
                "-1": 0,
                "confused": 0,
                "eyes": 0,
                "heart": 2,
                "hooray": 0,
                "laugh": 0,
                "rocket": 0,
                "total_count": 2,
                "url": "https://api.github.com/repos/neovim/neovim/issues/comments/1460454186/reactions"
            },
            "updated_at": "2023-03-13T12:00:15Z",
            "url": "https://api.github.com/repos/neovim/neovim/issues/comments/1460454186",
            "user": {
                "avatar_url": "https://avatars.githubusercontent.com/u/32037751?v=4",
                "events_url": "https://api.github.com/users/3N4N/events{/privacy}",
                "followers_url": "https://api.github.com/users/3N4N/followers",
                "following_url": "https://api.github.com/users/3N4N/following{/other_user}",
                "gists_url": "https://api.github.com/users/3N4N/gists{/gist_id}",
                "gravatar_id": "",
                "html_url": "https://github.com/3N4N",
                "id": 32037751,
                "login": "3N4N",
                "node_id": "MDQ6VXNlcjMyMDM3NzUx",
                "organizations_url": "https://api.github.com/users/3N4N/orgs",
                "received_events_url": "https://api.github.com/users/3N4N/received_events",
                "repos_url": "https://api.github.com/users/3N4N/repos",
                "site_admin": false,
                "starred_url": "https://api.github.com/users/3N4N/starred{/owner}{/repo}",
                "subscriptions_url": "https://api.github.com/users/3N4N/subscriptions",
                "type": "User",
                "url": "https://api.github.com/users/3N4N",
                "user_view_type": "public"
            }
        }
    ],
    "comments": 5,
    "comments_url": "https://api.github.com/repos/neovim/neovim/issues/19331/comments",
    "created_at": "2022-07-12T04:19:27Z",
    "events_url": "https://api.github.com/repos/neovim/neovim/issues/19331/events",
    "html_url": "https://github.com/neovim/neovim/issues/19331",
    "id": 1301514314,
    "labels": [
        {
            "color": "f9d0c4",
            "default": true,
            "description": "issues reporting wrong behavior",
            "id": 77997474,
            "name": "bug",
            "node_id": "MDU6TGFiZWw3Nzk5NzQ3NA==",
            "url": "https://api.github.com/repos/neovim/neovim/labels/bug"
        },
        {
            "color": "c5def5",
            "default": false,
            "description": "",
            "id": 110418643,
            "name": "test",
            "node_id": "MDU6TGFiZWwxMTA0MTg2NDM=",
            "url": "https://api.github.com/repos/neovim/neovim/labels/test"
        },
        {
            "color": "d4c5f9",
            "default": false,
            "description": "issues specific to BSD descendants (please specify which in the issue)",
            "id": 201019594,
            "name": "platform:bsd",
            "node_id": "MDU6TGFiZWwyMDEwMTk1OTQ=",
            "url": "https://api.github.com/repos/neovim/neovim/labels/platform:bsd"
        }
    ],
    "labels_url": "https://api.github.com/repos/neovim/neovim/issues/19331/labels{/name}",
    "locked": false,
    "milestone": null,
    "node_id": "I_kwDOAPphoM5Nk4hK",
    "number": 19331,
    "performed_via_github_app": null,
    "reactions": {
        "+1": 0,
        "-1": 0,
        "confused": 0,
        "eyes": 0,
        "heart": 0,
        "hooray": 0,
        "laugh": 0,
        "rocket": 0,
        "total_count": 0,
        "url": "https://api.github.com/repos/neovim/neovim/issues/19331/reactions"
    },
    "repository_url": "https://api.github.com/repos/neovim/neovim",
    "state": "open",
    "state_reason": null,
    "sub_issues_summary": {
        "completed": 0,
        "percent_completed": 0,
        "total": 0
    },
    "timeline_url": "https://api.github.com/repos/neovim/neovim/issues/19331/timeline",
    "title": "`:language time` doesn't give an error for invalid language on OpenBSD",
    "updated_at": "2025-01-19T11:34:41Z",
    "url": "https://api.github.com/repos/neovim/neovim/issues/19331",
    "user": {
        "avatar_url": "https://avatars.githubusercontent.com/u/35768171?v=4",
        "events_url": "https://api.github.com/users/zeertzjq/events{/privacy}",
        "followers_url": "https://api.github.com/users/zeertzjq/followers",
        "following_url": "https://api.github.com/users/zeertzjq/following{/other_user}",
        "gists_url": "https://api.github.com/users/zeertzjq/gists{/gist_id}",
        "gravatar_id": "",
        "html_url": "https://github.com/zeertzjq",
        "id": 35768171,
        "login": "zeertzjq",
        "node_id": "MDQ6VXNlcjM1NzY4MTcx",
        "organizations_url": "https://api.github.com/users/zeertzjq/orgs",
        "received_events_url": "https://api.github.com/users/zeertzjq/received_events",
        "repos_url": "https://api.github.com/users/zeertzjq/repos",
        "site_admin": false,
        "starred_url": "https://api.github.com/users/zeertzjq/starred{/owner}{/repo}",
        "subscriptions_url": "https://api.github.com/users/zeertzjq/subscriptions",
        "type": "User",
        "url": "https://api.github.com/users/zeertzjq",
        "user_view_type": "public"
    }
}