{
    "active_lock_reason": null,
    "assignee": null,
    "assignees": [],
    "author_association": "CONTRIBUTOR",
    "body": "### Problem\n\n[Kulala](https://github.com/mistweaverco/kulala.nvim) is a Neovim plugin that bundles an in-process LSP. When using its LSP, in combination with a regular LSP, file edits may throw an error: \n```\nLua callback: /usr/share/nvim/runtime/lua/vim/lsp/_changetracking.lua:308: attempt to index local 'buf_state' (a nil value)\nstack traceback:\n\t/usr/share/nvim/runtime/lua/vim/lsp/_changetracking.lua:308: in function 'send_changes_for_group'\n\t/usr/share/nvim/runtime/lua/vim/lsp/_changetracking.lua:351: in function 'send_changes'\n\t/usr/share/nvim/runtime/lua/vim/lsp.lua:927: in function </usr/share/nvim/runtime/lua/vim/lsp.lua:921>\n```\nIf I then try to save the file, I get another error:\n```\nError in BufWritePost Autocommands for \"<buffer=1>\":\nLua callback: /usr/share/nvim/runtime/lua/vim/lsp/_changetracking.lua:175: attempt to index local 'buf_state' (a nil value)\nstack traceback:\n\t/usr/share/nvim/runtime/lua/vim/lsp/_changetracking.lua:175: in function '_get_and_set_name'\n\t/usr/share/nvim/runtime/lua/vim/lsp.lua:838: in function 'text_document_did_save_handler'\n\t/usr/share/nvim/runtime/lua/vim/lsp.lua:916: in function </usr/share/nvim/runtime/lua/vim/lsp.lua:915>\n```\nRelated: https://github.com/neovim/neovim/pull/37454\n\n### Steps to reproduce using \"nvim --clean -u minimal_init.lua\"\n\nNot quite as minimalâ„¢ because it requires Kulala. I could only observe this behavior with its LSP.\n\n- Config\n```lua\nvim.pack.add({\n\t\"https://github.com/mistweaverco/kulala.nvim\",\n})\nrequire(\"kulala\").setup()\n\n---@type vim.lsp.Config\nvim.lsp.config(\"jsonls\", {\n\tcmd = { \"vscode-json-language-server\", \"--stdio\" },\n\tfiletypes = { \"json\", \"jsonc\" },\n})\n\nvim.lsp.enable(\"jsonls\")\n```\n- Sample file:\n```json\n{\"vimscript\":\"let SessionLoad = 1\\nlet s:so_save = &g:so | let s:siso_save = &g:siso | setg so=0 siso=0 | setl so=-1 siso=-1\\nlet v:this_session=expand(\\\"<sfile>:p\\\")\\nsilent only\\nsilent tabonly\\ncd ~/.local/share/nvim/possession\\nif expand('%') == '' && !&modified && line('$') <= 1 && getline(1) == ''\\n  let s:wipebuf = bufnr('%')\\nendif\\nlet s:shortmess_save = &shortmess\\nset shortmess+=aoO\\nbadd +1 minimal.lua\\nargglobal\\n%argdel\\n$argadd minimal.lua\\nedit minimal.lua\\nargglobal\\nsetlocal foldmethod=expr\\nsetlocal foldexpr=v:lua.vim.treesitter.foldexpr()\\nsetlocal foldmarker={{{,}}}\\nsetlocal foldignore=#\\nsetlocal foldlevel=99\\nsetlocal foldminlines=1\\nsetlocal foldnestmax=20\\nsetlocal foldenable\\nlet s:l = 1 - ((0 * winheight(0) + 20) / 41)\\nif s:l < 1 | let s:l = 1 | endif\\nkeepjumps exe s:l\\nnormal! zt\\nkeepjumps 1\\nnormal! 0\\ntabnext 1\\nif exists('s:wipebuf') && len(win_findbuf(s:wipebuf)) == 0 && getbufvar(s:wipebuf, '&buftype') isnot# 'terminal'\\n  silent exe 'bwipe ' . s:wipebuf\\nendif\\nunlet! s:wipebuf\\nset winheight=1 winwidth=20\\nlet &shortmess = s:shortmess_save\\nlet s:sx = expand(\\\"<sfile>:p:r\\\").\\\"x.vim\\\"\\nif filereadable(s:sx)\\n  exe \\\"source \\\" . fnameescape(s:sx)\\nendif\\nlet &g:so = s:so_save | let &g:siso = s:siso_save\\nset hlsearch\\ndoautoall SessionLoadPost\\nunlet SessionLoad\\n\\\" vim: set ft=vim :\\n\",\"cwd\":\"/home/dev/.local/share/nvim/possession\",\"plugins\":{\"close_windows\":[],\"dap\":{\"breakpoints\":[]},\"dapui\":[],\"tabby\":[],\"neo_tree\":[],\"nvim_tree\":{\"tabs\":[]},\"outline\":[],\"kulala\":{\"tabs\":[]},\"neotest\":[],\"delete_hidden_buffers\":[],\"symbols_outline\":[]},\"user_data\":[],\"name\":\"__\"}\n```\n- Steps\n1. `nvim -u minimal_init.lua file.json`\n2. `V>`\n\n### Expected behavior\n\n_No response_\n\n### Nvim version (nvim -v)\n\nNVIM v0.12.0-dev-2246+g57fc77ed29\n\n### Language server name/version\n\nkulala 5.3.4; jsonls 1.107.0\n\n### Operating system/version\n\nArch Linux 6.18\n\n### Log file\n\n_No response_",
    "closed_at": null,
    "closed_by": null,
    "comment_data": [
        {
            "author_association": "MEMBER",
            "body": "Can you confirm if #37454 fixes this?",
            "created_at": "2026-02-11T11:43:56Z",
            "html_url": "https://github.com/neovim/neovim/issues/37814#issuecomment-3883915777",
            "id": 3883915777,
            "issue_url": "https://api.github.com/repos/neovim/neovim/issues/37814",
            "node_id": "IC_kwDOAPphoM7nf9oB",
            "performed_via_github_app": null,
            "pin": null,
            "reactions": {
                "+1": 1,
                "-1": 0,
                "confused": 0,
                "eyes": 0,
                "heart": 0,
                "hooray": 0,
                "laugh": 0,
                "rocket": 0,
                "total_count": 1,
                "url": "https://api.github.com/repos/neovim/neovim/issues/comments/3883915777/reactions"
            },
            "updated_at": "2026-02-11T11:44:14Z",
            "url": "https://api.github.com/repos/neovim/neovim/issues/comments/3883915777",
            "user": {
                "avatar_url": "https://avatars.githubusercontent.com/u/1359421?v=4",
                "events_url": "https://api.github.com/users/justinmk/events{/privacy}",
                "followers_url": "https://api.github.com/users/justinmk/followers",
                "following_url": "https://api.github.com/users/justinmk/following{/other_user}",
                "gists_url": "https://api.github.com/users/justinmk/gists{/gist_id}",
                "gravatar_id": "",
                "html_url": "https://github.com/justinmk",
                "id": 1359421,
                "login": "justinmk",
                "node_id": "MDQ6VXNlcjEzNTk0MjE=",
                "organizations_url": "https://api.github.com/users/justinmk/orgs",
                "received_events_url": "https://api.github.com/users/justinmk/received_events",
                "repos_url": "https://api.github.com/users/justinmk/repos",
                "site_admin": false,
                "starred_url": "https://api.github.com/users/justinmk/starred{/owner}{/repo}",
                "subscriptions_url": "https://api.github.com/users/justinmk/subscriptions",
                "type": "User",
                "url": "https://api.github.com/users/justinmk",
                "user_view_type": "public"
            }
        },
        {
            "author_association": "CONTRIBUTOR",
            "body": "> Can you confirm if [#37454](https://github.com/neovim/neovim/pull/37454) fixes this?\n\nCertainly it does not _fully_ resolve this issue, it addresses at most the second stack (since it doesn't touch the lines from the first stack). But I'll give it a shot anyway.",
            "created_at": "2026-02-11T23:55:16Z",
            "html_url": "https://github.com/neovim/neovim/issues/37814#issuecomment-3887872341",
            "id": 3887872341,
            "issue_url": "https://api.github.com/repos/neovim/neovim/issues/37814",
            "node_id": "IC_kwDOAPphoM7nvDlV",
            "performed_via_github_app": null,
            "pin": null,
            "reactions": {
                "+1": 1,
                "-1": 0,
                "confused": 0,
                "eyes": 0,
                "heart": 0,
                "hooray": 0,
                "laugh": 0,
                "rocket": 0,
                "total_count": 1,
                "url": "https://api.github.com/repos/neovim/neovim/issues/comments/3887872341/reactions"
            },
            "updated_at": "2026-02-11T23:55:16Z",
            "url": "https://api.github.com/repos/neovim/neovim/issues/comments/3887872341",
            "user": {
                "avatar_url": "https://avatars.githubusercontent.com/u/84649544?v=4",
                "events_url": "https://api.github.com/users/igorlfs/events{/privacy}",
                "followers_url": "https://api.github.com/users/igorlfs/followers",
                "following_url": "https://api.github.com/users/igorlfs/following{/other_user}",
                "gists_url": "https://api.github.com/users/igorlfs/gists{/gist_id}",
                "gravatar_id": "",
                "html_url": "https://github.com/igorlfs",
                "id": 84649544,
                "login": "igorlfs",
                "node_id": "MDQ6VXNlcjg0NjQ5NTQ0",
                "organizations_url": "https://api.github.com/users/igorlfs/orgs",
                "received_events_url": "https://api.github.com/users/igorlfs/received_events",
                "repos_url": "https://api.github.com/users/igorlfs/repos",
                "site_admin": false,
                "starred_url": "https://api.github.com/users/igorlfs/starred{/owner}{/repo}",
                "subscriptions_url": "https://api.github.com/users/igorlfs/subscriptions",
                "type": "User",
                "url": "https://api.github.com/users/igorlfs",
                "user_view_type": "public"
            }
        },
        {
            "author_association": "CONTRIBUTOR",
            "body": "Unfortunately, it does not address the second error either, but I think that's a [bug](https://github.com/neovim/neovim/pull/37454/changes#r2796139749).",
            "created_at": "2026-02-12T00:06:19Z",
            "html_url": "https://github.com/neovim/neovim/issues/37814#issuecomment-3887905021",
            "id": 3887905021,
            "issue_url": "https://api.github.com/repos/neovim/neovim/issues/37814",
            "node_id": "IC_kwDOAPphoM7nvLj9",
            "performed_via_github_app": null,
            "pin": null,
            "reactions": {
                "+1": 2,
                "-1": 0,
                "confused": 0,
                "eyes": 0,
                "heart": 0,
                "hooray": 0,
                "laugh": 0,
                "rocket": 0,
                "total_count": 2,
                "url": "https://api.github.com/repos/neovim/neovim/issues/comments/3887905021/reactions"
            },
            "updated_at": "2026-02-12T00:06:19Z",
            "url": "https://api.github.com/repos/neovim/neovim/issues/comments/3887905021",
            "user": {
                "avatar_url": "https://avatars.githubusercontent.com/u/84649544?v=4",
                "events_url": "https://api.github.com/users/igorlfs/events{/privacy}",
                "followers_url": "https://api.github.com/users/igorlfs/followers",
                "following_url": "https://api.github.com/users/igorlfs/following{/other_user}",
                "gists_url": "https://api.github.com/users/igorlfs/gists{/gist_id}",
                "gravatar_id": "",
                "html_url": "https://github.com/igorlfs",
                "id": 84649544,
                "login": "igorlfs",
                "node_id": "MDQ6VXNlcjg0NjQ5NTQ0",
                "organizations_url": "https://api.github.com/users/igorlfs/orgs",
                "received_events_url": "https://api.github.com/users/igorlfs/received_events",
                "repos_url": "https://api.github.com/users/igorlfs/repos",
                "site_admin": false,
                "starred_url": "https://api.github.com/users/igorlfs/starred{/owner}{/repo}",
                "subscriptions_url": "https://api.github.com/users/igorlfs/subscriptions",
                "type": "User",
                "url": "https://api.github.com/users/igorlfs",
                "user_view_type": "public"
            }
        },
        {
            "author_association": "MEMBER",
            "body": "Any chance you want to take over https://github.com/neovim/neovim/pull/37454 :)",
            "created_at": "2026-02-12T10:04:35Z",
            "html_url": "https://github.com/neovim/neovim/issues/37814#issuecomment-3889910559",
            "id": 3889910559,
            "issue_url": "https://api.github.com/repos/neovim/neovim/issues/37814",
            "node_id": "IC_kwDOAPphoM7n21Mf",
            "performed_via_github_app": null,
            "pin": null,
            "reactions": {
                "+1": 0,
                "-1": 0,
                "confused": 0,
                "eyes": 0,
                "heart": 0,
                "hooray": 0,
                "laugh": 0,
                "rocket": 0,
                "total_count": 0,
                "url": "https://api.github.com/repos/neovim/neovim/issues/comments/3889910559/reactions"
            },
            "updated_at": "2026-02-12T10:04:35Z",
            "url": "https://api.github.com/repos/neovim/neovim/issues/comments/3889910559",
            "user": {
                "avatar_url": "https://avatars.githubusercontent.com/u/1359421?v=4",
                "events_url": "https://api.github.com/users/justinmk/events{/privacy}",
                "followers_url": "https://api.github.com/users/justinmk/followers",
                "following_url": "https://api.github.com/users/justinmk/following{/other_user}",
                "gists_url": "https://api.github.com/users/justinmk/gists{/gist_id}",
                "gravatar_id": "",
                "html_url": "https://github.com/justinmk",
                "id": 1359421,
                "login": "justinmk",
                "node_id": "MDQ6VXNlcjEzNTk0MjE=",
                "organizations_url": "https://api.github.com/users/justinmk/orgs",
                "received_events_url": "https://api.github.com/users/justinmk/received_events",
                "repos_url": "https://api.github.com/users/justinmk/repos",
                "site_admin": false,
                "starred_url": "https://api.github.com/users/justinmk/starred{/owner}{/repo}",
                "subscriptions_url": "https://api.github.com/users/justinmk/subscriptions",
                "type": "User",
                "url": "https://api.github.com/users/justinmk",
                "user_view_type": "public"
            }
        }
    ],
    "comments": 4,
    "comments_url": "https://api.github.com/repos/neovim/neovim/issues/37814/comments",
    "created_at": "2026-02-11T02:43:07Z",
    "events_url": "https://api.github.com/repos/neovim/neovim/issues/37814/events",
    "html_url": "https://github.com/neovim/neovim/issues/37814",
    "id": 3924441383,
    "issue_dependencies_summary": {
        "blocked_by": 0,
        "blocking": 0,
        "total_blocked_by": 0,
        "total_blocking": 0
    },
    "labels": [
        {
            "color": "c5def5",
            "default": false,
            "description": null,
            "id": 662566370,
            "name": "lsp",
            "node_id": "MDU6TGFiZWw2NjI1NjYzNzA=",
            "url": "https://api.github.com/repos/neovim/neovim/labels/lsp"
        }
    ],
    "labels_url": "https://api.github.com/repos/neovim/neovim/issues/37814/labels{/name}",
    "locked": false,
    "milestone": null,
    "node_id": "I_kwDOAPphoM7p6jkn",
    "number": 37814,
    "performed_via_github_app": null,
    "pinned_comment": null,
    "reactions": {
        "+1": 0,
        "-1": 0,
        "confused": 0,
        "eyes": 0,
        "heart": 0,
        "hooray": 0,
        "laugh": 0,
        "rocket": 0,
        "total_count": 0,
        "url": "https://api.github.com/repos/neovim/neovim/issues/37814/reactions"
    },
    "repository_url": "https://api.github.com/repos/neovim/neovim",
    "state": "open",
    "state_reason": null,
    "sub_issues_summary": {
        "completed": 0,
        "percent_completed": 0,
        "total": 0
    },
    "timeline_url": "https://api.github.com/repos/neovim/neovim/issues/37814/timeline",
    "title": "LSP:  `nil` index in `lsp/_changetracking.lua`",
    "type": {
        "color": "red",
        "created_at": "2024-01-25T10:10:19Z",
        "description": "An unexpected problem or behavior",
        "id": 597163,
        "is_enabled": true,
        "name": "Bug",
        "node_id": "IT_kwDOAGK_Pc4ACRyr",
        "updated_at": "2024-07-26T10:12:30Z"
    },
    "updated_at": "2026-02-12T10:04:35Z",
    "url": "https://api.github.com/repos/neovim/neovim/issues/37814",
    "user": {
        "avatar_url": "https://avatars.githubusercontent.com/u/84649544?v=4",
        "events_url": "https://api.github.com/users/igorlfs/events{/privacy}",
        "followers_url": "https://api.github.com/users/igorlfs/followers",
        "following_url": "https://api.github.com/users/igorlfs/following{/other_user}",
        "gists_url": "https://api.github.com/users/igorlfs/gists{/gist_id}",
        "gravatar_id": "",
        "html_url": "https://github.com/igorlfs",
        "id": 84649544,
        "login": "igorlfs",
        "node_id": "MDQ6VXNlcjg0NjQ5NTQ0",
        "organizations_url": "https://api.github.com/users/igorlfs/orgs",
        "received_events_url": "https://api.github.com/users/igorlfs/received_events",
        "repos_url": "https://api.github.com/users/igorlfs/repos",
        "site_admin": false,
        "starred_url": "https://api.github.com/users/igorlfs/starred{/owner}{/repo}",
        "subscriptions_url": "https://api.github.com/users/igorlfs/subscriptions",
        "type": "User",
        "url": "https://api.github.com/users/igorlfs",
        "user_view_type": "public"
    }
}