{
    "active_lock_reason": null,
    "assignee": null,
    "assignees": [],
    "author_association": "NONE",
    "body": "### Problem\n\nWhen scrolling through a document with concealed lines and 'conceallevel' >= 2 the relative line number can get stuck for the first displayed line after the concealed line. I *think* this is triggered when moving to/from the line above the concealed line. E.g starting from the line above the concealed line all of the following trigger the number to get stuck:\n- Moving up from the line above using \"k\"\n- Jumping down past the concealed line using [count]j\n- Jumping using g/G\nAlso starting anywhere in the document and jumping to the line above the concealed line will not update the line number and the subsequently performing any of the above actions causes it to remain stuck at its current value.\n\n![Image](https://github.com/user-attachments/assets/6974e6e1-baef-43ab-b7ca-a407e5638f65)\n\nIt looks like this is related to #32639\n\nResults of bisecting:\nf58e7d5fac1c4f63f0ba3e59134591239182910e introduced the conceal_lines option and bugs with the relative number setting\n- feat(marks): add conceal_lines to nvim_buf_set_extmark()\n\nf25dd7a8d54844effb44dad60e8154bc8172a67a fixed some of the behaviour but left this bug where the number gets stuck when moving from the line above\n- fix(display): correctly store winline info for concealed lines (#32656)\n\n### Steps to reproduce\n\ninit.lua\n```lua\nvim.o.conceallevel = 2\nvim.o.number = true\nvim.o.relativenumber = true\n\n-- Concealed line below this one\n\n-- Concealed line above: note that number gets stuck when scrolling from below to above\n\nvim.api.nvim_create_autocmd(\"BufEnter\", {\n  callback = function()\n    vim.api.nvim_buf_set_extmark(0, vim.api.nvim_create_namespace(\"test\"), 5, 0, {conceal_lines = \"\"})\n  end,\n})\n```\n- `nvim --clean -u init.lua init.lua`\n- Follow any of the steps above, but minimally hold `j` then hold `k` and observe numbers being wrong.\n\n\n### Expected behavior\n\nNumbers should always be updated even with concealed lines\n\n### Nvim version (nvim -v)\n\nNVIM v0.12.0-dev-249+g43f3c4a48f\n\n### Vim (not Nvim) behaves the same?\n\nassuming not due to concealed lines\n\n### Operating system/version\n\nLinux 6.13.8-arch1-1\n\n### Terminal name/version\n\nalacritty 0.15.1 (0c405d53)\n\n### $TERM environment variable\n\ntmux-256color\n\n### Installation\n\nAUR + build from repo",
    "closed_at": null,
    "closed_by": null,
    "comment_data": [],
    "comments": 0,
    "comments_url": "https://api.github.com/repos/neovim/neovim/issues/33694/comments",
    "created_at": "2025-04-28T14:36:02Z",
    "events_url": "https://api.github.com/repos/neovim/neovim/issues/33694/events",
    "html_url": "https://github.com/neovim/neovim/issues/33694",
    "id": 3025157093,
    "labels": [
        {
            "color": "c5def5",
            "default": false,
            "description": "marks, extmarks, decorations, virtual text",
            "id": 1680119719,
            "name": "marks",
            "node_id": "MDU6TGFiZWwxNjgwMTE5NzE5",
            "url": "https://api.github.com/repos/neovim/neovim/labels/marks"
        },
        {
            "color": "c5def5",
            "default": false,
            "description": "sign/number column",
            "id": 2962322085,
            "name": "column",
            "node_id": "MDU6TGFiZWwyOTYyMzIyMDg1",
            "url": "https://api.github.com/repos/neovim/neovim/labels/column"
        },
        {
            "color": "C5DEF5",
            "default": false,
            "description": "",
            "id": 3385582660,
            "name": "conceal",
            "node_id": "LA_kwDOAPphoM7Jy-RE",
            "url": "https://api.github.com/repos/neovim/neovim/labels/conceal"
        }
    ],
    "labels_url": "https://api.github.com/repos/neovim/neovim/issues/33694/labels{/name}",
    "locked": false,
    "milestone": null,
    "node_id": "I_kwDOAPphoM60UDvl",
    "number": 33694,
    "performed_via_github_app": null,
    "reactions": {
        "+1": 0,
        "-1": 0,
        "confused": 0,
        "eyes": 0,
        "heart": 0,
        "hooray": 0,
        "laugh": 0,
        "rocket": 0,
        "total_count": 0,
        "url": "https://api.github.com/repos/neovim/neovim/issues/33694/reactions"
    },
    "repository_url": "https://api.github.com/repos/neovim/neovim",
    "state": "open",
    "state_reason": null,
    "sub_issues_summary": {
        "completed": 0,
        "percent_completed": 0,
        "total": 0
    },
    "timeline_url": "https://api.github.com/repos/neovim/neovim/issues/33694/timeline",
    "title": "relativenumber stuck with concealed lines",
    "type": {
        "color": "red",
        "created_at": "2024-01-25T10:10:19Z",
        "description": "An unexpected problem or behavior",
        "id": 597163,
        "is_enabled": true,
        "name": "Bug",
        "node_id": "IT_kwDOAGK_Pc4ACRyr",
        "updated_at": "2024-07-26T10:12:30Z"
    },
    "updated_at": "2025-04-29T00:18:44Z",
    "url": "https://api.github.com/repos/neovim/neovim/issues/33694",
    "user": {
        "avatar_url": "https://avatars.githubusercontent.com/u/20502112?v=4",
        "events_url": "https://api.github.com/users/thialfi17/events{/privacy}",
        "followers_url": "https://api.github.com/users/thialfi17/followers",
        "following_url": "https://api.github.com/users/thialfi17/following{/other_user}",
        "gists_url": "https://api.github.com/users/thialfi17/gists{/gist_id}",
        "gravatar_id": "",
        "html_url": "https://github.com/thialfi17",
        "id": 20502112,
        "login": "thialfi17",
        "node_id": "MDQ6VXNlcjIwNTAyMTEy",
        "organizations_url": "https://api.github.com/users/thialfi17/orgs",
        "received_events_url": "https://api.github.com/users/thialfi17/received_events",
        "repos_url": "https://api.github.com/users/thialfi17/repos",
        "site_admin": false,
        "starred_url": "https://api.github.com/users/thialfi17/starred{/owner}{/repo}",
        "subscriptions_url": "https://api.github.com/users/thialfi17/subscriptions",
        "type": "User",
        "url": "https://api.github.com/users/thialfi17",
        "user_view_type": "public"
    }
}