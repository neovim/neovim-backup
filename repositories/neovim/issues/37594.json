{
    "active_lock_reason": null,
    "assignee": null,
    "assignees": [],
    "author_association": "NONE",
    "body": "### Problem\n\nPackChanged is not triggered after manual deletion\n\n### Steps to reproduce\n\nprepare `~/.config/nvim-repro/init.lua`:\n\n```\nvim.pack.add({\n\t\"https://github.com/nvim-mini/mini.align\",\n})\n\nvim.api.nvim_create_autocmd(\"PackChanged\", {\n\tcallback = function(ev)\n\t\tvim.print(ev)\n\tend,\n})\n\nvim.pack.add({\n\t\"https://github.com/nvim-mini/mini.ai\",\n})\n```\n\n1. `NVIM_APPNAME=nvim-repro nvim`\n2. autocmd is triggered\n3. manually delete `~/.local/share/nvim-repro/site/pack/core/opt/mini.ai`\n4. `NVIM_APPNAME=nvim-repro nvim` (restart nvim)\n5. autocmd is not triggered\n\n### Expected behavior\n\nsince mini.ai got reinstalled, the autocmd should be triggered at step 5\n\n### Nvim version (nvim -v)\n\nNVIM v0.12.0-dev-2032+gdddc359213\n\n### Vim (not Nvim) behaves the same?\n\nn/a\n\n### Operating system/version\n\n6.18.6-arch1-1\n\n### Terminal name/version\n\nst 0.8.5\n\n### $TERM environment variable\n\nst-256color\n\n### Installation\n\naur",
    "closed_at": "2026-01-28T19:35:13Z",
    "closed_by": {
        "avatar_url": "https://avatars.githubusercontent.com/u/24854248?v=4",
        "events_url": "https://api.github.com/users/echasnovski/events{/privacy}",
        "followers_url": "https://api.github.com/users/echasnovski/followers",
        "following_url": "https://api.github.com/users/echasnovski/following{/other_user}",
        "gists_url": "https://api.github.com/users/echasnovski/gists{/gist_id}",
        "gravatar_id": "",
        "html_url": "https://github.com/echasnovski",
        "id": 24854248,
        "login": "echasnovski",
        "node_id": "MDQ6VXNlcjI0ODU0MjQ4",
        "organizations_url": "https://api.github.com/users/echasnovski/orgs",
        "received_events_url": "https://api.github.com/users/echasnovski/received_events",
        "repos_url": "https://api.github.com/users/echasnovski/repos",
        "site_admin": false,
        "starred_url": "https://api.github.com/users/echasnovski/starred{/owner}{/repo}",
        "subscriptions_url": "https://api.github.com/users/echasnovski/subscriptions",
        "type": "User",
        "url": "https://api.github.com/users/echasnovski",
        "user_view_type": "public"
    },
    "comment_data": [
        {
            "author_association": "MEMBER",
            "body": "> manually delete `~/.local/share/nvim-repro/site/pack/core/opt/mini.ai`\n\nThis is not supported in general, though vim.pack does attempt to fix/repair such cases. But I would not expected events to be part of that.",
            "created_at": "2026-01-28T10:41:34Z",
            "html_url": "https://github.com/neovim/neovim/issues/37594#issuecomment-3810527950",
            "id": 3810527950,
            "issue_url": "https://api.github.com/repos/neovim/neovim/issues/37594",
            "node_id": "IC_kwDOAPphoM7jIArO",
            "performed_via_github_app": null,
            "reactions": {
                "+1": 0,
                "-1": 0,
                "confused": 0,
                "eyes": 1,
                "heart": 0,
                "hooray": 0,
                "laugh": 0,
                "rocket": 0,
                "total_count": 1,
                "url": "https://api.github.com/repos/neovim/neovim/issues/comments/3810527950/reactions"
            },
            "updated_at": "2026-01-28T10:41:34Z",
            "url": "https://api.github.com/repos/neovim/neovim/issues/comments/3810527950",
            "user": {
                "avatar_url": "https://avatars.githubusercontent.com/u/1359421?v=4",
                "events_url": "https://api.github.com/users/justinmk/events{/privacy}",
                "followers_url": "https://api.github.com/users/justinmk/followers",
                "following_url": "https://api.github.com/users/justinmk/following{/other_user}",
                "gists_url": "https://api.github.com/users/justinmk/gists{/gist_id}",
                "gravatar_id": "",
                "html_url": "https://github.com/justinmk",
                "id": 1359421,
                "login": "justinmk",
                "node_id": "MDQ6VXNlcjEzNTk0MjE=",
                "organizations_url": "https://api.github.com/users/justinmk/orgs",
                "received_events_url": "https://api.github.com/users/justinmk/received_events",
                "repos_url": "https://api.github.com/users/justinmk/repos",
                "site_admin": false,
                "starred_url": "https://api.github.com/users/justinmk/starred{/owner}{/repo}",
                "subscriptions_url": "https://api.github.com/users/justinmk/subscriptions",
                "type": "User",
                "url": "https://api.github.com/users/justinmk",
                "user_view_type": "public"
            }
        },
        {
            "author_association": "MEMBER",
            "body": "Yes, how to delete a plugin is [described in the documentation](https://github.com/neovim/neovim/blob/41336a35905b4c17978de4bb3be7ba82eb0214b5/runtime/doc/pack.txt#L341-L351). All plugins in the '~/.local/share/nvim-repro/site/pack/core/opt' directory [are assumed to be managed by `vim.pack`](https://github.com/neovim/neovim/blob/41336a35905b4c17978de4bb3be7ba82eb0214b5/runtime/doc/pack.txt#L217-L218) and manually deleting a plugin directory does not comply with that.\n\nAlso, I think treating `PackChanged` as events that are triggered as a result of `vim.pack` operation is reasonable. So I'd say the described behavior is expected.",
            "created_at": "2026-01-28T19:35:13Z",
            "html_url": "https://github.com/neovim/neovim/issues/37594#issuecomment-3813458809",
            "id": 3813458809,
            "issue_url": "https://api.github.com/repos/neovim/neovim/issues/37594",
            "node_id": "IC_kwDOAPphoM7jTMN5",
            "performed_via_github_app": null,
            "reactions": {
                "+1": 0,
                "-1": 0,
                "confused": 0,
                "eyes": 0,
                "heart": 0,
                "hooray": 0,
                "laugh": 0,
                "rocket": 0,
                "total_count": 0,
                "url": "https://api.github.com/repos/neovim/neovim/issues/comments/3813458809/reactions"
            },
            "updated_at": "2026-01-28T19:35:13Z",
            "url": "https://api.github.com/repos/neovim/neovim/issues/comments/3813458809",
            "user": {
                "avatar_url": "https://avatars.githubusercontent.com/u/24854248?v=4",
                "events_url": "https://api.github.com/users/echasnovski/events{/privacy}",
                "followers_url": "https://api.github.com/users/echasnovski/followers",
                "following_url": "https://api.github.com/users/echasnovski/following{/other_user}",
                "gists_url": "https://api.github.com/users/echasnovski/gists{/gist_id}",
                "gravatar_id": "",
                "html_url": "https://github.com/echasnovski",
                "id": 24854248,
                "login": "echasnovski",
                "node_id": "MDQ6VXNlcjI0ODU0MjQ4",
                "organizations_url": "https://api.github.com/users/echasnovski/orgs",
                "received_events_url": "https://api.github.com/users/echasnovski/received_events",
                "repos_url": "https://api.github.com/users/echasnovski/repos",
                "site_admin": false,
                "starred_url": "https://api.github.com/users/echasnovski/starred{/owner}{/repo}",
                "subscriptions_url": "https://api.github.com/users/echasnovski/subscriptions",
                "type": "User",
                "url": "https://api.github.com/users/echasnovski",
                "user_view_type": "public"
            }
        },
        {
            "author_association": "NONE",
            "body": "> Also, I think treating PackChanged as events that are triggered as a result of vim.pack operation is reasonable. So I'd say the described behavior is expected.\n\nI’m confused about the logic here. I’m not saying that manual deletion itself should trigger PackChanged. What I mean is that after manually deleting the plugin and restarting Neovim, calling vim.pack.add should trigger PackChanged.\n\nIn this case, there is a vim.pack.add operation, but the corresponding PackChanged event is not triggered.\n\n---\n\nAdditionally, what confuses me is that if init.lua is like this:\n\n```lua\nvim.api.nvim_create_autocmd(\"PackChanged\", {\n\tcallback = function(ev)\n\t\tvim.print(ev)\n\tend,\n})\n\nvim.pack.add({\n\t\"https://github.com/nvim-mini/mini.ai\",\n})\n```\n\nthen, following the steps above, this autocmd does get triggered in step 5\n\n---\n\nAdditionally, although manual deletion is not within the design goals of vim.pack, there is another documented behavior that is very similar to this case:\n\n[Synchronize config across machines](https://github.com/neovim/neovim/blob/41336a35905b4c17978de4bb3be7ba82eb0214b5/runtime/doc/pack.txt#L327)\n\nSo the steps to reproduce are\n\nprepare `~/.config/nvim-repro/init.lua`:\n\n```\nvim.pack.add({\n\t\"https://github.com/nvim-mini/mini.align\",\n})\n\nvim.api.nvim_create_autocmd(\"PackChanged\", {\n\tcallback = function(ev)\n\t\tvim.print(ev)\n\tend,\n})\n\nvim.pack.add({\n\t\"https://github.com/nvim-mini/mini.ai\",\n})\n```\n\n1. `NVIM_APPNAME=nvim-repro nvim`\n2. autocmd is triggered\n3. manually delete ~/.local/share/nvim-repro/site/pack/core/opt/mini.ai\nto simulate the case where a secondary machine has the same init.lua and nvim-pack-lock.json, but a different set of plugins on disk\n5. |:restart|. New plugins (not present locally, but present in the lockfile)\n    are installed at proper revision.\n6. `vim.pack.update(nil, { target = 'lockfile' })`. Read and confirm.\n7. the autocmd is still not triggered. consequently, any build steps in the autocmd are skipped on the secondary machine",
            "created_at": "2026-01-29T03:14:07Z",
            "html_url": "https://github.com/neovim/neovim/issues/37594#issuecomment-3815205325",
            "id": 3815205325,
            "issue_url": "https://api.github.com/repos/neovim/neovim/issues/37594",
            "node_id": "IC_kwDOAPphoM7jZ2nN",
            "performed_via_github_app": null,
            "reactions": {
                "+1": 0,
                "-1": 0,
                "confused": 0,
                "eyes": 0,
                "heart": 0,
                "hooray": 0,
                "laugh": 0,
                "rocket": 0,
                "total_count": 0,
                "url": "https://api.github.com/repos/neovim/neovim/issues/comments/3815205325/reactions"
            },
            "updated_at": "2026-01-29T03:36:37Z",
            "url": "https://api.github.com/repos/neovim/neovim/issues/comments/3815205325",
            "user": {
                "avatar_url": "https://avatars.githubusercontent.com/u/97080720?v=4",
                "events_url": "https://api.github.com/users/aidancz/events{/privacy}",
                "followers_url": "https://api.github.com/users/aidancz/followers",
                "following_url": "https://api.github.com/users/aidancz/following{/other_user}",
                "gists_url": "https://api.github.com/users/aidancz/gists{/gist_id}",
                "gravatar_id": "",
                "html_url": "https://github.com/aidancz",
                "id": 97080720,
                "login": "aidancz",
                "node_id": "U_kgDOBclVkA",
                "organizations_url": "https://api.github.com/users/aidancz/orgs",
                "received_events_url": "https://api.github.com/users/aidancz/received_events",
                "repos_url": "https://api.github.com/users/aidancz/repos",
                "site_admin": false,
                "starred_url": "https://api.github.com/users/aidancz/starred{/owner}{/repo}",
                "subscriptions_url": "https://api.github.com/users/aidancz/subscriptions",
                "type": "User",
                "url": "https://api.github.com/users/aidancz",
                "user_view_type": "public"
            }
        },
        {
            "author_association": "MEMBER",
            "body": "> I’m confused about the logic here. I’m not saying that manual deletion itself should trigger PackChanged. What I mean is that after manually deleting the plugin and restarting Neovim, calling vim.pack.add should trigger PackChanged.\n> \n> In this case, there is a vim.pack.add operation, but the corresponding PackChanged event is not triggered.\n\nI think the part of misunderstanding here is that we are talking about different kinds of `PackChanged` events.\n\nThe `PackChanged kind=delete` will be triggered if `vim.pack` itself deletes a plugin. Which is *the only way* a plugin should be deleted and it should not be expected to trigger after manual deletion.\n\nCalling `vim.pack.add` can trigger `PackChanged kind=install` if it installs a plugin. I.e. it was not on disk but user intends it to be; whether via explicit `vim.pack.add(...)` or via lockfile entry.\n\n> Additionally, what confuses me is that if init.lua is like this:\n> ...\n> then, following the steps above, this autocmd does get triggered in step 5\n> ...\n> Additionally, although manual deletion is not within the design goals of vim.pack, there is another documented behavior that is very similar to this case:\n\nI see the confusion now. `PackChanged kind=install` does get triggered in every case: in original comment, the one without adding 'mini.align', and the \"sync across machines\". The difference is that installing plugins based on the lockfile (and not on `vim.pack.add()`) is done for [\"all plugins ... at once ...\"](https://github.com/neovim/neovim/blob/41336a35905b4c17978de4bb3be7ba82eb0214b5/runtime/doc/pack.txt#L227-L229). Technically it means running on the *first time lockfile data is needed*, which is calling any of `vim.pack` functions. So here `PackChanged kind=install` is run inside first `vim.pack.add()`, which is for 'mini.align' and before an autocommand for any `PackChanged` is created.\n\nThe \"install on first call\" is needed to always have lockfile be in sync with what is happening on the disk. It looks like at least this behavior needs to be documented better.\n\nAs per \"... any build steps in the autocmd are skipped on the secondary machine\", this indeed is not pretty but is technically a result of how the config is structured. Creating an autocommand for `PackChanged` event before any `vim.pack.add()` will address the issue. The more \"to the point\" solution here is planned via #34778: lifting the burden from users to define build steps and placing it onto plugin developers.",
            "created_at": "2026-01-29T10:21:23Z",
            "html_url": "https://github.com/neovim/neovim/issues/37594#issuecomment-3816755451",
            "id": 3816755451,
            "issue_url": "https://api.github.com/repos/neovim/neovim/issues/37594",
            "node_id": "IC_kwDOAPphoM7jfxD7",
            "performed_via_github_app": null,
            "reactions": {
                "+1": 1,
                "-1": 0,
                "confused": 0,
                "eyes": 0,
                "heart": 1,
                "hooray": 0,
                "laugh": 0,
                "rocket": 0,
                "total_count": 2,
                "url": "https://api.github.com/repos/neovim/neovim/issues/comments/3816755451/reactions"
            },
            "updated_at": "2026-01-29T10:21:23Z",
            "url": "https://api.github.com/repos/neovim/neovim/issues/comments/3816755451",
            "user": {
                "avatar_url": "https://avatars.githubusercontent.com/u/24854248?v=4",
                "events_url": "https://api.github.com/users/echasnovski/events{/privacy}",
                "followers_url": "https://api.github.com/users/echasnovski/followers",
                "following_url": "https://api.github.com/users/echasnovski/following{/other_user}",
                "gists_url": "https://api.github.com/users/echasnovski/gists{/gist_id}",
                "gravatar_id": "",
                "html_url": "https://github.com/echasnovski",
                "id": 24854248,
                "login": "echasnovski",
                "node_id": "MDQ6VXNlcjI0ODU0MjQ4",
                "organizations_url": "https://api.github.com/users/echasnovski/orgs",
                "received_events_url": "https://api.github.com/users/echasnovski/received_events",
                "repos_url": "https://api.github.com/users/echasnovski/repos",
                "site_admin": false,
                "starred_url": "https://api.github.com/users/echasnovski/starred{/owner}{/repo}",
                "subscriptions_url": "https://api.github.com/users/echasnovski/subscriptions",
                "type": "User",
                "url": "https://api.github.com/users/echasnovski",
                "user_view_type": "public"
            }
        },
        {
            "author_association": "NONE",
            "body": "I think I understand the current behavior now.\n\nThank you for your patience in explaining it, and for the excellent work on `vim.pack`!",
            "created_at": "2026-01-29T10:45:39Z",
            "html_url": "https://github.com/neovim/neovim/issues/37594#issuecomment-3816878113",
            "id": 3816878113,
            "issue_url": "https://api.github.com/repos/neovim/neovim/issues/37594",
            "node_id": "IC_kwDOAPphoM7jgPAh",
            "performed_via_github_app": null,
            "reactions": {
                "+1": 0,
                "-1": 0,
                "confused": 0,
                "eyes": 0,
                "heart": 1,
                "hooray": 0,
                "laugh": 0,
                "rocket": 0,
                "total_count": 1,
                "url": "https://api.github.com/repos/neovim/neovim/issues/comments/3816878113/reactions"
            },
            "updated_at": "2026-01-29T10:45:39Z",
            "url": "https://api.github.com/repos/neovim/neovim/issues/comments/3816878113",
            "user": {
                "avatar_url": "https://avatars.githubusercontent.com/u/97080720?v=4",
                "events_url": "https://api.github.com/users/aidancz/events{/privacy}",
                "followers_url": "https://api.github.com/users/aidancz/followers",
                "following_url": "https://api.github.com/users/aidancz/following{/other_user}",
                "gists_url": "https://api.github.com/users/aidancz/gists{/gist_id}",
                "gravatar_id": "",
                "html_url": "https://github.com/aidancz",
                "id": 97080720,
                "login": "aidancz",
                "node_id": "U_kgDOBclVkA",
                "organizations_url": "https://api.github.com/users/aidancz/orgs",
                "received_events_url": "https://api.github.com/users/aidancz/received_events",
                "repos_url": "https://api.github.com/users/aidancz/repos",
                "site_admin": false,
                "starred_url": "https://api.github.com/users/aidancz/starred{/owner}{/repo}",
                "subscriptions_url": "https://api.github.com/users/aidancz/subscriptions",
                "type": "User",
                "url": "https://api.github.com/users/aidancz",
                "user_view_type": "public"
            }
        }
    ],
    "comments": 5,
    "comments_url": "https://api.github.com/repos/neovim/neovim/issues/37594/comments",
    "created_at": "2026-01-28T02:54:46Z",
    "events_url": "https://api.github.com/repos/neovim/neovim/issues/37594/events",
    "html_url": "https://github.com/neovim/neovim/issues/37594",
    "id": 3863299427,
    "issue_dependencies_summary": {
        "blocked_by": 0,
        "blocking": 0,
        "total_blocked_by": 0,
        "total_blocking": 0
    },
    "labels": [
        {
            "color": "e6e6e6",
            "default": false,
            "description": "current behavior is by design, and change is not desired",
            "id": 77997479,
            "name": "closed:wontfix",
            "node_id": "MDU6TGFiZWw3Nzk5NzQ3OQ==",
            "url": "https://api.github.com/repos/neovim/neovim/labels/closed:wontfix"
        },
        {
            "color": "FBCA04",
            "default": false,
            "description": "issue needs attention from an expert, or PR proposes significant changes to architecture or API",
            "id": 212680983,
            "name": "needs:discussion",
            "node_id": "MDU6TGFiZWwyMTI2ODA5ODM=",
            "url": "https://api.github.com/repos/neovim/neovim/labels/needs:discussion"
        },
        {
            "color": "bfd4f2",
            "default": false,
            "description": "vim.pack, start/opt packages, 'packpath'",
            "id": 8889050758,
            "name": "packages",
            "node_id": "LA_kwDOAPphoM8AAAACEdQmhg",
            "url": "https://api.github.com/repos/neovim/neovim/labels/packages"
        }
    ],
    "labels_url": "https://api.github.com/repos/neovim/neovim/issues/37594/labels{/name}",
    "locked": false,
    "milestone": null,
    "node_id": "I_kwDOAPphoM7mRUVj",
    "number": 37594,
    "performed_via_github_app": null,
    "reactions": {
        "+1": 0,
        "-1": 0,
        "confused": 0,
        "eyes": 0,
        "heart": 0,
        "hooray": 0,
        "laugh": 0,
        "rocket": 0,
        "total_count": 0,
        "url": "https://api.github.com/repos/neovim/neovim/issues/37594/reactions"
    },
    "repository_url": "https://api.github.com/repos/neovim/neovim",
    "state": "closed",
    "state_reason": "completed",
    "sub_issues_summary": {
        "completed": 0,
        "percent_completed": 0,
        "total": 0
    },
    "timeline_url": "https://api.github.com/repos/neovim/neovim/issues/37594/timeline",
    "title": "vim.pack PackChanged is not triggered after manual deletion",
    "type": {
        "color": "red",
        "created_at": "2024-01-25T10:10:19Z",
        "description": "An unexpected problem or behavior",
        "id": 597163,
        "is_enabled": true,
        "name": "Bug",
        "node_id": "IT_kwDOAGK_Pc4ACRyr",
        "updated_at": "2024-07-26T10:12:30Z"
    },
    "updated_at": "2026-01-29T10:45:39Z",
    "url": "https://api.github.com/repos/neovim/neovim/issues/37594",
    "user": {
        "avatar_url": "https://avatars.githubusercontent.com/u/97080720?v=4",
        "events_url": "https://api.github.com/users/aidancz/events{/privacy}",
        "followers_url": "https://api.github.com/users/aidancz/followers",
        "following_url": "https://api.github.com/users/aidancz/following{/other_user}",
        "gists_url": "https://api.github.com/users/aidancz/gists{/gist_id}",
        "gravatar_id": "",
        "html_url": "https://github.com/aidancz",
        "id": 97080720,
        "login": "aidancz",
        "node_id": "U_kgDOBclVkA",
        "organizations_url": "https://api.github.com/users/aidancz/orgs",
        "received_events_url": "https://api.github.com/users/aidancz/received_events",
        "repos_url": "https://api.github.com/users/aidancz/repos",
        "site_admin": false,
        "starred_url": "https://api.github.com/users/aidancz/starred{/owner}{/repo}",
        "subscriptions_url": "https://api.github.com/users/aidancz/subscriptions",
        "type": "User",
        "url": "https://api.github.com/users/aidancz",
        "user_view_type": "public"
    }
}