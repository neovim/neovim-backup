{
    "active_lock_reason": null,
    "assignee": null,
    "assignees": [],
    "author_association": "NONE",
    "body": "### Neovim version (nvim -v)\n\nNVIM v0.7.0-dev+1233-gabbc9148d\n\n### Vim (not Nvim) behaves the same?\n\nyes\n\n### Operating system/version\n\nlinux\n\n### Terminal name/version\n\nalacritty\n\n### $TERM environment variable\n\nxterm-256color\n\n### Installation\n\nbuild from repo\n\n### How to reproduce the issue\n\nnvim file\r\nfile:\r\n```txt\r\n{  }\r\n   x (pos1)\r\n{  }\r\n   x (pos2)\r\n```\r\nCursor position is at x (first example)\r\n:call searchpos('{', 'bz', 1)\r\npos1: no match\r\npos2: match\r\n:call searchpos('{', 'bz', 1)\r\n\r\n1. bug does move to wrong position (one line upwards) or not at all\r\n2. with 'n' and at least in lua does fail, if not at least row-1 is used (resulting in 0 or any match for line=1)\r\nThis requires then additional quirky checks, ie with\r\n```lua\r\n  if (srow == 0 and scol == 0 and backwards == true) or srow ~= crow\r\n    or (backwards == true and ccol < scol) then\r\n    print 'no matching backwards character'\r\n    return\r\n  end\r\n```\n\n### Expected behavior\n\n1. correct stopline logic (end of line for forward and begin of line for backwards)\r\n2. correct cursor movement (no jumping over result, though I did not test the vimscript result for 'nbz')\n\n### Actual behavior\n\n1. stopline logic is broken for backwards movements\r\n2. jumping over result for 'bz'",
    "closed_at": null,
    "closed_by": null,
    "comment_data": [
        {
            "author_association": "NONE",
            "body": "Will apply the patch at vim to upstream the fix.\r\n\r\nIn case anyone interested, the whole indexing behavior is quirky with different offsets based on forwards or backward search:\r\n```lua\r\n_G.CopyMatchingChar = function(backwards, register)\r\n  local tup_rowcol = vim.api.nvim_win_get_cursor(0) -- [1],[2] = y,x = row,col\r\n  local crow = tup_rowcol[1]\r\n  local ccol = tup_rowcol[2] -- 0 indexed => use +1\r\n  local cchar = vim.api.nvim_get_current_line():sub(ccol+1, ccol+1)\r\n  local matchchar = {\r\n    ['('] = ')',\r\n    [')'] = '(',\r\n    ['{'] = '}',\r\n    ['}'] = '{',\r\n    ['['] = ']',\r\n    [']'] = '[',\r\n    [\"<\"] = \">\",\r\n    [\">\"] = \"<\",\r\n    ['\"'] = '\"',\r\n    [\"'\"] = \"'\",\r\n    [\"|\"] = \"|\",\r\n    ['`'] = '`',\r\n    ['/'] = '/',\r\n    ['\\\\'] = '\\\\',\r\n  }\r\n  -- TODO searchpos: stopline only works forwards\r\n  -- => flag 'b' is not using starting line\r\n  local tup_search\r\n  if backwards == false then\r\n    tup_search = vim.fn.searchpos(matchchar[cchar], 'nz', crow+1) -- +1 to search until next line?\r\n  else\r\n    tup_search = vim.fn.searchpos(matchchar[cchar], 'bnz') -- +1 to search until next line?\r\n  end\r\n  local srow = tup_search[1]\r\n  local scol = tup_search[2]\r\n  if srow == 0 and scol == 0 and backwards == false then\r\n    print 'no matching forward character'\r\n    return\r\n  end\r\n  if (srow == 0 and scol == 0 and backwards == true) or srow ~= crow\r\n    or (backwards == true and ccol < scol) then\r\n    print 'no matching backwards character'\r\n    return\r\n  end\r\n  local copytext\r\n  if backwards == false then\r\n    copytext = vim.api.nvim_get_current_line():sub(ccol+1, scol)\r\n    print(string.format([[%s %s:%s]], [[write -> into]], register, copytext))\r\n  else\r\n    copytext = vim.api.nvim_get_current_line():sub(scol, ccol+1)\r\n    print(string.format([[%s %s:%s]], [[write <- into]], register, copytext))\r\n  end\r\n  vim.fn.setreg(register, copytext)\r\nend\r\n---- copy forward/backwards until first occurence of same symbol\r\nmap('n', '-', ':lua CopyMatchingChar(false, [[\"\"]])<CR>', opts)\r\nmap('n', '_', ':lua CopyMatchingChar(true, [[\"\"]])<CR>', opts)\r\n```",
            "created_at": "2022-03-12T02:39:49Z",
            "html_url": "https://github.com/neovim/neovim/issues/17686#issuecomment-1065795009",
            "id": 1065795009,
            "issue_url": "https://api.github.com/repos/neovim/neovim/issues/17686",
            "node_id": "IC_kwDOAPphoM4_hr3B",
            "performed_via_github_app": null,
            "reactions": {
                "+1": 0,
                "-1": 0,
                "confused": 0,
                "eyes": 0,
                "heart": 0,
                "hooray": 0,
                "laugh": 0,
                "rocket": 0,
                "total_count": 0,
                "url": "https://api.github.com/repos/neovim/neovim/issues/comments/1065795009/reactions"
            },
            "updated_at": "2022-03-12T02:42:14Z",
            "url": "https://api.github.com/repos/neovim/neovim/issues/comments/1065795009",
            "user": {
                "avatar_url": "https://avatars.githubusercontent.com/u/13089667?v=4",
                "events_url": "https://api.github.com/users/matu3ba/events{/privacy}",
                "followers_url": "https://api.github.com/users/matu3ba/followers",
                "following_url": "https://api.github.com/users/matu3ba/following{/other_user}",
                "gists_url": "https://api.github.com/users/matu3ba/gists{/gist_id}",
                "gravatar_id": "",
                "html_url": "https://github.com/matu3ba",
                "id": 13089667,
                "login": "matu3ba",
                "node_id": "MDQ6VXNlcjEzMDg5NjY3",
                "organizations_url": "https://api.github.com/users/matu3ba/orgs",
                "received_events_url": "https://api.github.com/users/matu3ba/received_events",
                "repos_url": "https://api.github.com/users/matu3ba/repos",
                "site_admin": false,
                "starred_url": "https://api.github.com/users/matu3ba/starred{/owner}{/repo}",
                "subscriptions_url": "https://api.github.com/users/matu3ba/subscriptions",
                "type": "User",
                "url": "https://api.github.com/users/matu3ba",
                "user_view_type": "public"
            }
        },
        {
            "author_association": "MEMBER",
            "body": "Hmm, I cannot reproduce. Or maybe I didn't fully understand the steps to reproduce?",
            "created_at": "2022-06-25T09:31:19Z",
            "html_url": "https://github.com/neovim/neovim/issues/17686#issuecomment-1166240519",
            "id": 1166240519,
            "issue_url": "https://api.github.com/repos/neovim/neovim/issues/17686",
            "node_id": "IC_kwDOAPphoM5Fg2sH",
            "performed_via_github_app": null,
            "reactions": {
                "+1": 0,
                "-1": 0,
                "confused": 0,
                "eyes": 0,
                "heart": 0,
                "hooray": 0,
                "laugh": 0,
                "rocket": 0,
                "total_count": 0,
                "url": "https://api.github.com/repos/neovim/neovim/issues/comments/1166240519/reactions"
            },
            "updated_at": "2022-06-25T09:31:19Z",
            "url": "https://api.github.com/repos/neovim/neovim/issues/comments/1166240519",
            "user": {
                "avatar_url": "https://avatars.githubusercontent.com/u/35768171?v=4",
                "events_url": "https://api.github.com/users/zeertzjq/events{/privacy}",
                "followers_url": "https://api.github.com/users/zeertzjq/followers",
                "following_url": "https://api.github.com/users/zeertzjq/following{/other_user}",
                "gists_url": "https://api.github.com/users/zeertzjq/gists{/gist_id}",
                "gravatar_id": "",
                "html_url": "https://github.com/zeertzjq",
                "id": 35768171,
                "login": "zeertzjq",
                "node_id": "MDQ6VXNlcjM1NzY4MTcx",
                "organizations_url": "https://api.github.com/users/zeertzjq/orgs",
                "received_events_url": "https://api.github.com/users/zeertzjq/received_events",
                "repos_url": "https://api.github.com/users/zeertzjq/repos",
                "site_admin": false,
                "starred_url": "https://api.github.com/users/zeertzjq/starred{/owner}{/repo}",
                "subscriptions_url": "https://api.github.com/users/zeertzjq/subscriptions",
                "type": "User",
                "url": "https://api.github.com/users/zeertzjq",
                "user_view_type": "public"
            }
        },
        {
            "author_association": "NONE",
            "body": "1. Make a file with content (line numbers are here additionally shown on the left side) and make sure the x for the cursor position are not in the file.\r\n```txt\r\n1 {  }\r\n     x (pos1)\r\n2 {  }\r\n     x (pos2)\r\n```\r\n2. run `:call searchpos('{', 'bz', 1)` with cursor on `pos1` as shown with the `x` to search backwards the opening bracket `{` from the closing bracket `}`\r\n3. run `:call searchpos('{', 'bz', 1)` with cursor on `pos2` as shown with the `x` to do the same in line 2\r\n\r\nQuestion for you:\r\n1. Why does the cursor jump one line upwards from pos2?\r\n2. Why does the cursor not move leftwards on the same line to the `{`?\r\n3. What does happen, if you run `:call searchpos('}', 'z', 1)` to search forward now from line 1 the opening bracket `{` ? What does happen, if you repeat in line 2?",
            "created_at": "2022-06-28T23:20:59Z",
            "html_url": "https://github.com/neovim/neovim/issues/17686#issuecomment-1169380302",
            "id": 1169380302,
            "issue_url": "https://api.github.com/repos/neovim/neovim/issues/17686",
            "node_id": "IC_kwDOAPphoM5Fs1PO",
            "performed_via_github_app": null,
            "reactions": {
                "+1": 0,
                "-1": 0,
                "confused": 0,
                "eyes": 0,
                "heart": 0,
                "hooray": 0,
                "laugh": 0,
                "rocket": 0,
                "total_count": 0,
                "url": "https://api.github.com/repos/neovim/neovim/issues/comments/1169380302/reactions"
            },
            "updated_at": "2022-06-29T00:08:06Z",
            "url": "https://api.github.com/repos/neovim/neovim/issues/comments/1169380302",
            "user": {
                "avatar_url": "https://avatars.githubusercontent.com/u/13089667?v=4",
                "events_url": "https://api.github.com/users/matu3ba/events{/privacy}",
                "followers_url": "https://api.github.com/users/matu3ba/followers",
                "following_url": "https://api.github.com/users/matu3ba/following{/other_user}",
                "gists_url": "https://api.github.com/users/matu3ba/gists{/gist_id}",
                "gravatar_id": "",
                "html_url": "https://github.com/matu3ba",
                "id": 13089667,
                "login": "matu3ba",
                "node_id": "MDQ6VXNlcjEzMDg5NjY3",
                "organizations_url": "https://api.github.com/users/matu3ba/orgs",
                "received_events_url": "https://api.github.com/users/matu3ba/received_events",
                "repos_url": "https://api.github.com/users/matu3ba/repos",
                "site_admin": false,
                "starred_url": "https://api.github.com/users/matu3ba/starred{/owner}{/repo}",
                "subscriptions_url": "https://api.github.com/users/matu3ba/subscriptions",
                "type": "User",
                "url": "https://api.github.com/users/matu3ba",
                "user_view_type": "public"
            }
        },
        {
            "author_association": "MEMBER",
            "body": "Oh, I can finally understand the issue.",
            "created_at": "2022-06-29T00:08:21Z",
            "html_url": "https://github.com/neovim/neovim/issues/17686#issuecomment-1169402184",
            "id": 1169402184,
            "issue_url": "https://api.github.com/repos/neovim/neovim/issues/17686",
            "node_id": "IC_kwDOAPphoM5Fs6lI",
            "performed_via_github_app": null,
            "reactions": {
                "+1": 0,
                "-1": 0,
                "confused": 0,
                "eyes": 0,
                "heart": 0,
                "hooray": 0,
                "laugh": 0,
                "rocket": 0,
                "total_count": 0,
                "url": "https://api.github.com/repos/neovim/neovim/issues/comments/1169402184/reactions"
            },
            "updated_at": "2022-06-29T00:08:21Z",
            "url": "https://api.github.com/repos/neovim/neovim/issues/comments/1169402184",
            "user": {
                "avatar_url": "https://avatars.githubusercontent.com/u/35768171?v=4",
                "events_url": "https://api.github.com/users/zeertzjq/events{/privacy}",
                "followers_url": "https://api.github.com/users/zeertzjq/followers",
                "following_url": "https://api.github.com/users/zeertzjq/following{/other_user}",
                "gists_url": "https://api.github.com/users/zeertzjq/gists{/gist_id}",
                "gravatar_id": "",
                "html_url": "https://github.com/zeertzjq",
                "id": 35768171,
                "login": "zeertzjq",
                "node_id": "MDQ6VXNlcjM1NzY4MTcx",
                "organizations_url": "https://api.github.com/users/zeertzjq/orgs",
                "received_events_url": "https://api.github.com/users/zeertzjq/received_events",
                "repos_url": "https://api.github.com/users/zeertzjq/repos",
                "site_admin": false,
                "starred_url": "https://api.github.com/users/zeertzjq/starred{/owner}{/repo}",
                "subscriptions_url": "https://api.github.com/users/zeertzjq/subscriptions",
                "type": "User",
                "url": "https://api.github.com/users/zeertzjq",
                "user_view_type": "public"
            }
        }
    ],
    "comments": 4,
    "comments_url": "https://api.github.com/repos/neovim/neovim/issues/17686/comments",
    "created_at": "2022-03-12T02:39:07Z",
    "events_url": "https://api.github.com/repos/neovim/neovim/issues/17686/events",
    "html_url": "https://github.com/neovim/neovim/issues/17686",
    "id": 1167152942,
    "labels": [
        {
            "color": "F9D0C4",
            "default": false,
            "description": "wrong behavior inherited from vim",
            "id": 154310492,
            "name": "bug-vim",
            "node_id": "MDU6TGFiZWwxNTQzMTA0OTI=",
            "url": "https://api.github.com/repos/neovim/neovim/labels/bug-vim"
        },
        {
            "color": "FBCA04",
            "default": false,
            "description": "upstream issue that must be fixed in Vim first",
            "id": 2639399975,
            "name": "needs:vim-patch",
            "node_id": "MDU6TGFiZWwyNjM5Mzk5OTc1",
            "url": "https://api.github.com/repos/neovim/neovim/labels/needs:vim-patch"
        }
    ],
    "labels_url": "https://api.github.com/repos/neovim/neovim/issues/17686/labels{/name}",
    "locked": false,
    "milestone": null,
    "node_id": "I_kwDOAPphoM5FkVcu",
    "number": 17686,
    "performed_via_github_app": null,
    "reactions": {
        "+1": 0,
        "-1": 0,
        "confused": 0,
        "eyes": 0,
        "heart": 0,
        "hooray": 0,
        "laugh": 0,
        "rocket": 0,
        "total_count": 0,
        "url": "https://api.github.com/repos/neovim/neovim/issues/17686/reactions"
    },
    "repository_url": "https://api.github.com/repos/neovim/neovim",
    "state": "open",
    "state_reason": null,
    "sub_issues_summary": {
        "completed": 0,
        "percent_completed": 0,
        "total": 0
    },
    "timeline_url": "https://api.github.com/repos/neovim/neovim/issues/17686/timeline",
    "title": "searchpos broken for backwards movements ('bnz' and 'bz')",
    "updated_at": "2025-01-19T11:49:56Z",
    "url": "https://api.github.com/repos/neovim/neovim/issues/17686",
    "user": {
        "avatar_url": "https://avatars.githubusercontent.com/u/13089667?v=4",
        "events_url": "https://api.github.com/users/matu3ba/events{/privacy}",
        "followers_url": "https://api.github.com/users/matu3ba/followers",
        "following_url": "https://api.github.com/users/matu3ba/following{/other_user}",
        "gists_url": "https://api.github.com/users/matu3ba/gists{/gist_id}",
        "gravatar_id": "",
        "html_url": "https://github.com/matu3ba",
        "id": 13089667,
        "login": "matu3ba",
        "node_id": "MDQ6VXNlcjEzMDg5NjY3",
        "organizations_url": "https://api.github.com/users/matu3ba/orgs",
        "received_events_url": "https://api.github.com/users/matu3ba/received_events",
        "repos_url": "https://api.github.com/users/matu3ba/repos",
        "site_admin": false,
        "starred_url": "https://api.github.com/users/matu3ba/starred{/owner}{/repo}",
        "subscriptions_url": "https://api.github.com/users/matu3ba/subscriptions",
        "type": "User",
        "url": "https://api.github.com/users/matu3ba",
        "user_view_type": "public"
    }
}