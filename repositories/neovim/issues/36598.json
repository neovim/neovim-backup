{
    "active_lock_reason": null,
    "assignee": null,
    "assignees": [],
    "author_association": "NONE",
    "body": "### Problem\n\nrunning nvim --embed with or without headless causes it to terminate either immediately or after any writing. I've been trying to figure out how to embed neovim for the last 3 days and everything I have tried from using lua, python, and C++ has failed to work. With only --headless nvim will stay running.\n\nThe docs say that --embed is identical to --cmd \"call stdioopen({'rpc': v:true})\" but\n\n```\nstd::wstring cmd = LR\"(nvim.exe --headless --cmd \\\"call stdioopen({'rpc': v:true})\\\")\";\nbool success = CreateProcessW(NULL, const_cast<wchar_t*>(cmd.c_str()), NULL, NULL, TRUE, 0, NULL, NULL, &si, &pi);\n```\n\ndoes not fail on writing while\n\n```\n    std::wstring cmd = LR\"(nvim.exe --embed --headless )\";\n    bool success = CreateProcessW(NULL, const_cast<wchar_t*>(cmd.c_str()), NULL, NULL, TRUE, 0, NULL, NULL, &si, &pi);\n```\n\nterminates immediately(but success is true). [https://neovim.io/doc/user/starting.html#--embed]\n\n\n\n### Steps to reproduce\n\nTry to use --embed mode. Seems to fail regardless. Usually writing anything to the pipe will cause it to terminate. Again, if the docs are right then there is something wrong with nvim --embed since it is behaving differently than expected.\n\nIf I do call it with nvim.exe --cmd \\\"call stdioopen({'rpc': v:true})\\ without headless then it opens up and immediately closes. If I run it inside nvim then I get E905: Couldn't open stdio channel: channel was already open.\n\nIf I run nvim.exe --embed --headless -cmd \"call stdioopen({'rpc': v:true}) nvim runs and any keyboard input then terminates it(sorta similar to the behavior before).\n\nEither way, the docs are either wrong or there is a bug with embed.\nI'll try to do some further testing to see if everything now starts working but I've been chasing this rabbit for quite some time.\n\n### Expected behavior\n\nFor it to work. I've been trying everything and assumed everything but nvim. Something isn't working. It shouldn't be this difficult. Given that the docs claim that embed is equivalent to sending the cmd and using it instead gives different results suggests there is a bug with --embed. I haven't tested it but I can say that calling nvim_ui_attach doesn't terminate nvim like it was(or anything I'd try to pass to nvim with --embed). \n\n\n\n### Nvim version (nvim -v)\n\nv0.12.0-dev-1387+gf67306cc67\n\n### Vim (not Nvim) behaves the same?\n\nvim doesn't have --embed\n\n### Operating system/version\n\nWin11 24H2\n\n### Terminal name/version\n\nwindows terminal\n\n### $TERM environment variable\n\nnone\n\n### Installation\n\nmanual",
    "closed_at": null,
    "closed_by": null,
    "comment_data": [
        {
            "author_association": "MEMBER",
            "body": "You can't write \"anything\" to the pipe. You need to write valid msgpack RPC.\n\n> Given that the docs claim that embed is equivalent to sending the cmd and using it instead gives different results suggests there is a bug with --embed.\n\nI cannot understand this sentence. Where does the docs claim what?",
            "created_at": "2025-11-18T00:53:19Z",
            "html_url": "https://github.com/neovim/neovim/issues/36598#issuecomment-3544565612",
            "id": 3544565612,
            "issue_url": "https://api.github.com/repos/neovim/neovim/issues/36598",
            "node_id": "IC_kwDOAPphoM7TRcds",
            "performed_via_github_app": null,
            "reactions": {
                "+1": 0,
                "-1": 0,
                "confused": 0,
                "eyes": 0,
                "heart": 0,
                "hooray": 0,
                "laugh": 0,
                "rocket": 0,
                "total_count": 0,
                "url": "https://api.github.com/repos/neovim/neovim/issues/comments/3544565612/reactions"
            },
            "updated_at": "2025-11-18T00:58:05Z",
            "url": "https://api.github.com/repos/neovim/neovim/issues/comments/3544565612",
            "user": {
                "avatar_url": "https://avatars.githubusercontent.com/u/35768171?v=4",
                "events_url": "https://api.github.com/users/zeertzjq/events{/privacy}",
                "followers_url": "https://api.github.com/users/zeertzjq/followers",
                "following_url": "https://api.github.com/users/zeertzjq/following{/other_user}",
                "gists_url": "https://api.github.com/users/zeertzjq/gists{/gist_id}",
                "gravatar_id": "",
                "html_url": "https://github.com/zeertzjq",
                "id": 35768171,
                "login": "zeertzjq",
                "node_id": "MDQ6VXNlcjM1NzY4MTcx",
                "organizations_url": "https://api.github.com/users/zeertzjq/orgs",
                "received_events_url": "https://api.github.com/users/zeertzjq/received_events",
                "repos_url": "https://api.github.com/users/zeertzjq/repos",
                "site_admin": false,
                "starred_url": "https://api.github.com/users/zeertzjq/starred{/owner}{/repo}",
                "subscriptions_url": "https://api.github.com/users/zeertzjq/subscriptions",
                "type": "User",
                "url": "https://api.github.com/users/zeertzjq",
                "user_view_type": "public"
            }
        },
        {
            "author_association": "NONE",
            "body": "> You can't write \"anything\" to the pipe. You need to write valid msgpack RPC.\n> \n> > Given that the docs claim that embed is equivalent to sending the cmd and using it instead gives different results suggests there is a bug with --embed.\n> \n> I cannot understand this sentence. Where does the docs claim what?\n\nObviously. I do not mean write anything arbitrarily.\n\nI posted the link to the docs where they claim that --embed is equivalent to which I explained in what I wrote. They are not behaving equivalently. I explained it all. I've tried so many different things and they all fail. I've tried 4 different msgpack libraries. 2 from lua and 2 from C++ + some custom basic stuff and hard coding data.\n\nI've tried: \n\ntype ui_attach_request.bin | nvim.exe --headless --cmd \"call stdioopen({'rpc': v:true})\"\n\nthe bin is msg pack data.\n\nEverything fails. In this case the above also fails. It contains: 94 00 01 ae 6e 76 69 6d 5f 75 69 5f 61 74 74 61 63 68 93 50 18 81 a3 72 67 62\n\n\nwhich is suppose to be a hard coded msg pack:\n\nlocal correct_hex = \"96\" ..      -- array of 6 items\n                    \"00\" ..      -- type: 0 (request)\n                    \"01\" ..      -- msg_id: 1\n                    \"da000f\" ..  -- str16 length 15\n                    \"6e76696d5f75695f617474616368\" .. -- \"nvim_ui_attach\"\n                    \"48\" ..      -- width: 80\n                    \"18\" ..      -- height: 24\n                    \"81\" ..      -- map of 1 item\n                    \"a3726762\" .. -- \"rgb\" (fixstr3 + \"rgb\")\n                    \"c3\"         -- true\n\nI've tried many other things. I went down the ui_attach route because that was mentioned in some docs as necessary but I couldn't get anything to work. Because it simply terminates it's very difficult to know what is going on. I assumed it was the msgpacking which is why I tried 4 different versions. In many cases though nvim just exits immediately when using --embed so it is impossible to figure out. I tried different things with CreateProcess including using lua's popen which worked much better but still had similar issues. I could at least use it to echo text at some point.\n\nhttps://neovim.io/doc/user/channel.html\n\nhttps://browse.dgit.debian.org/neovim.git/tree/runtime/doc/msgpack_rpc.txt?id=baa981ea214ebaf606df443b2928ee93a7e6f7b9\n\nWhich seems to have some outdated information and invalid code.\n\n\"nvim_ui_attach({width}, {height}, {options})[nvim_ui_attach()](https://neovim.io/doc/user/api.html#nvim_ui_attach())\nActivates UI events on the channel.\nEntry point of all UI clients. Allows [--embed](https://neovim.io/doc/user/starting.html#--embed) to continue startup. Implies that the client is ready to show the UI. Adds the client to the list of UIs. [nvim_list_uis()](https://neovim.io/doc/user/api.html#nvim_list_uis())\"\n\nMaybe this doesn't work with headless and that is why attach fails? \n\ntype ui_attach_request.bin | nvim.exe --embed sorta works as it outputs: 94 01 01 c0 c0 but then it terminates immediately.\n\nI tried python with pynvim and that worked but I can't use python but it was using tcp rather than embed.\n\nI haven't checked but maybe nvim can or is outputting some debug information to some log file?\n\n",
            "created_at": "2025-11-18T01:43:17Z",
            "html_url": "https://github.com/neovim/neovim/issues/36598#issuecomment-3544664589",
            "id": 3544664589,
            "issue_url": "https://api.github.com/repos/neovim/neovim/issues/36598",
            "node_id": "IC_kwDOAPphoM7TR0oN",
            "performed_via_github_app": null,
            "reactions": {
                "+1": 0,
                "-1": 0,
                "confused": 0,
                "eyes": 0,
                "heart": 0,
                "hooray": 0,
                "laugh": 0,
                "rocket": 0,
                "total_count": 0,
                "url": "https://api.github.com/repos/neovim/neovim/issues/comments/3544664589/reactions"
            },
            "updated_at": "2025-11-18T01:43:17Z",
            "url": "https://api.github.com/repos/neovim/neovim/issues/comments/3544664589",
            "user": {
                "avatar_url": "https://avatars.githubusercontent.com/u/202556375?v=4",
                "events_url": "https://api.github.com/users/Universal-Invariant/events{/privacy}",
                "followers_url": "https://api.github.com/users/Universal-Invariant/followers",
                "following_url": "https://api.github.com/users/Universal-Invariant/following{/other_user}",
                "gists_url": "https://api.github.com/users/Universal-Invariant/gists{/gist_id}",
                "gravatar_id": "",
                "html_url": "https://github.com/Universal-Invariant",
                "id": 202556375,
                "login": "Universal-Invariant",
                "node_id": "U_kgDODBLD1w",
                "organizations_url": "https://api.github.com/users/Universal-Invariant/orgs",
                "received_events_url": "https://api.github.com/users/Universal-Invariant/received_events",
                "repos_url": "https://api.github.com/users/Universal-Invariant/repos",
                "site_admin": false,
                "starred_url": "https://api.github.com/users/Universal-Invariant/starred{/owner}{/repo}",
                "subscriptions_url": "https://api.github.com/users/Universal-Invariant/subscriptions",
                "type": "User",
                "url": "https://api.github.com/users/Universal-Invariant",
                "user_view_type": "public"
            }
        },
        {
            "author_association": "MEMBER",
            "body": "Sorry your experience is bad, but we can narrow down the issue and perhaps improve docs if needed. It may help if you can provide a minimal C/C++ code sample that we can try out (though possibly this is a Windows-specific issue, but [Neovim-qt](https://github.com/equalsraf/neovim-qt/blob/76cc138555e36d1b79fde141bc369024383a438e/src/neovimconnector.cpp#L269) is a C++ client which calls `nvim --embed`, and it definitely works on Windows...)\n\nI am guessing that something somewhere is writing invalid msgpack to the channel.\n\n> The docs say that --embed is identical to --cmd \"call stdioopen({'rpc': v:true})\" but\n\nNot to be pedantic, but \"equivalent\" does not mean \"identical\". That line is an attempt to show a (very similar, but not identical) analogy.\n\n> Maybe this doesn't work with headless and that is why attach fails?\n\n`:help --embed` does mention that `--headless`, by definition, does not wait for a UI (nvim_ui_attach).\n\n> I haven't checked but maybe nvim can or is outputting some debug information to some log file?\n\nYes, `:edit $NVIM_LOG_FILE` shows the default path. And Nvim builds with very verbose logging if you used the default build settings.\n\n",
            "created_at": "2025-11-18T02:05:16Z",
            "html_url": "https://github.com/neovim/neovim/issues/36598#issuecomment-3544700057",
            "id": 3544700057,
            "issue_url": "https://api.github.com/repos/neovim/neovim/issues/36598",
            "node_id": "IC_kwDOAPphoM7TR9SZ",
            "performed_via_github_app": null,
            "reactions": {
                "+1": 0,
                "-1": 0,
                "confused": 0,
                "eyes": 0,
                "heart": 0,
                "hooray": 0,
                "laugh": 0,
                "rocket": 0,
                "total_count": 0,
                "url": "https://api.github.com/repos/neovim/neovim/issues/comments/3544700057/reactions"
            },
            "updated_at": "2025-11-18T02:05:16Z",
            "url": "https://api.github.com/repos/neovim/neovim/issues/comments/3544700057",
            "user": {
                "avatar_url": "https://avatars.githubusercontent.com/u/1359421?v=4",
                "events_url": "https://api.github.com/users/justinmk/events{/privacy}",
                "followers_url": "https://api.github.com/users/justinmk/followers",
                "following_url": "https://api.github.com/users/justinmk/following{/other_user}",
                "gists_url": "https://api.github.com/users/justinmk/gists{/gist_id}",
                "gravatar_id": "",
                "html_url": "https://github.com/justinmk",
                "id": 1359421,
                "login": "justinmk",
                "node_id": "MDQ6VXNlcjEzNTk0MjE=",
                "organizations_url": "https://api.github.com/users/justinmk/orgs",
                "received_events_url": "https://api.github.com/users/justinmk/received_events",
                "repos_url": "https://api.github.com/users/justinmk/repos",
                "site_admin": false,
                "starred_url": "https://api.github.com/users/justinmk/starred{/owner}{/repo}",
                "subscriptions_url": "https://api.github.com/users/justinmk/subscriptions",
                "type": "User",
                "url": "https://api.github.com/users/justinmk",
                "user_view_type": "public"
            }
        }
    ],
    "comments": 3,
    "comments_url": "https://api.github.com/repos/neovim/neovim/issues/36598/comments",
    "created_at": "2025-11-18T00:46:15Z",
    "events_url": "https://api.github.com/repos/neovim/neovim/issues/36598/events",
    "html_url": "https://github.com/neovim/neovim/issues/36598",
    "id": 3635615149,
    "issue_dependencies_summary": {
        "blocked_by": 0,
        "blocking": 0,
        "total_blocked_by": 0,
        "total_blocking": 0
    },
    "labels": [
        {
            "color": "d4c5f9",
            "default": false,
            "description": null,
            "id": 109461219,
            "name": "platform:windows",
            "node_id": "MDU6TGFiZWwxMDk0NjEyMTk=",
            "url": "https://api.github.com/repos/neovim/neovim/labels/platform:windows"
        },
        {
            "color": "c7def8",
            "default": false,
            "description": "channels, RPC, msgpack",
            "id": 242522707,
            "name": "channels-rpc",
            "node_id": "MDU6TGFiZWwyNDI1MjI3MDc=",
            "url": "https://api.github.com/repos/neovim/neovim/labels/channels-rpc"
        },
        {
            "color": "c5def5",
            "default": false,
            "description": "startup, shutdown, attach, detach",
            "id": 870629450,
            "name": "lifecycle",
            "node_id": "MDU6TGFiZWw4NzA2Mjk0NTA=",
            "url": "https://api.github.com/repos/neovim/neovim/labels/lifecycle"
        },
        {
            "color": "C5DEF5",
            "default": false,
            "description": "",
            "id": 6212014172,
            "name": "embedding",
            "node_id": "LA_kwDOAPphoM8AAAABckPQXA",
            "url": "https://api.github.com/repos/neovim/neovim/labels/embedding"
        }
    ],
    "labels_url": "https://api.github.com/repos/neovim/neovim/issues/36598/labels{/name}",
    "locked": false,
    "milestone": null,
    "node_id": "I_kwDOAPphoM7YsxWt",
    "number": 36598,
    "performed_via_github_app": null,
    "reactions": {
        "+1": 0,
        "-1": 0,
        "confused": 0,
        "eyes": 0,
        "heart": 0,
        "hooray": 0,
        "laugh": 0,
        "rocket": 0,
        "total_count": 0,
        "url": "https://api.github.com/repos/neovim/neovim/issues/36598/reactions"
    },
    "repository_url": "https://api.github.com/repos/neovim/neovim",
    "state": "open",
    "state_reason": null,
    "sub_issues_summary": {
        "completed": 0,
        "percent_completed": 0,
        "total": 0
    },
    "timeline_url": "https://api.github.com/repos/neovim/neovim/issues/36598/timeline",
    "title": "embed cause nvim to immediately terminate",
    "type": {
        "color": "red",
        "created_at": "2024-01-25T10:10:19Z",
        "description": "An unexpected problem or behavior",
        "id": 597163,
        "is_enabled": true,
        "name": "Bug",
        "node_id": "IT_kwDOAGK_Pc4ACRyr",
        "updated_at": "2024-07-26T10:12:30Z"
    },
    "updated_at": "2025-11-18T02:06:24Z",
    "url": "https://api.github.com/repos/neovim/neovim/issues/36598",
    "user": {
        "avatar_url": "https://avatars.githubusercontent.com/u/202556375?v=4",
        "events_url": "https://api.github.com/users/Universal-Invariant/events{/privacy}",
        "followers_url": "https://api.github.com/users/Universal-Invariant/followers",
        "following_url": "https://api.github.com/users/Universal-Invariant/following{/other_user}",
        "gists_url": "https://api.github.com/users/Universal-Invariant/gists{/gist_id}",
        "gravatar_id": "",
        "html_url": "https://github.com/Universal-Invariant",
        "id": 202556375,
        "login": "Universal-Invariant",
        "node_id": "U_kgDODBLD1w",
        "organizations_url": "https://api.github.com/users/Universal-Invariant/orgs",
        "received_events_url": "https://api.github.com/users/Universal-Invariant/received_events",
        "repos_url": "https://api.github.com/users/Universal-Invariant/repos",
        "site_admin": false,
        "starred_url": "https://api.github.com/users/Universal-Invariant/starred{/owner}{/repo}",
        "subscriptions_url": "https://api.github.com/users/Universal-Invariant/subscriptions",
        "type": "User",
        "url": "https://api.github.com/users/Universal-Invariant",
        "user_view_type": "public"
    }
}