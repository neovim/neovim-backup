{
    "active_lock_reason": null,
    "assignee": null,
    "assignees": [],
    "author_association": "CONTRIBUTOR",
    "body": "<!-- Before reporting: search existing issues and check the FAQ. -->\r\n\r\n- `nvim --version`:\r\n```\r\nNVIM v0.5.0-dev+1036-gf9b311054\r\nBuild type: RelWithDebInfo\r\nLuaJIT 2.0.5\r\nCompilation: /usr/bin/cc -D_FORTIFY_SOURCE=2 -march=native -O2 -pipe -fno-plt -U_FORTIFY_SOURCE -D_FORTIFY_SOURCE=1 -O2 -g -Og -g -Wall -Wextra -pedantic -Wno-unused-parameter -Wstrict-prototypes -std=gnu99 -Wshadow -Wconversion -Wmissing-prototypes -Wimplicit-fallthrough -Wvla -fstack-protector-strong -fno-common -fdiagnostics-color=auto -DINCLUDE_GENERATED_DECLARATIONS -D_GNU_SOURCE -DNVIM_MSGPACK_HAS_FLOAT32 -DNVIM_UNIBI_HAS_VAR_FROM -DMIN_LOG_LEVEL=3 -I/home/jb/.cache/yay/neovim-git/src/build/config -I/home/jb/.cache/yay/neovim-git/src/neovim-git/src -I/usr/include -I/home/jb/.cache/yay/neovim-git/src/build/src/nvim/auto -I/home/jb/.cache/yay/neovim-git/src/build/include\r\nCompiled by jb\r\n```\r\n\r\n### Steps to reproduce\r\n\r\nUsing the following files `changedtick.lua`:\r\n```lua\r\n-- On changedtick\r\nTicks = 0\r\nfunction attach_onchangedtick()\r\n  vim.api.nvim_buf_attach(0, false, {\r\n    on_changedtick = function()\r\n      Ticks = Ticks + 1\r\n    end,\r\n  })\r\nend\r\n\r\nvim.cmd 'autocmd BufNew,BufRead * lua attach_onchangedtick()'\r\nvim.cmd 'command! Ticks lua print(Ticks)'\r\n\r\n-- Indent\r\nmath.randomseed(42)\r\n\r\nfunction get_random_indent(lnum)\r\n    print('get_random_indent, changedtick =', vim.b.changedtick, '=', vim.api.nvim_buf_get_changedtick(0))\r\n    local n = math.random(5)\r\n    local width = 4\r\n    local indent = width * n\r\n    return indent\r\nend\r\n\r\nlocal indentexpr = 'v:lua.get_random_indent(v:lnum)'\r\nvim.o.indentexpr = indentexpr\r\nvim.bo.indentexpr = indentexpr\r\n```\r\nand `testfile.txt`:\r\n```\r\nFirst line\r\nSecond line\r\nThird line\r\nLine 4\r\nLast line\r\n```\r\nrun:\r\n```\r\nnvim -u changedtick.lua --noplugin testfile.txt\r\n```\r\nand then do `gg=G`. \r\n\r\n### Actual behaviour\r\n\r\nThe `on_changedtick` callback should be called for each line change.\r\n\r\n### Expected behaviour\r\n\r\n`Ticks` stays 0. It is only incremented after I undo the changes. \r\n\r\nActually, when I was testing this in https://github.com/nvim-treesitter/nvim-treesitter/pull/837#issuecomment-757044164 it _was_ triggered, but only once at the end of the operation. When testing this now for some reason I don't even get a call after the whole operation, so I am a bit confused.\r\n\r\n### Background\r\n\r\nThis is an issue encountered when working on indent in nvim-treesitter. I described it in https://github.com/nvim-treesitter/nvim-treesitter/pull/837#issuecomment-757044164. The main issue is that the plugin maintains per-buffer cache that needs to be updated on any buffer change ([like this](https://github.com/nvim-treesitter/nvim-treesitter/blob/master/lua/nvim-treesitter/ts_utils.lua#L206)). `on_changedtick` was used for this purpose, but it does not get called when running an indent operation on multiple lines and treesitter updates the tree on each buffer modification and so the cache maintained in the plugin gets out of sync.\r\n\r\nI am not really sure \"what calls treesitter\" and makes it be reevaluated on any line change. As for `on_changedtick`, I found that `op_reindent` in `ops.c` should call this only once [at the end](https://github.com/neovim/neovim/blob/master/src/nvim/ops.c#L673-L675). I was able to make `changedtick` updated on each line as described in https://github.com/nvim-treesitter/nvim-treesitter/pull/837#issuecomment-758286023, but `on_changedtick` still was not called.",
    "closed_at": null,
    "closed_by": null,
    "comment_data": [
        {
            "author_association": "MEMBER",
            "body": "After doing some tests, I can't seem to subscribe to `on_changedtick` events, so this might be a problem too.",
            "created_at": "2021-01-20T09:31:00Z",
            "html_url": "https://github.com/neovim/neovim/issues/13786#issuecomment-763468369",
            "id": 763468369,
            "issue_url": "https://api.github.com/repos/neovim/neovim/issues/13786",
            "node_id": "MDEyOklzc3VlQ29tbWVudDc2MzQ2ODM2OQ==",
            "performed_via_github_app": null,
            "reactions": {
                "+1": 0,
                "-1": 0,
                "confused": 0,
                "eyes": 0,
                "heart": 0,
                "hooray": 0,
                "laugh": 0,
                "rocket": 0,
                "total_count": 0,
                "url": "https://api.github.com/repos/neovim/neovim/issues/comments/763468369/reactions"
            },
            "updated_at": "2021-01-20T09:31:00Z",
            "url": "https://api.github.com/repos/neovim/neovim/issues/comments/763468369",
            "user": {
                "avatar_url": "https://avatars.githubusercontent.com/u/39092278?v=4",
                "events_url": "https://api.github.com/users/vigoux/events{/privacy}",
                "followers_url": "https://api.github.com/users/vigoux/followers",
                "following_url": "https://api.github.com/users/vigoux/following{/other_user}",
                "gists_url": "https://api.github.com/users/vigoux/gists{/gist_id}",
                "gravatar_id": "",
                "html_url": "https://github.com/vigoux",
                "id": 39092278,
                "login": "vigoux",
                "node_id": "MDQ6VXNlcjM5MDkyMjc4",
                "organizations_url": "https://api.github.com/users/vigoux/orgs",
                "received_events_url": "https://api.github.com/users/vigoux/received_events",
                "repos_url": "https://api.github.com/users/vigoux/repos",
                "site_admin": false,
                "starred_url": "https://api.github.com/users/vigoux/starred{/owner}{/repo}",
                "subscriptions_url": "https://api.github.com/users/vigoux/subscriptions",
                "type": "User",
                "url": "https://api.github.com/users/vigoux",
                "user_view_type": "public"
            }
        },
        {
            "author_association": "CONTRIBUTOR",
            "body": "I came to this bug via: https://www.reddit.com/r/neovim/comments/l3mpiv/i_just_discovered_treesitter_was_the_reason_my/\r\n\r\nIt is still an issue for me using Python with Neovim 0.6-nightly.",
            "created_at": "2021-11-10T02:39:13Z",
            "html_url": "https://github.com/neovim/neovim/issues/13786#issuecomment-964729419",
            "id": 964729419,
            "issue_url": "https://api.github.com/repos/neovim/neovim/issues/13786",
            "node_id": "IC_kwDOAPphoM45gJpL",
            "performed_via_github_app": null,
            "reactions": {
                "+1": 0,
                "-1": 0,
                "confused": 0,
                "eyes": 0,
                "heart": 0,
                "hooray": 0,
                "laugh": 0,
                "rocket": 0,
                "total_count": 0,
                "url": "https://api.github.com/repos/neovim/neovim/issues/comments/964729419/reactions"
            },
            "updated_at": "2021-11-10T02:39:13Z",
            "url": "https://api.github.com/repos/neovim/neovim/issues/comments/964729419",
            "user": {
                "avatar_url": "https://avatars.githubusercontent.com/u/22371?v=4",
                "events_url": "https://api.github.com/users/dsully/events{/privacy}",
                "followers_url": "https://api.github.com/users/dsully/followers",
                "following_url": "https://api.github.com/users/dsully/following{/other_user}",
                "gists_url": "https://api.github.com/users/dsully/gists{/gist_id}",
                "gravatar_id": "",
                "html_url": "https://github.com/dsully",
                "id": 22371,
                "login": "dsully",
                "node_id": "MDQ6VXNlcjIyMzcx",
                "organizations_url": "https://api.github.com/users/dsully/orgs",
                "received_events_url": "https://api.github.com/users/dsully/received_events",
                "repos_url": "https://api.github.com/users/dsully/repos",
                "site_admin": false,
                "starred_url": "https://api.github.com/users/dsully/starred{/owner}{/repo}",
                "subscriptions_url": "https://api.github.com/users/dsully/subscriptions",
                "type": "User",
                "url": "https://api.github.com/users/dsully",
                "user_view_type": "public"
            }
        },
        {
            "author_association": "MEMBER",
            "body": "Coming back to this, this seems to be a pretty major issue. I'll see what I can do to get that fixed.",
            "created_at": "2021-12-14T13:20:43Z",
            "html_url": "https://github.com/neovim/neovim/issues/13786#issuecomment-993532728",
            "id": 993532728,
            "issue_url": "https://api.github.com/repos/neovim/neovim/issues/13786",
            "node_id": "IC_kwDOAPphoM47OBs4",
            "performed_via_github_app": null,
            "reactions": {
                "+1": 0,
                "-1": 0,
                "confused": 0,
                "eyes": 0,
                "heart": 1,
                "hooray": 0,
                "laugh": 0,
                "rocket": 0,
                "total_count": 1,
                "url": "https://api.github.com/repos/neovim/neovim/issues/comments/993532728/reactions"
            },
            "updated_at": "2021-12-14T13:20:43Z",
            "url": "https://api.github.com/repos/neovim/neovim/issues/comments/993532728",
            "user": {
                "avatar_url": "https://avatars.githubusercontent.com/u/39092278?v=4",
                "events_url": "https://api.github.com/users/vigoux/events{/privacy}",
                "followers_url": "https://api.github.com/users/vigoux/followers",
                "following_url": "https://api.github.com/users/vigoux/following{/other_user}",
                "gists_url": "https://api.github.com/users/vigoux/gists{/gist_id}",
                "gravatar_id": "",
                "html_url": "https://github.com/vigoux",
                "id": 39092278,
                "login": "vigoux",
                "node_id": "MDQ6VXNlcjM5MDkyMjc4",
                "organizations_url": "https://api.github.com/users/vigoux/orgs",
                "received_events_url": "https://api.github.com/users/vigoux/received_events",
                "repos_url": "https://api.github.com/users/vigoux/repos",
                "site_admin": false,
                "starred_url": "https://api.github.com/users/vigoux/starred{/owner}{/repo}",
                "subscriptions_url": "https://api.github.com/users/vigoux/subscriptions",
                "type": "User",
                "url": "https://api.github.com/users/vigoux",
                "user_view_type": "public"
            }
        },
        {
            "author_association": "CONTRIBUTOR",
            "body": "Some time ago I was testing some ideas on the treesitter indentation, though I didn't have time to finish it (the very much WIP changes are [here](https://github.com/jedrzejboczar/nvim-treesitter/tree/indent-debugger)).\r\n\r\nAnyway, while working on it I was able to overcome the issue with `on_changedtick` using the following fix: https://github.com/jedrzejboczar/neovim/tree/increment-reindent-changedtick ([commit](https://github.com/jedrzejboczar/neovim/commit/26556a4e433446a068399dad49307129c0b765b9)) and it seemed to work without any problems - you could give it a try. I am not sure if `do_buf_event` needs to be true or false and if this fix can have any unexpected consequences (like noticeable indent performance hit), so this still probably needs some testing. ",
            "created_at": "2021-12-14T14:28:45Z",
            "html_url": "https://github.com/neovim/neovim/issues/13786#issuecomment-993597323",
            "id": 993597323,
            "issue_url": "https://api.github.com/repos/neovim/neovim/issues/13786",
            "node_id": "IC_kwDOAPphoM47OReL",
            "performed_via_github_app": null,
            "reactions": {
                "+1": 0,
                "-1": 0,
                "confused": 0,
                "eyes": 0,
                "heart": 0,
                "hooray": 0,
                "laugh": 0,
                "rocket": 0,
                "total_count": 0,
                "url": "https://api.github.com/repos/neovim/neovim/issues/comments/993597323/reactions"
            },
            "updated_at": "2021-12-14T14:28:45Z",
            "url": "https://api.github.com/repos/neovim/neovim/issues/comments/993597323",
            "user": {
                "avatar_url": "https://avatars.githubusercontent.com/u/16623787?v=4",
                "events_url": "https://api.github.com/users/jedrzejboczar/events{/privacy}",
                "followers_url": "https://api.github.com/users/jedrzejboczar/followers",
                "following_url": "https://api.github.com/users/jedrzejboczar/following{/other_user}",
                "gists_url": "https://api.github.com/users/jedrzejboczar/gists{/gist_id}",
                "gravatar_id": "",
                "html_url": "https://github.com/jedrzejboczar",
                "id": 16623787,
                "login": "jedrzejboczar",
                "node_id": "MDQ6VXNlcjE2NjIzNzg3",
                "organizations_url": "https://api.github.com/users/jedrzejboczar/orgs",
                "received_events_url": "https://api.github.com/users/jedrzejboczar/received_events",
                "repos_url": "https://api.github.com/users/jedrzejboczar/repos",
                "site_admin": false,
                "starred_url": "https://api.github.com/users/jedrzejboczar/starred{/owner}{/repo}",
                "subscriptions_url": "https://api.github.com/users/jedrzejboczar/subscriptions",
                "type": "User",
                "url": "https://api.github.com/users/jedrzejboczar",
                "user_view_type": "public"
            }
        }
    ],
    "comments": 4,
    "comments_url": "https://api.github.com/repos/neovim/neovim/issues/13786/comments",
    "created_at": "2021-01-18T21:48:15Z",
    "events_url": "https://api.github.com/repos/neovim/neovim/issues/13786/events",
    "html_url": "https://github.com/neovim/neovim/issues/13786",
    "id": 788565053,
    "labels": [
        {
            "color": "f9d0c4",
            "default": true,
            "description": "issues reporting wrong behavior",
            "id": 77997474,
            "name": "bug",
            "node_id": "MDU6TGFiZWw3Nzk5NzQ3NA==",
            "url": "https://api.github.com/repos/neovim/neovim/labels/bug"
        }
    ],
    "labels_url": "https://api.github.com/repos/neovim/neovim/issues/13786/labels{/name}",
    "locked": false,
    "milestone": null,
    "node_id": "MDU6SXNzdWU3ODg1NjUwNTM=",
    "number": 13786,
    "performed_via_github_app": null,
    "reactions": {
        "+1": 4,
        "-1": 0,
        "confused": 0,
        "eyes": 0,
        "heart": 0,
        "hooray": 0,
        "laugh": 0,
        "rocket": 0,
        "total_count": 4,
        "url": "https://api.github.com/repos/neovim/neovim/issues/13786/reactions"
    },
    "repository_url": "https://api.github.com/repos/neovim/neovim",
    "state": "open",
    "state_reason": null,
    "sub_issues_summary": {
        "completed": 0,
        "percent_completed": 0,
        "total": 0
    },
    "timeline_url": "https://api.github.com/repos/neovim/neovim/issues/13786/timeline",
    "title": "on_changedtick not called for op_reindent",
    "updated_at": "2025-01-19T11:40:46Z",
    "url": "https://api.github.com/repos/neovim/neovim/issues/13786",
    "user": {
        "avatar_url": "https://avatars.githubusercontent.com/u/16623787?v=4",
        "events_url": "https://api.github.com/users/jedrzejboczar/events{/privacy}",
        "followers_url": "https://api.github.com/users/jedrzejboczar/followers",
        "following_url": "https://api.github.com/users/jedrzejboczar/following{/other_user}",
        "gists_url": "https://api.github.com/users/jedrzejboczar/gists{/gist_id}",
        "gravatar_id": "",
        "html_url": "https://github.com/jedrzejboczar",
        "id": 16623787,
        "login": "jedrzejboczar",
        "node_id": "MDQ6VXNlcjE2NjIzNzg3",
        "organizations_url": "https://api.github.com/users/jedrzejboczar/orgs",
        "received_events_url": "https://api.github.com/users/jedrzejboczar/received_events",
        "repos_url": "https://api.github.com/users/jedrzejboczar/repos",
        "site_admin": false,
        "starred_url": "https://api.github.com/users/jedrzejboczar/starred{/owner}{/repo}",
        "subscriptions_url": "https://api.github.com/users/jedrzejboczar/subscriptions",
        "type": "User",
        "url": "https://api.github.com/users/jedrzejboczar",
        "user_view_type": "public"
    }
}