{
    "active_lock_reason": null,
    "assignee": null,
    "assignees": [],
    "author_association": "CONTRIBUTOR",
    "body": "### Problem\n\nI'm using `v:lua.vim.treesitter.foldexpr()` and often when editing, folds are randomly being closed.\nI can set `foldlevel` to enormous value, and `foldnestmax = 1`, none of them prevent it.\n\nExample:\n```c\nint hello() {  // I close this fold first with 'za'\n  printf(\"hi\");\n}\n\n// other contents in between don't prevent the issue\n\nint goodbye() {  // <-- If i replace '{' with a space, then back to a '{', this fold gets closed(!)\n  printf(\"bye\");\n}\n```\n\nI'm new to trying to use treesitter folding, only having used indentation-based folding in the past: so maybe I'm doing something wrong, but from everything I understand, it seems like a bug.\n\nI made a little reproducer since it was a bit tricky to narrow down to this point. After it runs, `goodbye()` fold is closed, even though no-one asked for that.\n\n### Steps to reproduce\n\n$ nvim --clean -u repro.lua\n\n```lua\n-- configuration\nvim.opt.foldlevel = 99\nvim.opt.foldexpr = 'v:lua.vim.treesitter.foldexpr()'\nvim.opt.foldmethod = 'expr'\n\nvim.api.nvim_create_autocmd(\"FileType\", {\n  callback = function(args)\n    vim.treesitter.start()\n  end\n})\n-- end configuration\n\n-- create test C file\nlocal buf = vim.api.nvim_create_buf(true, true)\nvim.api.nvim_set_current_buf(buf)\nvim.api.nvim_buf_set_lines(buf, 0, -1, true, vim.split([[\nint hello() {\n  printf(\"hi\");\n}\n\nint goodbye() {\n  printf(\"bye\");\n}\n]], \"\\n\")\n)\nvim.bo[buf].filetype = 'c'\n\n-- compute the folds\nvim.api.nvim_feedkeys('zx', 'n', false)\n\nvim.defer_fn(function()\n  -- step1: close hello() fold\n  vim.cmd('foldclose')\n  vim.print('closed hello()')\n\n  vim.defer_fn(function()\n    -- step2: replace opening brace of 'goodbye() {' with a space\n    vim.api.nvim_win_set_cursor(0, {5, 14})\n    vim.api.nvim_feedkeys('r ', 'n', false)\n    vim.print('replaced brace with space')\n\n    vim.defer_fn(function()\n      -- step3: replace space with opening brace again\n      vim.api.nvim_feedkeys('r{', 'n', false)\n      vim.print('put the brace back')\n    end, 500)\n  end, 500)\nend, 500)\n```\n\n### Expected behavior\n\nExpect that the second `goodbye()` fold won't be closed since I never closed that fold, and foldlevel is set to an enormous value\n\n### Nvim version (nvim -v)\n\nv0.11.0-dev-1912+g0c0352783f\n\n### Vim (not Nvim) behaves the same?\n\nN/A: treesitter\n\n### Operating system/version\n\nlinux 6.13.4\n\n### Terminal name/version\n\nfoot 1.20.2\n\n### $TERM environment variable\n\nxterm-256color\n\n### Installation\n\nAUR",
    "closed_at": null,
    "closed_by": null,
    "comment_data": [
        {
            "author_association": "CONTRIBUTOR",
            "body": "This happens due to this line that makes the new fold inherit the state of the previous fold. I'm not sure why this is useful, but this line is at least 21 years old.\nhttps://github.com/neovim/neovim/blob/48e3ac60c63341761b0f7e21262722f09127d374/src/nvim/fold.c#L2364\n\n\nInterestingly, this problem doesn't happen with fdm=syntax. So I believe it happens because vim.treesitter.foldexpr schedules a callback to compute and update folds. On the other hand, the updates by fdm=syntax and legacy foldexprs are not scheduled. The non-scheduled ones might be retaining some context that prevent this problem happening. \n",
            "created_at": "2025-03-08T13:23:23Z",
            "html_url": "https://github.com/neovim/neovim/issues/32759#issuecomment-2708282516",
            "id": 2708282516,
            "issue_url": "https://api.github.com/repos/neovim/neovim/issues/32759",
            "node_id": "IC_kwDOAPphoM6hbRyU",
            "performed_via_github_app": null,
            "reactions": {
                "+1": 0,
                "-1": 0,
                "confused": 0,
                "eyes": 2,
                "heart": 0,
                "hooray": 0,
                "laugh": 0,
                "rocket": 0,
                "total_count": 2,
                "url": "https://api.github.com/repos/neovim/neovim/issues/comments/2708282516/reactions"
            },
            "updated_at": "2025-03-08T13:23:23Z",
            "url": "https://api.github.com/repos/neovim/neovim/issues/comments/2708282516",
            "user": {
                "avatar_url": "https://avatars.githubusercontent.com/u/19489738?v=4",
                "events_url": "https://api.github.com/users/tomtomjhj/events{/privacy}",
                "followers_url": "https://api.github.com/users/tomtomjhj/followers",
                "following_url": "https://api.github.com/users/tomtomjhj/following{/other_user}",
                "gists_url": "https://api.github.com/users/tomtomjhj/gists{/gist_id}",
                "gravatar_id": "",
                "html_url": "https://github.com/tomtomjhj",
                "id": 19489738,
                "login": "tomtomjhj",
                "node_id": "MDQ6VXNlcjE5NDg5NzM4",
                "organizations_url": "https://api.github.com/users/tomtomjhj/orgs",
                "received_events_url": "https://api.github.com/users/tomtomjhj/received_events",
                "repos_url": "https://api.github.com/users/tomtomjhj/repos",
                "site_admin": false,
                "starred_url": "https://api.github.com/users/tomtomjhj/starred{/owner}{/repo}",
                "subscriptions_url": "https://api.github.com/users/tomtomjhj/subscriptions",
                "type": "User",
                "url": "https://api.github.com/users/tomtomjhj",
                "user_view_type": "public"
            }
        }
    ],
    "comments": 1,
    "comments_url": "https://api.github.com/repos/neovim/neovim/issues/32759/comments",
    "created_at": "2025-03-06T20:00:56Z",
    "events_url": "https://api.github.com/repos/neovim/neovim/issues/32759/events",
    "html_url": "https://github.com/neovim/neovim/issues/32759",
    "id": 2901303419,
    "labels": [
        {
            "color": "c5def5",
            "default": false,
            "description": "",
            "id": 1799626557,
            "name": "treesitter",
            "node_id": "MDU6TGFiZWwxNzk5NjI2NTU3",
            "url": "https://api.github.com/repos/neovim/neovim/labels/treesitter"
        },
        {
            "color": "c5def5",
            "default": false,
            "description": "",
            "id": 2598645343,
            "name": "folds",
            "node_id": "MDU6TGFiZWwyNTk4NjQ1MzQz",
            "url": "https://api.github.com/repos/neovim/neovim/labels/folds"
        }
    ],
    "labels_url": "https://api.github.com/repos/neovim/neovim/issues/32759/labels{/name}",
    "locked": false,
    "milestone": null,
    "node_id": "I_kwDOAPphoM6s7mB7",
    "number": 32759,
    "performed_via_github_app": null,
    "reactions": {
        "+1": 0,
        "-1": 0,
        "confused": 0,
        "eyes": 0,
        "heart": 0,
        "hooray": 0,
        "laugh": 0,
        "rocket": 0,
        "total_count": 0,
        "url": "https://api.github.com/repos/neovim/neovim/issues/32759/reactions"
    },
    "repository_url": "https://api.github.com/repos/neovim/neovim",
    "state": "open",
    "state_reason": null,
    "sub_issues_summary": {
        "completed": 0,
        "percent_completed": 0,
        "total": 0
    },
    "timeline_url": "https://api.github.com/repos/neovim/neovim/issues/32759/timeline",
    "title": "vim.treesitter.foldexpr() incorrectly closing folds when editing",
    "updated_at": "2025-03-08T13:23:24Z",
    "url": "https://api.github.com/repos/neovim/neovim/issues/32759",
    "user": {
        "avatar_url": "https://avatars.githubusercontent.com/u/504194?v=4",
        "events_url": "https://api.github.com/users/rmuir/events{/privacy}",
        "followers_url": "https://api.github.com/users/rmuir/followers",
        "following_url": "https://api.github.com/users/rmuir/following{/other_user}",
        "gists_url": "https://api.github.com/users/rmuir/gists{/gist_id}",
        "gravatar_id": "",
        "html_url": "https://github.com/rmuir",
        "id": 504194,
        "login": "rmuir",
        "node_id": "MDQ6VXNlcjUwNDE5NA==",
        "organizations_url": "https://api.github.com/users/rmuir/orgs",
        "received_events_url": "https://api.github.com/users/rmuir/received_events",
        "repos_url": "https://api.github.com/users/rmuir/repos",
        "site_admin": false,
        "starred_url": "https://api.github.com/users/rmuir/starred{/owner}{/repo}",
        "subscriptions_url": "https://api.github.com/users/rmuir/subscriptions",
        "type": "User",
        "url": "https://api.github.com/users/rmuir",
        "user_view_type": "public"
    }
}