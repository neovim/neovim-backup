{
    "active_lock_reason": null,
    "assignee": null,
    "assignees": [],
    "author_association": "MEMBER",
    "body": "### Problem\n\nTUI segfaults when using extmark with very long URL. ASAN log:\n```\n=================================================================\n==280569==ERROR: AddressSanitizer: heap-buffer-overflow on address 0x531000012630 at pc 0x5b8b676bd084 bp 0x7ffc40542f10 sp 0x7ffc405426d0\nWRITE of size 100019 at 0x531000012630 thread T0\n    #0 0x5b8b676bd083 in __asan_memcpy (**/build/bin/nvim+0xd29083) (BuildId: 51d9302e21cef8c7d563cf75b16d50cc87897e8c)\n    #1 0x5b8b68c04bf8 in out **/src/nvim/tui/tui.c:1844:3\n    #2 0x5b8b68c183ed in update_attrs **/src/nvim/tui/tui.c:815:7\n    #3 0x5b8b68c22b8b in print_cell **/src/nvim/tui/tui.c:855:3\n    #4 0x5b8b68c1f833 in print_cell_at_pos **/src/nvim/tui/tui.c:1038:3\n    #5 0x5b8b68c25769 in tui_raw_line **/src/nvim/tui/tui.c:1672:3\n    #6 0x5b8b68c63a1c in ui_client_event_raw_line **/src/nvim/ui_client.c:275:3\n    #7 0x5b8b6848b009 in parse_msgpack **/src/nvim/msgpack_rpc/channel.c:251:11\n    #8 0x5b8b68480c71 in receive_msgpack **/src/nvim/msgpack_rpc/channel.c:213:5\n    #9 0x5b8b67e28fbc in read_event **/src/nvim/event/rstream.c:180:23\n    #10 0x5b8b67e2898d in invoke_read_cb **/src/nvim/event/rstream.c:232:3\n    #11 0x5b8b67e25b9d in read_cb **/src/nvim/event/rstream.c:135:3\n    #12 0x5b8b690a424a in uv__read **/.deps/build/src/libuv/src/unix/stream.c:1148:7\n    #13 0x5b8b690a1b7c in uv__stream_io **/.deps/build/src/libuv/src/unix/stream.c:1208:5\n    #14 0x5b8b690adcd1 in uv__io_poll **/.deps/build/src/libuv/src/unix/linux.c:1570:11\n    #15 0x5b8b6908f405 in uv_run **/.deps/build/src/libuv/src/unix/core.c:458:5\n    #16 0x5b8b67e12cd9 in loop_uv_run **/src/nvim/event/loop.c:61:3\n    #17 0x5b8b67e128e4 in loop_poll_events **/src/nvim/event/loop.c:82:26\n    #18 0x5b8b68c61ac9 in ui_client_run **/src/nvim/ui_client.c:176:5\n    #19 0x5b8b681fef6d in main **/src/nvim/main.c:354:5\n    #20 0x7c8dc1170e07 in __libc_start_call_main /usr/src/debug/glibc/glibc/csu/../sysdeps/nptl/libc_start_call_main.h:58:16\n    #21 0x7c8dc1170ecb in __libc_start_main /usr/src/debug/glibc/glibc/csu/../csu/libc-start.c:360:3\n    #22 0x5b8b675d4d24 in _start (**/build/bin/nvim+0xc40d24) (BuildId: 51d9302e21cef8c7d563cf75b16d50cc87897e8c)\n\n0x531000012630 is located 0 bytes after 73264-byte region [0x531000000800,0x531000012630)\nallocated by thread T0 here:\n    #0 0x5b8b676c1149 in calloc (**/build/bin/nvim+0xd2d149) (BuildId: 51d9302e21cef8c7d563cf75b16d50cc87897e8c)\n    #1 0x5b8b683c473d in xcalloc **/src/nvim/memory.c:159:15\n    #2 0x5b8b68c012d2 in tui_start **/src/nvim/tui/tui.c:164:18\n    #3 0x5b8b68c6194b in ui_client_run **/src/nvim/ui_client.c:163:3\n    #4 0x5b8b681fef6d in main **/src/nvim/main.c:354:5\n    #5 0x7c8dc1170e07 in __libc_start_call_main /usr/src/debug/glibc/glibc/csu/../sysdeps/nptl/libc_start_call_main.h:58:16\n    #6 0x7c8dc1170ecb in __libc_start_main /usr/src/debug/glibc/glibc/csu/../csu/libc-start.c:360:3\n    #7 0x5b8b675d4d24 in _start (**/build/bin/nvim+0xc40d24) (BuildId: 51d9302e21cef8c7d563cf75b16d50cc87897e8c)\n\nSUMMARY: AddressSanitizer: heap-buffer-overflow (**/build/bin/nvim+0xd29083) (BuildId: 51d9302e21cef8c7d563cf75b16d50cc87897e8c) in __asan_memcpy\nShadow bytes around the buggy address:\n  0x531000012380: 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00\n  0x531000012400: 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00\n  0x531000012480: 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00\n  0x531000012500: 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00\n  0x531000012580: 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00\n=>0x531000012600: 00 00 00 00 00 00[fa]fa fa fa fa fa fa fa fa fa\n  0x531000012680: fa fa fa fa fa fa fa fa fa fa fa fa fa fa fa fa\n  0x531000012700: fa fa fa fa fa fa fa fa fa fa fa fa fa fa fa fa\n  0x531000012780: fa fa fa fa fa fa fa fa fa fa fa fa fa fa fa fa\n  0x531000012800: fa fa fa fa fa fa fa fa fa fa fa fa fa fa fa fa\n  0x531000012880: fa fa fa fa fa fa fa fa fa fa fa fa fa fa fa fa\nShadow byte legend (one shadow byte represents 8 application bytes):\n  Addressable:           00\n  Partially addressable: 01 02 03 04 05 06 07 \n  Heap left redzone:       fa\n  Freed heap region:       fd\n  Stack left redzone:      f1\n  Stack mid redzone:       f2\n  Stack right redzone:     f3\n  Stack after return:      f5\n  Stack use after scope:   f8\n  Global redzone:          f9\n  Global init order:       f6\n  Poisoned by user:        f7\n  Container overflow:      fc\n  Array cookie:            ac\n  Intra object redzone:    bb\n  ASan internal:           fe\n  Left alloca redzone:     ca\n  Right alloca redzone:    cb\n==280569==ABORTING\n```\n\n### Steps to reproduce\n\n1. Run `nvim --clean`\n2. Source the following Lua file:\n```lua\nlocal ns = vim.api.nvim_create_namespace('test')\nvim.api.nvim_buf_set_lines(0, 0, -1, true, { 'foobar' })\nvim.api.nvim_buf_set_extmark(0, ns, 0, 0, { end_col = 3, url = ('a'):rep(99999) })\n```\n3. Segfault\n\n### Expected behavior\n\nNo segfault\n\n### Nvim version (nvim -v)\n\nv0.11.0-dev-965+gfb74fd2954\n\n### Vim (not Nvim) behaves the same?\n\nN/A\n\n### Operating system/version\n\nArch Linux\n\n### Terminal name/version\n\nkitty 0.36.4\n\n### $TERM environment variable\n\nxterm-kitty\n\n### Installation\n\nbuild from repo",
    "closed_at": null,
    "closed_by": null,
    "comment_data": [],
    "comments": 0,
    "comments_url": "https://api.github.com/repos/neovim/neovim/issues/30794/comments",
    "created_at": "2024-10-13T07:24:00Z",
    "events_url": "https://api.github.com/repos/neovim/neovim/issues/30794/events",
    "html_url": "https://github.com/neovim/neovim/issues/30794",
    "id": 2583729822,
    "labels": [
        {
            "color": "c5def5",
            "default": false,
            "description": "",
            "id": 197254545,
            "name": "tui",
            "node_id": "MDU6TGFiZWwxOTcyNTQ1NDU=",
            "url": "https://api.github.com/repos/neovim/neovim/labels/tui"
        },
        {
            "color": "0E8A16",
            "default": false,
            "description": "issue contains a stacktrace/ASAN log",
            "id": 435854079,
            "name": "has:backtrace",
            "node_id": "MDU6TGFiZWw0MzU4NTQwNzk=",
            "url": "https://api.github.com/repos/neovim/neovim/labels/has:backtrace"
        },
        {
            "color": "F9D0C4",
            "default": false,
            "description": "issue reporting a crash or segfault",
            "id": 435854234,
            "name": "bug-crash",
            "node_id": "MDU6TGFiZWw0MzU4NTQyMzQ=",
            "url": "https://api.github.com/repos/neovim/neovim/labels/bug-crash"
        }
    ],
    "labels_url": "https://api.github.com/repos/neovim/neovim/issues/30794/labels{/name}",
    "locked": false,
    "milestone": null,
    "node_id": "I_kwDOAPphoM6aAJae",
    "number": 30794,
    "performed_via_github_app": null,
    "reactions": {
        "+1": 0,
        "-1": 0,
        "confused": 0,
        "eyes": 0,
        "heart": 0,
        "hooray": 0,
        "laugh": 0,
        "rocket": 0,
        "total_count": 0,
        "url": "https://api.github.com/repos/neovim/neovim/issues/30794/reactions"
    },
    "repository_url": "https://api.github.com/repos/neovim/neovim",
    "state": "open",
    "state_reason": null,
    "sub_issues_summary": {
        "completed": 0,
        "percent_completed": 0,
        "total": 0
    },
    "timeline_url": "https://api.github.com/repos/neovim/neovim/issues/30794/timeline",
    "title": "TUI: segfault when using extmark with very long URL",
    "type": {
        "color": "red",
        "created_at": "2024-01-25T10:10:19Z",
        "description": "An unexpected problem or behavior",
        "id": 597163,
        "is_enabled": true,
        "name": "Bug",
        "node_id": "IT_kwDOAGK_Pc4ACRyr",
        "updated_at": "2024-07-26T10:12:30Z"
    },
    "updated_at": "2025-07-02T22:32:29Z",
    "url": "https://api.github.com/repos/neovim/neovim/issues/30794",
    "user": {
        "avatar_url": "https://avatars.githubusercontent.com/u/35768171?v=4",
        "events_url": "https://api.github.com/users/zeertzjq/events{/privacy}",
        "followers_url": "https://api.github.com/users/zeertzjq/followers",
        "following_url": "https://api.github.com/users/zeertzjq/following{/other_user}",
        "gists_url": "https://api.github.com/users/zeertzjq/gists{/gist_id}",
        "gravatar_id": "",
        "html_url": "https://github.com/zeertzjq",
        "id": 35768171,
        "login": "zeertzjq",
        "node_id": "MDQ6VXNlcjM1NzY4MTcx",
        "organizations_url": "https://api.github.com/users/zeertzjq/orgs",
        "received_events_url": "https://api.github.com/users/zeertzjq/received_events",
        "repos_url": "https://api.github.com/users/zeertzjq/repos",
        "site_admin": false,
        "starred_url": "https://api.github.com/users/zeertzjq/starred{/owner}{/repo}",
        "subscriptions_url": "https://api.github.com/users/zeertzjq/subscriptions",
        "type": "User",
        "url": "https://api.github.com/users/zeertzjq",
        "user_view_type": "public"
    }
}