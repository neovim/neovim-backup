{
    "active_lock_reason": null,
    "assignee": null,
    "assignees": [],
    "author_association": "NONE",
    "body": "### Problem\n\nWhen a user has configured vim.on_key to swallow key input, and a Lua function is bound to some key mapping, pressing that key mapping results in inexplicable numbers and line breaks being inserted instead of the key mapping being swallowed.\n\nThis issue occurred on macOS, but it was also reproducible on Linux. The terminal application used is also irrelevant.\n\n<img width=\"651\" height=\"364\" alt=\"Image\" src=\"https://github.com/user-attachments/assets/82cc3556-0fa2-42c6-9fc4-c63903d8acef\" />\n\n### Steps to reproduce\n\nThis is `minimal.lua`:\n```lua\n-- Run this file as `nvim --clean -u minimal.lua`\n\nfor name, url in pairs {\n  -- ADD PLUGINS _NECESSARY_ TO REPRODUCE THE ISSUE, e.g:\n  -- 'https://github.com/author1/plugin1',\n  -- 'https://github.com/author2/plugin2',\n} do\n  local install_path = vim.fn.fnamemodify('nvim_issue/' .. name, ':p')\n  if vim.fn.isdirectory(install_path) == 0 then\n    vim.fn.system { 'git', 'clone', '--depth=1', url, install_path }\n  end\n  vim.opt.runtimepath:append(install_path)\nend\n\n-- ADD INIT.LUA SETTINGS _NECESSARY_ FOR REPRODUCING THE ISSUE\n\nvim.on_key(function(k, t)\n  -- Check for \"a\" key\n  if t == \"a\" then\n    -- Swallow the key by returning an empty string\n    return \"\"\n  end\n  -- Let other keys pass through\n  return nil\nend)\n\nvim.keymap.set(\"i\", \"a\", function()\n  -- This function should not be executed because on_key swallowed the key.\n  -- However, its mere presence as a Lua mapping seems necessary to trigger the bug.\nend)\nvim.cmd(\"startinsert\")\n```\n1. Execute `nvim --clean -u minimal.lua`\n2. Press `a`\n3. An inexplicable number and newline is entered. (In my environment, it's `62`, but it probably varies depending on the settings and environment.)\n\n### Expected behavior\n\nWhen `a` is pressed, `vim.on_key` should \"swallow\" the keypress. The keymap for a should not be triggered, and input nothing.\n\n### Nvim version (nvim -v)\n\n0.11.5\n\n### Vim (not Nvim) behaves the same?\n\nno, 9.1.1128\n\n### Operating system/version\n\nmacOS Tahoe 26.0\n\n### Terminal name/version\n\niTerm Built 3.6.5\n\n### $TERM environment variable\n\nxterm-256color\n\n### Installation\n\nmise-en-place via aqua backend",
    "closed_at": "2025-11-20T04:33:03Z",
    "closed_by": {
        "avatar_url": "https://avatars.githubusercontent.com/u/35768171?v=4",
        "events_url": "https://api.github.com/users/zeertzjq/events{/privacy}",
        "followers_url": "https://api.github.com/users/zeertzjq/followers",
        "following_url": "https://api.github.com/users/zeertzjq/following{/other_user}",
        "gists_url": "https://api.github.com/users/zeertzjq/gists{/gist_id}",
        "gravatar_id": "",
        "html_url": "https://github.com/zeertzjq",
        "id": 35768171,
        "login": "zeertzjq",
        "node_id": "MDQ6VXNlcjM1NzY4MTcx",
        "organizations_url": "https://api.github.com/users/zeertzjq/orgs",
        "received_events_url": "https://api.github.com/users/zeertzjq/received_events",
        "repos_url": "https://api.github.com/users/zeertzjq/repos",
        "site_admin": false,
        "starred_url": "https://api.github.com/users/zeertzjq/starred{/owner}{/repo}",
        "subscriptions_url": "https://api.github.com/users/zeertzjq/subscriptions",
        "type": "User",
        "url": "https://api.github.com/users/zeertzjq",
        "user_view_type": "public"
    },
    "comment_data": [
        {
            "author_association": "NONE",
            "body": "This bug is likely caused by an incomplete reset of the typeahead buffer when input is discarded by vim.on_key. When K_LUA is discarded, the subsequent {LuaRef}<CR> is not discarded, and these are processed as normal input, leading to this strange behavior.",
            "created_at": "2025-11-08T15:09:44Z",
            "html_url": "https://github.com/neovim/neovim/issues/36480#issuecomment-3506621888",
            "id": 3506621888,
            "issue_url": "https://api.github.com/repos/neovim/neovim/issues/36480",
            "node_id": "IC_kwDOAPphoM7RAs3A",
            "performed_via_github_app": null,
            "reactions": {
                "+1": 0,
                "-1": 0,
                "confused": 0,
                "eyes": 0,
                "heart": 0,
                "hooray": 0,
                "laugh": 0,
                "rocket": 0,
                "total_count": 0,
                "url": "https://api.github.com/repos/neovim/neovim/issues/comments/3506621888/reactions"
            },
            "updated_at": "2025-11-08T15:09:44Z",
            "url": "https://api.github.com/repos/neovim/neovim/issues/comments/3506621888",
            "user": {
                "avatar_url": "https://avatars.githubusercontent.com/u/43296160?v=4",
                "events_url": "https://api.github.com/users/sirasagi62/events{/privacy}",
                "followers_url": "https://api.github.com/users/sirasagi62/followers",
                "following_url": "https://api.github.com/users/sirasagi62/following{/other_user}",
                "gists_url": "https://api.github.com/users/sirasagi62/gists{/gist_id}",
                "gravatar_id": "",
                "html_url": "https://github.com/sirasagi62",
                "id": 43296160,
                "login": "sirasagi62",
                "node_id": "MDQ6VXNlcjQzMjk2MTYw",
                "organizations_url": "https://api.github.com/users/sirasagi62/orgs",
                "received_events_url": "https://api.github.com/users/sirasagi62/received_events",
                "repos_url": "https://api.github.com/users/sirasagi62/repos",
                "site_admin": false,
                "starred_url": "https://api.github.com/users/sirasagi62/starred{/owner}{/repo}",
                "subscriptions_url": "https://api.github.com/users/sirasagi62/subscriptions",
                "type": "User",
                "url": "https://api.github.com/users/sirasagi62",
                "user_view_type": "public"
            }
        },
        {
            "author_association": "NONE",
            "body": "To clarify the issue, I tried several additional patterns. The problem persisted even when I replaced the key mapping with command execution instead of a Lua function, expression evaluation in a register, or simple text. \n\nThe essence of the problem seems to be that when an empty string is returned by vim.on_key, only the first character is deleted, and the rest of the key mapping is still input.\n\n```lua\n-- Run this file as `nvim --clean -u minimal.lua`\n\nfor name, url in pairs {\n  -- ADD PLUGINS _NECESSARY_ TO REPRODUCE THE ISSUE, e.g:\n  -- 'https://github.com/author1/plugin1',\n  -- 'https://github.com/author2/plugin2',\n} do\n  local install_path = vim.fn.fnamemodify('nvim_issue/' .. name, ':p')\n  if vim.fn.isdirectory(install_path) == 0 then\n    vim.fn.system { 'git', 'clone', '--depth=1', url, install_path }\n  end\n  vim.opt.runtimepath:append(install_path)\nend\n\n-- ADD INIT.LUA SETTINGS _NECESSARY_ FOR REPRODUCING THE ISSUE\n\nvim.on_key(function(k, t)\n  if t == \"a\" or t==\"b\" or t==\"c\" or t==\"d\" or t==\"e\" then\n    -- Swallow the key by returning an empty string\n    return \"\"\n  end\n  -- Let other keys pass through\n  -- return nil\nend)\n\nvim.keymap.set(\"i\", \"a\", function()\n  -- This function should not be executed because on_key swallowed the key.\n  -- However, its mere presence as a Lua mapping seems necessary to trigger the bug.\nend)\nvim.keymap.set(\"i\", \"b\", \"<cmd>echo 'Hello'<CR>\")\nvim.keymap.set(\"i\", \"c\", \"<C-r>=1+1<CR>\")\nvim.keymap.set(\"i\", \"d\", \"123456789\")\n--- `echo 'Hello'<CR>` is inserted when the user typed 'b'\n--- `=1+1` is inserted when the user typed 'c'\n--- `23456789` is inserted when the user typed 'd'\n\nvim.cmd(\"startinsert\")\n\n```",
            "created_at": "2025-11-09T09:57:22Z",
            "html_url": "https://github.com/neovim/neovim/issues/36480#issuecomment-3507862035",
            "id": 3507862035,
            "issue_url": "https://api.github.com/repos/neovim/neovim/issues/36480",
            "node_id": "IC_kwDOAPphoM7RFboT",
            "performed_via_github_app": null,
            "reactions": {
                "+1": 0,
                "-1": 0,
                "confused": 0,
                "eyes": 0,
                "heart": 0,
                "hooray": 0,
                "laugh": 0,
                "rocket": 0,
                "total_count": 0,
                "url": "https://api.github.com/repos/neovim/neovim/issues/comments/3507862035/reactions"
            },
            "updated_at": "2025-11-09T10:01:51Z",
            "url": "https://api.github.com/repos/neovim/neovim/issues/comments/3507862035",
            "user": {
                "avatar_url": "https://avatars.githubusercontent.com/u/43296160?v=4",
                "events_url": "https://api.github.com/users/sirasagi62/events{/privacy}",
                "followers_url": "https://api.github.com/users/sirasagi62/followers",
                "following_url": "https://api.github.com/users/sirasagi62/following{/other_user}",
                "gists_url": "https://api.github.com/users/sirasagi62/gists{/gist_id}",
                "gravatar_id": "",
                "html_url": "https://github.com/sirasagi62",
                "id": 43296160,
                "login": "sirasagi62",
                "node_id": "MDQ6VXNlcjQzMjk2MTYw",
                "organizations_url": "https://api.github.com/users/sirasagi62/orgs",
                "received_events_url": "https://api.github.com/users/sirasagi62/received_events",
                "repos_url": "https://api.github.com/users/sirasagi62/repos",
                "site_admin": false,
                "starred_url": "https://api.github.com/users/sirasagi62/starred{/owner}{/repo}",
                "subscriptions_url": "https://api.github.com/users/sirasagi62/subscriptions",
                "type": "User",
                "url": "https://api.github.com/users/sirasagi62",
                "user_view_type": "public"
            }
        },
        {
            "author_association": "MEMBER",
            "body": "Returning an empty string in `vim.on_key()` callback only discards a single key. I think you should do this:\n```lua\nlocal prev_t = ''\n\nvim.on_key(function(k, t)\n  t = #t > 0 and t or prev_t\n  prev_t = t\n  if t == \"a\" or t==\"b\" or t==\"c\" or t==\"d\" or t==\"e\" then\n    -- Swallow the key by returning an empty string\n    return \"\"\n  end\n  -- Let other keys pass through\n  -- return nil\nend)\n```\n\nHowever, for `<Cmd>` (and K_LUA) the current behavior probably still should be changed, as when the `<Cmd>` key isn't discarded by the callback it doesn't receive the following keys (until after the `<CR>`) either. I'm not sure about this...",
            "created_at": "2025-11-09T10:13:12Z",
            "html_url": "https://github.com/neovim/neovim/issues/36480#issuecomment-3507897954",
            "id": 3507897954,
            "issue_url": "https://api.github.com/repos/neovim/neovim/issues/36480",
            "node_id": "IC_kwDOAPphoM7RFkZi",
            "performed_via_github_app": null,
            "reactions": {
                "+1": 1,
                "-1": 0,
                "confused": 0,
                "eyes": 0,
                "heart": 0,
                "hooray": 0,
                "laugh": 0,
                "rocket": 0,
                "total_count": 1,
                "url": "https://api.github.com/repos/neovim/neovim/issues/comments/3507897954/reactions"
            },
            "updated_at": "2025-11-09T10:16:44Z",
            "url": "https://api.github.com/repos/neovim/neovim/issues/comments/3507897954",
            "user": {
                "avatar_url": "https://avatars.githubusercontent.com/u/35768171?v=4",
                "events_url": "https://api.github.com/users/zeertzjq/events{/privacy}",
                "followers_url": "https://api.github.com/users/zeertzjq/followers",
                "following_url": "https://api.github.com/users/zeertzjq/following{/other_user}",
                "gists_url": "https://api.github.com/users/zeertzjq/gists{/gist_id}",
                "gravatar_id": "",
                "html_url": "https://github.com/zeertzjq",
                "id": 35768171,
                "login": "zeertzjq",
                "node_id": "MDQ6VXNlcjM1NzY4MTcx",
                "organizations_url": "https://api.github.com/users/zeertzjq/orgs",
                "received_events_url": "https://api.github.com/users/zeertzjq/received_events",
                "repos_url": "https://api.github.com/users/zeertzjq/repos",
                "site_admin": false,
                "starred_url": "https://api.github.com/users/zeertzjq/starred{/owner}{/repo}",
                "subscriptions_url": "https://api.github.com/users/zeertzjq/subscriptions",
                "type": "User",
                "url": "https://api.github.com/users/zeertzjq",
                "user_view_type": "public"
            }
        },
        {
            "author_association": "NONE",
            "body": "I finally realized that I had misinterpreted the documentation.\n\nRegarding the use of `<cmd>`, it does indeed refer to \"every key,\" so while the behavior is quite unexpected, it does match the documentation. However, for Lua functions, the call is based on an internal representation of the mapping that the user cannot know, so it seems like the behavior should be changed.\n\nI think the documentation for on_key should be updated, perhaps by adding some examples.\n\nThank you.",
            "created_at": "2025-11-09T11:14:29Z",
            "html_url": "https://github.com/neovim/neovim/issues/36480#issuecomment-3508011506",
            "id": 3508011506,
            "issue_url": "https://api.github.com/repos/neovim/neovim/issues/36480",
            "node_id": "IC_kwDOAPphoM7RGAHy",
            "performed_via_github_app": null,
            "reactions": {
                "+1": 0,
                "-1": 0,
                "confused": 0,
                "eyes": 0,
                "heart": 0,
                "hooray": 0,
                "laugh": 0,
                "rocket": 0,
                "total_count": 0,
                "url": "https://api.github.com/repos/neovim/neovim/issues/comments/3508011506/reactions"
            },
            "updated_at": "2025-11-09T11:14:29Z",
            "url": "https://api.github.com/repos/neovim/neovim/issues/comments/3508011506",
            "user": {
                "avatar_url": "https://avatars.githubusercontent.com/u/43296160?v=4",
                "events_url": "https://api.github.com/users/sirasagi62/events{/privacy}",
                "followers_url": "https://api.github.com/users/sirasagi62/followers",
                "following_url": "https://api.github.com/users/sirasagi62/following{/other_user}",
                "gists_url": "https://api.github.com/users/sirasagi62/gists{/gist_id}",
                "gravatar_id": "",
                "html_url": "https://github.com/sirasagi62",
                "id": 43296160,
                "login": "sirasagi62",
                "node_id": "MDQ6VXNlcjQzMjk2MTYw",
                "organizations_url": "https://api.github.com/users/sirasagi62/orgs",
                "received_events_url": "https://api.github.com/users/sirasagi62/received_events",
                "repos_url": "https://api.github.com/users/sirasagi62/repos",
                "site_admin": false,
                "starred_url": "https://api.github.com/users/sirasagi62/starred{/owner}{/repo}",
                "subscriptions_url": "https://api.github.com/users/sirasagi62/subscriptions",
                "type": "User",
                "url": "https://api.github.com/users/sirasagi62",
                "user_view_type": "public"
            }
        }
    ],
    "comments": 4,
    "comments_url": "https://api.github.com/repos/neovim/neovim/issues/36480/comments",
    "created_at": "2025-11-08T15:04:05Z",
    "events_url": "https://api.github.com/repos/neovim/neovim/issues/36480/events",
    "html_url": "https://github.com/neovim/neovim/issues/36480",
    "id": 3603646544,
    "issue_dependencies_summary": {
        "blocked_by": 0,
        "blocking": 0,
        "total_blocked_by": 0,
        "total_blocking": 0
    },
    "labels": [
        {
            "color": "c5def5",
            "default": false,
            "description": null,
            "id": 396626349,
            "name": "input",
            "node_id": "MDU6TGFiZWwzOTY2MjYzNDk=",
            "url": "https://api.github.com/repos/neovim/neovim/labels/input"
        }
    ],
    "labels_url": "https://api.github.com/repos/neovim/neovim/issues/36480/labels{/name}",
    "locked": false,
    "milestone": {
        "closed_at": null,
        "closed_issues": 163,
        "created_at": "2024-05-16T14:11:54Z",
        "creator": {
            "avatar_url": "https://avatars.githubusercontent.com/u/1359421?v=4",
            "events_url": "https://api.github.com/users/justinmk/events{/privacy}",
            "followers_url": "https://api.github.com/users/justinmk/followers",
            "following_url": "https://api.github.com/users/justinmk/following{/other_user}",
            "gists_url": "https://api.github.com/users/justinmk/gists{/gist_id}",
            "gravatar_id": "",
            "html_url": "https://github.com/justinmk",
            "id": 1359421,
            "login": "justinmk",
            "node_id": "MDQ6VXNlcjEzNTk0MjE=",
            "organizations_url": "https://api.github.com/users/justinmk/orgs",
            "received_events_url": "https://api.github.com/users/justinmk/received_events",
            "repos_url": "https://api.github.com/users/justinmk/repos",
            "site_admin": false,
            "starred_url": "https://api.github.com/users/justinmk/starred{/owner}{/repo}",
            "subscriptions_url": "https://api.github.com/users/justinmk/subscriptions",
            "type": "User",
            "url": "https://api.github.com/users/justinmk",
            "user_view_type": "public"
        },
        "description": "",
        "due_on": "2025-12-25T08:00:00Z",
        "html_url": "https://github.com/neovim/neovim/milestone/43",
        "id": 11063573,
        "labels_url": "https://api.github.com/repos/neovim/neovim/milestones/43/labels",
        "node_id": "MI_kwDOAPphoM4AqNEV",
        "number": 43,
        "open_issues": 80,
        "state": "open",
        "title": "0.12",
        "updated_at": "2025-11-25T01:11:18Z",
        "url": "https://api.github.com/repos/neovim/neovim/milestones/43"
    },
    "node_id": "I_kwDOAPphoM7Wy0hQ",
    "number": 36480,
    "performed_via_github_app": null,
    "reactions": {
        "+1": 0,
        "-1": 0,
        "confused": 0,
        "eyes": 0,
        "heart": 0,
        "hooray": 0,
        "laugh": 0,
        "rocket": 0,
        "total_count": 0,
        "url": "https://api.github.com/repos/neovim/neovim/issues/36480/reactions"
    },
    "repository_url": "https://api.github.com/repos/neovim/neovim",
    "state": "closed",
    "state_reason": "completed",
    "sub_issues_summary": {
        "completed": 0,
        "percent_completed": 0,
        "total": 0
    },
    "timeline_url": "https://api.github.com/repos/neovim/neovim/issues/36480/timeline",
    "title": "Improper key discard in `vim.on_key` leads to spurious input",
    "type": {
        "color": "red",
        "created_at": "2024-01-25T10:10:19Z",
        "description": "An unexpected problem or behavior",
        "id": 597163,
        "is_enabled": true,
        "name": "Bug",
        "node_id": "IT_kwDOAGK_Pc4ACRyr",
        "updated_at": "2024-07-26T10:12:30Z"
    },
    "updated_at": "2025-11-20T06:16:04Z",
    "url": "https://api.github.com/repos/neovim/neovim/issues/36480",
    "user": {
        "avatar_url": "https://avatars.githubusercontent.com/u/43296160?v=4",
        "events_url": "https://api.github.com/users/sirasagi62/events{/privacy}",
        "followers_url": "https://api.github.com/users/sirasagi62/followers",
        "following_url": "https://api.github.com/users/sirasagi62/following{/other_user}",
        "gists_url": "https://api.github.com/users/sirasagi62/gists{/gist_id}",
        "gravatar_id": "",
        "html_url": "https://github.com/sirasagi62",
        "id": 43296160,
        "login": "sirasagi62",
        "node_id": "MDQ6VXNlcjQzMjk2MTYw",
        "organizations_url": "https://api.github.com/users/sirasagi62/orgs",
        "received_events_url": "https://api.github.com/users/sirasagi62/received_events",
        "repos_url": "https://api.github.com/users/sirasagi62/repos",
        "site_admin": false,
        "starred_url": "https://api.github.com/users/sirasagi62/starred{/owner}{/repo}",
        "subscriptions_url": "https://api.github.com/users/sirasagi62/subscriptions",
        "type": "User",
        "url": "https://api.github.com/users/sirasagi62",
        "user_view_type": "public"
    }
}