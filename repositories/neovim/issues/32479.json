{
    "active_lock_reason": null,
    "assignee": null,
    "assignees": [],
    "author_association": "MEMBER",
    "body": "### Problem\n\nhttps://github.com/neovim/neovim/pull/32082/commits/8543aa406c4ae88cc928372b2f8105005cdd0a80 introduced a check against the number of valid regions to determine whether all regions are valid (to maintain an optimization in the language tree when all regions were parsed). This relied on the (wrong) assumption by me that table length for tables with holes is calculated from one until the first nil index. Actually, this is undefined behavior. You can have something like this:\n\n```lua\nlocal mytable = {\n  [6] = true,\n  [7] = true,\n  [8] = true,\n}\n\nassert(#mytable == 8)\n```\n\nwhich means that the language tree incorrectly thinks all regions are valid, even though only 6, 7, and 8 are valid. This manifests as some injections not applying until being edited.\n\n### Steps to reproduce\n\nOpen a file with sparse injections (such that only one or two are on screen at a time):\n\n<details>\n\n```lua\n-- file.lua\nvim.treesitter.query.set('c', 'highlights', [[(node) @capture]])\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\nvim.treesitter.query.set('c', 'highlights', [[(node) @capture]])\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\nvim.treesitter.query.set('c', 'highlights', [[(node) @capture]])\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\nvim.treesitter.query.set('c', 'highlights', [[(node) @capture]])\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\nvim.treesitter.query.set('c', 'highlights', [[(node) @capture]])\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\nvim.treesitter.query.set('c', 'highlights', [[(node) @capture]])\n```\n\n</details>\n\n`nvim --clean file.lua +'norm G'`\n\nscroll back up and observe not all injections are highlighted\n\n### Expected behavior\n\nAll injections should be processed properly\n\n### Nvim version (nvim -v)\n\nNVIM v0.11.0-nightly+c7d13f2\n\n### Vim (not Nvim) behaves the same?\n\nNA\n\n### Operating system/version\n\nNixOS 25.05\n\n### Terminal name/version\n\nghostty 1.1.0\n\n### $TERM environment variable\n\nxterm-ghostty\n\n### Installation\n\nnixos nightly overlay",
    "closed_at": "2025-02-17T15:13:27Z",
    "closed_by": {
        "avatar_url": "https://avatars.githubusercontent.com/u/7904185?v=4",
        "events_url": "https://api.github.com/users/lewis6991/events{/privacy}",
        "followers_url": "https://api.github.com/users/lewis6991/followers",
        "following_url": "https://api.github.com/users/lewis6991/following{/other_user}",
        "gists_url": "https://api.github.com/users/lewis6991/gists{/gist_id}",
        "gravatar_id": "",
        "html_url": "https://github.com/lewis6991",
        "id": 7904185,
        "login": "lewis6991",
        "node_id": "MDQ6VXNlcjc5MDQxODU=",
        "organizations_url": "https://api.github.com/users/lewis6991/orgs",
        "received_events_url": "https://api.github.com/users/lewis6991/received_events",
        "repos_url": "https://api.github.com/users/lewis6991/repos",
        "site_admin": false,
        "starred_url": "https://api.github.com/users/lewis6991/starred{/owner}{/repo}",
        "subscriptions_url": "https://api.github.com/users/lewis6991/subscriptions",
        "type": "User",
        "url": "https://api.github.com/users/lewis6991",
        "user_view_type": "public"
    },
    "comment_data": [
        {
            "author_association": "MEMBER",
            "body": "Yes, `#length` of a \"sparse array\" is undefined (implementation specific: it's the first `nil` the interpreter _encounters_; for LuaJIT, which seems to use a binary search, this differs based on whether the hole is in an even or odd positions, while PUC Lua seems to use a linear search and behave \"as expected\").\n\nThis is why `:h vim.tbl_count()` is a thing.",
            "created_at": "2025-02-16T16:33:27Z",
            "html_url": "https://github.com/neovim/neovim/issues/32479#issuecomment-2661513723",
            "id": 2661513723,
            "issue_url": "https://api.github.com/repos/neovim/neovim/issues/32479",
            "node_id": "IC_kwDOAPphoM6eo3n7",
            "performed_via_github_app": null,
            "reactions": {
                "+1": 1,
                "-1": 0,
                "confused": 0,
                "eyes": 0,
                "heart": 0,
                "hooray": 0,
                "laugh": 0,
                "rocket": 0,
                "total_count": 1,
                "url": "https://api.github.com/repos/neovim/neovim/issues/comments/2661513723/reactions"
            },
            "updated_at": "2025-02-16T16:33:27Z",
            "url": "https://api.github.com/repos/neovim/neovim/issues/comments/2661513723",
            "user": {
                "avatar_url": "https://avatars.githubusercontent.com/u/2361214?v=4",
                "events_url": "https://api.github.com/users/clason/events{/privacy}",
                "followers_url": "https://api.github.com/users/clason/followers",
                "following_url": "https://api.github.com/users/clason/following{/other_user}",
                "gists_url": "https://api.github.com/users/clason/gists{/gist_id}",
                "gravatar_id": "",
                "html_url": "https://github.com/clason",
                "id": 2361214,
                "login": "clason",
                "node_id": "MDQ6VXNlcjIzNjEyMTQ=",
                "organizations_url": "https://api.github.com/users/clason/orgs",
                "received_events_url": "https://api.github.com/users/clason/received_events",
                "repos_url": "https://api.github.com/users/clason/repos",
                "site_admin": false,
                "starred_url": "https://api.github.com/users/clason/starred{/owner}{/repo}",
                "subscriptions_url": "https://api.github.com/users/clason/subscriptions",
                "type": "User",
                "url": "https://api.github.com/users/clason",
                "user_view_type": "public"
            }
        }
    ],
    "comments": 1,
    "comments_url": "https://api.github.com/repos/neovim/neovim/issues/32479/comments",
    "created_at": "2025-02-16T16:27:25Z",
    "events_url": "https://api.github.com/repos/neovim/neovim/issues/32479/events",
    "html_url": "https://github.com/neovim/neovim/issues/32479",
    "id": 2856195765,
    "labels": [],
    "labels_url": "https://api.github.com/repos/neovim/neovim/issues/32479/labels{/name}",
    "locked": false,
    "milestone": null,
    "node_id": "I_kwDOAPphoM6qPha1",
    "number": 32479,
    "performed_via_github_app": null,
    "reactions": {
        "+1": 0,
        "-1": 0,
        "confused": 0,
        "eyes": 0,
        "heart": 0,
        "hooray": 0,
        "laugh": 0,
        "rocket": 0,
        "total_count": 0,
        "url": "https://api.github.com/repos/neovim/neovim/issues/32479/reactions"
    },
    "repository_url": "https://api.github.com/repos/neovim/neovim",
    "state": "closed",
    "state_reason": "completed",
    "sub_issues_summary": {
        "completed": 0,
        "percent_completed": 0,
        "total": 0
    },
    "timeline_url": "https://api.github.com/repos/neovim/neovim/issues/32479/timeline",
    "title": "Language tree falsely marked as fully valid",
    "updated_at": "2025-02-17T15:13:27Z",
    "url": "https://api.github.com/repos/neovim/neovim/issues/32479",
    "user": {
        "avatar_url": "https://avatars.githubusercontent.com/u/55766287?v=4",
        "events_url": "https://api.github.com/users/ribru17/events{/privacy}",
        "followers_url": "https://api.github.com/users/ribru17/followers",
        "following_url": "https://api.github.com/users/ribru17/following{/other_user}",
        "gists_url": "https://api.github.com/users/ribru17/gists{/gist_id}",
        "gravatar_id": "",
        "html_url": "https://github.com/ribru17",
        "id": 55766287,
        "login": "ribru17",
        "node_id": "MDQ6VXNlcjU1NzY2Mjg3",
        "organizations_url": "https://api.github.com/users/ribru17/orgs",
        "received_events_url": "https://api.github.com/users/ribru17/received_events",
        "repos_url": "https://api.github.com/users/ribru17/repos",
        "site_admin": false,
        "starred_url": "https://api.github.com/users/ribru17/starred{/owner}{/repo}",
        "subscriptions_url": "https://api.github.com/users/ribru17/subscriptions",
        "type": "User",
        "url": "https://api.github.com/users/ribru17",
        "user_view_type": "public"
    }
}