{
    "active_lock_reason": null,
    "assignee": null,
    "assignees": [],
    "author_association": "CONTRIBUTOR",
    "body": "### Problem\n\nI've found three related data loss bugs in neovim 0.11.5, all relating to writing a buffer that contains some invalid UTF-8 byte sequences, when converting to latin1 encoding. This investigation was set off by a [bug report](https://github.com/RaafatTurki/hex.nvim/issues/30) for the `hex.nvim` plugin.\n\nEach of these three bugs requires the buffer to contain bytes that are not valid in UTF-8. I'm not entirely sure if that state is expected to be possible or correctly preserve the bytes on write, but I'm assuming that the bytes should be preserved.\n\n## Bug 1: Dropping Bytes at the End of the File\n\nIn this scenario, the saved file is missing bytes at the end.\n\n### Repro Steps\n\n    $ echo -n -e \"\\\\xA3\\\\xFB\" > test-file\n    $ nvim --clean test-file\n\n    :set binary\n    :%!cat\n    :write\n\nExpected result: The file contains the same two bytes that were originally written to it.\n\nActual result: The file contains one byte, 0xA3.\n\n### Observations\n\nWhen opened, the file is auto-detected as latin1, as reported by `:set fileencoding?`.\n\nFollowing the `cat`, the appearance of the buffer on-screen changes from two characters from the latin1 character set to two angle-bracketed hex codes: `<a3><fb>`. My understanding is that this indicates that the buffer actually contains these two bytes, rather than the proper UTF-8 sequences that would be used to represent the characters. I've used this technique to introduce invalid UTF-8 sequences in all the repro instructions in this report. It's not clear to me whether this behavior is itself a bug.\n\n### Explanation\n\nIn `bufwrite.c`, when `buf_write_convert` reaches the `0xFB` byte, `utf_ptr2len_len` reports that it requires 5 bytes to complete the character. These bytes are not available, so `bw_rest` is used to store the last byte until a future call provides the missing bytes.\n\nThis is the end of the buffer. No further calls to `buf_write_convert` are made, and the byte stored in `bw_rest` is never written to the output.\n\nMore than one byte can be lost if the byte sequence that ends the file is close enough to being a valid UTF-8 character sequence, but is missing at least the last continuation byte. For example, replacing the `echo` command in the repro with this:\n\n    $ echo -n -e \"\\\\xA3\\\\xFB\\\\x80\\\\x80\\\\x80\" > test-file\n\nUsing that test file, four bytes are lost when writing.\n\n## Bug 2: All File Bytes Replaced With Last Byte\n\nIn this scenario, the entire content of the file is overwritten with the final byte of the file.\n\n### Repro Steps\n\n    $ echo -n -e \"Important information\\\\xFB\" > test-file\n    $ nvim --clean -b\n\n    :edit ++enc=latin1 test-file\n    :%!cat\n    :set nowritebackup\n    :write\n\nExpected results: file content should be identical to the original file written with the `echo` command.\n\nActual results: File length is unchanged, but every byte is 0xFB.\n\n### Explanation\n\nSimilar to the previous case, `buf_write_convert` reaches the last byte, finds that it requires additional bytes to complete the UTF-8 character, and stores the byte in `bw_rest` to be used on the next call. This happens during the conversion test phase, which runs due to `writebackup` being turned off. As before, this is the end of the buffer, and the content of `bw_rest` doesn't get consumed.\n\nWhen the \"real\" conversion starts, `bw_rest` still contains the 0xFB byte. On the first call to `buf_write_convert`, it sees that there's a remainder from a previous call in `bw_rest` and writes that byte to its output buffer. (I'm skipping over a step here, where `utf_ptr2len_len` determines based on future bytes that the 0xFB byte is not followed by any UTF-8 continuation bytes, so the byte gets written as-is).\n\nThe problem here is that `buf_write_convert` is performing its conversion in-place. The output buffer and the input buffer are the same. In writing the 0xFB from `bw_rest` to the output buffer, it has also overwritten the first byte of its input buffer, and it still needs that byte. The next iteration of the big `for` loop won't advance `wlen` because no bytes have been consumed from the input buffer yet. From here on, `buf_write_convert` is writing to locations in the buffer that it hasn't read from yet, so it constantly copies the byte it just wrote into the next position in the buffer.\n\n## Bug 3: Bytes Starting in the Middle of a File are Replaced\n\nIn this scenario, an invalid UTF-8 sequence at a specific buffer location causes the remainder of the file to be overwritten with the first byte of the invalid sequence.\n\n### Repro Steps\n\nCreate a test file by running this Python script:\n\n    #!/usr/bin/env python3\n\n    import string\n\n    data = bytearray([ord(string.hexdigits[i % 16]) for i in range(9 * 1024)])\n\n    data[8191] = 0xFB\n\n    with open('buffer-test', 'wb') as f:\n        _ = f.write(data)\n\nThen perform the following steps:\n\n    $ nvim --clean -b\n\n    :edit ++enc=latin1 buffer-test\n    :%!cat\n    :write\n\nExpected results: The file content should be the same as it was after running the Python script.\n\nActual results: The last kibibyte of the file has been overwritten with 0xFB.\n\n### Explanation\n\nThis is kind of a variation on the previous bug. `buf_write` uses an 8 KiB buffer (usually) for the file bytes as it reads them in. When the buffer is full, it calls `buf_write_bytes` to convert and write the bytes to the destination. `buf_write_bytes` calls `buf_write_convert`, and when it reaches the last byte of the buffer, it finds 0xFB, which it interprets as the start of a UTF-8 multi-byte character. Being at the end of its input buffer, it doesn't have the bytes to complete the sequence and it stores the 0xFB in `bw_rest` for use in a later call.\n\nThe next time `buf_write_convert` is called, things play out like they did in the previous bug. The new buffer doesn't contain any UTF-8 continuation bytes at the beginning, so the byte that was previously stored in `bw_rest` gets written to the output buffer as-is. Like before, the output buffer *is* the input buffer, and the position that the byte was just written to is a position that has yet to be read from. From here on every time the function reads a byte from its input buffer, it's reading the last byte it wrote, and every time it writes to its output it is overwriting the next byte it was supposed to read.\n\n\n### Steps to reproduce\n\nSee detailed steps in the problem description.\n\n### Expected behavior\n\nSee details in the problem description\n\n### Nvim version (nvim -v)\n\n0.11.5\n\n### Vim (not Nvim) behaves the same?\n\nYes, Vim 9.0 has the same behavior\n\n### Operating system/version\n\nDebian GNU/Linux 12\n\n### Terminal name/version\n\nkitty 0.26.5\n\n### $TERM environment variable\n\nxterm-kitty\n\n### Installation\n\nAppimage, also built from source",
    "closed_at": "2026-02-12T22:38:13Z",
    "closed_by": {
        "avatar_url": "https://avatars.githubusercontent.com/u/1359421?v=4",
        "events_url": "https://api.github.com/users/justinmk/events{/privacy}",
        "followers_url": "https://api.github.com/users/justinmk/followers",
        "following_url": "https://api.github.com/users/justinmk/following{/other_user}",
        "gists_url": "https://api.github.com/users/justinmk/gists{/gist_id}",
        "gravatar_id": "",
        "html_url": "https://github.com/justinmk",
        "id": 1359421,
        "login": "justinmk",
        "node_id": "MDQ6VXNlcjEzNTk0MjE=",
        "organizations_url": "https://api.github.com/users/justinmk/orgs",
        "received_events_url": "https://api.github.com/users/justinmk/received_events",
        "repos_url": "https://api.github.com/users/justinmk/repos",
        "site_admin": false,
        "starred_url": "https://api.github.com/users/justinmk/starred{/owner}{/repo}",
        "subscriptions_url": "https://api.github.com/users/justinmk/subscriptions",
        "type": "User",
        "url": "https://api.github.com/users/justinmk",
        "user_view_type": "public"
    },
    "comment_data": [
        {
            "author_association": "CONTRIBUTOR",
            "body": "The first two bugs seem like they could be solved in a similar way, by handling `bw_rest` at the end of writing (and in the process setting `bw_restlen` to 0). The third seems a lot more tricky. Fundamentally `bw_write_convert` is being asked to deal with more bytes than its output has capacity for, because its input is the same size as its output, plus whatever is in `bw_rest`.",
            "created_at": "2025-12-16T01:04:41Z",
            "html_url": "https://github.com/neovim/neovim/issues/36990#issuecomment-3658249232",
            "id": 3658249232,
            "issue_url": "https://api.github.com/repos/neovim/neovim/issues/36990",
            "node_id": "IC_kwDOAPphoM7aDHQQ",
            "performed_via_github_app": null,
            "pin": null,
            "reactions": {
                "+1": 0,
                "-1": 0,
                "confused": 0,
                "eyes": 0,
                "heart": 0,
                "hooray": 0,
                "laugh": 0,
                "rocket": 0,
                "total_count": 0,
                "url": "https://api.github.com/repos/neovim/neovim/issues/comments/3658249232/reactions"
            },
            "updated_at": "2025-12-16T01:04:41Z",
            "url": "https://api.github.com/repos/neovim/neovim/issues/comments/3658249232",
            "user": {
                "avatar_url": "https://avatars.githubusercontent.com/u/58675?v=4",
                "events_url": "https://api.github.com/users/KevinGoodsell/events{/privacy}",
                "followers_url": "https://api.github.com/users/KevinGoodsell/followers",
                "following_url": "https://api.github.com/users/KevinGoodsell/following{/other_user}",
                "gists_url": "https://api.github.com/users/KevinGoodsell/gists{/gist_id}",
                "gravatar_id": "",
                "html_url": "https://github.com/KevinGoodsell",
                "id": 58675,
                "login": "KevinGoodsell",
                "node_id": "MDQ6VXNlcjU4Njc1",
                "organizations_url": "https://api.github.com/users/KevinGoodsell/orgs",
                "received_events_url": "https://api.github.com/users/KevinGoodsell/received_events",
                "repos_url": "https://api.github.com/users/KevinGoodsell/repos",
                "site_admin": false,
                "starred_url": "https://api.github.com/users/KevinGoodsell/starred{/owner}{/repo}",
                "subscriptions_url": "https://api.github.com/users/KevinGoodsell/subscriptions",
                "type": "User",
                "url": "https://api.github.com/users/KevinGoodsell",
                "user_view_type": "public"
            }
        },
        {
            "author_association": "CONTRIBUTOR",
            "body": "Note: the repro steps don't work on current builds because of the new 'shelltemp' default, 'shelltemp' has to be enabled for the repro to work, as it changes the `:%!cat` behavior.",
            "created_at": "2026-01-11T19:52:35Z",
            "html_url": "https://github.com/neovim/neovim/issues/36990#issuecomment-3735603596",
            "id": 3735603596,
            "issue_url": "https://api.github.com/repos/neovim/neovim/issues/36990",
            "node_id": "IC_kwDOAPphoM7eqMmM",
            "performed_via_github_app": null,
            "pin": null,
            "reactions": {
                "+1": 0,
                "-1": 0,
                "confused": 0,
                "eyes": 0,
                "heart": 0,
                "hooray": 0,
                "laugh": 0,
                "rocket": 0,
                "total_count": 0,
                "url": "https://api.github.com/repos/neovim/neovim/issues/comments/3735603596/reactions"
            },
            "updated_at": "2026-01-11T19:53:58Z",
            "url": "https://api.github.com/repos/neovim/neovim/issues/comments/3735603596",
            "user": {
                "avatar_url": "https://avatars.githubusercontent.com/u/58675?v=4",
                "events_url": "https://api.github.com/users/KevinGoodsell/events{/privacy}",
                "followers_url": "https://api.github.com/users/KevinGoodsell/followers",
                "following_url": "https://api.github.com/users/KevinGoodsell/following{/other_user}",
                "gists_url": "https://api.github.com/users/KevinGoodsell/gists{/gist_id}",
                "gravatar_id": "",
                "html_url": "https://github.com/KevinGoodsell",
                "id": 58675,
                "login": "KevinGoodsell",
                "node_id": "MDQ6VXNlcjU4Njc1",
                "organizations_url": "https://api.github.com/users/KevinGoodsell/orgs",
                "received_events_url": "https://api.github.com/users/KevinGoodsell/received_events",
                "repos_url": "https://api.github.com/users/KevinGoodsell/repos",
                "site_admin": false,
                "starred_url": "https://api.github.com/users/KevinGoodsell/starred{/owner}{/repo}",
                "subscriptions_url": "https://api.github.com/users/KevinGoodsell/subscriptions",
                "type": "User",
                "url": "https://api.github.com/users/KevinGoodsell",
                "user_view_type": "public"
            }
        }
    ],
    "comments": 2,
    "comments_url": "https://api.github.com/repos/neovim/neovim/issues/36990/comments",
    "created_at": "2025-12-16T00:57:07Z",
    "events_url": "https://api.github.com/repos/neovim/neovim/issues/36990/events",
    "html_url": "https://github.com/neovim/neovim/issues/36990",
    "id": 3732667769,
    "issue_dependencies_summary": {
        "blocked_by": 0,
        "blocking": 0,
        "total_blocked_by": 0,
        "total_blocking": 0
    },
    "labels": [
        {
            "color": "F9D0C4",
            "default": false,
            "description": "wrong behavior inherited from vim",
            "id": 154310492,
            "name": "bug-vim",
            "node_id": "MDU6TGFiZWwxNTQzMTA0OTI=",
            "url": "https://api.github.com/repos/neovim/neovim/labels/bug-vim"
        },
        {
            "color": "c5def5",
            "default": false,
            "description": "",
            "id": 158930125,
            "name": "encoding",
            "node_id": "MDU6TGFiZWwxNTg5MzAxMjU=",
            "url": "https://api.github.com/repos/neovim/neovim/labels/encoding"
        },
        {
            "color": "c5def5",
            "default": false,
            "description": null,
            "id": 378639615,
            "name": "io",
            "node_id": "MDU6TGFiZWwzNzg2Mzk2MTU=",
            "url": "https://api.github.com/repos/neovim/neovim/labels/io"
        }
    ],
    "labels_url": "https://api.github.com/repos/neovim/neovim/issues/36990/labels{/name}",
    "locked": false,
    "milestone": {
        "closed_at": null,
        "closed_issues": 250,
        "created_at": "2024-05-16T14:11:54Z",
        "creator": {
            "avatar_url": "https://avatars.githubusercontent.com/u/1359421?v=4",
            "events_url": "https://api.github.com/users/justinmk/events{/privacy}",
            "followers_url": "https://api.github.com/users/justinmk/followers",
            "following_url": "https://api.github.com/users/justinmk/following{/other_user}",
            "gists_url": "https://api.github.com/users/justinmk/gists{/gist_id}",
            "gravatar_id": "",
            "html_url": "https://github.com/justinmk",
            "id": 1359421,
            "login": "justinmk",
            "node_id": "MDQ6VXNlcjEzNTk0MjE=",
            "organizations_url": "https://api.github.com/users/justinmk/orgs",
            "received_events_url": "https://api.github.com/users/justinmk/received_events",
            "repos_url": "https://api.github.com/users/justinmk/repos",
            "site_admin": false,
            "starred_url": "https://api.github.com/users/justinmk/starred{/owner}{/repo}",
            "subscriptions_url": "https://api.github.com/users/justinmk/subscriptions",
            "type": "User",
            "url": "https://api.github.com/users/justinmk",
            "user_view_type": "public"
        },
        "description": "",
        "due_on": "2026-03-14T00:00:00Z",
        "html_url": "https://github.com/neovim/neovim/milestone/43",
        "id": 11063573,
        "labels_url": "https://api.github.com/repos/neovim/neovim/milestones/43/labels",
        "node_id": "MI_kwDOAPphoM4AqNEV",
        "number": 43,
        "open_issues": 52,
        "state": "open",
        "title": "0.12",
        "updated_at": "2026-02-16T22:39:00Z",
        "url": "https://api.github.com/repos/neovim/neovim/milestones/43"
    },
    "node_id": "I_kwDOAPphoM7ee_15",
    "number": 36990,
    "performed_via_github_app": null,
    "pinned_comment": null,
    "reactions": {
        "+1": 1,
        "-1": 0,
        "confused": 0,
        "eyes": 0,
        "heart": 0,
        "hooray": 0,
        "laugh": 0,
        "rocket": 0,
        "total_count": 1,
        "url": "https://api.github.com/repos/neovim/neovim/issues/36990/reactions"
    },
    "repository_url": "https://api.github.com/repos/neovim/neovim",
    "state": "closed",
    "state_reason": "completed",
    "sub_issues_summary": {
        "completed": 0,
        "percent_completed": 0,
        "total": 0
    },
    "timeline_url": "https://api.github.com/repos/neovim/neovim/issues/36990/timeline",
    "title": "data loss when converting incomplete UTF-8 characters to latin1",
    "type": {
        "color": "red",
        "created_at": "2024-01-25T10:10:19Z",
        "description": "An unexpected problem or behavior",
        "id": 597163,
        "is_enabled": true,
        "name": "Bug",
        "node_id": "IT_kwDOAGK_Pc4ACRyr",
        "updated_at": "2024-07-26T10:12:30Z"
    },
    "updated_at": "2026-02-12T22:38:13Z",
    "url": "https://api.github.com/repos/neovim/neovim/issues/36990",
    "user": {
        "avatar_url": "https://avatars.githubusercontent.com/u/58675?v=4",
        "events_url": "https://api.github.com/users/KevinGoodsell/events{/privacy}",
        "followers_url": "https://api.github.com/users/KevinGoodsell/followers",
        "following_url": "https://api.github.com/users/KevinGoodsell/following{/other_user}",
        "gists_url": "https://api.github.com/users/KevinGoodsell/gists{/gist_id}",
        "gravatar_id": "",
        "html_url": "https://github.com/KevinGoodsell",
        "id": 58675,
        "login": "KevinGoodsell",
        "node_id": "MDQ6VXNlcjU4Njc1",
        "organizations_url": "https://api.github.com/users/KevinGoodsell/orgs",
        "received_events_url": "https://api.github.com/users/KevinGoodsell/received_events",
        "repos_url": "https://api.github.com/users/KevinGoodsell/repos",
        "site_admin": false,
        "starred_url": "https://api.github.com/users/KevinGoodsell/starred{/owner}{/repo}",
        "subscriptions_url": "https://api.github.com/users/KevinGoodsell/subscriptions",
        "type": "User",
        "url": "https://api.github.com/users/KevinGoodsell",
        "user_view_type": "public"
    }
}