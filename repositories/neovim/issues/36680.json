{
    "active_lock_reason": null,
    "assignee": null,
    "assignees": [],
    "author_association": "NONE",
    "body": "### Problem\n\nWhen a language server provides the `relatedInformation` key in its diagnostics but sets it to `null`/`vim.NIL`, `vim.diagnostic.open_float()` crashes with the following error:\n\n```\nvim.schedule callback: ...m/HEAD-01a9765/share/nvim/runtime/lua/vim/diagnostic.lua:2515: bad argument #1 to 'ipairs' (table expected, got userdata)\nstack traceback:\n\t[C]: in function 'ipairs'\n\t...m/HEAD-01a9765/share/nvim/runtime/lua/vim/diagnostic.lua:2515: in function 'open_float'\n```\n\n`nimlangserver` in particular sends diagnostics this way.\n\nI'm able to work around this with the following code change, though I'm not familiar enough with the codebase to know if this is idiomatic or correct:\n\n```diff\ndiff --git a/runtime/lua/vim/diagnostic.lua b/runtime/lua/vim/diagnostic.lua\nindex a33ed7e082..24af95a58a 100644\n--- a/runtime/lua/vim/diagnostic.lua\n+++ b/runtime/lua/vim/diagnostic.lua\n@@ -2509,6 +2509,9 @@ function M.open_float(opts, ...)\n \n     ---@type lsp.DiagnosticRelatedInformation[]\n     local related_info = vim.tbl_get(diagnostic, 'user_data', 'lsp', 'relatedInformation') or {}\n+    if related_info == vim.NIL then\n+      related_info = {}\n+    end\n \n     -- Below the diagnostic, show its LSP related information (if any) in the form of file name and\n     -- range, plus description.\n```\n\nIf this is amenable to others (or would be amenable with changes/feedback), I'd be happy to submit a pull request.\n\n### Steps to reproduce using \"nvim --clean -u minimal_init.lua\"\n\nminimal_init.lua:\n\n```lua\nlocal pattern = 'nim'\nlocal cmd = {'nimlangserver'}\nlocal root_markers = {'.git', '.editorconfig'}\nlocal settings = vim.empty_dict()\n\nvim.api.nvim_create_autocmd('FileType', {\n  pattern = pattern,\n  callback = function(args)\n    local match = vim.fs.find(root_markers, { path = args.file, upward = true })[1]\n    local root_dir = match and vim.fn.fnamemodify(match, ':p:h') or nil\n    vim.lsp.start({\n      name = 'nimglangserver',\n      cmd = cmd,\n      root_dir = root_dir,\n      settings = settings\n    })\n  end\n})\n```\n\nfoo.nim:\n\n```nim\nvar c: char = 'c'\n```\n\nRun `git init` where foo.nim is, then run `nvim --clean -u minimal_init.lua foo.nim`.\n\nInside Neovim, run `:lua vim.diagnostic.open_float()` to trigger the error:\n\n```\nE5108: Lua: ...m/HEAD-01a9765/share/nvim/runtime/lua/vim/diagnostic.lua:2515: bad argument #1 to 'ip\nairs' (table expected, got userdata)\nstack traceback:\n        [C]: in function 'ipairs'\n        ...m/HEAD-01a9765/share/nvim/runtime/lua/vim/diagnostic.lua:2515: in function 'open_float'\n        [string \":lua\"]:1: in main chunk\n```\n\n### Expected behavior\n\nInstead of crashing, the diagnostic window is shown with the following:\n\n```\nnimsuggest chk: 'c' is declared but not used [XDeclaredButNotUsed]\n```\n\n### Nvim version (nvim -v)\n\nNVIM v0.12.0-dev-1684+g01a9765035-Homebrew\n\n### Language server name/version\n\nnimlangserver 1.12.0\n\n### Operating system/version\n\nmacOS 26.1\n\n### Log file\n\n_No response_",
    "closed_at": "2025-11-25T03:56:57Z",
    "closed_by": {
        "avatar_url": "https://avatars.githubusercontent.com/u/62502207?v=4",
        "events_url": "https://api.github.com/users/MariaSolOs/events{/privacy}",
        "followers_url": "https://api.github.com/users/MariaSolOs/followers",
        "following_url": "https://api.github.com/users/MariaSolOs/following{/other_user}",
        "gists_url": "https://api.github.com/users/MariaSolOs/gists{/gist_id}",
        "gravatar_id": "",
        "html_url": "https://github.com/MariaSolOs",
        "id": 62502207,
        "login": "MariaSolOs",
        "node_id": "MDQ6VXNlcjYyNTAyMjA3",
        "organizations_url": "https://api.github.com/users/MariaSolOs/orgs",
        "received_events_url": "https://api.github.com/users/MariaSolOs/received_events",
        "repos_url": "https://api.github.com/users/MariaSolOs/repos",
        "site_admin": false,
        "starred_url": "https://api.github.com/users/MariaSolOs/starred{/owner}{/repo}",
        "subscriptions_url": "https://api.github.com/users/MariaSolOs/subscriptions",
        "type": "User",
        "url": "https://api.github.com/users/MariaSolOs",
        "user_view_type": "public"
    },
    "comment_data": [
        {
            "author_association": "MEMBER",
            "body": "@aiiie For a second I forgot how TypeScript works but yeah this is a server bug.\n\nFrom the [spec](https://microsoft.github.io/language-server-protocol/specifications/lsp/3.18/specification/#diagnostic):\n```ts\n/**\n * An array of related diagnostic information, e.g. when symbol-names within\n * a scope collide all definitions can be marked via this property.\n */\n relatedInformation?: DiagnosticRelatedInformation[];\n```\n\nThe above TypeScript definition means that `relatedInformation` should either be entirely absent from the `diagnostic` object or set to an array of `DiagnosticRelatedInformation`. Something like `relatedInformation: null` violates the LSP (that would be allowed if the type was `DiagnosticRelatedInformation[] | null`).",
            "created_at": "2025-11-25T02:54:27Z",
            "html_url": "https://github.com/neovim/neovim/issues/36680#issuecomment-3573578621",
            "id": 3573578621,
            "issue_url": "https://api.github.com/repos/neovim/neovim/issues/36680",
            "node_id": "IC_kwDOAPphoM7VAHt9",
            "performed_via_github_app": null,
            "reactions": {
                "+1": 2,
                "-1": 0,
                "confused": 0,
                "eyes": 0,
                "heart": 0,
                "hooray": 0,
                "laugh": 0,
                "rocket": 0,
                "total_count": 2,
                "url": "https://api.github.com/repos/neovim/neovim/issues/comments/3573578621/reactions"
            },
            "updated_at": "2025-11-25T02:54:27Z",
            "url": "https://api.github.com/repos/neovim/neovim/issues/comments/3573578621",
            "user": {
                "avatar_url": "https://avatars.githubusercontent.com/u/62502207?v=4",
                "events_url": "https://api.github.com/users/MariaSolOs/events{/privacy}",
                "followers_url": "https://api.github.com/users/MariaSolOs/followers",
                "following_url": "https://api.github.com/users/MariaSolOs/following{/other_user}",
                "gists_url": "https://api.github.com/users/MariaSolOs/gists{/gist_id}",
                "gravatar_id": "",
                "html_url": "https://github.com/MariaSolOs",
                "id": 62502207,
                "login": "MariaSolOs",
                "node_id": "MDQ6VXNlcjYyNTAyMjA3",
                "organizations_url": "https://api.github.com/users/MariaSolOs/orgs",
                "received_events_url": "https://api.github.com/users/MariaSolOs/received_events",
                "repos_url": "https://api.github.com/users/MariaSolOs/repos",
                "site_admin": false,
                "starred_url": "https://api.github.com/users/MariaSolOs/starred{/owner}{/repo}",
                "subscriptions_url": "https://api.github.com/users/MariaSolOs/subscriptions",
                "type": "User",
                "url": "https://api.github.com/users/MariaSolOs",
                "user_view_type": "public"
            }
        },
        {
            "author_association": "MEMBER",
            "body": "@justinmk @ribru17 Since you reviewed my [premature fix](https://github.com/neovim/neovim/pull/36682) I would also appreciate your input here.\n\nThat being said do note that handling this kind of situations (i.e. a server setting `foo: null` vs `foo` not being defined at all) is what https://github.com/neovim/neovim/pull/34849 addressed, and hence this makes me even more in favor of _not_ having any editor hacks here.",
            "created_at": "2025-11-25T02:57:15Z",
            "html_url": "https://github.com/neovim/neovim/issues/36680#issuecomment-3573582806",
            "id": 3573582806,
            "issue_url": "https://api.github.com/repos/neovim/neovim/issues/36680",
            "node_id": "IC_kwDOAPphoM7VAIvW",
            "performed_via_github_app": null,
            "reactions": {
                "+1": 2,
                "-1": 0,
                "confused": 0,
                "eyes": 0,
                "heart": 0,
                "hooray": 0,
                "laugh": 0,
                "rocket": 0,
                "total_count": 2,
                "url": "https://api.github.com/repos/neovim/neovim/issues/comments/3573582806/reactions"
            },
            "updated_at": "2025-11-25T02:57:15Z",
            "url": "https://api.github.com/repos/neovim/neovim/issues/comments/3573582806",
            "user": {
                "avatar_url": "https://avatars.githubusercontent.com/u/62502207?v=4",
                "events_url": "https://api.github.com/users/MariaSolOs/events{/privacy}",
                "followers_url": "https://api.github.com/users/MariaSolOs/followers",
                "following_url": "https://api.github.com/users/MariaSolOs/following{/other_user}",
                "gists_url": "https://api.github.com/users/MariaSolOs/gists{/gist_id}",
                "gravatar_id": "",
                "html_url": "https://github.com/MariaSolOs",
                "id": 62502207,
                "login": "MariaSolOs",
                "node_id": "MDQ6VXNlcjYyNTAyMjA3",
                "organizations_url": "https://api.github.com/users/MariaSolOs/orgs",
                "received_events_url": "https://api.github.com/users/MariaSolOs/received_events",
                "repos_url": "https://api.github.com/users/MariaSolOs/repos",
                "site_admin": false,
                "starred_url": "https://api.github.com/users/MariaSolOs/starred{/owner}{/repo}",
                "subscriptions_url": "https://api.github.com/users/MariaSolOs/subscriptions",
                "type": "User",
                "url": "https://api.github.com/users/MariaSolOs",
                "user_view_type": "public"
            }
        },
        {
            "author_association": "MEMBER",
            "body": "I agreeüëç",
            "created_at": "2025-11-25T03:51:33Z",
            "html_url": "https://github.com/neovim/neovim/issues/36680#issuecomment-3573674587",
            "id": 3573674587,
            "issue_url": "https://api.github.com/repos/neovim/neovim/issues/36680",
            "node_id": "IC_kwDOAPphoM7VAfJb",
            "performed_via_github_app": null,
            "reactions": {
                "+1": 0,
                "-1": 0,
                "confused": 0,
                "eyes": 0,
                "heart": 2,
                "hooray": 0,
                "laugh": 0,
                "rocket": 0,
                "total_count": 2,
                "url": "https://api.github.com/repos/neovim/neovim/issues/comments/3573674587/reactions"
            },
            "updated_at": "2025-11-25T03:51:33Z",
            "url": "https://api.github.com/repos/neovim/neovim/issues/comments/3573674587",
            "user": {
                "avatar_url": "https://avatars.githubusercontent.com/u/55766287?v=4",
                "events_url": "https://api.github.com/users/ribru17/events{/privacy}",
                "followers_url": "https://api.github.com/users/ribru17/followers",
                "following_url": "https://api.github.com/users/ribru17/following{/other_user}",
                "gists_url": "https://api.github.com/users/ribru17/gists{/gist_id}",
                "gravatar_id": "",
                "html_url": "https://github.com/ribru17",
                "id": 55766287,
                "login": "ribru17",
                "node_id": "MDQ6VXNlcjU1NzY2Mjg3",
                "organizations_url": "https://api.github.com/users/ribru17/orgs",
                "received_events_url": "https://api.github.com/users/ribru17/received_events",
                "repos_url": "https://api.github.com/users/ribru17/repos",
                "site_admin": false,
                "starred_url": "https://api.github.com/users/ribru17/starred{/owner}{/repo}",
                "subscriptions_url": "https://api.github.com/users/ribru17/subscriptions",
                "type": "User",
                "url": "https://api.github.com/users/ribru17",
                "user_view_type": "public"
            }
        }
    ],
    "comments": 3,
    "comments_url": "https://api.github.com/repos/neovim/neovim/issues/36680/comments",
    "created_at": "2025-11-24T21:56:31Z",
    "events_url": "https://api.github.com/repos/neovim/neovim/issues/36680/events",
    "html_url": "https://github.com/neovim/neovim/issues/36680",
    "id": 3660656645,
    "issue_dependencies_summary": {
        "blocked_by": 0,
        "blocking": 0,
        "total_blocked_by": 0,
        "total_blocking": 0
    },
    "labels": [
        {
            "color": "c5def5",
            "default": false,
            "description": null,
            "id": 662566370,
            "name": "lsp",
            "node_id": "MDU6TGFiZWw2NjI1NjYzNzA=",
            "url": "https://api.github.com/repos/neovim/neovim/labels/lsp"
        }
    ],
    "labels_url": "https://api.github.com/repos/neovim/neovim/issues/36680/labels{/name}",
    "locked": false,
    "milestone": null,
    "node_id": "I_kwDOAPphoM7aMTAF",
    "number": 36680,
    "performed_via_github_app": null,
    "reactions": {
        "+1": 0,
        "-1": 0,
        "confused": 0,
        "eyes": 0,
        "heart": 0,
        "hooray": 0,
        "laugh": 0,
        "rocket": 0,
        "total_count": 0,
        "url": "https://api.github.com/repos/neovim/neovim/issues/36680/reactions"
    },
    "repository_url": "https://api.github.com/repos/neovim/neovim",
    "state": "closed",
    "state_reason": "completed",
    "sub_issues_summary": {
        "completed": 0,
        "percent_completed": 0,
        "total": 0
    },
    "timeline_url": "https://api.github.com/repos/neovim/neovim/issues/36680/timeline",
    "title": "LSP: vim.diagnostic.open_float() crashes when relatedInformation is vim.NIL",
    "type": {
        "color": "red",
        "created_at": "2024-01-25T10:10:19Z",
        "description": "An unexpected problem or behavior",
        "id": 597163,
        "is_enabled": true,
        "name": "Bug",
        "node_id": "IT_kwDOAGK_Pc4ACRyr",
        "updated_at": "2024-07-26T10:12:30Z"
    },
    "updated_at": "2025-11-25T03:56:57Z",
    "url": "https://api.github.com/repos/neovim/neovim/issues/36680",
    "user": {
        "avatar_url": "https://avatars.githubusercontent.com/u/42407?v=4",
        "events_url": "https://api.github.com/users/aiiie/events{/privacy}",
        "followers_url": "https://api.github.com/users/aiiie/followers",
        "following_url": "https://api.github.com/users/aiiie/following{/other_user}",
        "gists_url": "https://api.github.com/users/aiiie/gists{/gist_id}",
        "gravatar_id": "",
        "html_url": "https://github.com/aiiie",
        "id": 42407,
        "login": "aiiie",
        "node_id": "MDQ6VXNlcjQyNDA3",
        "organizations_url": "https://api.github.com/users/aiiie/orgs",
        "received_events_url": "https://api.github.com/users/aiiie/received_events",
        "repos_url": "https://api.github.com/users/aiiie/repos",
        "site_admin": false,
        "starred_url": "https://api.github.com/users/aiiie/starred{/owner}{/repo}",
        "subscriptions_url": "https://api.github.com/users/aiiie/subscriptions",
        "type": "User",
        "url": "https://api.github.com/users/aiiie",
        "user_view_type": "public"
    }
}