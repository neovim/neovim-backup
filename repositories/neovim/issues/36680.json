{
    "active_lock_reason": null,
    "assignee": null,
    "assignees": [],
    "author_association": "NONE",
    "body": "### Problem\n\nWhen a language server provides the `relatedInformation` key in its diagnostics but sets it to `null`/`vim.NIL`, `vim.diagnostic.open_float()` crashes with the following error:\n\n```\nvim.schedule callback: ...m/HEAD-01a9765/share/nvim/runtime/lua/vim/diagnostic.lua:2515: bad argument #1 to 'ipairs' (table expected, got userdata)\nstack traceback:\n\t[C]: in function 'ipairs'\n\t...m/HEAD-01a9765/share/nvim/runtime/lua/vim/diagnostic.lua:2515: in function 'open_float'\n```\n\n`nimlangserver` in particular sends diagnostics this way.\n\nI'm able to work around this with the following code change, though I'm not familiar enough with the codebase to know if this is idiomatic or correct:\n\n```diff\ndiff --git a/runtime/lua/vim/diagnostic.lua b/runtime/lua/vim/diagnostic.lua\nindex a33ed7e082..24af95a58a 100644\n--- a/runtime/lua/vim/diagnostic.lua\n+++ b/runtime/lua/vim/diagnostic.lua\n@@ -2509,6 +2509,9 @@ function M.open_float(opts, ...)\n \n     ---@type lsp.DiagnosticRelatedInformation[]\n     local related_info = vim.tbl_get(diagnostic, 'user_data', 'lsp', 'relatedInformation') or {}\n+    if related_info == vim.NIL then\n+      related_info = {}\n+    end\n \n     -- Below the diagnostic, show its LSP related information (if any) in the form of file name and\n     -- range, plus description.\n```\n\nIf this is amenable to others (or would be amenable with changes/feedback), I'd be happy to submit a pull request.\n\n### Steps to reproduce using \"nvim --clean -u minimal_init.lua\"\n\nminimal_init.lua:\n\n```lua\nlocal pattern = 'nim'\nlocal cmd = {'nimlangserver'}\nlocal root_markers = {'.git', '.editorconfig'}\nlocal settings = vim.empty_dict()\n\nvim.api.nvim_create_autocmd('FileType', {\n  pattern = pattern,\n  callback = function(args)\n    local match = vim.fs.find(root_markers, { path = args.file, upward = true })[1]\n    local root_dir = match and vim.fn.fnamemodify(match, ':p:h') or nil\n    vim.lsp.start({\n      name = 'nimglangserver',\n      cmd = cmd,\n      root_dir = root_dir,\n      settings = settings\n    })\n  end\n})\n```\n\nfoo.nim:\n\n```nim\nvar c: char = 'c'\n```\n\nRun `git init` where foo.nim is, then run `nvim --clean -u minimal_init.lua foo.nim`.\n\nInside Neovim, run `:lua vim.diagnostic.open_float()` to trigger the error:\n\n```\nE5108: Lua: ...m/HEAD-01a9765/share/nvim/runtime/lua/vim/diagnostic.lua:2515: bad argument #1 to 'ip\nairs' (table expected, got userdata)\nstack traceback:\n        [C]: in function 'ipairs'\n        ...m/HEAD-01a9765/share/nvim/runtime/lua/vim/diagnostic.lua:2515: in function 'open_float'\n        [string \":lua\"]:1: in main chunk\n```\n\n### Expected behavior\n\nInstead of crashing, the diagnostic window is shown with the following:\n\n```\nnimsuggest chk: 'c' is declared but not used [XDeclaredButNotUsed]\n```\n\n### Nvim version (nvim -v)\n\nNVIM v0.12.0-dev-1684+g01a9765035-Homebrew\n\n### Language server name/version\n\nnimlangserver 1.12.0\n\n### Operating system/version\n\nmacOS 26.1\n\n### Log file\n\n_No response_",
    "closed_at": null,
    "closed_by": null,
    "comment_data": [],
    "comments": 0,
    "comments_url": "https://api.github.com/repos/neovim/neovim/issues/36680/comments",
    "created_at": "2025-11-24T21:56:31Z",
    "events_url": "https://api.github.com/repos/neovim/neovim/issues/36680/events",
    "html_url": "https://github.com/neovim/neovim/issues/36680",
    "id": 3660656645,
    "issue_dependencies_summary": {
        "blocked_by": 0,
        "blocking": 0,
        "total_blocked_by": 0,
        "total_blocking": 0
    },
    "labels": [
        {
            "color": "c5def5",
            "default": false,
            "description": null,
            "id": 662566370,
            "name": "lsp",
            "node_id": "MDU6TGFiZWw2NjI1NjYzNzA=",
            "url": "https://api.github.com/repos/neovim/neovim/labels/lsp"
        }
    ],
    "labels_url": "https://api.github.com/repos/neovim/neovim/issues/36680/labels{/name}",
    "locked": false,
    "milestone": null,
    "node_id": "I_kwDOAPphoM7aMTAF",
    "number": 36680,
    "performed_via_github_app": null,
    "reactions": {
        "+1": 0,
        "-1": 0,
        "confused": 0,
        "eyes": 0,
        "heart": 0,
        "hooray": 0,
        "laugh": 0,
        "rocket": 0,
        "total_count": 0,
        "url": "https://api.github.com/repos/neovim/neovim/issues/36680/reactions"
    },
    "repository_url": "https://api.github.com/repos/neovim/neovim",
    "state": "open",
    "state_reason": null,
    "sub_issues_summary": {
        "completed": 0,
        "percent_completed": 0,
        "total": 0
    },
    "timeline_url": "https://api.github.com/repos/neovim/neovim/issues/36680/timeline",
    "title": "LSP: vim.diagnostic.open_float() crashes when relatedInformation is vim.NIL",
    "type": {
        "color": "red",
        "created_at": "2024-01-25T10:10:19Z",
        "description": "An unexpected problem or behavior",
        "id": 597163,
        "is_enabled": true,
        "name": "Bug",
        "node_id": "IT_kwDOAGK_Pc4ACRyr",
        "updated_at": "2024-07-26T10:12:30Z"
    },
    "updated_at": "2025-11-24T21:56:38Z",
    "url": "https://api.github.com/repos/neovim/neovim/issues/36680",
    "user": {
        "avatar_url": "https://avatars.githubusercontent.com/u/42407?v=4",
        "events_url": "https://api.github.com/users/aiiie/events{/privacy}",
        "followers_url": "https://api.github.com/users/aiiie/followers",
        "following_url": "https://api.github.com/users/aiiie/following{/other_user}",
        "gists_url": "https://api.github.com/users/aiiie/gists{/gist_id}",
        "gravatar_id": "",
        "html_url": "https://github.com/aiiie",
        "id": 42407,
        "login": "aiiie",
        "node_id": "MDQ6VXNlcjQyNDA3",
        "organizations_url": "https://api.github.com/users/aiiie/orgs",
        "received_events_url": "https://api.github.com/users/aiiie/received_events",
        "repos_url": "https://api.github.com/users/aiiie/repos",
        "site_admin": false,
        "starred_url": "https://api.github.com/users/aiiie/starred{/owner}{/repo}",
        "subscriptions_url": "https://api.github.com/users/aiiie/subscriptions",
        "type": "User",
        "url": "https://api.github.com/users/aiiie",
        "user_view_type": "public"
    }
}