{
    "active_lock_reason": null,
    "assignee": null,
    "assignees": [],
    "author_association": "CONTRIBUTOR",
    "body": "### Problem\n\nThe `workspace/diagnostic` support no longer works after 0f3e3c87b738f1c81fa22b6e5f2a9a847d59ebd3 with several language servers, at least:\n* lua_ls (lua)\n* basedpyright (python)\n* ty (python)\n\nThe problem may not be in neovim: maybe it is buggy behavior of these servers? I haven't determined the issue, but at least there's a simple workaround: disable the dynamic registration, and workspace diagnostics functions again.\n\n### Steps to reproduce using \"nvim --clean -u minimal_init.lua\"\n\n```lua\nvim.lsp.config('ty', {\n  cmd = { 'ty', 'server' },\n  filetypes = { 'python' },\n  root_markers = { 'minimal_init.lua' },\n  settings = {\n    ty = {\n      diagnosticMode = 'workspace',\n    },\n  },\n  -- -- uncomment this for a workaround\n  --  capabilities = {\n  --    textDocument = {\n  --      diagnostic = {\n  --        dynamicRegistration = false\n  --      },\n  --    },\n  --  },\n})\nvim.lsp.enable('ty')\nvim.defer_fn(function()\n  vim.print(vim.lsp.get_clients()[1]:supports_method('workspace/diagnostic'))\nend, 1000)\n```\n\nThen run `nvim --clean -u minimal_init.lua nonexistent.py`. It will print `false`. If you disable the dynamic registration with the workaround, it will print `true`.\n\n### Expected behavior\n\nworkspace/diagnostic feature functions again\n\n### Nvim version (nvim -v)\n\nNVIM v0.12.0-dev-1915+g444e1ffe3e\n\n### Language server name/version\n\nty 0.0.7\n\n### Operating system/version\n\nlinux 6.17.9-arch1-1\n\n### Log file\n\nhttps://gist.github.com/rmuir/033e9a1553f08e0e0a3de09f6b1352a9",
    "closed_at": null,
    "closed_by": null,
    "comment_data": [
        {
            "author_association": "MEMBER",
            "body": "@tris203 ",
            "created_at": "2025-12-29T03:12:30Z",
            "html_url": "https://github.com/neovim/neovim/issues/37150#issuecomment-3695327384",
            "id": 3695327384,
            "issue_url": "https://api.github.com/repos/neovim/neovim/issues/37150",
            "node_id": "IC_kwDOAPphoM7cQjiY",
            "performed_via_github_app": null,
            "reactions": {
                "+1": 0,
                "-1": 0,
                "confused": 0,
                "eyes": 0,
                "heart": 0,
                "hooray": 0,
                "laugh": 0,
                "rocket": 0,
                "total_count": 0,
                "url": "https://api.github.com/repos/neovim/neovim/issues/comments/3695327384/reactions"
            },
            "updated_at": "2025-12-29T03:12:30Z",
            "url": "https://api.github.com/repos/neovim/neovim/issues/comments/3695327384",
            "user": {
                "avatar_url": "https://avatars.githubusercontent.com/u/1359421?v=4",
                "events_url": "https://api.github.com/users/justinmk/events{/privacy}",
                "followers_url": "https://api.github.com/users/justinmk/followers",
                "following_url": "https://api.github.com/users/justinmk/following{/other_user}",
                "gists_url": "https://api.github.com/users/justinmk/gists{/gist_id}",
                "gravatar_id": "",
                "html_url": "https://github.com/justinmk",
                "id": 1359421,
                "login": "justinmk",
                "node_id": "MDQ6VXNlcjEzNTk0MjE=",
                "organizations_url": "https://api.github.com/users/justinmk/orgs",
                "received_events_url": "https://api.github.com/users/justinmk/received_events",
                "repos_url": "https://api.github.com/users/justinmk/repos",
                "site_admin": false,
                "starred_url": "https://api.github.com/users/justinmk/starred{/owner}{/repo}",
                "subscriptions_url": "https://api.github.com/users/justinmk/subscriptions",
                "type": "User",
                "url": "https://api.github.com/users/justinmk",
                "user_view_type": "public"
            }
        },
        {
            "author_association": "CONTRIBUTOR",
            "body": "This is an interesting one.\nThe key is here \n```\n[DEBUG][2025-12-28 13:46:57] /usr/share/nvim/runtime/lua/vim/lsp/log.lua:151\t\"rpc.receive\"\t{ id = 1, jsonrpc = \"2.0\", method = \"client/registerCapability\", params = { registrations = { { id = \"ty/textDocument/diagnostic\", method = \"textDocument/diagnostic\", registerOptions = { documentSelector = vim.NIL, identifier = \"ty\", interFileDependencies = true, workDoneProgress = true, workspaceDiagnostics = true } } } } }\n```\n\n`DiagnosticRegistrationOptions` is defined as\nhttps://microsoft.github.io/language-server-protocol/specifications/lsp/3.17/specification/#diagnosticRegistrationOptions\n```js\nexport interface DiagnosticRegistrationOptions extends TextDocumentRegistrationOptions, DiagnosticOptions, StaticRegistrationOptions { }\n```\n\nSo you can define `DiagnosticOptions` in the dynamic registration request, which means it isn't defined statically in the `server_capabilities`. (Correctly)\n\nThis means that our `supports_method` check will be looking for the `workspace/diagnostics` method, which isnt defined statically in the `server_capabilities`, and because the dynamic registration is done under the `textDocument/diagnostic` method. So that isn't checked, and we decide that we don't support the method.\n\nI have looked at the metamodel, and it doesn't seem to define this anywhere immediately clearly. Except for through the `DiagnosticsProvider` definition (and the fact that `workspace/diagnostic` shared this prefix)\nhttps://github.com/microsoft/language-server-protocol/blob/f1b5515dd96741041a68fa83da13c4e9fe0c1727/_specifications/lsp/3.18/metaModel/metaModel.json#L8912-L8930\n\nI think the core of the problem is with our `supports_method` implementation.\n\nI will think some more about this",
            "created_at": "2025-12-29T12:22:37Z",
            "html_url": "https://github.com/neovim/neovim/issues/37150#issuecomment-3696382241",
            "id": 3696382241,
            "issue_url": "https://api.github.com/repos/neovim/neovim/issues/37150",
            "node_id": "IC_kwDOAPphoM7cUlEh",
            "performed_via_github_app": null,
            "reactions": {
                "+1": 2,
                "-1": 0,
                "confused": 0,
                "eyes": 0,
                "heart": 0,
                "hooray": 0,
                "laugh": 0,
                "rocket": 0,
                "total_count": 2,
                "url": "https://api.github.com/repos/neovim/neovim/issues/comments/3696382241/reactions"
            },
            "updated_at": "2025-12-29T12:22:37Z",
            "url": "https://api.github.com/repos/neovim/neovim/issues/comments/3696382241",
            "user": {
                "avatar_url": "https://avatars.githubusercontent.com/u/18444302?v=4",
                "events_url": "https://api.github.com/users/tris203/events{/privacy}",
                "followers_url": "https://api.github.com/users/tris203/followers",
                "following_url": "https://api.github.com/users/tris203/following{/other_user}",
                "gists_url": "https://api.github.com/users/tris203/gists{/gist_id}",
                "gravatar_id": "",
                "html_url": "https://github.com/tris203",
                "id": 18444302,
                "login": "tris203",
                "node_id": "MDQ6VXNlcjE4NDQ0MzAy",
                "organizations_url": "https://api.github.com/users/tris203/orgs",
                "received_events_url": "https://api.github.com/users/tris203/received_events",
                "repos_url": "https://api.github.com/users/tris203/repos",
                "site_admin": false,
                "starred_url": "https://api.github.com/users/tris203/starred{/owner}{/repo}",
                "subscriptions_url": "https://api.github.com/users/tris203/subscriptions",
                "type": "User",
                "url": "https://api.github.com/users/tris203",
                "user_view_type": "public"
            }
        }
    ],
    "comments": 2,
    "comments_url": "https://api.github.com/repos/neovim/neovim/issues/37150/comments",
    "created_at": "2025-12-28T18:51:31Z",
    "events_url": "https://api.github.com/repos/neovim/neovim/issues/37150/events",
    "html_url": "https://github.com/neovim/neovim/issues/37150",
    "id": 3765912148,
    "issue_dependencies_summary": {
        "blocked_by": 0,
        "blocking": 0,
        "total_blocked_by": 0,
        "total_blocking": 0
    },
    "labels": [
        {
            "color": "c5def5",
            "default": false,
            "description": null,
            "id": 662566370,
            "name": "lsp",
            "node_id": "MDU6TGFiZWw2NjI1NjYzNzA=",
            "url": "https://api.github.com/repos/neovim/neovim/labels/lsp"
        }
    ],
    "labels_url": "https://api.github.com/repos/neovim/neovim/issues/37150/labels{/name}",
    "locked": false,
    "milestone": {
        "closed_at": null,
        "closed_issues": 763,
        "created_at": "2014-05-10T20:43:04Z",
        "creator": {
            "avatar_url": "https://avatars.githubusercontent.com/u/1359421?v=4",
            "events_url": "https://api.github.com/users/justinmk/events{/privacy}",
            "followers_url": "https://api.github.com/users/justinmk/followers",
            "following_url": "https://api.github.com/users/justinmk/following{/other_user}",
            "gists_url": "https://api.github.com/users/justinmk/gists{/gist_id}",
            "gravatar_id": "",
            "html_url": "https://github.com/justinmk",
            "id": 1359421,
            "login": "justinmk",
            "node_id": "MDQ6VXNlcjEzNTk0MjE=",
            "organizations_url": "https://api.github.com/users/justinmk/orgs",
            "received_events_url": "https://api.github.com/users/justinmk/received_events",
            "repos_url": "https://api.github.com/users/justinmk/repos",
            "site_admin": false,
            "starred_url": "https://api.github.com/users/justinmk/starred{/owner}{/repo}",
            "subscriptions_url": "https://api.github.com/users/justinmk/subscriptions",
            "type": "User",
            "url": "https://api.github.com/users/justinmk",
            "user_view_type": "public"
        },
        "description": "Low priority items. We plan to work on this but don't have a target date.",
        "due_on": null,
        "html_url": "https://github.com/neovim/neovim/milestone/6",
        "id": 655037,
        "labels_url": "https://api.github.com/repos/neovim/neovim/milestones/6/labels",
        "node_id": "MDk6TWlsZXN0b25lNjU1MDM3",
        "number": 6,
        "open_issues": 641,
        "state": "open",
        "title": "backlog",
        "updated_at": "2025-12-29T03:12:48Z",
        "url": "https://api.github.com/repos/neovim/neovim/milestones/6"
    },
    "node_id": "I_kwDOAPphoM7gd0JU",
    "number": 37150,
    "performed_via_github_app": null,
    "reactions": {
        "+1": 0,
        "-1": 0,
        "confused": 0,
        "eyes": 0,
        "heart": 0,
        "hooray": 0,
        "laugh": 0,
        "rocket": 0,
        "total_count": 0,
        "url": "https://api.github.com/repos/neovim/neovim/issues/37150/reactions"
    },
    "repository_url": "https://api.github.com/repos/neovim/neovim",
    "state": "open",
    "state_reason": null,
    "sub_issues_summary": {
        "completed": 0,
        "percent_completed": 0,
        "total": 0
    },
    "timeline_url": "https://api.github.com/repos/neovim/neovim/issues/37150/timeline",
    "title": "LSP: textDocument/diagnostic dynamicRegistration does not play well with workspace/diagnostic",
    "type": {
        "color": "red",
        "created_at": "2024-01-25T10:10:19Z",
        "description": "An unexpected problem or behavior",
        "id": 597163,
        "is_enabled": true,
        "name": "Bug",
        "node_id": "IT_kwDOAGK_Pc4ACRyr",
        "updated_at": "2024-07-26T10:12:30Z"
    },
    "updated_at": "2025-12-29T12:22:37Z",
    "url": "https://api.github.com/repos/neovim/neovim/issues/37150",
    "user": {
        "avatar_url": "https://avatars.githubusercontent.com/u/504194?v=4",
        "events_url": "https://api.github.com/users/rmuir/events{/privacy}",
        "followers_url": "https://api.github.com/users/rmuir/followers",
        "following_url": "https://api.github.com/users/rmuir/following{/other_user}",
        "gists_url": "https://api.github.com/users/rmuir/gists{/gist_id}",
        "gravatar_id": "",
        "html_url": "https://github.com/rmuir",
        "id": 504194,
        "login": "rmuir",
        "node_id": "MDQ6VXNlcjUwNDE5NA==",
        "organizations_url": "https://api.github.com/users/rmuir/orgs",
        "received_events_url": "https://api.github.com/users/rmuir/received_events",
        "repos_url": "https://api.github.com/users/rmuir/repos",
        "site_admin": false,
        "starred_url": "https://api.github.com/users/rmuir/starred{/owner}{/repo}",
        "subscriptions_url": "https://api.github.com/users/rmuir/subscriptions",
        "type": "User",
        "url": "https://api.github.com/users/rmuir",
        "user_view_type": "public"
    }
}