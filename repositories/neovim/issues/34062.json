{
    "active_lock_reason": null,
    "assignee": null,
    "assignees": [],
    "author_association": "NONE",
    "body": "### Problem\n\nThe `ast-grep` language server (config from `lspconfig`) fails to start when using `root_markers` but works fine if a custom (and equivalent) `root_dir` function is provided.\n\nThe error seems to only appear when using `autochdir` and a session file where the session is restored to a buffer that is _not_ in a project that does not contain the root marker file, and a buffer in the session is switched to that _is_ in a project containing the root marker file.\n\nNote: The session might not be necessary to trigger this issue (it's just how I observed the issue occurring initially), however `autochdir` seems to be required to trigger this issue. It's also likely this isn't specifically an `ast-grep` issue, but it's what I observed the issue with.\n\nThe error seen is:\n```\nClient ast_grep quit with exit code 2 and signal 0. Check log for errors: /Users/josh/.local/state/nvim/lsp.log\n```\nand the `lsp.log` has the error:\n```\n[ERROR][2025-05-17 13:57:22] ...p/_transport.lua:36\t\"rpc\"\t\"ast-grep\"\t\"stderr\"\t\"Error: No ast-grep project configuration is found.\\nHelp: You need to create an ast-grep project for this command. Try `sg new` to create one.\\nSee also: https://ast-grep.github.io/guide/scan-project.html\\n\\n\"\n```\neven though there _is_ an `sgconfig.yml` (one of the `root_markers`) present for the project.\n\nManually adding a `root_dir` function, like:\n```lua\nlocal make_root_dir = function(root_markers)\n  local root_dir = function(bufnr, on_dir)\n    on_dir(vim.fs.root(bufnr, root_markers))\n  end\n  return root_dir\nend\n\nvim.lsp.config(\n  'ast_grep',\n  {\n    root_dir = make_root_dir({'sgconfig.yml', 'sgconfig.yaml'})\n  }\n)\nvim.lsp.enable('ast_grep')\n```\nworks around the problem.\n\nMy suspicion is that when `root_dir` is specified as a function, the server is being initialised using `vim.schedule`, but without `root_dir` it is initialised immediately and there is some race-condition (e.g. `autochdir` hasn't had a chance to change the directory yet).\n\n### Steps to reproduce\n\n# Setup\n\nCreate the following files somewhere (e.g. `/tmp/nvim-test`)\n\n## `minimal.lua`\n\n```lua\nfor name, url in pairs {\n  \"https://github.com/neovim/nvim-lspconfig\",\n} do\n  local install_path = vim.fn.fnamemodify('nvim_issue/' .. name, ':p')\n  if vim.fn.isdirectory(install_path) == 0 then\n    vim.fn.system { 'git', 'clone', '--depth=1', url, install_path }\n  end\n  vim.opt.runtimepath:append(install_path)\nend\n\nlocal make_root_dir = function(root_markers)\n  local root_dir = function(bufnr, on_dir)\n    on_dir(vim.fs.root(bufnr, root_markers))\n  end\n  return root_dir\nend\n\n-- uncomment to work around issue:\n-- vim.lsp.config(\n--   'ast_grep',\n--   {\n--     root_dir = make_root_dir(vim.lsp.config.ast_grep.root_markers)\n--   }\n-- )\nvim.lsp.enable({ 'ast_grep' })\n```\n\n## `sgconfig.yml`\n\nBasic config for `ast-grep`:\n\n```yaml\nruleDirs:\n  - rules\n```\n\n## `foo.py`\n\nA dummy file to open:\n\n```python\ndef foo():\n    pass\n```\n\n# Steps to reproduce\n\n1. Install `ast-grep`:\n\n    e.g. for macOS:\n\n    ```bash\n    $ brew install ast-grep\n    ```\n\n2. Start `nvim` with the minimal configuration:\n\n    ```bash\n    $ cd /tmp/nvim-test\n    $ nvim --clean -u /tmp/nvim-test/minimal.lua\n    ```\n\n3. Open `foo.py` (i.e. `:e /tmp/nvim-test/foo.py`)\n4. Open and save some file outside of the project (e.g. `:e /tmp/bar.py | :w`)\n5. Save the session `:mksession /tmp/Session.vim` and quit.\n6. Restart `nvim` and load the saved session:\n\n    ```bash\n    $ nvim --clean -u /tmp/nvim-test/minimal.lua -S /tmp/Session.vim\n    ```\n\n7. Switch to `foo.py` (i.e. `:b foo.py` or `:b #`)\n\nThe error should now appear.\nUncommenting the `vim.lsp.config(...)` in `minimal.lua` (or disabling `autochdir`) should prevent the error.\n\n### Expected behavior\n\nThe language server should start without errors.\n\n### Nvim version (nvim -v)\n\nv0.12.0-nightly+2fda267\n\n### Vim (not Nvim) behaves the same?\n\nn/a\n\n### Operating system/version\n\nmacOS 15.5\n\n### Terminal name/version\n\nalacritty 0.15.1 (0c405d5)\n\n### $TERM environment variable\n\ntmux-256color\n\n### Installation\n\nNix neovim nightly overlay: https://github.com/nix-community/neovim-nightly-overlay",
    "closed_at": null,
    "closed_by": null,
    "comment_data": [],
    "comments": 0,
    "comments_url": "https://api.github.com/repos/neovim/neovim/issues/34062/comments",
    "created_at": "2025-05-17T05:52:10Z",
    "events_url": "https://api.github.com/repos/neovim/neovim/issues/34062/events",
    "html_url": "https://github.com/neovim/neovim/issues/34062",
    "id": 3070406215,
    "labels": [
        {
            "color": "c5def5",
            "default": false,
            "description": null,
            "id": 662566370,
            "name": "lsp",
            "node_id": "MDU6TGFiZWw2NjI1NjYzNzA=",
            "url": "https://api.github.com/repos/neovim/neovim/labels/lsp"
        }
    ],
    "labels_url": "https://api.github.com/repos/neovim/neovim/issues/34062/labels{/name}",
    "locked": false,
    "milestone": {
        "closed_at": null,
        "closed_issues": 283,
        "created_at": "2014-11-26T22:13:11Z",
        "creator": {
            "avatar_url": "https://avatars.githubusercontent.com/u/1359421?v=4",
            "events_url": "https://api.github.com/users/justinmk/events{/privacy}",
            "followers_url": "https://api.github.com/users/justinmk/followers",
            "following_url": "https://api.github.com/users/justinmk/following{/other_user}",
            "gists_url": "https://api.github.com/users/justinmk/gists{/gist_id}",
            "gravatar_id": "",
            "html_url": "https://github.com/justinmk",
            "id": 1359421,
            "login": "justinmk",
            "node_id": "MDQ6VXNlcjEzNTk0MjE=",
            "organizations_url": "https://api.github.com/users/justinmk/orgs",
            "received_events_url": "https://api.github.com/users/justinmk/received_events",
            "repos_url": "https://api.github.com/users/justinmk/repos",
            "site_admin": false,
            "starred_url": "https://api.github.com/users/justinmk/starred{/owner}{/repo}",
            "subscriptions_url": "https://api.github.com/users/justinmk/subscriptions",
            "type": "User",
            "url": "https://api.github.com/users/justinmk",
            "user_view_type": "public"
        },
        "description": "We don't plan to work on this, but will accept high quality contributions from someone who will own the feature and follow up on bug reports.",
        "due_on": null,
        "html_url": "https://github.com/neovim/neovim/milestone/9",
        "id": 881978,
        "labels_url": "https://api.github.com/repos/neovim/neovim/milestones/9/labels",
        "node_id": "MDk6TWlsZXN0b25lODgxOTc4",
        "number": 9,
        "open_issues": 328,
        "state": "open",
        "title": "needs-owner",
        "updated_at": "2025-06-16T11:54:24Z",
        "url": "https://api.github.com/repos/neovim/neovim/milestones/9"
    },
    "node_id": "I_kwDOAPphoM63Aq5H",
    "number": 34062,
    "performed_via_github_app": null,
    "reactions": {
        "+1": 0,
        "-1": 0,
        "confused": 0,
        "eyes": 0,
        "heart": 0,
        "hooray": 0,
        "laugh": 0,
        "rocket": 0,
        "total_count": 0,
        "url": "https://api.github.com/repos/neovim/neovim/issues/34062/reactions"
    },
    "repository_url": "https://api.github.com/repos/neovim/neovim",
    "state": "open",
    "state_reason": null,
    "sub_issues_summary": {
        "completed": 0,
        "percent_completed": 0,
        "total": 0
    },
    "timeline_url": "https://api.github.com/repos/neovim/neovim/issues/34062/timeline",
    "title": "`vim.lsp.start` failure for `ast-grep` language server when using sessions and `autochdir`",
    "type": {
        "color": "red",
        "created_at": "2024-01-25T10:10:19Z",
        "description": "An unexpected problem or behavior",
        "id": 597163,
        "is_enabled": true,
        "name": "Bug",
        "node_id": "IT_kwDOAGK_Pc4ACRyr",
        "updated_at": "2024-07-26T10:12:30Z"
    },
    "updated_at": "2025-06-15T00:14:41Z",
    "url": "https://api.github.com/repos/neovim/neovim/issues/34062",
    "user": {
        "avatar_url": "https://avatars.githubusercontent.com/u/878107?v=4",
        "events_url": "https://api.github.com/users/joshbode/events{/privacy}",
        "followers_url": "https://api.github.com/users/joshbode/followers",
        "following_url": "https://api.github.com/users/joshbode/following{/other_user}",
        "gists_url": "https://api.github.com/users/joshbode/gists{/gist_id}",
        "gravatar_id": "",
        "html_url": "https://github.com/joshbode",
        "id": 878107,
        "login": "joshbode",
        "node_id": "MDQ6VXNlcjg3ODEwNw==",
        "organizations_url": "https://api.github.com/users/joshbode/orgs",
        "received_events_url": "https://api.github.com/users/joshbode/received_events",
        "repos_url": "https://api.github.com/users/joshbode/repos",
        "site_admin": false,
        "starred_url": "https://api.github.com/users/joshbode/starred{/owner}{/repo}",
        "subscriptions_url": "https://api.github.com/users/joshbode/subscriptions",
        "type": "User",
        "url": "https://api.github.com/users/joshbode",
        "user_view_type": "public"
    }
}