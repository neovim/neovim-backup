{
    "active_lock_reason": null,
    "assignee": null,
    "assignees": [],
    "author_association": "MEMBER",
    "body": "### Problem\n\nHang if PTY process exits after spawning detached child that keeps writing output.\nRegression from #37325.\n\n### Steps to reproduce\n\n1. Compile the following C program into an executable `./a.out`:\n```c\n#include <stdio.h>\n#include <unistd.h>\n\nint main() {\n  if (fork() == 0) {\n    setsid();\n    for (;;) {\n      printf(\"foobar\\n\");\n    }\n  } else {\n    usleep(1000);\n  }\n  return 0;\n}\n```\n2. Run `nvim --clean`\n3. Run `:call jobstart(['./a.out'], {'term': v:true}`\n4. Nvim hangs and doesn't respond to any input\n\nTheoretically this can happen with `'pty': v:true` as well, but when I test this it only happens with `'term': v:true`.\n\n### Expected behavior\n\nNo hang. There are three possible solutions:\n1. Restore the remaining data size limit, but use a larger limit on Linux. See #38011.\n2. Allow interrupting the loop in `flush_stream()` with Ctrl-C.\n3. Don't drain PTY master after the direct child exits. Instead, keep the terminal channel open until EOF on PTY master (i.e. all children have exited).\n\nIt seems that some terminal emulators (e.g. kitty) do wait for all processes in the PTY to exit (e.g. after `:detach` in Nvim, kitty doesn't exit until the server is also stopped), while some other terminal emulators don't. This is also mentioned in tui_spec.lua:\n\nhttps://github.com/neovim/neovim/blob/94c21c22dcf6b1afdb25a250c08bd858d481429b/test/functional/terminal/tui_spec.lua#L205-L209\n\nMaking Nvim's builtin terminal do this can be a bit hard and can potentially break plugins, as it's not clear how this should interact with `on_exit` and `jobwait()` etc..\n\n### Nvim version (nvim -v)\n\nv0.12.0-dev-2379+g524164ae05\n\n### Vim (not Nvim) behaves the same?\n\nYes, Vim 9.0.38 also hangs with `:call term_start(['./a.out'])`\n\n### Operating system/version\n\nArch Linux\n\n### Terminal name/version\n\nkitty 0.45.0\n\n### $TERM environment variable\n\nxterm-kitty\n\n### Installation\n\nArch User Respository (AUR)",
    "closed_at": null,
    "closed_by": null,
    "comment_data": [
        {
            "author_association": "MEMBER",
            "body": "> 2\\. Allow interrupting the loop in `flush_stream()` with Ctrl-C.\n\nThat seems like something we should have in any case, similar to `proc_wait`. But that's only a fallback, since it is still similar to a \"hang\". \n\nIs it stuck in the `flush_stream` while-loop (maybe we can return to the main loop?), or something out of our control? https://github.com/neovim/neovim/blob/ce5c7111f4050f168ddf4806287b4c384264b0fa/src/nvim/event/proc.c#L392-L393\n\n\n> 3\\. Don't drain PTY master after the direct child exits. Instead, keep the terminal channel open until EOF on PTY master (i.e. all children have exited).\n>\n> ... Making Nvim's builtin terminal do this can be a bit hard and can potentially break plugins, as it's not clear how this should interact with `on_exit` and `jobwait()` etc..\n\nCan/should we make this controllable by some sort of timeout?  We may need something similar to `vim.lsp.Client.exit_timeout` for general job-control.",
            "created_at": "2026-02-23T13:53:23Z",
            "html_url": "https://github.com/neovim/neovim/issues/38014#issuecomment-3944913652",
            "id": 3944913652,
            "issue_url": "https://api.github.com/repos/neovim/neovim/issues/38014",
            "node_id": "IC_kwDOAPphoM7rIpr0",
            "performed_via_github_app": null,
            "pin": null,
            "reactions": {
                "+1": 0,
                "-1": 0,
                "confused": 0,
                "eyes": 0,
                "heart": 0,
                "hooray": 0,
                "laugh": 0,
                "rocket": 0,
                "total_count": 0,
                "url": "https://api.github.com/repos/neovim/neovim/issues/comments/3944913652/reactions"
            },
            "updated_at": "2026-02-23T13:55:36Z",
            "url": "https://api.github.com/repos/neovim/neovim/issues/comments/3944913652",
            "user": {
                "avatar_url": "https://avatars.githubusercontent.com/u/1359421?v=4",
                "events_url": "https://api.github.com/users/justinmk/events{/privacy}",
                "followers_url": "https://api.github.com/users/justinmk/followers",
                "following_url": "https://api.github.com/users/justinmk/following{/other_user}",
                "gists_url": "https://api.github.com/users/justinmk/gists{/gist_id}",
                "gravatar_id": "",
                "html_url": "https://github.com/justinmk",
                "id": 1359421,
                "login": "justinmk",
                "node_id": "MDQ6VXNlcjEzNTk0MjE=",
                "organizations_url": "https://api.github.com/users/justinmk/orgs",
                "received_events_url": "https://api.github.com/users/justinmk/received_events",
                "repos_url": "https://api.github.com/users/justinmk/repos",
                "site_admin": false,
                "starred_url": "https://api.github.com/users/justinmk/starred{/owner}{/repo}",
                "subscriptions_url": "https://api.github.com/users/justinmk/subscriptions",
                "type": "User",
                "url": "https://api.github.com/users/justinmk",
                "user_view_type": "public"
            }
        },
        {
            "author_association": "MEMBER",
            "body": "> Is it stuck in the `flush_stream` while-loop\n\nYes.",
            "created_at": "2026-02-23T13:59:36Z",
            "html_url": "https://github.com/neovim/neovim/issues/38014#issuecomment-3944943453",
            "id": 3944943453,
            "issue_url": "https://api.github.com/repos/neovim/neovim/issues/38014",
            "node_id": "IC_kwDOAPphoM7rIw9d",
            "performed_via_github_app": null,
            "pin": null,
            "reactions": {
                "+1": 0,
                "-1": 0,
                "confused": 0,
                "eyes": 0,
                "heart": 0,
                "hooray": 0,
                "laugh": 0,
                "rocket": 0,
                "total_count": 0,
                "url": "https://api.github.com/repos/neovim/neovim/issues/comments/3944943453/reactions"
            },
            "updated_at": "2026-02-23T14:07:20Z",
            "url": "https://api.github.com/repos/neovim/neovim/issues/comments/3944943453",
            "user": {
                "avatar_url": "https://avatars.githubusercontent.com/u/35768171?v=4",
                "events_url": "https://api.github.com/users/zeertzjq/events{/privacy}",
                "followers_url": "https://api.github.com/users/zeertzjq/followers",
                "following_url": "https://api.github.com/users/zeertzjq/following{/other_user}",
                "gists_url": "https://api.github.com/users/zeertzjq/gists{/gist_id}",
                "gravatar_id": "",
                "html_url": "https://github.com/zeertzjq",
                "id": 35768171,
                "login": "zeertzjq",
                "node_id": "MDQ6VXNlcjM1NzY4MTcx",
                "organizations_url": "https://api.github.com/users/zeertzjq/orgs",
                "received_events_url": "https://api.github.com/users/zeertzjq/received_events",
                "repos_url": "https://api.github.com/users/zeertzjq/repos",
                "site_admin": false,
                "starred_url": "https://api.github.com/users/zeertzjq/starred{/owner}{/repo}",
                "subscriptions_url": "https://api.github.com/users/zeertzjq/subscriptions",
                "type": "User",
                "url": "https://api.github.com/users/zeertzjq",
                "user_view_type": "public"
            }
        }
    ],
    "comments": 2,
    "comments_url": "https://api.github.com/repos/neovim/neovim/issues/38014/comments",
    "created_at": "2026-02-22T09:54:47Z",
    "events_url": "https://api.github.com/repos/neovim/neovim/issues/38014/events",
    "html_url": "https://github.com/neovim/neovim/issues/38014",
    "id": 3974075510,
    "issue_dependencies_summary": {
        "blocked_by": 0,
        "blocking": 0,
        "total_blocked_by": 0,
        "total_blocking": 0
    },
    "labels": [
        {
            "color": "c5def5",
            "default": false,
            "description": "OS processes, spawn",
            "id": 182884815,
            "name": "job-control",
            "node_id": "MDU6TGFiZWwxODI4ODQ4MTU=",
            "url": "https://api.github.com/repos/neovim/neovim/labels/job-control"
        },
        {
            "color": "c7def8",
            "default": false,
            "description": "channels, RPC, msgpack",
            "id": 242522707,
            "name": "channels-rpc",
            "node_id": "MDU6TGFiZWwyNDI1MjI3MDc=",
            "url": "https://api.github.com/repos/neovim/neovim/labels/channels-rpc"
        },
        {
            "color": "f9d0c4",
            "default": false,
            "description": "wrong behavior that was introduced in a previous commit (please bisect)",
            "id": 619474658,
            "name": "bug-regression",
            "node_id": "MDU6TGFiZWw2MTk0NzQ2NTg=",
            "url": "https://api.github.com/repos/neovim/neovim/labels/bug-regression"
        }
    ],
    "labels_url": "https://api.github.com/repos/neovim/neovim/issues/38014/labels{/name}",
    "locked": false,
    "milestone": {
        "closed_at": null,
        "closed_issues": 0,
        "created_at": "2025-02-01T14:58:39Z",
        "creator": {
            "avatar_url": "https://avatars.githubusercontent.com/u/1359421?v=4",
            "events_url": "https://api.github.com/users/justinmk/events{/privacy}",
            "followers_url": "https://api.github.com/users/justinmk/followers",
            "following_url": "https://api.github.com/users/justinmk/following{/other_user}",
            "gists_url": "https://api.github.com/users/justinmk/gists{/gist_id}",
            "gravatar_id": "",
            "html_url": "https://github.com/justinmk",
            "id": 1359421,
            "login": "justinmk",
            "node_id": "MDQ6VXNlcjEzNTk0MjE=",
            "organizations_url": "https://api.github.com/users/justinmk/orgs",
            "received_events_url": "https://api.github.com/users/justinmk/received_events",
            "repos_url": "https://api.github.com/users/justinmk/repos",
            "site_admin": false,
            "starred_url": "https://api.github.com/users/justinmk/starred{/owner}{/repo}",
            "subscriptions_url": "https://api.github.com/users/justinmk/subscriptions",
            "type": "User",
            "url": "https://api.github.com/users/justinmk",
            "user_view_type": "public"
        },
        "description": "",
        "due_on": null,
        "html_url": "https://github.com/neovim/neovim/milestone/48",
        "id": 12251313,
        "labels_url": "https://api.github.com/repos/neovim/neovim/milestones/48/labels",
        "node_id": "MI_kwDOAPphoM4AuvCx",
        "number": 48,
        "open_issues": 29,
        "state": "open",
        "title": "0.13",
        "updated_at": "2026-02-23T13:37:41Z",
        "url": "https://api.github.com/repos/neovim/neovim/milestones/48"
    },
    "node_id": "I_kwDOAPphoM7s35R2",
    "number": 38014,
    "performed_via_github_app": null,
    "pinned_comment": null,
    "reactions": {
        "+1": 0,
        "-1": 0,
        "confused": 0,
        "eyes": 0,
        "heart": 0,
        "hooray": 0,
        "laugh": 0,
        "rocket": 0,
        "total_count": 0,
        "url": "https://api.github.com/repos/neovim/neovim/issues/38014/reactions"
    },
    "repository_url": "https://api.github.com/repos/neovim/neovim",
    "state": "open",
    "state_reason": null,
    "sub_issues_summary": {
        "completed": 0,
        "percent_completed": 0,
        "total": 0
    },
    "timeline_url": "https://api.github.com/repos/neovim/neovim/issues/38014/timeline",
    "title": "Hang if PTY process exits after spawning detached child that keeps writing output",
    "type": {
        "color": "red",
        "created_at": "2024-01-25T10:10:19Z",
        "description": "An unexpected problem or behavior",
        "id": 597163,
        "is_enabled": true,
        "name": "Bug",
        "node_id": "IT_kwDOAGK_Pc4ACRyr",
        "updated_at": "2024-07-26T10:12:30Z"
    },
    "updated_at": "2026-02-23T14:07:20Z",
    "url": "https://api.github.com/repos/neovim/neovim/issues/38014",
    "user": {
        "avatar_url": "https://avatars.githubusercontent.com/u/35768171?v=4",
        "events_url": "https://api.github.com/users/zeertzjq/events{/privacy}",
        "followers_url": "https://api.github.com/users/zeertzjq/followers",
        "following_url": "https://api.github.com/users/zeertzjq/following{/other_user}",
        "gists_url": "https://api.github.com/users/zeertzjq/gists{/gist_id}",
        "gravatar_id": "",
        "html_url": "https://github.com/zeertzjq",
        "id": 35768171,
        "login": "zeertzjq",
        "node_id": "MDQ6VXNlcjM1NzY4MTcx",
        "organizations_url": "https://api.github.com/users/zeertzjq/orgs",
        "received_events_url": "https://api.github.com/users/zeertzjq/received_events",
        "repos_url": "https://api.github.com/users/zeertzjq/repos",
        "site_admin": false,
        "starred_url": "https://api.github.com/users/zeertzjq/starred{/owner}{/repo}",
        "subscriptions_url": "https://api.github.com/users/zeertzjq/subscriptions",
        "type": "User",
        "url": "https://api.github.com/users/zeertzjq",
        "user_view_type": "public"
    }
}