{
    "active_lock_reason": null,
    "assignee": null,
    "assignees": [],
    "author_association": "NONE",
    "body": "### Problem\n\nWhen I enter `:w` to accept the updates gathered by `vim.pack`, the following error occurs:\n\n> vim.schedule callback: /usr/local/share/nvim/runtime/lua/vim/pack.lua:1124: Vim:E784: Cannot close last tab page\n\ncc: @echasnovski \n\n\n### Steps to reproduce\n\n```lua\n-- Only happens when ui2 enabled and cmdheight > 0\nrequire(\"vim._core.ui2\").enable({})\n\n-- We need something to update:\nvim.pack.add({ \"https://github.com/nvim-mini/mini.nvim\" })\n\nlocal make_buffer_autocommand = function(buf_id)\n  local augroup = vim.api.nvim_create_augroup(\"DummyBuffer\", {})\n  local au = function(event, callback, desc)\n    vim.api.nvim_create_autocmd(event, { group = augroup, buffer = buf_id, callback = callback, desc = desc })\n  end\n\n  au(\"BufLeave\", function()\n    if vim.o.cmdheight > 0 then vim.cmd(\"echo ''\") end\n  end, \"On BufLeave\")\nend\n\nlocal open = function()\n  local buf_id = vim.api.nvim_create_buf(false, true)\n  vim.api.nvim_set_current_buf(buf_id)\n\n  make_buffer_autocommand(buf_id)\n\n  local options = {\n    \"bufhidden=wipe\",\n  }\n  vim.cmd((\"silent! noautocmd setlocal %s\"):format(table.concat(options, \" \")))\nend\n\n_G.dummyopen = open\nvim.cmd(\"noautocmd lua _G.dummyopen()\")\n```\n\n1. Open nvim\n2. Type: `:lua vim.pack.update()` and enter\n3. Type: `:w` and enter\n\n### Expected behavior\n\nvim.pack closes cleanly without error\n\n### Nvim version (nvim -v)\n\nNVIM v0.12.0-dev-2209+gdb133879b2\n\n### Vim (not Nvim) behaves the same?\n\nnot applicable\n\n### Operating system/version\n\narch linux\n\n### Terminal name/version\n\nkitty 0.45.0\n\n### $TERM environment variable\n\nxterm-kitty\n\n### Installation\n\nbuild from repo",
    "closed_at": "2026-02-08T14:15:18Z",
    "closed_by": {
        "avatar_url": "https://avatars.githubusercontent.com/u/1359421?v=4",
        "events_url": "https://api.github.com/users/justinmk/events{/privacy}",
        "followers_url": "https://api.github.com/users/justinmk/followers",
        "following_url": "https://api.github.com/users/justinmk/following{/other_user}",
        "gists_url": "https://api.github.com/users/justinmk/gists{/gist_id}",
        "gravatar_id": "",
        "html_url": "https://github.com/justinmk",
        "id": 1359421,
        "login": "justinmk",
        "node_id": "MDQ6VXNlcjEzNTk0MjE=",
        "organizations_url": "https://api.github.com/users/justinmk/orgs",
        "received_events_url": "https://api.github.com/users/justinmk/received_events",
        "repos_url": "https://api.github.com/users/justinmk/repos",
        "site_admin": false,
        "starred_url": "https://api.github.com/users/justinmk/starred{/owner}{/repo}",
        "subscriptions_url": "https://api.github.com/users/justinmk/subscriptions",
        "type": "User",
        "url": "https://api.github.com/users/justinmk",
        "user_view_type": "public"
    },
    "comment_data": [
        {
            "author_association": "MEMBER",
            "body": "Here is a minified version of the 'init.lua' with which I can reproduce the error:\n\n```lua\n-- Only happens when ui2 enabled and cmdheight > 0\nrequire('vim._core.ui2').enable({})\n\n-- We need something to update:\nvim.pack.add({ 'https://github.com/nvim-mini/mini.nvim' })\n\n-- Open a temporary scratch buffer\nvim.api.nvim_set_current_buf(vim.api.nvim_create_buf(false, true))\nvim.bo.bufhidden = 'wipe'\n\n-- Define autocommand that uses ui2\nvim.cmd('au BufLeave * echo \"\"')\n```\n\nHaving both `bufhidden=wipe` and an autocommand needed to trigger the error. Plus reproducing it with `vim.pack` is a bit less taxing with `:lua vim.pack.update(nil, { offline = true })`.\n\nThere is definitely a way (and need, it seems like) to fix this on `vim.pack` side with a [more careful check](https://github.com/neovim/neovim/blob/a33e5fb1bbce06512b35b40b2cb04577a146f2aa/runtime/lua/vim/pack.lua#L1123-L1125), but the fact that this only happens with ui2 enabled is probably an indicator of something bad happening inside of it. @luukvbaal, do you need a `vim.pack` free example of reproducing this?",
            "created_at": "2026-02-06T15:15:28Z",
            "html_url": "https://github.com/neovim/neovim/issues/37749#issuecomment-3861001157",
            "id": 3861001157,
            "issue_url": "https://api.github.com/repos/neovim/neovim/issues/37749",
            "node_id": "IC_kwDOAPphoM7mIjPF",
            "performed_via_github_app": null,
            "pin": null,
            "reactions": {
                "+1": 2,
                "-1": 0,
                "confused": 0,
                "eyes": 0,
                "heart": 0,
                "hooray": 0,
                "laugh": 0,
                "rocket": 0,
                "total_count": 2,
                "url": "https://api.github.com/repos/neovim/neovim/issues/comments/3861001157/reactions"
            },
            "updated_at": "2026-02-06T15:56:20Z",
            "url": "https://api.github.com/repos/neovim/neovim/issues/comments/3861001157",
            "user": {
                "avatar_url": "https://avatars.githubusercontent.com/u/24854248?v=4",
                "events_url": "https://api.github.com/users/echasnovski/events{/privacy}",
                "followers_url": "https://api.github.com/users/echasnovski/followers",
                "following_url": "https://api.github.com/users/echasnovski/following{/other_user}",
                "gists_url": "https://api.github.com/users/echasnovski/gists{/gist_id}",
                "gravatar_id": "",
                "html_url": "https://github.com/echasnovski",
                "id": 24854248,
                "login": "echasnovski",
                "node_id": "MDQ6VXNlcjI0ODU0MjQ4",
                "organizations_url": "https://api.github.com/users/echasnovski/orgs",
                "received_events_url": "https://api.github.com/users/echasnovski/received_events",
                "repos_url": "https://api.github.com/users/echasnovski/repos",
                "site_admin": false,
                "starred_url": "https://api.github.com/users/echasnovski/starred{/owner}{/repo}",
                "subscriptions_url": "https://api.github.com/users/echasnovski/subscriptions",
                "type": "User",
                "url": "https://api.github.com/users/echasnovski",
                "user_view_type": "public"
            }
        },
        {
            "author_association": "MEMBER",
            "body": "I can repoduce from here, thanks. This line is responsible for closing the tabpage, still figuring out if that makes sense or what to do about it. Wondering if that condition can/should be more restrictive. Any clues @zeertzjq?\nhttps://github.com/neovim/neovim/blob/a33e5fb1bbce06512b35b40b2cb04577a146f2aa/src/nvim/buffer.c#L1692-L1698 \n\nSeems like we're closing windows for a hypothetical scenario that wouldn't have happened in the first place in this repro. I.e. `close_buffer()` does not wipe the buffer.",
            "created_at": "2026-02-06T15:50:44Z",
            "html_url": "https://github.com/neovim/neovim/issues/37749#issuecomment-3861159462",
            "id": 3861159462,
            "issue_url": "https://api.github.com/repos/neovim/neovim/issues/37749",
            "node_id": "IC_kwDOAPphoM7mJJ4m",
            "performed_via_github_app": null,
            "pin": null,
            "reactions": {
                "+1": 1,
                "-1": 0,
                "confused": 0,
                "eyes": 0,
                "heart": 0,
                "hooray": 0,
                "laugh": 0,
                "rocket": 0,
                "total_count": 1,
                "url": "https://api.github.com/repos/neovim/neovim/issues/comments/3861159462/reactions"
            },
            "updated_at": "2026-02-06T18:00:35Z",
            "url": "https://api.github.com/repos/neovim/neovim/issues/comments/3861159462",
            "user": {
                "avatar_url": "https://avatars.githubusercontent.com/u/31730729?v=4",
                "events_url": "https://api.github.com/users/luukvbaal/events{/privacy}",
                "followers_url": "https://api.github.com/users/luukvbaal/followers",
                "following_url": "https://api.github.com/users/luukvbaal/following{/other_user}",
                "gists_url": "https://api.github.com/users/luukvbaal/gists{/gist_id}",
                "gravatar_id": "",
                "html_url": "https://github.com/luukvbaal",
                "id": 31730729,
                "login": "luukvbaal",
                "node_id": "MDQ6VXNlcjMxNzMwNzI5",
                "organizations_url": "https://api.github.com/users/luukvbaal/orgs",
                "received_events_url": "https://api.github.com/users/luukvbaal/received_events",
                "repos_url": "https://api.github.com/users/luukvbaal/repos",
                "site_admin": false,
                "starred_url": "https://api.github.com/users/luukvbaal/starred{/owner}{/repo}",
                "subscriptions_url": "https://api.github.com/users/luukvbaal/subscriptions",
                "type": "User",
                "url": "https://api.github.com/users/luukvbaal",
                "user_view_type": "public"
            }
        },
        {
            "author_association": "MEMBER",
            "body": "> This line is responsible for closing the tabpage, still figuring out if that makes sense or what to do about it.\n\nYeah, I somehow missed that the whole tabpage with created scratch buffer is closed right after the `vim.pack` tabpage is opened. I thought it was something more complicated with how confirmation buffer tabpage is closed.",
            "created_at": "2026-02-06T15:57:58Z",
            "html_url": "https://github.com/neovim/neovim/issues/37749#issuecomment-3861194098",
            "id": 3861194098,
            "issue_url": "https://api.github.com/repos/neovim/neovim/issues/37749",
            "node_id": "IC_kwDOAPphoM7mJSVy",
            "performed_via_github_app": null,
            "pin": null,
            "reactions": {
                "+1": 0,
                "-1": 0,
                "confused": 0,
                "eyes": 0,
                "heart": 0,
                "hooray": 0,
                "laugh": 0,
                "rocket": 0,
                "total_count": 0,
                "url": "https://api.github.com/repos/neovim/neovim/issues/comments/3861194098/reactions"
            },
            "updated_at": "2026-02-06T15:57:58Z",
            "url": "https://api.github.com/repos/neovim/neovim/issues/comments/3861194098",
            "user": {
                "avatar_url": "https://avatars.githubusercontent.com/u/24854248?v=4",
                "events_url": "https://api.github.com/users/echasnovski/events{/privacy}",
                "followers_url": "https://api.github.com/users/echasnovski/followers",
                "following_url": "https://api.github.com/users/echasnovski/following{/other_user}",
                "gists_url": "https://api.github.com/users/echasnovski/gists{/gist_id}",
                "gravatar_id": "",
                "html_url": "https://github.com/echasnovski",
                "id": 24854248,
                "login": "echasnovski",
                "node_id": "MDQ6VXNlcjI0ODU0MjQ4",
                "organizations_url": "https://api.github.com/users/echasnovski/orgs",
                "received_events_url": "https://api.github.com/users/echasnovski/received_events",
                "repos_url": "https://api.github.com/users/echasnovski/repos",
                "site_admin": false,
                "starred_url": "https://api.github.com/users/echasnovski/starred{/owner}{/repo}",
                "subscriptions_url": "https://api.github.com/users/echasnovski/subscriptions",
                "type": "User",
                "url": "https://api.github.com/users/echasnovski",
                "user_view_type": "public"
            }
        },
        {
            "author_association": "MEMBER",
            "body": "I think it at least shouldn't be done with `DOBUF_SPLIT`:\n```diff\ndiff --git a/src/nvim/buffer.c b/src/nvim/buffer.c\nindex ba6e03a729..a1964ae979 100644\n--- a/src/nvim/buffer.c\n+++ b/src/nvim/buffer.c\n@@ -1692,7 +1692,7 @@ void set_curbuf(buf_T *buf, int action, bool update_jumplist)\n     // autocommands may have opened a new window\n     // with prevbuf, grr\n     if (unload\n-        || (last_winid != get_last_winid()\n+        || (action != DOBUF_SPLIT && last_winid != get_last_winid()\n             && strchr(\"wdu\", prevbuf->b_p_bh[0]) != NULL)) {\n       close_windows(prevbuf, false);\n     }\n```",
            "created_at": "2026-02-06T23:29:26Z",
            "html_url": "https://github.com/neovim/neovim/issues/37749#issuecomment-3863020554",
            "id": 3863020554,
            "issue_url": "https://api.github.com/repos/neovim/neovim/issues/37749",
            "node_id": "IC_kwDOAPphoM7mQQQK",
            "performed_via_github_app": null,
            "pin": null,
            "reactions": {
                "+1": 0,
                "-1": 0,
                "confused": 0,
                "eyes": 0,
                "heart": 0,
                "hooray": 0,
                "laugh": 0,
                "rocket": 0,
                "total_count": 0,
                "url": "https://api.github.com/repos/neovim/neovim/issues/comments/3863020554/reactions"
            },
            "updated_at": "2026-02-06T23:29:26Z",
            "url": "https://api.github.com/repos/neovim/neovim/issues/comments/3863020554",
            "user": {
                "avatar_url": "https://avatars.githubusercontent.com/u/35768171?v=4",
                "events_url": "https://api.github.com/users/zeertzjq/events{/privacy}",
                "followers_url": "https://api.github.com/users/zeertzjq/followers",
                "following_url": "https://api.github.com/users/zeertzjq/following{/other_user}",
                "gists_url": "https://api.github.com/users/zeertzjq/gists{/gist_id}",
                "gravatar_id": "",
                "html_url": "https://github.com/zeertzjq",
                "id": 35768171,
                "login": "zeertzjq",
                "node_id": "MDQ6VXNlcjM1NzY4MTcx",
                "organizations_url": "https://api.github.com/users/zeertzjq/orgs",
                "received_events_url": "https://api.github.com/users/zeertzjq/received_events",
                "repos_url": "https://api.github.com/users/zeertzjq/repos",
                "site_admin": false,
                "starred_url": "https://api.github.com/users/zeertzjq/starred{/owner}{/repo}",
                "subscriptions_url": "https://api.github.com/users/zeertzjq/subscriptions",
                "type": "User",
                "url": "https://api.github.com/users/zeertzjq",
                "user_view_type": "public"
            }
        },
        {
            "author_association": "MEMBER",
            "body": "Here's a simple repro btw\n\n```vim\nsetlocal bufhidden=wipe\nnew foo\nclose\nau BufLeave * split\ntab1 sbuffer2\n```",
            "created_at": "2026-02-06T23:48:25Z",
            "html_url": "https://github.com/neovim/neovim/issues/37749#issuecomment-3863058541",
            "id": 3863058541,
            "issue_url": "https://api.github.com/repos/neovim/neovim/issues/37749",
            "node_id": "IC_kwDOAPphoM7mQZht",
            "performed_via_github_app": null,
            "pin": null,
            "reactions": {
                "+1": 0,
                "-1": 0,
                "confused": 0,
                "eyes": 0,
                "heart": 0,
                "hooray": 0,
                "laugh": 0,
                "rocket": 1,
                "total_count": 1,
                "url": "https://api.github.com/repos/neovim/neovim/issues/comments/3863058541/reactions"
            },
            "updated_at": "2026-02-06T23:48:25Z",
            "url": "https://api.github.com/repos/neovim/neovim/issues/comments/3863058541",
            "user": {
                "avatar_url": "https://avatars.githubusercontent.com/u/31730729?v=4",
                "events_url": "https://api.github.com/users/luukvbaal/events{/privacy}",
                "followers_url": "https://api.github.com/users/luukvbaal/followers",
                "following_url": "https://api.github.com/users/luukvbaal/following{/other_user}",
                "gists_url": "https://api.github.com/users/luukvbaal/gists{/gist_id}",
                "gravatar_id": "",
                "html_url": "https://github.com/luukvbaal",
                "id": 31730729,
                "login": "luukvbaal",
                "node_id": "MDQ6VXNlcjMxNzMwNzI5",
                "organizations_url": "https://api.github.com/users/luukvbaal/orgs",
                "received_events_url": "https://api.github.com/users/luukvbaal/received_events",
                "repos_url": "https://api.github.com/users/luukvbaal/repos",
                "site_admin": false,
                "starred_url": "https://api.github.com/users/luukvbaal/starred{/owner}{/repo}",
                "subscriptions_url": "https://api.github.com/users/luukvbaal/subscriptions",
                "type": "User",
                "url": "https://api.github.com/users/luukvbaal",
                "user_view_type": "public"
            }
        }
    ],
    "comments": 5,
    "comments_url": "https://api.github.com/repos/neovim/neovim/issues/37749/comments",
    "created_at": "2026-02-06T10:47:00Z",
    "events_url": "https://api.github.com/repos/neovim/neovim/issues/37749/events",
    "html_url": "https://github.com/neovim/neovim/issues/37749",
    "id": 3906136701,
    "issue_dependencies_summary": {
        "blocked_by": 0,
        "blocking": 0,
        "total_blocked_by": 0,
        "total_blocking": 0
    },
    "labels": [
        {
            "color": "bfd4f2",
            "default": false,
            "description": "vim.pack, start/opt packages, 'packpath'",
            "id": 8889050758,
            "name": "packages",
            "node_id": "LA_kwDOAPphoM8AAAACEdQmhg",
            "url": "https://api.github.com/repos/neovim/neovim/labels/packages"
        },
        {
            "color": "c5def5",
            "default": false,
            "description": "Nvim 0.12 mesages/dialog/pager/notifications based on the UI-ext protocol",
            "id": 8934685970,
            "name": "ui2",
            "node_id": "LA_kwDOAPphoM8AAAACFIx9Eg",
            "url": "https://api.github.com/repos/neovim/neovim/labels/ui2"
        }
    ],
    "labels_url": "https://api.github.com/repos/neovim/neovim/issues/37749/labels{/name}",
    "locked": false,
    "milestone": null,
    "node_id": "I_kwDOAPphoM7o0up9",
    "number": 37749,
    "performed_via_github_app": null,
    "reactions": {
        "+1": 1,
        "-1": 0,
        "confused": 0,
        "eyes": 0,
        "heart": 0,
        "hooray": 0,
        "laugh": 0,
        "rocket": 0,
        "total_count": 1,
        "url": "https://api.github.com/repos/neovim/neovim/issues/37749/reactions"
    },
    "repository_url": "https://api.github.com/repos/neovim/neovim",
    "state": "closed",
    "state_reason": "completed",
    "sub_issues_summary": {
        "completed": 0,
        "percent_completed": 0,
        "total": 0
    },
    "timeline_url": "https://api.github.com/repos/neovim/neovim/issues/37749/timeline",
    "title": "vim.pack: Vim:E784: Cannot close last tab page",
    "type": {
        "color": "red",
        "created_at": "2024-01-25T10:10:19Z",
        "description": "An unexpected problem or behavior",
        "id": 597163,
        "is_enabled": true,
        "name": "Bug",
        "node_id": "IT_kwDOAGK_Pc4ACRyr",
        "updated_at": "2024-07-26T10:12:30Z"
    },
    "updated_at": "2026-02-08T14:15:18Z",
    "url": "https://api.github.com/repos/neovim/neovim/issues/37749",
    "user": {
        "avatar_url": "https://avatars.githubusercontent.com/u/58370433?v=4",
        "events_url": "https://api.github.com/users/abeldekat/events{/privacy}",
        "followers_url": "https://api.github.com/users/abeldekat/followers",
        "following_url": "https://api.github.com/users/abeldekat/following{/other_user}",
        "gists_url": "https://api.github.com/users/abeldekat/gists{/gist_id}",
        "gravatar_id": "",
        "html_url": "https://github.com/abeldekat",
        "id": 58370433,
        "login": "abeldekat",
        "node_id": "MDQ6VXNlcjU4MzcwNDMz",
        "organizations_url": "https://api.github.com/users/abeldekat/orgs",
        "received_events_url": "https://api.github.com/users/abeldekat/received_events",
        "repos_url": "https://api.github.com/users/abeldekat/repos",
        "site_admin": false,
        "starred_url": "https://api.github.com/users/abeldekat/starred{/owner}{/repo}",
        "subscriptions_url": "https://api.github.com/users/abeldekat/subscriptions",
        "type": "User",
        "url": "https://api.github.com/users/abeldekat",
        "user_view_type": "public"
    }
}