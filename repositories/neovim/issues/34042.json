{
    "active_lock_reason": null,
    "assignee": null,
    "assignees": [],
    "author_association": "NONE",
    "body": "### Problem\n\n![Image](https://github.com/user-attachments/assets/995a0723-7066-4008-a295-a59033c4b9f9)\n\n### Steps to reproduce\n\nrepro.lua:\n\n```lua\nvim.o.foldmethod = \"expr\"\nvim.lsp.config.lua_ls = {\n\tcmd = { \"lua-language-server\" },\n\tfiletypes = { \"lua\" },\n\troot_markers = {\n\t\t\".luarc.json\",\n\t\t\".luarc.jsonc\",\n\t\t\".luacheckrc\",\n\t\t\".stylua.toml\",\n\t\t\"stylua.toml\",\n\t\t\"selene.toml\",\n\t\t\"selene.yml\",\n\t\t\".git\",\n\t},\n}\n\nvim.lsp.enable(\"lua_ls\")\nvim.api.nvim_create_autocmd(\"FileType\", {\n  callback = function(args)\n    vim.wo.foldmethod = \"expr\"\n    vim.wo.foldexpr = \"v.lua:vim.treesitter.foldexpr()\"\n    vim.wo.foldlevel = 3\n  end,\n})\n\n---@class (private) vim.lsp.folding_range.BufState\n---\n---@field version? integer\n---\n--- Never use this directly, `renew()` the cached foldinfo\n--- then use on demand via `row_*` fields.\n---\n--- Index In the form of client_id -> ranges\n---@field client_ranges table<integer, lsp.FoldingRange[]?>\n---\n--- Index in the form of row -> [foldlevel, mark]\n---@field row_level table<integer, [integer, \">\" | \"<\"?]?>\n---\n--- Index in the form of start_row -> kinds\n---@field row_kinds table<integer, table<lsp.FoldingRangeKind, true?>?>>\n---\n--- Index in the form of start_row -> collapsed_text\n---@field row_text table<integer, string?>\n\n---@type table<integer, vim.lsp.folding_range.BufState?>\nvim.api.nvim_create_autocmd(\"LspNotify\", {\n\tcallback = function(args)\n\t\tvim.lsp.foldclose(\"comment\", vim.fn.bufwinid(args.buf))\n\tend,\n})\n\n\nvim.api.nvim_create_autocmd(\"LspAttach\", {\n  callback = function(args)\n\n    -- Prefer LSP folding if client supports it\n    local win = vim.api.nvim_get_current_win()\n    vim.wo[win][0].foldmethod = \"expr\"\n    vim.wo[win][0].foldexpr = \"v:lua.vim.lsp.foldexpr()\"\n    vim.wo[win][0].foldlevel = 3\n  end,\n})\n```\n\n```shell\nnvim -u repro.lua repro.lua\n:e\n```\n\n### Expected behavior\n\nno error happened\n\n### Nvim version (nvim -v)\n\nNVIM v0.11.1\n\n### Vim (not Nvim) behaves the same?\n\nno\n\n### Operating system/version\n\nmacOS, 15.3.1\n\n### Terminal name/version\n\nKitty 0.42.0\n\n### $TERM environment variable\n\nxterm-kitty\n\n### Installation\n\nhomebrew",
    "closed_at": null,
    "closed_by": null,
    "comment_data": [
        {
            "author_association": "NONE",
            "body": "Concerning issue #34042, the error `E490` when editing Lua files with the provided configuration seems related to the interaction between LSP, folding, and potentially treesitter. The traceback suggests an issue during folding or displaying messages.\n\nThe configuration sets `foldmethod` to `expr` and `foldexpr` to `vim.treesitter.foldexpr()`, while also using `vim.lsp.enable(\"lua_ls\")` and `vim.lsp.foldclose(\"comment\", ...)` in an `LspNotify` autocmd, and setting `foldmethod` to `expr` and `foldexpr` to `v:lua.vim.lsp.foldexpr()` in an `LspAttach` autocmd.\n\nThere might be a conflict or incorrect state being set up due to the multiple places trying to control folding and the interaction between treesitter and LSP folding. It could be helpful to simplify the configuration to isolate whether the issue lies with LSP folding, treesitter folding, or the combination and timing of the autocmds.",
            "created_at": "2025-05-16T10:55:39Z",
            "html_url": "https://github.com/neovim/neovim/issues/34042#issuecomment-2886384804",
            "id": 2886384804,
            "issue_url": "https://api.github.com/repos/neovim/neovim/issues/34042",
            "node_id": "IC_kwDOAPphoM6sCryk",
            "performed_via_github_app": null,
            "reactions": {
                "+1": 0,
                "-1": 0,
                "confused": 0,
                "eyes": 0,
                "heart": 0,
                "hooray": 0,
                "laugh": 0,
                "rocket": 0,
                "total_count": 0,
                "url": "https://api.github.com/repos/neovim/neovim/issues/comments/2886384804/reactions"
            },
            "updated_at": "2025-05-16T10:55:39Z",
            "url": "https://api.github.com/repos/neovim/neovim/issues/comments/2886384804",
            "user": {
                "avatar_url": "https://avatars.githubusercontent.com/u/75843278?v=4",
                "events_url": "https://api.github.com/users/d7manDev/events{/privacy}",
                "followers_url": "https://api.github.com/users/d7manDev/followers",
                "following_url": "https://api.github.com/users/d7manDev/following{/other_user}",
                "gists_url": "https://api.github.com/users/d7manDev/gists{/gist_id}",
                "gravatar_id": "",
                "html_url": "https://github.com/d7manDev",
                "id": 75843278,
                "login": "d7manDev",
                "node_id": "MDQ6VXNlcjc1ODQzMjc4",
                "organizations_url": "https://api.github.com/users/d7manDev/orgs",
                "received_events_url": "https://api.github.com/users/d7manDev/received_events",
                "repos_url": "https://api.github.com/users/d7manDev/repos",
                "site_admin": false,
                "starred_url": "https://api.github.com/users/d7manDev/starred{/owner}{/repo}",
                "subscriptions_url": "https://api.github.com/users/d7manDev/subscriptions",
                "type": "User",
                "url": "https://api.github.com/users/d7manDev",
                "user_view_type": "public"
            }
        },
        {
            "author_association": "CONTRIBUTOR",
            "body": "The cause of this error is that when `vim.lsp.foldclose` is triggered, the `foldexpr` of the window it affects is not `vim.lsp.foldexpr`. This situation is more common in Lua files because the `foldexpr` of Lua files is set to `vim.treesitter.foldexpr` by default in `runtime/ftplugin/lua.lua`. This error can be easily resolved by the user (for example, by writing their own `ftplugin/lua.lua` to set `foldexpr` to `vim.lsp.foldexpr`), and it can also be easily ignored directly in the code of this repository. I prefer not to change nvim's behavior because using `foldclose()` in such a window is incorrect, and ignoring such errors may overlook other potential issues.",
            "created_at": "2025-05-18T08:41:26Z",
            "html_url": "https://github.com/neovim/neovim/issues/34042#issuecomment-2888860591",
            "id": 2888860591,
            "issue_url": "https://api.github.com/repos/neovim/neovim/issues/34042",
            "node_id": "IC_kwDOAPphoM6sMIOv",
            "performed_via_github_app": null,
            "reactions": {
                "+1": 1,
                "-1": 0,
                "confused": 0,
                "eyes": 0,
                "heart": 0,
                "hooray": 0,
                "laugh": 0,
                "rocket": 0,
                "total_count": 1,
                "url": "https://api.github.com/repos/neovim/neovim/issues/comments/2888860591/reactions"
            },
            "updated_at": "2025-05-18T08:41:26Z",
            "url": "https://api.github.com/repos/neovim/neovim/issues/comments/2888860591",
            "user": {
                "avatar_url": "https://avatars.githubusercontent.com/u/61115159?v=4",
                "events_url": "https://api.github.com/users/ofseed/events{/privacy}",
                "followers_url": "https://api.github.com/users/ofseed/followers",
                "following_url": "https://api.github.com/users/ofseed/following{/other_user}",
                "gists_url": "https://api.github.com/users/ofseed/gists{/gist_id}",
                "gravatar_id": "",
                "html_url": "https://github.com/ofseed",
                "id": 61115159,
                "login": "ofseed",
                "node_id": "MDQ6VXNlcjYxMTE1MTU5",
                "organizations_url": "https://api.github.com/users/ofseed/orgs",
                "received_events_url": "https://api.github.com/users/ofseed/received_events",
                "repos_url": "https://api.github.com/users/ofseed/repos",
                "site_admin": false,
                "starred_url": "https://api.github.com/users/ofseed/starred{/owner}{/repo}",
                "subscriptions_url": "https://api.github.com/users/ofseed/subscriptions",
                "type": "User",
                "url": "https://api.github.com/users/ofseed",
                "user_view_type": "public"
            }
        }
    ],
    "comments": 2,
    "comments_url": "https://api.github.com/repos/neovim/neovim/issues/34042/comments",
    "created_at": "2025-05-16T06:13:12Z",
    "events_url": "https://api.github.com/repos/neovim/neovim/issues/34042/events",
    "html_url": "https://github.com/neovim/neovim/issues/34042",
    "id": 3068044488,
    "labels": [
        {
            "color": "c5def5",
            "default": false,
            "description": null,
            "id": 662566370,
            "name": "lsp",
            "node_id": "MDU6TGFiZWw2NjI1NjYzNzA=",
            "url": "https://api.github.com/repos/neovim/neovim/labels/lsp"
        }
    ],
    "labels_url": "https://api.github.com/repos/neovim/neovim/issues/34042/labels{/name}",
    "locked": false,
    "milestone": null,
    "node_id": "I_kwDOAPphoM623qTI",
    "number": 34042,
    "performed_via_github_app": null,
    "reactions": {
        "+1": 0,
        "-1": 0,
        "confused": 0,
        "eyes": 0,
        "heart": 0,
        "hooray": 0,
        "laugh": 0,
        "rocket": 0,
        "total_count": 0,
        "url": "https://api.github.com/repos/neovim/neovim/issues/34042/reactions"
    },
    "repository_url": "https://api.github.com/repos/neovim/neovim",
    "state": "open",
    "state_reason": null,
    "sub_issues_summary": {
        "completed": 0,
        "percent_completed": 0,
        "total": 0
    },
    "timeline_url": "https://api.github.com/repos/neovim/neovim/issues/34042/timeline",
    "title": "E490 raised when edit lua files",
    "type": {
        "color": "red",
        "created_at": "2024-01-25T10:10:19Z",
        "description": "An unexpected problem or behavior",
        "id": 597163,
        "is_enabled": true,
        "name": "Bug",
        "node_id": "IT_kwDOAGK_Pc4ACRyr",
        "updated_at": "2024-07-26T10:12:30Z"
    },
    "updated_at": "2025-05-18T08:41:27Z",
    "url": "https://api.github.com/repos/neovim/neovim/issues/34042",
    "user": {
        "avatar_url": "https://avatars.githubusercontent.com/u/41264693?v=4",
        "events_url": "https://api.github.com/users/jiz4oh/events{/privacy}",
        "followers_url": "https://api.github.com/users/jiz4oh/followers",
        "following_url": "https://api.github.com/users/jiz4oh/following{/other_user}",
        "gists_url": "https://api.github.com/users/jiz4oh/gists{/gist_id}",
        "gravatar_id": "",
        "html_url": "https://github.com/jiz4oh",
        "id": 41264693,
        "login": "jiz4oh",
        "node_id": "MDQ6VXNlcjQxMjY0Njkz",
        "organizations_url": "https://api.github.com/users/jiz4oh/orgs",
        "received_events_url": "https://api.github.com/users/jiz4oh/received_events",
        "repos_url": "https://api.github.com/users/jiz4oh/repos",
        "site_admin": false,
        "starred_url": "https://api.github.com/users/jiz4oh/starred{/owner}{/repo}",
        "subscriptions_url": "https://api.github.com/users/jiz4oh/subscriptions",
        "type": "User",
        "url": "https://api.github.com/users/jiz4oh",
        "user_view_type": "public"
    }
}