{
    "active_lock_reason": null,
    "assignee": null,
    "assignees": [],
    "author_association": "NONE",
    "body": "### Problem\n\nWhen both `<Up>` and `<CR>` are remapped, vim does not update command history items so that the most recently executed command is always last.\n\n### Steps to reproduce\n\nSave the following file as `init.lua`:\n```lua\n-- These two lines cause the bug. Either single one will not cause the bug.\nvim.fn.execute('cnoremap <Up> <Up>')\nvim.fn.execute('cnoremap <CR> <CR>')\n```\n\nRun `nvim -u init.lua`. Type `:A<CR>` `:B<CR>` `:<Up><Up><CR>` `:<Up>`\n\n### Expected behavior\n\nthe command line shows \"A\"\n\nActual behavior:\nthe command line shows \"B\"\n\n### Nvim version (nvim -v)\n\nv0.11.4\n\n### Vim (not Nvim) behaves the same?\n\nyes, vim 9.0\n\n### Operating system/version\n\nmacOS 14.7.7 (23H723)\n\n### Terminal name/version\n\niTerm2 Build 3.6.4\n\n### $TERM environment variable\n\nxterm-256color\n\n### Installation\n\ngithub releases",
    "closed_at": null,
    "closed_by": null,
    "comment_data": [
        {
            "author_association": "NONE",
            "body": "Updated: I just realized my vimscript style confirmation was wrong. I've reduced the repro case to using vimscript style `cnoremap`, which still has the same problem.",
            "created_at": "2025-10-20T03:49:08Z",
            "html_url": "https://github.com/neovim/neovim/issues/36256#issuecomment-3420443321",
            "id": 3420443321,
            "issue_url": "https://api.github.com/repos/neovim/neovim/issues/36256",
            "node_id": "IC_kwDOAPphoM7L39K5",
            "performed_via_github_app": null,
            "reactions": {
                "+1": 0,
                "-1": 0,
                "confused": 0,
                "eyes": 0,
                "heart": 0,
                "hooray": 0,
                "laugh": 0,
                "rocket": 0,
                "total_count": 0,
                "url": "https://api.github.com/repos/neovim/neovim/issues/comments/3420443321/reactions"
            },
            "updated_at": "2025-10-20T03:49:08Z",
            "url": "https://api.github.com/repos/neovim/neovim/issues/comments/3420443321",
            "user": {
                "avatar_url": "https://avatars.githubusercontent.com/u/1216626?v=4",
                "events_url": "https://api.github.com/users/CGamesPlay/events{/privacy}",
                "followers_url": "https://api.github.com/users/CGamesPlay/followers",
                "following_url": "https://api.github.com/users/CGamesPlay/following{/other_user}",
                "gists_url": "https://api.github.com/users/CGamesPlay/gists{/gist_id}",
                "gravatar_id": "",
                "html_url": "https://github.com/CGamesPlay",
                "id": 1216626,
                "login": "CGamesPlay",
                "node_id": "MDQ6VXNlcjEyMTY2MjY=",
                "organizations_url": "https://api.github.com/users/CGamesPlay/orgs",
                "received_events_url": "https://api.github.com/users/CGamesPlay/received_events",
                "repos_url": "https://api.github.com/users/CGamesPlay/repos",
                "site_admin": false,
                "starred_url": "https://api.github.com/users/CGamesPlay/starred{/owner}{/repo}",
                "subscriptions_url": "https://api.github.com/users/CGamesPlay/subscriptions",
                "type": "User",
                "url": "https://api.github.com/users/CGamesPlay",
                "user_view_type": "public"
            }
        },
        {
            "author_association": "MEMBER",
            "body": "This is kind of working as intended. See `:h history`:\n```\n- Only commands that are typed are remembered.  Ones that completely come from\n  mappings are not put in the history.\n```\nHowever, it's not entirely clear whether this case actually counts as \"completely come from mappings\".\n\nA easy patch to fix this:\n```diff\ndiff --git a/src/nvim/ex_getln.c b/src/nvim/ex_getln.c\nindex f617f9be04..95a6cdeb14 100644\n--- a/src/nvim/ex_getln.c\n+++ b/src/nvim/ex_getln.c\n@@ -1038,6 +1038,10 @@ static int command_line_check(VimState *state)\n                            // that occurs while typing a command should\n                            // cause the command not to be executed.\n \n+  if (stuff_empty() && typebuf.tb_len == 0) {\n+    s->some_key_typed = true;\n+  }\n+\n   // Trigger SafeState if nothing is pending.\n   may_trigger_safestate(s->xpc.xp_numfiles <= 0);\n \n```\n\nBut I'm not sure if it is desired or will cause other problems.",
            "created_at": "2025-10-20T04:40:52Z",
            "html_url": "https://github.com/neovim/neovim/issues/36256#issuecomment-3420526305",
            "id": 3420526305,
            "issue_url": "https://api.github.com/repos/neovim/neovim/issues/36256",
            "node_id": "IC_kwDOAPphoM7L4Rbh",
            "performed_via_github_app": null,
            "reactions": {
                "+1": 0,
                "-1": 0,
                "confused": 0,
                "eyes": 0,
                "heart": 0,
                "hooray": 0,
                "laugh": 0,
                "rocket": 0,
                "total_count": 0,
                "url": "https://api.github.com/repos/neovim/neovim/issues/comments/3420526305/reactions"
            },
            "updated_at": "2025-10-20T13:22:35Z",
            "url": "https://api.github.com/repos/neovim/neovim/issues/comments/3420526305",
            "user": {
                "avatar_url": "https://avatars.githubusercontent.com/u/35768171?v=4",
                "events_url": "https://api.github.com/users/zeertzjq/events{/privacy}",
                "followers_url": "https://api.github.com/users/zeertzjq/followers",
                "following_url": "https://api.github.com/users/zeertzjq/following{/other_user}",
                "gists_url": "https://api.github.com/users/zeertzjq/gists{/gist_id}",
                "gravatar_id": "",
                "html_url": "https://github.com/zeertzjq",
                "id": 35768171,
                "login": "zeertzjq",
                "node_id": "MDQ6VXNlcjM1NzY4MTcx",
                "organizations_url": "https://api.github.com/users/zeertzjq/orgs",
                "received_events_url": "https://api.github.com/users/zeertzjq/received_events",
                "repos_url": "https://api.github.com/users/zeertzjq/repos",
                "site_admin": false,
                "starred_url": "https://api.github.com/users/zeertzjq/starred{/owner}{/repo}",
                "subscriptions_url": "https://api.github.com/users/zeertzjq/subscriptions",
                "type": "User",
                "url": "https://api.github.com/users/zeertzjq",
                "user_view_type": "public"
            }
        },
        {
            "author_association": "NONE",
            "body": "I don't feel like this command comes completely from mappings at all. For some context/use case, I want to map these so that I can use different behavior in wildmenu. Specifically, what I want is `cmap <expr> <Up> 'wildmenumode() ? \"<C-p>\" : \"<Up>\"'`. I found that [using feedkeys(..., \"nt\")](https://github.com/CGamesPlay/dotfiles/blob/2484f6f7d0ab302e2afb508a83f9ede49040320d/files/.config/nvim/lua/config/builtin.lua#L257) is a workaround.",
            "created_at": "2025-10-20T05:51:36Z",
            "html_url": "https://github.com/neovim/neovim/issues/36256#issuecomment-3420664973",
            "id": 3420664973,
            "issue_url": "https://api.github.com/repos/neovim/neovim/issues/36256",
            "node_id": "IC_kwDOAPphoM7L4zSN",
            "performed_via_github_app": null,
            "reactions": {
                "+1": 0,
                "-1": 0,
                "confused": 0,
                "eyes": 0,
                "heart": 0,
                "hooray": 0,
                "laugh": 0,
                "rocket": 0,
                "total_count": 0,
                "url": "https://api.github.com/repos/neovim/neovim/issues/comments/3420664973/reactions"
            },
            "updated_at": "2025-10-20T05:52:40Z",
            "url": "https://api.github.com/repos/neovim/neovim/issues/comments/3420664973",
            "user": {
                "avatar_url": "https://avatars.githubusercontent.com/u/1216626?v=4",
                "events_url": "https://api.github.com/users/CGamesPlay/events{/privacy}",
                "followers_url": "https://api.github.com/users/CGamesPlay/followers",
                "following_url": "https://api.github.com/users/CGamesPlay/following{/other_user}",
                "gists_url": "https://api.github.com/users/CGamesPlay/gists{/gist_id}",
                "gravatar_id": "",
                "html_url": "https://github.com/CGamesPlay",
                "id": 1216626,
                "login": "CGamesPlay",
                "node_id": "MDQ6VXNlcjEyMTY2MjY=",
                "organizations_url": "https://api.github.com/users/CGamesPlay/orgs",
                "received_events_url": "https://api.github.com/users/CGamesPlay/received_events",
                "repos_url": "https://api.github.com/users/CGamesPlay/repos",
                "site_admin": false,
                "starred_url": "https://api.github.com/users/CGamesPlay/starred{/owner}{/repo}",
                "subscriptions_url": "https://api.github.com/users/CGamesPlay/subscriptions",
                "type": "User",
                "url": "https://api.github.com/users/CGamesPlay",
                "user_view_type": "public"
            }
        },
        {
            "author_association": "CONTRIBUTOR",
            "body": "> I don't feel like this command comes completely from mappings at all. \n\nI agree. I would consider a command that completely comes from a keymap to be something like the keymap expression `dd:cnext`. The cnext shouldn't be added to the command history.\n\nAlternatively,  we could expose the functionality behind these original keymaps and any other problematic ones  to the lua api because there have been many other footguns i have run into in customizing my command completion keymaps to do what I want.\n\nEdit: added context for why I agree\n",
            "created_at": "2025-10-20T11:59:08Z",
            "html_url": "https://github.com/neovim/neovim/issues/36256#issuecomment-3421770288",
            "id": 3421770288,
            "issue_url": "https://api.github.com/repos/neovim/neovim/issues/36256",
            "node_id": "IC_kwDOAPphoM7L9BIw",
            "performed_via_github_app": null,
            "reactions": {
                "+1": 0,
                "-1": 0,
                "confused": 0,
                "eyes": 0,
                "heart": 0,
                "hooray": 0,
                "laugh": 0,
                "rocket": 0,
                "total_count": 0,
                "url": "https://api.github.com/repos/neovim/neovim/issues/comments/3421770288/reactions"
            },
            "updated_at": "2025-10-20T12:07:11Z",
            "url": "https://api.github.com/repos/neovim/neovim/issues/comments/3421770288",
            "user": {
                "avatar_url": "https://avatars.githubusercontent.com/u/51029315?v=4",
                "events_url": "https://api.github.com/users/crwebb85/events{/privacy}",
                "followers_url": "https://api.github.com/users/crwebb85/followers",
                "following_url": "https://api.github.com/users/crwebb85/following{/other_user}",
                "gists_url": "https://api.github.com/users/crwebb85/gists{/gist_id}",
                "gravatar_id": "",
                "html_url": "https://github.com/crwebb85",
                "id": 51029315,
                "login": "crwebb85",
                "node_id": "MDQ6VXNlcjUxMDI5MzE1",
                "organizations_url": "https://api.github.com/users/crwebb85/orgs",
                "received_events_url": "https://api.github.com/users/crwebb85/received_events",
                "repos_url": "https://api.github.com/users/crwebb85/repos",
                "site_admin": false,
                "starred_url": "https://api.github.com/users/crwebb85/starred{/owner}{/repo}",
                "subscriptions_url": "https://api.github.com/users/crwebb85/subscriptions",
                "type": "User",
                "url": "https://api.github.com/users/crwebb85",
                "user_view_type": "public"
            }
        }
    ],
    "comments": 4,
    "comments_url": "https://api.github.com/repos/neovim/neovim/issues/36256/comments",
    "created_at": "2025-10-20T03:37:44Z",
    "events_url": "https://api.github.com/repos/neovim/neovim/issues/36256/events",
    "html_url": "https://github.com/neovim/neovim/issues/36256",
    "id": 3530917094,
    "issue_dependencies_summary": {
        "blocked_by": 0,
        "blocking": 0,
        "total_blocked_by": 0,
        "total_blocking": 0
    },
    "labels": [
        {
            "color": "F9D0C4",
            "default": false,
            "description": "wrong behavior inherited from vim",
            "id": 154310492,
            "name": "bug-vim",
            "node_id": "MDU6TGFiZWwxNTQzMTA0OTI=",
            "url": "https://api.github.com/repos/neovim/neovim/labels/bug-vim"
        },
        {
            "color": "FBCA04",
            "default": false,
            "description": "issue needs attention from an expert, or PR proposes significant changes to architecture or API",
            "id": 212680983,
            "name": "needs:discussion",
            "node_id": "MDU6TGFiZWwyMTI2ODA5ODM=",
            "url": "https://api.github.com/repos/neovim/neovim/labels/needs:discussion"
        },
        {
            "color": "0E8A16",
            "default": false,
            "description": "issue is not fixed but can be circumvented until then",
            "id": 435850181,
            "name": "has:workaround",
            "node_id": "MDU6TGFiZWw0MzU4NTAxODE=",
            "url": "https://api.github.com/repos/neovim/neovim/labels/has:workaround"
        },
        {
            "color": "C5DEF5",
            "default": false,
            "description": "command line, also cmdwin",
            "id": 5826989442,
            "name": "cmdline-mode",
            "node_id": "LA_kwDOAPphoM8AAAABW1DNgg",
            "url": "https://api.github.com/repos/neovim/neovim/labels/cmdline-mode"
        }
    ],
    "labels_url": "https://api.github.com/repos/neovim/neovim/issues/36256/labels{/name}",
    "locked": false,
    "milestone": null,
    "node_id": "I_kwDOAPphoM7SdYTm",
    "number": 36256,
    "performed_via_github_app": null,
    "reactions": {
        "+1": 0,
        "-1": 0,
        "confused": 0,
        "eyes": 0,
        "heart": 0,
        "hooray": 0,
        "laugh": 0,
        "rocket": 0,
        "total_count": 0,
        "url": "https://api.github.com/repos/neovim/neovim/issues/36256/reactions"
    },
    "repository_url": "https://api.github.com/repos/neovim/neovim",
    "state": "open",
    "state_reason": null,
    "sub_issues_summary": {
        "completed": 0,
        "percent_completed": 0,
        "total": 0
    },
    "timeline_url": "https://api.github.com/repos/neovim/neovim/issues/36256/timeline",
    "title": "cmap breaks command history reordering",
    "type": {
        "color": "red",
        "created_at": "2024-01-25T10:10:19Z",
        "description": "An unexpected problem or behavior",
        "id": 597163,
        "is_enabled": true,
        "name": "Bug",
        "node_id": "IT_kwDOAGK_Pc4ACRyr",
        "updated_at": "2024-07-26T10:12:30Z"
    },
    "updated_at": "2025-10-20T13:22:35Z",
    "url": "https://api.github.com/repos/neovim/neovim/issues/36256",
    "user": {
        "avatar_url": "https://avatars.githubusercontent.com/u/1216626?v=4",
        "events_url": "https://api.github.com/users/CGamesPlay/events{/privacy}",
        "followers_url": "https://api.github.com/users/CGamesPlay/followers",
        "following_url": "https://api.github.com/users/CGamesPlay/following{/other_user}",
        "gists_url": "https://api.github.com/users/CGamesPlay/gists{/gist_id}",
        "gravatar_id": "",
        "html_url": "https://github.com/CGamesPlay",
        "id": 1216626,
        "login": "CGamesPlay",
        "node_id": "MDQ6VXNlcjEyMTY2MjY=",
        "organizations_url": "https://api.github.com/users/CGamesPlay/orgs",
        "received_events_url": "https://api.github.com/users/CGamesPlay/received_events",
        "repos_url": "https://api.github.com/users/CGamesPlay/repos",
        "site_admin": false,
        "starred_url": "https://api.github.com/users/CGamesPlay/starred{/owner}{/repo}",
        "subscriptions_url": "https://api.github.com/users/CGamesPlay/subscriptions",
        "type": "User",
        "url": "https://api.github.com/users/CGamesPlay",
        "user_view_type": "public"
    }
}