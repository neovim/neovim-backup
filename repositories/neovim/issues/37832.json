{
    "active_lock_reason": null,
    "assignee": null,
    "assignees": [],
    "author_association": "NONE",
    "body": "I have a question about this line of code in the function `apply_text_edit`:\n\nhttps://github.com/neovim/neovim/blob/8a0cbf04d6a60f91c69c707789b18986a6921f8f/runtime/lua/vim/lsp/util.lua#L315\n\nI am aware this code is mentioned in this issue:\nhttps://github.com/neovim/neovim/issues/25272\n\nI was wondering why does this function change the current buffer to a listed one.\nIs this critically needed?\nIt seems to be a bug to me.\n\nEven trying to load the buffer (just above) seems strange.\nWhy would you make edits to a buffer that is not even loaded.\n\nBut I don't know much about the inner workings of vim/neovim so I may be wrong.\n\n## Why I'm asking\n\nI was experiencing very strange crashes in one of my custom plugins.\n\nIt was caused by me handling the BufDelete event, which I thought `only me™` could possibly trigger.\n\nBut it turns out, the BufDelete was also emitted by a [nvim-cmp] completion confirmation.\nBecause it calls `apply_text_edit` during this procedure.\nAnd it will also remember the buflisted value before the call, and then reapply the old buflisted value after the call.\n\nhttps://github.com/hrsh7th/nvim-cmp/blob/da88697d7f45d16852c6b2769dc52387d1ddc45f/lua/cmp/utils/api.lua#L74-L79\n\nThis will cause neovim (I think) to emit a BufDelete event.\n(because the buffer becomes unlisted?)\n\nThe problem is, the buffer is not deleted, it is still there.\nSo it might even be a bug in neovim, I don't know.\n\n<details>\n<summary>I have a snippet to reproduce the issue if it helps:</summary>\n\nIf you just change the buffer from listed to unlisted (even though the buffer is not destroyed, the event is still fired):\n\n`nvim -u <filename> --noplugins`\n```lua\n-- Setup textEdit payload for demonstration\nlocal textEdit = {\n\tnewText = \"\",\n\trange = {\n\t\t[\"end\"] = { character = 0, line = 1 },\n\t\tstart = { character = 0, line = 1 },\n\t},\n}\n\n-- Create an unlisted, scratch buffer (the problem only happens in an unlisted buffer, scratch or not)\nlocal the_buffer = vim.api.nvim_create_buf(false, true)\n\n-- Setup a listener to see the problem occur\nvim.api.nvim_create_autocmd(\"BufDelete\", {\n\tgroup = vim.api.nvim_create_augroup(\"ReproGroup\", { clear = true }),\n\tcallback = function()\n\t\tvim.api.nvim_buf_set_lines(the_buffer, -1, -1, false, { \"A BufDelete event was triggered!!\" })\n\tend,\n})\n\n-- Just a quick setup with some guidance (no impact on the issue)\nvim.cmd.buffer(the_buffer)\n\nlocal function append(lines) vim.api.nvim_buf_set_lines(0, -1, -1, false, lines) end\nlocal function buflisted() return vim.bo[the_buffer].buflisted and \"✅ listed\" or \"❌ unlisted\" end\n\n--- This is cmp.utils.api.apply_text_edits with added debug statements\nlocal function apply_text_edits(text_edits, bufnr, position_encoding)\n\t-- preserve 'buflisted' state because vim.lsp.util.apply_text_edits forces it to true\n\tlocal prev_buflisted = vim.bo[bufnr].buflisted                         append({ \"Memorize buflisted                    \"..buflisted() })\n\tvim.lsp.util.apply_text_edits(text_edits, bufnr, position_encoding)    append({ \"vim.lsp.util.apply_text_edits(...)    \"..buflisted() })\n\tvim.bo[bufnr].buflisted = prev_buflisted                               append({ \"Restore buflisted                     \"..buflisted() })\nend\n\nappend({ \"\", \"Call vim.lsp.util.apply_text_edits:\", \"\" })\n\napply_text_edits({ textEdit }, the_buffer, \"utf-8\")\n\nappend({ \"\", \"Modifying buflisted (same effect):\", \"\" })\n\nvim.bo[the_buffer].buflisted = true                                        append({ \"set buflisted to true                 \"..buflisted() })\nvim.bo[the_buffer].buflisted = false                                       append({ \"set buflisted to false                \"..buflisted() })\n```\n\nIf you happen to use a completion in an unlisted buffer:\n\n`nvim -u <filename>`\n```lua\n-- Minimal plugin configuration\nlocal cmp_spec = {\n\t\"hrsh7th/nvim-cmp\",\n\tdependencies = { \"hrsh7th/cmp-path\" },\n\tconfig = function()\n\t\tlocal cmp = require(\"cmp\")\n\t\tcmp.setup({\n\t\t\tmapping = cmp.mapping.preset.insert({\n\t\t\t\t[\"<Enter>\"] = cmp.mapping.confirm({ select = true }),\n\t\t\t\t[\"<C-Space>\"] = cmp.mapping.complete(),\n\t\t\t}),\n\t\t\tsources = cmp.config.sources({\n\t\t\t\t{ name = \"path\" }, -- The problem also happens with other kinds of sources (snippy for example)\n\t\t\t}),\n\t\t})\n\tend,\n}\n\n-- Using lazy to install the plugin, you may do differently\nvim.env.LAZY_STDPATH = \".repro\"\nload(vim.fn.system(\"curl -s https://raw.githubusercontent.com/folke/lazy.nvim/main/bootstrap.lua\"))()\nrequire(\"lazy.minit\").repro({ spec = { cmp_spec } })\n\n-- Create an unlisted, scratch buffer (the problem only happens in an unlisted buffer, scratch or not)\nlocal the_buffer = vim.api.nvim_create_buf(false, true)\n\n-- Setup a listener to see the problem occur\nvim.api.nvim_create_autocmd(\"BufDelete\", {\n\tgroup = vim.api.nvim_create_augroup(\"ReproGroup\", { clear = true }),\n\tcallback = function()\n\t\tvim.api.nvim_buf_set_lines(the_buffer, -1, -1, false, { \"A BufDelete event was triggered!!\" })\n\tend,\n})\n\n-- Enter the buffer\nvim.cmd.buffer(the_buffer)\n\n-- Basic setup for easier repro\nvim.api.nvim_buf_set_lines(the_buffer, 0, -1, false, {\n\t\"1. Start typing '/' to trigger cmp-path's autocomplete\",\n\t\"2. Select any entry and hit <CR> (confirm)\",\n\t\"\",\n})\nvim.fn.feedkeys(\"GA\")\n```\n</details>\n\n[nvim-cmp]: https://github.com/hrsh7th/nvim-cmp",
    "closed_at": null,
    "closed_by": null,
    "comment_data": [
        {
            "author_association": "NONE",
            "body": "Adding this in case it helps triage the issue.\n\nI am starting to have doubts after re reading the manual for BufDelete for the nth time (emphasis mine).\n\n> Before deleting a buffer from the buffer list.\n> The BufUnload may be called first (if the\n> buffer was loaded).\n> **Also used just before a buffer in the buffer\n> list is renamed.**\n\nFor my use cases in particular, it's probably better to track `BufWipeout` rather than `BufDelete`.\n\nBut my question still holds.",
            "created_at": "2026-02-12T18:47:55Z",
            "html_url": "https://github.com/neovim/neovim/issues/37832#issuecomment-3892771681",
            "id": 3892771681,
            "issue_url": "https://api.github.com/repos/neovim/neovim/issues/37832",
            "node_id": "IC_kwDOAPphoM7oBvth",
            "performed_via_github_app": null,
            "pin": null,
            "reactions": {
                "+1": 1,
                "-1": 0,
                "confused": 0,
                "eyes": 0,
                "heart": 0,
                "hooray": 0,
                "laugh": 0,
                "rocket": 0,
                "total_count": 1,
                "url": "https://api.github.com/repos/neovim/neovim/issues/comments/3892771681/reactions"
            },
            "updated_at": "2026-02-12T18:47:55Z",
            "url": "https://api.github.com/repos/neovim/neovim/issues/comments/3892771681",
            "user": {
                "avatar_url": "https://avatars.githubusercontent.com/u/17208592?v=4",
                "events_url": "https://api.github.com/users/sylann/events{/privacy}",
                "followers_url": "https://api.github.com/users/sylann/followers",
                "following_url": "https://api.github.com/users/sylann/following{/other_user}",
                "gists_url": "https://api.github.com/users/sylann/gists{/gist_id}",
                "gravatar_id": "",
                "html_url": "https://github.com/sylann",
                "id": 17208592,
                "login": "sylann",
                "node_id": "MDQ6VXNlcjE3MjA4NTky",
                "organizations_url": "https://api.github.com/users/sylann/orgs",
                "received_events_url": "https://api.github.com/users/sylann/received_events",
                "repos_url": "https://api.github.com/users/sylann/repos",
                "site_admin": false,
                "starred_url": "https://api.github.com/users/sylann/starred{/owner}{/repo}",
                "subscriptions_url": "https://api.github.com/users/sylann/subscriptions",
                "type": "User",
                "url": "https://api.github.com/users/sylann",
                "user_view_type": "public"
            }
        },
        {
            "author_association": "MEMBER",
            "body": "The git history is always the first place to look. That change was made in https://github.com/neovim/neovim/pull/12489 , to fix https://github.com/neovim/neovim/issues/12488 , \n\n> neovim is calling bufadd() to apply the text edits, and whenever the file isn't open already, it opens the file and applies the change as expected, but the new buffer is unlisted.\n\nI assume `bufload()` was meant, not `bufadd()`. \n\nThe explanation doesn't really make sense to me. And setting `buflisted` does seem like the wrong solution. If `bufload()` isn't doing what's expected, maybe we need to call `:edit` or something else. Or dig into why `bufload()` doesn't set 'buflisted'. \n\nPR welcome, if it includes a concise, clear explanation + references.",
            "created_at": "2026-02-12T20:25:26Z",
            "html_url": "https://github.com/neovim/neovim/issues/37832#issuecomment-3893212585",
            "id": 3893212585,
            "issue_url": "https://api.github.com/repos/neovim/neovim/issues/37832",
            "node_id": "IC_kwDOAPphoM7oDbWp",
            "performed_via_github_app": null,
            "pin": null,
            "reactions": {
                "+1": 1,
                "-1": 0,
                "confused": 0,
                "eyes": 0,
                "heart": 0,
                "hooray": 0,
                "laugh": 0,
                "rocket": 0,
                "total_count": 1,
                "url": "https://api.github.com/repos/neovim/neovim/issues/comments/3893212585/reactions"
            },
            "updated_at": "2026-02-12T20:25:53Z",
            "url": "https://api.github.com/repos/neovim/neovim/issues/comments/3893212585",
            "user": {
                "avatar_url": "https://avatars.githubusercontent.com/u/1359421?v=4",
                "events_url": "https://api.github.com/users/justinmk/events{/privacy}",
                "followers_url": "https://api.github.com/users/justinmk/followers",
                "following_url": "https://api.github.com/users/justinmk/following{/other_user}",
                "gists_url": "https://api.github.com/users/justinmk/gists{/gist_id}",
                "gravatar_id": "",
                "html_url": "https://github.com/justinmk",
                "id": 1359421,
                "login": "justinmk",
                "node_id": "MDQ6VXNlcjEzNTk0MjE=",
                "organizations_url": "https://api.github.com/users/justinmk/orgs",
                "received_events_url": "https://api.github.com/users/justinmk/received_events",
                "repos_url": "https://api.github.com/users/justinmk/repos",
                "site_admin": false,
                "starred_url": "https://api.github.com/users/justinmk/starred{/owner}{/repo}",
                "subscriptions_url": "https://api.github.com/users/justinmk/subscriptions",
                "type": "User",
                "url": "https://api.github.com/users/justinmk",
                "user_view_type": "public"
            }
        }
    ],
    "comments": 2,
    "comments_url": "https://api.github.com/repos/neovim/neovim/issues/37832/comments",
    "created_at": "2026-02-12T18:35:36Z",
    "events_url": "https://api.github.com/repos/neovim/neovim/issues/37832/events",
    "html_url": "https://github.com/neovim/neovim/issues/37832",
    "id": 3933373477,
    "issue_dependencies_summary": {
        "blocked_by": 0,
        "blocking": 0,
        "total_blocked_by": 0,
        "total_blocking": 0
    },
    "labels": [
        {
            "color": "c5def5",
            "default": false,
            "description": null,
            "id": 662566370,
            "name": "lsp",
            "node_id": "MDU6TGFiZWw2NjI1NjYzNzA=",
            "url": "https://api.github.com/repos/neovim/neovim/labels/lsp"
        }
    ],
    "labels_url": "https://api.github.com/repos/neovim/neovim/issues/37832/labels{/name}",
    "locked": false,
    "milestone": null,
    "node_id": "I_kwDOAPphoM7qcoQl",
    "number": 37832,
    "performed_via_github_app": null,
    "pinned_comment": null,
    "reactions": {
        "+1": 0,
        "-1": 0,
        "confused": 0,
        "eyes": 0,
        "heart": 0,
        "hooray": 0,
        "laugh": 0,
        "rocket": 0,
        "total_count": 0,
        "url": "https://api.github.com/repos/neovim/neovim/issues/37832/reactions"
    },
    "repository_url": "https://api.github.com/repos/neovim/neovim",
    "state": "open",
    "state_reason": null,
    "sub_issues_summary": {
        "completed": 0,
        "percent_completed": 0,
        "total": 0
    },
    "timeline_url": "https://api.github.com/repos/neovim/neovim/issues/37832/timeline",
    "title": "vim.lsp.util.apply_text_edits forces given buffer to be listed (buflisted=true)",
    "type": null,
    "updated_at": "2026-02-12T20:25:53Z",
    "url": "https://api.github.com/repos/neovim/neovim/issues/37832",
    "user": {
        "avatar_url": "https://avatars.githubusercontent.com/u/17208592?v=4",
        "events_url": "https://api.github.com/users/sylann/events{/privacy}",
        "followers_url": "https://api.github.com/users/sylann/followers",
        "following_url": "https://api.github.com/users/sylann/following{/other_user}",
        "gists_url": "https://api.github.com/users/sylann/gists{/gist_id}",
        "gravatar_id": "",
        "html_url": "https://github.com/sylann",
        "id": 17208592,
        "login": "sylann",
        "node_id": "MDQ6VXNlcjE3MjA4NTky",
        "organizations_url": "https://api.github.com/users/sylann/orgs",
        "received_events_url": "https://api.github.com/users/sylann/received_events",
        "repos_url": "https://api.github.com/users/sylann/repos",
        "site_admin": false,
        "starred_url": "https://api.github.com/users/sylann/starred{/owner}{/repo}",
        "subscriptions_url": "https://api.github.com/users/sylann/subscriptions",
        "type": "User",
        "url": "https://api.github.com/users/sylann",
        "user_view_type": "public"
    }
}