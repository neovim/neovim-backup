{
    "active_lock_reason": null,
    "assignee": null,
    "assignees": [],
    "author_association": "NONE",
    "body": "### Problem\n\nI'm not entirely sure if this can be considered a bug or not so please reassign labels or move it to a discussion instead.\n\nI've been running into this problem in testing two neotest adapters but the problem also occurs during regular usage. Here is a [CI traceback](https://github.com/nvim-neotest/neotest-jest/actions/runs/16059462164/job/45321831307?pr=149) (scroll to the \"Run tests\" section and view the first failing test) from one of the adapters. [Neotest](https://github.com/nvim-neotest/neotest) runs asynchronous code which, in this case, ultimately calls `vim.treesitter.language.get_lang`. The code path from there requires `vim.tresitter.query` which contains a top-level call to `vim.api.nvim_create_autocmd` [here](https://github.com/neovim/neovim/blob/master/runtime/lua/vim/treesitter/query.lua#L335-L342). This causes the issue since you cannot call `vim.api` functions in a fast event.\n\nI've tracked the change to this commit 3fdc4302415972eb5d98ba832372236be3d22572 which added the top-level autocmd call some months ago at the time of this writing. Consequently, the tests work fine on earlier versions like 0.9.0 which is also tested by the workflow I linked so running treesitter in async code didn't pose a problem beforehand at least but I'm not sure if the treesitter module is supposed to support async code.\n\nGenerally, I would avoid having `require` side-effects due to such unintended effects but the commit's change makes sense from an optimisation perspective.\n\nPerhaps the autocmd can be created lazily by moving it into a function call in the `query` submodule and running it once instead?\n\n### Steps to reproduce\n\nUnfortunately, I haven't been able to reliably reproduce this outside a CI environment. I'm not sure why it always occurs in a CI environment though the method `adapter.discover_positions` is called directly here and cannot be called directly from the command line in a non-async context. I've tried running it inside a `coroutine` but so far no luck.\n\nI'll continue to try and figure out a way to reproduce it. Please bear with me.\n\n### Expected behavior\n\nI expected to be able to call treesitter module functions in an async context like before the change above although I don't know if this expectation is wrong to begin with and treesitter was never supposed to be called in an async context.\n\n### Nvim version (nvim -v)\n\nNVIM v0.11.0 Build type: Release LuaJIT 2.1.1741730670 Run \"nvim -V1 -v\" for more info (from the CI workflow)\n\n### Vim (not Nvim) behaves the same?\n\nNot relevant\n\n### Operating system/version\n\nMac Sequioa 15.5\n\n### Terminal name/version\n\nWhatever terminal the github actions workflow uses. Probably bash but I can find out if relevant.\n\n### $TERM environment variable\n\nSame as above.\n\n### Installation\n\nCurl command using the release url for a neovim version. See [here](https://github.com/nvim-neotest/neotest-jest/blob/e159cde097e86d40e6b52f8779de70edf024c8fd/.github/workflows/workflow.yaml#L65)",
    "closed_at": null,
    "closed_by": null,
    "comment_data": [
        {
            "author_association": "MEMBER",
            "body": "The latest stable version is 0.11.3, please always check that to save time, since it may have bugfixes. Not to mention, it saves time to check the current dev branch (nightly).",
            "created_at": "2025-07-25T22:05:03Z",
            "html_url": "https://github.com/neovim/neovim/issues/35071#issuecomment-3120514093",
            "id": 3120514093,
            "issue_url": "https://api.github.com/repos/neovim/neovim/issues/35071",
            "node_id": "IC_kwDOAPphoM65_0Qt",
            "performed_via_github_app": null,
            "reactions": {
                "+1": 0,
                "-1": 0,
                "confused": 0,
                "eyes": 0,
                "heart": 0,
                "hooray": 0,
                "laugh": 0,
                "rocket": 0,
                "total_count": 0,
                "url": "https://api.github.com/repos/neovim/neovim/issues/comments/3120514093/reactions"
            },
            "updated_at": "2025-07-25T22:05:03Z",
            "url": "https://api.github.com/repos/neovim/neovim/issues/comments/3120514093",
            "user": {
                "avatar_url": "https://avatars.githubusercontent.com/u/1359421?v=4",
                "events_url": "https://api.github.com/users/justinmk/events{/privacy}",
                "followers_url": "https://api.github.com/users/justinmk/followers",
                "following_url": "https://api.github.com/users/justinmk/following{/other_user}",
                "gists_url": "https://api.github.com/users/justinmk/gists{/gist_id}",
                "gravatar_id": "",
                "html_url": "https://github.com/justinmk",
                "id": 1359421,
                "login": "justinmk",
                "node_id": "MDQ6VXNlcjEzNTk0MjE=",
                "organizations_url": "https://api.github.com/users/justinmk/orgs",
                "received_events_url": "https://api.github.com/users/justinmk/received_events",
                "repos_url": "https://api.github.com/users/justinmk/repos",
                "site_admin": false,
                "starred_url": "https://api.github.com/users/justinmk/starred{/owner}{/repo}",
                "subscriptions_url": "https://api.github.com/users/justinmk/subscriptions",
                "type": "User",
                "url": "https://api.github.com/users/justinmk",
                "user_view_type": "public"
            }
        },
        {
            "author_association": "CONTRIBUTOR",
            "body": "> [Neotest](https://github.com/nvim-neotest/neotest) runs asynchronous code\n\nDoes wrapping the async code in `vim.schedule` work? ",
            "created_at": "2025-07-26T05:40:56Z",
            "html_url": "https://github.com/neovim/neovim/issues/35071#issuecomment-3121326338",
            "id": 3121326338,
            "issue_url": "https://api.github.com/repos/neovim/neovim/issues/35071",
            "node_id": "IC_kwDOAPphoM66C6kC",
            "performed_via_github_app": null,
            "reactions": {
                "+1": 0,
                "-1": 0,
                "confused": 0,
                "eyes": 0,
                "heart": 0,
                "hooray": 0,
                "laugh": 0,
                "rocket": 0,
                "total_count": 0,
                "url": "https://api.github.com/repos/neovim/neovim/issues/comments/3121326338/reactions"
            },
            "updated_at": "2025-07-26T05:40:56Z",
            "url": "https://api.github.com/repos/neovim/neovim/issues/comments/3121326338",
            "user": {
                "avatar_url": "https://avatars.githubusercontent.com/u/19489738?v=4",
                "events_url": "https://api.github.com/users/tomtomjhj/events{/privacy}",
                "followers_url": "https://api.github.com/users/tomtomjhj/followers",
                "following_url": "https://api.github.com/users/tomtomjhj/following{/other_user}",
                "gists_url": "https://api.github.com/users/tomtomjhj/gists{/gist_id}",
                "gravatar_id": "",
                "html_url": "https://github.com/tomtomjhj",
                "id": 19489738,
                "login": "tomtomjhj",
                "node_id": "MDQ6VXNlcjE5NDg5NzM4",
                "organizations_url": "https://api.github.com/users/tomtomjhj/orgs",
                "received_events_url": "https://api.github.com/users/tomtomjhj/received_events",
                "repos_url": "https://api.github.com/users/tomtomjhj/repos",
                "site_admin": false,
                "starred_url": "https://api.github.com/users/tomtomjhj/starred{/owner}{/repo}",
                "subscriptions_url": "https://api.github.com/users/tomtomjhj/subscriptions",
                "type": "User",
                "url": "https://api.github.com/users/tomtomjhj",
                "user_view_type": "public"
            }
        },
        {
            "author_association": "NONE",
            "body": "@justinmk good point. I'll update the CI workflow to test on 0.11.3 and get back to you. Nightly is also tested by the workflow and fails in the same way.\n\n@tomtomjhj I haven't tried wrapping the entire call to `discover_positions`. I'll try later today and see if it helps. I can also try to wrap just the call to `vim.treesitter.language.get_lang`. I've opened a PR on the neotest repo where I suggest something very similar.",
            "created_at": "2025-07-26T07:07:08Z",
            "html_url": "https://github.com/neovim/neovim/issues/35071#issuecomment-3121419462",
            "id": 3121419462,
            "issue_url": "https://api.github.com/repos/neovim/neovim/issues/35071",
            "node_id": "IC_kwDOAPphoM66DRTG",
            "performed_via_github_app": null,
            "reactions": {
                "+1": 0,
                "-1": 0,
                "confused": 0,
                "eyes": 0,
                "heart": 0,
                "hooray": 0,
                "laugh": 0,
                "rocket": 0,
                "total_count": 0,
                "url": "https://api.github.com/repos/neovim/neovim/issues/comments/3121419462/reactions"
            },
            "updated_at": "2025-07-26T07:07:08Z",
            "url": "https://api.github.com/repos/neovim/neovim/issues/comments/3121419462",
            "user": {
                "avatar_url": "https://avatars.githubusercontent.com/u/1846147?v=4",
                "events_url": "https://api.github.com/users/MisanthropicBit/events{/privacy}",
                "followers_url": "https://api.github.com/users/MisanthropicBit/followers",
                "following_url": "https://api.github.com/users/MisanthropicBit/following{/other_user}",
                "gists_url": "https://api.github.com/users/MisanthropicBit/gists{/gist_id}",
                "gravatar_id": "",
                "html_url": "https://github.com/MisanthropicBit",
                "id": 1846147,
                "login": "MisanthropicBit",
                "node_id": "MDQ6VXNlcjE4NDYxNDc=",
                "organizations_url": "https://api.github.com/users/MisanthropicBit/orgs",
                "received_events_url": "https://api.github.com/users/MisanthropicBit/received_events",
                "repos_url": "https://api.github.com/users/MisanthropicBit/repos",
                "site_admin": false,
                "starred_url": "https://api.github.com/users/MisanthropicBit/starred{/owner}{/repo}",
                "subscriptions_url": "https://api.github.com/users/MisanthropicBit/subscriptions",
                "type": "User",
                "url": "https://api.github.com/users/MisanthropicBit",
                "user_view_type": "public"
            }
        },
        {
            "author_association": "NONE",
            "body": "Results on 0.11.3 were expectedly the same since the top-level call to `nvim_create_augroup` is still there but good thing to test anyway. [Here's the log output](https://github.com/nvim-neotest/neotest-jest/actions/runs/16554564378/job/46814211340?pr=150).\n\nI tried inserting calls to `nio.scheduler()` (see [here](https://github.com/nvim-neotest/nvim-nio/blob/21f5324bfac14e22ba26553caf69ec76ae8a7662/lua/nio/init.lua#L176-L182), basically a call to `vim.schedule` wrapped in a coroutine context for use in async code) before the calls to `discover_positions` but that didn't work unfortunately. I'll tried to wrap the code in `vim.schedule` itself and see if that works.",
            "created_at": "2025-07-27T19:29:44Z",
            "html_url": "https://github.com/neovim/neovim/issues/35071#issuecomment-3124679664",
            "id": 3124679664,
            "issue_url": "https://api.github.com/repos/neovim/neovim/issues/35071",
            "node_id": "IC_kwDOAPphoM66PtPw",
            "performed_via_github_app": null,
            "reactions": {
                "+1": 0,
                "-1": 0,
                "confused": 0,
                "eyes": 0,
                "heart": 0,
                "hooray": 0,
                "laugh": 0,
                "rocket": 0,
                "total_count": 0,
                "url": "https://api.github.com/repos/neovim/neovim/issues/comments/3124679664/reactions"
            },
            "updated_at": "2025-07-27T19:29:44Z",
            "url": "https://api.github.com/repos/neovim/neovim/issues/comments/3124679664",
            "user": {
                "avatar_url": "https://avatars.githubusercontent.com/u/1846147?v=4",
                "events_url": "https://api.github.com/users/MisanthropicBit/events{/privacy}",
                "followers_url": "https://api.github.com/users/MisanthropicBit/followers",
                "following_url": "https://api.github.com/users/MisanthropicBit/following{/other_user}",
                "gists_url": "https://api.github.com/users/MisanthropicBit/gists{/gist_id}",
                "gravatar_id": "",
                "html_url": "https://github.com/MisanthropicBit",
                "id": 1846147,
                "login": "MisanthropicBit",
                "node_id": "MDQ6VXNlcjE4NDYxNDc=",
                "organizations_url": "https://api.github.com/users/MisanthropicBit/orgs",
                "received_events_url": "https://api.github.com/users/MisanthropicBit/received_events",
                "repos_url": "https://api.github.com/users/MisanthropicBit/repos",
                "site_admin": false,
                "starred_url": "https://api.github.com/users/MisanthropicBit/starred{/owner}{/repo}",
                "subscriptions_url": "https://api.github.com/users/MisanthropicBit/subscriptions",
                "type": "User",
                "url": "https://api.github.com/users/MisanthropicBit",
                "user_view_type": "public"
            }
        }
    ],
    "comments": 4,
    "comments_url": "https://api.github.com/repos/neovim/neovim/issues/35071/comments",
    "created_at": "2025-07-25T19:41:24Z",
    "events_url": "https://api.github.com/repos/neovim/neovim/issues/35071/events",
    "html_url": "https://github.com/neovim/neovim/issues/35071",
    "id": 3264213156,
    "labels": [
        {
            "color": "c5def5",
            "default": false,
            "description": "",
            "id": 1799626557,
            "name": "treesitter",
            "node_id": "MDU6TGFiZWwxNzk5NjI2NTU3",
            "url": "https://api.github.com/repos/neovim/neovim/labels/treesitter"
        }
    ],
    "labels_url": "https://api.github.com/repos/neovim/neovim/issues/35071/labels{/name}",
    "locked": false,
    "milestone": {
        "closed_at": null,
        "closed_issues": 286,
        "created_at": "2014-11-26T22:13:11Z",
        "creator": {
            "avatar_url": "https://avatars.githubusercontent.com/u/1359421?v=4",
            "events_url": "https://api.github.com/users/justinmk/events{/privacy}",
            "followers_url": "https://api.github.com/users/justinmk/followers",
            "following_url": "https://api.github.com/users/justinmk/following{/other_user}",
            "gists_url": "https://api.github.com/users/justinmk/gists{/gist_id}",
            "gravatar_id": "",
            "html_url": "https://github.com/justinmk",
            "id": 1359421,
            "login": "justinmk",
            "node_id": "MDQ6VXNlcjEzNTk0MjE=",
            "organizations_url": "https://api.github.com/users/justinmk/orgs",
            "received_events_url": "https://api.github.com/users/justinmk/received_events",
            "repos_url": "https://api.github.com/users/justinmk/repos",
            "site_admin": false,
            "starred_url": "https://api.github.com/users/justinmk/starred{/owner}{/repo}",
            "subscriptions_url": "https://api.github.com/users/justinmk/subscriptions",
            "type": "User",
            "url": "https://api.github.com/users/justinmk",
            "user_view_type": "public"
        },
        "description": "We don't plan to work on this, but will accept high quality contributions from someone who will own the feature and follow up on bug reports.",
        "due_on": null,
        "html_url": "https://github.com/neovim/neovim/milestone/9",
        "id": 881978,
        "labels_url": "https://api.github.com/repos/neovim/neovim/milestones/9/labels",
        "node_id": "MDk6TWlsZXN0b25lODgxOTc4",
        "number": 9,
        "open_issues": 345,
        "state": "open",
        "title": "needs-owner",
        "updated_at": "2025-07-27T02:48:55Z",
        "url": "https://api.github.com/repos/neovim/neovim/milestones/9"
    },
    "node_id": "I_kwDOAPphoM7Cj_Ck",
    "number": 35071,
    "performed_via_github_app": null,
    "reactions": {
        "+1": 0,
        "-1": 0,
        "confused": 0,
        "eyes": 0,
        "heart": 0,
        "hooray": 0,
        "laugh": 0,
        "rocket": 0,
        "total_count": 0,
        "url": "https://api.github.com/repos/neovim/neovim/issues/35071/reactions"
    },
    "repository_url": "https://api.github.com/repos/neovim/neovim",
    "state": "open",
    "state_reason": null,
    "sub_issues_summary": {
        "completed": 0,
        "percent_completed": 0,
        "total": 0
    },
    "timeline_url": "https://api.github.com/repos/neovim/neovim/issues/35071/timeline",
    "title": "vim.treesitter functions in \"fast\" event fails",
    "type": {
        "color": "red",
        "created_at": "2024-01-25T10:10:19Z",
        "description": "An unexpected problem or behavior",
        "id": 597163,
        "is_enabled": true,
        "name": "Bug",
        "node_id": "IT_kwDOAGK_Pc4ACRyr",
        "updated_at": "2024-07-26T10:12:30Z"
    },
    "updated_at": "2025-07-27T19:29:44Z",
    "url": "https://api.github.com/repos/neovim/neovim/issues/35071",
    "user": {
        "avatar_url": "https://avatars.githubusercontent.com/u/1846147?v=4",
        "events_url": "https://api.github.com/users/MisanthropicBit/events{/privacy}",
        "followers_url": "https://api.github.com/users/MisanthropicBit/followers",
        "following_url": "https://api.github.com/users/MisanthropicBit/following{/other_user}",
        "gists_url": "https://api.github.com/users/MisanthropicBit/gists{/gist_id}",
        "gravatar_id": "",
        "html_url": "https://github.com/MisanthropicBit",
        "id": 1846147,
        "login": "MisanthropicBit",
        "node_id": "MDQ6VXNlcjE4NDYxNDc=",
        "organizations_url": "https://api.github.com/users/MisanthropicBit/orgs",
        "received_events_url": "https://api.github.com/users/MisanthropicBit/received_events",
        "repos_url": "https://api.github.com/users/MisanthropicBit/repos",
        "site_admin": false,
        "starred_url": "https://api.github.com/users/MisanthropicBit/starred{/owner}{/repo}",
        "subscriptions_url": "https://api.github.com/users/MisanthropicBit/subscriptions",
        "type": "User",
        "url": "https://api.github.com/users/MisanthropicBit",
        "user_view_type": "public"
    }
}