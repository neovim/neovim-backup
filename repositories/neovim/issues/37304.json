{
    "active_lock_reason": null,
    "assignee": null,
    "assignees": [],
    "author_association": "CONTRIBUTOR",
    "body": "## Problem\n\n## Steps to reproduce\n\n```\nlocal api = vim.api\nlocal win = api.nvim_open_win(api.nvim_create_buf(false, true), true, {\n  style = 'minimal',\n  height = 10,\n  width = 10,\n  row = 5,\n  col = 5,\n  relative = 'cursor',\n})\nvim._with({ wo = { nu = true } }, function() end)\n```\n\n## Expected behavior\nfloat window should be `nonumber`?\n\n## System info\n\n- Nvim version (nvim -v): `v0.12.0-dev-1966 g4d46d040c3` neovim/neovim@4d46d040c3\n- Vim (not Nvim) behaves the same?: ?\n- Operating system/version: Linux 6.18.3-zen1-1-zen\n- Terminal name/version: kitty\n- $TERM environment variable: `xterm-kitty`\n- Installation: ?\n\n",
    "closed_at": "2026-01-11T12:04:33Z",
    "closed_by": {
        "avatar_url": "https://avatars.githubusercontent.com/u/35768171?v=4",
        "events_url": "https://api.github.com/users/zeertzjq/events{/privacy}",
        "followers_url": "https://api.github.com/users/zeertzjq/followers",
        "following_url": "https://api.github.com/users/zeertzjq/following{/other_user}",
        "gists_url": "https://api.github.com/users/zeertzjq/gists{/gist_id}",
        "gravatar_id": "",
        "html_url": "https://github.com/zeertzjq",
        "id": 35768171,
        "login": "zeertzjq",
        "node_id": "MDQ6VXNlcjM1NzY4MTcx",
        "organizations_url": "https://api.github.com/users/zeertzjq/orgs",
        "received_events_url": "https://api.github.com/users/zeertzjq/received_events",
        "repos_url": "https://api.github.com/users/zeertzjq/repos",
        "site_admin": false,
        "starred_url": "https://api.github.com/users/zeertzjq/starred{/owner}{/repo}",
        "subscriptions_url": "https://api.github.com/users/zeertzjq/subscriptions",
        "type": "User",
        "url": "https://api.github.com/users/zeertzjq",
        "user_view_type": "public"
    },
    "comment_data": [
        {
            "author_association": "MEMBER",
            "body": "Minimal repro:\n```lua\nvim.api.nvim_set_option_value('number', false, { scope = 'local' })\nvim._with({ wo = { nu = true } }, function() end)\n```",
            "created_at": "2026-01-08T09:45:56Z",
            "html_url": "https://github.com/neovim/neovim/issues/37304#issuecomment-3723055260",
            "id": 3723055260,
            "issue_url": "https://api.github.com/repos/neovim/neovim/issues/37304",
            "node_id": "IC_kwDOAPphoM7d6VCc",
            "performed_via_github_app": null,
            "reactions": {
                "+1": 0,
                "-1": 0,
                "confused": 0,
                "eyes": 0,
                "heart": 0,
                "hooray": 0,
                "laugh": 0,
                "rocket": 0,
                "total_count": 0,
                "url": "https://api.github.com/repos/neovim/neovim/issues/comments/3723055260/reactions"
            },
            "updated_at": "2026-01-08T09:45:56Z",
            "url": "https://api.github.com/repos/neovim/neovim/issues/comments/3723055260",
            "user": {
                "avatar_url": "https://avatars.githubusercontent.com/u/35768171?v=4",
                "events_url": "https://api.github.com/users/zeertzjq/events{/privacy}",
                "followers_url": "https://api.github.com/users/zeertzjq/followers",
                "following_url": "https://api.github.com/users/zeertzjq/following{/other_user}",
                "gists_url": "https://api.github.com/users/zeertzjq/gists{/gist_id}",
                "gravatar_id": "",
                "html_url": "https://github.com/zeertzjq",
                "id": 35768171,
                "login": "zeertzjq",
                "node_id": "MDQ6VXNlcjM1NzY4MTcx",
                "organizations_url": "https://api.github.com/users/zeertzjq/orgs",
                "received_events_url": "https://api.github.com/users/zeertzjq/received_events",
                "repos_url": "https://api.github.com/users/zeertzjq/repos",
                "site_admin": false,
                "starred_url": "https://api.github.com/users/zeertzjq/starred{/owner}{/repo}",
                "subscriptions_url": "https://api.github.com/users/zeertzjq/subscriptions",
                "type": "User",
                "url": "https://api.github.com/users/zeertzjq",
                "user_view_type": "public"
            }
        },
        {
            "author_association": "MEMBER",
            "body": "Not sure if this solution can be simplified:\n```diff\ndiff --git a/runtime/lua/vim/_core/shared.lua b/runtime/lua/vim/_core/shared.lua\nindex 8dfca25fb9..91e8236541 100644\n--- a/runtime/lua/vim/_core/shared.lua\n+++ b/runtime/lua/vim/_core/shared.lua\n@@ -1473,7 +1473,7 @@ local get_context_state = function(context)\n \n       -- Do not override already set state and fall back to `vim.NIL` for\n       -- state `nil` values (which still needs restoring later)\n-      res[sc][name] = res[sc][name] or vim[sc][name] or vim.NIL\n+      res[sc][name] = res[sc][name] or sc == 'wo' and vim.wo[0][0][name] or vim[sc][name] or vim.NIL\n \n       -- Always track global option value to properly restore later.\n       -- This matters for at least `o` and `wo` (which might set either/both\n@@ -1565,8 +1565,13 @@ function vim._with(context, f)\n       for name, context_value in\n         pairs(context[scope] or {} --[[@as table<string,any>]])\n       do\n-        --- @diagnostic disable-next-line:no-unknown\n-        vim[scope][name] = context_value\n+        if scope == 'wo' then\n+          --- @diagnostic disable-next-line:no-unknown\n+          vim.wo[0][0][name] = context_value\n+        else\n+          --- @diagnostic disable-next-line:no-unknown\n+          vim[scope][name] = context_value\n+        end\n       end\n     end\n \n```",
            "created_at": "2026-01-08T09:53:27Z",
            "html_url": "https://github.com/neovim/neovim/issues/37304#issuecomment-3723082832",
            "id": 3723082832,
            "issue_url": "https://api.github.com/repos/neovim/neovim/issues/37304",
            "node_id": "IC_kwDOAPphoM7d6bxQ",
            "performed_via_github_app": null,
            "reactions": {
                "+1": 0,
                "-1": 0,
                "confused": 0,
                "eyes": 0,
                "heart": 0,
                "hooray": 0,
                "laugh": 0,
                "rocket": 0,
                "total_count": 0,
                "url": "https://api.github.com/repos/neovim/neovim/issues/comments/3723082832/reactions"
            },
            "updated_at": "2026-01-11T11:22:20Z",
            "url": "https://api.github.com/repos/neovim/neovim/issues/comments/3723082832",
            "user": {
                "avatar_url": "https://avatars.githubusercontent.com/u/35768171?v=4",
                "events_url": "https://api.github.com/users/zeertzjq/events{/privacy}",
                "followers_url": "https://api.github.com/users/zeertzjq/followers",
                "following_url": "https://api.github.com/users/zeertzjq/following{/other_user}",
                "gists_url": "https://api.github.com/users/zeertzjq/gists{/gist_id}",
                "gravatar_id": "",
                "html_url": "https://github.com/zeertzjq",
                "id": 35768171,
                "login": "zeertzjq",
                "node_id": "MDQ6VXNlcjM1NzY4MTcx",
                "organizations_url": "https://api.github.com/users/zeertzjq/orgs",
                "received_events_url": "https://api.github.com/users/zeertzjq/received_events",
                "repos_url": "https://api.github.com/users/zeertzjq/repos",
                "site_admin": false,
                "starred_url": "https://api.github.com/users/zeertzjq/starred{/owner}{/repo}",
                "subscriptions_url": "https://api.github.com/users/zeertzjq/subscriptions",
                "type": "User",
                "url": "https://api.github.com/users/zeertzjq",
                "user_view_type": "public"
            }
        },
        {
            "author_association": "MEMBER",
            "body": "cc @echasnovski What do you think?",
            "created_at": "2026-01-11T09:51:47Z",
            "html_url": "https://github.com/neovim/neovim/issues/37304#issuecomment-3734333104",
            "id": 3734333104,
            "issue_url": "https://api.github.com/repos/neovim/neovim/issues/37304",
            "node_id": "IC_kwDOAPphoM7elWaw",
            "performed_via_github_app": null,
            "reactions": {
                "+1": 0,
                "-1": 0,
                "confused": 0,
                "eyes": 0,
                "heart": 0,
                "hooray": 0,
                "laugh": 0,
                "rocket": 0,
                "total_count": 0,
                "url": "https://api.github.com/repos/neovim/neovim/issues/comments/3734333104/reactions"
            },
            "updated_at": "2026-01-11T09:51:47Z",
            "url": "https://api.github.com/repos/neovim/neovim/issues/comments/3734333104",
            "user": {
                "avatar_url": "https://avatars.githubusercontent.com/u/35768171?v=4",
                "events_url": "https://api.github.com/users/zeertzjq/events{/privacy}",
                "followers_url": "https://api.github.com/users/zeertzjq/followers",
                "following_url": "https://api.github.com/users/zeertzjq/following{/other_user}",
                "gists_url": "https://api.github.com/users/zeertzjq/gists{/gist_id}",
                "gravatar_id": "",
                "html_url": "https://github.com/zeertzjq",
                "id": 35768171,
                "login": "zeertzjq",
                "node_id": "MDQ6VXNlcjM1NzY4MTcx",
                "organizations_url": "https://api.github.com/users/zeertzjq/orgs",
                "received_events_url": "https://api.github.com/users/zeertzjq/received_events",
                "repos_url": "https://api.github.com/users/zeertzjq/repos",
                "site_admin": false,
                "starred_url": "https://api.github.com/users/zeertzjq/starred{/owner}{/repo}",
                "subscriptions_url": "https://api.github.com/users/zeertzjq/subscriptions",
                "type": "User",
                "url": "https://api.github.com/users/zeertzjq",
                "user_view_type": "public"
            }
        },
        {
            "author_association": "MEMBER",
            "body": "I am a bit hazy on this topic. One thing that is strange is that this seems to work in only one way:\n\n- Has side effects:\n\n```lua\nvim.api.nvim_set_option_value('number', false, { scope = 'local' })\nvim._with({ wo = { nu = true } }, function() end)\n```\n\n- No side effects:\n\n\n```lua\nvim.api.nvim_set_option_value('number', true, { scope = 'local' })\nvim._with({ wo = { nu = false } }, function() end)\n```\n\n---\n\nBut if it fixes the issue and passes all previous tests, then should be fine, I guess.\n\nWould you mind maybe adding some parenthesis to the first change? It starts to get a bit hard to read. Maybe like this:\n\n```lua\nres[sc][name] or (sc == 'wo' and vim.wo[0][0][name] or vim[sc][name]) or vim.NIL\n```",
            "created_at": "2026-01-11T10:21:28Z",
            "html_url": "https://github.com/neovim/neovim/issues/37304#issuecomment-3734361539",
            "id": 3734361539,
            "issue_url": "https://api.github.com/repos/neovim/neovim/issues/37304",
            "node_id": "IC_kwDOAPphoM7eldXD",
            "performed_via_github_app": null,
            "reactions": {
                "+1": 0,
                "-1": 0,
                "confused": 0,
                "eyes": 0,
                "heart": 0,
                "hooray": 0,
                "laugh": 0,
                "rocket": 0,
                "total_count": 0,
                "url": "https://api.github.com/repos/neovim/neovim/issues/comments/3734361539/reactions"
            },
            "updated_at": "2026-01-11T10:21:28Z",
            "url": "https://api.github.com/repos/neovim/neovim/issues/comments/3734361539",
            "user": {
                "avatar_url": "https://avatars.githubusercontent.com/u/24854248?v=4",
                "events_url": "https://api.github.com/users/echasnovski/events{/privacy}",
                "followers_url": "https://api.github.com/users/echasnovski/followers",
                "following_url": "https://api.github.com/users/echasnovski/following{/other_user}",
                "gists_url": "https://api.github.com/users/echasnovski/gists{/gist_id}",
                "gravatar_id": "",
                "html_url": "https://github.com/echasnovski",
                "id": 24854248,
                "login": "echasnovski",
                "node_id": "MDQ6VXNlcjI0ODU0MjQ4",
                "organizations_url": "https://api.github.com/users/echasnovski/orgs",
                "received_events_url": "https://api.github.com/users/echasnovski/received_events",
                "repos_url": "https://api.github.com/users/echasnovski/repos",
                "site_admin": false,
                "starred_url": "https://api.github.com/users/echasnovski/starred{/owner}{/repo}",
                "subscriptions_url": "https://api.github.com/users/echasnovski/subscriptions",
                "type": "User",
                "url": "https://api.github.com/users/echasnovski",
                "user_view_type": "public"
            }
        },
        {
            "author_association": "MEMBER",
            "body": "It seems to be a bug in the boolean logic used there. It needs to use `vim.F.if_nil` instead. Or just `if`.",
            "created_at": "2026-01-11T10:41:38Z",
            "html_url": "https://github.com/neovim/neovim/issues/37304#issuecomment-3734387383",
            "id": 3734387383,
            "issue_url": "https://api.github.com/repos/neovim/neovim/issues/37304",
            "node_id": "IC_kwDOAPphoM7eljq3",
            "performed_via_github_app": null,
            "reactions": {
                "+1": 0,
                "-1": 0,
                "confused": 0,
                "eyes": 0,
                "heart": 0,
                "hooray": 0,
                "laugh": 0,
                "rocket": 0,
                "total_count": 0,
                "url": "https://api.github.com/repos/neovim/neovim/issues/comments/3734387383/reactions"
            },
            "updated_at": "2026-01-11T10:46:29Z",
            "url": "https://api.github.com/repos/neovim/neovim/issues/comments/3734387383",
            "user": {
                "avatar_url": "https://avatars.githubusercontent.com/u/35768171?v=4",
                "events_url": "https://api.github.com/users/zeertzjq/events{/privacy}",
                "followers_url": "https://api.github.com/users/zeertzjq/followers",
                "following_url": "https://api.github.com/users/zeertzjq/following{/other_user}",
                "gists_url": "https://api.github.com/users/zeertzjq/gists{/gist_id}",
                "gravatar_id": "",
                "html_url": "https://github.com/zeertzjq",
                "id": 35768171,
                "login": "zeertzjq",
                "node_id": "MDQ6VXNlcjM1NzY4MTcx",
                "organizations_url": "https://api.github.com/users/zeertzjq/orgs",
                "received_events_url": "https://api.github.com/users/zeertzjq/received_events",
                "repos_url": "https://api.github.com/users/zeertzjq/repos",
                "site_admin": false,
                "starred_url": "https://api.github.com/users/zeertzjq/starred{/owner}{/repo}",
                "subscriptions_url": "https://api.github.com/users/zeertzjq/subscriptions",
                "type": "User",
                "url": "https://api.github.com/users/zeertzjq",
                "user_view_type": "public"
            }
        },
        {
            "author_association": "MEMBER",
            "body": "> It seems to be a bug in the boolean logic used there. It needs to use `vim.F.if_nil` instead. Or just `if`.\n\nYeah, judging by PR seems like it. Thanks for fixing this!",
            "created_at": "2026-01-11T12:15:57Z",
            "html_url": "https://github.com/neovim/neovim/issues/37304#issuecomment-3734475690",
            "id": 3734475690,
            "issue_url": "https://api.github.com/repos/neovim/neovim/issues/37304",
            "node_id": "IC_kwDOAPphoM7el5Oq",
            "performed_via_github_app": null,
            "reactions": {
                "+1": 0,
                "-1": 0,
                "confused": 0,
                "eyes": 0,
                "heart": 0,
                "hooray": 0,
                "laugh": 0,
                "rocket": 0,
                "total_count": 0,
                "url": "https://api.github.com/repos/neovim/neovim/issues/comments/3734475690/reactions"
            },
            "updated_at": "2026-01-11T12:15:57Z",
            "url": "https://api.github.com/repos/neovim/neovim/issues/comments/3734475690",
            "user": {
                "avatar_url": "https://avatars.githubusercontent.com/u/24854248?v=4",
                "events_url": "https://api.github.com/users/echasnovski/events{/privacy}",
                "followers_url": "https://api.github.com/users/echasnovski/followers",
                "following_url": "https://api.github.com/users/echasnovski/following{/other_user}",
                "gists_url": "https://api.github.com/users/echasnovski/gists{/gist_id}",
                "gravatar_id": "",
                "html_url": "https://github.com/echasnovski",
                "id": 24854248,
                "login": "echasnovski",
                "node_id": "MDQ6VXNlcjI0ODU0MjQ4",
                "organizations_url": "https://api.github.com/users/echasnovski/orgs",
                "received_events_url": "https://api.github.com/users/echasnovski/received_events",
                "repos_url": "https://api.github.com/users/echasnovski/repos",
                "site_admin": false,
                "starred_url": "https://api.github.com/users/echasnovski/starred{/owner}{/repo}",
                "subscriptions_url": "https://api.github.com/users/echasnovski/subscriptions",
                "type": "User",
                "url": "https://api.github.com/users/echasnovski",
                "user_view_type": "public"
            }
        }
    ],
    "comments": 6,
    "comments_url": "https://api.github.com/repos/neovim/neovim/issues/37304/comments",
    "created_at": "2026-01-08T09:34:48Z",
    "events_url": "https://api.github.com/repos/neovim/neovim/issues/37304/events",
    "html_url": "https://github.com/neovim/neovim/issues/37304",
    "id": 3792126772,
    "issue_dependencies_summary": {
        "blocked_by": 0,
        "blocking": 0,
        "total_blocked_by": 0,
        "total_blocking": 0
    },
    "labels": [
        {
            "color": "c5def5",
            "default": false,
            "description": "stdlib",
            "id": 573222693,
            "name": "lua",
            "node_id": "MDU6TGFiZWw1NzMyMjI2OTM=",
            "url": "https://api.github.com/repos/neovim/neovim/labels/lua"
        }
    ],
    "labels_url": "https://api.github.com/repos/neovim/neovim/issues/37304/labels{/name}",
    "locked": false,
    "milestone": null,
    "node_id": "I_kwDOAPphoM7iB0M0",
    "number": 37304,
    "performed_via_github_app": null,
    "reactions": {
        "+1": 0,
        "-1": 0,
        "confused": 0,
        "eyes": 0,
        "heart": 0,
        "hooray": 0,
        "laugh": 0,
        "rocket": 0,
        "total_count": 0,
        "url": "https://api.github.com/repos/neovim/neovim/issues/37304/reactions"
    },
    "repository_url": "https://api.github.com/repos/neovim/neovim",
    "state": "closed",
    "state_reason": "completed",
    "sub_issues_summary": {
        "completed": 0,
        "percent_completed": 0,
        "total": 0
    },
    "timeline_url": "https://api.github.com/repos/neovim/neovim/issues/37304/timeline",
    "title": "vim._with changes window-local option value",
    "type": {
        "color": "red",
        "created_at": "2024-01-25T10:10:19Z",
        "description": "An unexpected problem or behavior",
        "id": 597163,
        "is_enabled": true,
        "name": "Bug",
        "node_id": "IT_kwDOAGK_Pc4ACRyr",
        "updated_at": "2024-07-26T10:12:30Z"
    },
    "updated_at": "2026-01-11T12:15:57Z",
    "url": "https://api.github.com/repos/neovim/neovim/issues/37304",
    "user": {
        "avatar_url": "https://avatars.githubusercontent.com/u/91544758?v=4",
        "events_url": "https://api.github.com/users/phanen/events{/privacy}",
        "followers_url": "https://api.github.com/users/phanen/followers",
        "following_url": "https://api.github.com/users/phanen/following{/other_user}",
        "gists_url": "https://api.github.com/users/phanen/gists{/gist_id}",
        "gravatar_id": "",
        "html_url": "https://github.com/phanen",
        "id": 91544758,
        "login": "phanen",
        "node_id": "U_kgDOBXTctg",
        "organizations_url": "https://api.github.com/users/phanen/orgs",
        "received_events_url": "https://api.github.com/users/phanen/received_events",
        "repos_url": "https://api.github.com/users/phanen/repos",
        "site_admin": false,
        "starred_url": "https://api.github.com/users/phanen/starred{/owner}{/repo}",
        "subscriptions_url": "https://api.github.com/users/phanen/subscriptions",
        "type": "User",
        "url": "https://api.github.com/users/phanen",
        "user_view_type": "public"
    }
}