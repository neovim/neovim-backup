{
    "active_lock_reason": null,
    "assignee": null,
    "assignees": [],
    "author_association": "NONE",
    "body": "### Problem\n\nWhen using `vim.fn.termopen`, if I set the `on_stdout` and `on_stderr` functions, for the `termopen` and then run something producing lot of changing output in the term, like `btop`, then the `nvim` process will begin to accumulate memory that will not be freed up even after the terminal is closed.\n\n### Steps to reproduce\n\n```\r\nnvim --clean\r\n:lua vim.fn.termopen(vim.o.shell, {cdw = vim.fn.getcwd(),on_stdout = function(chan, data, _) end, on_stderr = function(chan, data, _) end, })\r\n```\r\n\r\nIn another terminal, check out the nvim process memory consumption: `ps -o rss= <pid>`, where `pid` is the neovim process id.\r\n\r\nYou can check the memory consumption for a minute. You will notice the same memory footprint. \r\n\r\nThen, in the nvim terminal, open `btop`. Select a process from the list of processes. Now let the `nvim` terminal untouched. \r\n\r\nIn the other terminal, check again the memory consumption of the `nvim` process every 30 seconds or so. You will notice that it keeps growing without stopping.\r\n\r\n*NOTE*\r\n\r\nIf I run the termopen without the `on_stdout` and `on_stderr` functions, like this:\r\n```\r\n:lua vim.fn.termopen(vim.o.shell, {cdw = vim.fn.getcwd()})\r\n```\r\nthen there is no memory leak. The memory consumption will remain the same after opening `btop` after several hours.\r\n\n\n### Expected behavior\n\nWhile the `btop` is opened in the terminal process, the memory consumption of the `nvim` process should remain unchanged.\n\n### Neovim version (nvim -v)\n\n0.9.4 latest stable\n\n### Vim (not Nvim) behaves the same?\n\nN/A since the `termopen` is neovim specific\n\n### Operating system/version\n\nArch linux 6.4.1-zen2-1-zen\n\n### Terminal name/version\n\nXTerm(383)\n\n### $TERM environment variable\n\nxterm-256color\n\n### Installation\n\nApp image from the latest releases",
    "closed_at": null,
    "comment_data": [
        {
            "author_association": "MEMBER",
            "body": "Related: https://github.com/neovim/neovim/issues/7871",
            "created_at": "2023-11-14T14:46:58Z",
            "html_url": "https://github.com/neovim/neovim/issues/25891#issuecomment-1810366573",
            "id": 1810366573,
            "issue_url": "https://api.github.com/repos/neovim/neovim/issues/25891",
            "node_id": "IC_kwDOAPphoM5r6ABt",
            "performed_via_github_app": null,
            "reactions": {
                "+1": 0,
                "-1": 0,
                "confused": 0,
                "eyes": 0,
                "heart": 0,
                "hooray": 0,
                "laugh": 0,
                "rocket": 0,
                "total_count": 0,
                "url": "https://api.github.com/repos/neovim/neovim/issues/comments/1810366573/reactions"
            },
            "updated_at": "2023-11-14T14:46:58Z",
            "url": "https://api.github.com/repos/neovim/neovim/issues/comments/1810366573",
            "user": {
                "avatar_url": "https://avatars.githubusercontent.com/u/1359421?v=4",
                "events_url": "https://api.github.com/users/justinmk/events{/privacy}",
                "followers_url": "https://api.github.com/users/justinmk/followers",
                "following_url": "https://api.github.com/users/justinmk/following{/other_user}",
                "gists_url": "https://api.github.com/users/justinmk/gists{/gist_id}",
                "gravatar_id": "",
                "html_url": "https://github.com/justinmk",
                "id": 1359421,
                "login": "justinmk",
                "node_id": "MDQ6VXNlcjEzNTk0MjE=",
                "organizations_url": "https://api.github.com/users/justinmk/orgs",
                "received_events_url": "https://api.github.com/users/justinmk/received_events",
                "repos_url": "https://api.github.com/users/justinmk/repos",
                "site_admin": false,
                "starred_url": "https://api.github.com/users/justinmk/starred{/owner}{/repo}",
                "subscriptions_url": "https://api.github.com/users/justinmk/subscriptions",
                "type": "User",
                "url": "https://api.github.com/users/justinmk"
            }
        },
        {
            "author_association": "MEMBER",
            "body": "I can reproduce the memory usage increase even without the callbacks.",
            "created_at": "2023-12-01T10:18:47Z",
            "html_url": "https://github.com/neovim/neovim/issues/25891#issuecomment-1835832808",
            "id": 1835832808,
            "issue_url": "https://api.github.com/repos/neovim/neovim/issues/25891",
            "node_id": "IC_kwDOAPphoM5tbJXo",
            "performed_via_github_app": null,
            "reactions": {
                "+1": 0,
                "-1": 0,
                "confused": 0,
                "eyes": 0,
                "heart": 0,
                "hooray": 0,
                "laugh": 0,
                "rocket": 0,
                "total_count": 0,
                "url": "https://api.github.com/repos/neovim/neovim/issues/comments/1835832808/reactions"
            },
            "updated_at": "2023-12-01T10:18:47Z",
            "url": "https://api.github.com/repos/neovim/neovim/issues/comments/1835832808",
            "user": {
                "avatar_url": "https://avatars.githubusercontent.com/u/35768171?v=4",
                "events_url": "https://api.github.com/users/zeertzjq/events{/privacy}",
                "followers_url": "https://api.github.com/users/zeertzjq/followers",
                "following_url": "https://api.github.com/users/zeertzjq/following{/other_user}",
                "gists_url": "https://api.github.com/users/zeertzjq/gists{/gist_id}",
                "gravatar_id": "",
                "html_url": "https://github.com/zeertzjq",
                "id": 35768171,
                "login": "zeertzjq",
                "node_id": "MDQ6VXNlcjM1NzY4MTcx",
                "organizations_url": "https://api.github.com/users/zeertzjq/orgs",
                "received_events_url": "https://api.github.com/users/zeertzjq/received_events",
                "repos_url": "https://api.github.com/users/zeertzjq/repos",
                "site_admin": false,
                "starred_url": "https://api.github.com/users/zeertzjq/starred{/owner}{/repo}",
                "subscriptions_url": "https://api.github.com/users/zeertzjq/subscriptions",
                "type": "User",
                "url": "https://api.github.com/users/zeertzjq"
            }
        },
        {
            "author_association": "NONE",
            "body": "I actually can't reproduce it without callbacks. @zeertzjq how did you reproduce it without callbacks?",
            "created_at": "2023-12-01T12:46:45Z",
            "html_url": "https://github.com/neovim/neovim/issues/25891#issuecomment-1836063617",
            "id": 1836063617,
            "issue_url": "https://api.github.com/repos/neovim/neovim/issues/25891",
            "node_id": "IC_kwDOAPphoM5tcBuB",
            "performed_via_github_app": null,
            "reactions": {
                "+1": 0,
                "-1": 0,
                "confused": 0,
                "eyes": 0,
                "heart": 0,
                "hooray": 0,
                "laugh": 0,
                "rocket": 0,
                "total_count": 0,
                "url": "https://api.github.com/repos/neovim/neovim/issues/comments/1836063617/reactions"
            },
            "updated_at": "2023-12-01T12:46:45Z",
            "url": "https://api.github.com/repos/neovim/neovim/issues/comments/1836063617",
            "user": {
                "avatar_url": "https://avatars.githubusercontent.com/u/5187873?v=4",
                "events_url": "https://api.github.com/users/cosminadrianpopescu/events{/privacy}",
                "followers_url": "https://api.github.com/users/cosminadrianpopescu/followers",
                "following_url": "https://api.github.com/users/cosminadrianpopescu/following{/other_user}",
                "gists_url": "https://api.github.com/users/cosminadrianpopescu/gists{/gist_id}",
                "gravatar_id": "",
                "html_url": "https://github.com/cosminadrianpopescu",
                "id": 5187873,
                "login": "cosminadrianpopescu",
                "node_id": "MDQ6VXNlcjUxODc4NzM=",
                "organizations_url": "https://api.github.com/users/cosminadrianpopescu/orgs",
                "received_events_url": "https://api.github.com/users/cosminadrianpopescu/received_events",
                "repos_url": "https://api.github.com/users/cosminadrianpopescu/repos",
                "site_admin": false,
                "starred_url": "https://api.github.com/users/cosminadrianpopescu/starred{/owner}{/repo}",
                "subscriptions_url": "https://api.github.com/users/cosminadrianpopescu/subscriptions",
                "type": "User",
                "url": "https://api.github.com/users/cosminadrianpopescu"
            }
        },
        {
            "author_association": "MEMBER",
            "body": "I checked again. It seems that the memory usage stops increasing after reaching some value, and doesn't increase by much after that even if another terminal instance is opened. Whether there are callbacks or not doesn't affect the result.\r\n\r\nSo I didn't actually reproduce this issue.",
            "created_at": "2023-12-01T14:56:35Z",
            "html_url": "https://github.com/neovim/neovim/issues/25891#issuecomment-1836259351",
            "id": 1836259351,
            "issue_url": "https://api.github.com/repos/neovim/neovim/issues/25891",
            "node_id": "IC_kwDOAPphoM5tcxgX",
            "performed_via_github_app": null,
            "reactions": {
                "+1": 0,
                "-1": 0,
                "confused": 0,
                "eyes": 0,
                "heart": 0,
                "hooray": 0,
                "laugh": 0,
                "rocket": 0,
                "total_count": 0,
                "url": "https://api.github.com/repos/neovim/neovim/issues/comments/1836259351/reactions"
            },
            "updated_at": "2023-12-01T15:14:35Z",
            "url": "https://api.github.com/repos/neovim/neovim/issues/comments/1836259351",
            "user": {
                "avatar_url": "https://avatars.githubusercontent.com/u/35768171?v=4",
                "events_url": "https://api.github.com/users/zeertzjq/events{/privacy}",
                "followers_url": "https://api.github.com/users/zeertzjq/followers",
                "following_url": "https://api.github.com/users/zeertzjq/following{/other_user}",
                "gists_url": "https://api.github.com/users/zeertzjq/gists{/gist_id}",
                "gravatar_id": "",
                "html_url": "https://github.com/zeertzjq",
                "id": 35768171,
                "login": "zeertzjq",
                "node_id": "MDQ6VXNlcjM1NzY4MTcx",
                "organizations_url": "https://api.github.com/users/zeertzjq/orgs",
                "received_events_url": "https://api.github.com/users/zeertzjq/received_events",
                "repos_url": "https://api.github.com/users/zeertzjq/repos",
                "site_admin": false,
                "starred_url": "https://api.github.com/users/zeertzjq/starred{/owner}{/repo}",
                "subscriptions_url": "https://api.github.com/users/zeertzjq/subscriptions",
                "type": "User",
                "url": "https://api.github.com/users/zeertzjq"
            }
        },
        {
            "author_association": "NONE",
            "body": "@zeertzjq Did you try opening a software that produces a lot of static output like `btop`? In `btop` you should activate the graphs, which will produce this output. My hypothesis is that actually when the callbacks are used, the output generated by the terminal is being buffered without actually being freed. \r\n\r\nIn a normal usage, the terminal has the scrollback setting to keep the number of lines (default 10000). So, the usage of the memory will increase without any  callbacks until 10000 lines are in the terminal buffer. After this, when a new line is added one is removed from the scrollback and so the memory stays constant. \r\n\r\nWhat happens when a software like btop is started, is that this will produce a lot of output on the current screen, without adding any new line in the scrollbuffer. So, this is when the issue starts to happen. \r\n\r\nWithout the callbacks, because there is no new line added in the scrollback, there is no memory increase. Memory stays constant over even a few days. \r\n\r\nAnd I would expect the same behavior with callbacks. However, I imagine that the modified lines are buffered somewhere when using the callbacks, so the memory will increase constantly. After several days of leaving the btop started and not touching anything else, my nvim process was using more than 7GB of ram. ",
            "created_at": "2023-12-01T16:46:18Z",
            "html_url": "https://github.com/neovim/neovim/issues/25891#issuecomment-1836445411",
            "id": 1836445411,
            "issue_url": "https://api.github.com/repos/neovim/neovim/issues/25891",
            "node_id": "IC_kwDOAPphoM5tde7j",
            "performed_via_github_app": null,
            "reactions": {
                "+1": 0,
                "-1": 0,
                "confused": 0,
                "eyes": 0,
                "heart": 0,
                "hooray": 0,
                "laugh": 0,
                "rocket": 0,
                "total_count": 0,
                "url": "https://api.github.com/repos/neovim/neovim/issues/comments/1836445411/reactions"
            },
            "updated_at": "2023-12-01T16:46:58Z",
            "url": "https://api.github.com/repos/neovim/neovim/issues/comments/1836445411",
            "user": {
                "avatar_url": "https://avatars.githubusercontent.com/u/5187873?v=4",
                "events_url": "https://api.github.com/users/cosminadrianpopescu/events{/privacy}",
                "followers_url": "https://api.github.com/users/cosminadrianpopescu/followers",
                "following_url": "https://api.github.com/users/cosminadrianpopescu/following{/other_user}",
                "gists_url": "https://api.github.com/users/cosminadrianpopescu/gists{/gist_id}",
                "gravatar_id": "",
                "html_url": "https://github.com/cosminadrianpopescu",
                "id": 5187873,
                "login": "cosminadrianpopescu",
                "node_id": "MDQ6VXNlcjUxODc4NzM=",
                "organizations_url": "https://api.github.com/users/cosminadrianpopescu/orgs",
                "received_events_url": "https://api.github.com/users/cosminadrianpopescu/received_events",
                "repos_url": "https://api.github.com/users/cosminadrianpopescu/repos",
                "site_admin": false,
                "starred_url": "https://api.github.com/users/cosminadrianpopescu/starred{/owner}{/repo}",
                "subscriptions_url": "https://api.github.com/users/cosminadrianpopescu/subscriptions",
                "type": "User",
                "url": "https://api.github.com/users/cosminadrianpopescu"
            }
        },
        {
            "author_association": "MEMBER",
            "body": "There is one scrollback buffer for each terminal, and a scrollback buffer is freed when its terminal is closed, so I think the behavior I observed is not caused by the scrollback buffer, but some global buffer with only one instance. I was running `btop` with its default config, with seems to already have graphs enabled.",
            "created_at": "2023-12-02T01:49:25Z",
            "html_url": "https://github.com/neovim/neovim/issues/25891#issuecomment-1836988763",
            "id": 1836988763,
            "issue_url": "https://api.github.com/repos/neovim/neovim/issues/25891",
            "node_id": "IC_kwDOAPphoM5tfjlb",
            "performed_via_github_app": null,
            "reactions": {
                "+1": 0,
                "-1": 0,
                "confused": 0,
                "eyes": 0,
                "heart": 0,
                "hooray": 0,
                "laugh": 0,
                "rocket": 0,
                "total_count": 0,
                "url": "https://api.github.com/repos/neovim/neovim/issues/comments/1836988763/reactions"
            },
            "updated_at": "2023-12-02T01:55:04Z",
            "url": "https://api.github.com/repos/neovim/neovim/issues/comments/1836988763",
            "user": {
                "avatar_url": "https://avatars.githubusercontent.com/u/35768171?v=4",
                "events_url": "https://api.github.com/users/zeertzjq/events{/privacy}",
                "followers_url": "https://api.github.com/users/zeertzjq/followers",
                "following_url": "https://api.github.com/users/zeertzjq/following{/other_user}",
                "gists_url": "https://api.github.com/users/zeertzjq/gists{/gist_id}",
                "gravatar_id": "",
                "html_url": "https://github.com/zeertzjq",
                "id": 35768171,
                "login": "zeertzjq",
                "node_id": "MDQ6VXNlcjM1NzY4MTcx",
                "organizations_url": "https://api.github.com/users/zeertzjq/orgs",
                "received_events_url": "https://api.github.com/users/zeertzjq/received_events",
                "repos_url": "https://api.github.com/users/zeertzjq/repos",
                "site_admin": false,
                "starred_url": "https://api.github.com/users/zeertzjq/starred{/owner}{/repo}",
                "subscriptions_url": "https://api.github.com/users/zeertzjq/subscriptions",
                "type": "User",
                "url": "https://api.github.com/users/zeertzjq"
            }
        }
    ],
    "comments": 6,
    "comments_url": "https://api.github.com/repos/neovim/neovim/issues/25891/comments",
    "created_at": "2023-11-04T12:28:11Z",
    "events_url": "https://api.github.com/repos/neovim/neovim/issues/25891/events",
    "html_url": "https://github.com/neovim/neovim/issues/25891",
    "id": 1977310388,
    "labels": [
        {
            "color": "f9d0c4",
            "default": true,
            "description": "issues reporting wrong behavior",
            "id": 77997474,
            "name": "bug",
            "node_id": "MDU6TGFiZWw3Nzk5NzQ3NA==",
            "url": "https://api.github.com/repos/neovim/neovim/labels/bug"
        },
        {
            "color": "c5def5",
            "default": false,
            "description": "OS processes, spawn",
            "id": 182884815,
            "name": "job-control",
            "node_id": "MDU6TGFiZWwxODI4ODQ4MTU=",
            "url": "https://api.github.com/repos/neovim/neovim/labels/job-control"
        },
        {
            "color": "c5def5",
            "default": false,
            "description": "built-in :terminal or :shell",
            "id": 212696822,
            "name": "terminal",
            "node_id": "MDU6TGFiZWwyMTI2OTY4MjI=",
            "url": "https://api.github.com/repos/neovim/neovim/labels/terminal"
        }
    ],
    "labels_url": "https://api.github.com/repos/neovim/neovim/issues/25891/labels{/name}",
    "locked": false,
    "milestone": {
        "closed_at": null,
        "closed_issues": 590,
        "created_at": "2014-05-10T20:43:04Z",
        "creator": {
            "avatar_url": "https://avatars.githubusercontent.com/u/1359421?v=4",
            "events_url": "https://api.github.com/users/justinmk/events{/privacy}",
            "followers_url": "https://api.github.com/users/justinmk/followers",
            "following_url": "https://api.github.com/users/justinmk/following{/other_user}",
            "gists_url": "https://api.github.com/users/justinmk/gists{/gist_id}",
            "gravatar_id": "",
            "html_url": "https://github.com/justinmk",
            "id": 1359421,
            "login": "justinmk",
            "node_id": "MDQ6VXNlcjEzNTk0MjE=",
            "organizations_url": "https://api.github.com/users/justinmk/orgs",
            "received_events_url": "https://api.github.com/users/justinmk/received_events",
            "repos_url": "https://api.github.com/users/justinmk/repos",
            "site_admin": false,
            "starred_url": "https://api.github.com/users/justinmk/starred{/owner}{/repo}",
            "subscriptions_url": "https://api.github.com/users/justinmk/subscriptions",
            "type": "User",
            "url": "https://api.github.com/users/justinmk"
        },
        "description": "Low priority. Not planned for the current target, may be reassigned.",
        "due_on": null,
        "html_url": "https://github.com/neovim/neovim/milestone/6",
        "id": 655037,
        "labels_url": "https://api.github.com/repos/neovim/neovim/milestones/6/labels",
        "node_id": "MDk6TWlsZXN0b25lNjU1MDM3",
        "number": 6,
        "open_issues": 423,
        "state": "open",
        "title": "backlog",
        "updated_at": "2023-12-01T09:11:59Z",
        "url": "https://api.github.com/repos/neovim/neovim/milestones/6"
    },
    "node_id": "I_kwDOAPphoM5121y0",
    "number": 25891,
    "performed_via_github_app": null,
    "reactions": {
        "+1": 0,
        "-1": 0,
        "confused": 0,
        "eyes": 0,
        "heart": 0,
        "hooray": 0,
        "laugh": 0,
        "rocket": 0,
        "total_count": 0,
        "url": "https://api.github.com/repos/neovim/neovim/issues/25891/reactions"
    },
    "repository_url": "https://api.github.com/repos/neovim/neovim",
    "state": "open",
    "state_reason": null,
    "timeline_url": "https://api.github.com/repos/neovim/neovim/issues/25891/timeline",
    "title": "Terminal memory leak",
    "updated_at": "2023-12-02T01:55:04Z",
    "url": "https://api.github.com/repos/neovim/neovim/issues/25891",
    "user": {
        "avatar_url": "https://avatars.githubusercontent.com/u/5187873?v=4",
        "events_url": "https://api.github.com/users/cosminadrianpopescu/events{/privacy}",
        "followers_url": "https://api.github.com/users/cosminadrianpopescu/followers",
        "following_url": "https://api.github.com/users/cosminadrianpopescu/following{/other_user}",
        "gists_url": "https://api.github.com/users/cosminadrianpopescu/gists{/gist_id}",
        "gravatar_id": "",
        "html_url": "https://github.com/cosminadrianpopescu",
        "id": 5187873,
        "login": "cosminadrianpopescu",
        "node_id": "MDQ6VXNlcjUxODc4NzM=",
        "organizations_url": "https://api.github.com/users/cosminadrianpopescu/orgs",
        "received_events_url": "https://api.github.com/users/cosminadrianpopescu/received_events",
        "repos_url": "https://api.github.com/users/cosminadrianpopescu/repos",
        "site_admin": false,
        "starred_url": "https://api.github.com/users/cosminadrianpopescu/starred{/owner}{/repo}",
        "subscriptions_url": "https://api.github.com/users/cosminadrianpopescu/subscriptions",
        "type": "User",
        "url": "https://api.github.com/users/cosminadrianpopescu"
    }
}