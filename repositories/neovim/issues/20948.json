{
    "active_lock_reason": null,
    "assignee": null,
    "assignees": [],
    "author_association": "NONE",
    "body": "### Neovim version (nvim -v)\r\n\r\nv0.9.0-dev-213+gcc5b7368d\r\n\r\n### Vim (not Nvim) behaves the same?\r\n\r\nNA, requires treesitter\r\n\r\n### Operating system/version\r\n\r\nCentOS Stream 9\r\n\r\n### Terminal name/version\r\n\r\nWSL2\r\n\r\n### $TERM environment variable\r\n\r\nscreen-256color\r\n\r\n### Installation\r\n\r\nbuild and install from repo (nightly)\r\n\r\n### How to reproduce the issue\r\n\r\ngit clone https://github.com/andremarianiello/nvim-ts-highlight-bug-repro.git\r\ncd nvim-ts-highlight-bug-repro\r\nnvim --clean main.c -s scriptin.vim\r\n\r\n### Expected behavior\r\n\r\nI would expect only the body of the `main()` function to be highlighted.\r\n\r\n![image](https://user-images.githubusercontent.com/3359229/200124904-f556744e-0035-42b7-849a-2f3f8010216b.png)\r\n\r\n\r\n### Actual behavior\r\n\r\nBoth function bodies are highlighted, even though `foo()` doesn't match the query predicate `(#eq? @declarator \"main()\")`.\r\n\r\n![image](https://user-images.githubusercontent.com/3359229/200124682-08868dc6-0042-4988-a907-73a84307bbc5.png)\r\n\r\n### Extra Information\r\n\r\nI have investigated this quite a bit (even though I am pretty unfamiliar with neovim's internals) and the issue seems to either be a bug in the treesitter api or a bug with how neovim uses the treesitter library api.\r\n\r\nTreesitter itself runs this query correctly\r\n```\r\n# tree-sitter query --captures ~/nvim-ts-highlight-bug-repro/queries/c/highlights.scm ~/nvim-ts-highlight-bug-repro/main.c\r\n/root/nvim-ts-highlight-bug-repro/main.c\r\n    pattern: 0, capture: declarator, row: 4, text: \"main()\"\r\n    pattern: 0, capture: comment, row: 4, text: \"{\\n   foo()\\n   return 0;\\n}\"\r\n```\r\nmatching only the main function, as the predicate dictates.\r\n\r\nHowever, neovim erroneously highlights both functions. I added some debug logs to clarify what is happening.\r\n\r\nHere are the (abridged) logs from the `foo()` match.\r\n```\r\nquery_next_capture:1138: found capture\r\nquery_next_capture:1140: capture: (function_declarator declarator: (identifier) parameters: (parameter_list))\r\nquery_next_capture:1149: n_pred: 4, max_match_id: -1, match.id: 0, capture_index: 0, match.pattern_index: 0, match.capture_count: 1\r\nquery_next_capture:1138: found capture\r\nquery_next_capture:1140: capture: (compound_statement (expression_statement (call_expression function: (identifier) arguments: (argument_list (string_literal)))))\r\nquery_next_capture:1149: n_pred: 4, max_match_id: 0, match.id: 0, capture_index: 1, match.pattern_index: 0, match.capture_count: 2\r\n```\r\n\r\nWe see that both captures are found. However, `match.capture_count` is 1 for the first capture, and it's 2 for the second capture. This seems to indicate that the treesitter api is returning the number of captures found _so far_ in capture count, not the total number of captures in the pattern. However, if I am reading the logic in `query_next_capture` correctly, it treats capture_count as the total number of captures, and uses that to determine how to handle predicates. I think this faulty expectation, or faulty capture count from treesitter, is the root cause of the issue.\r\n",
    "closed_at": null,
    "closed_by": null,
    "comment_data": [
        {
            "author_association": "MEMBER",
            "body": "You need \r\n```\r\n((function_definition\r\n\tdeclarator: _ @declarator\r\n\tbody: _ @comment)\r\n  (#eq? @declarator \"main()\"))\r\n```",
            "created_at": "2022-11-05T14:41:11Z",
            "html_url": "https://github.com/neovim/neovim/issues/20948#issuecomment-1304559201",
            "id": 1304559201,
            "issue_url": "https://api.github.com/repos/neovim/neovim/issues/20948",
            "node_id": "IC_kwDOAPphoM5Nwf5h",
            "performed_via_github_app": null,
            "reactions": {
                "+1": 0,
                "-1": 0,
                "confused": 0,
                "eyes": 0,
                "heart": 0,
                "hooray": 0,
                "laugh": 0,
                "rocket": 0,
                "total_count": 0,
                "url": "https://api.github.com/repos/neovim/neovim/issues/comments/1304559201/reactions"
            },
            "updated_at": "2022-11-05T15:01:14Z",
            "url": "https://api.github.com/repos/neovim/neovim/issues/comments/1304559201",
            "user": {
                "avatar_url": "https://avatars.githubusercontent.com/u/2361214?v=4",
                "events_url": "https://api.github.com/users/clason/events{/privacy}",
                "followers_url": "https://api.github.com/users/clason/followers",
                "following_url": "https://api.github.com/users/clason/following{/other_user}",
                "gists_url": "https://api.github.com/users/clason/gists{/gist_id}",
                "gravatar_id": "",
                "html_url": "https://github.com/clason",
                "id": 2361214,
                "login": "clason",
                "node_id": "MDQ6VXNlcjIzNjEyMTQ=",
                "organizations_url": "https://api.github.com/users/clason/orgs",
                "received_events_url": "https://api.github.com/users/clason/received_events",
                "repos_url": "https://api.github.com/users/clason/repos",
                "site_admin": false,
                "starred_url": "https://api.github.com/users/clason/starred{/owner}{/repo}",
                "subscriptions_url": "https://api.github.com/users/clason/subscriptions",
                "type": "User",
                "url": "https://api.github.com/users/clason",
                "user_view_type": "public"
            }
        },
        {
            "author_association": "NONE",
            "body": "> You need\r\n> \r\n> ```\r\n> ((function_definition\r\n> \tdeclarator: _ @declarator\r\n> \tbody: _ @comment)\r\n>   (#eq? @declarator \"main()\"))\r\n> ```\r\n\r\nMaybe I'm missing the difference, but to me that looks identical to the query I use in the reproduction https://github.com/andremarianiello/nvim-ts-highlight-bug-repro/blob/2f7a2ca858b11ee4fbeb1d71567b22225ba46208/queries/c/highlights.scm#L1-L4",
            "created_at": "2022-11-05T14:45:07Z",
            "html_url": "https://github.com/neovim/neovim/issues/20948#issuecomment-1304559827",
            "id": 1304559827,
            "issue_url": "https://api.github.com/repos/neovim/neovim/issues/20948",
            "node_id": "IC_kwDOAPphoM5NwgDT",
            "performed_via_github_app": null,
            "reactions": {
                "+1": 0,
                "-1": 0,
                "confused": 0,
                "eyes": 0,
                "heart": 0,
                "hooray": 0,
                "laugh": 0,
                "rocket": 0,
                "total_count": 0,
                "url": "https://api.github.com/repos/neovim/neovim/issues/comments/1304559827/reactions"
            },
            "updated_at": "2022-11-05T15:01:20Z",
            "url": "https://api.github.com/repos/neovim/neovim/issues/comments/1304559827",
            "user": {
                "avatar_url": "https://avatars.githubusercontent.com/u/3359229?v=4",
                "events_url": "https://api.github.com/users/andremarianiello/events{/privacy}",
                "followers_url": "https://api.github.com/users/andremarianiello/followers",
                "following_url": "https://api.github.com/users/andremarianiello/following{/other_user}",
                "gists_url": "https://api.github.com/users/andremarianiello/gists{/gist_id}",
                "gravatar_id": "",
                "html_url": "https://github.com/andremarianiello",
                "id": 3359229,
                "login": "andremarianiello",
                "node_id": "MDQ6VXNlcjMzNTkyMjk=",
                "organizations_url": "https://api.github.com/users/andremarianiello/orgs",
                "received_events_url": "https://api.github.com/users/andremarianiello/received_events",
                "repos_url": "https://api.github.com/users/andremarianiello/repos",
                "site_admin": false,
                "starred_url": "https://api.github.com/users/andremarianiello/starred{/owner}{/repo}",
                "subscriptions_url": "https://api.github.com/users/andremarianiello/subscriptions",
                "type": "User",
                "url": "https://api.github.com/users/andremarianiello",
                "user_view_type": "public"
            }
        },
        {
            "author_association": "MEMBER",
            "body": "It's really not. (It's lisp, parens matter.)",
            "created_at": "2022-11-05T14:46:26Z",
            "html_url": "https://github.com/neovim/neovim/issues/20948#issuecomment-1304560179",
            "id": 1304560179,
            "issue_url": "https://api.github.com/repos/neovim/neovim/issues/20948",
            "node_id": "IC_kwDOAPphoM5NwgIz",
            "performed_via_github_app": null,
            "reactions": {
                "+1": 0,
                "-1": 0,
                "confused": 0,
                "eyes": 0,
                "heart": 0,
                "hooray": 0,
                "laugh": 0,
                "rocket": 0,
                "total_count": 0,
                "url": "https://api.github.com/repos/neovim/neovim/issues/comments/1304560179/reactions"
            },
            "updated_at": "2022-11-05T15:01:26Z",
            "url": "https://api.github.com/repos/neovim/neovim/issues/comments/1304560179",
            "user": {
                "avatar_url": "https://avatars.githubusercontent.com/u/2361214?v=4",
                "events_url": "https://api.github.com/users/clason/events{/privacy}",
                "followers_url": "https://api.github.com/users/clason/followers",
                "following_url": "https://api.github.com/users/clason/following{/other_user}",
                "gists_url": "https://api.github.com/users/clason/gists{/gist_id}",
                "gravatar_id": "",
                "html_url": "https://github.com/clason",
                "id": 2361214,
                "login": "clason",
                "node_id": "MDQ6VXNlcjIzNjEyMTQ=",
                "organizations_url": "https://api.github.com/users/clason/orgs",
                "received_events_url": "https://api.github.com/users/clason/received_events",
                "repos_url": "https://api.github.com/users/clason/repos",
                "site_admin": false,
                "starred_url": "https://api.github.com/users/clason/starred{/owner}{/repo}",
                "subscriptions_url": "https://api.github.com/users/clason/subscriptions",
                "type": "User",
                "url": "https://api.github.com/users/clason",
                "user_view_type": "public"
            }
        },
        {
            "author_association": "NONE",
            "body": "> It's really not. (It's lisp, parens matter.)\r\n\r\nI tried again with the parens arranged according to your query, and the issue still occurs. Why does it matter which way its done?",
            "created_at": "2022-11-05T14:48:53Z",
            "html_url": "https://github.com/neovim/neovim/issues/20948#issuecomment-1304560644",
            "id": 1304560644,
            "issue_url": "https://api.github.com/repos/neovim/neovim/issues/20948",
            "node_id": "IC_kwDOAPphoM5NwgQE",
            "performed_via_github_app": null,
            "reactions": {
                "+1": 0,
                "-1": 0,
                "confused": 0,
                "eyes": 0,
                "heart": 0,
                "hooray": 0,
                "laugh": 0,
                "rocket": 0,
                "total_count": 0,
                "url": "https://api.github.com/repos/neovim/neovim/issues/comments/1304560644/reactions"
            },
            "updated_at": "2022-11-05T15:01:33Z",
            "url": "https://api.github.com/repos/neovim/neovim/issues/comments/1304560644",
            "user": {
                "avatar_url": "https://avatars.githubusercontent.com/u/3359229?v=4",
                "events_url": "https://api.github.com/users/andremarianiello/events{/privacy}",
                "followers_url": "https://api.github.com/users/andremarianiello/followers",
                "following_url": "https://api.github.com/users/andremarianiello/following{/other_user}",
                "gists_url": "https://api.github.com/users/andremarianiello/gists{/gist_id}",
                "gravatar_id": "",
                "html_url": "https://github.com/andremarianiello",
                "id": 3359229,
                "login": "andremarianiello",
                "node_id": "MDQ6VXNlcjMzNTkyMjk=",
                "organizations_url": "https://api.github.com/users/andremarianiello/orgs",
                "received_events_url": "https://api.github.com/users/andremarianiello/received_events",
                "repos_url": "https://api.github.com/users/andremarianiello/repos",
                "site_admin": false,
                "starred_url": "https://api.github.com/users/andremarianiello/starred{/owner}{/repo}",
                "subscriptions_url": "https://api.github.com/users/andremarianiello/subscriptions",
                "type": "User",
                "url": "https://api.github.com/users/andremarianiello",
                "user_view_type": "public"
            }
        },
        {
            "author_association": "MEMBER",
            "body": "Don't just look at the highlighting -- that doesn't show the difference. Check with `lua =vim.treesitter.get_captures_at_cursor()`.",
            "created_at": "2022-11-05T14:51:25Z",
            "html_url": "https://github.com/neovim/neovim/issues/20948#issuecomment-1304561053",
            "id": 1304561053,
            "issue_url": "https://api.github.com/repos/neovim/neovim/issues/20948",
            "node_id": "IC_kwDOAPphoM5NwgWd",
            "performed_via_github_app": null,
            "reactions": {
                "+1": 0,
                "-1": 0,
                "confused": 0,
                "eyes": 0,
                "heart": 0,
                "hooray": 0,
                "laugh": 0,
                "rocket": 0,
                "total_count": 0,
                "url": "https://api.github.com/repos/neovim/neovim/issues/comments/1304561053/reactions"
            },
            "updated_at": "2022-11-05T15:01:40Z",
            "url": "https://api.github.com/repos/neovim/neovim/issues/comments/1304561053",
            "user": {
                "avatar_url": "https://avatars.githubusercontent.com/u/2361214?v=4",
                "events_url": "https://api.github.com/users/clason/events{/privacy}",
                "followers_url": "https://api.github.com/users/clason/followers",
                "following_url": "https://api.github.com/users/clason/following{/other_user}",
                "gists_url": "https://api.github.com/users/clason/gists{/gist_id}",
                "gravatar_id": "",
                "html_url": "https://github.com/clason",
                "id": 2361214,
                "login": "clason",
                "node_id": "MDQ6VXNlcjIzNjEyMTQ=",
                "organizations_url": "https://api.github.com/users/clason/orgs",
                "received_events_url": "https://api.github.com/users/clason/received_events",
                "repos_url": "https://api.github.com/users/clason/repos",
                "site_admin": false,
                "starred_url": "https://api.github.com/users/clason/starred{/owner}{/repo}",
                "subscriptions_url": "https://api.github.com/users/clason/subscriptions",
                "type": "User",
                "url": "https://api.github.com/users/clason",
                "user_view_type": "public"
            }
        },
        {
            "author_association": "NONE",
            "body": "This bug is about the highlighting, so even if `lua =vim.treesitter.get_captures_at_cursor()` gave different results for each query, it wouldn't matter for the existence of an issue. However, I tried your check with both queries and for both queries it behaves the same (main() body is a \"comment\", foo() body is not). So I still fail to see why the parens matter.",
            "created_at": "2022-11-05T14:55:00Z",
            "html_url": "https://github.com/neovim/neovim/issues/20948#issuecomment-1304561567",
            "id": 1304561567,
            "issue_url": "https://api.github.com/repos/neovim/neovim/issues/20948",
            "node_id": "IC_kwDOAPphoM5Nwgef",
            "performed_via_github_app": null,
            "reactions": {
                "+1": 0,
                "-1": 0,
                "confused": 0,
                "eyes": 0,
                "heart": 0,
                "hooray": 0,
                "laugh": 0,
                "rocket": 0,
                "total_count": 0,
                "url": "https://api.github.com/repos/neovim/neovim/issues/comments/1304561567/reactions"
            },
            "updated_at": "2022-11-05T15:01:46Z",
            "url": "https://api.github.com/repos/neovim/neovim/issues/comments/1304561567",
            "user": {
                "avatar_url": "https://avatars.githubusercontent.com/u/3359229?v=4",
                "events_url": "https://api.github.com/users/andremarianiello/events{/privacy}",
                "followers_url": "https://api.github.com/users/andremarianiello/followers",
                "following_url": "https://api.github.com/users/andremarianiello/following{/other_user}",
                "gists_url": "https://api.github.com/users/andremarianiello/gists{/gist_id}",
                "gravatar_id": "",
                "html_url": "https://github.com/andremarianiello",
                "id": 3359229,
                "login": "andremarianiello",
                "node_id": "MDQ6VXNlcjMzNTkyMjk=",
                "organizations_url": "https://api.github.com/users/andremarianiello/orgs",
                "received_events_url": "https://api.github.com/users/andremarianiello/received_events",
                "repos_url": "https://api.github.com/users/andremarianiello/repos",
                "site_admin": false,
                "starred_url": "https://api.github.com/users/andremarianiello/starred{/owner}{/repo}",
                "subscriptions_url": "https://api.github.com/users/andremarianiello/subscriptions",
                "type": "User",
                "url": "https://api.github.com/users/andremarianiello",
                "user_view_type": "public"
            }
        },
        {
            "author_association": "MEMBER",
            "body": "> main() body is a \"comment\",\r\n\r\nBut it's really not, which is my point. So the issue is probably not with the `#eq` but something else.",
            "created_at": "2022-11-05T14:57:27Z",
            "html_url": "https://github.com/neovim/neovim/issues/20948#issuecomment-1304561968",
            "id": 1304561968,
            "issue_url": "https://api.github.com/repos/neovim/neovim/issues/20948",
            "node_id": "IC_kwDOAPphoM5Nwgkw",
            "performed_via_github_app": null,
            "reactions": {
                "+1": 0,
                "-1": 0,
                "confused": 0,
                "eyes": 0,
                "heart": 0,
                "hooray": 0,
                "laugh": 0,
                "rocket": 0,
                "total_count": 0,
                "url": "https://api.github.com/repos/neovim/neovim/issues/comments/1304561968/reactions"
            },
            "updated_at": "2022-11-05T15:01:52Z",
            "url": "https://api.github.com/repos/neovim/neovim/issues/comments/1304561968",
            "user": {
                "avatar_url": "https://avatars.githubusercontent.com/u/2361214?v=4",
                "events_url": "https://api.github.com/users/clason/events{/privacy}",
                "followers_url": "https://api.github.com/users/clason/followers",
                "following_url": "https://api.github.com/users/clason/following{/other_user}",
                "gists_url": "https://api.github.com/users/clason/gists{/gist_id}",
                "gravatar_id": "",
                "html_url": "https://github.com/clason",
                "id": 2361214,
                "login": "clason",
                "node_id": "MDQ6VXNlcjIzNjEyMTQ=",
                "organizations_url": "https://api.github.com/users/clason/orgs",
                "received_events_url": "https://api.github.com/users/clason/received_events",
                "repos_url": "https://api.github.com/users/clason/repos",
                "site_admin": false,
                "starred_url": "https://api.github.com/users/clason/starred{/owner}{/repo}",
                "subscriptions_url": "https://api.github.com/users/clason/subscriptions",
                "type": "User",
                "url": "https://api.github.com/users/clason",
                "user_view_type": "public"
            }
        },
        {
            "author_association": "NONE",
            "body": "_Moved to ticket description_",
            "created_at": "2022-11-05T14:58:30Z",
            "html_url": "https://github.com/neovim/neovim/issues/20948#issuecomment-1304562154",
            "id": 1304562154,
            "issue_url": "https://api.github.com/repos/neovim/neovim/issues/20948",
            "node_id": "IC_kwDOAPphoM5Nwgnq",
            "performed_via_github_app": null,
            "reactions": {
                "+1": 0,
                "-1": 0,
                "confused": 0,
                "eyes": 0,
                "heart": 0,
                "hooray": 0,
                "laugh": 0,
                "rocket": 0,
                "total_count": 0,
                "url": "https://api.github.com/repos/neovim/neovim/issues/comments/1304562154/reactions"
            },
            "updated_at": "2022-11-05T15:20:01Z",
            "url": "https://api.github.com/repos/neovim/neovim/issues/comments/1304562154",
            "user": {
                "avatar_url": "https://avatars.githubusercontent.com/u/3359229?v=4",
                "events_url": "https://api.github.com/users/andremarianiello/events{/privacy}",
                "followers_url": "https://api.github.com/users/andremarianiello/followers",
                "following_url": "https://api.github.com/users/andremarianiello/following{/other_user}",
                "gists_url": "https://api.github.com/users/andremarianiello/gists{/gist_id}",
                "gravatar_id": "",
                "html_url": "https://github.com/andremarianiello",
                "id": 3359229,
                "login": "andremarianiello",
                "node_id": "MDQ6VXNlcjMzNTkyMjk=",
                "organizations_url": "https://api.github.com/users/andremarianiello/orgs",
                "received_events_url": "https://api.github.com/users/andremarianiello/received_events",
                "repos_url": "https://api.github.com/users/andremarianiello/repos",
                "site_admin": false,
                "starred_url": "https://api.github.com/users/andremarianiello/starred{/owner}{/repo}",
                "subscriptions_url": "https://api.github.com/users/andremarianiello/subscriptions",
                "type": "User",
                "url": "https://api.github.com/users/andremarianiello",
                "user_view_type": "public"
            }
        },
        {
            "author_association": "MEMBER",
            "body": "Thank you, that is indeed very helpful. Still, the `get_captures_at_cursor()` function correctly handles the predicate, so the issue must be in a part of the highlighting code path that is not shared.",
            "created_at": "2022-11-05T15:02:02Z",
            "html_url": "https://github.com/neovim/neovim/issues/20948#issuecomment-1304562876",
            "id": 1304562876,
            "issue_url": "https://api.github.com/repos/neovim/neovim/issues/20948",
            "node_id": "IC_kwDOAPphoM5Nwgy8",
            "performed_via_github_app": null,
            "reactions": {
                "+1": 0,
                "-1": 0,
                "confused": 0,
                "eyes": 0,
                "heart": 0,
                "hooray": 0,
                "laugh": 0,
                "rocket": 0,
                "total_count": 0,
                "url": "https://api.github.com/repos/neovim/neovim/issues/comments/1304562876/reactions"
            },
            "updated_at": "2022-11-05T15:03:34Z",
            "url": "https://api.github.com/repos/neovim/neovim/issues/comments/1304562876",
            "user": {
                "avatar_url": "https://avatars.githubusercontent.com/u/2361214?v=4",
                "events_url": "https://api.github.com/users/clason/events{/privacy}",
                "followers_url": "https://api.github.com/users/clason/followers",
                "following_url": "https://api.github.com/users/clason/following{/other_user}",
                "gists_url": "https://api.github.com/users/clason/gists{/gist_id}",
                "gravatar_id": "",
                "html_url": "https://github.com/clason",
                "id": 2361214,
                "login": "clason",
                "node_id": "MDQ6VXNlcjIzNjEyMTQ=",
                "organizations_url": "https://api.github.com/users/clason/orgs",
                "received_events_url": "https://api.github.com/users/clason/received_events",
                "repos_url": "https://api.github.com/users/clason/repos",
                "site_admin": false,
                "starred_url": "https://api.github.com/users/clason/starred{/owner}{/repo}",
                "subscriptions_url": "https://api.github.com/users/clason/subscriptions",
                "type": "User",
                "url": "https://api.github.com/users/clason",
                "user_view_type": "public"
            }
        },
        {
            "author_association": "NONE",
            "body": "I think the capture_count is not 2 only during the very first time the match is found. I think all subsequent times the captures are iterated that the capture list is reused, so the capture_count is 2 for the entire iteration.\r\n\r\nHere are the (abridged) logs when I run `get_captures_at_cursor()` on `foo()` body\r\n\r\n```\r\nquery_next_capture:1138: found capture\r\nquery_next_capture:1140: capture: (compound_statement (expression_statement (call_expression function: (identifier) arguments: (argument_list (string_literal)))))\r\nquery_next_capture:1149: n_pred: 4, max_match_id: -1, match.id: 0, capture_index: 1, match.pattern_index: 0, match.capture_count: 2\r\n```\r\nWe see that capture count is 2. This triggered the predicate result caching behavior and when the predicate fails the match is removed so that no more captures from it are iterated over, producing the correct result. So I think the highlighting is failing because the code is incorrect for the first time that a match is found. I think it behaves correctly for subsequent usages of the same match.",
            "created_at": "2022-11-05T15:14:44Z",
            "html_url": "https://github.com/neovim/neovim/issues/20948#issuecomment-1304565173",
            "id": 1304565173,
            "issue_url": "https://api.github.com/repos/neovim/neovim/issues/20948",
            "node_id": "IC_kwDOAPphoM5NwhW1",
            "performed_via_github_app": null,
            "reactions": {
                "+1": 0,
                "-1": 0,
                "confused": 0,
                "eyes": 0,
                "heart": 0,
                "hooray": 0,
                "laugh": 0,
                "rocket": 0,
                "total_count": 0,
                "url": "https://api.github.com/repos/neovim/neovim/issues/comments/1304565173/reactions"
            },
            "updated_at": "2022-11-05T15:15:17Z",
            "url": "https://api.github.com/repos/neovim/neovim/issues/comments/1304565173",
            "user": {
                "avatar_url": "https://avatars.githubusercontent.com/u/3359229?v=4",
                "events_url": "https://api.github.com/users/andremarianiello/events{/privacy}",
                "followers_url": "https://api.github.com/users/andremarianiello/followers",
                "following_url": "https://api.github.com/users/andremarianiello/following{/other_user}",
                "gists_url": "https://api.github.com/users/andremarianiello/gists{/gist_id}",
                "gravatar_id": "",
                "html_url": "https://github.com/andremarianiello",
                "id": 3359229,
                "login": "andremarianiello",
                "node_id": "MDQ6VXNlcjMzNTkyMjk=",
                "organizations_url": "https://api.github.com/users/andremarianiello/orgs",
                "received_events_url": "https://api.github.com/users/andremarianiello/received_events",
                "repos_url": "https://api.github.com/users/andremarianiello/repos",
                "site_admin": false,
                "starred_url": "https://api.github.com/users/andremarianiello/starred{/owner}{/repo}",
                "subscriptions_url": "https://api.github.com/users/andremarianiello/subscriptions",
                "type": "User",
                "url": "https://api.github.com/users/andremarianiello",
                "user_view_type": "public"
            }
        },
        {
            "author_association": "NONE",
            "body": "@clason Thank you for re-adding the bug label",
            "created_at": "2022-11-05T15:30:39Z",
            "html_url": "https://github.com/neovim/neovim/issues/20948#issuecomment-1304568271",
            "id": 1304568271,
            "issue_url": "https://api.github.com/repos/neovim/neovim/issues/20948",
            "node_id": "IC_kwDOAPphoM5NwiHP",
            "performed_via_github_app": null,
            "reactions": {
                "+1": 0,
                "-1": 0,
                "confused": 0,
                "eyes": 0,
                "heart": 0,
                "hooray": 0,
                "laugh": 0,
                "rocket": 0,
                "total_count": 0,
                "url": "https://api.github.com/repos/neovim/neovim/issues/comments/1304568271/reactions"
            },
            "updated_at": "2022-11-05T15:30:39Z",
            "url": "https://api.github.com/repos/neovim/neovim/issues/comments/1304568271",
            "user": {
                "avatar_url": "https://avatars.githubusercontent.com/u/3359229?v=4",
                "events_url": "https://api.github.com/users/andremarianiello/events{/privacy}",
                "followers_url": "https://api.github.com/users/andremarianiello/followers",
                "following_url": "https://api.github.com/users/andremarianiello/following{/other_user}",
                "gists_url": "https://api.github.com/users/andremarianiello/gists{/gist_id}",
                "gravatar_id": "",
                "html_url": "https://github.com/andremarianiello",
                "id": 3359229,
                "login": "andremarianiello",
                "node_id": "MDQ6VXNlcjMzNTkyMjk=",
                "organizations_url": "https://api.github.com/users/andremarianiello/orgs",
                "received_events_url": "https://api.github.com/users/andremarianiello/received_events",
                "repos_url": "https://api.github.com/users/andremarianiello/repos",
                "site_admin": false,
                "starred_url": "https://api.github.com/users/andremarianiello/starred{/owner}{/repo}",
                "subscriptions_url": "https://api.github.com/users/andremarianiello/subscriptions",
                "type": "User",
                "url": "https://api.github.com/users/andremarianiello",
                "user_view_type": "public"
            }
        },
        {
            "author_association": "CONTRIBUTOR",
            "body": "I have run into either a similar bug or the same bug when using tree-sitter-astro.\r\n\r\nThe following Astro file\r\n```\r\n---\r\n---\r\n\r\n<html lang=\"en\">\r\n</html>\r\n```\r\n\r\n\r\n\r\nhas incorrect syntax highlighting on the opening `<html`, even though tree-sitter-astro is returning the correct tree.\r\n![image](https://user-images.githubusercontent.com/16955157/208228013-f3956391-6c95-4b7a-a2ef-223568e4f588.png)\r\n\r\nThe syntax highlighting corrects itself if the frontmatter has any text in it. Note that the `element` tree is still the same.\r\n![image](https://user-images.githubusercontent.com/16955157/208228126-a8441a27-5f3e-421c-a42d-ef911e973107.png)\r\n\r\nThis bug seems to have some weird state changes though:\r\n\r\n1. The bug will disappear if you highlight any text past the issue, and will reappear once the highlighting goes away. This appears to work with any feature of Neovim that changes the background color. This includes:\r\n\r\n* Playground highlighting\r\n\r\nhttps://user-images.githubusercontent.com/16955157/208228348-81c25985-bbbe-40f0-8356-52b847f5e9f9.mp4\r\n\r\n* Visual mode\r\n\r\nhttps://user-images.githubusercontent.com/16955157/208228543-7c75b24d-efa0-4ef4-87b4-0389dfcb8b7f.mp4\r\n\r\n* `:set cursorline`\r\n\r\nhttps://user-images.githubusercontent.com/16955157/208228668-f80310dc-a1c7-4e28-9929-7b41ee3d9ba3.mp4\r\n\r\n2. The bug appears to work incrementally. When editing the file, even after the frontmatter has been filled, the bad highlighting will be preserved. You have to delete and retype the offending line to fix the highlighting, after which it stays fixed.\r\n\r\nhttps://user-images.githubusercontent.com/16955157/208228778-0bac5075-93a7-4e16-994b-e65f38fb1b8a.mp4\r\n\r\n3. However, the bug does _not_ work incrementally in the opposite direction. Incrementally changing a fixed document may cause the bug to appear.\r\n\r\nhttps://user-images.githubusercontent.com/16955157/208228946-eb1264ca-d695-4c02-8eb1-83eec74a4d3b.mp4\r\n\r\nAlso I'm not really sure what's going on with the `---` end of the frontmatter. It seems to be affected also, since it stops being pink when the issue gets fixed, but highlighting it doesn't fix it like it does with the `<html`.",
            "created_at": "2022-12-17T06:34:45Z",
            "html_url": "https://github.com/neovim/neovim/issues/20948#issuecomment-1356072324",
            "id": 1356072324,
            "issue_url": "https://api.github.com/repos/neovim/neovim/issues/20948",
            "node_id": "IC_kwDOAPphoM5Q1AWE",
            "performed_via_github_app": null,
            "reactions": {
                "+1": 0,
                "-1": 0,
                "confused": 0,
                "eyes": 0,
                "heart": 0,
                "hooray": 0,
                "laugh": 0,
                "rocket": 0,
                "total_count": 0,
                "url": "https://api.github.com/repos/neovim/neovim/issues/comments/1356072324/reactions"
            },
            "updated_at": "2022-12-17T06:37:26Z",
            "url": "https://api.github.com/repos/neovim/neovim/issues/comments/1356072324",
            "user": {
                "avatar_url": "https://avatars.githubusercontent.com/u/16955157?v=4",
                "events_url": "https://api.github.com/users/virchau13/events{/privacy}",
                "followers_url": "https://api.github.com/users/virchau13/followers",
                "following_url": "https://api.github.com/users/virchau13/following{/other_user}",
                "gists_url": "https://api.github.com/users/virchau13/gists{/gist_id}",
                "gravatar_id": "",
                "html_url": "https://github.com/virchau13",
                "id": 16955157,
                "login": "virchau13",
                "node_id": "MDQ6VXNlcjE2OTU1MTU3",
                "organizations_url": "https://api.github.com/users/virchau13/orgs",
                "received_events_url": "https://api.github.com/users/virchau13/received_events",
                "repos_url": "https://api.github.com/users/virchau13/repos",
                "site_admin": false,
                "starred_url": "https://api.github.com/users/virchau13/starred{/owner}{/repo}",
                "subscriptions_url": "https://api.github.com/users/virchau13/subscriptions",
                "type": "User",
                "url": "https://api.github.com/users/virchau13",
                "user_view_type": "public"
            }
        }
    ],
    "comments": 12,
    "comments_url": "https://api.github.com/repos/neovim/neovim/issues/20948/comments",
    "created_at": "2022-11-05T14:33:31Z",
    "events_url": "https://api.github.com/repos/neovim/neovim/issues/20948/events",
    "html_url": "https://github.com/neovim/neovim/issues/20948",
    "id": 1437052986,
    "labels": [
        {
            "color": "f9d0c4",
            "default": true,
            "description": "issues reporting wrong behavior",
            "id": 77997474,
            "name": "bug",
            "node_id": "MDU6TGFiZWw3Nzk5NzQ3NA==",
            "url": "https://api.github.com/repos/neovim/neovim/labels/bug"
        },
        {
            "color": "c5def5",
            "default": false,
            "description": "",
            "id": 1786207367,
            "name": "highlight",
            "node_id": "MDU6TGFiZWwxNzg2MjA3MzY3",
            "url": "https://api.github.com/repos/neovim/neovim/labels/highlight"
        },
        {
            "color": "c5def5",
            "default": false,
            "description": "",
            "id": 1799626557,
            "name": "treesitter",
            "node_id": "MDU6TGFiZWwxNzk5NjI2NTU3",
            "url": "https://api.github.com/repos/neovim/neovim/labels/treesitter"
        }
    ],
    "labels_url": "https://api.github.com/repos/neovim/neovim/issues/20948/labels{/name}",
    "locked": false,
    "milestone": null,
    "node_id": "I_kwDOAPphoM5Vp7A6",
    "number": 20948,
    "performed_via_github_app": null,
    "reactions": {
        "+1": 1,
        "-1": 0,
        "confused": 0,
        "eyes": 0,
        "heart": 0,
        "hooray": 0,
        "laugh": 0,
        "rocket": 0,
        "total_count": 1,
        "url": "https://api.github.com/repos/neovim/neovim/issues/20948/reactions"
    },
    "repository_url": "https://api.github.com/repos/neovim/neovim",
    "state": "open",
    "state_reason": null,
    "sub_issues_summary": {
        "completed": 0,
        "percent_completed": 0,
        "total": 0
    },
    "timeline_url": "https://api.github.com/repos/neovim/neovim/issues/20948/timeline",
    "title": "Treesitter highlight queries with predicates can get highlighted even if they don't match",
    "updated_at": "2025-01-19T11:35:48Z",
    "url": "https://api.github.com/repos/neovim/neovim/issues/20948",
    "user": {
        "avatar_url": "https://avatars.githubusercontent.com/u/3359229?v=4",
        "events_url": "https://api.github.com/users/andremarianiello/events{/privacy}",
        "followers_url": "https://api.github.com/users/andremarianiello/followers",
        "following_url": "https://api.github.com/users/andremarianiello/following{/other_user}",
        "gists_url": "https://api.github.com/users/andremarianiello/gists{/gist_id}",
        "gravatar_id": "",
        "html_url": "https://github.com/andremarianiello",
        "id": 3359229,
        "login": "andremarianiello",
        "node_id": "MDQ6VXNlcjMzNTkyMjk=",
        "organizations_url": "https://api.github.com/users/andremarianiello/orgs",
        "received_events_url": "https://api.github.com/users/andremarianiello/received_events",
        "repos_url": "https://api.github.com/users/andremarianiello/repos",
        "site_admin": false,
        "starred_url": "https://api.github.com/users/andremarianiello/starred{/owner}{/repo}",
        "subscriptions_url": "https://api.github.com/users/andremarianiello/subscriptions",
        "type": "User",
        "url": "https://api.github.com/users/andremarianiello",
        "user_view_type": "public"
    }
}