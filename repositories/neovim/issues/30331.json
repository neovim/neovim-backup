{
    "active_lock_reason": null,
    "assignee": null,
    "assignees": [],
    "author_association": "CONTRIBUTOR",
    "body": "### Problem\r\n\r\nExtmarks are not restored properly on redo.\r\n\r\n### Steps to reproduce\r\n\r\nRun this lua script to set up the buffer.\r\n```lua\r\nvim.cmd \"enew\"\r\nvim.api.nvim_buf_set_lines(0, 0, -1, 1, {\"foobar\"})\r\nlocal ns = vim.api.nvim_create_namespace(\"\")\r\nvim.api.nvim_buf_set_extmark(0, ns, 0, 3, { end_col = 6, hl_group = \"Error\" })\r\n```\r\n1. Observe restoration works properly on undo\r\n    1. Source the provided lua script\r\n    2. Press `D` (delete \"foobar\")\r\n    3. Press `u`(undo deletion)\r\n    4. Observe that the highlighting is still present\r\n2. Observe restoration does not work on redo\r\n    1. Source the provided lua script\r\n    2. Press `u` (undo \"foobar\")\r\n    3. Press `<C-r>` (redo \"foobar\")\r\n    4. Observe that the highlighting is absent\r\n\r\n### Neovim version (nvim -v)\r\n\r\n0.10.1",
    "closed_at": null,
    "closed_by": null,
    "comment_data": [
        {
            "author_association": "MEMBER",
            "body": "I guess `undo_restore` is not mentioned because it defaults to true.",
            "created_at": "2024-09-10T14:02:02Z",
            "html_url": "https://github.com/neovim/neovim/issues/30331#issuecomment-2340908728",
            "id": 2340908728,
            "issue_url": "https://api.github.com/repos/neovim/neovim/issues/30331",
            "node_id": "IC_kwDOAPphoM6Lh264",
            "performed_via_github_app": null,
            "reactions": {
                "+1": 1,
                "-1": 0,
                "confused": 0,
                "eyes": 0,
                "heart": 0,
                "hooray": 0,
                "laugh": 0,
                "rocket": 0,
                "total_count": 1,
                "url": "https://api.github.com/repos/neovim/neovim/issues/comments/2340908728/reactions"
            },
            "updated_at": "2024-09-10T14:02:02Z",
            "url": "https://api.github.com/repos/neovim/neovim/issues/comments/2340908728",
            "user": {
                "avatar_url": "https://avatars.githubusercontent.com/u/1359421?v=4",
                "events_url": "https://api.github.com/users/justinmk/events{/privacy}",
                "followers_url": "https://api.github.com/users/justinmk/followers",
                "following_url": "https://api.github.com/users/justinmk/following{/other_user}",
                "gists_url": "https://api.github.com/users/justinmk/gists{/gist_id}",
                "gravatar_id": "",
                "html_url": "https://github.com/justinmk",
                "id": 1359421,
                "login": "justinmk",
                "node_id": "MDQ6VXNlcjEzNTk0MjE=",
                "organizations_url": "https://api.github.com/users/justinmk/orgs",
                "received_events_url": "https://api.github.com/users/justinmk/received_events",
                "repos_url": "https://api.github.com/users/justinmk/repos",
                "site_admin": false,
                "starred_url": "https://api.github.com/users/justinmk/starred{/owner}{/repo}",
                "subscriptions_url": "https://api.github.com/users/justinmk/subscriptions",
                "type": "User",
                "url": "https://api.github.com/users/justinmk",
                "user_view_type": "public"
            }
        },
        {
            "author_association": "CONTRIBUTOR",
            "body": "I think this is _technically_ a feature request and not a bug. The very last paragraph in `:h extmarks` states:\n\n>  Extmark positions changed by an edit will be restored on undo/redo. Creating and deleting extmarks is not a buffer change, thus new undo states are not created for extmark changes\n\nIn your first example, an extmark was created, and then its position was then changed by an edit (delete \"foobar\"), so as stated above, the extmark is restored on undo.\n\nHowever, in your second example, an edit was made (add \"foobar\"), and _then_ an extmark was added, so as stated above, a new undo state will not be created for this extmark change.\n\nAn argument could be made that the \"undo\" in the second example should count as an edit and the extmark position should be restored on redo. I think this is also what would intuitively be expected. A possible implementation would be to modify extmark information associated with the relevant undo state (contained in `u_header.uh_extmark`). This could also be put behind a `redo_restore` option to `nvim_buf_set_extmark` to match the existing `undo_restore` option.\n\nI'm happy to take a stab at implementing this, but I'd appreciate it if a maintainer could weigh in and let me know if there's any reason not to implement this feature or if there's a problem with my proposed approach. @justinmk I hope you don't mind me pinging you, but do you have any thoughts?",
            "created_at": "2024-11-18T19:55:42Z",
            "html_url": "https://github.com/neovim/neovim/issues/30331#issuecomment-2483981925",
            "id": 2483981925,
            "issue_url": "https://api.github.com/repos/neovim/neovim/issues/30331",
            "node_id": "IC_kwDOAPphoM6UDo5l",
            "performed_via_github_app": null,
            "reactions": {
                "+1": 0,
                "-1": 0,
                "confused": 0,
                "eyes": 0,
                "heart": 0,
                "hooray": 0,
                "laugh": 0,
                "rocket": 0,
                "total_count": 0,
                "url": "https://api.github.com/repos/neovim/neovim/issues/comments/2483981925/reactions"
            },
            "updated_at": "2024-11-18T19:55:42Z",
            "url": "https://api.github.com/repos/neovim/neovim/issues/comments/2483981925",
            "user": {
                "avatar_url": "https://avatars.githubusercontent.com/u/40901142?v=4",
                "events_url": "https://api.github.com/users/zshuzh/events{/privacy}",
                "followers_url": "https://api.github.com/users/zshuzh/followers",
                "following_url": "https://api.github.com/users/zshuzh/following{/other_user}",
                "gists_url": "https://api.github.com/users/zshuzh/gists{/gist_id}",
                "gravatar_id": "",
                "html_url": "https://github.com/zshuzh",
                "id": 40901142,
                "login": "zshuzh",
                "node_id": "MDQ6VXNlcjQwOTAxMTQy",
                "organizations_url": "https://api.github.com/users/zshuzh/orgs",
                "received_events_url": "https://api.github.com/users/zshuzh/received_events",
                "repos_url": "https://api.github.com/users/zshuzh/repos",
                "site_admin": false,
                "starred_url": "https://api.github.com/users/zshuzh/starred{/owner}{/repo}",
                "subscriptions_url": "https://api.github.com/users/zshuzh/subscriptions",
                "type": "User",
                "url": "https://api.github.com/users/zshuzh",
                "user_view_type": "public"
            }
        },
        {
            "author_association": "MEMBER",
            "body": "Yeah regardless if a bug or a feature request I think the expected behavior makes more sense. PR welcome.\n\n> This could also be put behind a redo_restore option to nvim_buf_set_extmark to match the existing undo_restore option.\n\nNo need for a separate flag. `undo_restore` refers to the entire undo machinery, including redoing, branches (as far as possible) etc.",
            "created_at": "2024-11-18T20:10:46Z",
            "html_url": "https://github.com/neovim/neovim/issues/30331#issuecomment-2484027479",
            "id": 2484027479,
            "issue_url": "https://api.github.com/repos/neovim/neovim/issues/30331",
            "node_id": "IC_kwDOAPphoM6UD0BX",
            "performed_via_github_app": null,
            "reactions": {
                "+1": 2,
                "-1": 0,
                "confused": 0,
                "eyes": 0,
                "heart": 0,
                "hooray": 0,
                "laugh": 0,
                "rocket": 0,
                "total_count": 2,
                "url": "https://api.github.com/repos/neovim/neovim/issues/comments/2484027479/reactions"
            },
            "updated_at": "2024-11-18T20:10:46Z",
            "url": "https://api.github.com/repos/neovim/neovim/issues/comments/2484027479",
            "user": {
                "avatar_url": "https://avatars.githubusercontent.com/u/1363104?v=4",
                "events_url": "https://api.github.com/users/bfredl/events{/privacy}",
                "followers_url": "https://api.github.com/users/bfredl/followers",
                "following_url": "https://api.github.com/users/bfredl/following{/other_user}",
                "gists_url": "https://api.github.com/users/bfredl/gists{/gist_id}",
                "gravatar_id": "",
                "html_url": "https://github.com/bfredl",
                "id": 1363104,
                "login": "bfredl",
                "node_id": "MDQ6VXNlcjEzNjMxMDQ=",
                "organizations_url": "https://api.github.com/users/bfredl/orgs",
                "received_events_url": "https://api.github.com/users/bfredl/received_events",
                "repos_url": "https://api.github.com/users/bfredl/repos",
                "site_admin": false,
                "starred_url": "https://api.github.com/users/bfredl/starred{/owner}{/repo}",
                "subscriptions_url": "https://api.github.com/users/bfredl/subscriptions",
                "type": "User",
                "url": "https://api.github.com/users/bfredl",
                "user_view_type": "public"
            }
        }
    ],
    "comments": 3,
    "comments_url": "https://api.github.com/repos/neovim/neovim/issues/30331/comments",
    "created_at": "2024-09-10T13:56:33Z",
    "events_url": "https://api.github.com/repos/neovim/neovim/issues/30331/events",
    "html_url": "https://github.com/neovim/neovim/issues/30331",
    "id": 2516558610,
    "labels": [
        {
            "color": "f9d0c4",
            "default": true,
            "description": "issues reporting wrong behavior",
            "id": 77997474,
            "name": "bug",
            "node_id": "MDU6TGFiZWw3Nzk5NzQ3NA==",
            "url": "https://api.github.com/repos/neovim/neovim/labels/bug"
        },
        {
            "color": "0E8A16",
            "default": false,
            "description": "issue contains minimal reproducing steps",
            "id": 435851959,
            "name": "has:repro",
            "node_id": "MDU6TGFiZWw0MzU4NTE5NTk=",
            "url": "https://api.github.com/repos/neovim/neovim/labels/has:repro"
        },
        {
            "color": "c5def5",
            "default": false,
            "description": "marks, extmarks, decorations, virtual text, namespaces",
            "id": 1680119719,
            "name": "marks",
            "node_id": "MDU6TGFiZWwxNjgwMTE5NzE5",
            "url": "https://api.github.com/repos/neovim/neovim/labels/marks"
        },
        {
            "color": "C5DEF5",
            "default": false,
            "description": "save/restore editor state: shada, context, ctx",
            "id": 4449264023,
            "name": "editor-state",
            "node_id": "LA_kwDOAPphoM8AAAABCTJhlw",
            "url": "https://api.github.com/repos/neovim/neovim/labels/editor-state"
        }
    ],
    "labels_url": "https://api.github.com/repos/neovim/neovim/issues/30331/labels{/name}",
    "locked": false,
    "milestone": {
        "closed_at": null,
        "closed_issues": 686,
        "created_at": "2014-05-10T20:43:04Z",
        "creator": {
            "avatar_url": "https://avatars.githubusercontent.com/u/1359421?v=4",
            "events_url": "https://api.github.com/users/justinmk/events{/privacy}",
            "followers_url": "https://api.github.com/users/justinmk/followers",
            "following_url": "https://api.github.com/users/justinmk/following{/other_user}",
            "gists_url": "https://api.github.com/users/justinmk/gists{/gist_id}",
            "gravatar_id": "",
            "html_url": "https://github.com/justinmk",
            "id": 1359421,
            "login": "justinmk",
            "node_id": "MDQ6VXNlcjEzNTk0MjE=",
            "organizations_url": "https://api.github.com/users/justinmk/orgs",
            "received_events_url": "https://api.github.com/users/justinmk/received_events",
            "repos_url": "https://api.github.com/users/justinmk/repos",
            "site_admin": false,
            "starred_url": "https://api.github.com/users/justinmk/starred{/owner}{/repo}",
            "subscriptions_url": "https://api.github.com/users/justinmk/subscriptions",
            "type": "User",
            "url": "https://api.github.com/users/justinmk",
            "user_view_type": "public"
        },
        "description": "Low priority items. We plan to work on this but don't have a target date.",
        "due_on": null,
        "html_url": "https://github.com/neovim/neovim/milestone/6",
        "id": 655037,
        "labels_url": "https://api.github.com/repos/neovim/neovim/milestones/6/labels",
        "node_id": "MDk6TWlsZXN0b25lNjU1MDM3",
        "number": 6,
        "open_issues": 635,
        "state": "open",
        "title": "backlog",
        "updated_at": "2025-01-21T00:09:37Z",
        "url": "https://api.github.com/repos/neovim/neovim/milestones/6"
    },
    "node_id": "I_kwDOAPphoM6V_6MS",
    "number": 30331,
    "performed_via_github_app": null,
    "reactions": {
        "+1": 0,
        "-1": 0,
        "confused": 0,
        "eyes": 0,
        "heart": 0,
        "hooray": 0,
        "laugh": 0,
        "rocket": 0,
        "total_count": 0,
        "url": "https://api.github.com/repos/neovim/neovim/issues/30331/reactions"
    },
    "repository_url": "https://api.github.com/repos/neovim/neovim",
    "state": "open",
    "state_reason": null,
    "sub_issues_summary": {
        "completed": 0,
        "percent_completed": 0,
        "total": 0
    },
    "timeline_url": "https://api.github.com/repos/neovim/neovim/issues/30331/timeline",
    "title": "Extmarks are not restored on redo",
    "updated_at": "2025-01-19T10:59:11Z",
    "url": "https://api.github.com/repos/neovim/neovim/issues/30331",
    "user": {
        "avatar_url": "https://avatars.githubusercontent.com/u/802511?v=4",
        "events_url": "https://api.github.com/users/ddickstein/events{/privacy}",
        "followers_url": "https://api.github.com/users/ddickstein/followers",
        "following_url": "https://api.github.com/users/ddickstein/following{/other_user}",
        "gists_url": "https://api.github.com/users/ddickstein/gists{/gist_id}",
        "gravatar_id": "",
        "html_url": "https://github.com/ddickstein",
        "id": 802511,
        "login": "ddickstein",
        "node_id": "MDQ6VXNlcjgwMjUxMQ==",
        "organizations_url": "https://api.github.com/users/ddickstein/orgs",
        "received_events_url": "https://api.github.com/users/ddickstein/received_events",
        "repos_url": "https://api.github.com/users/ddickstein/repos",
        "site_admin": false,
        "starred_url": "https://api.github.com/users/ddickstein/starred{/owner}{/repo}",
        "subscriptions_url": "https://api.github.com/users/ddickstein/subscriptions",
        "type": "User",
        "url": "https://api.github.com/users/ddickstein",
        "user_view_type": "public"
    }
}