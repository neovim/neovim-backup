{
    "active_lock_reason": null,
    "assignee": null,
    "assignees": [],
    "author_association": "CONTRIBUTOR",
    "body": "### Problem\n\nAfter https://github.com/neovim/neovim/commit/098da1fc2c9ba65adb9c2f7ecb76b26f6e6b0383 floating windows with height 1, concealed lines and `concealcursor=\"\"` are wrongly highlighted prior to redraw. This applies to LSP windows since https://github.com/neovim/neovim/commit/4b8980949cd47f8206b2fbc266dfeb0920fd1191 and the issue was exposed by tests updated in https://github.com/neovim/neovim/commit/6638a58fdac7fdfa677a41e355b781616eb9dd29\n\nIt seems that it uses the ` ``` ` highlight color for the entire buffer.\n<img width=\"1297\" height=\"208\" alt=\"1763672531_screenshot\" src=\"https://github.com/user-attachments/assets/1dd13f09-9c3f-480c-91f0-5e4049a0772e\" />\n\n\n\n### Steps to reproduce\n\n`minimal.lua` which basically extracts the LSP test\n```lua\nlocal floating_bufnr = vim.api.nvim_create_buf(false, true)\n\nvim.api.nvim_buf_set_lines(floating_bufnr, 0, -1, false, { \"```lua\", \"local foo\", \"```\"})\n\nlocal floating_winnr = vim.api.nvim_open_win(floating_bufnr, false, {\n\trelative = \"win\",\n\trow = 3,\n\tcol = 3,\n\tstyle = \"minimal\",\n\tborder = \"single\",\n\twidth = 10,\n\theight = 1,\n})\n\nvim.wo[floating_winnr].conceallevel = 2\nvim.wo[floating_winnr].concealcursor = \"\"\nvim.bo[floating_bufnr].filetype = \"markdown\"\n\nvim.treesitter.start(floating_bufnr, \"markdown\")\n```\n\n```sh\nnvim --clean -u minimal.lua\n```\n\n### Expected behavior\n\nAfter `:redraw`\n\n<img width=\"1298\" height=\"202\" alt=\"1763672535_screenshot\" src=\"https://github.com/user-attachments/assets/d2ccbac0-1dc8-4c4a-8296-c67c35433139\" />\n\n### Nvim version (nvim -v)\n\nv0.12.0-dev-1667+gea70d2ad85\n\n### Vim (not Nvim) behaves the same?\n\n-\n\n### Operating system/version\n\nLinux arch 6.17.3-arch2-1\n\n### Terminal name/version\n\nalacritty 0.17.0-dev\n\n### $TERM environment variable\n\nalacritty\n\n### Installation\n\nBuild from source",
    "closed_at": "2025-12-15T00:01:51Z",
    "closed_by": {
        "avatar_url": "https://avatars.githubusercontent.com/u/1359421?v=4",
        "events_url": "https://api.github.com/users/justinmk/events{/privacy}",
        "followers_url": "https://api.github.com/users/justinmk/followers",
        "following_url": "https://api.github.com/users/justinmk/following{/other_user}",
        "gists_url": "https://api.github.com/users/justinmk/gists{/gist_id}",
        "gravatar_id": "",
        "html_url": "https://github.com/justinmk",
        "id": 1359421,
        "login": "justinmk",
        "node_id": "MDQ6VXNlcjEzNTk0MjE=",
        "organizations_url": "https://api.github.com/users/justinmk/orgs",
        "received_events_url": "https://api.github.com/users/justinmk/received_events",
        "repos_url": "https://api.github.com/users/justinmk/repos",
        "site_admin": false,
        "starred_url": "https://api.github.com/users/justinmk/starred{/owner}{/repo}",
        "subscriptions_url": "https://api.github.com/users/justinmk/subscriptions",
        "type": "User",
        "url": "https://api.github.com/users/justinmk",
        "user_view_type": "public"
    },
    "comment_data": [
        {
            "author_association": "CONTRIBUTOR",
            "body": "@ribru17 Restoring these lines removed in #36503 fixes the issue, but it triggers an unnecessary re-parse. Since `concealcursor` seems to influence this, the root cause might be deeper, possibly in the decoration provider and the ranges received by `on_start` vs `on_win`.\n```diff\ndiff --git a/runtime/lua/vim/treesitter/highlighter.lua b/runtime/lua/vim/treesitter/highlighter.lua\nindex 472b605e38..80e0662b9e 100644\n--- a/runtime/lua/vim/treesitter/highlighter.lua\n+++ b/runtime/lua/vim/treesitter/highlighter.lua\n@@ -540,6 +540,14 @@ function TSHighlighter._on_win(_, _, buf, topline, botline)\n   if not self then\n     return false\n   end\n+  self.parsing = self.parsing\n+    or nil\n+      == self.tree:parse({ topline, botline + 1 }, function(_, trees)\n+        if trees and self.parsing then\n+          self.parsing = false\n+          api.nvim__redraw({ buf = buf, valid = false, flush = false })\n+        end\n+      end)\n   if not self.parsing then\n     self.redraw_count = self.redraw_count + 1\n     self:prepare_highlight_states(topline, botline)\n```",
            "created_at": "2025-11-20T22:13:25Z",
            "html_url": "https://github.com/neovim/neovim/issues/36641#issuecomment-3560299481",
            "id": 3560299481,
            "issue_url": "https://api.github.com/repos/neovim/neovim/issues/36641",
            "node_id": "IC_kwDOAPphoM7UNdvZ",
            "performed_via_github_app": null,
            "reactions": {
                "+1": 0,
                "-1": 0,
                "confused": 0,
                "eyes": 0,
                "heart": 0,
                "hooray": 0,
                "laugh": 0,
                "rocket": 0,
                "total_count": 0,
                "url": "https://api.github.com/repos/neovim/neovim/issues/comments/3560299481/reactions"
            },
            "updated_at": "2025-11-20T22:13:25Z",
            "url": "https://api.github.com/repos/neovim/neovim/issues/comments/3560299481",
            "user": {
                "avatar_url": "https://avatars.githubusercontent.com/u/101928759?v=4",
                "events_url": "https://api.github.com/users/skewb1k/events{/privacy}",
                "followers_url": "https://api.github.com/users/skewb1k/followers",
                "following_url": "https://api.github.com/users/skewb1k/following{/other_user}",
                "gists_url": "https://api.github.com/users/skewb1k/gists{/gist_id}",
                "gravatar_id": "",
                "html_url": "https://github.com/skewb1k",
                "id": 101928759,
                "login": "skewb1k",
                "node_id": "U_kgDOBhNPNw",
                "organizations_url": "https://api.github.com/users/skewb1k/orgs",
                "received_events_url": "https://api.github.com/users/skewb1k/received_events",
                "repos_url": "https://api.github.com/users/skewb1k/repos",
                "site_admin": false,
                "starred_url": "https://api.github.com/users/skewb1k/starred{/owner}{/repo}",
                "subscriptions_url": "https://api.github.com/users/skewb1k/subscriptions",
                "type": "User",
                "url": "https://api.github.com/users/skewb1k",
                "user_view_type": "public"
            }
        },
        {
            "author_association": "MEMBER",
            "body": "> Restoring these lines removed in [#36503](https://github.com/neovim/neovim/pull/36503) fixes the issue, but it triggers an unnecessary re-parse\n\nDoesn't seem like a good tradeoff. Maybe it could check window height to avoid reparse for more common cases?",
            "created_at": "2025-11-20T22:55:32Z",
            "html_url": "https://github.com/neovim/neovim/issues/36641#issuecomment-3560486345",
            "id": 3560486345,
            "issue_url": "https://api.github.com/repos/neovim/neovim/issues/36641",
            "node_id": "IC_kwDOAPphoM7UOLXJ",
            "performed_via_github_app": null,
            "reactions": {
                "+1": 0,
                "-1": 0,
                "confused": 0,
                "eyes": 0,
                "heart": 0,
                "hooray": 0,
                "laugh": 0,
                "rocket": 0,
                "total_count": 0,
                "url": "https://api.github.com/repos/neovim/neovim/issues/comments/3560486345/reactions"
            },
            "updated_at": "2025-11-20T22:55:32Z",
            "url": "https://api.github.com/repos/neovim/neovim/issues/comments/3560486345",
            "user": {
                "avatar_url": "https://avatars.githubusercontent.com/u/1359421?v=4",
                "events_url": "https://api.github.com/users/justinmk/events{/privacy}",
                "followers_url": "https://api.github.com/users/justinmk/followers",
                "following_url": "https://api.github.com/users/justinmk/following{/other_user}",
                "gists_url": "https://api.github.com/users/justinmk/gists{/gist_id}",
                "gravatar_id": "",
                "html_url": "https://github.com/justinmk",
                "id": 1359421,
                "login": "justinmk",
                "node_id": "MDQ6VXNlcjEzNTk0MjE=",
                "organizations_url": "https://api.github.com/users/justinmk/orgs",
                "received_events_url": "https://api.github.com/users/justinmk/received_events",
                "repos_url": "https://api.github.com/users/justinmk/repos",
                "site_admin": false,
                "starred_url": "https://api.github.com/users/justinmk/starred{/owner}{/repo}",
                "subscriptions_url": "https://api.github.com/users/justinmk/subscriptions",
                "type": "User",
                "url": "https://api.github.com/users/justinmk",
                "user_view_type": "public"
            }
        },
        {
            "author_association": "CONTRIBUTOR",
            "body": "> Doesn't seem like a good tradeoff. Maybe it could check window height to avoid reparse for more common cases?\n\nI don't think that’s the right direction. It was mainly to show the context of what changed in #36503 and how it caused the issue, not to suggest a final fix (otherwise I'd open a PR).\n\nThe reason the reverted logic works is that during `on_start` the buffer's `botline` is 2 instead of 4. By the time `on_win` called, the buffer state is already valid and the range is correct.\n \nI’m currently stepping through this in the debugger. `on_start` is called with `botline = 2` here:\n\nhttps://github.com/neovim/neovim/blob/ea70d2ad8581fab6ea8cc264df5d01c799550e52/src/nvim/drawscreen.c#L588\n\nAnd later in the loop it's updated to 4:\n\nhttps://github.com/neovim/neovim/blob/ea70d2ad8581fab6ea8cc264df5d01c799550e52/src/nvim/drawscreen.c#L671\n\nNo idea yet where the initial 2 comes from, but it looks like a bug. I'll keep investigating.\n\nUPD: the initial 2 is inherited from the parent window in `nvim_open_win`",
            "created_at": "2025-11-20T23:12:25Z",
            "html_url": "https://github.com/neovim/neovim/issues/36641#issuecomment-3560563043",
            "id": 3560563043,
            "issue_url": "https://api.github.com/repos/neovim/neovim/issues/36641",
            "node_id": "IC_kwDOAPphoM7UOeFj",
            "performed_via_github_app": null,
            "reactions": {
                "+1": 2,
                "-1": 0,
                "confused": 0,
                "eyes": 0,
                "heart": 0,
                "hooray": 0,
                "laugh": 0,
                "rocket": 0,
                "total_count": 2,
                "url": "https://api.github.com/repos/neovim/neovim/issues/comments/3560563043/reactions"
            },
            "updated_at": "2025-11-20T23:59:02Z",
            "url": "https://api.github.com/repos/neovim/neovim/issues/comments/3560563043",
            "user": {
                "avatar_url": "https://avatars.githubusercontent.com/u/101928759?v=4",
                "events_url": "https://api.github.com/users/skewb1k/events{/privacy}",
                "followers_url": "https://api.github.com/users/skewb1k/followers",
                "following_url": "https://api.github.com/users/skewb1k/following{/other_user}",
                "gists_url": "https://api.github.com/users/skewb1k/gists{/gist_id}",
                "gravatar_id": "",
                "html_url": "https://github.com/skewb1k",
                "id": 101928759,
                "login": "skewb1k",
                "node_id": "U_kgDOBhNPNw",
                "organizations_url": "https://api.github.com/users/skewb1k/orgs",
                "received_events_url": "https://api.github.com/users/skewb1k/received_events",
                "repos_url": "https://api.github.com/users/skewb1k/repos",
                "site_admin": false,
                "starred_url": "https://api.github.com/users/skewb1k/starred{/owner}{/repo}",
                "subscriptions_url": "https://api.github.com/users/skewb1k/subscriptions",
                "type": "User",
                "url": "https://api.github.com/users/skewb1k",
                "user_view_type": "public"
            }
        }
    ],
    "comments": 3,
    "comments_url": "https://api.github.com/repos/neovim/neovim/issues/36641/comments",
    "created_at": "2025-11-20T22:06:25Z",
    "events_url": "https://api.github.com/repos/neovim/neovim/issues/36641/events",
    "html_url": "https://github.com/neovim/neovim/issues/36641",
    "id": 3649297138,
    "issue_dependencies_summary": {
        "blocked_by": 0,
        "blocking": 0,
        "total_blocked_by": 0,
        "total_blocking": 0
    },
    "labels": [
        {
            "color": "c5def5",
            "default": false,
            "description": null,
            "id": 662566370,
            "name": "lsp",
            "node_id": "MDU6TGFiZWw2NjI1NjYzNzA=",
            "url": "https://api.github.com/repos/neovim/neovim/labels/lsp"
        }
    ],
    "labels_url": "https://api.github.com/repos/neovim/neovim/issues/36641/labels{/name}",
    "locked": false,
    "milestone": null,
    "node_id": "I_kwDOAPphoM7Zg9ry",
    "number": 36641,
    "performed_via_github_app": null,
    "reactions": {
        "+1": 1,
        "-1": 0,
        "confused": 0,
        "eyes": 0,
        "heart": 0,
        "hooray": 0,
        "laugh": 0,
        "rocket": 0,
        "total_count": 1,
        "url": "https://api.github.com/repos/neovim/neovim/issues/36641/reactions"
    },
    "repository_url": "https://api.github.com/repos/neovim/neovim",
    "state": "closed",
    "state_reason": "completed",
    "sub_issues_summary": {
        "completed": 0,
        "percent_completed": 0,
        "total": 0
    },
    "timeline_url": "https://api.github.com/repos/neovim/neovim/issues/36641/timeline",
    "title": "LSP: incorrect highlights in floating wins of height 1",
    "type": {
        "color": "red",
        "created_at": "2024-01-25T10:10:19Z",
        "description": "An unexpected problem or behavior",
        "id": 597163,
        "is_enabled": true,
        "name": "Bug",
        "node_id": "IT_kwDOAGK_Pc4ACRyr",
        "updated_at": "2024-07-26T10:12:30Z"
    },
    "updated_at": "2025-12-15T00:01:51Z",
    "url": "https://api.github.com/repos/neovim/neovim/issues/36641",
    "user": {
        "avatar_url": "https://avatars.githubusercontent.com/u/101928759?v=4",
        "events_url": "https://api.github.com/users/skewb1k/events{/privacy}",
        "followers_url": "https://api.github.com/users/skewb1k/followers",
        "following_url": "https://api.github.com/users/skewb1k/following{/other_user}",
        "gists_url": "https://api.github.com/users/skewb1k/gists{/gist_id}",
        "gravatar_id": "",
        "html_url": "https://github.com/skewb1k",
        "id": 101928759,
        "login": "skewb1k",
        "node_id": "U_kgDOBhNPNw",
        "organizations_url": "https://api.github.com/users/skewb1k/orgs",
        "received_events_url": "https://api.github.com/users/skewb1k/received_events",
        "repos_url": "https://api.github.com/users/skewb1k/repos",
        "site_admin": false,
        "starred_url": "https://api.github.com/users/skewb1k/starred{/owner}{/repo}",
        "subscriptions_url": "https://api.github.com/users/skewb1k/subscriptions",
        "type": "User",
        "url": "https://api.github.com/users/skewb1k",
        "user_view_type": "public"
    }
}