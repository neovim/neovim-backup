{
    "active_lock_reason": null,
    "assignee": null,
    "assignees": [],
    "author_association": "CONTRIBUTOR",
    "body": "### Problem\n\nAfter opening a floating window using a hover plugin I'm working on, Neovim just crashes with what looks like an error message before the screen is cleared completely. After triggering the crash under LLDB, I get a \"malloc: Heap corruption detected, free list is damaged at 0x600001104ef0\" error.\n\nSometimes the floating window appears and then nvim crashes shortly afterwards, and sometimes it crashes basically immediately and the window doesn't show up at all.\n\n### Steps to reproduce\n\nI am able to trigger the crash consistently using my own config and plugins and everything, but I have no idea where to begin trying to figure out minimal reproduction steps.\n\nPossibly relevant context is that I just added support for using `man.lua` to show manpages in my plugin's hover window, the crashes are only happening when using that functionality.\n\nI have been able to bisect the first bad commit to bd413a2f55be7db4e4d9b821758580f59b5cc01e, ping @bfredl \n\nThe LLDB output is attached below, including a backtrace, for what it's worth. I'm happy to provide a core dump or sit through with whoever and debug, just let me know.\n\n[lldb.txt](https://github.com/user-attachments/files/20001758/lldb.txt)\n\n### Expected behavior\n\nNo crash :|\n\n### Nvim version (nvim -v)\n\nv0.12.0-dev-267+gd1fed989f2\n\n### Vim (not Nvim) behaves the same?\n\nNot sure how to test this, but probably not\n\n### Operating system/version\n\nmacOS 15.4.1\n\n### Terminal name/version\n\nAlacritty 0.15.1\n\n### $TERM environment variable\n\nalacritty\n\n### Installation\n\nBuild from repo (but also happens with my normal homebrew --HEAD install)",
    "closed_at": "2025-05-05T09:20:15Z",
    "closed_by": {
        "avatar_url": "https://avatars.githubusercontent.com/u/1363104?v=4",
        "events_url": "https://api.github.com/users/bfredl/events{/privacy}",
        "followers_url": "https://api.github.com/users/bfredl/followers",
        "following_url": "https://api.github.com/users/bfredl/following{/other_user}",
        "gists_url": "https://api.github.com/users/bfredl/gists{/gist_id}",
        "gravatar_id": "",
        "html_url": "https://github.com/bfredl",
        "id": 1363104,
        "login": "bfredl",
        "node_id": "MDQ6VXNlcjEzNjMxMDQ=",
        "organizations_url": "https://api.github.com/users/bfredl/orgs",
        "received_events_url": "https://api.github.com/users/bfredl/received_events",
        "repos_url": "https://api.github.com/users/bfredl/repos",
        "site_admin": false,
        "starred_url": "https://api.github.com/users/bfredl/starred{/owner}{/repo}",
        "subscriptions_url": "https://api.github.com/users/bfredl/subscriptions",
        "type": "User",
        "url": "https://api.github.com/users/bfredl",
        "user_view_type": "public"
    },
    "comment_data": [
        {
            "author_association": "CONTRIBUTOR",
            "body": "Just tried again and got a different error from lldb:\n```\nProcess 46298 stopped\n* thread #1, queue = 'com.apple.main-thread', stop reason = EXC_BAD_ACCESS (code=1, address=0x6004039dd6ac)\n    frame #0: 0x000000010019f694 nvim`grid_clear_line(grid=0x000000014c056808, off=4294967295, width=1, valid=false) at grid.c:316:36\n   313 \tvoid grid_clear_line(ScreenGrid *grid, size_t off, int width, bool valid)\n   314 \t{\n   315 \t  for (int col = 0; col < width; col++) {\n-> 316 \t    grid->chars[off + (size_t)col] = schar_from_ascii(' ');\n    \t                                   ^\n   317 \t  }\n   318 \t  int fill = valid ? 0 : -1;\n   319 \t  memset(grid->attrs + off, fill, (size_t)width * sizeof(sattr_T));\n(lldb) bt\n* thread #1, queue = 'com.apple.main-thread', stop reason = EXC_BAD_ACCESS (code=1, address=0x6004039dd6ac)\n  * frame #0: 0x000000010019f694 nvim`grid_clear_line(grid=0x000000014c056808, off=4294967295, width=1, valid=false) at grid.c:316:36\n    frame #1: 0x00000001001a2298 nvim`grid_del_lines(grid=0x000000014c056808, row=0, line_count=6, end=21, col=0, width=1) at grid.c:1072:7\n    frame #2: 0x00000001000be480 nvim`win_scroll_lines(wp=0x000000014c054000, row=0, line_count=-6) at drawscreen.c:2563:5\n    frame #3: 0x0000000100265254 nvim`curs_columns(wp=0x000000014c054000, may_scroll=0) at move.c:1010:7\n    frame #4: 0x000000010042c5c4 nvim`scroll_to_fraction(wp=0x000000014c054000, prev_height=1) at window.c:6628:5\n    frame #5: 0x000000010042ca94 nvim`win_set_inner_size(wp=0x000000014c054000, valid_cursor=true) at window.c:6672:7\n    frame #6: 0x000000010042fc4c nvim`win_config_float(wp=0x000000014c054000, fconfig=WinConfig @ 0x000000016fdfc0f8) at winfloat.c:228:3\n    frame #7: 0x0000000100053074 nvim`nvim_win_set_config(window=1003, config=0x000000016fdfc8c0, err=0x000000016fdfca00) at win_config.c:630:5\n    frame #8: 0x00000001001ec674 nvim`nlua_api_nvim_win_set_config(lstate=0x00000001034b0380) at lua_api_c_bindings.generated.h:7683:3\n    frame #9: 0x00000001004a828c nvim`lj_BC_FUNCC + 44\n    frame #10: 0x00000001004bea10 nvim`lua_pcall(L=<unavailable>, nargs=<unavailable>, nresults=<unavailable>, errfunc=<unavailable>) at lj_api.c:1151:12 [opt]\n    frame #11: 0x00000001001f70c4 nvim`nlua_pcall(lstate=0x00000001034b0380, nargs=0, nresults=1) at executor.c:180:16\n    frame #12: 0x00000001001f9444 nvim`nlua_call_ref_ctx(fast=false, ref=374, name=0x0000000000000000, args=Array @ 0x000000016fdfcc40, mode=kRetLuaref, arena=0x0000000000000000, err=0x000000016fdfde00) at executor.c:1596:14\n    frame #13: 0x00000001001f92d4 nvim`nlua_call_ref(ref=374, name=0x0000000000000000, args=Array @ 0x000000016fdfcca0, mode=kRetLuaref, arena=0x0000000000000000, err=0x000000016fdfde00) at executor.c:1573:10\n    frame #14: 0x0000000100055a40 nvim`nvim_win_call(window=1003, fun=374, err=0x000000016fdfde00) at window.c:425:3\n    frame #15: 0x00000001001eedf8 nvim`nlua_api_nvim_win_call(lstate=0x00000001034b0380) at lua_api_c_bindings.generated.h:8555:16\n    frame #16: 0x00000001004a828c nvim`lj_BC_FUNCC + 44\n    frame #17: 0x00000001004bea10 nvim`lua_pcall(L=<unavailable>, nargs=<unavailable>, nresults=<unavailable>, errfunc=<unavailable>) at lj_api.c:1151:12 [opt]\n    frame #18: 0x00000001001f70c4 nvim`nlua_pcall(lstate=0x00000001034b0380, nargs=0, nresults=0) at executor.c:180:16\n    frame #19: 0x00000001001fca00 nvim`nlua_schedule_event(argv=0x000000016fdfdf98) at executor.c:379:7\n    frame #20: 0x000000010037b694 nvim`state_handle_k_event at state.c:120:7\n    frame #21: 0x000000010027ee5c nvim`nv_event(cap=0x000000016fdfe120) at normal.c:6645:3\n    frame #22: 0x000000010027707c nvim`normal_execute(state=0x000000016fdfe0b0, key=-26365) at normal.c:1244:3\n    frame #23: 0x000000010037b608 nvim`state_enter(s=0x000000016fdfe0b0) at state.c:102:26\n    frame #24: 0x0000000100271ed8 nvim`normal_enter(cmdwin=false, noexmode=false) at normal.c:523:3\n    frame #25: 0x0000000100207d88 nvim`main(argc=4, argv=0x000000016fdfeac0) at main.c:654:3\n    frame #26: 0x0000000189e2ab4c dyld`start + 6000\n(lldb)\n```",
            "created_at": "2025-05-01T16:12:46Z",
            "html_url": "https://github.com/neovim/neovim/issues/33749#issuecomment-2845162870",
            "id": 2845162870,
            "issue_url": "https://api.github.com/repos/neovim/neovim/issues/33749",
            "node_id": "IC_kwDOAPphoM6plb12",
            "performed_via_github_app": null,
            "reactions": {
                "+1": 0,
                "-1": 0,
                "confused": 0,
                "eyes": 0,
                "heart": 0,
                "hooray": 0,
                "laugh": 0,
                "rocket": 0,
                "total_count": 0,
                "url": "https://api.github.com/repos/neovim/neovim/issues/comments/2845162870/reactions"
            },
            "updated_at": "2025-05-01T16:12:46Z",
            "url": "https://api.github.com/repos/neovim/neovim/issues/comments/2845162870",
            "user": {
                "avatar_url": "https://avatars.githubusercontent.com/u/49614525?v=4",
                "events_url": "https://api.github.com/users/AThePeanut4/events{/privacy}",
                "followers_url": "https://api.github.com/users/AThePeanut4/followers",
                "following_url": "https://api.github.com/users/AThePeanut4/following{/other_user}",
                "gists_url": "https://api.github.com/users/AThePeanut4/gists{/gist_id}",
                "gravatar_id": "",
                "html_url": "https://github.com/AThePeanut4",
                "id": 49614525,
                "login": "AThePeanut4",
                "node_id": "MDQ6VXNlcjQ5NjE0NTI1",
                "organizations_url": "https://api.github.com/users/AThePeanut4/orgs",
                "received_events_url": "https://api.github.com/users/AThePeanut4/received_events",
                "repos_url": "https://api.github.com/users/AThePeanut4/repos",
                "site_admin": false,
                "starred_url": "https://api.github.com/users/AThePeanut4/starred{/owner}{/repo}",
                "subscriptions_url": "https://api.github.com/users/AThePeanut4/subscriptions",
                "type": "User",
                "url": "https://api.github.com/users/AThePeanut4",
                "user_view_type": "public"
            }
        },
        {
            "author_association": "MEMBER",
            "body": "@AThePeanut4 if you'd like you can try this attempt at a fix https://github.com/neovim/neovim/pull/33753",
            "created_at": "2025-05-01T19:12:35Z",
            "html_url": "https://github.com/neovim/neovim/issues/33749#issuecomment-2845538947",
            "id": 2845538947,
            "issue_url": "https://api.github.com/repos/neovim/neovim/issues/33749",
            "node_id": "IC_kwDOAPphoM6pm3qD",
            "performed_via_github_app": null,
            "reactions": {
                "+1": 0,
                "-1": 0,
                "confused": 0,
                "eyes": 0,
                "heart": 0,
                "hooray": 0,
                "laugh": 0,
                "rocket": 0,
                "total_count": 0,
                "url": "https://api.github.com/repos/neovim/neovim/issues/comments/2845538947/reactions"
            },
            "updated_at": "2025-05-01T19:12:35Z",
            "url": "https://api.github.com/repos/neovim/neovim/issues/comments/2845538947",
            "user": {
                "avatar_url": "https://avatars.githubusercontent.com/u/1363104?v=4",
                "events_url": "https://api.github.com/users/bfredl/events{/privacy}",
                "followers_url": "https://api.github.com/users/bfredl/followers",
                "following_url": "https://api.github.com/users/bfredl/following{/other_user}",
                "gists_url": "https://api.github.com/users/bfredl/gists{/gist_id}",
                "gravatar_id": "",
                "html_url": "https://github.com/bfredl",
                "id": 1363104,
                "login": "bfredl",
                "node_id": "MDQ6VXNlcjEzNjMxMDQ=",
                "organizations_url": "https://api.github.com/users/bfredl/orgs",
                "received_events_url": "https://api.github.com/users/bfredl/received_events",
                "repos_url": "https://api.github.com/users/bfredl/repos",
                "site_admin": false,
                "starred_url": "https://api.github.com/users/bfredl/starred{/owner}{/repo}",
                "subscriptions_url": "https://api.github.com/users/bfredl/subscriptions",
                "type": "User",
                "url": "https://api.github.com/users/bfredl",
                "user_view_type": "public"
            }
        },
        {
            "author_association": "CONTRIBUTOR",
            "body": "> [@AThePeanut4](https://github.com/AThePeanut4) if you'd like you can try this attempt at a fix [#33753](https://github.com/neovim/neovim/pull/33753)\n\n@bfredl Just tried it, unfortunately still crashing with the same EXC_BAD_ACCESS error :( ",
            "created_at": "2025-05-01T19:21:59Z",
            "html_url": "https://github.com/neovim/neovim/issues/33749#issuecomment-2845564126",
            "id": 2845564126,
            "issue_url": "https://api.github.com/repos/neovim/neovim/issues/33749",
            "node_id": "IC_kwDOAPphoM6pm9ze",
            "performed_via_github_app": null,
            "reactions": {
                "+1": 0,
                "-1": 0,
                "confused": 0,
                "eyes": 0,
                "heart": 0,
                "hooray": 0,
                "laugh": 0,
                "rocket": 0,
                "total_count": 0,
                "url": "https://api.github.com/repos/neovim/neovim/issues/comments/2845564126/reactions"
            },
            "updated_at": "2025-05-01T19:23:22Z",
            "url": "https://api.github.com/repos/neovim/neovim/issues/comments/2845564126",
            "user": {
                "avatar_url": "https://avatars.githubusercontent.com/u/49614525?v=4",
                "events_url": "https://api.github.com/users/AThePeanut4/events{/privacy}",
                "followers_url": "https://api.github.com/users/AThePeanut4/followers",
                "following_url": "https://api.github.com/users/AThePeanut4/following{/other_user}",
                "gists_url": "https://api.github.com/users/AThePeanut4/gists{/gist_id}",
                "gravatar_id": "",
                "html_url": "https://github.com/AThePeanut4",
                "id": 49614525,
                "login": "AThePeanut4",
                "node_id": "MDQ6VXNlcjQ5NjE0NTI1",
                "organizations_url": "https://api.github.com/users/AThePeanut4/orgs",
                "received_events_url": "https://api.github.com/users/AThePeanut4/received_events",
                "repos_url": "https://api.github.com/users/AThePeanut4/repos",
                "site_admin": false,
                "starred_url": "https://api.github.com/users/AThePeanut4/starred{/owner}{/repo}",
                "subscriptions_url": "https://api.github.com/users/AThePeanut4/subscriptions",
                "type": "User",
                "url": "https://api.github.com/users/AThePeanut4",
                "user_view_type": "public"
            }
        }
    ],
    "comments": 3,
    "comments_url": "https://api.github.com/repos/neovim/neovim/issues/33749/comments",
    "created_at": "2025-05-01T16:06:34Z",
    "events_url": "https://api.github.com/repos/neovim/neovim/issues/33749/events",
    "html_url": "https://github.com/neovim/neovim/issues/33749",
    "id": 3034178348,
    "labels": [
        {
            "color": "f9d0c4",
            "default": false,
            "description": "wrong behavior that was introduced in a previous commit (please bisect)",
            "id": 619474658,
            "name": "bug-regression",
            "node_id": "MDU6TGFiZWw2MTk0NzQ2NTg=",
            "url": "https://api.github.com/repos/neovim/neovim/labels/bug-regression"
        },
        {
            "color": "0E8A16",
            "default": false,
            "description": "issue has been tracked to a specific commit",
            "id": 1481421490,
            "name": "has:bisected",
            "node_id": "MDU6TGFiZWwxNDgxNDIxNDkw",
            "url": "https://api.github.com/repos/neovim/neovim/labels/has:bisected"
        }
    ],
    "labels_url": "https://api.github.com/repos/neovim/neovim/issues/33749/labels{/name}",
    "locked": false,
    "milestone": null,
    "node_id": "I_kwDOAPphoM602eMs",
    "number": 33749,
    "performed_via_github_app": null,
    "reactions": {
        "+1": 0,
        "-1": 0,
        "confused": 0,
        "eyes": 0,
        "heart": 0,
        "hooray": 0,
        "laugh": 0,
        "rocket": 0,
        "total_count": 0,
        "url": "https://api.github.com/repos/neovim/neovim/issues/33749/reactions"
    },
    "repository_url": "https://api.github.com/repos/neovim/neovim",
    "state": "closed",
    "state_reason": "completed",
    "sub_issues_summary": {
        "completed": 0,
        "percent_completed": 0,
        "total": 0
    },
    "timeline_url": "https://api.github.com/repos/neovim/neovim/issues/33749/timeline",
    "title": "Heap corruption crash (scrolling invalid grid)",
    "type": {
        "color": "red",
        "created_at": "2024-01-25T10:10:19Z",
        "description": "An unexpected problem or behavior",
        "id": 597163,
        "is_enabled": true,
        "name": "Bug",
        "node_id": "IT_kwDOAGK_Pc4ACRyr",
        "updated_at": "2024-07-26T10:12:30Z"
    },
    "updated_at": "2025-05-05T09:20:15Z",
    "url": "https://api.github.com/repos/neovim/neovim/issues/33749",
    "user": {
        "avatar_url": "https://avatars.githubusercontent.com/u/49614525?v=4",
        "events_url": "https://api.github.com/users/AThePeanut4/events{/privacy}",
        "followers_url": "https://api.github.com/users/AThePeanut4/followers",
        "following_url": "https://api.github.com/users/AThePeanut4/following{/other_user}",
        "gists_url": "https://api.github.com/users/AThePeanut4/gists{/gist_id}",
        "gravatar_id": "",
        "html_url": "https://github.com/AThePeanut4",
        "id": 49614525,
        "login": "AThePeanut4",
        "node_id": "MDQ6VXNlcjQ5NjE0NTI1",
        "organizations_url": "https://api.github.com/users/AThePeanut4/orgs",
        "received_events_url": "https://api.github.com/users/AThePeanut4/received_events",
        "repos_url": "https://api.github.com/users/AThePeanut4/repos",
        "site_admin": false,
        "starred_url": "https://api.github.com/users/AThePeanut4/starred{/owner}{/repo}",
        "subscriptions_url": "https://api.github.com/users/AThePeanut4/subscriptions",
        "type": "User",
        "url": "https://api.github.com/users/AThePeanut4",
        "user_view_type": "public"
    }
}