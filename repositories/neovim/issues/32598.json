{
    "active_lock_reason": null,
    "assignee": null,
    "assignees": [],
    "author_association": "CONTRIBUTOR",
    "body": "### Problem\n\nWhen setting an option in Lua, no matter in script file or in cmdline, `last_set_SID` is always `-8`. This affect the result of function `is_empty_or_default` https://github.com/neovim/neovim/blob/6bc79790449f8bbf238b740bf6eb33cea88e4295/runtime/lua/vim/lsp.lua#L655. Discovered in https://github.com/neovim/neovim/pull/32491\n\n### Steps to reproduce\n\nAs context, `'commentstring'` is last set in [runtime/ftplugin/c.lua](https://github.com/neovim/neovim/blob/f398e3a61abbf802b49867d2f533be1b0725c0d7/runtime/ftplugin/c.lua), while `'omnifunc'` is only set once in [runtime/ftplugin/c.vim](https://github.com/neovim/neovim/blob/f398e3a61abbf802b49867d2f533be1b0725c0d7/runtime/ftplugin/c.vim)\n\n1. Add the following to `repro.lua`\n```lua\n---@see https://github.com/neovim/neovim/blob/6bc79790449f8bbf238b740bf6eb33cea88e4295/runtime/lua/vim/lsp.lua#L655\nfunction IsEmptyOrDefault(bufnr, option)\n\tif vim.bo[bufnr][option] == '' then\n\t\treturn true\n\tend\n\n\tlocal info = vim.api.nvim_get_option_info2(option, { buf = bufnr })\n\t---@param e vim.fn.getscriptinfo.ret\n\tlocal scriptinfo = vim.tbl_filter(function(e)\n\t\treturn e.sid == info.last_set_sid\n\tend, vim.fn.getscriptinfo())\n\n\tif #scriptinfo ~= 1 then\n\t\treturn false\n\tend\n\n\treturn vim.startswith(scriptinfo[1].name, vim.fn.expand('$VIMRUNTIME'))\nend\n```\n2.  `$ nvim test.c --clean -u repro.lua`\n3. `:=IsEmptyOrDefault(0, 'omnifunc')  \" return true`\n4. `:=IsEmptyOrDefault(0, 'commentstring') \" return false`\nSo `'commentstring'` is not default even in clean mode?\n5. `:=vim.api.nvim_get_option_info2('omnifunc', { buf = 0 }).last_set_sid  \" return 23`\n6. `:=vim.api.nvim_get_option_info2('commentstring', {buf = 0}).last_set_sid  \" return -8`\nThis is really strange because Nvim is run in clean mode. Also is negative SID possible?\n7. To be more sure, I run `:scriptnames` and realize that the file `$VIMRUNTIME/ftplugin/c.lua` has SID 24 (which seems normal, as it is loaded right after `$VIMRUNTIME/ftplugin/c.vim`). So why is result of step 6 above a negative number?\n\n8.\n```vim\n:setl commentstring=foo%s\n:=vim.api.nvim_get_option_info2('commentstring', {buf = 0}).last_set_sid  \" return 0\n:lua vim.cmd('setl commentstring=bar%s')\n:=vim.api.nvim_get_option_info2('commentstring', {buf = 0}).last_set_sid  \" return -8\n```\n\nSo whenever I set option in Lua, no matter if in a script file or in cmdline, no matter if I use Nvim API directly or calling Vimscript from Lua, `last_set_sid` is always -8.\n\n### Expected behavior\n\n- Step 4 should returns true \n- Step 6 should returns 24\n\n### Nvim version (nvim -v)\n\nNVIM v0.11.0-dev-1819+g1c81734871\n\n### Vim (not Nvim) behaves the same?\n\nNot relevant, https://neovim.io/doc/user/vim_diff.html#if_lua\n\n### Operating system/version\n\nKubuntu 24.04\n\n### Terminal name/version\n\n23.08\n\n### $TERM environment variable\n\nxterm-256colors\n\n### Installation\n\nSnap",
    "closed_at": null,
    "closed_by": null,
    "comment_data": [
        {
            "author_association": "MEMBER",
            "body": "Lua scripts may have no SID if they are loaded by `:luafile` or `:lua require()`, so the expected `last_set_sid` for Lua scripts isn't always clear here.",
            "created_at": "2025-02-24T01:53:07Z",
            "html_url": "https://github.com/neovim/neovim/issues/32598#issuecomment-2677284724",
            "id": 2677284724,
            "issue_url": "https://api.github.com/repos/neovim/neovim/issues/32598",
            "node_id": "IC_kwDOAPphoM6flB90",
            "performed_via_github_app": null,
            "reactions": {
                "+1": 0,
                "-1": 0,
                "confused": 0,
                "eyes": 0,
                "heart": 0,
                "hooray": 0,
                "laugh": 0,
                "rocket": 0,
                "total_count": 0,
                "url": "https://api.github.com/repos/neovim/neovim/issues/comments/2677284724/reactions"
            },
            "updated_at": "2025-02-24T01:55:25Z",
            "url": "https://api.github.com/repos/neovim/neovim/issues/comments/2677284724",
            "user": {
                "avatar_url": "https://avatars.githubusercontent.com/u/35768171?v=4",
                "events_url": "https://api.github.com/users/zeertzjq/events{/privacy}",
                "followers_url": "https://api.github.com/users/zeertzjq/followers",
                "following_url": "https://api.github.com/users/zeertzjq/following{/other_user}",
                "gists_url": "https://api.github.com/users/zeertzjq/gists{/gist_id}",
                "gravatar_id": "",
                "html_url": "https://github.com/zeertzjq",
                "id": 35768171,
                "login": "zeertzjq",
                "node_id": "MDQ6VXNlcjM1NzY4MTcx",
                "organizations_url": "https://api.github.com/users/zeertzjq/orgs",
                "received_events_url": "https://api.github.com/users/zeertzjq/received_events",
                "repos_url": "https://api.github.com/users/zeertzjq/repos",
                "site_admin": false,
                "starred_url": "https://api.github.com/users/zeertzjq/starred{/owner}{/repo}",
                "subscriptions_url": "https://api.github.com/users/zeertzjq/subscriptions",
                "type": "User",
                "url": "https://api.github.com/users/zeertzjq",
                "user_view_type": "public"
            }
        },
        {
            "author_association": "CONTRIBUTOR",
            "body": "> Lua scripts may have no SID if they are loaded by :luafile, so the expected last_set_sid for Lua scripts isn't always clear here.\n\nThe file `c.lua` in $VIMRUNTIME that is used in the repro is shown in `:scriptnames` as well as `getscriptinfo()` with SID of 24.",
            "created_at": "2025-02-24T02:01:58Z",
            "html_url": "https://github.com/neovim/neovim/issues/32598#issuecomment-2677292017",
            "id": 2677292017,
            "issue_url": "https://api.github.com/repos/neovim/neovim/issues/32598",
            "node_id": "IC_kwDOAPphoM6flDvx",
            "performed_via_github_app": null,
            "reactions": {
                "+1": 0,
                "-1": 0,
                "confused": 0,
                "eyes": 0,
                "heart": 0,
                "hooray": 0,
                "laugh": 0,
                "rocket": 0,
                "total_count": 0,
                "url": "https://api.github.com/repos/neovim/neovim/issues/comments/2677292017/reactions"
            },
            "updated_at": "2025-02-24T02:03:35Z",
            "url": "https://api.github.com/repos/neovim/neovim/issues/comments/2677292017",
            "user": {
                "avatar_url": "https://avatars.githubusercontent.com/u/111893501?v=4",
                "events_url": "https://api.github.com/users/brianhuster/events{/privacy}",
                "followers_url": "https://api.github.com/users/brianhuster/followers",
                "following_url": "https://api.github.com/users/brianhuster/following{/other_user}",
                "gists_url": "https://api.github.com/users/brianhuster/gists{/gist_id}",
                "gravatar_id": "",
                "html_url": "https://github.com/brianhuster",
                "id": 111893501,
                "login": "brianhuster",
                "node_id": "U_kgDOBqtb_Q",
                "organizations_url": "https://api.github.com/users/brianhuster/orgs",
                "received_events_url": "https://api.github.com/users/brianhuster/received_events",
                "repos_url": "https://api.github.com/users/brianhuster/repos",
                "site_admin": false,
                "starred_url": "https://api.github.com/users/brianhuster/starred{/owner}{/repo}",
                "subscriptions_url": "https://api.github.com/users/brianhuster/subscriptions",
                "type": "User",
                "url": "https://api.github.com/users/brianhuster",
                "user_view_type": "public"
            }
        },
        {
            "author_association": "MEMBER",
            "body": "Yes, but you can set an option in any Lua script.",
            "created_at": "2025-02-24T02:03:35Z",
            "html_url": "https://github.com/neovim/neovim/issues/32598#issuecomment-2677293912",
            "id": 2677293912,
            "issue_url": "https://api.github.com/repos/neovim/neovim/issues/32598",
            "node_id": "IC_kwDOAPphoM6flENY",
            "performed_via_github_app": null,
            "reactions": {
                "+1": 0,
                "-1": 0,
                "confused": 0,
                "eyes": 0,
                "heart": 0,
                "hooray": 0,
                "laugh": 0,
                "rocket": 0,
                "total_count": 0,
                "url": "https://api.github.com/repos/neovim/neovim/issues/comments/2677293912/reactions"
            },
            "updated_at": "2025-02-24T02:06:19Z",
            "url": "https://api.github.com/repos/neovim/neovim/issues/comments/2677293912",
            "user": {
                "avatar_url": "https://avatars.githubusercontent.com/u/35768171?v=4",
                "events_url": "https://api.github.com/users/zeertzjq/events{/privacy}",
                "followers_url": "https://api.github.com/users/zeertzjq/followers",
                "following_url": "https://api.github.com/users/zeertzjq/following{/other_user}",
                "gists_url": "https://api.github.com/users/zeertzjq/gists{/gist_id}",
                "gravatar_id": "",
                "html_url": "https://github.com/zeertzjq",
                "id": 35768171,
                "login": "zeertzjq",
                "node_id": "MDQ6VXNlcjM1NzY4MTcx",
                "organizations_url": "https://api.github.com/users/zeertzjq/orgs",
                "received_events_url": "https://api.github.com/users/zeertzjq/received_events",
                "repos_url": "https://api.github.com/users/zeertzjq/repos",
                "site_admin": false,
                "starred_url": "https://api.github.com/users/zeertzjq/starred{/owner}{/repo}",
                "subscriptions_url": "https://api.github.com/users/zeertzjq/subscriptions",
                "type": "User",
                "url": "https://api.github.com/users/zeertzjq",
                "user_view_type": "public"
            }
        },
        {
            "author_association": "CONTRIBUTOR",
            "body": "No, in repro steps, I never set options in any Lua scripts myself. It was only in step 8 that I tried setting it in cmdline (and of course, still not a script)",
            "created_at": "2025-02-24T02:05:53Z",
            "html_url": "https://github.com/neovim/neovim/issues/32598#issuecomment-2677296140",
            "id": 2677296140,
            "issue_url": "https://api.github.com/repos/neovim/neovim/issues/32598",
            "node_id": "IC_kwDOAPphoM6flEwM",
            "performed_via_github_app": null,
            "reactions": {
                "+1": 0,
                "-1": 0,
                "confused": 0,
                "eyes": 0,
                "heart": 0,
                "hooray": 0,
                "laugh": 0,
                "rocket": 0,
                "total_count": 0,
                "url": "https://api.github.com/repos/neovim/neovim/issues/comments/2677296140/reactions"
            },
            "updated_at": "2025-02-24T02:26:26Z",
            "url": "https://api.github.com/repos/neovim/neovim/issues/comments/2677296140",
            "user": {
                "avatar_url": "https://avatars.githubusercontent.com/u/111893501?v=4",
                "events_url": "https://api.github.com/users/brianhuster/events{/privacy}",
                "followers_url": "https://api.github.com/users/brianhuster/followers",
                "following_url": "https://api.github.com/users/brianhuster/following{/other_user}",
                "gists_url": "https://api.github.com/users/brianhuster/gists{/gist_id}",
                "gravatar_id": "",
                "html_url": "https://github.com/brianhuster",
                "id": 111893501,
                "login": "brianhuster",
                "node_id": "U_kgDOBqtb_Q",
                "organizations_url": "https://api.github.com/users/brianhuster/orgs",
                "received_events_url": "https://api.github.com/users/brianhuster/received_events",
                "repos_url": "https://api.github.com/users/brianhuster/repos",
                "site_admin": false,
                "starred_url": "https://api.github.com/users/brianhuster/starred{/owner}{/repo}",
                "subscriptions_url": "https://api.github.com/users/brianhuster/subscriptions",
                "type": "User",
                "url": "https://api.github.com/users/brianhuster",
                "user_view_type": "public"
            }
        },
        {
            "author_association": "MEMBER",
            "body": "Wait, this works if you run Nvim with `-V1`, so the behavior should at least be consistent with and without `-V1`.",
            "created_at": "2025-02-24T02:18:11Z",
            "html_url": "https://github.com/neovim/neovim/issues/32598#issuecomment-2677304956",
            "id": 2677304956,
            "issue_url": "https://api.github.com/repos/neovim/neovim/issues/32598",
            "node_id": "IC_kwDOAPphoM6flG58",
            "performed_via_github_app": null,
            "reactions": {
                "+1": 0,
                "-1": 0,
                "confused": 0,
                "eyes": 0,
                "heart": 1,
                "hooray": 0,
                "laugh": 0,
                "rocket": 0,
                "total_count": 1,
                "url": "https://api.github.com/repos/neovim/neovim/issues/comments/2677304956/reactions"
            },
            "updated_at": "2025-02-24T02:18:45Z",
            "url": "https://api.github.com/repos/neovim/neovim/issues/comments/2677304956",
            "user": {
                "avatar_url": "https://avatars.githubusercontent.com/u/35768171?v=4",
                "events_url": "https://api.github.com/users/zeertzjq/events{/privacy}",
                "followers_url": "https://api.github.com/users/zeertzjq/followers",
                "following_url": "https://api.github.com/users/zeertzjq/following{/other_user}",
                "gists_url": "https://api.github.com/users/zeertzjq/gists{/gist_id}",
                "gravatar_id": "",
                "html_url": "https://github.com/zeertzjq",
                "id": 35768171,
                "login": "zeertzjq",
                "node_id": "MDQ6VXNlcjM1NzY4MTcx",
                "organizations_url": "https://api.github.com/users/zeertzjq/orgs",
                "received_events_url": "https://api.github.com/users/zeertzjq/received_events",
                "repos_url": "https://api.github.com/users/zeertzjq/repos",
                "site_admin": false,
                "starred_url": "https://api.github.com/users/zeertzjq/starred{/owner}{/repo}",
                "subscriptions_url": "https://api.github.com/users/zeertzjq/subscriptions",
                "type": "User",
                "url": "https://api.github.com/users/zeertzjq",
                "user_view_type": "public"
            }
        },
        {
            "author_association": "MEMBER",
            "body": "Actually there is a problem with calling several APIs in Vimscript as well:\n```vim\ncall nvim_set_option_value('commentstring', '// %s', {})\nverbose set commentstring?\n```\nprints\n```\n  commentstring=// %s\n        Last set from API client (channel id 9223372036854775808) line 1\n```\nAnd this also applies to `nvim_create_autocmd`, `nvim_create_user_command` etc..",
            "created_at": "2025-02-24T04:48:31Z",
            "html_url": "https://github.com/neovim/neovim/issues/32598#issuecomment-2677430314",
            "id": 2677430314,
            "issue_url": "https://api.github.com/repos/neovim/neovim/issues/32598",
            "node_id": "IC_kwDOAPphoM6fllgq",
            "performed_via_github_app": null,
            "reactions": {
                "+1": 1,
                "-1": 0,
                "confused": 0,
                "eyes": 0,
                "heart": 0,
                "hooray": 0,
                "laugh": 0,
                "rocket": 0,
                "total_count": 1,
                "url": "https://api.github.com/repos/neovim/neovim/issues/comments/2677430314/reactions"
            },
            "updated_at": "2025-02-25T01:22:34Z",
            "url": "https://api.github.com/repos/neovim/neovim/issues/comments/2677430314",
            "user": {
                "avatar_url": "https://avatars.githubusercontent.com/u/35768171?v=4",
                "events_url": "https://api.github.com/users/zeertzjq/events{/privacy}",
                "followers_url": "https://api.github.com/users/zeertzjq/followers",
                "following_url": "https://api.github.com/users/zeertzjq/following{/other_user}",
                "gists_url": "https://api.github.com/users/zeertzjq/gists{/gist_id}",
                "gravatar_id": "",
                "html_url": "https://github.com/zeertzjq",
                "id": 35768171,
                "login": "zeertzjq",
                "node_id": "MDQ6VXNlcjM1NzY4MTcx",
                "organizations_url": "https://api.github.com/users/zeertzjq/orgs",
                "received_events_url": "https://api.github.com/users/zeertzjq/received_events",
                "repos_url": "https://api.github.com/users/zeertzjq/repos",
                "site_admin": false,
                "starred_url": "https://api.github.com/users/zeertzjq/starred{/owner}{/repo}",
                "subscriptions_url": "https://api.github.com/users/zeertzjq/subscriptions",
                "type": "User",
                "url": "https://api.github.com/users/zeertzjq",
                "user_view_type": "public"
            }
        }
    ],
    "comments": 6,
    "comments_url": "https://api.github.com/repos/neovim/neovim/issues/32598/comments",
    "created_at": "2025-02-23T17:55:39Z",
    "events_url": "https://api.github.com/repos/neovim/neovim/issues/32598/events",
    "html_url": "https://github.com/neovim/neovim/issues/32598",
    "id": 2873359316,
    "labels": [
        {
            "color": "c5def5",
            "default": false,
            "description": "libnvim, Nvim RPC API",
            "id": 103819671,
            "name": "api",
            "node_id": "MDU6TGFiZWwxMDM4MTk2NzE=",
            "url": "https://api.github.com/repos/neovim/neovim/labels/api"
        },
        {
            "color": "c5def5",
            "default": false,
            "description": "stdlib",
            "id": 573222693,
            "name": "lua",
            "node_id": "MDU6TGFiZWw1NzMyMjI2OTM=",
            "url": "https://api.github.com/repos/neovim/neovim/labels/lua"
        }
    ],
    "labels_url": "https://api.github.com/repos/neovim/neovim/issues/32598/labels{/name}",
    "locked": false,
    "milestone": null,
    "node_id": "I_kwDOAPphoM6rQ_vU",
    "number": 32598,
    "performed_via_github_app": null,
    "reactions": {
        "+1": 0,
        "-1": 0,
        "confused": 0,
        "eyes": 0,
        "heart": 0,
        "hooray": 0,
        "laugh": 0,
        "rocket": 0,
        "total_count": 0,
        "url": "https://api.github.com/repos/neovim/neovim/issues/32598/reactions"
    },
    "repository_url": "https://api.github.com/repos/neovim/neovim",
    "state": "open",
    "state_reason": null,
    "sub_issues_summary": {
        "completed": 0,
        "percent_completed": 0,
        "total": 0
    },
    "timeline_url": "https://api.github.com/repos/neovim/neovim/issues/32598/timeline",
    "title": "nvim_get_option_info2 doesn't return the right `last_set_sid` after setting option in Lua",
    "updated_at": "2025-02-25T01:22:34Z",
    "url": "https://api.github.com/repos/neovim/neovim/issues/32598",
    "user": {
        "avatar_url": "https://avatars.githubusercontent.com/u/111893501?v=4",
        "events_url": "https://api.github.com/users/brianhuster/events{/privacy}",
        "followers_url": "https://api.github.com/users/brianhuster/followers",
        "following_url": "https://api.github.com/users/brianhuster/following{/other_user}",
        "gists_url": "https://api.github.com/users/brianhuster/gists{/gist_id}",
        "gravatar_id": "",
        "html_url": "https://github.com/brianhuster",
        "id": 111893501,
        "login": "brianhuster",
        "node_id": "U_kgDOBqtb_Q",
        "organizations_url": "https://api.github.com/users/brianhuster/orgs",
        "received_events_url": "https://api.github.com/users/brianhuster/received_events",
        "repos_url": "https://api.github.com/users/brianhuster/repos",
        "site_admin": false,
        "starred_url": "https://api.github.com/users/brianhuster/starred{/owner}{/repo}",
        "subscriptions_url": "https://api.github.com/users/brianhuster/subscriptions",
        "type": "User",
        "url": "https://api.github.com/users/brianhuster",
        "user_view_type": "public"
    }
}