{
    "active_lock_reason": null,
    "assignee": null,
    "assignees": [],
    "author_association": "NONE",
    "body": "### Problem\n\nScreenshot of error:\n\n<img width=\"1293\" height=\"156\" alt=\"Image\" src=\"https://github.com/user-attachments/assets/56b6be96-d5a3-478d-8c87-6ea9b5d0370a\" />\n\n\n\n### Steps to reproduce\n\nMinimal Config:\n\n```\nfor name, url in pairs({\n    \"https://github.com/neovim/nvim-lspconfig\",\n}) do\n    local install_path = vim.fn.fnamemodify(\"nvim_issue/\" .. name, \":p\")\n    if vim.fn.isdirectory(install_path) == 0 then\n        vim.fn.system({ \"git\", \"clone\", \"--depth=1\", url, install_path })\n    end\n    vim.opt.runtimepath:append(install_path)\nend\n\nvim.api.nvim_create_autocmd(\"LspAttach\", {\n    group = vim.api.nvim_create_augroup(\"LSP_Augroup\", { clear = true }),\n    callback = function(ev)\n        local buf = ev.buf ---@type integer\n        local client = assert(vim.lsp.get_client_by_id(ev.data.client_id)) ---@type vim.lsp.Client\n        local methods = vim.lsp.protocol.Methods ---@type table\n\n        if client:supports_method(methods.textDocument_references) then\n            vim.keymap.set(\"n\", \"grr\", function()\n                vim.lsp.buf.references({ includeDeclaration = false })\n                -- vim.lsp.buf.references() -- Issue doesn't occur if this is used\n            end, { buffer = buf })\n        end\n    end,\n})\n\nvim.lsp.enable(\"lua_ls\")\nvim.lsp.enable(\"pylsp\")\n```\n\n-----------------------\n\n```\nLua Test File:\n\nlocal M = {}\n\n-- Does not produce error\nfunction M.print_a_line()\n    print(\"A line\")\nend\n\n-- Produces error\nlocal function use_print_a_line()\n    M.print_a_line()\nend\n\n-- Produces error\nfunction M.print_different_line()\n    print(\"Different line\")\nend\n\nreturn M\n```\n\n### Expected behavior\n\nWhen using this Python test file, no references are correctly recognized for \"print_different_line()\"\n\nPython Test File\n\n```\n# Shows one reference\ndef print_a_line():\n    print(\"A line\")\n\n# Shows one reference\nprint_a_line()\n\n\n# Correctly recognizes no references\ndef print_different_line():\n    print(\"Different line\")\n```\n\n### Nvim version (nvim -v)\n\nNVIM v0.12.0-dev-916+g68eece8b84\n\n### Vim (not Nvim) behaves the same?\n\nN/A\n\n### Operating system/version\n\nLinux Mint 22.1 x86_64\n\n### Terminal name/version\n\nGhostty v1.1.3 / tmux 3.5a\n\n### $TERM environment variable\n\ntmux-256color\n\n### Installation\n\nNightly release tar",
    "closed_at": "2025-08-03T02:58:59Z",
    "closed_by": {
        "avatar_url": "https://avatars.githubusercontent.com/u/1359421?v=4",
        "events_url": "https://api.github.com/users/justinmk/events{/privacy}",
        "followers_url": "https://api.github.com/users/justinmk/followers",
        "following_url": "https://api.github.com/users/justinmk/following{/other_user}",
        "gists_url": "https://api.github.com/users/justinmk/gists{/gist_id}",
        "gravatar_id": "",
        "html_url": "https://github.com/justinmk",
        "id": 1359421,
        "login": "justinmk",
        "node_id": "MDQ6VXNlcjEzNTk0MjE=",
        "organizations_url": "https://api.github.com/users/justinmk/orgs",
        "received_events_url": "https://api.github.com/users/justinmk/received_events",
        "repos_url": "https://api.github.com/users/justinmk/repos",
        "site_admin": false,
        "starred_url": "https://api.github.com/users/justinmk/starred{/owner}{/repo}",
        "subscriptions_url": "https://api.github.com/users/justinmk/subscriptions",
        "type": "User",
        "url": "https://api.github.com/users/justinmk",
        "user_view_type": "public"
    },
    "comment_data": [
        {
            "author_association": "NONE",
            "body": "Results data in handler when run on Lua (edited per https://github.com/neovim/neovim/issues/35137#issuecomment-3146801240):\n\n```lua\n{ {\n    context = {\n      bufnr = 8,\n      client_id = 1,\n      method = \"textDocument/references\",\n      params = {\n        context = {\n          includeDeclaration = false\n        },\n        position = {\n          character = 14,\n          line = 53\n        },\n        textDocument = {\n          uri = \"file:///home/mjm/.config/nvim/lua/mjm/lsp.lua\"\n        }\n      },\n      version = 33\n    }\n  } }\n```\n\nvs. Python\n\n```lua\n{\n  [2] = {\n    context = {\n      bufnr = 21,\n      client_id = 2,\n      method = \"textDocument/references\",\n      params = {\n        context = {\n          includeDeclaration = false\n        },\n        position = {\n          character = 6,\n          line = 9\n        },\n        textDocument = {\n          uri = \"file:///home/mjm/.config/nvim/lua/reference-test/py-test.py\"\n        }\n      },\n      version = 0\n    },\n    result = {}\n  }\n}\n```\n\nThe former does not have an empty result table\n\nEDIT: If I do the map this way it gives the expected result:\n\n```lua\n        if client:supports_method(methods.textDocument_references) then\n            vim.keymap.set(\"n\", \"grr\", function()\n                local bufnr = buf\n                local win = vim.api.nvim_get_current_win()\n                local vim_lsp = require(\"vim.lsp\")\n                local util = require(\"vim.lsp.util\")\n                local ms = require(\"vim.lsp.protocol\").Methods\n\n                vim_lsp.buf_request_all(bufnr, ms.textDocument_references, function(p_client)\n                    local params = util.make_position_params(win, p_client.offset_encoding)\n                    ---@diagnostic disable-next-line: inject-field\n                    params.context = { includeDeclaration = false }\n                    return params\n                end, function(results)\n                    local all_items = {}\n                    local title = \"References\"\n\n                    for client_id, res in pairs(results) do\n                        local r_client = assert(vim_lsp.get_client_by_id(client_id))\n                        local result = res.result or {} -- Add this\n                        -- Change this:\n                        -- local items = util.locations_to_items(res.result, client.offset_encoding)\n                        -- To this:\n                        local items = util.locations_to_items(result, r_client.offset_encoding)\n                        vim.list_extend(all_items, items)\n                    end\n\n                    if not next(all_items) then\n                        vim.notify(\"No references found\")\n                    else\n                        local list = {\n                            title = title,\n                            items = all_items,\n                            context = {\n                                method = ms.textDocument_references,\n                                bufnr = bufnr,\n                            },\n                        }\n                        vim.fn.setqflist({}, \" \", list)\n                        vim.cmd(\"botright copen\")\n                    end\n                end)\n            end, { buffer = buf })\n        end\n\n```",
            "created_at": "2025-08-02T20:52:10Z",
            "html_url": "https://github.com/neovim/neovim/issues/35137#issuecomment-3146718603",
            "id": 3146718603,
            "issue_url": "https://api.github.com/repos/neovim/neovim/issues/35137",
            "node_id": "IC_kwDOAPphoM67jx2L",
            "performed_via_github_app": null,
            "reactions": {
                "+1": 0,
                "-1": 0,
                "confused": 0,
                "eyes": 0,
                "heart": 0,
                "hooray": 0,
                "laugh": 0,
                "rocket": 0,
                "total_count": 0,
                "url": "https://api.github.com/repos/neovim/neovim/issues/comments/3146718603/reactions"
            },
            "updated_at": "2025-08-02T23:07:56Z",
            "url": "https://api.github.com/repos/neovim/neovim/issues/comments/3146718603",
            "user": {
                "avatar_url": "https://avatars.githubusercontent.com/u/62523234?v=4",
                "events_url": "https://api.github.com/users/mikejmcguirk/events{/privacy}",
                "followers_url": "https://api.github.com/users/mikejmcguirk/followers",
                "following_url": "https://api.github.com/users/mikejmcguirk/following{/other_user}",
                "gists_url": "https://api.github.com/users/mikejmcguirk/gists{/gist_id}",
                "gravatar_id": "",
                "html_url": "https://github.com/mikejmcguirk",
                "id": 62523234,
                "login": "mikejmcguirk",
                "node_id": "MDQ6VXNlcjYyNTIzMjM0",
                "organizations_url": "https://api.github.com/users/mikejmcguirk/orgs",
                "received_events_url": "https://api.github.com/users/mikejmcguirk/received_events",
                "repos_url": "https://api.github.com/users/mikejmcguirk/repos",
                "site_admin": false,
                "starred_url": "https://api.github.com/users/mikejmcguirk/starred{/owner}{/repo}",
                "subscriptions_url": "https://api.github.com/users/mikejmcguirk/subscriptions",
                "type": "User",
                "url": "https://api.github.com/users/mikejmcguirk",
                "user_view_type": "public"
            }
        },
        {
            "author_association": "MEMBER",
            "body": "please do NOT post screenshots of *data*.",
            "created_at": "2025-08-02T22:40:04Z",
            "html_url": "https://github.com/neovim/neovim/issues/35137#issuecomment-3146801240",
            "id": 3146801240,
            "issue_url": "https://api.github.com/repos/neovim/neovim/issues/35137",
            "node_id": "IC_kwDOAPphoM67kGBY",
            "performed_via_github_app": null,
            "reactions": {
                "+1": 0,
                "-1": 0,
                "confused": 0,
                "eyes": 0,
                "heart": 0,
                "hooray": 0,
                "laugh": 0,
                "rocket": 0,
                "total_count": 0,
                "url": "https://api.github.com/repos/neovim/neovim/issues/comments/3146801240/reactions"
            },
            "updated_at": "2025-08-02T22:40:04Z",
            "url": "https://api.github.com/repos/neovim/neovim/issues/comments/3146801240",
            "user": {
                "avatar_url": "https://avatars.githubusercontent.com/u/1359421?v=4",
                "events_url": "https://api.github.com/users/justinmk/events{/privacy}",
                "followers_url": "https://api.github.com/users/justinmk/followers",
                "following_url": "https://api.github.com/users/justinmk/following{/other_user}",
                "gists_url": "https://api.github.com/users/justinmk/gists{/gist_id}",
                "gravatar_id": "",
                "html_url": "https://github.com/justinmk",
                "id": 1359421,
                "login": "justinmk",
                "node_id": "MDQ6VXNlcjEzNTk0MjE=",
                "organizations_url": "https://api.github.com/users/justinmk/orgs",
                "received_events_url": "https://api.github.com/users/justinmk/received_events",
                "repos_url": "https://api.github.com/users/justinmk/repos",
                "site_admin": false,
                "starred_url": "https://api.github.com/users/justinmk/starred{/owner}{/repo}",
                "subscriptions_url": "https://api.github.com/users/justinmk/subscriptions",
                "type": "User",
                "url": "https://api.github.com/users/justinmk",
                "user_view_type": "public"
            }
        },
        {
            "author_association": "NONE",
            "body": "Copy. Original comment updated.",
            "created_at": "2025-08-02T23:08:14Z",
            "html_url": "https://github.com/neovim/neovim/issues/35137#issuecomment-3146832683",
            "id": 3146832683,
            "issue_url": "https://api.github.com/repos/neovim/neovim/issues/35137",
            "node_id": "IC_kwDOAPphoM67kNsr",
            "performed_via_github_app": null,
            "reactions": {
                "+1": 0,
                "-1": 0,
                "confused": 0,
                "eyes": 0,
                "heart": 0,
                "hooray": 0,
                "laugh": 0,
                "rocket": 0,
                "total_count": 0,
                "url": "https://api.github.com/repos/neovim/neovim/issues/comments/3146832683/reactions"
            },
            "updated_at": "2025-08-02T23:08:14Z",
            "url": "https://api.github.com/repos/neovim/neovim/issues/comments/3146832683",
            "user": {
                "avatar_url": "https://avatars.githubusercontent.com/u/62523234?v=4",
                "events_url": "https://api.github.com/users/mikejmcguirk/events{/privacy}",
                "followers_url": "https://api.github.com/users/mikejmcguirk/followers",
                "following_url": "https://api.github.com/users/mikejmcguirk/following{/other_user}",
                "gists_url": "https://api.github.com/users/mikejmcguirk/gists{/gist_id}",
                "gravatar_id": "",
                "html_url": "https://github.com/mikejmcguirk",
                "id": 62523234,
                "login": "mikejmcguirk",
                "node_id": "MDQ6VXNlcjYyNTIzMjM0",
                "organizations_url": "https://api.github.com/users/mikejmcguirk/orgs",
                "received_events_url": "https://api.github.com/users/mikejmcguirk/received_events",
                "repos_url": "https://api.github.com/users/mikejmcguirk/repos",
                "site_admin": false,
                "starred_url": "https://api.github.com/users/mikejmcguirk/starred{/owner}{/repo}",
                "subscriptions_url": "https://api.github.com/users/mikejmcguirk/subscriptions",
                "type": "User",
                "url": "https://api.github.com/users/mikejmcguirk",
                "user_view_type": "public"
            }
        }
    ],
    "comments": 3,
    "comments_url": "https://api.github.com/repos/neovim/neovim/issues/35137/comments",
    "created_at": "2025-08-02T19:41:26Z",
    "events_url": "https://api.github.com/repos/neovim/neovim/issues/35137/events",
    "html_url": "https://github.com/neovim/neovim/issues/35137",
    "id": 3286236996,
    "labels": [
        {
            "color": "BFDADC",
            "default": false,
            "description": "Low-risk, self-contained. Do NOT ask \"can I work on this\", just read CONTRIBUTING.md",
            "id": 407246773,
            "name": "complexity:low",
            "node_id": "MDU6TGFiZWw0MDcyNDY3NzM=",
            "url": "https://api.github.com/repos/neovim/neovim/labels/complexity:low"
        },
        {
            "color": "c5def5",
            "default": false,
            "description": null,
            "id": 662566370,
            "name": "lsp",
            "node_id": "MDU6TGFiZWw2NjI1NjYzNzA=",
            "url": "https://api.github.com/repos/neovim/neovim/labels/lsp"
        }
    ],
    "labels_url": "https://api.github.com/repos/neovim/neovim/issues/35137/labels{/name}",
    "locked": false,
    "milestone": {
        "closed_at": null,
        "closed_issues": 13,
        "created_at": "2025-07-14T12:16:41Z",
        "creator": {
            "avatar_url": "https://avatars.githubusercontent.com/u/1359421?v=4",
            "events_url": "https://api.github.com/users/justinmk/events{/privacy}",
            "followers_url": "https://api.github.com/users/justinmk/followers",
            "following_url": "https://api.github.com/users/justinmk/following{/other_user}",
            "gists_url": "https://api.github.com/users/justinmk/gists{/gist_id}",
            "gravatar_id": "",
            "html_url": "https://github.com/justinmk",
            "id": 1359421,
            "login": "justinmk",
            "node_id": "MDQ6VXNlcjEzNTk0MjE=",
            "organizations_url": "https://api.github.com/users/justinmk/orgs",
            "received_events_url": "https://api.github.com/users/justinmk/received_events",
            "repos_url": "https://api.github.com/users/justinmk/repos",
            "site_admin": false,
            "starred_url": "https://api.github.com/users/justinmk/starred{/owner}{/repo}",
            "subscriptions_url": "https://api.github.com/users/justinmk/subscriptions",
            "type": "User",
            "url": "https://api.github.com/users/justinmk",
            "user_view_type": "public"
        },
        "description": "",
        "due_on": null,
        "html_url": "https://github.com/neovim/neovim/milestone/52",
        "id": 13265074,
        "labels_url": "https://api.github.com/repos/neovim/neovim/milestones/52/labels",
        "node_id": "MI_kwDOAPphoM4Aymiy",
        "number": 52,
        "open_issues": 22,
        "state": "open",
        "title": "0.11.4",
        "updated_at": "2025-08-03T13:36:08Z",
        "url": "https://api.github.com/repos/neovim/neovim/milestones/52"
    },
    "node_id": "I_kwDOAPphoM7D3_9E",
    "number": 35137,
    "performed_via_github_app": null,
    "reactions": {
        "+1": 0,
        "-1": 0,
        "confused": 0,
        "eyes": 0,
        "heart": 0,
        "hooray": 0,
        "laugh": 0,
        "rocket": 0,
        "total_count": 0,
        "url": "https://api.github.com/repos/neovim/neovim/issues/35137/reactions"
    },
    "repository_url": "https://api.github.com/repos/neovim/neovim",
    "state": "closed",
    "state_reason": "completed",
    "sub_issues_summary": {
        "completed": 0,
        "percent_completed": 0,
        "total": 0
    },
    "timeline_url": "https://api.github.com/repos/neovim/neovim/issues/35137/timeline",
    "title": "Enter Error When Going to LSP References in Lua Without Declaration",
    "type": {
        "color": "red",
        "created_at": "2024-01-25T10:10:19Z",
        "description": "An unexpected problem or behavior",
        "id": 597163,
        "is_enabled": true,
        "name": "Bug",
        "node_id": "IT_kwDOAGK_Pc4ACRyr",
        "updated_at": "2024-07-26T10:12:30Z"
    },
    "updated_at": "2025-08-03T02:59:00Z",
    "url": "https://api.github.com/repos/neovim/neovim/issues/35137",
    "user": {
        "avatar_url": "https://avatars.githubusercontent.com/u/62523234?v=4",
        "events_url": "https://api.github.com/users/mikejmcguirk/events{/privacy}",
        "followers_url": "https://api.github.com/users/mikejmcguirk/followers",
        "following_url": "https://api.github.com/users/mikejmcguirk/following{/other_user}",
        "gists_url": "https://api.github.com/users/mikejmcguirk/gists{/gist_id}",
        "gravatar_id": "",
        "html_url": "https://github.com/mikejmcguirk",
        "id": 62523234,
        "login": "mikejmcguirk",
        "node_id": "MDQ6VXNlcjYyNTIzMjM0",
        "organizations_url": "https://api.github.com/users/mikejmcguirk/orgs",
        "received_events_url": "https://api.github.com/users/mikejmcguirk/received_events",
        "repos_url": "https://api.github.com/users/mikejmcguirk/repos",
        "site_admin": false,
        "starred_url": "https://api.github.com/users/mikejmcguirk/starred{/owner}{/repo}",
        "subscriptions_url": "https://api.github.com/users/mikejmcguirk/subscriptions",
        "type": "User",
        "url": "https://api.github.com/users/mikejmcguirk",
        "user_view_type": "public"
    }
}