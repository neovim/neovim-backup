{
    "active_lock_reason": null,
    "assignee": null,
    "assignees": [],
    "author_association": "MEMBER",
    "body": "### Problem\n\nIn the treesitter highlighter, the `on_conceal_line` callback sometimes gets called with `row == -1`. This is making it difficult to track injection ranges with extmarks, since this code path requests a parse at row -1, which is invalid. It also probably has unintended effects in the highlighter regardless.\n\n### Steps to reproduce\n\n```lua\n-- minimal.lua\nvim.o.scrolloff = 8\nvim.api.nvim_tabpage_set_win(\n  0,\n  ({\n    vim.lsp.util.open_floating_preview(\n      { 'foo', '```lua', 'local bar', '```' },\n      'markdown',\n      {\n        border = 'single',\n        focus = true,\n      }\n    ),\n  })[2]\n)\n```\n\nWith this patch:\n\n```patch\ndiff --git a/src/nvim/decoration_provider.c b/src/nvim/decoration_provider.c\nindex 3019bd4df4..5e13c66a69 100644\n--- a/src/nvim/decoration_provider.c\n+++ b/src/nvim/decoration_provider.c\n@@ -91,6 +91,7 @@ void decor_providers_invoke_spell(win_T *wp, int start_row, int start_col, int e\n /// @return whether a provider placed any marks in the callback.\n bool decor_providers_invoke_conceal_line(win_T *wp, int row)\n {\n+  assert(row != -1);\n   size_t keys = wp->w_buffer->b_marktree->n_keys;\n   for (size_t i = 0; i < kv_size(decor_providers); i++) {\n     DecorProvider *p = &kv_A(decor_providers, i);\n```\n\nRun:\n\n```\nnvim minimal.lua --clean\n:so<CR>\nvj\n```\n\n> **NOTE:** In the above `minimal.lua`, you can also remove `scrolloff` entirely, and then replace `vj` with `:h<CR>` in the repro steps, and the assertion will also trigger.\n\nObserve the assertion failure. Backtrace:\n\n```\n           PID: 218243 (nvim)\n           UID: 1000 (jdoe)\n           GID: 100 (users)\n        Signal: 6 (ABRT)\n     Timestamp: Mon 2025-10-06 06:56:37 PDT (2min 41s ago)\n  Command Line: /home/jdoe/neovim/bin/nvim --embed --luamod-dev test.lua --clean\n    Executable: /home/jdoe/neovim/bin/nvim\n Control Group: /user.slice/user-1000.slice/user@1000.service/app.slice/app-ghostty-transient-2799.scope/surfaces/560976E5C2C0.scope\n          Unit: user@1000.service\n     User Unit: app-ghostty-transient-2799.scope\n         Slice: user-1000.slice\n     Owner UID: 1000 (jdoe)\n       Boot ID: c21981ef5c464e7e902cf83b290d2668\n    Machine ID: 6541f6ca719247c8b00690cbc51ddae1\n      Hostname: computer\n       Storage: /var/lib/systemd/coredump/core.nvim.1000.c21981ef5c464e7e902cf83b290d2668.218243.1759758997000000.zst (present)\n  Size on Disk: 1.1M\n       Message: Process 218243 (nvim) of user 1000 dumped core.\n                \n                Module /home/jdoe/neovim/bin/nvim without build-id.\n                Module markdown_inline.so without build-id.\n                Module markdown.so without build-id.\n                Module lua.so without build-id.\n                Module libgcc_s.so.1 without build-id.\n                Stack trace of thread 218243:\n                #0  0x00007f04ab49caac __pthread_kill_implementation (libc.so.6 + 0x9caac)\n                #1  0x00007f04ab44190e raise (libc.so.6 + 0x4190e)\n                #2  0x00007f04ab428942 abort (libc.so.6 + 0x28942)\n                #3  0x00007f04ab42885e __assert_fail_base.cold (libc.so.6 + 0x2885e)\n                #4  0x00007f04ab4396f7 __assert_fail (libc.so.6 + 0x396f7)\n                #5  0x00000000004d1b32 decor_providers_invoke_conceal_line (/home/jdoe/neovim/bin/nvim + 0xd1b32)\n                #6  0x00000000004cfa53 decor_conceal_line (/home/jdoe/neovim/bin/nvim + 0xcfa53)\n                #7  0x000000000061f48e update_topline (/home/jdoe/neovim/bin/nvim + 0x21f48e)\n                #8  0x00000000004ed70c cursor_down (/home/jdoe/neovim/bin/nvim + 0xed70c)\n                #9  0x0000000000628dea nv_down (/home/jdoe/neovim/bin/nvim + 0x228dea)\n                #10 0x000000000062eecb normal_execute (/home/jdoe/neovim/bin/nvim + 0x22eecb)\n                #11 0x00000000006e0eda state_enter (/home/jdoe/neovim/bin/nvim + 0x2e0eda)\n                #12 0x000000000062b939 normal_enter (/home/jdoe/neovim/bin/nvim + 0x22b939)\n                #13 0x00000000004630d8 main (/home/jdoe/neovim/bin/nvim + 0x630d8)\n                #14 0x00007f04ab42a4d8 __libc_start_call_main (libc.so.6 + 0x2a4d8)\n                #15 0x00007f04ab42a59b __libc_start_main@@GLIBC_2.34 (libc.so.6 + 0x2a59b)\n                #16 0x00000000004651d5 _start (/home/jdoe/neovim/bin/nvim + 0x651d5)\n                ELF object binary architecture: AMD x86-64\n\nGNU gdb (GDB) 16.3\nCopyright (C) 2024 Free Software Foundation, Inc.\nLicense GPLv3+: GNU GPL version 3 or later <http://gnu.org/licenses/gpl.html>\nThis is free software: you are free to change and redistribute it.\nThere is NO WARRANTY, to the extent permitted by law.\nType \"show copying\" and \"show warranty\" for details.\nThis GDB was configured as \"x86_64-unknown-linux-gnu\".\nType \"show configuration\" for configuration details.\nFor bug reporting instructions, please see:\n<https://www.gnu.org/software/gdb/bugs/>.\nFind the GDB manual and other documentation resources online at:\n    <http://www.gnu.org/software/gdb/documentation/>.\n\nFor help, type \"help\".\nType \"apropos word\" to search for commands related to \"word\"...\nReading symbols from /home/jdoe/neovim/bin/nvim...\n\nwarning: Can't open file anon_inode:[io_uring] during file-backed mapping note processing\n[New LWP 218243]\n[Thread debugging using libthread_db enabled]\nUsing host libthread_db library \"/nix/store/776irwlgfb65a782cxmyk61pck460fs9-glibc-2.40-66/lib/libthread_db.so.1\".\nCore was generated by `/home/jdoe/neovim/bin/nvim --embed --luamod-dev test.lua --clean'.\nProgram terminated with signal SIGABRT, Aborted.\n#0  0x00007f04ab49caac in __pthread_kill_implementation () from /nix/store/776irwlgfb65a782cxmyk61pck460fs9-glibc-2.40-66/lib/libc.so.6\nThread 1 (Thread 0x7f04ab65d740 (LWP 218243)):\n#0  0x00007f04ab49caac in __pthread_kill_implementation () from /nix/store/776irwlgfb65a782cxmyk61pck460fs9-glibc-2.40-66/lib/libc.so.6\nNo symbol table info available.\n#1  0x00007f04ab44190e in raise () from /nix/store/776irwlgfb65a782cxmyk61pck460fs9-glibc-2.40-66/lib/libc.so.6\nNo symbol table info available.\n#2  0x00007f04ab428942 in abort () from /nix/store/776irwlgfb65a782cxmyk61pck460fs9-glibc-2.40-66/lib/libc.so.6\nNo symbol table info available.\n#3  0x00007f04ab42885e in __assert_fail_base.cold () from /nix/store/776irwlgfb65a782cxmyk61pck460fs9-glibc-2.40-66/lib/libc.so.6\nNo symbol table info available.\n#4  0x00007f04ab4396f7 in __assert_fail () from /nix/store/776irwlgfb65a782cxmyk61pck460fs9-glibc-2.40-66/lib/libc.so.6\nNo symbol table info available.\n#5  0x00000000004d1b32 in decor_providers_invoke_conceal_line (wp=wp@entry=0x11b97210, row=row@entry=-1) at /home/jdoe/Documents/CodeProjects/neovim/src/nvim/decoration_provider.c:94\n        __PRETTY_FUNCTION__ = \"decor_providers_invoke_conceal_line\"\n        keys = <optimized out>\n#6  0x00000000004cfa53 in decor_conceal_line (wp=wp@entry=0x11b97210, row=-1, check_cursor=check_cursor@entry=false) at /home/jdoe/Documents/CodeProjects/neovim/src/nvim/decoration.c:902\n        pair = {start = {pos = {row = 2, col = 32767}, ns = 1136145152, id = 1089770029, flags = 62496, decor_data = {hl = {flags = 3, priority = 0, hl_id = 0, conceal_char = 3}, ext = {sh_idx = 3, vt = 0x3}}}, end_pos = {row = 0, col = 0}, end_right_gravity = false}\n        itr = {{pos = {row = 0, col = 0}, lvl = 0, x = 0x11c45580, i = 0, s = {{oldcol = 1089770029, i = 0}, {oldcol = 0, i = 1136145152}, {oldcol = 1089770029, i = 297366032}, {oldcol = 0, i = 3}, {oldcol = 0, i = 3}, {oldcol = 0, i = 1}, {oldcol = 0, i = 0}, {oldcol = 0, i = 297366032}, {oldcol = 0, i = -1543424672}, {oldcol = 32767, i = 5769690}, {oldcol = 0, i = 2}, {oldcol = 0, i = 1136145152}, {oldcol = 1089770029, i = 0}, {oldcol = 0, i = 1136145152}, {oldcol = 1089770029, i = 297366032}, {oldcol = 0, i = 3}, {oldcol = 0, i = -1543424520}, {oldcol = 32767, i = 0}, {oldcol = 0, i = -1543424624}, {oldcol = 32767, i = 6686459}}, intersect_idx = 0, intersect_pos = {row = -1, col = 0}, intersect_pos_x = {row = -1, col = 0}}}\n#7  0x000000000061f48e in update_topline (wp=0x11b97210) at /home/jdoe/Documents/CodeProjects/neovim/src/nvim/move.c:404\n        lnum = 0\n        line_count = 2\n        check_botline = true\n        so_ptr = 0x9e08d8 <p_so>\n        save_so = <optimized out>\n        old_topline = 1\n        old_topfill = 0\n        __PRETTY_FUNCTION__ = \"update_topline\"\n#8  0x00000000004ed70c in cursor_down (n=1, upd_topline=<optimized out>) at /home/jdoe/Documents/CodeProjects/neovim/src/nvim/edit.c:2534\n        lnum = 1\n#9  0x0000000000628dea in nv_down (cap=0x7fffa4013790) at /home/jdoe/Documents/CodeProjects/neovim/src/nvim/normal.c:3860\nNo locals.\n#10 nv_down (cap=0x7fffa4013790) at /home/jdoe/Documents/CodeProjects/neovim/src/nvim/normal.c:3838\nNo locals.\n#11 0x000000000062eecb in normal_execute (state=0x7fffa4013720, key=<optimized out>) at /home/jdoe/Documents/CodeProjects/neovim/src/nvim/normal.c:1245\n        s = 0x7fffa4013720\n        __PRETTY_FUNCTION__ = \"normal_execute\"\n#12 0x00000000006e0eda in state_enter (s=s@entry=0x7fffa4013720) at /home/jdoe/Documents/CodeProjects/neovim/src/nvim/state.c:100\n        check_result = <optimized out>\n        key = <optimized out>\n        execute_result = <optimized out>\n        getkey = <optimized out>\n#13 0x000000000062b939 in normal_enter (cmdwin=cmdwin@entry=false, noexmode=noexmode@entry=false) at /home/jdoe/Documents/CodeProjects/neovim/src/nvim/normal.c:522\n        state = {state = {check = 0x62d770 <normal_check>, execute = 0x62e970 <normal_execute>}, command_finished = false, ctrl_w = false, need_flushbuf = true, set_prevcount = false, previous_got_int = false, cmdwin = false, noexmode = false, toplevel = true, oa = {op_type = 0, regname = 0, motion_type = kMTLineWise, motion_force = 0, use_reg_one = false, inclusive = false, end_adjusted = false, start = {lnum = 0, col = 0, coladd = 0}, end = {lnum = 0, col = 0, coladd = 0}, cursor_start = {lnum = 0, col = 0, coladd = 0}, line_count = 0, empty = false, is_VIsual = false, start_vcol = 0, end_vcol = 0, prev_opcount = 0, prev_count0 = 0, excl_tr_ws = false}, ca = {oap = 0x7fffa4013738, prechar = 0, cmdchar = 106, nchar = 0, nchar_composing = '\\000' <repeats 31 times>, nchar_len = 0, extra_char = 0, opcount = 0, count0 = 0, count1 = 1, arg = 0, retval = 0, searchbuf = 0x0}, mapped_len = 0, old_mapped_len = 0, idx = 107, c = 106, old_col = 0, old_pos = {lnum = 1, col = 0, coladd = 0}}\n        prev_oap = 0x0\n#14 0x00000000004630d8 in main (argc=<optimized out>, argv=<optimized out>) at /home/jdoe/Documents/CodeProjects/neovim/src/nvim/main.c:655\n        fname = <optimized out>\n        params = {argc = 5, argv = 0x7fffa4013cc8, use_vimrc = 0x848c5f \"NONE\", clean = true, n_commands = 0, commands = {0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0}, cmds_tofree = \"\\000\\000\\000\\000\\000\\000\\000\\000\\000\", n_pre_commands = 0, pre_commands = {0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0}, luaf = 0x0, lua_arg0 = -1, edit_type = 1, tagname = 0x0, use_ef = 0x0, input_istext = false, no_swap_file = 0, use_debug_break_level = -1, window_count = 1, window_layout = 0, diff_mode = 0, listen_addr = 0x0, remote = 0, server_addr = 0x0, scriptin = 0x0, scriptout = 0x0, scriptout_append = false, had_stdin_file = false}\n        cwd = <optimized out>\n        has_term = <optimized out>\n        use_builtin_ui = <optimized out>\n        remote_ui = false\n        __PRETTY_FUNCTION__ = \"main\"\n        use_remote_ui = <optimized out>\n        listen_and_embed = <optimized out>\n        vimrc_none = <optimized out>\n```\n\ncc @luukvbaal \n\n### Expected behavior\n\nThis should not be called with `row == -1` (either it should not be called, or it should be called with a correct row value?)\n\n### Nvim version (nvim -v)\n\nNightly e7a03dd4e8792d49c4c34fcc8a5bd981a0310208\n\n### Vim (not Nvim) behaves the same?\n\nNA\n\n### Operating system/version\n\nNixOS 25.11\n\n### Terminal name/version\n\nGhostty 1.2.0\n\n### $TERM environment variable\n\nxterm-ghostty\n\n### Installation\n\nnixos nightly overlay",
    "closed_at": "2025-10-09T13:44:12Z",
    "closed_by": {
        "avatar_url": "https://avatars.githubusercontent.com/u/31730729?v=4",
        "events_url": "https://api.github.com/users/luukvbaal/events{/privacy}",
        "followers_url": "https://api.github.com/users/luukvbaal/followers",
        "following_url": "https://api.github.com/users/luukvbaal/following{/other_user}",
        "gists_url": "https://api.github.com/users/luukvbaal/gists{/gist_id}",
        "gravatar_id": "",
        "html_url": "https://github.com/luukvbaal",
        "id": 31730729,
        "login": "luukvbaal",
        "node_id": "MDQ6VXNlcjMxNzMwNzI5",
        "organizations_url": "https://api.github.com/users/luukvbaal/orgs",
        "received_events_url": "https://api.github.com/users/luukvbaal/received_events",
        "repos_url": "https://api.github.com/users/luukvbaal/repos",
        "site_admin": false,
        "starred_url": "https://api.github.com/users/luukvbaal/starred{/owner}{/repo}",
        "subscriptions_url": "https://api.github.com/users/luukvbaal/subscriptions",
        "type": "User",
        "url": "https://api.github.com/users/luukvbaal",
        "user_view_type": "public"
    },
    "comment_data": [
        {
            "author_association": "MEMBER",
            "body": "Thanks. The 'scrolloff' case should be fixed like so:\n```diff\ndiff --git a/src/nvim/move.c b/src/nvim/move.c\nindex 294c147838..895f1b2949 100644\n--- a/src/nvim/move.c\n+++ b/src/nvim/move.c\n@@ -401,11 +401,11 @@ void update_topline(win_T *wp)\n           // botline - p_so (approximation of how much will be\n           // scrolled).\n           for (linenr_T lnum = wp->w_cursor.lnum; lnum >= wp->w_botline - *so_ptr; lnum--) {\n-            line_count += !decor_conceal_line(wp, lnum - 1, false);\n             // stop at end of file or when we know we are far off\n             if (lnum <= 0 || line_count > wp->w_view_height + 1) {\n               break;\n             }\n+            line_count += !decor_conceal_line(wp, lnum - 1, false);\n             hasFolding(wp, lnum, &lnum, NULL);\n           }\n         } else {\n```\n\nA no scrolloff culprit would be elsewhere I think.",
            "created_at": "2025-10-06T14:20:20Z",
            "html_url": "https://github.com/neovim/neovim/issues/36057#issuecomment-3371934109",
            "id": 3371934109,
            "issue_url": "https://api.github.com/repos/neovim/neovim/issues/36057",
            "node_id": "IC_kwDOAPphoM7I-6Gd",
            "performed_via_github_app": null,
            "reactions": {
                "+1": 1,
                "-1": 0,
                "confused": 0,
                "eyes": 0,
                "heart": 0,
                "hooray": 0,
                "laugh": 0,
                "rocket": 0,
                "total_count": 1,
                "url": "https://api.github.com/repos/neovim/neovim/issues/comments/3371934109/reactions"
            },
            "updated_at": "2025-10-06T14:20:20Z",
            "url": "https://api.github.com/repos/neovim/neovim/issues/comments/3371934109",
            "user": {
                "avatar_url": "https://avatars.githubusercontent.com/u/31730729?v=4",
                "events_url": "https://api.github.com/users/luukvbaal/events{/privacy}",
                "followers_url": "https://api.github.com/users/luukvbaal/followers",
                "following_url": "https://api.github.com/users/luukvbaal/following{/other_user}",
                "gists_url": "https://api.github.com/users/luukvbaal/gists{/gist_id}",
                "gravatar_id": "",
                "html_url": "https://github.com/luukvbaal",
                "id": 31730729,
                "login": "luukvbaal",
                "node_id": "MDQ6VXNlcjMxNzMwNzI5",
                "organizations_url": "https://api.github.com/users/luukvbaal/orgs",
                "received_events_url": "https://api.github.com/users/luukvbaal/received_events",
                "repos_url": "https://api.github.com/users/luukvbaal/repos",
                "site_admin": false,
                "starred_url": "https://api.github.com/users/luukvbaal/starred{/owner}{/repo}",
                "subscriptions_url": "https://api.github.com/users/luukvbaal/subscriptions",
                "type": "User",
                "url": "https://api.github.com/users/luukvbaal",
                "user_view_type": "public"
            }
        }
    ],
    "comments": 1,
    "comments_url": "https://api.github.com/repos/neovim/neovim/issues/36057/comments",
    "created_at": "2025-10-06T14:03:23Z",
    "events_url": "https://api.github.com/repos/neovim/neovim/issues/36057/events",
    "html_url": "https://github.com/neovim/neovim/issues/36057",
    "id": 3487462895,
    "issue_dependencies_summary": {
        "blocked_by": 0,
        "blocking": 0,
        "total_blocked_by": 0,
        "total_blocking": 0
    },
    "labels": [
        {
            "color": "c5def5",
            "default": false,
            "description": "marks, extmarks, decorations, virtual text",
            "id": 1680119719,
            "name": "marks",
            "node_id": "MDU6TGFiZWwxNjgwMTE5NzE5",
            "url": "https://api.github.com/repos/neovim/neovim/labels/marks"
        },
        {
            "color": "C5DEF5",
            "default": false,
            "description": "",
            "id": 3385582660,
            "name": "conceal",
            "node_id": "LA_kwDOAPphoM7Jy-RE",
            "url": "https://api.github.com/repos/neovim/neovim/labels/conceal"
        }
    ],
    "labels_url": "https://api.github.com/repos/neovim/neovim/issues/36057/labels{/name}",
    "locked": false,
    "milestone": null,
    "node_id": "I_kwDOAPphoM7P3nXv",
    "number": 36057,
    "performed_via_github_app": null,
    "reactions": {
        "+1": 0,
        "-1": 0,
        "confused": 0,
        "eyes": 0,
        "heart": 0,
        "hooray": 0,
        "laugh": 0,
        "rocket": 0,
        "total_count": 0,
        "url": "https://api.github.com/repos/neovim/neovim/issues/36057/reactions"
    },
    "repository_url": "https://api.github.com/repos/neovim/neovim",
    "state": "closed",
    "state_reason": "completed",
    "sub_issues_summary": {
        "completed": 0,
        "percent_completed": 0,
        "total": 0
    },
    "timeline_url": "https://api.github.com/repos/neovim/neovim/issues/36057/timeline",
    "title": "\"conceal_line\" callback invoked with `row == -1` ",
    "type": {
        "color": "red",
        "created_at": "2024-01-25T10:10:19Z",
        "description": "An unexpected problem or behavior",
        "id": 597163,
        "is_enabled": true,
        "name": "Bug",
        "node_id": "IT_kwDOAGK_Pc4ACRyr",
        "updated_at": "2024-07-26T10:12:30Z"
    },
    "updated_at": "2025-10-09T13:44:12Z",
    "url": "https://api.github.com/repos/neovim/neovim/issues/36057",
    "user": {
        "avatar_url": "https://avatars.githubusercontent.com/u/55766287?v=4",
        "events_url": "https://api.github.com/users/ribru17/events{/privacy}",
        "followers_url": "https://api.github.com/users/ribru17/followers",
        "following_url": "https://api.github.com/users/ribru17/following{/other_user}",
        "gists_url": "https://api.github.com/users/ribru17/gists{/gist_id}",
        "gravatar_id": "",
        "html_url": "https://github.com/ribru17",
        "id": 55766287,
        "login": "ribru17",
        "node_id": "MDQ6VXNlcjU1NzY2Mjg3",
        "organizations_url": "https://api.github.com/users/ribru17/orgs",
        "received_events_url": "https://api.github.com/users/ribru17/received_events",
        "repos_url": "https://api.github.com/users/ribru17/repos",
        "site_admin": false,
        "starred_url": "https://api.github.com/users/ribru17/starred{/owner}{/repo}",
        "subscriptions_url": "https://api.github.com/users/ribru17/subscriptions",
        "type": "User",
        "url": "https://api.github.com/users/ribru17",
        "user_view_type": "public"
    }
}