{
    "active_lock_reason": null,
    "assignee": null,
    "assignees": [],
    "author_association": "MEMBER",
    "body": "### Problem\n\nOn Linux, the following check in `flush_stream()` isn't sufficient to ensure that all PTY output is received:\n\nhttps://github.com/neovim/neovim/blob/94c21c22dcf6b1afdb25a250c08bd858d481429b/src/nvim/event/proc.c#L394-L404\n\nIt seems that even if `poll()` doesn't return any events after process exit, PTY master can still have more output. This problem is present both with and without #37401.\n\n### Steps to reproduce\n\nSince #37918 this started happening occasionally on Linux CI jobs other than ASAN/TSAN. Example test failure:\n```\nFAILED   test/functional/terminal/tui_spec.lua @ 2552: TUI no assert failure on deadly signal #21896\ntest/functional/terminal/tui_spec.lua:2554: Row 1 did not match.\nExpected:\n  |*Nvim: Caught deadly signal 'SIGTERM'              |\n  |*                                                  |\n  |*[Process exited 1]^                                |\n  |                                                  |\n  |                                                  |\n  |                                                  |\n  |{5:-- TERMINAL --}                                    |\nActual:\n  |*                                                  |\n  |*[Process exited 1]^                                |\n  |*                                                  |\n  |                                                  |\n  |                                                  |\n  |                                                  |\n  |{5:-- TERMINAL --}                                    |\n```\nThere are also several other test that may fail due to this.\n\n### Expected behavior\n\nFull PTY output should be received by the terminal buffer.\n\nIt seems that the proper way to detect PTY master EOF on Linux is to call `read()` and check if `errno` is `EIO`.\n\nHowever, then there is another problem that if there is another program running in the PTY, EOF only happens on PTY master when that process exits as well.\n\nIt seems that some terminal emulators (e.g. kitty) do wait for all processes in the PTY to exit (e.g. after `:detach` in Nvim, kitty doesn't exit until the server is also stopped), while some other terminal emulators don't. This is also mentioned in tui_spec.lua:\n\nhttps://github.com/neovim/neovim/blob/94c21c22dcf6b1afdb25a250c08bd858d481429b/test/functional/terminal/tui_spec.lua#L205-L209\n\nMaking Nvim's builtin terminal do this can be a bit hard and can potentially break plugins, as it's not clear how this should interact with `on_exit` and `jobwait()` etc..\n\n### Nvim version (nvim -v)\n\nv0.12.0-dev-2374+g94c21c22dc\n\n### Vim (not Nvim) behaves the same?\n\nCannot verify as issue is hard to reproduce locally\n\n### Operating system/version\n\nGitHub Actions Ubuntu 24.04\n\n### Terminal name/version\n\nN/A\n\n### $TERM environment variable\n\nN/A\n\n### Installation\n\nN/A",
    "closed_at": "2026-02-22T23:15:40Z",
    "closed_by": {
        "avatar_url": "https://avatars.githubusercontent.com/u/35768171?v=4",
        "events_url": "https://api.github.com/users/zeertzjq/events{/privacy}",
        "followers_url": "https://api.github.com/users/zeertzjq/followers",
        "following_url": "https://api.github.com/users/zeertzjq/following{/other_user}",
        "gists_url": "https://api.github.com/users/zeertzjq/gists{/gist_id}",
        "gravatar_id": "",
        "html_url": "https://github.com/zeertzjq",
        "id": 35768171,
        "login": "zeertzjq",
        "node_id": "MDQ6VXNlcjM1NzY4MTcx",
        "organizations_url": "https://api.github.com/users/zeertzjq/orgs",
        "received_events_url": "https://api.github.com/users/zeertzjq/received_events",
        "repos_url": "https://api.github.com/users/zeertzjq/repos",
        "site_admin": false,
        "starred_url": "https://api.github.com/users/zeertzjq/starred{/owner}{/repo}",
        "subscriptions_url": "https://api.github.com/users/zeertzjq/subscriptions",
        "type": "User",
        "url": "https://api.github.com/users/zeertzjq",
        "user_view_type": "public"
    },
    "comment_data": [
        {
            "author_association": "MEMBER",
            "body": "#37984 can possibly make this happen less frequently, although it doesn't solve the problem.",
            "created_at": "2026-02-20T12:11:20Z",
            "html_url": "https://github.com/neovim/neovim/issues/37982#issuecomment-3933769457",
            "id": 3933769457,
            "issue_url": "https://api.github.com/repos/neovim/neovim/issues/37982",
            "node_id": "IC_kwDOAPphoM7qeI7x",
            "performed_via_github_app": null,
            "pin": null,
            "reactions": {
                "+1": 0,
                "-1": 0,
                "confused": 0,
                "eyes": 0,
                "heart": 0,
                "hooray": 0,
                "laugh": 0,
                "rocket": 0,
                "total_count": 0,
                "url": "https://api.github.com/repos/neovim/neovim/issues/comments/3933769457/reactions"
            },
            "updated_at": "2026-02-20T12:12:36Z",
            "url": "https://api.github.com/repos/neovim/neovim/issues/comments/3933769457",
            "user": {
                "avatar_url": "https://avatars.githubusercontent.com/u/35768171?v=4",
                "events_url": "https://api.github.com/users/zeertzjq/events{/privacy}",
                "followers_url": "https://api.github.com/users/zeertzjq/followers",
                "following_url": "https://api.github.com/users/zeertzjq/following{/other_user}",
                "gists_url": "https://api.github.com/users/zeertzjq/gists{/gist_id}",
                "gravatar_id": "",
                "html_url": "https://github.com/zeertzjq",
                "id": 35768171,
                "login": "zeertzjq",
                "node_id": "MDQ6VXNlcjM1NzY4MTcx",
                "organizations_url": "https://api.github.com/users/zeertzjq/orgs",
                "received_events_url": "https://api.github.com/users/zeertzjq/received_events",
                "repos_url": "https://api.github.com/users/zeertzjq/repos",
                "site_admin": false,
                "starred_url": "https://api.github.com/users/zeertzjq/starred{/owner}{/repo}",
                "subscriptions_url": "https://api.github.com/users/zeertzjq/subscriptions",
                "type": "User",
                "url": "https://api.github.com/users/zeertzjq",
                "user_view_type": "public"
            }
        },
        {
            "author_association": "MEMBER",
            "body": "> It seems that even if `poll()` doesn't return any events after process exit, PTY master can still have more output.\n\nI initially came up with this speculation because I've seen this problem in multiple different tests. However I looked into [Linux kernel source code](https://github.com/torvalds/linux/blob/a95f71ad3e2e224277508e006580c333d0a5fe36/drivers/tty/n_tty.c#L2433-L2446) and found out that my analysis may be wrong.\n\nIt's possible that #37984 actually fixed the problem with the other tests, and the flaky test mentioned in this issue is caused by some other factor related to the TUI client, especially considering that this test sometimes fails in a different way:\n```\nFAILED   1 test, listed below:\nFAILED   test/functional/terminal/tui_spec.lua @ 2552: TUI no assert failure on deadly signal #21896\ntest/functional/terminal/tui_spec.lua:2554: Row 1 did not match.\nExpected:\n  |*Nvim: Caught deadly signal 'SIGTERM'              |\n  |*                                                  |\n  |*[Process exited 1]^                                |\n  |*                                                  |\n  |*                                                  |\n  |                                                  |\n  |{5:-- TERMINAL --}                                    |\nActual:\n  |*                                                  |\n  |*[Process exited 1]{100:^                                }|\n  |*{100:~                                                 }|\n  |*{100:~                                                 }|\n  |*{3:[No Name]                                         }|\n  |                                                  |\n  |{5:-- TERMINAL --}                                    |\n```\nHere it appears that the client didn't exit alternate screen. I'm not sure how that can happen, as the signal is only sent to the client, so the server shouldn't exit until the client does, and the client should exit normally. I've seem this one on both Linux and FreeBSD CI, but not on macOS.",
            "created_at": "2026-02-21T00:40:52Z",
            "html_url": "https://github.com/neovim/neovim/issues/37982#issuecomment-3937790015",
            "id": 3937790015,
            "issue_url": "https://api.github.com/repos/neovim/neovim/issues/37982",
            "node_id": "IC_kwDOAPphoM7qteg_",
            "performed_via_github_app": null,
            "pin": null,
            "reactions": {
                "+1": 1,
                "-1": 0,
                "confused": 0,
                "eyes": 0,
                "heart": 0,
                "hooray": 0,
                "laugh": 0,
                "rocket": 0,
                "total_count": 1,
                "url": "https://api.github.com/repos/neovim/neovim/issues/comments/3937790015/reactions"
            },
            "updated_at": "2026-02-21T00:47:41Z",
            "url": "https://api.github.com/repos/neovim/neovim/issues/comments/3937790015",
            "user": {
                "avatar_url": "https://avatars.githubusercontent.com/u/35768171?v=4",
                "events_url": "https://api.github.com/users/zeertzjq/events{/privacy}",
                "followers_url": "https://api.github.com/users/zeertzjq/followers",
                "following_url": "https://api.github.com/users/zeertzjq/following{/other_user}",
                "gists_url": "https://api.github.com/users/zeertzjq/gists{/gist_id}",
                "gravatar_id": "",
                "html_url": "https://github.com/zeertzjq",
                "id": 35768171,
                "login": "zeertzjq",
                "node_id": "MDQ6VXNlcjM1NzY4MTcx",
                "organizations_url": "https://api.github.com/users/zeertzjq/orgs",
                "received_events_url": "https://api.github.com/users/zeertzjq/received_events",
                "repos_url": "https://api.github.com/users/zeertzjq/repos",
                "site_admin": false,
                "starred_url": "https://api.github.com/users/zeertzjq/starred{/owner}{/repo}",
                "subscriptions_url": "https://api.github.com/users/zeertzjq/subscriptions",
                "type": "User",
                "url": "https://api.github.com/users/zeertzjq",
                "user_view_type": "public"
            }
        },
        {
            "author_association": "MEMBER",
            "body": "Hmm, even with #37984 reverted, I cannot reproduce two other flaky tests I previously observed...",
            "created_at": "2026-02-21T01:47:14Z",
            "html_url": "https://github.com/neovim/neovim/issues/37982#issuecomment-3937895806",
            "id": 3937895806,
            "issue_url": "https://api.github.com/repos/neovim/neovim/issues/37982",
            "node_id": "IC_kwDOAPphoM7qt4V-",
            "performed_via_github_app": null,
            "pin": null,
            "reactions": {
                "+1": 0,
                "-1": 0,
                "confused": 0,
                "eyes": 0,
                "heart": 0,
                "hooray": 0,
                "laugh": 0,
                "rocket": 0,
                "total_count": 0,
                "url": "https://api.github.com/repos/neovim/neovim/issues/comments/3937895806/reactions"
            },
            "updated_at": "2026-02-21T01:47:14Z",
            "url": "https://api.github.com/repos/neovim/neovim/issues/comments/3937895806",
            "user": {
                "avatar_url": "https://avatars.githubusercontent.com/u/35768171?v=4",
                "events_url": "https://api.github.com/users/zeertzjq/events{/privacy}",
                "followers_url": "https://api.github.com/users/zeertzjq/followers",
                "following_url": "https://api.github.com/users/zeertzjq/following{/other_user}",
                "gists_url": "https://api.github.com/users/zeertzjq/gists{/gist_id}",
                "gravatar_id": "",
                "html_url": "https://github.com/zeertzjq",
                "id": 35768171,
                "login": "zeertzjq",
                "node_id": "MDQ6VXNlcjM1NzY4MTcx",
                "organizations_url": "https://api.github.com/users/zeertzjq/orgs",
                "received_events_url": "https://api.github.com/users/zeertzjq/received_events",
                "repos_url": "https://api.github.com/users/zeertzjq/repos",
                "site_admin": false,
                "starred_url": "https://api.github.com/users/zeertzjq/starred{/owner}{/repo}",
                "subscriptions_url": "https://api.github.com/users/zeertzjq/subscriptions",
                "type": "User",
                "url": "https://api.github.com/users/zeertzjq",
                "user_view_type": "public"
            }
        }
    ],
    "comments": 3,
    "comments_url": "https://api.github.com/repos/neovim/neovim/issues/37982/comments",
    "created_at": "2026-02-20T08:46:05Z",
    "events_url": "https://api.github.com/repos/neovim/neovim/issues/37982/events",
    "html_url": "https://github.com/neovim/neovim/issues/37982",
    "id": 3967344668,
    "issue_dependencies_summary": {
        "blocked_by": 0,
        "blocking": 0,
        "total_blocked_by": 0,
        "total_blocking": 0
    },
    "labels": [
        {
            "color": "c5def5",
            "default": false,
            "description": "OS processes, spawn",
            "id": 182884815,
            "name": "job-control",
            "node_id": "MDU6TGFiZWwxODI4ODQ4MTU=",
            "url": "https://api.github.com/repos/neovim/neovim/labels/job-control"
        },
        {
            "color": "c5def5",
            "default": false,
            "description": "built-in :terminal or :shell, PTY",
            "id": 212696822,
            "name": "terminal",
            "node_id": "MDU6TGFiZWwyMTI2OTY4MjI=",
            "url": "https://api.github.com/repos/neovim/neovim/labels/terminal"
        },
        {
            "color": "c7def8",
            "default": false,
            "description": "channels, RPC, msgpack",
            "id": 242522707,
            "name": "channels-rpc",
            "node_id": "MDU6TGFiZWwyNDI1MjI3MDc=",
            "url": "https://api.github.com/repos/neovim/neovim/labels/channels-rpc"
        },
        {
            "color": "d4c5f9",
            "default": false,
            "description": null,
            "id": 314665132,
            "name": "platform:linux",
            "node_id": "MDU6TGFiZWwzMTQ2NjUxMzI=",
            "url": "https://api.github.com/repos/neovim/neovim/labels/platform:linux"
        }
    ],
    "labels_url": "https://api.github.com/repos/neovim/neovim/issues/37982/labels{/name}",
    "locked": false,
    "milestone": {
        "closed_at": null,
        "closed_issues": 258,
        "created_at": "2024-05-16T14:11:54Z",
        "creator": {
            "avatar_url": "https://avatars.githubusercontent.com/u/1359421?v=4",
            "events_url": "https://api.github.com/users/justinmk/events{/privacy}",
            "followers_url": "https://api.github.com/users/justinmk/followers",
            "following_url": "https://api.github.com/users/justinmk/following{/other_user}",
            "gists_url": "https://api.github.com/users/justinmk/gists{/gist_id}",
            "gravatar_id": "",
            "html_url": "https://github.com/justinmk",
            "id": 1359421,
            "login": "justinmk",
            "node_id": "MDQ6VXNlcjEzNTk0MjE=",
            "organizations_url": "https://api.github.com/users/justinmk/orgs",
            "received_events_url": "https://api.github.com/users/justinmk/received_events",
            "repos_url": "https://api.github.com/users/justinmk/repos",
            "site_admin": false,
            "starred_url": "https://api.github.com/users/justinmk/starred{/owner}{/repo}",
            "subscriptions_url": "https://api.github.com/users/justinmk/subscriptions",
            "type": "User",
            "url": "https://api.github.com/users/justinmk",
            "user_view_type": "public"
        },
        "description": "",
        "due_on": "2026-03-14T00:00:00Z",
        "html_url": "https://github.com/neovim/neovim/milestone/43",
        "id": 11063573,
        "labels_url": "https://api.github.com/repos/neovim/neovim/milestones/43/labels",
        "node_id": "MI_kwDOAPphoM4AqNEV",
        "number": 43,
        "open_issues": 51,
        "state": "open",
        "title": "0.12",
        "updated_at": "2026-02-23T14:54:57Z",
        "url": "https://api.github.com/repos/neovim/neovim/milestones/43"
    },
    "node_id": "I_kwDOAPphoM7seOAc",
    "number": 37982,
    "performed_via_github_app": null,
    "pinned_comment": null,
    "reactions": {
        "+1": 0,
        "-1": 0,
        "confused": 0,
        "eyes": 0,
        "heart": 0,
        "hooray": 0,
        "laugh": 0,
        "rocket": 0,
        "total_count": 0,
        "url": "https://api.github.com/repos/neovim/neovim/issues/37982/reactions"
    },
    "repository_url": "https://api.github.com/repos/neovim/neovim",
    "state": "closed",
    "state_reason": "completed",
    "sub_issues_summary": {
        "completed": 0,
        "percent_completed": 0,
        "total": 0
    },
    "timeline_url": "https://api.github.com/repos/neovim/neovim/issues/37982/timeline",
    "title": "PTY output may still be dropped after process exit on Linux",
    "type": {
        "color": "red",
        "created_at": "2024-01-25T10:10:19Z",
        "description": "An unexpected problem or behavior",
        "id": 597163,
        "is_enabled": true,
        "name": "Bug",
        "node_id": "IT_kwDOAGK_Pc4ACRyr",
        "updated_at": "2024-07-26T10:12:30Z"
    },
    "updated_at": "2026-02-22T23:15:40Z",
    "url": "https://api.github.com/repos/neovim/neovim/issues/37982",
    "user": {
        "avatar_url": "https://avatars.githubusercontent.com/u/35768171?v=4",
        "events_url": "https://api.github.com/users/zeertzjq/events{/privacy}",
        "followers_url": "https://api.github.com/users/zeertzjq/followers",
        "following_url": "https://api.github.com/users/zeertzjq/following{/other_user}",
        "gists_url": "https://api.github.com/users/zeertzjq/gists{/gist_id}",
        "gravatar_id": "",
        "html_url": "https://github.com/zeertzjq",
        "id": 35768171,
        "login": "zeertzjq",
        "node_id": "MDQ6VXNlcjM1NzY4MTcx",
        "organizations_url": "https://api.github.com/users/zeertzjq/orgs",
        "received_events_url": "https://api.github.com/users/zeertzjq/received_events",
        "repos_url": "https://api.github.com/users/zeertzjq/repos",
        "site_admin": false,
        "starred_url": "https://api.github.com/users/zeertzjq/starred{/owner}{/repo}",
        "subscriptions_url": "https://api.github.com/users/zeertzjq/subscriptions",
        "type": "User",
        "url": "https://api.github.com/users/zeertzjq",
        "user_view_type": "public"
    }
}