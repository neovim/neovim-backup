{
    "active_lock_reason": null,
    "assignee": null,
    "assignees": [],
    "author_association": "MEMBER",
    "body": "### Problem\n\nDespite the valiant efforts of #37325, I've found another instance where the output of `:term` can be dropped. This time from heavy `BufFilePost` events.\n\n### Steps to reproduce\n\n```lua\nlocal function wait_for_exit()\n  while true do\n    vim.wait(100)\n    local lines = vim.api.nvim_buf_get_lines(0, 0, -1, false)\n    for _, line in ipairs(lines) do\n      if vim.startswith(line, '[Process exited') then\n        return lines\n      end\n    end\n  end\nend\n\nlocal function main()\n  vim.cmd [=[\n  function! BigLoop() abort\n    let i = 0\n    while i < 100000\n      let i += 1\n    endwhile\n  endfunction\n  ]=]\n\n  local line_count = 10000\n\n  local payload = ('x'):rep(8)\n  local lines = {}\n  for i = 1, line_count do\n    lines[i] = ('line %04d %s'):format(i, payload)\n  end\n\n  local tmp = vim.fn.tempname()\n  local f = assert(io.open(tmp, 'w'))\n  for _, line in ipairs(lines) do\n    f:write(line, '\\n')\n  end\n  f:close()\n\n  vim.api.nvim_create_autocmd('BufFilePost', {\n    callback = function()\n      vim.cmd.call('BigLoop()')\n    end,\n  })\n\n  vim.cmd.term('cat ' .. tmp)\n\n  local lines = wait_for_exit()\n\n  for i = 1, line_count do\n    local prefix = string.format('line %04d', i)\n    assert(vim.startswith(lines[i], prefix), ('Line %d is wrong: %s'):format(i, lines[i]))\n  end\nend\n\nlocal ok, err = pcall(main)\n\nif not ok then\n  print(err)\n  os.exit(1)\nelse\n  os.exit(0)\nend\n```\n\n`nvim -u NONE --headless -c 'source min.lua'`\n\n\n### Expected behavior\n\n`:term cat` command prints entire contents of file.\n\n### Nvim version (nvim -v)\n\nNVIM v0.12.0-dev-2103+g95b03171d\n\n### Vim (not Nvim) behaves the same?\n\nNot checked\n\n### Operating system/version\n\nmacOS 15.7.3, rhel9.6\n\n### Terminal name/version\n\nna\n\n### $TERM environment variable\n\nna\n\n### Installation\n\nsource",
    "closed_at": null,
    "closed_by": null,
    "comment_data": [
        {
            "author_association": "MEMBER",
            "body": "For convenience, here a patch to apply the above testcase:\n\n```diff\ndiff --git a/test/functional/terminal/ex_terminal_spec.lua b/test/functional/terminal/ex_terminal_spec.lua\nindex 587b96bcd8..75977c4a12 100644\n--- a/test/functional/terminal/ex_terminal_spec.lua\n+++ b/test/functional/terminal/ex_terminal_spec.lua\n@@ -184,6 +184,57 @@ describe(':terminal', function()\n     api.nvim_set_current_buf(buf1)\n     eq({ blocking = false, mode = 't' }, api.nvim_get_mode())\n   end)\n+\n+  it('does not drop output when event loop is blocked', function()\n+    local line_count = 10000\n+\n+    local payload = ('x'):rep(8)\n+    local lines = {}\n+    for i = 1, line_count do\n+      lines[i] = ('line %04d %s'):format(i, payload)\n+    end\n+\n+    local path = t.tmpname()\n+    t.write_file(path, table.concat(lines, '\\n'))\n+\n+    local received = n.exec_lua(function()\n+      vim.cmd [=[\n+      function! BigLoop() abort\n+        let i = 0\n+        while i < 100000\n+          let i += 1\n+        endwhile\n+      endfunction\n+      ]=]\n+      vim.api.nvim_create_autocmd('BufFilePost', {\n+        callback = function()\n+          vim.cmd.call('BigLoop()')\n+        end,\n+      })\n+\n+      vim.cmd.term('cat ' .. vim.fn.shellescape(path))\n+\n+      local buf_lines\n+      local ok = vim.wait(10000, function()\n+        buf_lines = vim.api.nvim_buf_get_lines(0, 0, -1, false)\n+        for _, line in ipairs(buf_lines) do\n+          if vim.startswith(line, '[Process exited') then\n+            return true\n+          end\n+        end\n+        return false\n+      end, 10)\n+      assert(ok, 'terminal did not exit')\n+\n+      return buf_lines\n+    end)\n+\n+    lines[#lines + 1] = '[Process exited 0]'\n+\n+    vim.fs.rm(path)\n+\n+    eq(received, lines, string.format('expected %d lines, got %d', #lines, #received))\n+  end)\n end)\n \n local function test_terminal_with_fake_shell(backslash)\n```",
            "created_at": "2026-01-26T09:42:23Z",
            "html_url": "https://github.com/neovim/neovim/issues/37559#issuecomment-3798680863",
            "id": 3798680863,
            "issue_url": "https://api.github.com/repos/neovim/neovim/issues/37559",
            "node_id": "IC_kwDOAPphoM7ia0Uf",
            "performed_via_github_app": null,
            "reactions": {
                "+1": 0,
                "-1": 0,
                "confused": 0,
                "eyes": 0,
                "heart": 0,
                "hooray": 0,
                "laugh": 0,
                "rocket": 0,
                "total_count": 0,
                "url": "https://api.github.com/repos/neovim/neovim/issues/comments/3798680863/reactions"
            },
            "updated_at": "2026-01-26T09:42:23Z",
            "url": "https://api.github.com/repos/neovim/neovim/issues/comments/3798680863",
            "user": {
                "avatar_url": "https://avatars.githubusercontent.com/u/7904185?v=4",
                "events_url": "https://api.github.com/users/lewis6991/events{/privacy}",
                "followers_url": "https://api.github.com/users/lewis6991/followers",
                "following_url": "https://api.github.com/users/lewis6991/following{/other_user}",
                "gists_url": "https://api.github.com/users/lewis6991/gists{/gist_id}",
                "gravatar_id": "",
                "html_url": "https://github.com/lewis6991",
                "id": 7904185,
                "login": "lewis6991",
                "node_id": "MDQ6VXNlcjc5MDQxODU=",
                "organizations_url": "https://api.github.com/users/lewis6991/orgs",
                "received_events_url": "https://api.github.com/users/lewis6991/received_events",
                "repos_url": "https://api.github.com/users/lewis6991/repos",
                "site_admin": false,
                "starred_url": "https://api.github.com/users/lewis6991/starred{/owner}{/repo}",
                "subscriptions_url": "https://api.github.com/users/lewis6991/subscriptions",
                "type": "User",
                "url": "https://api.github.com/users/lewis6991",
                "user_view_type": "public"
            }
        },
        {
            "author_association": "MEMBER",
            "body": "Vibe coded fix:\n\n```diff\ndiff --git a/src/nvim/channel.c b/src/nvim/channel.c\nindex e417e14d5b..3a836d6951 100644\n--- a/src/nvim/channel.c\n+++ b/src/nvim/channel.c\n@@ -38,6 +38,8 @@\n #include \"nvim/memory_defs.h\"\n #include \"nvim/message.h\"\n #include \"nvim/msgpack_rpc/channel.h\"\n+// Max bytes of PTY output to buffer before terminal attaches.\n+#define TERM_PENDING_LIMIT (1024 * 1024)\n #include \"nvim/msgpack_rpc/server.h\"\n #include \"nvim/os/fs.h\"\n #include \"nvim/os/os_defs.h\"\n@@ -220,6 +222,8 @@ Channel *channel_alloc(ChannelStreamType type)\n   chan->exit_status = -1;\n   chan->streamtype = type;\n   chan->detach = false;\n+  chan->term_pending_buf = (garray_T)GA_EMPTY_INIT_VALUE;\n+  chan->term_pending = false;\n   assert(chan->id <= VARNUMBER_MAX);\n   pmap_put(uint64_t)(&channels, chan->id, chan);\n   return chan;\n@@ -297,6 +301,7 @@ static void channel_destroy(Channel *chan)\n   callback_reader_free(&chan->on_data);\n   callback_reader_free(&chan->on_stderr);\n   callback_free(&chan->on_exit);\n+  ga_clear(&chan->term_pending_buf);\n \n   multiqueue_free(chan->events);\n   xfree(chan);\n@@ -659,7 +664,7 @@ size_t on_job_stderr(RStream *stream, const char *buf, size_t count, void *data,\n static size_t on_channel_output(RStream *stream, Channel *chan, const char *buf, size_t count,\n                                 bool eof, CallbackReader *reader)\n {\n-  if (chan->term) {\n+  if (chan->term || chan->term_pending) {\n     if (count) {\n       const char *p = buf;\n       const char *end = buf + count;\n@@ -674,8 +679,20 @@ static size_t on_channel_output(RStream *stream, Channel *chan, const char *buf,\n         p += clen;\n       }\n     }\n+  }\n \n+  if (chan->term) {\n     terminal_receive(chan->term, buf, count);\n+  } else if (chan->term_pending && count) {\n+    if (chan->term_pending_buf.ga_itemsize == 0) {\n+      ga_init(&chan->term_pending_buf, 1, 1024);\n+    }\n+    size_t pending_len = (size_t)chan->term_pending_buf.ga_len;\n+    if (pending_len < TERM_PENDING_LIMIT) {\n+      size_t avail = TERM_PENDING_LIMIT - pending_len;\n+      size_t to_copy = count < avail ? count : avail;\n+      ga_concat_len(&chan->term_pending_buf, buf, to_copy);\n+    }\n   }\n \n   if (eof) {\n@@ -831,6 +848,17 @@ void channel_terminal_open(buf_T *buf, Channel *chan)\n   buf->b_p_channel = (OptInt)chan->id;  // 'channel' option\n   channel_incref(chan);\n   terminal_open(&chan->term, buf, topts);\n+  if (chan->term_pending) {\n+    if (chan->term && chan->term_pending_buf.ga_len > 0) {\n+      terminal_receive(chan->term, chan->term_pending_buf.ga_data,\n+                       (size_t)chan->term_pending_buf.ga_len);\n+    }\n+    ga_clear(&chan->term_pending_buf);\n+    chan->term_pending = false;\n+  }\n+  if (chan->term && chan->exit_status >= 0) {\n+    terminal_close(&chan->term, chan->exit_status);\n+  }\n }\n \n static void term_write(const char *buf, size_t size, void *data)\ndiff --git a/src/nvim/channel.h b/src/nvim/channel.h\nindex 669b50cf86..78dafe0cfb 100644\n--- a/src/nvim/channel.h\n+++ b/src/nvim/channel.h\n@@ -36,6 +36,8 @@ struct Channel {\n                 ///< not FORCE self-exit.\n   RpcState rpc;\n   Terminal *term;\n+  garray_T term_pending_buf;\n+  bool term_pending;\n \n   CallbackReader on_data;\n   CallbackReader on_stderr;\ndiff --git a/src/nvim/eval/funcs.c b/src/nvim/eval/funcs.c\nindex 871794c4a1..2f914c1396 100644\n--- a/src/nvim/eval/funcs.c\n+++ b/src/nvim/eval/funcs.c\n@@ -3599,6 +3599,7 @@ void f_jobstart(typval_T *argvars, typval_T *rettv, EvalFuncData fptr)\n   } else if (!term) {\n     channel_create_event(chan, NULL);\n   } else {\n+    chan->term_pending = true;\n     if (rettv->vval.v_number <= 0) {\n       return;\n     }\n```\n\n\nOptional fix that AI kept insisting:\n\n```diff\ndiff --git a/src/nvim/event/proc.c b/src/nvim/event/proc.c\nindex eb8f2690a2..af16c6fdce 100644\n--- a/src/nvim/event/proc.c\n+++ b/src/nvim/event/proc.c\n@@ -391,8 +391,9 @@ static void flush_stream(Proc *proc, RStream *stream)\n \n   // Read remaining data.\n   while (!stream->s.closed && stream->num_bytes < max_bytes) {\n-    // Remember number of bytes before polling\n+    // Remember progress before polling\n     size_t num_bytes = stream->num_bytes;\n+    size_t available = rstream_available(stream);\n \n     // Poll for data and process the generated events.\n     loop_poll_events(proc->loop, 0);\n@@ -400,8 +401,9 @@ static void flush_stream(Proc *proc, RStream *stream)\n       multiqueue_process_events(stream->s.events);\n     }\n \n-    // Stream can be closed if it is empty.\n-    if (num_bytes == stream->num_bytes) {\n+    // Only treat the stream as drained if no progress and no buffered change.\n+    if (num_bytes == stream->num_bytes\n+        && available == rstream_available(stream)) {\n       if (stream->read_cb && !stream->did_eof) {\n         // Stream callback could miss EOF handling if a child keeps the stream\n         // open. But only send EOF if we haven't already.\n```",
            "created_at": "2026-01-26T09:45:39Z",
            "html_url": "https://github.com/neovim/neovim/issues/37559#issuecomment-3798694738",
            "id": 3798694738,
            "issue_url": "https://api.github.com/repos/neovim/neovim/issues/37559",
            "node_id": "IC_kwDOAPphoM7ia3tS",
            "performed_via_github_app": null,
            "reactions": {
                "+1": 0,
                "-1": 0,
                "confused": 0,
                "eyes": 0,
                "heart": 0,
                "hooray": 0,
                "laugh": 0,
                "rocket": 0,
                "total_count": 0,
                "url": "https://api.github.com/repos/neovim/neovim/issues/comments/3798694738/reactions"
            },
            "updated_at": "2026-01-26T09:56:43Z",
            "url": "https://api.github.com/repos/neovim/neovim/issues/comments/3798694738",
            "user": {
                "avatar_url": "https://avatars.githubusercontent.com/u/7904185?v=4",
                "events_url": "https://api.github.com/users/lewis6991/events{/privacy}",
                "followers_url": "https://api.github.com/users/lewis6991/followers",
                "following_url": "https://api.github.com/users/lewis6991/following{/other_user}",
                "gists_url": "https://api.github.com/users/lewis6991/gists{/gist_id}",
                "gravatar_id": "",
                "html_url": "https://github.com/lewis6991",
                "id": 7904185,
                "login": "lewis6991",
                "node_id": "MDQ6VXNlcjc5MDQxODU=",
                "organizations_url": "https://api.github.com/users/lewis6991/orgs",
                "received_events_url": "https://api.github.com/users/lewis6991/received_events",
                "repos_url": "https://api.github.com/users/lewis6991/repos",
                "site_admin": false,
                "starred_url": "https://api.github.com/users/lewis6991/starred{/owner}{/repo}",
                "subscriptions_url": "https://api.github.com/users/lewis6991/subscriptions",
                "type": "User",
                "url": "https://api.github.com/users/lewis6991",
                "user_view_type": "public"
            }
        },
        {
            "author_association": "MEMBER",
            "body": "Related #19408",
            "created_at": "2026-01-26T11:40:34Z",
            "html_url": "https://github.com/neovim/neovim/issues/37559#issuecomment-3799143142",
            "id": 3799143142,
            "issue_url": "https://api.github.com/repos/neovim/neovim/issues/37559",
            "node_id": "IC_kwDOAPphoM7iclLm",
            "performed_via_github_app": null,
            "reactions": {
                "+1": 0,
                "-1": 0,
                "confused": 0,
                "eyes": 0,
                "heart": 0,
                "hooray": 0,
                "laugh": 0,
                "rocket": 0,
                "total_count": 0,
                "url": "https://api.github.com/repos/neovim/neovim/issues/comments/3799143142/reactions"
            },
            "updated_at": "2026-01-26T11:40:34Z",
            "url": "https://api.github.com/repos/neovim/neovim/issues/comments/3799143142",
            "user": {
                "avatar_url": "https://avatars.githubusercontent.com/u/35768171?v=4",
                "events_url": "https://api.github.com/users/zeertzjq/events{/privacy}",
                "followers_url": "https://api.github.com/users/zeertzjq/followers",
                "following_url": "https://api.github.com/users/zeertzjq/following{/other_user}",
                "gists_url": "https://api.github.com/users/zeertzjq/gists{/gist_id}",
                "gravatar_id": "",
                "html_url": "https://github.com/zeertzjq",
                "id": 35768171,
                "login": "zeertzjq",
                "node_id": "MDQ6VXNlcjM1NzY4MTcx",
                "organizations_url": "https://api.github.com/users/zeertzjq/orgs",
                "received_events_url": "https://api.github.com/users/zeertzjq/received_events",
                "repos_url": "https://api.github.com/users/zeertzjq/repos",
                "site_admin": false,
                "starred_url": "https://api.github.com/users/zeertzjq/starred{/owner}{/repo}",
                "subscriptions_url": "https://api.github.com/users/zeertzjq/subscriptions",
                "type": "User",
                "url": "https://api.github.com/users/zeertzjq",
                "user_view_type": "public"
            }
        },
        {
            "author_association": "MEMBER",
            "body": "> Optional fix that AI kept insisting:\n\nThis change seems not currently needed as `on_channel_output()` always consumes all output.",
            "created_at": "2026-01-26T23:58:00Z",
            "html_url": "https://github.com/neovim/neovim/issues/37559#issuecomment-3802348673",
            "id": 3802348673,
            "issue_url": "https://api.github.com/repos/neovim/neovim/issues/37559",
            "node_id": "IC_kwDOAPphoM7iozyB",
            "performed_via_github_app": null,
            "reactions": {
                "+1": 0,
                "-1": 0,
                "confused": 0,
                "eyes": 0,
                "heart": 0,
                "hooray": 0,
                "laugh": 0,
                "rocket": 0,
                "total_count": 0,
                "url": "https://api.github.com/repos/neovim/neovim/issues/comments/3802348673/reactions"
            },
            "updated_at": "2026-01-26T23:58:00Z",
            "url": "https://api.github.com/repos/neovim/neovim/issues/comments/3802348673",
            "user": {
                "avatar_url": "https://avatars.githubusercontent.com/u/35768171?v=4",
                "events_url": "https://api.github.com/users/zeertzjq/events{/privacy}",
                "followers_url": "https://api.github.com/users/zeertzjq/followers",
                "following_url": "https://api.github.com/users/zeertzjq/following{/other_user}",
                "gists_url": "https://api.github.com/users/zeertzjq/gists{/gist_id}",
                "gravatar_id": "",
                "html_url": "https://github.com/zeertzjq",
                "id": 35768171,
                "login": "zeertzjq",
                "node_id": "MDQ6VXNlcjM1NzY4MTcx",
                "organizations_url": "https://api.github.com/users/zeertzjq/orgs",
                "received_events_url": "https://api.github.com/users/zeertzjq/received_events",
                "repos_url": "https://api.github.com/users/zeertzjq/repos",
                "site_admin": false,
                "starred_url": "https://api.github.com/users/zeertzjq/starred{/owner}{/repo}",
                "subscriptions_url": "https://api.github.com/users/zeertzjq/subscriptions",
                "type": "User",
                "url": "https://api.github.com/users/zeertzjq",
                "user_view_type": "public"
            }
        }
    ],
    "comments": 4,
    "comments_url": "https://api.github.com/repos/neovim/neovim/issues/37559/comments",
    "created_at": "2026-01-26T09:40:09Z",
    "events_url": "https://api.github.com/repos/neovim/neovim/issues/37559/events",
    "html_url": "https://github.com/neovim/neovim/issues/37559",
    "id": 3855209172,
    "issue_dependencies_summary": {
        "blocked_by": 0,
        "blocking": 0,
        "total_blocked_by": 0,
        "total_blocking": 0
    },
    "labels": [
        {
            "color": "c5def5",
            "default": false,
            "description": "OS processes, spawn",
            "id": 182884815,
            "name": "job-control",
            "node_id": "MDU6TGFiZWwxODI4ODQ4MTU=",
            "url": "https://api.github.com/repos/neovim/neovim/labels/job-control"
        },
        {
            "color": "c5def5",
            "default": false,
            "description": "built-in :terminal or :shell",
            "id": 212696822,
            "name": "terminal",
            "node_id": "MDU6TGFiZWwyMTI2OTY4MjI=",
            "url": "https://api.github.com/repos/neovim/neovim/labels/terminal"
        }
    ],
    "labels_url": "https://api.github.com/repos/neovim/neovim/issues/37559/labels{/name}",
    "locked": false,
    "milestone": null,
    "node_id": "I_kwDOAPphoM7lydLU",
    "number": 37559,
    "performed_via_github_app": null,
    "reactions": {
        "+1": 0,
        "-1": 0,
        "confused": 0,
        "eyes": 0,
        "heart": 0,
        "hooray": 0,
        "laugh": 0,
        "rocket": 0,
        "total_count": 0,
        "url": "https://api.github.com/repos/neovim/neovim/issues/37559/reactions"
    },
    "repository_url": "https://api.github.com/repos/neovim/neovim",
    "state": "open",
    "state_reason": null,
    "sub_issues_summary": {
        "completed": 0,
        "percent_completed": 0,
        "total": 0
    },
    "timeline_url": "https://api.github.com/repos/neovim/neovim/issues/37559/timeline",
    "title": "`BufFilePost` events can cause `:term` to lose output.",
    "type": {
        "color": "red",
        "created_at": "2024-01-25T10:10:19Z",
        "description": "An unexpected problem or behavior",
        "id": 597163,
        "is_enabled": true,
        "name": "Bug",
        "node_id": "IT_kwDOAGK_Pc4ACRyr",
        "updated_at": "2024-07-26T10:12:30Z"
    },
    "updated_at": "2026-01-26T23:58:01Z",
    "url": "https://api.github.com/repos/neovim/neovim/issues/37559",
    "user": {
        "avatar_url": "https://avatars.githubusercontent.com/u/7904185?v=4",
        "events_url": "https://api.github.com/users/lewis6991/events{/privacy}",
        "followers_url": "https://api.github.com/users/lewis6991/followers",
        "following_url": "https://api.github.com/users/lewis6991/following{/other_user}",
        "gists_url": "https://api.github.com/users/lewis6991/gists{/gist_id}",
        "gravatar_id": "",
        "html_url": "https://github.com/lewis6991",
        "id": 7904185,
        "login": "lewis6991",
        "node_id": "MDQ6VXNlcjc5MDQxODU=",
        "organizations_url": "https://api.github.com/users/lewis6991/orgs",
        "received_events_url": "https://api.github.com/users/lewis6991/received_events",
        "repos_url": "https://api.github.com/users/lewis6991/repos",
        "site_admin": false,
        "starred_url": "https://api.github.com/users/lewis6991/starred{/owner}{/repo}",
        "subscriptions_url": "https://api.github.com/users/lewis6991/subscriptions",
        "type": "User",
        "url": "https://api.github.com/users/lewis6991",
        "user_view_type": "public"
    }
}