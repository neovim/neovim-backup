{
    "active_lock_reason": null,
    "assignee": null,
    "assignees": [],
    "author_association": "NONE",
    "body": "### Problem\n\nI was working on a complete refactoring of a code base, and I noticed that in some specific circumstances accepting the completion for the `#include ` statement triggers a `nil` error in the LSP runtime.\n\nI attach a video that reproduces the exact steps.\n\nI just decided to go for manual Nvim installation yesterday.\nI am happy to provide a fix, but I'd first need to understand how to properly debug the issue.\nI will check documentation, but if anyone has hands-on suggestions on how this is best done, are well accepted.\n\nFrom a first shallow code inspection, I think the issue is that the faulty code line is trying to get the length of the next row, which for some reasons happens to be higher than the actual N. of rows.   \n\n### Steps to reproduce\n\nSee the video.\n\n### Expected behavior\n\nNo error should happen.\n\nhttps://github.com/user-attachments/assets/4987e728-c91d-423d-a24d-e2f540fc047e\n\n<img width=\"1515\" height=\"311\" alt=\"Image\" src=\"https://github.com/user-attachments/assets/e7f91abd-7a3d-4e0f-b15a-45da57ac363e\" />\n\n### Nvim version (nvim -v)\n\nNVIM v0.12.0-dev-1889+g 1aa26f5d55\n\n### Vim (not Nvim) behaves the same?\n\nNA\n\n### Operating system/version\n\nUbuntu 22.04\n\n### Terminal name/version\n\nGNOME terminal 3.44.0 using VTE 0.68.0 +BIDI +GNUTLS +ICU +SYSTEMD\n\n### $TERM environment variable\n\nxterm-256color\n\n### Installation\n\nBuild from repo",
    "closed_at": null,
    "closed_by": null,
    "comment_data": [
        {
            "author_association": "MEMBER",
            "body": "`once_buf_loaded` was modified recently. could be a regression from https://github.com/neovim/neovim/pull/34014 @faergeek , can we just handle this case to avoid the nil reference?",
            "created_at": "2025-12-26T04:49:29Z",
            "html_url": "https://github.com/neovim/neovim/issues/37090#issuecomment-3692093408",
            "id": 3692093408,
            "issue_url": "https://api.github.com/repos/neovim/neovim/issues/37090",
            "node_id": "IC_kwDOAPphoM7cEN_g",
            "performed_via_github_app": null,
            "reactions": {
                "+1": 0,
                "-1": 0,
                "confused": 0,
                "eyes": 0,
                "heart": 0,
                "hooray": 0,
                "laugh": 0,
                "rocket": 0,
                "total_count": 0,
                "url": "https://api.github.com/repos/neovim/neovim/issues/comments/3692093408/reactions"
            },
            "updated_at": "2025-12-26T04:50:06Z",
            "url": "https://api.github.com/repos/neovim/neovim/issues/comments/3692093408",
            "user": {
                "avatar_url": "https://avatars.githubusercontent.com/u/1359421?v=4",
                "events_url": "https://api.github.com/users/justinmk/events{/privacy}",
                "followers_url": "https://api.github.com/users/justinmk/followers",
                "following_url": "https://api.github.com/users/justinmk/following{/other_user}",
                "gists_url": "https://api.github.com/users/justinmk/gists{/gist_id}",
                "gravatar_id": "",
                "html_url": "https://github.com/justinmk",
                "id": 1359421,
                "login": "justinmk",
                "node_id": "MDQ6VXNlcjEzNTk0MjE=",
                "organizations_url": "https://api.github.com/users/justinmk/orgs",
                "received_events_url": "https://api.github.com/users/justinmk/received_events",
                "repos_url": "https://api.github.com/users/justinmk/repos",
                "site_admin": false,
                "starred_url": "https://api.github.com/users/justinmk/starred{/owner}{/repo}",
                "subscriptions_url": "https://api.github.com/users/justinmk/subscriptions",
                "type": "User",
                "url": "https://api.github.com/users/justinmk",
                "user_view_type": "public"
            }
        },
        {
            "author_association": "CONTRIBUTOR",
            "body": "I couldn't reproduce it myself with `clangd`. @miEsMar do you use something else or something extra for diagnostics in C? \n\nIf you want to debug it yourself, you could start by adding a `vim.print(diagnostic)` line inside the start of the loop here and check message contents prior to error, but it will be quite noisy https://github.com/neovim/neovim/blob/c03d635a1243287dd0a0b7d1f471ea12a5786a87/runtime/lua/vim/diagnostic.lua#L1328\n\nMy only guess of what has happened was that a diagnostic has been set with `lnum = -1, col = 0, end_lnum = 0, end_col = 0` or similar. But I've just checked it and it works fine since line and column numbers are clamped to be inside the buffer. \n\nThe error happens here according to a stacktrace https://github.com/neovim/neovim/blob/c03d635a1243287dd0a0b7d1f471ea12a5786a87/runtime/lua/vim/diagnostic.lua#L1347\n\n`end_row + 1` goes out of range of `lines`, but I don't really understand how it happens.",
            "created_at": "2025-12-26T05:58:02Z",
            "html_url": "https://github.com/neovim/neovim/issues/37090#issuecomment-3692193532",
            "id": 3692193532,
            "issue_url": "https://api.github.com/repos/neovim/neovim/issues/37090",
            "node_id": "IC_kwDOAPphoM7cEmb8",
            "performed_via_github_app": null,
            "reactions": {
                "+1": 0,
                "-1": 0,
                "confused": 0,
                "eyes": 0,
                "heart": 0,
                "hooray": 0,
                "laugh": 0,
                "rocket": 0,
                "total_count": 0,
                "url": "https://api.github.com/repos/neovim/neovim/issues/comments/3692193532/reactions"
            },
            "updated_at": "2025-12-26T05:58:02Z",
            "url": "https://api.github.com/repos/neovim/neovim/issues/comments/3692193532",
            "user": {
                "avatar_url": "https://avatars.githubusercontent.com/u/3524621?v=4",
                "events_url": "https://api.github.com/users/faergeek/events{/privacy}",
                "followers_url": "https://api.github.com/users/faergeek/followers",
                "following_url": "https://api.github.com/users/faergeek/following{/other_user}",
                "gists_url": "https://api.github.com/users/faergeek/gists{/gist_id}",
                "gravatar_id": "",
                "html_url": "https://github.com/faergeek",
                "id": 3524621,
                "login": "faergeek",
                "node_id": "MDQ6VXNlcjM1MjQ2MjE=",
                "organizations_url": "https://api.github.com/users/faergeek/orgs",
                "received_events_url": "https://api.github.com/users/faergeek/received_events",
                "repos_url": "https://api.github.com/users/faergeek/repos",
                "site_admin": false,
                "starred_url": "https://api.github.com/users/faergeek/starred{/owner}{/repo}",
                "subscriptions_url": "https://api.github.com/users/faergeek/subscriptions",
                "type": "User",
                "url": "https://api.github.com/users/faergeek",
                "user_view_type": "public"
            }
        },
        {
            "author_association": "NONE",
            "body": "@faergeek I am trying to set up a repro, but yeah, it is not easy since, as said, this happens under very specific circumstances.\nBasically, I was splitting a big header into separate .h/.c files, and as shown in the capture, the issue seems to only happen by the time, in the recently created .c file, I first tried to include its relative .h file.\nThe issue did not show up if later I did the same action for other .h files, or even, deleting all includes and starting over, likely suggesting that yes, it has to do with first buffer loading.\nPutting that print does not help much, other than cluttering the screen with not so much useful insights.",
            "created_at": "2025-12-26T09:08:05Z",
            "html_url": "https://github.com/neovim/neovim/issues/37090#issuecomment-3692522913",
            "id": 3692522913,
            "issue_url": "https://api.github.com/repos/neovim/neovim/issues/37090",
            "node_id": "IC_kwDOAPphoM7cF22h",
            "performed_via_github_app": null,
            "reactions": {
                "+1": 0,
                "-1": 0,
                "confused": 0,
                "eyes": 0,
                "heart": 0,
                "hooray": 0,
                "laugh": 0,
                "rocket": 0,
                "total_count": 0,
                "url": "https://api.github.com/repos/neovim/neovim/issues/comments/3692522913/reactions"
            },
            "updated_at": "2025-12-26T09:08:05Z",
            "url": "https://api.github.com/repos/neovim/neovim/issues/comments/3692522913",
            "user": {
                "avatar_url": "https://avatars.githubusercontent.com/u/144672975?v=4",
                "events_url": "https://api.github.com/users/miEsMar/events{/privacy}",
                "followers_url": "https://api.github.com/users/miEsMar/followers",
                "following_url": "https://api.github.com/users/miEsMar/following{/other_user}",
                "gists_url": "https://api.github.com/users/miEsMar/gists{/gist_id}",
                "gravatar_id": "",
                "html_url": "https://github.com/miEsMar",
                "id": 144672975,
                "login": "miEsMar",
                "node_id": "U_kgDOCJ-Izw",
                "organizations_url": "https://api.github.com/users/miEsMar/orgs",
                "received_events_url": "https://api.github.com/users/miEsMar/received_events",
                "repos_url": "https://api.github.com/users/miEsMar/repos",
                "site_admin": false,
                "starred_url": "https://api.github.com/users/miEsMar/starred{/owner}{/repo}",
                "subscriptions_url": "https://api.github.com/users/miEsMar/subscriptions",
                "type": "User",
                "url": "https://api.github.com/users/miEsMar",
                "user_view_type": "public"
            }
        },
        {
            "author_association": "MEMBER",
            "body": "If we don't want to check-and-skip, let's at least add an `assert` that prints relevant values.",
            "created_at": "2026-01-02T07:14:48Z",
            "html_url": "https://github.com/neovim/neovim/issues/37090#issuecomment-3704649657",
            "id": 3704649657,
            "issue_url": "https://api.github.com/repos/neovim/neovim/issues/37090",
            "node_id": "IC_kwDOAPphoM7c0He5",
            "performed_via_github_app": null,
            "reactions": {
                "+1": 1,
                "-1": 0,
                "confused": 0,
                "eyes": 0,
                "heart": 0,
                "hooray": 0,
                "laugh": 0,
                "rocket": 0,
                "total_count": 1,
                "url": "https://api.github.com/repos/neovim/neovim/issues/comments/3704649657/reactions"
            },
            "updated_at": "2026-01-02T07:14:48Z",
            "url": "https://api.github.com/repos/neovim/neovim/issues/comments/3704649657",
            "user": {
                "avatar_url": "https://avatars.githubusercontent.com/u/1359421?v=4",
                "events_url": "https://api.github.com/users/justinmk/events{/privacy}",
                "followers_url": "https://api.github.com/users/justinmk/followers",
                "following_url": "https://api.github.com/users/justinmk/following{/other_user}",
                "gists_url": "https://api.github.com/users/justinmk/gists{/gist_id}",
                "gravatar_id": "",
                "html_url": "https://github.com/justinmk",
                "id": 1359421,
                "login": "justinmk",
                "node_id": "MDQ6VXNlcjEzNTk0MjE=",
                "organizations_url": "https://api.github.com/users/justinmk/orgs",
                "received_events_url": "https://api.github.com/users/justinmk/received_events",
                "repos_url": "https://api.github.com/users/justinmk/repos",
                "site_admin": false,
                "starred_url": "https://api.github.com/users/justinmk/starred{/owner}{/repo}",
                "subscriptions_url": "https://api.github.com/users/justinmk/subscriptions",
                "type": "User",
                "url": "https://api.github.com/users/justinmk",
                "user_view_type": "public"
            }
        },
        {
            "author_association": "CONTRIBUTOR",
            "body": "@justinmk I've added an assertion printing the number of lines in a buffer and diagnostic start and end positions in #37210. This should be enough to understand what inputs cause that error I think.",
            "created_at": "2026-01-03T02:31:29Z",
            "html_url": "https://github.com/neovim/neovim/issues/37090#issuecomment-3706618901",
            "id": 3706618901,
            "issue_url": "https://api.github.com/repos/neovim/neovim/issues/37090",
            "node_id": "IC_kwDOAPphoM7c7oQV",
            "performed_via_github_app": null,
            "reactions": {
                "+1": 0,
                "-1": 0,
                "confused": 0,
                "eyes": 0,
                "heart": 0,
                "hooray": 0,
                "laugh": 0,
                "rocket": 0,
                "total_count": 0,
                "url": "https://api.github.com/repos/neovim/neovim/issues/comments/3706618901/reactions"
            },
            "updated_at": "2026-01-03T02:31:29Z",
            "url": "https://api.github.com/repos/neovim/neovim/issues/comments/3706618901",
            "user": {
                "avatar_url": "https://avatars.githubusercontent.com/u/3524621?v=4",
                "events_url": "https://api.github.com/users/faergeek/events{/privacy}",
                "followers_url": "https://api.github.com/users/faergeek/followers",
                "following_url": "https://api.github.com/users/faergeek/following{/other_user}",
                "gists_url": "https://api.github.com/users/faergeek/gists{/gist_id}",
                "gravatar_id": "",
                "html_url": "https://github.com/faergeek",
                "id": 3524621,
                "login": "faergeek",
                "node_id": "MDQ6VXNlcjM1MjQ2MjE=",
                "organizations_url": "https://api.github.com/users/faergeek/orgs",
                "received_events_url": "https://api.github.com/users/faergeek/received_events",
                "repos_url": "https://api.github.com/users/faergeek/repos",
                "site_admin": false,
                "starred_url": "https://api.github.com/users/faergeek/starred{/owner}{/repo}",
                "subscriptions_url": "https://api.github.com/users/faergeek/subscriptions",
                "type": "User",
                "url": "https://api.github.com/users/faergeek",
                "user_view_type": "public"
            }
        }
    ],
    "comments": 5,
    "comments_url": "https://api.github.com/repos/neovim/neovim/issues/37090/comments",
    "created_at": "2025-12-24T11:09:23Z",
    "events_url": "https://api.github.com/repos/neovim/neovim/issues/37090/events",
    "html_url": "https://github.com/neovim/neovim/issues/37090",
    "id": 3760039710,
    "issue_dependencies_summary": {
        "blocked_by": 0,
        "blocking": 0,
        "total_blocked_by": 0,
        "total_blocking": 0
    },
    "labels": [
        {
            "color": "FBCA04",
            "default": false,
            "description": "We need minimal steps to reproduce the issue",
            "id": 298863445,
            "name": "needs:repro",
            "node_id": "MDU6TGFiZWwyOTg4NjM0NDU=",
            "url": "https://api.github.com/repos/neovim/neovim/labels/needs:repro"
        },
        {
            "color": "c5def5",
            "default": false,
            "description": null,
            "id": 662566370,
            "name": "lsp",
            "node_id": "MDU6TGFiZWw2NjI1NjYzNzA=",
            "url": "https://api.github.com/repos/neovim/neovim/labels/lsp"
        },
        {
            "color": "C5DEF5",
            "default": false,
            "description": "",
            "id": 3361645105,
            "name": "diagnostic",
            "node_id": "MDU6TGFiZWwzMzYxNjQ1MTA1",
            "url": "https://api.github.com/repos/neovim/neovim/labels/diagnostic"
        }
    ],
    "labels_url": "https://api.github.com/repos/neovim/neovim/issues/37090/labels{/name}",
    "locked": false,
    "milestone": {
        "closed_at": null,
        "closed_issues": 773,
        "created_at": "2014-05-10T20:43:04Z",
        "creator": {
            "avatar_url": "https://avatars.githubusercontent.com/u/1359421?v=4",
            "events_url": "https://api.github.com/users/justinmk/events{/privacy}",
            "followers_url": "https://api.github.com/users/justinmk/followers",
            "following_url": "https://api.github.com/users/justinmk/following{/other_user}",
            "gists_url": "https://api.github.com/users/justinmk/gists{/gist_id}",
            "gravatar_id": "",
            "html_url": "https://github.com/justinmk",
            "id": 1359421,
            "login": "justinmk",
            "node_id": "MDQ6VXNlcjEzNTk0MjE=",
            "organizations_url": "https://api.github.com/users/justinmk/orgs",
            "received_events_url": "https://api.github.com/users/justinmk/received_events",
            "repos_url": "https://api.github.com/users/justinmk/repos",
            "site_admin": false,
            "starred_url": "https://api.github.com/users/justinmk/starred{/owner}{/repo}",
            "subscriptions_url": "https://api.github.com/users/justinmk/subscriptions",
            "type": "User",
            "url": "https://api.github.com/users/justinmk",
            "user_view_type": "public"
        },
        "description": "Low priority items. We plan to work on this but don't have a target date.",
        "due_on": null,
        "html_url": "https://github.com/neovim/neovim/milestone/6",
        "id": 655037,
        "labels_url": "https://api.github.com/repos/neovim/neovim/milestones/6/labels",
        "node_id": "MDk6TWlsZXN0b25lNjU1MDM3",
        "number": 6,
        "open_issues": 637,
        "state": "open",
        "title": "backlog",
        "updated_at": "2026-01-26T23:03:14Z",
        "url": "https://api.github.com/repos/neovim/neovim/milestones/6"
    },
    "node_id": "I_kwDOAPphoM7gHace",
    "number": 37090,
    "performed_via_github_app": null,
    "reactions": {
        "+1": 0,
        "-1": 0,
        "confused": 0,
        "eyes": 0,
        "heart": 0,
        "hooray": 0,
        "laugh": 0,
        "rocket": 0,
        "total_count": 0,
        "url": "https://api.github.com/repos/neovim/neovim/issues/37090/reactions"
    },
    "repository_url": "https://api.github.com/repos/neovim/neovim",
    "state": "open",
    "state_reason": null,
    "sub_issues_summary": {
        "completed": 0,
        "percent_completed": 0,
        "total": 0
    },
    "timeline_url": "https://api.github.com/repos/neovim/neovim/issues/37090/timeline",
    "title": "nil reference error in vim.diagnostic after LSP completion of C `#include`",
    "type": {
        "color": "red",
        "created_at": "2024-01-25T10:10:19Z",
        "description": "An unexpected problem or behavior",
        "id": 597163,
        "is_enabled": true,
        "name": "Bug",
        "node_id": "IT_kwDOAGK_Pc4ACRyr",
        "updated_at": "2024-07-26T10:12:30Z"
    },
    "updated_at": "2026-01-26T13:27:04Z",
    "url": "https://api.github.com/repos/neovim/neovim/issues/37090",
    "user": {
        "avatar_url": "https://avatars.githubusercontent.com/u/144672975?v=4",
        "events_url": "https://api.github.com/users/miEsMar/events{/privacy}",
        "followers_url": "https://api.github.com/users/miEsMar/followers",
        "following_url": "https://api.github.com/users/miEsMar/following{/other_user}",
        "gists_url": "https://api.github.com/users/miEsMar/gists{/gist_id}",
        "gravatar_id": "",
        "html_url": "https://github.com/miEsMar",
        "id": 144672975,
        "login": "miEsMar",
        "node_id": "U_kgDOCJ-Izw",
        "organizations_url": "https://api.github.com/users/miEsMar/orgs",
        "received_events_url": "https://api.github.com/users/miEsMar/received_events",
        "repos_url": "https://api.github.com/users/miEsMar/repos",
        "site_admin": false,
        "starred_url": "https://api.github.com/users/miEsMar/starred{/owner}{/repo}",
        "subscriptions_url": "https://api.github.com/users/miEsMar/subscriptions",
        "type": "User",
        "url": "https://api.github.com/users/miEsMar",
        "user_view_type": "public"
    }
}