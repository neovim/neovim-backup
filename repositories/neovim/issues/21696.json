{
    "active_lock_reason": null,
    "assignee": null,
    "assignees": [],
    "author_association": "NONE",
    "body": "### Describe the bug\n\nIf you open a big text file, searching and replacing in a file can lock neovim up completely. \n\n### Steps to reproduce\n\n- Download zip archive under https://www3.stats.govt.nz/2018census/Age-sex-by-ethnic-group-grouped-total-responses-census-usually-resident-population-counts-2006-2013-2018-Censuses-RC-TA-SA2-DHB.zip\r\n- unpack Data8277.csv (857 MB)\r\n- nvim -u NONE Data8277.csv\r\n- :%s/20/30\n\n### Expected behavior\n\nNeovim instance will ramp up memory usage up to 5 GB over several minutes but will never finish. \r\nVim manages to do the replacement above in ~13 sec.\n\n### Neovim version (nvim -v)\n\n0.8.2\n\n### Vim (not Nvim) behaves the same?\n\nno, as of vim 9.0.639\n\n### Operating system/version\n\nmacOS 13.1\n\n### Terminal name/version\n\niTerm2 3.5.0beta8\n\n### $TERM environment variable\n\nxterm-256color\n\n### Installation\n\nhomebrew",
    "closed_at": null,
    "comment_data": [
        {
            "author_association": "MEMBER",
            "body": "Try `set inccommand=`. (Some expensive operations that are fine for average files and those within six standard deviations are obviously not feasible for outlier files.)",
            "created_at": "2023-01-08T22:14:10Z",
            "html_url": "https://github.com/neovim/neovim/issues/21696#issuecomment-1374941045",
            "id": 1374941045,
            "issue_url": "https://api.github.com/repos/neovim/neovim/issues/21696",
            "node_id": "IC_kwDOAPphoM5R8-91",
            "performed_via_github_app": null,
            "reactions": {
                "+1": 0,
                "-1": 0,
                "confused": 0,
                "eyes": 0,
                "heart": 0,
                "hooray": 0,
                "laugh": 0,
                "rocket": 0,
                "total_count": 0,
                "url": "https://api.github.com/repos/neovim/neovim/issues/comments/1374941045/reactions"
            },
            "updated_at": "2023-01-08T22:14:10Z",
            "url": "https://api.github.com/repos/neovim/neovim/issues/comments/1374941045",
            "user": {
                "avatar_url": "https://avatars.githubusercontent.com/u/2361214?v=4",
                "events_url": "https://api.github.com/users/clason/events{/privacy}",
                "followers_url": "https://api.github.com/users/clason/followers",
                "following_url": "https://api.github.com/users/clason/following{/other_user}",
                "gists_url": "https://api.github.com/users/clason/gists{/gist_id}",
                "gravatar_id": "",
                "html_url": "https://github.com/clason",
                "id": 2361214,
                "login": "clason",
                "node_id": "MDQ6VXNlcjIzNjEyMTQ=",
                "organizations_url": "https://api.github.com/users/clason/orgs",
                "received_events_url": "https://api.github.com/users/clason/received_events",
                "repos_url": "https://api.github.com/users/clason/repos",
                "site_admin": false,
                "starred_url": "https://api.github.com/users/clason/starred{/owner}{/repo}",
                "subscriptions_url": "https://api.github.com/users/clason/subscriptions",
                "type": "User",
                "url": "https://api.github.com/users/clason"
            }
        },
        {
            "author_association": "NONE",
            "body": "I've tried to start it with ```nvim -u NONE -c \"set inccommand=\" Data8277.csv```. If it is the right way to set it, then it had no effect. One thing I've noticed: vim takes mere seconds to ramp up to 4 GB ram, but neovim takes a long time to reach even 2 GB in memory. ",
            "created_at": "2023-01-08T22:27:32Z",
            "html_url": "https://github.com/neovim/neovim/issues/21696#issuecomment-1374944036",
            "id": 1374944036,
            "issue_url": "https://api.github.com/repos/neovim/neovim/issues/21696",
            "node_id": "IC_kwDOAPphoM5R8_sk",
            "performed_via_github_app": null,
            "reactions": {
                "+1": 0,
                "-1": 0,
                "confused": 0,
                "eyes": 0,
                "heart": 0,
                "hooray": 0,
                "laugh": 0,
                "rocket": 0,
                "total_count": 0,
                "url": "https://api.github.com/repos/neovim/neovim/issues/comments/1374944036/reactions"
            },
            "updated_at": "2023-01-08T22:27:32Z",
            "url": "https://api.github.com/repos/neovim/neovim/issues/comments/1374944036",
            "user": {
                "avatar_url": "https://avatars.githubusercontent.com/u/10035382?v=4",
                "events_url": "https://api.github.com/users/shartf/events{/privacy}",
                "followers_url": "https://api.github.com/users/shartf/followers",
                "following_url": "https://api.github.com/users/shartf/following{/other_user}",
                "gists_url": "https://api.github.com/users/shartf/gists{/gist_id}",
                "gravatar_id": "",
                "html_url": "https://github.com/shartf",
                "id": 10035382,
                "login": "shartf",
                "node_id": "MDQ6VXNlcjEwMDM1Mzgy",
                "organizations_url": "https://api.github.com/users/shartf/orgs",
                "received_events_url": "https://api.github.com/users/shartf/received_events",
                "repos_url": "https://api.github.com/users/shartf/repos",
                "site_admin": false,
                "starred_url": "https://api.github.com/users/shartf/starred{/owner}{/repo}",
                "subscriptions_url": "https://api.github.com/users/shartf/subscriptions",
                "type": "User",
                "url": "https://api.github.com/users/shartf"
            }
        },
        {
            "author_association": "CONTRIBUTOR",
            "body": "I've looked into it, and it seems that when [`ml_find_line_or_offset`](https://github.com/neovim/neovim/blob/24b60b0f71e0ffbd09c827230ecb5a37e833cade/src/nvim/memline.c#L3872) gets called on increasing line numbers, [this loop](https://github.com/neovim/neovim/blob/24b60b0f71e0ffbd09c827230ecb5a37e833cade/src/nvim/memline.c#LL3914C1-L3932C4) gets executed every time. I don't think the behaviour is exactly quadratic, but the number of times this loop is run does not increase linearly. `ml_find_line_or_offset` is called by [`extmark_splice`](https://github.com/neovim/neovim/blob/24b60b0f71e0ffbd09c827230ecb5a37e833cade/src/nvim/extmark.c#L585) and `extmark_splice` is called on every edit. I was thinking I could add a struct parameter to `ml_find_or_offset` and store the values computed in the loop so that subsequent calls to that function do not have to recompute from the start, but It would require threading that parameter through `extmark_splice` and `do_sub` and I'm not sure of the ergonomics.",
            "created_at": "2023-05-18T22:10:29Z",
            "html_url": "https://github.com/neovim/neovim/issues/21696#issuecomment-1553725993",
            "id": 1553725993,
            "issue_url": "https://api.github.com/repos/neovim/neovim/issues/21696",
            "node_id": "IC_kwDOAPphoM5cm_op",
            "performed_via_github_app": null,
            "reactions": {
                "+1": 0,
                "-1": 0,
                "confused": 0,
                "eyes": 0,
                "heart": 0,
                "hooray": 0,
                "laugh": 0,
                "rocket": 0,
                "total_count": 0,
                "url": "https://api.github.com/repos/neovim/neovim/issues/comments/1553725993/reactions"
            },
            "updated_at": "2023-05-18T22:10:56Z",
            "url": "https://api.github.com/repos/neovim/neovim/issues/comments/1553725993",
            "user": {
                "avatar_url": "https://avatars.githubusercontent.com/u/31444858?v=4",
                "events_url": "https://api.github.com/users/lorlouis/events{/privacy}",
                "followers_url": "https://api.github.com/users/lorlouis/followers",
                "following_url": "https://api.github.com/users/lorlouis/following{/other_user}",
                "gists_url": "https://api.github.com/users/lorlouis/gists{/gist_id}",
                "gravatar_id": "",
                "html_url": "https://github.com/lorlouis",
                "id": 31444858,
                "login": "lorlouis",
                "node_id": "MDQ6VXNlcjMxNDQ0ODU4",
                "organizations_url": "https://api.github.com/users/lorlouis/orgs",
                "received_events_url": "https://api.github.com/users/lorlouis/received_events",
                "repos_url": "https://api.github.com/users/lorlouis/repos",
                "site_admin": false,
                "starred_url": "https://api.github.com/users/lorlouis/starred{/owner}{/repo}",
                "subscriptions_url": "https://api.github.com/users/lorlouis/subscriptions",
                "type": "User",
                "url": "https://api.github.com/users/lorlouis"
            }
        }
    ],
    "comments": 3,
    "comments_url": "https://api.github.com/repos/neovim/neovim/issues/21696/comments",
    "created_at": "2023-01-08T22:10:47Z",
    "events_url": "https://api.github.com/repos/neovim/neovim/issues/21696/events",
    "html_url": "https://github.com/neovim/neovim/issues/21696",
    "id": 1524702266,
    "labels": [
        {
            "color": "f9d0c4",
            "default": true,
            "description": "issues reporting wrong behavior",
            "id": 77997474,
            "name": "bug",
            "node_id": "MDU6TGFiZWw3Nzk5NzQ3NA==",
            "url": "https://api.github.com/repos/neovim/neovim/labels/bug"
        },
        {
            "color": "FEF2C0",
            "default": false,
            "description": "issues reporting performance problems",
            "id": 101930601,
            "name": "performance",
            "node_id": "MDU6TGFiZWwxMDE5MzA2MDE=",
            "url": "https://api.github.com/repos/neovim/neovim/labels/performance"
        },
        {
            "color": "c5def5",
            "default": false,
            "description": "extmarks, decorations, virtual text, namespaces",
            "id": 1680119719,
            "name": "extmarks",
            "node_id": "MDU6TGFiZWwxNjgwMTE5NzE5",
            "url": "https://api.github.com/repos/neovim/neovim/labels/extmarks"
        }
    ],
    "labels_url": "https://api.github.com/repos/neovim/neovim/issues/21696/labels{/name}",
    "locked": false,
    "milestone": null,
    "node_id": "I_kwDOAPphoM5a4Rw6",
    "number": 21696,
    "performed_via_github_app": null,
    "reactions": {
        "+1": 2,
        "-1": 0,
        "confused": 0,
        "eyes": 0,
        "heart": 0,
        "hooray": 0,
        "laugh": 0,
        "rocket": 0,
        "total_count": 2,
        "url": "https://api.github.com/repos/neovim/neovim/issues/21696/reactions"
    },
    "repository_url": "https://api.github.com/repos/neovim/neovim",
    "state": "open",
    "state_reason": null,
    "timeline_url": "https://api.github.com/repos/neovim/neovim/issues/21696/timeline",
    "title": "search and replace locks up neovim on big files",
    "updated_at": "2023-07-28T04:47:31Z",
    "url": "https://api.github.com/repos/neovim/neovim/issues/21696",
    "user": {
        "avatar_url": "https://avatars.githubusercontent.com/u/10035382?v=4",
        "events_url": "https://api.github.com/users/shartf/events{/privacy}",
        "followers_url": "https://api.github.com/users/shartf/followers",
        "following_url": "https://api.github.com/users/shartf/following{/other_user}",
        "gists_url": "https://api.github.com/users/shartf/gists{/gist_id}",
        "gravatar_id": "",
        "html_url": "https://github.com/shartf",
        "id": 10035382,
        "login": "shartf",
        "node_id": "MDQ6VXNlcjEwMDM1Mzgy",
        "organizations_url": "https://api.github.com/users/shartf/orgs",
        "received_events_url": "https://api.github.com/users/shartf/received_events",
        "repos_url": "https://api.github.com/users/shartf/repos",
        "site_admin": false,
        "starred_url": "https://api.github.com/users/shartf/starred{/owner}{/repo}",
        "subscriptions_url": "https://api.github.com/users/shartf/subscriptions",
        "type": "User",
        "url": "https://api.github.com/users/shartf"
    }
}