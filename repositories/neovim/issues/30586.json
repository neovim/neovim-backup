{
    "active_lock_reason": null,
    "assignee": null,
    "assignees": [],
    "author_association": "CONTRIBUTOR",
    "body": "### Problem\n\nNeovim uses a hidden internal composition order, which determines the order the floating windows with the same z-index are drawn. Many UIs, including the very widespread telecope relies on this order to build the UIs. In particular, a there's no alpha blending between the windows of the same z-index, the last window in the index will always be used.\r\n\r\nA GUI like, Neovide, need to respect this order and do the same type of rendering, or things will look wrong. So that's in fact what we are doing right now, I reverse engineered the algorithm and duplicated it in Neovide [here](https://github.com/neovide/neovide/pull/2612). But it only works when the UI is connected from the start, and we receive absolutely all the events. It's also very fragile.\n\n### Expected behavior\n\nThe internal composition order is exposed in the UI protocol.\r\n\r\nNOTE: Another solution would be to require the whole plugin world to stop using overlapping z-indices. But this does still not work correctly in Neovide, because then we need a way to control the shadow casting and blur. Threating the whole z-index as one layer, is much easier to understand and does not require plugin authors to add additional Neovide specific annotations.",
    "closed_at": null,
    "closed_by": null,
    "comment_data": [
        {
            "author_association": "MEMBER",
            "body": "> Expected behavior: composition order is exposed in the UI protocol.\r\n\r\nWhat would this look like? An extra property in a UI event (which one)?\r\n\r\n~~In `:help ui-events` I don't see any explicit mention of z-index.~~ `win_float_pos` is documented as:\r\n\r\n> `[\"win_float_pos\", grid, win, anchor, anchor_grid, anchor_row, anchor_col, focusable] ~`\r\n>\r\n> \t... The window should be displayed above another grid `anchor_grid` at the specified position ...\r\n\r\nDo \"floating windows with the same z-index\" currently have the same `anchor_grid`? Perhaps that should be changed, so the internal composition order is reflected in `anchor_grid`?",
            "created_at": "2024-09-30T09:17:54Z",
            "html_url": "https://github.com/neovim/neovim/issues/30586#issuecomment-2382582161",
            "id": 2382582161,
            "issue_url": "https://api.github.com/repos/neovim/neovim/issues/30586",
            "node_id": "IC_kwDOAPphoM6OA1GR",
            "performed_via_github_app": null,
            "reactions": {
                "+1": 0,
                "-1": 0,
                "confused": 0,
                "eyes": 0,
                "heart": 0,
                "hooray": 0,
                "laugh": 0,
                "rocket": 0,
                "total_count": 0,
                "url": "https://api.github.com/repos/neovim/neovim/issues/comments/2382582161/reactions"
            },
            "updated_at": "2024-09-30T10:03:13Z",
            "url": "https://api.github.com/repos/neovim/neovim/issues/comments/2382582161",
            "user": {
                "avatar_url": "https://avatars.githubusercontent.com/u/1359421?v=4",
                "events_url": "https://api.github.com/users/justinmk/events{/privacy}",
                "followers_url": "https://api.github.com/users/justinmk/followers",
                "following_url": "https://api.github.com/users/justinmk/following{/other_user}",
                "gists_url": "https://api.github.com/users/justinmk/gists{/gist_id}",
                "gravatar_id": "",
                "html_url": "https://github.com/justinmk",
                "id": 1359421,
                "login": "justinmk",
                "node_id": "MDQ6VXNlcjEzNTk0MjE=",
                "organizations_url": "https://api.github.com/users/justinmk/orgs",
                "received_events_url": "https://api.github.com/users/justinmk/received_events",
                "repos_url": "https://api.github.com/users/justinmk/repos",
                "site_admin": false,
                "starred_url": "https://api.github.com/users/justinmk/starred{/owner}{/repo}",
                "subscriptions_url": "https://api.github.com/users/justinmk/subscriptions",
                "type": "User",
                "url": "https://api.github.com/users/justinmk"
            }
        },
        {
            "author_association": "CONTRIBUTOR",
            "body": "Hm, I see this in my help, and this is on the website as well https://neovim.io/doc/user/ui.html#ui-multigrid\r\n`[\"win_float_pos\", grid, win, anchor, anchor_grid, anchor_row, anchor_col, focusable, zindex]`\r\n\r\nSo, yes, another numerical property after `zindex` would be ideal. And it should be the same as the `comp_index` But, note that it's currently not updated when multgrid is enabled.\r\nhttps://github.com/neovim/neovim/blob/20251be15a4ad3f6e7016450ca3338d52b2f0951/src/nvim/grid_defs.h#L104\r\n\r\nI think that `anchor_grid` should remain an independent property, which, that should only affect the position. For example, you might want to render two windows side by side, and on top of some kind of frame window. So, you use anchor for position them next to each other, and the order to draw on top of the other window.\r\n\r\nAnother thing to note, is that the whole `comp_index` is unspecified and dependent on the implementation. But many plugins rely on the current implementation.  And at least this PR, will change a bit how it works https://github.com/neovim/neovim/pull/30259",
            "created_at": "2024-09-30T09:55:54Z",
            "html_url": "https://github.com/neovim/neovim/issues/30586#issuecomment-2382662877",
            "id": 2382662877,
            "issue_url": "https://api.github.com/repos/neovim/neovim/issues/30586",
            "node_id": "IC_kwDOAPphoM6OBIzd",
            "performed_via_github_app": null,
            "reactions": {
                "+1": 1,
                "-1": 0,
                "confused": 0,
                "eyes": 0,
                "heart": 0,
                "hooray": 0,
                "laugh": 0,
                "rocket": 0,
                "total_count": 1,
                "url": "https://api.github.com/repos/neovim/neovim/issues/comments/2382662877/reactions"
            },
            "updated_at": "2024-09-30T09:55:54Z",
            "url": "https://api.github.com/repos/neovim/neovim/issues/comments/2382662877",
            "user": {
                "avatar_url": "https://avatars.githubusercontent.com/u/9946255?v=4",
                "events_url": "https://api.github.com/users/fredizzimo/events{/privacy}",
                "followers_url": "https://api.github.com/users/fredizzimo/followers",
                "following_url": "https://api.github.com/users/fredizzimo/following{/other_user}",
                "gists_url": "https://api.github.com/users/fredizzimo/gists{/gist_id}",
                "gravatar_id": "",
                "html_url": "https://github.com/fredizzimo",
                "id": 9946255,
                "login": "fredizzimo",
                "node_id": "MDQ6VXNlcjk5NDYyNTU=",
                "organizations_url": "https://api.github.com/users/fredizzimo/orgs",
                "received_events_url": "https://api.github.com/users/fredizzimo/received_events",
                "repos_url": "https://api.github.com/users/fredizzimo/repos",
                "site_admin": false,
                "starred_url": "https://api.github.com/users/fredizzimo/starred{/owner}{/repo}",
                "subscriptions_url": "https://api.github.com/users/fredizzimo/subscriptions",
                "type": "User",
                "url": "https://api.github.com/users/fredizzimo"
            }
        },
        {
            "author_association": "MEMBER",
            "body": "> another numerical property after `zindex` would be ideal. And it should be the same as the `comp_index`\r\n\r\nIs it actually ideal, or would it make sense to adjust the `zindex` in the UI event? Though maybe that's complicated to implement in Nvim.",
            "created_at": "2024-09-30T10:06:24Z",
            "html_url": "https://github.com/neovim/neovim/issues/30586#issuecomment-2382685858",
            "id": 2382685858,
            "issue_url": "https://api.github.com/repos/neovim/neovim/issues/30586",
            "node_id": "IC_kwDOAPphoM6OBOai",
            "performed_via_github_app": null,
            "reactions": {
                "+1": 0,
                "-1": 0,
                "confused": 0,
                "eyes": 0,
                "heart": 0,
                "hooray": 0,
                "laugh": 0,
                "rocket": 0,
                "total_count": 0,
                "url": "https://api.github.com/repos/neovim/neovim/issues/comments/2382685858/reactions"
            },
            "updated_at": "2024-09-30T10:10:47Z",
            "url": "https://api.github.com/repos/neovim/neovim/issues/comments/2382685858",
            "user": {
                "avatar_url": "https://avatars.githubusercontent.com/u/1359421?v=4",
                "events_url": "https://api.github.com/users/justinmk/events{/privacy}",
                "followers_url": "https://api.github.com/users/justinmk/followers",
                "following_url": "https://api.github.com/users/justinmk/following{/other_user}",
                "gists_url": "https://api.github.com/users/justinmk/gists{/gist_id}",
                "gravatar_id": "",
                "html_url": "https://github.com/justinmk",
                "id": 1359421,
                "login": "justinmk",
                "node_id": "MDQ6VXNlcjEzNTk0MjE=",
                "organizations_url": "https://api.github.com/users/justinmk/orgs",
                "received_events_url": "https://api.github.com/users/justinmk/received_events",
                "repos_url": "https://api.github.com/users/justinmk/repos",
                "site_admin": false,
                "starred_url": "https://api.github.com/users/justinmk/starred{/owner}{/repo}",
                "subscriptions_url": "https://api.github.com/users/justinmk/subscriptions",
                "type": "User",
                "url": "https://api.github.com/users/justinmk"
            }
        },
        {
            "author_association": "CONTRIBUTOR",
            "body": "Yes, currently we need both. Z-index to group shadows and blur. And the composition order to decide which window, or part of it, should actually be rendered within the same index. Remember the assumption that Neovim makes, is that the blend always blends through everything, even if a floating window underneath has a solid cell. In Neovide we extend this slightly, so that each z-index can see a z-index underneath it, and cast shadows on top of it.\r\n\r\nOf course, this could also be done some other way, like introducing window groups, or additional window properties, but our current model is simple, and out of the box compatible with most plugins. And when it isn't easy to fix like this https://github.com/MunifTanjim/nui.nvim/pull/373.",
            "created_at": "2024-09-30T10:20:12Z",
            "html_url": "https://github.com/neovim/neovim/issues/30586#issuecomment-2382715677",
            "id": 2382715677,
            "issue_url": "https://api.github.com/repos/neovim/neovim/issues/30586",
            "node_id": "IC_kwDOAPphoM6OBVsd",
            "performed_via_github_app": null,
            "reactions": {
                "+1": 0,
                "-1": 0,
                "confused": 0,
                "eyes": 0,
                "heart": 0,
                "hooray": 0,
                "laugh": 0,
                "rocket": 0,
                "total_count": 0,
                "url": "https://api.github.com/repos/neovim/neovim/issues/comments/2382715677/reactions"
            },
            "updated_at": "2024-09-30T10:20:12Z",
            "url": "https://api.github.com/repos/neovim/neovim/issues/comments/2382715677",
            "user": {
                "avatar_url": "https://avatars.githubusercontent.com/u/9946255?v=4",
                "events_url": "https://api.github.com/users/fredizzimo/events{/privacy}",
                "followers_url": "https://api.github.com/users/fredizzimo/followers",
                "following_url": "https://api.github.com/users/fredizzimo/following{/other_user}",
                "gists_url": "https://api.github.com/users/fredizzimo/gists{/gist_id}",
                "gravatar_id": "",
                "html_url": "https://github.com/fredizzimo",
                "id": 9946255,
                "login": "fredizzimo",
                "node_id": "MDQ6VXNlcjk5NDYyNTU=",
                "organizations_url": "https://api.github.com/users/fredizzimo/orgs",
                "received_events_url": "https://api.github.com/users/fredizzimo/received_events",
                "repos_url": "https://api.github.com/users/fredizzimo/repos",
                "site_admin": false,
                "starred_url": "https://api.github.com/users/fredizzimo/starred{/owner}{/repo}",
                "subscriptions_url": "https://api.github.com/users/fredizzimo/subscriptions",
                "type": "User",
                "url": "https://api.github.com/users/fredizzimo"
            }
        },
        {
            "author_association": "MEMBER",
            "body": "> Yes, currently we need both. Z-index to group shadows and blur. And the composition order to decide which window, or part of it, should actually be rendered within the same index. Remember the assumption that Neovim makes, is that the blend always blends through everything, even if a floating window underneath has a solid cell. In Neovide we extend this slightly, so that each z-index can see a z-index underneath it, and cast shadows on top of it.\r\n\r\nThis is great info to include in the docs for the new field.",
            "created_at": "2024-09-30T10:24:36Z",
            "html_url": "https://github.com/neovim/neovim/issues/30586#issuecomment-2382724250",
            "id": 2382724250,
            "issue_url": "https://api.github.com/repos/neovim/neovim/issues/30586",
            "node_id": "IC_kwDOAPphoM6OBXya",
            "performed_via_github_app": null,
            "reactions": {
                "+1": 0,
                "-1": 0,
                "confused": 0,
                "eyes": 0,
                "heart": 0,
                "hooray": 0,
                "laugh": 0,
                "rocket": 0,
                "total_count": 0,
                "url": "https://api.github.com/repos/neovim/neovim/issues/comments/2382724250/reactions"
            },
            "updated_at": "2024-09-30T10:24:36Z",
            "url": "https://api.github.com/repos/neovim/neovim/issues/comments/2382724250",
            "user": {
                "avatar_url": "https://avatars.githubusercontent.com/u/1359421?v=4",
                "events_url": "https://api.github.com/users/justinmk/events{/privacy}",
                "followers_url": "https://api.github.com/users/justinmk/followers",
                "following_url": "https://api.github.com/users/justinmk/following{/other_user}",
                "gists_url": "https://api.github.com/users/justinmk/gists{/gist_id}",
                "gravatar_id": "",
                "html_url": "https://github.com/justinmk",
                "id": 1359421,
                "login": "justinmk",
                "node_id": "MDQ6VXNlcjEzNTk0MjE=",
                "organizations_url": "https://api.github.com/users/justinmk/orgs",
                "received_events_url": "https://api.github.com/users/justinmk/received_events",
                "repos_url": "https://api.github.com/users/justinmk/repos",
                "site_admin": false,
                "starred_url": "https://api.github.com/users/justinmk/starred{/owner}{/repo}",
                "subscriptions_url": "https://api.github.com/users/justinmk/subscriptions",
                "type": "User",
                "url": "https://api.github.com/users/justinmk"
            }
        }
    ],
    "comments": 5,
    "comments_url": "https://api.github.com/repos/neovim/neovim/issues/30586/comments",
    "created_at": "2024-09-29T19:58:24Z",
    "events_url": "https://api.github.com/repos/neovim/neovim/issues/30586/events",
    "html_url": "https://github.com/neovim/neovim/issues/30586",
    "id": 2555129549,
    "labels": [
        {
            "color": "c2e0c6",
            "default": true,
            "description": "feature request",
            "id": 77997476,
            "name": "enhancement",
            "node_id": "MDU6TGFiZWw3Nzk5NzQ3Ng==",
            "url": "https://api.github.com/repos/neovim/neovim/labels/enhancement"
        },
        {
            "color": "c5def5",
            "default": false,
            "description": "UI extensibility, events, protocol, externalized UI",
            "id": 640132777,
            "name": "ui-extensibility",
            "node_id": "MDU6TGFiZWw2NDAxMzI3Nzc=",
            "url": "https://api.github.com/repos/neovim/neovim/labels/ui-extensibility"
        },
        {
            "color": "C5DEF5",
            "default": false,
            "description": "floating windows, popups, hover",
            "id": 3234818716,
            "name": "floatwin",
            "node_id": "MDU6TGFiZWwzMjM0ODE4NzE2",
            "url": "https://api.github.com/repos/neovim/neovim/labels/floatwin"
        }
    ],
    "labels_url": "https://api.github.com/repos/neovim/neovim/issues/30586/labels{/name}",
    "locked": false,
    "milestone": {
        "closed_at": null,
        "closed_issues": 649,
        "created_at": "2014-05-10T20:43:04Z",
        "creator": {
            "avatar_url": "https://avatars.githubusercontent.com/u/1359421?v=4",
            "events_url": "https://api.github.com/users/justinmk/events{/privacy}",
            "followers_url": "https://api.github.com/users/justinmk/followers",
            "following_url": "https://api.github.com/users/justinmk/following{/other_user}",
            "gists_url": "https://api.github.com/users/justinmk/gists{/gist_id}",
            "gravatar_id": "",
            "html_url": "https://github.com/justinmk",
            "id": 1359421,
            "login": "justinmk",
            "node_id": "MDQ6VXNlcjEzNTk0MjE=",
            "organizations_url": "https://api.github.com/users/justinmk/orgs",
            "received_events_url": "https://api.github.com/users/justinmk/received_events",
            "repos_url": "https://api.github.com/users/justinmk/repos",
            "site_admin": false,
            "starred_url": "https://api.github.com/users/justinmk/starred{/owner}{/repo}",
            "subscriptions_url": "https://api.github.com/users/justinmk/subscriptions",
            "type": "User",
            "url": "https://api.github.com/users/justinmk"
        },
        "description": "Low priority items. We plan to work on this but don't have a target date.",
        "due_on": null,
        "html_url": "https://github.com/neovim/neovim/milestone/6",
        "id": 655037,
        "labels_url": "https://api.github.com/repos/neovim/neovim/milestones/6/labels",
        "node_id": "MDk6TWlsZXN0b25lNjU1MDM3",
        "number": 6,
        "open_issues": 589,
        "state": "open",
        "title": "backlog",
        "updated_at": "2024-09-30T17:10:20Z",
        "url": "https://api.github.com/repos/neovim/neovim/milestones/6"
    },
    "node_id": "I_kwDOAPphoM6YTC7N",
    "number": 30586,
    "performed_via_github_app": null,
    "reactions": {
        "+1": 0,
        "-1": 0,
        "confused": 0,
        "eyes": 0,
        "heart": 0,
        "hooray": 0,
        "laugh": 0,
        "rocket": 0,
        "total_count": 0,
        "url": "https://api.github.com/repos/neovim/neovim/issues/30586/reactions"
    },
    "repository_url": "https://api.github.com/repos/neovim/neovim",
    "state": "open",
    "state_reason": null,
    "timeline_url": "https://api.github.com/repos/neovim/neovim/issues/30586/timeline",
    "title": "UI protocol: expose floatwin composition order (comp_index) to UIs",
    "updated_at": "2024-09-30T10:24:38Z",
    "url": "https://api.github.com/repos/neovim/neovim/issues/30586",
    "user": {
        "avatar_url": "https://avatars.githubusercontent.com/u/9946255?v=4",
        "events_url": "https://api.github.com/users/fredizzimo/events{/privacy}",
        "followers_url": "https://api.github.com/users/fredizzimo/followers",
        "following_url": "https://api.github.com/users/fredizzimo/following{/other_user}",
        "gists_url": "https://api.github.com/users/fredizzimo/gists{/gist_id}",
        "gravatar_id": "",
        "html_url": "https://github.com/fredizzimo",
        "id": 9946255,
        "login": "fredizzimo",
        "node_id": "MDQ6VXNlcjk5NDYyNTU=",
        "organizations_url": "https://api.github.com/users/fredizzimo/orgs",
        "received_events_url": "https://api.github.com/users/fredizzimo/received_events",
        "repos_url": "https://api.github.com/users/fredizzimo/repos",
        "site_admin": false,
        "starred_url": "https://api.github.com/users/fredizzimo/starred{/owner}{/repo}",
        "subscriptions_url": "https://api.github.com/users/fredizzimo/subscriptions",
        "type": "User",
        "url": "https://api.github.com/users/fredizzimo"
    }
}