{
    "active_lock_reason": null,
    "assignee": null,
    "assignees": [],
    "author_association": "NONE",
    "body": "### Neovim version (nvim -v)\n\n0.6 commit 88e16a7f30b23c03c2207086f613190e685a67c3\n\n### Vim (not Nvim) behaves the same?\n\nunrelated\n\n### Operating system/version\n\nNixOS unstable\n\n### Terminal name/version\n\nunrelated\n\n### $TERM environment variable\n\nunrelated\n\n### Installation\n\nbuilt from source\n\n### How to reproduce the issue\n\nI want to inject highlighting to indented strings with a language-indicator comment in nix-lang. Like,\r\n```nix\r\n/* bash */ ''\r\n  echo foo\r\n''\r\n```\r\n\r\nI write dynamic injection like this.\r\n```\r\n(\r\n  ((comment) @language\r\n    (#match? @language \"^/\\\\* [A-Za-z][A-Za-z_-]* \\\\*/$\")\r\n    (#offset! @language 0 3 0 -3)) ; Strip comment delimiters.\r\n  .\r\n  ((indented_string) @content\r\n    (#offset! @content 0 2 0 -2))) ; Strip quotes.\r\n```\r\n\n\n### Expected behavior\n\nIt works.\n\n### Actual behavior\n\nIt doesn't. The content is still highlighted as normal string.\r\n\r\nI tried to `(#set! \"language\" @language)` after the `offset!` but it still doesn't.\r\nIt works only when I manually set `language` to `bash`.\r\n```\r\n(\r\n  ((comment) @language\r\n    (#match? @language \"^/\\\\* [A-Za-z][A-Za-z_-]* \\\\*/$\")\r\n    (#offset! @language 0 3 0 -3) ; Strip comment delimiters.\r\n    (#set! \"language\" \"bash\"))\r\n  .\r\n  ((indented_string) @content\r\n    (#offset! @content 0 2 0 -2))) ; Strip quotes.\r\n```\r\n\r\nSo I believe it have trouble retrieving language string from the comment.\r\n\r\nIn the handler code of `offset!`, it always put the result range into `metadata.content` and the capture information is not saved at all.\r\n\r\nhttps://github.com/neovim/neovim/blob/5fd4557573c73a6b41b702b1ee39151b5bd7e5fd/runtime/lua/vim/treesitter/query.lua#L323\r\n\r\nWhen retrieving `@language`, it directly pull text from the node without respecting any offset.\r\n\r\nhttps://github.com/neovim/neovim/blob/5fd4557573c73a6b41b702b1ee39151b5bd7e5fd/runtime/lua/vim/treesitter/languagetree.lua#L343-L344\r\n\r\nRelated: #14046 \r\ncc @steelsojka ",
    "closed_at": null,
    "closed_by": null,
    "comment_data": [
        {
            "author_association": "CONTRIBUTOR",
            "body": "offset only works for injection queries, and for the content of the language only. You can write a directive that analyze the language part similar to https://github.com/nvim-treesitter/nvim-treesitter/pull/1240/files#diff-81f58ecd0f4978b575136c86619adc8dbc9a0c9e87f87702ddf22615d0ac6c4bR93-R102",
            "created_at": "2021-10-15T17:56:04Z",
            "html_url": "https://github.com/neovim/neovim/issues/16032#issuecomment-944489439",
            "id": 944489439,
            "issue_url": "https://api.github.com/repos/neovim/neovim/issues/16032",
            "node_id": "IC_kwDOAPphoM44S8Pf",
            "performed_via_github_app": null,
            "reactions": {
                "+1": 0,
                "-1": 0,
                "confused": 0,
                "eyes": 0,
                "heart": 0,
                "hooray": 0,
                "laugh": 0,
                "rocket": 0,
                "total_count": 0,
                "url": "https://api.github.com/repos/neovim/neovim/issues/comments/944489439/reactions"
            },
            "updated_at": "2021-10-15T17:56:04Z",
            "url": "https://api.github.com/repos/neovim/neovim/issues/comments/944489439",
            "user": {
                "avatar_url": "https://avatars.githubusercontent.com/u/4975310?v=4",
                "events_url": "https://api.github.com/users/stsewd/events{/privacy}",
                "followers_url": "https://api.github.com/users/stsewd/followers",
                "following_url": "https://api.github.com/users/stsewd/following{/other_user}",
                "gists_url": "https://api.github.com/users/stsewd/gists{/gist_id}",
                "gravatar_id": "",
                "html_url": "https://github.com/stsewd",
                "id": 4975310,
                "login": "stsewd",
                "node_id": "MDQ6VXNlcjQ5NzUzMTA=",
                "organizations_url": "https://api.github.com/users/stsewd/orgs",
                "received_events_url": "https://api.github.com/users/stsewd/received_events",
                "repos_url": "https://api.github.com/users/stsewd/repos",
                "site_admin": false,
                "starred_url": "https://api.github.com/users/stsewd/starred{/owner}{/repo}",
                "subscriptions_url": "https://api.github.com/users/stsewd/subscriptions",
                "type": "User",
                "url": "https://api.github.com/users/stsewd",
                "user_view_type": "public"
            }
        }
    ],
    "comments": 1,
    "comments_url": "https://api.github.com/repos/neovim/neovim/issues/16032/comments",
    "created_at": "2021-10-15T09:31:46Z",
    "events_url": "https://api.github.com/repos/neovim/neovim/issues/16032/events",
    "html_url": "https://github.com/neovim/neovim/issues/16032",
    "id": 1027260841,
    "labels": [
        {
            "color": "c5def5",
            "default": false,
            "description": "",
            "id": 1799626557,
            "name": "treesitter",
            "node_id": "MDU6TGFiZWwxNzk5NjI2NTU3",
            "url": "https://api.github.com/repos/neovim/neovim/labels/treesitter"
        }
    ],
    "labels_url": "https://api.github.com/repos/neovim/neovim/issues/16032/labels{/name}",
    "locked": false,
    "milestone": null,
    "node_id": "I_kwDOAPphoM49OsGp",
    "number": 16032,
    "performed_via_github_app": null,
    "reactions": {
        "+1": 0,
        "-1": 0,
        "confused": 0,
        "eyes": 0,
        "heart": 0,
        "hooray": 0,
        "laugh": 0,
        "rocket": 0,
        "total_count": 0,
        "url": "https://api.github.com/repos/neovim/neovim/issues/16032/reactions"
    },
    "repository_url": "https://api.github.com/repos/neovim/neovim",
    "state": "open",
    "state_reason": null,
    "sub_issues_summary": {
        "completed": 0,
        "percent_completed": 0,
        "total": 0
    },
    "timeline_url": "https://api.github.com/repos/neovim/neovim/issues/16032/timeline",
    "title": "treesitter: #offset! doesn't work on @language",
    "type": {
        "color": "red",
        "created_at": "2024-01-25T10:10:19Z",
        "description": "An unexpected problem or behavior",
        "id": 597163,
        "is_enabled": true,
        "name": "Bug",
        "node_id": "IT_kwDOAGK_Pc4ACRyr",
        "updated_at": "2024-07-26T10:12:30Z"
    },
    "updated_at": "2025-07-02T08:38:20Z",
    "url": "https://api.github.com/repos/neovim/neovim/issues/16032",
    "user": {
        "avatar_url": "https://avatars.githubusercontent.com/u/14816024?v=4",
        "events_url": "https://api.github.com/users/oxalica/events{/privacy}",
        "followers_url": "https://api.github.com/users/oxalica/followers",
        "following_url": "https://api.github.com/users/oxalica/following{/other_user}",
        "gists_url": "https://api.github.com/users/oxalica/gists{/gist_id}",
        "gravatar_id": "",
        "html_url": "https://github.com/oxalica",
        "id": 14816024,
        "login": "oxalica",
        "node_id": "MDQ6VXNlcjE0ODE2MDI0",
        "organizations_url": "https://api.github.com/users/oxalica/orgs",
        "received_events_url": "https://api.github.com/users/oxalica/received_events",
        "repos_url": "https://api.github.com/users/oxalica/repos",
        "site_admin": false,
        "starred_url": "https://api.github.com/users/oxalica/starred{/owner}{/repo}",
        "subscriptions_url": "https://api.github.com/users/oxalica/subscriptions",
        "type": "User",
        "url": "https://api.github.com/users/oxalica",
        "user_view_type": "public"
    }
}