{
    "active_lock_reason": null,
    "assignee": null,
    "assignees": [],
    "author_association": "NONE",
    "body": "### Problem\n\nNeovim shows an error and fails to syntax highlight on Astro files when a trailing comma is left in the `tsconfig.json` file.\n\n### Steps to reproduce\n\n```\n$ nvim --clean example.astro\nError detected while processing BufReadPost Autocommands for \"*\":\nError executing lua callback: ...ro-fix/nvim-linux-x86_64/share/nvim/runtime/filetype.lua:35: Error executing lua: ...ro-fix/nvim-linux-x86\n_64/share/nvim/runtime/filetype.lua:36: BufReadPost Autocommands for \"*\"..FileType Autocommands for \"*\"..function <SNR>1_LoadFTPlugin[20]..\nscript /home/user/nvim-astro-fix/nvim-linux-x86_64/share/nvim/runtime/ftplugin/astro.vim[163]..function <SNR>21_CollectPathsFrom\nConfig, line 11: Vim(let):E474: Trailing comma: }\nstack traceback:\n        [C]: in function 'nvim_cmd'\n        ...ro-fix/nvim-linux-x86_64/share/nvim/runtime/filetype.lua:36: in function <...ro-fix/nvim-linux-x86_64/share/nvim/runtime/filetyp\ne.lua:35>\n        [C]: in function 'nvim_buf_call'\n        ...ro-fix/nvim-linux-x86_64/share/nvim/runtime/filetype.lua:35: in function <...ro-fix/nvim-linux-x86_64/share/nvim/runtime/filetyp\ne.lua:10>\nstack traceback:\n        [C]: in function 'nvim_buf_call'\n        ...ro-fix/nvim-linux-x86_64/share/nvim/runtime/filetype.lua:35: in function <...ro-fix/nvim-linux-x86_64/share/nvim/runtime/filetyp\ne.lua:10>\nPress ENTER or type command to continue\n```\n\nOpening Neovim and then opening the file results in no syntax highlight.\nReloading the file with `:e` shows the error on screen.\n\n\nFiles to reproduce the issue:\n\n`example.astro`:\n```astro\n---\n---\n<p>This is an example</p>\n\n```\n\n`tsconfig.json`:\n```json\n{\n  \"extends\": \"astro/tsconfigs/strict\",\n}\n```\n\nThe trailing comma shouldn't be there, but I had more options below the \"extends\" and I commented them out, leaving the trailing comma by mistake.\n\n\n### Expected behavior\n\nIn my opinion, the UI shouldn't break like this but I don't know how would it be the proper way of handling this.\n\nAs a workaround, since the problem appears when a trailing comma is left on the `tsconfig.json`, just removing that trailing comma makes the error go away.\n\n### A possible fix\nThe problem seems to come from an unhandled error on `runtime/ftplugin/astro.vim`.\n\nI wrapped the problematic code with a `try`/`catch` and that made the error go away.\nI don't know what would be the correct behavior on Neovim when this problem happens.\n\n```diff\n54,60c54,66\n<     let paths_from_config = config_json\n<                 \\ ->readfile()\n<                 \\ ->filter({ _, val -> val =~ '^\\s*[\\[\\]{}\"0-9]' })\n<                 \\ ->join()\n<                 \\ ->json_decode()\n<                 \\ ->get('compilerOptions', {})\n<                 \\ ->get('paths', {})\n---\n>     try\n>         let paths_from_config = config_json\n>                     \\ ->readfile()\n>                     \\ ->filter({ _, val -> val =~ '^\\s*[\\[\\]{}\"0-9]' })\n>                     \\ ->join()\n>                     \\ ->json_decode()\n>                     \\ ->get('compilerOptions', {})\n>                     \\ ->get('paths', {})\n>     catch\n>         \" not actually handling the error, what should we do here? inform the\n>         \" user somehow about a broken json config?\n>         return\n>     endtry\n```\n\nThe original implementation gets `compilerOptions` and `paths` from the `tsconfig.json` file and uses them, but with this approach those options will be ignored if present.\nI think that a better approach would be to read those options regardless of issues with the file format.\n\n### Does this affect Vim?\nNo, I just downloaded the AppImage for Vim v9.1.1106 and I couldn't reproduce the issue.\nhttps://github.com/vim/vim-appimage/releases/tag/v9.1.1106\n\nFrom the discussion on the original repo (https://github.com/wuelnerdotexe/vim-astro/issues/9) it seems that the json decoder on Vim is more tolerant to trailing commas than Neovim's json decoder.\n\n\n### How to proceed?\nOn another Astro related issue there's a comment saying that Neovim doesn't maintain the file, that the changes are ported from the maintainer to Vim and then to Neovim.\nSee: https://github.com/neovim/neovim/issues/31225#issuecomment-2479017474\n\nThe problem is that this is not affecting Vim, so I imagine there won't be a fix for this that Neovim could port from Vim.\n\nMaybe the proper fix is to have a more resilient json decoder?\n\n\n### References\n- Pull request where the Astro file type support was merged on Vim: https://github.com/vim/vim/pull/14561\n- Pull request where the changes where ported to Neovim: https://github.com/neovim/neovim/pull/28442\n- The Astro file support was ported to Vim from https://github.com/wuelnerdotexe/vim-astro\n- Discussion about the json parsing problem on the original repo: https://github.com/wuelnerdotexe/vim-astro/issues/9\n- Someone experienced this issue and solved it by removing the trailing comma: https://www.reddit.com/r/neovim/comments/1f9m7lb/error_when_opening_astro_files_can_someone_help/\n- Neovim version tested: https://github.com/neovim/neovim/releases/tag/v0.10.4 (got `nvim-linux-x86_64.tar.gz`)\n- Vim version tested: https://github.com/vim/vim-appimage/releases/tag/v9.1.1106 (got `Vim-v9.1.1106.glibc2.29-x86_64.AppImage`)\n- There's a closed bug report about this problem already, with the recommendation of removing the trailing comma: https://github.com/neovim/neovim/issues/29300\n\n### Nvim version (nvim -v)\n\n0.10.4\n\n### Vim (not Nvim) behaves the same?\n\nno, Vim v9.1.1106\n\n### Operating system/version\n\nUbuntu 22.04.5 LTS\n\n### Terminal name/version\n\nkonsole 21.12.3\n\n### $TERM environment variable\n\nscreen-256color\n\n### Installation\n\nBuild from the repo, nvim-linux-x86_64.tar.gz",
    "closed_at": null,
    "closed_by": null,
    "comment_data": [
        {
            "author_association": "MEMBER",
            "body": "I think the situation is still the same: Your file is invalid JSON, and the upstream maintainer is not willing to support this situation. (Understandably so.) We will not switch the JSON decoder for this, which is a load-bearing part of our LSP implementation.\n\nWe _could_ silence any errors (anything beyond that is out of scope), but I'm not sure that's much better UX (your JSON _is_ invalid, after all).\n\n",
            "created_at": "2025-02-12T18:26:50Z",
            "html_url": "https://github.com/neovim/neovim/issues/32422#issuecomment-2654526970",
            "id": 2654526970,
            "issue_url": "https://api.github.com/repos/neovim/neovim/issues/32422",
            "node_id": "IC_kwDOAPphoM6eON36",
            "performed_via_github_app": null,
            "reactions": {
                "+1": 0,
                "-1": 0,
                "confused": 0,
                "eyes": 0,
                "heart": 0,
                "hooray": 0,
                "laugh": 0,
                "rocket": 0,
                "total_count": 0,
                "url": "https://api.github.com/repos/neovim/neovim/issues/comments/2654526970/reactions"
            },
            "updated_at": "2025-02-12T18:26:50Z",
            "url": "https://api.github.com/repos/neovim/neovim/issues/comments/2654526970",
            "user": {
                "avatar_url": "https://avatars.githubusercontent.com/u/2361214?v=4",
                "events_url": "https://api.github.com/users/clason/events{/privacy}",
                "followers_url": "https://api.github.com/users/clason/followers",
                "following_url": "https://api.github.com/users/clason/following{/other_user}",
                "gists_url": "https://api.github.com/users/clason/gists{/gist_id}",
                "gravatar_id": "",
                "html_url": "https://github.com/clason",
                "id": 2361214,
                "login": "clason",
                "node_id": "MDQ6VXNlcjIzNjEyMTQ=",
                "organizations_url": "https://api.github.com/users/clason/orgs",
                "received_events_url": "https://api.github.com/users/clason/received_events",
                "repos_url": "https://api.github.com/users/clason/repos",
                "site_admin": false,
                "starred_url": "https://api.github.com/users/clason/starred{/owner}{/repo}",
                "subscriptions_url": "https://api.github.com/users/clason/subscriptions",
                "type": "User",
                "url": "https://api.github.com/users/clason",
                "user_view_type": "public"
            }
        },
        {
            "author_association": "NONE",
            "body": "> We will not switch the JSON decoder for this, which is a load-bearing part of our LSP implementation.\n\nThis is reasonable, is not like the decoder is doing something wrong... the json file contains invalid json after all.\n\n\n> (...) Your file is invalid JSON (...)\n\nYes, but I'd say that the `tsconfig.json` file is not 100% json since it supports comments and trailing commas, or at least works normally when they are present.\nSo I'd say that my `tsconfig.json` is not a valid json file, but is a valid `tsconfig.json` file.\nI went through typescript docs and github issues but I couldn't find a reference for the file format.\n\nBtw, comments on `tsconfig.json` do not seem to cause any issue with Astro files on Neovim.\n\n\n> We _could_ silence any errors (anything beyond that is out of scope), but I'm not sure that's much better UX (your JSON _is_ invalid, after all).\n\nI wonder what would be the best UX for a user.\nWhat I experience right now is that my editor breaks when I open an astro file that compiles and works without an issue on the terminal.\nI don't think is clear to a user that some other file in the project is causing the currently open file to break. I went through my configs and updated plugins to see if something broke before finding the culprit.\n\nNote that if we add two trailing commas (just trying to break it at this point), Astro files break for both Vim and Neovim.\n\nIs this discussion something that should happen on https://github.com/wuelnerdotexe/vim-astro ? Since they maintain the original repo do they have the final say on how Neovim behaves with Astro files?",
            "created_at": "2025-02-12T20:29:44Z",
            "html_url": "https://github.com/neovim/neovim/issues/32422#issuecomment-2654774699",
            "id": 2654774699,
            "issue_url": "https://api.github.com/repos/neovim/neovim/issues/32422",
            "node_id": "IC_kwDOAPphoM6ePKWr",
            "performed_via_github_app": null,
            "reactions": {
                "+1": 0,
                "-1": 0,
                "confused": 0,
                "eyes": 0,
                "heart": 0,
                "hooray": 0,
                "laugh": 0,
                "rocket": 0,
                "total_count": 0,
                "url": "https://api.github.com/repos/neovim/neovim/issues/comments/2654774699/reactions"
            },
            "updated_at": "2025-02-12T20:29:44Z",
            "url": "https://api.github.com/repos/neovim/neovim/issues/comments/2654774699",
            "user": {
                "avatar_url": "https://avatars.githubusercontent.com/u/806502?v=4",
                "events_url": "https://api.github.com/users/ivanalejandro0/events{/privacy}",
                "followers_url": "https://api.github.com/users/ivanalejandro0/followers",
                "following_url": "https://api.github.com/users/ivanalejandro0/following{/other_user}",
                "gists_url": "https://api.github.com/users/ivanalejandro0/gists{/gist_id}",
                "gravatar_id": "",
                "html_url": "https://github.com/ivanalejandro0",
                "id": 806502,
                "login": "ivanalejandro0",
                "node_id": "MDQ6VXNlcjgwNjUwMg==",
                "organizations_url": "https://api.github.com/users/ivanalejandro0/orgs",
                "received_events_url": "https://api.github.com/users/ivanalejandro0/received_events",
                "repos_url": "https://api.github.com/users/ivanalejandro0/repos",
                "site_admin": false,
                "starred_url": "https://api.github.com/users/ivanalejandro0/starred{/owner}{/repo}",
                "subscriptions_url": "https://api.github.com/users/ivanalejandro0/subscriptions",
                "type": "User",
                "url": "https://api.github.com/users/ivanalejandro0",
                "user_view_type": "public"
            }
        },
        {
            "author_association": "MEMBER",
            "body": "> Is this discussion something that should happen on https://github.com/wuelnerdotexe/vim-astro ? Since they maintain the original repo do they have the final say on how Neovim behaves with Astro files?\n\nYes, ideally. The question is what to do if they continue to refuse to address this. If there's a way to frame this so upstream sees value in being more resilient to errors, both win. \n\n(I acknowledge that this is a more urgent issue for as than for them.)",
            "created_at": "2025-02-12T20:33:52Z",
            "html_url": "https://github.com/neovim/neovim/issues/32422#issuecomment-2654782592",
            "id": 2654782592,
            "issue_url": "https://api.github.com/repos/neovim/neovim/issues/32422",
            "node_id": "IC_kwDOAPphoM6ePMSA",
            "performed_via_github_app": null,
            "reactions": {
                "+1": 0,
                "-1": 0,
                "confused": 0,
                "eyes": 0,
                "heart": 0,
                "hooray": 0,
                "laugh": 0,
                "rocket": 0,
                "total_count": 0,
                "url": "https://api.github.com/repos/neovim/neovim/issues/comments/2654782592/reactions"
            },
            "updated_at": "2025-02-12T20:33:52Z",
            "url": "https://api.github.com/repos/neovim/neovim/issues/comments/2654782592",
            "user": {
                "avatar_url": "https://avatars.githubusercontent.com/u/2361214?v=4",
                "events_url": "https://api.github.com/users/clason/events{/privacy}",
                "followers_url": "https://api.github.com/users/clason/followers",
                "following_url": "https://api.github.com/users/clason/following{/other_user}",
                "gists_url": "https://api.github.com/users/clason/gists{/gist_id}",
                "gravatar_id": "",
                "html_url": "https://github.com/clason",
                "id": 2361214,
                "login": "clason",
                "node_id": "MDQ6VXNlcjIzNjEyMTQ=",
                "organizations_url": "https://api.github.com/users/clason/orgs",
                "received_events_url": "https://api.github.com/users/clason/received_events",
                "repos_url": "https://api.github.com/users/clason/repos",
                "site_admin": false,
                "starred_url": "https://api.github.com/users/clason/starred{/owner}{/repo}",
                "subscriptions_url": "https://api.github.com/users/clason/subscriptions",
                "type": "User",
                "url": "https://api.github.com/users/clason",
                "user_view_type": "public"
            }
        }
    ],
    "comments": 3,
    "comments_url": "https://api.github.com/repos/neovim/neovim/issues/32422/comments",
    "created_at": "2025-02-12T18:15:27Z",
    "events_url": "https://api.github.com/repos/neovim/neovim/issues/32422/events",
    "html_url": "https://github.com/neovim/neovim/issues/32422",
    "id": 2849020335,
    "labels": [],
    "labels_url": "https://api.github.com/repos/neovim/neovim/issues/32422/labels{/name}",
    "locked": false,
    "milestone": null,
    "node_id": "I_kwDOAPphoM6p0Jmv",
    "number": 32422,
    "performed_via_github_app": null,
    "reactions": {
        "+1": 0,
        "-1": 0,
        "confused": 0,
        "eyes": 0,
        "heart": 0,
        "hooray": 0,
        "laugh": 0,
        "rocket": 0,
        "total_count": 0,
        "url": "https://api.github.com/repos/neovim/neovim/issues/32422/reactions"
    },
    "repository_url": "https://api.github.com/repos/neovim/neovim",
    "state": "open",
    "state_reason": null,
    "sub_issues_summary": {
        "completed": 0,
        "percent_completed": 0,
        "total": 0
    },
    "timeline_url": "https://api.github.com/repos/neovim/neovim/issues/32422/timeline",
    "title": "Error opening Astro file when tsconfig.json has a trailing comma",
    "updated_at": "2025-02-12T20:33:54Z",
    "url": "https://api.github.com/repos/neovim/neovim/issues/32422",
    "user": {
        "avatar_url": "https://avatars.githubusercontent.com/u/806502?v=4",
        "events_url": "https://api.github.com/users/ivanalejandro0/events{/privacy}",
        "followers_url": "https://api.github.com/users/ivanalejandro0/followers",
        "following_url": "https://api.github.com/users/ivanalejandro0/following{/other_user}",
        "gists_url": "https://api.github.com/users/ivanalejandro0/gists{/gist_id}",
        "gravatar_id": "",
        "html_url": "https://github.com/ivanalejandro0",
        "id": 806502,
        "login": "ivanalejandro0",
        "node_id": "MDQ6VXNlcjgwNjUwMg==",
        "organizations_url": "https://api.github.com/users/ivanalejandro0/orgs",
        "received_events_url": "https://api.github.com/users/ivanalejandro0/received_events",
        "repos_url": "https://api.github.com/users/ivanalejandro0/repos",
        "site_admin": false,
        "starred_url": "https://api.github.com/users/ivanalejandro0/starred{/owner}{/repo}",
        "subscriptions_url": "https://api.github.com/users/ivanalejandro0/subscriptions",
        "type": "User",
        "url": "https://api.github.com/users/ivanalejandro0",
        "user_view_type": "public"
    }
}