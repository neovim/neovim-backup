{
    "active_lock_reason": null,
    "assignee": null,
    "assignees": [],
    "author_association": "CONTRIBUTOR",
    "body": "### Problem\n\nThe diagnostic handler for opening the floating preview window has [special handling](https://github.com/neovim/neovim/blob/570e62d0f99dbc99e4f506ad1b874bb1842159d0/runtime/lua/vim/diagnostic.lua#L2181) for diagnostics at the end of the line.\nhttps://github.com/neovim/neovim/blob/570e62d0f99dbc99e4f506ad1b874bb1842159d0/runtime/lua/vim/diagnostic.lua#L2181-L2189\nHowever, other handlers, such as the underline one, do not do this, which can lead to a surprising user experience (e.g., if you auto-summon the window when on a diagnostic, it will appear in places where there aren't diagnostic indicators). Can the handlers be made consistent?\n\n### Nvim version (nvim -v)\n\n0.11.1",
    "closed_at": null,
    "closed_by": null,
    "comment_data": [
        {
            "author_association": "CONTRIBUTOR",
            "body": "An easy way to repro this case: in a lua file where you have a table defined over multiple lines, drop one of the commas.",
            "created_at": "2025-05-14T04:25:06Z",
            "html_url": "https://github.com/neovim/neovim/issues/34013#issuecomment-2878627092",
            "id": 2878627092,
            "issue_url": "https://api.github.com/repos/neovim/neovim/issues/34013",
            "node_id": "IC_kwDOAPphoM6rlF0U",
            "performed_via_github_app": null,
            "reactions": {
                "+1": 0,
                "-1": 0,
                "confused": 0,
                "eyes": 0,
                "heart": 0,
                "hooray": 0,
                "laugh": 0,
                "rocket": 0,
                "total_count": 0,
                "url": "https://api.github.com/repos/neovim/neovim/issues/comments/2878627092/reactions"
            },
            "updated_at": "2025-05-14T04:25:06Z",
            "url": "https://api.github.com/repos/neovim/neovim/issues/comments/2878627092",
            "user": {
                "avatar_url": "https://avatars.githubusercontent.com/u/802511?v=4",
                "events_url": "https://api.github.com/users/ddickstein/events{/privacy}",
                "followers_url": "https://api.github.com/users/ddickstein/followers",
                "following_url": "https://api.github.com/users/ddickstein/following{/other_user}",
                "gists_url": "https://api.github.com/users/ddickstein/gists{/gist_id}",
                "gravatar_id": "",
                "html_url": "https://github.com/ddickstein",
                "id": 802511,
                "login": "ddickstein",
                "node_id": "MDQ6VXNlcjgwMjUxMQ==",
                "organizations_url": "https://api.github.com/users/ddickstein/orgs",
                "received_events_url": "https://api.github.com/users/ddickstein/received_events",
                "repos_url": "https://api.github.com/users/ddickstein/repos",
                "site_admin": false,
                "starred_url": "https://api.github.com/users/ddickstein/starred{/owner}{/repo}",
                "subscriptions_url": "https://api.github.com/users/ddickstein/subscriptions",
                "type": "User",
                "url": "https://api.github.com/users/ddickstein",
                "user_view_type": "public"
            }
        },
        {
            "author_association": "MEMBER",
            "body": "@faergeek do you know if ~https://github.com/neovim/neovim/issues/34013~ https://github.com/neovim/neovim/issues/34014 will fix this?",
            "created_at": "2025-05-17T17:44:49Z",
            "html_url": "https://github.com/neovim/neovim/issues/34013#issuecomment-2888510224",
            "id": 2888510224,
            "issue_url": "https://api.github.com/repos/neovim/neovim/issues/34013",
            "node_id": "IC_kwDOAPphoM6sKysQ",
            "performed_via_github_app": null,
            "reactions": {
                "+1": 0,
                "-1": 0,
                "confused": 0,
                "eyes": 0,
                "heart": 0,
                "hooray": 0,
                "laugh": 0,
                "rocket": 0,
                "total_count": 0,
                "url": "https://api.github.com/repos/neovim/neovim/issues/comments/2888510224/reactions"
            },
            "updated_at": "2025-05-18T19:20:55Z",
            "url": "https://api.github.com/repos/neovim/neovim/issues/comments/2888510224",
            "user": {
                "avatar_url": "https://avatars.githubusercontent.com/u/62502207?v=4",
                "events_url": "https://api.github.com/users/MariaSolOs/events{/privacy}",
                "followers_url": "https://api.github.com/users/MariaSolOs/followers",
                "following_url": "https://api.github.com/users/MariaSolOs/following{/other_user}",
                "gists_url": "https://api.github.com/users/MariaSolOs/gists{/gist_id}",
                "gravatar_id": "",
                "html_url": "https://github.com/MariaSolOs",
                "id": 62502207,
                "login": "MariaSolOs",
                "node_id": "MDQ6VXNlcjYyNTAyMjA3",
                "organizations_url": "https://api.github.com/users/MariaSolOs/orgs",
                "received_events_url": "https://api.github.com/users/MariaSolOs/received_events",
                "repos_url": "https://api.github.com/users/MariaSolOs/repos",
                "site_admin": false,
                "starred_url": "https://api.github.com/users/MariaSolOs/starred{/owner}{/repo}",
                "subscriptions_url": "https://api.github.com/users/MariaSolOs/subscriptions",
                "type": "User",
                "url": "https://api.github.com/users/MariaSolOs",
                "user_view_type": "public"
            }
        },
        {
            "author_association": "CONTRIBUTOR",
            "body": "Is this what the problem is?\n\nWith this code in a lua file:\n\n```lua\nlocal tbl = {\n  foo = 'bar',\n  baz = 'quux',\n}\n\nvim.print(tbl)\n```\n\nIf I put the cursor at the end of \"foo\" line, hit `x` to delete a comma and press `<C-w>d` it shows a float even though diagnostic underline appears to be shown only starting from the \"baz\" line?\n\nIf so, with #34013 float won't open, but `[d` and `]d` will still jump to the end of \"foo\" line instead of the start of the \"baz\" line. Which to me seems to be worse than what's described here initially.\n\nNot quite sure what happens there to be honest, but I'll take a closer look.",
            "created_at": "2025-05-18T04:15:09Z",
            "html_url": "https://github.com/neovim/neovim/issues/34013#issuecomment-2888755243",
            "id": 2888755243,
            "issue_url": "https://api.github.com/repos/neovim/neovim/issues/34013",
            "node_id": "IC_kwDOAPphoM6sLugr",
            "performed_via_github_app": null,
            "reactions": {
                "+1": 0,
                "-1": 0,
                "confused": 0,
                "eyes": 0,
                "heart": 0,
                "hooray": 0,
                "laugh": 0,
                "rocket": 0,
                "total_count": 0,
                "url": "https://api.github.com/repos/neovim/neovim/issues/comments/2888755243/reactions"
            },
            "updated_at": "2025-05-18T04:15:09Z",
            "url": "https://api.github.com/repos/neovim/neovim/issues/comments/2888755243",
            "user": {
                "avatar_url": "https://avatars.githubusercontent.com/u/3524621?v=4",
                "events_url": "https://api.github.com/users/faergeek/events{/privacy}",
                "followers_url": "https://api.github.com/users/faergeek/followers",
                "following_url": "https://api.github.com/users/faergeek/following{/other_user}",
                "gists_url": "https://api.github.com/users/faergeek/gists{/gist_id}",
                "gravatar_id": "",
                "html_url": "https://github.com/faergeek",
                "id": 3524621,
                "login": "faergeek",
                "node_id": "MDQ6VXNlcjM1MjQ2MjE=",
                "organizations_url": "https://api.github.com/users/faergeek/orgs",
                "received_events_url": "https://api.github.com/users/faergeek/received_events",
                "repos_url": "https://api.github.com/users/faergeek/repos",
                "site_admin": false,
                "starred_url": "https://api.github.com/users/faergeek/starred{/owner}{/repo}",
                "subscriptions_url": "https://api.github.com/users/faergeek/subscriptions",
                "type": "User",
                "url": "https://api.github.com/users/faergeek",
                "user_view_type": "public"
            }
        },
        {
            "author_association": "CONTRIBUTOR",
            "body": "Lua file for testing:\n\n```lua\nlocal tbl = {\n  foo = 'bar'\n  baz = 'quux',\n}\n\nvim.print(tbl)\n```\n\nDiagnostic that is set in this case:\n\n```lua\n{\n  lnum = 1,\n  col = 13,\n  end_lnum = 2,\n  end_col = 8,\n  message = 'Miss symbol `,` or `;` .',\n  -- ...\n}\n```\n\n`open_float` doesn't open anything because extmark is set past the EOL (basically exactly per diagnostic position being sent). `jump` is inconsistent with that because it tries to set the cursor to `{ 2, 13 }` (1,0-indexed) position, which isn't valid (unless `set virtualedit=all` or similar), but as I understand `nvim_win_set_cursor` just clamps the column in that case and cursor ends up at `{ 2, 12 }`.\n\n`underline` is not shown past the end of the line, but I think it's possible to change that if it's changed to use extmark with `hl_eol` instead of `vim.hl.range`, which doesn't seem to support that.\n`signs` doesn't care about the column.\n`virtual_text` is shown where the diagnostic is at since it doesn't really care about the column.\n`virtual_lines` is shown where the diagnostic is at since it's a virtual line below, it could be easily shown even 5 characters past the EOL as well I guess.\n\n#34013 for sure makes it worse than it already is right now.",
            "created_at": "2025-05-18T05:38:13Z",
            "html_url": "https://github.com/neovim/neovim/issues/34013#issuecomment-2888783802",
            "id": 2888783802,
            "issue_url": "https://api.github.com/repos/neovim/neovim/issues/34013",
            "node_id": "IC_kwDOAPphoM6sL1e6",
            "performed_via_github_app": null,
            "reactions": {
                "+1": 0,
                "-1": 0,
                "confused": 0,
                "eyes": 0,
                "heart": 0,
                "hooray": 0,
                "laugh": 0,
                "rocket": 0,
                "total_count": 0,
                "url": "https://api.github.com/repos/neovim/neovim/issues/comments/2888783802/reactions"
            },
            "updated_at": "2025-05-18T05:38:13Z",
            "url": "https://api.github.com/repos/neovim/neovim/issues/comments/2888783802",
            "user": {
                "avatar_url": "https://avatars.githubusercontent.com/u/3524621?v=4",
                "events_url": "https://api.github.com/users/faergeek/events{/privacy}",
                "followers_url": "https://api.github.com/users/faergeek/followers",
                "following_url": "https://api.github.com/users/faergeek/following{/other_user}",
                "gists_url": "https://api.github.com/users/faergeek/gists{/gist_id}",
                "gravatar_id": "",
                "html_url": "https://github.com/faergeek",
                "id": 3524621,
                "login": "faergeek",
                "node_id": "MDQ6VXNlcjM1MjQ2MjE=",
                "organizations_url": "https://api.github.com/users/faergeek/orgs",
                "received_events_url": "https://api.github.com/users/faergeek/received_events",
                "repos_url": "https://api.github.com/users/faergeek/repos",
                "site_admin": false,
                "starred_url": "https://api.github.com/users/faergeek/starred{/owner}{/repo}",
                "subscriptions_url": "https://api.github.com/users/faergeek/subscriptions",
                "type": "User",
                "url": "https://api.github.com/users/faergeek",
                "user_view_type": "public"
            }
        },
        {
            "author_association": "CONTRIBUTOR",
            "body": "@faergeek just want to confirm that yes that's the problem I was describing.",
            "created_at": "2025-05-18T07:18:38Z",
            "html_url": "https://github.com/neovim/neovim/issues/34013#issuecomment-2888823757",
            "id": 2888823757,
            "issue_url": "https://api.github.com/repos/neovim/neovim/issues/34013",
            "node_id": "IC_kwDOAPphoM6sL_PN",
            "performed_via_github_app": null,
            "reactions": {
                "+1": 0,
                "-1": 0,
                "confused": 0,
                "eyes": 0,
                "heart": 0,
                "hooray": 0,
                "laugh": 0,
                "rocket": 0,
                "total_count": 0,
                "url": "https://api.github.com/repos/neovim/neovim/issues/comments/2888823757/reactions"
            },
            "updated_at": "2025-05-18T07:18:38Z",
            "url": "https://api.github.com/repos/neovim/neovim/issues/comments/2888823757",
            "user": {
                "avatar_url": "https://avatars.githubusercontent.com/u/802511?v=4",
                "events_url": "https://api.github.com/users/ddickstein/events{/privacy}",
                "followers_url": "https://api.github.com/users/ddickstein/followers",
                "following_url": "https://api.github.com/users/ddickstein/following{/other_user}",
                "gists_url": "https://api.github.com/users/ddickstein/gists{/gist_id}",
                "gravatar_id": "",
                "html_url": "https://github.com/ddickstein",
                "id": 802511,
                "login": "ddickstein",
                "node_id": "MDQ6VXNlcjgwMjUxMQ==",
                "organizations_url": "https://api.github.com/users/ddickstein/orgs",
                "received_events_url": "https://api.github.com/users/ddickstein/received_events",
                "repos_url": "https://api.github.com/users/ddickstein/repos",
                "site_admin": false,
                "starred_url": "https://api.github.com/users/ddickstein/starred{/owner}{/repo}",
                "subscriptions_url": "https://api.github.com/users/ddickstein/subscriptions",
                "type": "User",
                "url": "https://api.github.com/users/ddickstein",
                "user_view_type": "public"
            }
        },
        {
            "author_association": "MEMBER",
            "body": "@faergeek sorry I just realized I made this thread very confusing because I meant to link https://github.com/neovim/neovim/pull/34014 in https://github.com/neovim/neovim/issues/34013#issuecomment-2888510224 😅 ",
            "created_at": "2025-05-18T19:20:30Z",
            "html_url": "https://github.com/neovim/neovim/issues/34013#issuecomment-2889162897",
            "id": 2889162897,
            "issue_url": "https://api.github.com/repos/neovim/neovim/issues/34013",
            "node_id": "IC_kwDOAPphoM6sNSCR",
            "performed_via_github_app": null,
            "reactions": {
                "+1": 0,
                "-1": 0,
                "confused": 0,
                "eyes": 0,
                "heart": 0,
                "hooray": 0,
                "laugh": 1,
                "rocket": 0,
                "total_count": 1,
                "url": "https://api.github.com/repos/neovim/neovim/issues/comments/2889162897/reactions"
            },
            "updated_at": "2025-05-18T19:20:30Z",
            "url": "https://api.github.com/repos/neovim/neovim/issues/comments/2889162897",
            "user": {
                "avatar_url": "https://avatars.githubusercontent.com/u/62502207?v=4",
                "events_url": "https://api.github.com/users/MariaSolOs/events{/privacy}",
                "followers_url": "https://api.github.com/users/MariaSolOs/followers",
                "following_url": "https://api.github.com/users/MariaSolOs/following{/other_user}",
                "gists_url": "https://api.github.com/users/MariaSolOs/gists{/gist_id}",
                "gravatar_id": "",
                "html_url": "https://github.com/MariaSolOs",
                "id": 62502207,
                "login": "MariaSolOs",
                "node_id": "MDQ6VXNlcjYyNTAyMjA3",
                "organizations_url": "https://api.github.com/users/MariaSolOs/orgs",
                "received_events_url": "https://api.github.com/users/MariaSolOs/received_events",
                "repos_url": "https://api.github.com/users/MariaSolOs/repos",
                "site_admin": false,
                "starred_url": "https://api.github.com/users/MariaSolOs/starred{/owner}{/repo}",
                "subscriptions_url": "https://api.github.com/users/MariaSolOs/subscriptions",
                "type": "User",
                "url": "https://api.github.com/users/MariaSolOs",
                "user_view_type": "public"
            }
        },
        {
            "author_association": "CONTRIBUTOR",
            "body": "@MariaSolOs no problem at all :-) In any case it's good this was mentioned. I now made it behave like it did before with regards to `open_float` and `jump` and added a test.\n\nI think what this issue really is about is that `underline` handler behaves different from others. It should start showing underline at the end of a previous line. Using `hl_eol` will probably be too much as it would overlap with virtual text, so just shifting underline one column to the start in this case looks like a proper fix. I could prepare a PR for that as well.",
            "created_at": "2025-05-19T04:38:58Z",
            "html_url": "https://github.com/neovim/neovim/issues/34013#issuecomment-2889588219",
            "id": 2889588219,
            "issue_url": "https://api.github.com/repos/neovim/neovim/issues/34013",
            "node_id": "IC_kwDOAPphoM6sO537",
            "performed_via_github_app": null,
            "reactions": {
                "+1": 1,
                "-1": 0,
                "confused": 0,
                "eyes": 0,
                "heart": 1,
                "hooray": 0,
                "laugh": 0,
                "rocket": 0,
                "total_count": 2,
                "url": "https://api.github.com/repos/neovim/neovim/issues/comments/2889588219/reactions"
            },
            "updated_at": "2025-05-19T04:38:58Z",
            "url": "https://api.github.com/repos/neovim/neovim/issues/comments/2889588219",
            "user": {
                "avatar_url": "https://avatars.githubusercontent.com/u/3524621?v=4",
                "events_url": "https://api.github.com/users/faergeek/events{/privacy}",
                "followers_url": "https://api.github.com/users/faergeek/followers",
                "following_url": "https://api.github.com/users/faergeek/following{/other_user}",
                "gists_url": "https://api.github.com/users/faergeek/gists{/gist_id}",
                "gravatar_id": "",
                "html_url": "https://github.com/faergeek",
                "id": 3524621,
                "login": "faergeek",
                "node_id": "MDQ6VXNlcjM1MjQ2MjE=",
                "organizations_url": "https://api.github.com/users/faergeek/orgs",
                "received_events_url": "https://api.github.com/users/faergeek/received_events",
                "repos_url": "https://api.github.com/users/faergeek/repos",
                "site_admin": false,
                "starred_url": "https://api.github.com/users/faergeek/starred{/owner}{/repo}",
                "subscriptions_url": "https://api.github.com/users/faergeek/subscriptions",
                "type": "User",
                "url": "https://api.github.com/users/faergeek",
                "user_view_type": "public"
            }
        },
        {
            "author_association": "MEMBER",
            "body": "> [@MariaSolOs](https://github.com/MariaSolOs) no problem at all :-) In any case it's good this was mentioned. I now made it behave like it did before with regards to `open_float` and `jump` and added a test.\n> \n> I think what this issue really is about is that `underline` handler behaves different from others. It should start showing underline at the end of a previous line. Using `hl_eol` will probably be too much as it would overlap with virtual text, so just shifting underline one column to the start in this case looks like a proper fix. I could prepare a PR for that as well.\n\nGo for it! No pressure though, you're already working on some exciting improvements! I didn't mean to pressure you into handling this too 😅 ",
            "created_at": "2025-05-19T04:46:57Z",
            "html_url": "https://github.com/neovim/neovim/issues/34013#issuecomment-2889598734",
            "id": 2889598734,
            "issue_url": "https://api.github.com/repos/neovim/neovim/issues/34013",
            "node_id": "IC_kwDOAPphoM6sO8cO",
            "performed_via_github_app": null,
            "reactions": {
                "+1": 0,
                "-1": 0,
                "confused": 0,
                "eyes": 0,
                "heart": 1,
                "hooray": 0,
                "laugh": 0,
                "rocket": 0,
                "total_count": 1,
                "url": "https://api.github.com/repos/neovim/neovim/issues/comments/2889598734/reactions"
            },
            "updated_at": "2025-05-19T04:46:57Z",
            "url": "https://api.github.com/repos/neovim/neovim/issues/comments/2889598734",
            "user": {
                "avatar_url": "https://avatars.githubusercontent.com/u/62502207?v=4",
                "events_url": "https://api.github.com/users/MariaSolOs/events{/privacy}",
                "followers_url": "https://api.github.com/users/MariaSolOs/followers",
                "following_url": "https://api.github.com/users/MariaSolOs/following{/other_user}",
                "gists_url": "https://api.github.com/users/MariaSolOs/gists{/gist_id}",
                "gravatar_id": "",
                "html_url": "https://github.com/MariaSolOs",
                "id": 62502207,
                "login": "MariaSolOs",
                "node_id": "MDQ6VXNlcjYyNTAyMjA3",
                "organizations_url": "https://api.github.com/users/MariaSolOs/orgs",
                "received_events_url": "https://api.github.com/users/MariaSolOs/received_events",
                "repos_url": "https://api.github.com/users/MariaSolOs/repos",
                "site_admin": false,
                "starred_url": "https://api.github.com/users/MariaSolOs/starred{/owner}{/repo}",
                "subscriptions_url": "https://api.github.com/users/MariaSolOs/subscriptions",
                "type": "User",
                "url": "https://api.github.com/users/MariaSolOs",
                "user_view_type": "public"
            }
        }
    ],
    "comments": 8,
    "comments_url": "https://api.github.com/repos/neovim/neovim/issues/34013/comments",
    "created_at": "2025-05-14T04:23:22Z",
    "events_url": "https://api.github.com/repos/neovim/neovim/issues/34013/events",
    "html_url": "https://github.com/neovim/neovim/issues/34013",
    "id": 3061769345,
    "labels": [],
    "labels_url": "https://api.github.com/repos/neovim/neovim/issues/34013/labels{/name}",
    "locked": false,
    "milestone": null,
    "node_id": "I_kwDOAPphoM62fuSB",
    "number": 34013,
    "performed_via_github_app": null,
    "reactions": {
        "+1": 0,
        "-1": 0,
        "confused": 0,
        "eyes": 0,
        "heart": 0,
        "hooray": 0,
        "laugh": 0,
        "rocket": 0,
        "total_count": 0,
        "url": "https://api.github.com/repos/neovim/neovim/issues/34013/reactions"
    },
    "repository_url": "https://api.github.com/repos/neovim/neovim",
    "state": "open",
    "state_reason": null,
    "sub_issues_summary": {
        "completed": 0,
        "percent_completed": 0,
        "total": 0
    },
    "timeline_url": "https://api.github.com/repos/neovim/neovim/issues/34013/timeline",
    "title": "Diagnostic handlers for diagnostics at EOL are inconsistent",
    "type": {
        "color": "red",
        "created_at": "2024-01-25T10:10:19Z",
        "description": "An unexpected problem or behavior",
        "id": 597163,
        "is_enabled": true,
        "name": "Bug",
        "node_id": "IT_kwDOAGK_Pc4ACRyr",
        "updated_at": "2024-07-26T10:12:30Z"
    },
    "updated_at": "2025-05-19T04:46:57Z",
    "url": "https://api.github.com/repos/neovim/neovim/issues/34013",
    "user": {
        "avatar_url": "https://avatars.githubusercontent.com/u/802511?v=4",
        "events_url": "https://api.github.com/users/ddickstein/events{/privacy}",
        "followers_url": "https://api.github.com/users/ddickstein/followers",
        "following_url": "https://api.github.com/users/ddickstein/following{/other_user}",
        "gists_url": "https://api.github.com/users/ddickstein/gists{/gist_id}",
        "gravatar_id": "",
        "html_url": "https://github.com/ddickstein",
        "id": 802511,
        "login": "ddickstein",
        "node_id": "MDQ6VXNlcjgwMjUxMQ==",
        "organizations_url": "https://api.github.com/users/ddickstein/orgs",
        "received_events_url": "https://api.github.com/users/ddickstein/received_events",
        "repos_url": "https://api.github.com/users/ddickstein/repos",
        "site_admin": false,
        "starred_url": "https://api.github.com/users/ddickstein/starred{/owner}{/repo}",
        "subscriptions_url": "https://api.github.com/users/ddickstein/subscriptions",
        "type": "User",
        "url": "https://api.github.com/users/ddickstein",
        "user_view_type": "public"
    }
}