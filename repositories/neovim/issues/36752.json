{
    "active_lock_reason": null,
    "assignee": null,
    "assignees": [],
    "author_association": "CONTRIBUTOR",
    "body": "### Problem\n\nWhen quitting neovim, the client will be forced stopped immediately, instead of after `ClientConfig.exit_timeout` milliseconds.\n\nI suspect `:stop()` is being called twice, which is escalating to immediate force stopping.\n\n### Steps to reproduce\n\n- Take an existing lsp and modify its source code so it ignores shutdown requests. I used the python-language-server for this. You'll know the modifications work correctly when `:stop()` fails to stop the server.\n- Set `vim.lsp.config('*', { exit_timeout = 3000 })`, or pick any other large number.\n- `:qall`\n- Vim will close in much less than 3000 milliseconds.\n\n### Expected behavior\n\n`exit_timeout` is respected.\n\n### Nvim version (nvim -v)\n\nNVIM v0.12.0-dev+1714-a950e8ea9\n\n### Vim (not Nvim) behaves the same?\n\nnot applicable\n\n### Operating system/version\n\nFedora 43\n\n### Terminal name/version\n\nkitty 0.43.1\n\n### $TERM environment variable\n\nxterm-kitty\n\n### Installation\n\nFedora COPR",
    "closed_at": null,
    "closed_by": null,
    "comment_data": [
        {
            "author_association": "CONTRIBUTOR",
            "body": "Turns out it's not caused by `:stop()` being called twice. Even in the case of `:stop()` being turned into a no-op, the server will still be shut down instantly. Some other mechanism is terminating the server on VimExit.",
            "created_at": "2025-11-30T01:00:59Z",
            "html_url": "https://github.com/neovim/neovim/issues/36752#issuecomment-3592075257",
            "id": 3592075257,
            "issue_url": "https://api.github.com/repos/neovim/neovim/issues/36752",
            "node_id": "IC_kwDOAPphoM7WGrf5",
            "performed_via_github_app": null,
            "reactions": {
                "+1": 0,
                "-1": 0,
                "confused": 0,
                "eyes": 0,
                "heart": 0,
                "hooray": 0,
                "laugh": 0,
                "rocket": 0,
                "total_count": 0,
                "url": "https://api.github.com/repos/neovim/neovim/issues/comments/3592075257/reactions"
            },
            "updated_at": "2025-11-30T01:01:15Z",
            "url": "https://api.github.com/repos/neovim/neovim/issues/comments/3592075257",
            "user": {
                "avatar_url": "https://avatars.githubusercontent.com/u/51250849?v=4",
                "events_url": "https://api.github.com/users/superatomic/events{/privacy}",
                "followers_url": "https://api.github.com/users/superatomic/followers",
                "following_url": "https://api.github.com/users/superatomic/following{/other_user}",
                "gists_url": "https://api.github.com/users/superatomic/gists{/gist_id}",
                "gravatar_id": "",
                "html_url": "https://github.com/superatomic",
                "id": 51250849,
                "login": "superatomic",
                "node_id": "MDQ6VXNlcjUxMjUwODQ5",
                "organizations_url": "https://api.github.com/users/superatomic/orgs",
                "received_events_url": "https://api.github.com/users/superatomic/received_events",
                "repos_url": "https://api.github.com/users/superatomic/repos",
                "site_admin": false,
                "starred_url": "https://api.github.com/users/superatomic/starred{/owner}{/repo}",
                "subscriptions_url": "https://api.github.com/users/superatomic/subscriptions",
                "type": "User",
                "url": "https://api.github.com/users/superatomic",
                "user_view_type": "public"
            }
        },
        {
            "author_association": "MEMBER",
            "body": "See also https://github.com/neovim/neovim/pull/19672. Not blocking on exit with the `false` default was intentional and that behavior should imho be kept.\n\n`client:stop()` with timeout is currently also not blocking: \n\nhttps://github.com/neovim/neovim/blob/f9ef1a4cab74defde29afcecfc2c819ecc476b27/runtime/lua/vim/lsp/client.lua?plain=1#L877-L879\n\n",
            "created_at": "2025-12-01T11:27:52Z",
            "html_url": "https://github.com/neovim/neovim/issues/36752#issuecomment-3596017419",
            "id": 3596017419,
            "issue_url": "https://api.github.com/repos/neovim/neovim/issues/36752",
            "node_id": "IC_kwDOAPphoM7WVt8L",
            "performed_via_github_app": null,
            "reactions": {
                "+1": 1,
                "-1": 0,
                "confused": 0,
                "eyes": 0,
                "heart": 0,
                "hooray": 0,
                "laugh": 0,
                "rocket": 0,
                "total_count": 1,
                "url": "https://api.github.com/repos/neovim/neovim/issues/comments/3596017419/reactions"
            },
            "updated_at": "2025-12-01T11:27:52Z",
            "url": "https://api.github.com/repos/neovim/neovim/issues/comments/3596017419",
            "user": {
                "avatar_url": "https://avatars.githubusercontent.com/u/38700?v=4",
                "events_url": "https://api.github.com/users/mfussenegger/events{/privacy}",
                "followers_url": "https://api.github.com/users/mfussenegger/followers",
                "following_url": "https://api.github.com/users/mfussenegger/following{/other_user}",
                "gists_url": "https://api.github.com/users/mfussenegger/gists{/gist_id}",
                "gravatar_id": "",
                "html_url": "https://github.com/mfussenegger",
                "id": 38700,
                "login": "mfussenegger",
                "node_id": "MDQ6VXNlcjM4NzAw",
                "organizations_url": "https://api.github.com/users/mfussenegger/orgs",
                "received_events_url": "https://api.github.com/users/mfussenegger/received_events",
                "repos_url": "https://api.github.com/users/mfussenegger/repos",
                "site_admin": false,
                "starred_url": "https://api.github.com/users/mfussenegger/starred{/owner}{/repo}",
                "subscriptions_url": "https://api.github.com/users/mfussenegger/subscriptions",
                "type": "User",
                "url": "https://api.github.com/users/mfussenegger",
                "user_view_type": "public"
            }
        },
        {
            "author_association": "CONTRIBUTOR",
            "body": "> See also [#19672](https://github.com/neovim/neovim/pull/19672). Not blocking on exit with the `false` default was intentional and that behavior should imho be kept.\n\nGood to know! So the bug is just when `ClientConfig.exit_timeout` is a number.\n\nNow that the default is `3000` and no longer `false`, this does change the default behavior (although it does not change the behavior if the timeout is set to `false`). I see three ways forward:\n- Make no changes. People who want an instant exit can set `exit_timeout` to either `false` or `true`.\n- Now that the default can be easily changed, set the default back to `false`. I'm not in favor of this change, but I can see the arguments for it.\n- Add a global option to `vim.lsp` which controls whether vim should ignore `ClientConfig.exit_timeout` during VimExit. Seems needlessly complicated, so I'm not in favor of this one.\n\nI can also see an argument for forking the servers off to close naturally after neovim has exited if `ClientConfig.exit_timeout` is false, so that they have forever to exit while still not blocking neovim's exit.\n\n> `client:stop()` with timeout is currently also not blocking:\n> https://github.com/neovim/neovim/blob/f9ef1a4cab74defde29afcecfc2c819ecc476b27/runtime/lua/vim/lsp/client.lua?plain=1#L877-L879\n\nAnd there's our bug! I can work on fixing this now. Thanks!",
            "created_at": "2025-12-01T17:24:13Z",
            "html_url": "https://github.com/neovim/neovim/issues/36752#issuecomment-3597867506",
            "id": 3597867506,
            "issue_url": "https://api.github.com/repos/neovim/neovim/issues/36752",
            "node_id": "IC_kwDOAPphoM7Wcxny",
            "performed_via_github_app": null,
            "reactions": {
                "+1": 0,
                "-1": 0,
                "confused": 0,
                "eyes": 0,
                "heart": 0,
                "hooray": 0,
                "laugh": 0,
                "rocket": 0,
                "total_count": 0,
                "url": "https://api.github.com/repos/neovim/neovim/issues/comments/3597867506/reactions"
            },
            "updated_at": "2025-12-01T17:25:21Z",
            "url": "https://api.github.com/repos/neovim/neovim/issues/comments/3597867506",
            "user": {
                "avatar_url": "https://avatars.githubusercontent.com/u/51250849?v=4",
                "events_url": "https://api.github.com/users/superatomic/events{/privacy}",
                "followers_url": "https://api.github.com/users/superatomic/followers",
                "following_url": "https://api.github.com/users/superatomic/following{/other_user}",
                "gists_url": "https://api.github.com/users/superatomic/gists{/gist_id}",
                "gravatar_id": "",
                "html_url": "https://github.com/superatomic",
                "id": 51250849,
                "login": "superatomic",
                "node_id": "MDQ6VXNlcjUxMjUwODQ5",
                "organizations_url": "https://api.github.com/users/superatomic/orgs",
                "received_events_url": "https://api.github.com/users/superatomic/received_events",
                "repos_url": "https://api.github.com/users/superatomic/repos",
                "site_admin": false,
                "starred_url": "https://api.github.com/users/superatomic/starred{/owner}{/repo}",
                "subscriptions_url": "https://api.github.com/users/superatomic/subscriptions",
                "type": "User",
                "url": "https://api.github.com/users/superatomic",
                "user_view_type": "public"
            }
        },
        {
            "author_association": "MEMBER",
            "body": "The default from https://github.com/neovim/neovim/pull/19672 should be preserved, I don't see a reason to change the default. The main point of the recent exit_timeout enhancements is to provide a mechanism for callers of `enable()` (such as `:lsp restart` / `:LspRestart`). But don't need to change the default since it was intentionally decided already.",
            "created_at": "2025-12-01T18:22:53Z",
            "html_url": "https://github.com/neovim/neovim/issues/36752#issuecomment-3598176261",
            "id": 3598176261,
            "issue_url": "https://api.github.com/repos/neovim/neovim/issues/36752",
            "node_id": "IC_kwDOAPphoM7Wd9AF",
            "performed_via_github_app": null,
            "reactions": {
                "+1": 1,
                "-1": 0,
                "confused": 0,
                "eyes": 0,
                "heart": 0,
                "hooray": 0,
                "laugh": 0,
                "rocket": 0,
                "total_count": 1,
                "url": "https://api.github.com/repos/neovim/neovim/issues/comments/3598176261/reactions"
            },
            "updated_at": "2025-12-01T18:22:53Z",
            "url": "https://api.github.com/repos/neovim/neovim/issues/comments/3598176261",
            "user": {
                "avatar_url": "https://avatars.githubusercontent.com/u/1359421?v=4",
                "events_url": "https://api.github.com/users/justinmk/events{/privacy}",
                "followers_url": "https://api.github.com/users/justinmk/followers",
                "following_url": "https://api.github.com/users/justinmk/following{/other_user}",
                "gists_url": "https://api.github.com/users/justinmk/gists{/gist_id}",
                "gravatar_id": "",
                "html_url": "https://github.com/justinmk",
                "id": 1359421,
                "login": "justinmk",
                "node_id": "MDQ6VXNlcjEzNTk0MjE=",
                "organizations_url": "https://api.github.com/users/justinmk/orgs",
                "received_events_url": "https://api.github.com/users/justinmk/received_events",
                "repos_url": "https://api.github.com/users/justinmk/repos",
                "site_admin": false,
                "starred_url": "https://api.github.com/users/justinmk/starred{/owner}{/repo}",
                "subscriptions_url": "https://api.github.com/users/justinmk/subscriptions",
                "type": "User",
                "url": "https://api.github.com/users/justinmk",
                "user_view_type": "public"
            }
        }
    ],
    "comments": 4,
    "comments_url": "https://api.github.com/repos/neovim/neovim/issues/36752/comments",
    "created_at": "2025-11-29T23:30:54Z",
    "events_url": "https://api.github.com/repos/neovim/neovim/issues/36752/events",
    "html_url": "https://github.com/neovim/neovim/issues/36752",
    "id": 3677192912,
    "issue_dependencies_summary": {
        "blocked_by": 0,
        "blocking": 0,
        "total_blocked_by": 0,
        "total_blocking": 0
    },
    "labels": [
        {
            "color": "c5def5",
            "default": false,
            "description": null,
            "id": 662566370,
            "name": "lsp",
            "node_id": "MDU6TGFiZWw2NjI1NjYzNzA=",
            "url": "https://api.github.com/repos/neovim/neovim/labels/lsp"
        },
        {
            "color": "c5def5",
            "default": false,
            "description": "startup, shutdown, attach, detach",
            "id": 870629450,
            "name": "lifecycle",
            "node_id": "MDU6TGFiZWw4NzA2Mjk0NTA=",
            "url": "https://api.github.com/repos/neovim/neovim/labels/lifecycle"
        }
    ],
    "labels_url": "https://api.github.com/repos/neovim/neovim/issues/36752/labels{/name}",
    "locked": false,
    "milestone": null,
    "node_id": "I_kwDOAPphoM7bLYLQ",
    "number": 36752,
    "performed_via_github_app": null,
    "reactions": {
        "+1": 0,
        "-1": 0,
        "confused": 0,
        "eyes": 0,
        "heart": 0,
        "hooray": 0,
        "laugh": 0,
        "rocket": 0,
        "total_count": 0,
        "url": "https://api.github.com/repos/neovim/neovim/issues/36752/reactions"
    },
    "repository_url": "https://api.github.com/repos/neovim/neovim",
    "state": "open",
    "state_reason": null,
    "sub_issues_summary": {
        "completed": 0,
        "percent_completed": 0,
        "total": 0
    },
    "timeline_url": "https://api.github.com/repos/neovim/neovim/issues/36752/timeline",
    "title": "lsp: `ClientConfig.exit_timeout` is ignored on VimExit",
    "type": {
        "color": "red",
        "created_at": "2024-01-25T10:10:19Z",
        "description": "An unexpected problem or behavior",
        "id": 597163,
        "is_enabled": true,
        "name": "Bug",
        "node_id": "IT_kwDOAGK_Pc4ACRyr",
        "updated_at": "2024-07-26T10:12:30Z"
    },
    "updated_at": "2025-12-01T18:22:53Z",
    "url": "https://api.github.com/repos/neovim/neovim/issues/36752",
    "user": {
        "avatar_url": "https://avatars.githubusercontent.com/u/51250849?v=4",
        "events_url": "https://api.github.com/users/superatomic/events{/privacy}",
        "followers_url": "https://api.github.com/users/superatomic/followers",
        "following_url": "https://api.github.com/users/superatomic/following{/other_user}",
        "gists_url": "https://api.github.com/users/superatomic/gists{/gist_id}",
        "gravatar_id": "",
        "html_url": "https://github.com/superatomic",
        "id": 51250849,
        "login": "superatomic",
        "node_id": "MDQ6VXNlcjUxMjUwODQ5",
        "organizations_url": "https://api.github.com/users/superatomic/orgs",
        "received_events_url": "https://api.github.com/users/superatomic/received_events",
        "repos_url": "https://api.github.com/users/superatomic/repos",
        "site_admin": false,
        "starred_url": "https://api.github.com/users/superatomic/starred{/owner}{/repo}",
        "subscriptions_url": "https://api.github.com/users/superatomic/subscriptions",
        "type": "User",
        "url": "https://api.github.com/users/superatomic",
        "user_view_type": "public"
    }
}