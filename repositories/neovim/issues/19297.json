{
    "active_lock_reason": null,
    "assignee": null,
    "assignees": [],
    "author_association": "MEMBER",
    "body": "### Neovim version (nvim -v)\n\nv0.8.0-dev+580-g45ba2e147\n\n### Vim (not Nvim) behaves the same?\n\nNo\n\n### Operating system/version\n\nWindows 10\n\n### Terminal name/version\n\nWindows Terminal\n\n### $TERM environment variable\n\nbuiltin_vtpcon\n\n### Installation\n\nnightly release zip\n\n### How to reproduce the issue\n\n1. Run `nvim --clean`\r\n2. Run\r\n```vim\r\n:argadd `echo foo`\r\n```\r\n3. Run `:echo argv()`\n\n### Expected behavior\n\n`['foo']` is printed\n\n### Actual behavior\n\n`['foo ']` is printed",
    "closed_at": null,
    "closed_by": null,
    "comment_data": [
        {
            "author_association": "MEMBER",
            "body": "Porting Vim patch 8.1.2092 is one way to solve this (see #19313). However that patch looks very hacky and requires setting `shellxquote=(` to work, which isn't always a good idea as described in <https://github.com/neovim/neovim/commit/d31d177a0c2c9997c2cdb04975bc3354b9a23fb8>.\r\n\r\nAnother solution is use `os_expand_wildcards()` instead of `make_filter_cmd()` by defining `SPECIAL_WILDCHAR`:\r\n```diff\r\ndiff --git a/src/nvim/os/shell.c b/src/nvim/os/shell.c\r\n--- a/src/nvim/os/shell.c\r\n+++ b/src/nvim/os/shell.c\r\n@@ -477,6 +477,9 @@ int os_expand_wildcards(int num_pat, char_u **pat, int *num_file, char_u ***file\r\n         || shell_style == STYLE_VIMGLOB) {\r\n       while (!(shell_style == STYLE_ECHO && *p == ' ')\r\n              && *p != '\\n' && *p != NUL) {\r\n+        if (*p == '\\r') {  // On Windows file name ends at CR\r\n+          *p = NUL;\r\n+        }\r\n         p++;\r\n       }\r\n       if (p == buffer + len) {                  // last entry\r\ndiff --git a/src/nvim/os/win_defs.h b/src/nvim/os/win_defs.h\r\n--- a/src/nvim/os/win_defs.h\r\n+++ b/src/nvim/os/win_defs.h\r\n@@ -27,6 +27,9 @@\r\n \r\n #define FNAME_ILLEGAL \"\\\"*?><|\"\r\n \r\n+// Special wildcards that need to be handled by the shell.\r\n+#define SPECIAL_WILDCHAR \"`\"\r\n+\r\n // Character that separates entries in $PATH.\r\n #define ENV_SEPCHAR ';'\r\n #define ENV_SEPSTR  \";\"\r\n```\r\n\r\nThis solution is quite easy, and should work in most shells including cmd.exe and powershell. `os_expand_wildcards()` is already used on Unix, so this may also make behavior more consistent.\r\n\r\nHowever, I'm not sure if using `os_expand_wildcards()` will cause problems. A disadvantage of `os_expand_wildcards()` compared to `make_filter_cmd()` is that it does not respect `'shellredir'`, which may or may not be a good thing.",
            "created_at": "2022-07-11T07:28:32Z",
            "html_url": "https://github.com/neovim/neovim/issues/19297#issuecomment-1180059367",
            "id": 1180059367,
            "issue_url": "https://api.github.com/repos/neovim/neovim/issues/19297",
            "node_id": "IC_kwDOAPphoM5GVkbn",
            "performed_via_github_app": null,
            "reactions": {
                "+1": 0,
                "-1": 0,
                "confused": 0,
                "eyes": 0,
                "heart": 0,
                "hooray": 0,
                "laugh": 0,
                "rocket": 0,
                "total_count": 0,
                "url": "https://api.github.com/repos/neovim/neovim/issues/comments/1180059367/reactions"
            },
            "updated_at": "2022-07-11T07:37:37Z",
            "url": "https://api.github.com/repos/neovim/neovim/issues/comments/1180059367",
            "user": {
                "avatar_url": "https://avatars.githubusercontent.com/u/35768171?v=4",
                "events_url": "https://api.github.com/users/zeertzjq/events{/privacy}",
                "followers_url": "https://api.github.com/users/zeertzjq/followers",
                "following_url": "https://api.github.com/users/zeertzjq/following{/other_user}",
                "gists_url": "https://api.github.com/users/zeertzjq/gists{/gist_id}",
                "gravatar_id": "",
                "html_url": "https://github.com/zeertzjq",
                "id": 35768171,
                "login": "zeertzjq",
                "node_id": "MDQ6VXNlcjM1NzY4MTcx",
                "organizations_url": "https://api.github.com/users/zeertzjq/orgs",
                "received_events_url": "https://api.github.com/users/zeertzjq/received_events",
                "repos_url": "https://api.github.com/users/zeertzjq/repos",
                "site_admin": false,
                "starred_url": "https://api.github.com/users/zeertzjq/starred{/owner}{/repo}",
                "subscriptions_url": "https://api.github.com/users/zeertzjq/subscriptions",
                "type": "User",
                "url": "https://api.github.com/users/zeertzjq",
                "user_view_type": "public"
            }
        },
        {
            "author_association": "MEMBER",
            "body": "Oh, another easy solution may be to just do not add the space before `'shellredir'` when shell is cmd.exe:\r\n```diff\r\ndiff --git a/src/nvim/ex_cmds.c b/src/nvim/ex_cmds.c\r\n--- a/src/nvim/ex_cmds.c\r\n+++ b/src/nvim/ex_cmds.c\r\n@@ -1670,7 +1670,9 @@ void append_redir(char *const buf, const size_t buflen, const char *const opt,\r\n     }\r\n   }\r\n   if (p != NULL) {\r\n-    *end = ' ';  // not really needed? Not with sh, ksh or bash\r\n+    if (STRNCMP(invocation_path_tail(p_sh, NULL), \"cmd\", 3) != 0) {\r\n+      *end = ' ';  // not really needed? Not with sh, ksh or bash\r\n+    }\r\n     vim_snprintf(end + 1, (size_t)((ptrdiff_t)buflen - (end + 1 - buf)), opt, fname);\r\n   } else {\r\n     vim_snprintf(end, (size_t)((ptrdiff_t)buflen - (end - buf)), \" %s %s\", opt, fname);\r\n```",
            "created_at": "2022-07-11T07:57:07Z",
            "html_url": "https://github.com/neovim/neovim/issues/19297#issuecomment-1180082618",
            "id": 1180082618,
            "issue_url": "https://api.github.com/repos/neovim/neovim/issues/19297",
            "node_id": "IC_kwDOAPphoM5GVqG6",
            "performed_via_github_app": null,
            "reactions": {
                "+1": 0,
                "-1": 0,
                "confused": 0,
                "eyes": 0,
                "heart": 0,
                "hooray": 0,
                "laugh": 0,
                "rocket": 0,
                "total_count": 0,
                "url": "https://api.github.com/repos/neovim/neovim/issues/comments/1180082618/reactions"
            },
            "updated_at": "2022-07-11T07:57:07Z",
            "url": "https://api.github.com/repos/neovim/neovim/issues/comments/1180082618",
            "user": {
                "avatar_url": "https://avatars.githubusercontent.com/u/35768171?v=4",
                "events_url": "https://api.github.com/users/zeertzjq/events{/privacy}",
                "followers_url": "https://api.github.com/users/zeertzjq/followers",
                "following_url": "https://api.github.com/users/zeertzjq/following{/other_user}",
                "gists_url": "https://api.github.com/users/zeertzjq/gists{/gist_id}",
                "gravatar_id": "",
                "html_url": "https://github.com/zeertzjq",
                "id": 35768171,
                "login": "zeertzjq",
                "node_id": "MDQ6VXNlcjM1NzY4MTcx",
                "organizations_url": "https://api.github.com/users/zeertzjq/orgs",
                "received_events_url": "https://api.github.com/users/zeertzjq/received_events",
                "repos_url": "https://api.github.com/users/zeertzjq/repos",
                "site_admin": false,
                "starred_url": "https://api.github.com/users/zeertzjq/starred{/owner}{/repo}",
                "subscriptions_url": "https://api.github.com/users/zeertzjq/subscriptions",
                "type": "User",
                "url": "https://api.github.com/users/zeertzjq",
                "user_view_type": "public"
            }
        },
        {
            "author_association": "CONTRIBUTOR",
            "body": "> However, I'm not sure if using os_expand_wildcards() will cause problems. A disadvantage of os_expand_wildcards() compared to make_filter_cmd() is that it does not respect 'shellredir', which may or may not be a good thing.\r\n\r\nI thought `make_filter_cmd()` was for editing the buffer with a shell command (hence the term filter in the name). Running `:!<cmd>` doesn't call `make_filter_cmd` (I don't think). Why should running `:<vim_cmd> \\`<shell_cmd>\\`` call it?",
            "created_at": "2022-07-14T02:57:07Z",
            "html_url": "https://github.com/neovim/neovim/issues/19297#issuecomment-1183927818",
            "id": 1183927818,
            "issue_url": "https://api.github.com/repos/neovim/neovim/issues/19297",
            "node_id": "IC_kwDOAPphoM5GkU4K",
            "performed_via_github_app": null,
            "reactions": {
                "+1": 0,
                "-1": 0,
                "confused": 0,
                "eyes": 0,
                "heart": 0,
                "hooray": 0,
                "laugh": 0,
                "rocket": 0,
                "total_count": 0,
                "url": "https://api.github.com/repos/neovim/neovim/issues/comments/1183927818/reactions"
            },
            "updated_at": "2022-07-14T02:57:07Z",
            "url": "https://api.github.com/repos/neovim/neovim/issues/comments/1183927818",
            "user": {
                "avatar_url": "https://avatars.githubusercontent.com/u/32037751?v=4",
                "events_url": "https://api.github.com/users/3N4N/events{/privacy}",
                "followers_url": "https://api.github.com/users/3N4N/followers",
                "following_url": "https://api.github.com/users/3N4N/following{/other_user}",
                "gists_url": "https://api.github.com/users/3N4N/gists{/gist_id}",
                "gravatar_id": "",
                "html_url": "https://github.com/3N4N",
                "id": 32037751,
                "login": "3N4N",
                "node_id": "MDQ6VXNlcjMyMDM3NzUx",
                "organizations_url": "https://api.github.com/users/3N4N/orgs",
                "received_events_url": "https://api.github.com/users/3N4N/received_events",
                "repos_url": "https://api.github.com/users/3N4N/repos",
                "site_admin": false,
                "starred_url": "https://api.github.com/users/3N4N/starred{/owner}{/repo}",
                "subscriptions_url": "https://api.github.com/users/3N4N/subscriptions",
                "type": "User",
                "url": "https://api.github.com/users/3N4N",
                "user_view_type": "public"
            }
        },
        {
            "author_association": "MEMBER",
            "body": "Using `make_filter_cmd()` for backtick expansion only on non-Unix indeed doesn't seem to make much sense. `os_expand_wildcards()` uses something like `(%s)>%s` for any unknown shells, and this syntax seems to work in both cmd.exe and powershell. If `os_expand_wildcards()` is used for backtick expansion on Windows, it may need to be changed to also check for shells with `.exe` suffix.",
            "created_at": "2022-07-14T03:34:17Z",
            "html_url": "https://github.com/neovim/neovim/issues/19297#issuecomment-1183945629",
            "id": 1183945629,
            "issue_url": "https://api.github.com/repos/neovim/neovim/issues/19297",
            "node_id": "IC_kwDOAPphoM5GkZOd",
            "performed_via_github_app": null,
            "reactions": {
                "+1": 1,
                "-1": 0,
                "confused": 0,
                "eyes": 0,
                "heart": 0,
                "hooray": 0,
                "laugh": 0,
                "rocket": 0,
                "total_count": 1,
                "url": "https://api.github.com/repos/neovim/neovim/issues/comments/1183945629/reactions"
            },
            "updated_at": "2022-07-14T03:34:32Z",
            "url": "https://api.github.com/repos/neovim/neovim/issues/comments/1183945629",
            "user": {
                "avatar_url": "https://avatars.githubusercontent.com/u/35768171?v=4",
                "events_url": "https://api.github.com/users/zeertzjq/events{/privacy}",
                "followers_url": "https://api.github.com/users/zeertzjq/followers",
                "following_url": "https://api.github.com/users/zeertzjq/following{/other_user}",
                "gists_url": "https://api.github.com/users/zeertzjq/gists{/gist_id}",
                "gravatar_id": "",
                "html_url": "https://github.com/zeertzjq",
                "id": 35768171,
                "login": "zeertzjq",
                "node_id": "MDQ6VXNlcjM1NzY4MTcx",
                "organizations_url": "https://api.github.com/users/zeertzjq/orgs",
                "received_events_url": "https://api.github.com/users/zeertzjq/received_events",
                "repos_url": "https://api.github.com/users/zeertzjq/repos",
                "site_admin": false,
                "starred_url": "https://api.github.com/users/zeertzjq/starred{/owner}{/repo}",
                "subscriptions_url": "https://api.github.com/users/zeertzjq/subscriptions",
                "type": "User",
                "url": "https://api.github.com/users/zeertzjq",
                "user_view_type": "public"
            }
        },
        {
            "author_association": "MEMBER",
            "body": "Note: remove this line when this is fixed:\r\n<https://github.com/neovim/neovim/blob/63e4436d8e9d25548cdc7c5b7e334ef164c150fc/src/nvim/testdir/test_cmdline.vim#L1423>",
            "created_at": "2022-08-15T23:55:13Z",
            "html_url": "https://github.com/neovim/neovim/issues/19297#issuecomment-1215994895",
            "id": 1215994895,
            "issue_url": "https://api.github.com/repos/neovim/neovim/issues/19297",
            "node_id": "IC_kwDOAPphoM5IepwP",
            "performed_via_github_app": null,
            "reactions": {
                "+1": 0,
                "-1": 0,
                "confused": 0,
                "eyes": 0,
                "heart": 0,
                "hooray": 0,
                "laugh": 0,
                "rocket": 0,
                "total_count": 0,
                "url": "https://api.github.com/repos/neovim/neovim/issues/comments/1215994895/reactions"
            },
            "updated_at": "2022-08-15T23:55:13Z",
            "url": "https://api.github.com/repos/neovim/neovim/issues/comments/1215994895",
            "user": {
                "avatar_url": "https://avatars.githubusercontent.com/u/35768171?v=4",
                "events_url": "https://api.github.com/users/zeertzjq/events{/privacy}",
                "followers_url": "https://api.github.com/users/zeertzjq/followers",
                "following_url": "https://api.github.com/users/zeertzjq/following{/other_user}",
                "gists_url": "https://api.github.com/users/zeertzjq/gists{/gist_id}",
                "gravatar_id": "",
                "html_url": "https://github.com/zeertzjq",
                "id": 35768171,
                "login": "zeertzjq",
                "node_id": "MDQ6VXNlcjM1NzY4MTcx",
                "organizations_url": "https://api.github.com/users/zeertzjq/orgs",
                "received_events_url": "https://api.github.com/users/zeertzjq/received_events",
                "repos_url": "https://api.github.com/users/zeertzjq/repos",
                "site_admin": false,
                "starred_url": "https://api.github.com/users/zeertzjq/starred{/owner}{/repo}",
                "subscriptions_url": "https://api.github.com/users/zeertzjq/subscriptions",
                "type": "User",
                "url": "https://api.github.com/users/zeertzjq",
                "user_view_type": "public"
            }
        }
    ],
    "comments": 5,
    "comments_url": "https://api.github.com/repos/neovim/neovim/issues/19297/comments",
    "created_at": "2022-07-09T12:39:12Z",
    "events_url": "https://api.github.com/repos/neovim/neovim/issues/19297/events",
    "html_url": "https://github.com/neovim/neovim/issues/19297",
    "id": 1299662118,
    "labels": [
        {
            "color": "d4c5f9",
            "default": false,
            "description": null,
            "id": 109461219,
            "name": "platform:windows",
            "node_id": "MDU6TGFiZWwxMDk0NjEyMTk=",
            "url": "https://api.github.com/repos/neovim/neovim/labels/platform:windows"
        }
    ],
    "labels_url": "https://api.github.com/repos/neovim/neovim/issues/19297/labels{/name}",
    "locked": false,
    "milestone": null,
    "node_id": "I_kwDOAPphoM5Nd0Um",
    "number": 19297,
    "performed_via_github_app": null,
    "reactions": {
        "+1": 0,
        "-1": 0,
        "confused": 0,
        "eyes": 0,
        "heart": 0,
        "hooray": 0,
        "laugh": 0,
        "rocket": 0,
        "total_count": 0,
        "url": "https://api.github.com/repos/neovim/neovim/issues/19297/reactions"
    },
    "repository_url": "https://api.github.com/repos/neovim/neovim",
    "state": "open",
    "state_reason": null,
    "sub_issues_summary": {
        "completed": 0,
        "percent_completed": 0,
        "total": 0
    },
    "timeline_url": "https://api.github.com/repos/neovim/neovim/issues/19297/timeline",
    "title": "backtick expansion has a trailing space when shell is cmd.exe ",
    "type": {
        "color": "red",
        "created_at": "2024-01-25T10:10:19Z",
        "description": "An unexpected problem or behavior",
        "id": 597163,
        "is_enabled": true,
        "name": "Bug",
        "node_id": "IT_kwDOAGK_Pc4ACRyr",
        "updated_at": "2024-07-26T10:12:30Z"
    },
    "updated_at": "2025-07-02T08:37:12Z",
    "url": "https://api.github.com/repos/neovim/neovim/issues/19297",
    "user": {
        "avatar_url": "https://avatars.githubusercontent.com/u/35768171?v=4",
        "events_url": "https://api.github.com/users/zeertzjq/events{/privacy}",
        "followers_url": "https://api.github.com/users/zeertzjq/followers",
        "following_url": "https://api.github.com/users/zeertzjq/following{/other_user}",
        "gists_url": "https://api.github.com/users/zeertzjq/gists{/gist_id}",
        "gravatar_id": "",
        "html_url": "https://github.com/zeertzjq",
        "id": 35768171,
        "login": "zeertzjq",
        "node_id": "MDQ6VXNlcjM1NzY4MTcx",
        "organizations_url": "https://api.github.com/users/zeertzjq/orgs",
        "received_events_url": "https://api.github.com/users/zeertzjq/received_events",
        "repos_url": "https://api.github.com/users/zeertzjq/repos",
        "site_admin": false,
        "starred_url": "https://api.github.com/users/zeertzjq/starred{/owner}{/repo}",
        "subscriptions_url": "https://api.github.com/users/zeertzjq/subscriptions",
        "type": "User",
        "url": "https://api.github.com/users/zeertzjq",
        "user_view_type": "public"
    }
}