{
    "active_lock_reason": null,
    "assignee": null,
    "assignees": [],
    "author_association": "CONTRIBUTOR",
    "body": "While working on https://github.com/neovim/neovim/pull/13979 I noticed some strange behavior.\r\n\r\n### Actual behaviour\r\nWhen calling `Join` on the second line of\r\n```rust\r\nfn main() {\r\n    println!(\"Hello, world!\");\r\n}\r\n```\r\n\r\non_bytes is only triggered once, what is received for the change that ultimately results in (note the space after the semicolon):\r\n\r\n```rust\r\nfn main() {\r\n    println!(\"Hello, world!\"); }\r\n```\r\nis the following (single) notification. Note the state of the line after on_bytes has been called does not include the space.\r\n\r\n```\r\n{\r\n  byte_offset = 42,\r\n  lines = { '    println!(\"Hello, world!\");' },\r\n  new_end_byte_length = 1,\r\n  new_end_column = 1,\r\n  new_end_row = 0,\r\n  old_end_byte_length = 1,\r\n  old_end_column = 0,\r\n  old_end_row = 1,\r\n  start_column = 30,\r\n  start_row = 1,\r\n}\r\n```\r\n\r\nThe missing space is causing offset errors when I try to use on_bytes to send the updates to the language server client\r\n",
    "closed_at": null,
    "closed_by": null,
    "comment_data": [
        {
            "author_association": "CONTRIBUTOR",
            "body": "Hmm, are you sure that it is the space update that is missing? From what I can tell from a brief look at the code (I could totally be wrong), the update for inserting the space gets sent, but it is the subsequent deletion and move of the below line that does not get spliced.",
            "created_at": "2021-03-02T10:17:38Z",
            "html_url": "https://github.com/neovim/neovim/issues/14043#issuecomment-788795312",
            "id": 788795312,
            "issue_url": "https://api.github.com/repos/neovim/neovim/issues/14043",
            "node_id": "MDEyOklzc3VlQ29tbWVudDc4ODc5NTMxMg==",
            "performed_via_github_app": null,
            "reactions": {
                "+1": 0,
                "-1": 0,
                "confused": 0,
                "eyes": 0,
                "heart": 0,
                "hooray": 0,
                "laugh": 0,
                "rocket": 0,
                "total_count": 0,
                "url": "https://api.github.com/repos/neovim/neovim/issues/comments/788795312/reactions"
            },
            "updated_at": "2021-03-02T10:17:38Z",
            "url": "https://api.github.com/repos/neovim/neovim/issues/comments/788795312",
            "user": {
                "avatar_url": "https://avatars.githubusercontent.com/u/36219739?v=4",
                "events_url": "https://api.github.com/users/chentoast/events{/privacy}",
                "followers_url": "https://api.github.com/users/chentoast/followers",
                "following_url": "https://api.github.com/users/chentoast/following{/other_user}",
                "gists_url": "https://api.github.com/users/chentoast/gists{/gist_id}",
                "gravatar_id": "",
                "html_url": "https://github.com/chentoast",
                "id": 36219739,
                "login": "chentoast",
                "node_id": "MDQ6VXNlcjM2MjE5NzM5",
                "organizations_url": "https://api.github.com/users/chentoast/orgs",
                "received_events_url": "https://api.github.com/users/chentoast/received_events",
                "repos_url": "https://api.github.com/users/chentoast/repos",
                "site_admin": false,
                "starred_url": "https://api.github.com/users/chentoast/starred{/owner}{/repo}",
                "subscriptions_url": "https://api.github.com/users/chentoast/subscriptions",
                "type": "User",
                "url": "https://api.github.com/users/chentoast",
                "user_view_type": "public"
            }
        },
        {
            "author_association": "MEMBER",
            "body": "Is this dependent on filetype settings?",
            "created_at": "2021-03-02T10:52:24Z",
            "html_url": "https://github.com/neovim/neovim/issues/14043#issuecomment-788817327",
            "id": 788817327,
            "issue_url": "https://api.github.com/repos/neovim/neovim/issues/14043",
            "node_id": "MDEyOklzc3VlQ29tbWVudDc4ODgxNzMyNw==",
            "performed_via_github_app": null,
            "reactions": {
                "+1": 0,
                "-1": 0,
                "confused": 0,
                "eyes": 0,
                "heart": 0,
                "hooray": 0,
                "laugh": 0,
                "rocket": 0,
                "total_count": 0,
                "url": "https://api.github.com/repos/neovim/neovim/issues/comments/788817327/reactions"
            },
            "updated_at": "2021-03-02T10:52:24Z",
            "url": "https://api.github.com/repos/neovim/neovim/issues/comments/788817327",
            "user": {
                "avatar_url": "https://avatars.githubusercontent.com/u/1363104?v=4",
                "events_url": "https://api.github.com/users/bfredl/events{/privacy}",
                "followers_url": "https://api.github.com/users/bfredl/followers",
                "following_url": "https://api.github.com/users/bfredl/following{/other_user}",
                "gists_url": "https://api.github.com/users/bfredl/gists{/gist_id}",
                "gravatar_id": "",
                "html_url": "https://github.com/bfredl",
                "id": 1363104,
                "login": "bfredl",
                "node_id": "MDQ6VXNlcjEzNjMxMDQ=",
                "organizations_url": "https://api.github.com/users/bfredl/orgs",
                "received_events_url": "https://api.github.com/users/bfredl/received_events",
                "repos_url": "https://api.github.com/users/bfredl/repos",
                "site_admin": false,
                "starred_url": "https://api.github.com/users/bfredl/starred{/owner}{/repo}",
                "subscriptions_url": "https://api.github.com/users/bfredl/subscriptions",
                "type": "User",
                "url": "https://api.github.com/users/bfredl",
                "user_view_type": "public"
            }
        },
        {
            "author_association": "MEMBER",
            "body": "seems to work like expected: \r\n\r\n```diff\r\ndiff --git a/test/functional/lua/buffer_updates_spec.lua b/test/functional/lua/buffer_updates_spec.lua\r\nindex 8c5e93690..5a5a521e8 100644\r\n--- a/test/functional/lua/buffer_updates_spec.lua\r\n+++ b/test/functional/lua/buffer_updates_spec.lua\r\n@@ -379,6 +379,15 @@ describe('lua: nvim_buf_attach on_bytes', function()\r\n         }\r\n     end)\r\n \r\n+    it('suspicious join', function()\r\n+      local check_events = setup_eventcheck(verify, {'fn main() {', '    println!(\"Hello, world!\");', '}'})\r\n+      feed '2GJ'\r\n+      check_events {\r\n+        { \"test1\", \"bytes\", 1, 3, 1, 30, 42, 1, 0, 1, 0, 1, 1 };\r\n+      }\r\n+      eq({'fn main() {', '    println!(\"Hello, world!\"); }'}, meths.buf_get_lines(0, 0, -1, true))\r\n+    end)\r\n+\r\n     it('opening lines', function()\r\n         local check_events = setup_eventcheck(verify, origlines)\r\n         -- meths.buf_set_option(0, 'autoindent', true)\r\n\r\n```",
            "created_at": "2021-03-02T10:59:11Z",
            "html_url": "https://github.com/neovim/neovim/issues/14043#issuecomment-788821443",
            "id": 788821443,
            "issue_url": "https://api.github.com/repos/neovim/neovim/issues/14043",
            "node_id": "MDEyOklzc3VlQ29tbWVudDc4ODgyMTQ0Mw==",
            "performed_via_github_app": null,
            "reactions": {
                "+1": 0,
                "-1": 0,
                "confused": 0,
                "eyes": 0,
                "heart": 0,
                "hooray": 0,
                "laugh": 0,
                "rocket": 0,
                "total_count": 0,
                "url": "https://api.github.com/repos/neovim/neovim/issues/comments/788821443/reactions"
            },
            "updated_at": "2021-03-02T10:59:11Z",
            "url": "https://api.github.com/repos/neovim/neovim/issues/comments/788821443",
            "user": {
                "avatar_url": "https://avatars.githubusercontent.com/u/1363104?v=4",
                "events_url": "https://api.github.com/users/bfredl/events{/privacy}",
                "followers_url": "https://api.github.com/users/bfredl/followers",
                "following_url": "https://api.github.com/users/bfredl/following{/other_user}",
                "gists_url": "https://api.github.com/users/bfredl/gists{/gist_id}",
                "gravatar_id": "",
                "html_url": "https://github.com/bfredl",
                "id": 1363104,
                "login": "bfredl",
                "node_id": "MDQ6VXNlcjEzNjMxMDQ=",
                "organizations_url": "https://api.github.com/users/bfredl/orgs",
                "received_events_url": "https://api.github.com/users/bfredl/received_events",
                "repos_url": "https://api.github.com/users/bfredl/repos",
                "site_admin": false,
                "starred_url": "https://api.github.com/users/bfredl/starred{/owner}{/repo}",
                "subscriptions_url": "https://api.github.com/users/bfredl/subscriptions",
                "type": "User",
                "url": "https://api.github.com/users/bfredl",
                "user_view_type": "public"
            }
        },
        {
            "author_association": "CONTRIBUTOR",
            "body": "The problem is I need to be able to send the inserted \" \" character to the language server, as there is no space in the original buffer representation of `;'\\n'}'\\n` which gets converted to `; }'\\n` (including terminating newline for clarity). Maybe I'm misunderstanding something, but I believe we have to send the updated text range to include the new space to keep the server representation matching, but the new line is not present at the invocation of on_bytes.\r\n\r\nRe: Filetypes, I'm testing this with rust + rust-analyzer",
            "created_at": "2021-03-02T17:54:16Z",
            "html_url": "https://github.com/neovim/neovim/issues/14043#issuecomment-789094617",
            "id": 789094617,
            "issue_url": "https://api.github.com/repos/neovim/neovim/issues/14043",
            "node_id": "MDEyOklzc3VlQ29tbWVudDc4OTA5NDYxNw==",
            "performed_via_github_app": null,
            "reactions": {
                "+1": 0,
                "-1": 0,
                "confused": 0,
                "eyes": 0,
                "heart": 0,
                "hooray": 0,
                "laugh": 0,
                "rocket": 0,
                "total_count": 0,
                "url": "https://api.github.com/repos/neovim/neovim/issues/comments/789094617/reactions"
            },
            "updated_at": "2021-03-02T17:54:40Z",
            "url": "https://api.github.com/repos/neovim/neovim/issues/comments/789094617",
            "user": {
                "avatar_url": "https://avatars.githubusercontent.com/u/13316262?v=4",
                "events_url": "https://api.github.com/users/mjlbach/events{/privacy}",
                "followers_url": "https://api.github.com/users/mjlbach/followers",
                "following_url": "https://api.github.com/users/mjlbach/following{/other_user}",
                "gists_url": "https://api.github.com/users/mjlbach/gists{/gist_id}",
                "gravatar_id": "",
                "html_url": "https://github.com/mjlbach",
                "id": 13316262,
                "login": "mjlbach",
                "node_id": "MDQ6VXNlcjEzMzE2MjYy",
                "organizations_url": "https://api.github.com/users/mjlbach/orgs",
                "received_events_url": "https://api.github.com/users/mjlbach/received_events",
                "repos_url": "https://api.github.com/users/mjlbach/repos",
                "site_admin": false,
                "starred_url": "https://api.github.com/users/mjlbach/starred{/owner}{/repo}",
                "subscriptions_url": "https://api.github.com/users/mjlbach/subscriptions",
                "type": "User",
                "url": "https://api.github.com/users/mjlbach",
                "user_view_type": "public"
            }
        },
        {
            "author_association": "MEMBER",
            "body": "hmm unfortunately on_bytes updates, in general, are not synced to buffer contents (at time of callback) with this level of resolution. I could \"trivially\" fix this for forward join, but not for undo join as in this case neither the prior nor posterior buffer state will be compatible with intermediate events.\r\n\r\nAt the time of writing this code, it was designed with the constraints imposed by extmarks and tree-sitter, while it was generally understood by all  outspoken at the time that line-level resolution was enough for LSP.. Retrofitting it for this usecase will unfortunately hit a lot of cases like this, especially regarding undo, and refactoring the undo representation for updates is my goal for 0.6, but not realistic within the 0.5 timeframe.",
            "created_at": "2021-03-02T18:53:59Z",
            "html_url": "https://github.com/neovim/neovim/issues/14043#issuecomment-789134018",
            "id": 789134018,
            "issue_url": "https://api.github.com/repos/neovim/neovim/issues/14043",
            "node_id": "MDEyOklzc3VlQ29tbWVudDc4OTEzNDAxOA==",
            "performed_via_github_app": null,
            "reactions": {
                "+1": 0,
                "-1": 0,
                "confused": 0,
                "eyes": 0,
                "heart": 0,
                "hooray": 0,
                "laugh": 0,
                "rocket": 0,
                "total_count": 0,
                "url": "https://api.github.com/repos/neovim/neovim/issues/comments/789134018/reactions"
            },
            "updated_at": "2021-03-02T18:53:59Z",
            "url": "https://api.github.com/repos/neovim/neovim/issues/comments/789134018",
            "user": {
                "avatar_url": "https://avatars.githubusercontent.com/u/1363104?v=4",
                "events_url": "https://api.github.com/users/bfredl/events{/privacy}",
                "followers_url": "https://api.github.com/users/bfredl/followers",
                "following_url": "https://api.github.com/users/bfredl/following{/other_user}",
                "gists_url": "https://api.github.com/users/bfredl/gists{/gist_id}",
                "gravatar_id": "",
                "html_url": "https://github.com/bfredl",
                "id": 1363104,
                "login": "bfredl",
                "node_id": "MDQ6VXNlcjEzNjMxMDQ=",
                "organizations_url": "https://api.github.com/users/bfredl/orgs",
                "received_events_url": "https://api.github.com/users/bfredl/received_events",
                "repos_url": "https://api.github.com/users/bfredl/repos",
                "site_admin": false,
                "starred_url": "https://api.github.com/users/bfredl/starred{/owner}{/repo}",
                "subscriptions_url": "https://api.github.com/users/bfredl/subscriptions",
                "type": "User",
                "url": "https://api.github.com/users/bfredl",
                "user_view_type": "public"
            }
        },
        {
            "author_association": "CONTRIBUTOR",
            "body": "That makes sense! No worries, thank you for clarifying and the explanation. I'll milestone on_bytes updates for LSP for 0.6. I'm happy to also help out with fixing on_bytes for the corner cases as I think I found a lot of them trying to get the LSP updates working.",
            "created_at": "2021-03-02T19:12:10Z",
            "html_url": "https://github.com/neovim/neovim/issues/14043#issuecomment-789145694",
            "id": 789145694,
            "issue_url": "https://api.github.com/repos/neovim/neovim/issues/14043",
            "node_id": "MDEyOklzc3VlQ29tbWVudDc4OTE0NTY5NA==",
            "performed_via_github_app": null,
            "reactions": {
                "+1": 0,
                "-1": 0,
                "confused": 0,
                "eyes": 0,
                "heart": 0,
                "hooray": 0,
                "laugh": 0,
                "rocket": 0,
                "total_count": 0,
                "url": "https://api.github.com/repos/neovim/neovim/issues/comments/789145694/reactions"
            },
            "updated_at": "2021-03-02T19:12:20Z",
            "url": "https://api.github.com/repos/neovim/neovim/issues/comments/789145694",
            "user": {
                "avatar_url": "https://avatars.githubusercontent.com/u/13316262?v=4",
                "events_url": "https://api.github.com/users/mjlbach/events{/privacy}",
                "followers_url": "https://api.github.com/users/mjlbach/followers",
                "following_url": "https://api.github.com/users/mjlbach/following{/other_user}",
                "gists_url": "https://api.github.com/users/mjlbach/gists{/gist_id}",
                "gravatar_id": "",
                "html_url": "https://github.com/mjlbach",
                "id": 13316262,
                "login": "mjlbach",
                "node_id": "MDQ6VXNlcjEzMzE2MjYy",
                "organizations_url": "https://api.github.com/users/mjlbach/orgs",
                "received_events_url": "https://api.github.com/users/mjlbach/received_events",
                "repos_url": "https://api.github.com/users/mjlbach/repos",
                "site_admin": false,
                "starred_url": "https://api.github.com/users/mjlbach/starred{/owner}{/repo}",
                "subscriptions_url": "https://api.github.com/users/mjlbach/subscriptions",
                "type": "User",
                "url": "https://api.github.com/users/mjlbach",
                "user_view_type": "public"
            }
        },
        {
            "author_association": "CONTRIBUTOR",
            "body": "Actual reproduction:\r\n\r\n```lua\r\nlocal edit_buf = vim.api.nvim_create_buf(true, true)\r\n\r\nvim.api.nvim_set_current_buf(edit_buf)\r\n\r\nvim.api.nvim_buf_set_lines(edit_buf, 0, -1, true, { 'test1 test2', 'test2' })\r\n\r\nlocal prev_lines = vim.api.nvim_buf_get_lines(edit_buf, 0, -1, true)\r\nlocal curr_lines = prev_lines\r\n\r\nlocal callback = function(buf)\r\n  curr_lines = vim.api.nvim_buf_get_lines(buf, 0, -1, true)\r\n  print(vim.inspect(prev_lines))\r\n  print(vim.inspect(curr_lines))\r\n  prev_lines=curr_lines\r\nend\r\n\r\nvim.api.nvim_buf_attach(edit_buf, false, { on_bytes = callback })\r\nvim.api.nvim_feedkeys('J', 'n', false)\r\n```",
            "created_at": "2021-11-06T01:40:49Z",
            "html_url": "https://github.com/neovim/neovim/issues/14043#issuecomment-962351726",
            "id": 962351726,
            "issue_url": "https://api.github.com/repos/neovim/neovim/issues/14043",
            "node_id": "IC_kwDOAPphoM45XFJu",
            "performed_via_github_app": null,
            "reactions": {
                "+1": 0,
                "-1": 0,
                "confused": 0,
                "eyes": 0,
                "heart": 0,
                "hooray": 0,
                "laugh": 0,
                "rocket": 0,
                "total_count": 0,
                "url": "https://api.github.com/repos/neovim/neovim/issues/comments/962351726/reactions"
            },
            "updated_at": "2021-11-06T01:40:55Z",
            "url": "https://api.github.com/repos/neovim/neovim/issues/comments/962351726",
            "user": {
                "avatar_url": "https://avatars.githubusercontent.com/u/13316262?v=4",
                "events_url": "https://api.github.com/users/mjlbach/events{/privacy}",
                "followers_url": "https://api.github.com/users/mjlbach/followers",
                "following_url": "https://api.github.com/users/mjlbach/following{/other_user}",
                "gists_url": "https://api.github.com/users/mjlbach/gists{/gist_id}",
                "gravatar_id": "",
                "html_url": "https://github.com/mjlbach",
                "id": 13316262,
                "login": "mjlbach",
                "node_id": "MDQ6VXNlcjEzMzE2MjYy",
                "organizations_url": "https://api.github.com/users/mjlbach/orgs",
                "received_events_url": "https://api.github.com/users/mjlbach/received_events",
                "repos_url": "https://api.github.com/users/mjlbach/repos",
                "site_admin": false,
                "starred_url": "https://api.github.com/users/mjlbach/starred{/owner}{/repo}",
                "subscriptions_url": "https://api.github.com/users/mjlbach/subscriptions",
                "type": "User",
                "url": "https://api.github.com/users/mjlbach",
                "user_view_type": "public"
            }
        }
    ],
    "comments": 7,
    "comments_url": "https://api.github.com/repos/neovim/neovim/issues/14043/comments",
    "created_at": "2021-03-02T05:37:04Z",
    "events_url": "https://api.github.com/repos/neovim/neovim/issues/14043/events",
    "html_url": "https://github.com/neovim/neovim/issues/14043",
    "id": 819649988,
    "labels": [],
    "labels_url": "https://api.github.com/repos/neovim/neovim/issues/14043/labels{/name}",
    "locked": false,
    "milestone": null,
    "node_id": "MDU6SXNzdWU4MTk2NDk5ODg=",
    "number": 14043,
    "performed_via_github_app": null,
    "reactions": {
        "+1": 0,
        "-1": 0,
        "confused": 0,
        "eyes": 0,
        "heart": 0,
        "hooray": 0,
        "laugh": 0,
        "rocket": 0,
        "total_count": 0,
        "url": "https://api.github.com/repos/neovim/neovim/issues/14043/reactions"
    },
    "repository_url": "https://api.github.com/repos/neovim/neovim",
    "state": "open",
    "state_reason": null,
    "sub_issues_summary": {
        "completed": 0,
        "percent_completed": 0,
        "total": 0
    },
    "timeline_url": "https://api.github.com/repos/neovim/neovim/issues/14043/timeline",
    "title": "on_bytes not triggered on second half of Join",
    "type": {
        "color": "red",
        "created_at": "2024-01-25T10:10:19Z",
        "description": "An unexpected problem or behavior",
        "id": 597163,
        "is_enabled": true,
        "name": "Bug",
        "node_id": "IT_kwDOAGK_Pc4ACRyr",
        "updated_at": "2024-07-26T10:12:30Z"
    },
    "updated_at": "2025-07-02T08:36:11Z",
    "url": "https://api.github.com/repos/neovim/neovim/issues/14043",
    "user": {
        "avatar_url": "https://avatars.githubusercontent.com/u/13316262?v=4",
        "events_url": "https://api.github.com/users/mjlbach/events{/privacy}",
        "followers_url": "https://api.github.com/users/mjlbach/followers",
        "following_url": "https://api.github.com/users/mjlbach/following{/other_user}",
        "gists_url": "https://api.github.com/users/mjlbach/gists{/gist_id}",
        "gravatar_id": "",
        "html_url": "https://github.com/mjlbach",
        "id": 13316262,
        "login": "mjlbach",
        "node_id": "MDQ6VXNlcjEzMzE2MjYy",
        "organizations_url": "https://api.github.com/users/mjlbach/orgs",
        "received_events_url": "https://api.github.com/users/mjlbach/received_events",
        "repos_url": "https://api.github.com/users/mjlbach/repos",
        "site_admin": false,
        "starred_url": "https://api.github.com/users/mjlbach/starred{/owner}{/repo}",
        "subscriptions_url": "https://api.github.com/users/mjlbach/subscriptions",
        "type": "User",
        "url": "https://api.github.com/users/mjlbach",
        "user_view_type": "public"
    }
}