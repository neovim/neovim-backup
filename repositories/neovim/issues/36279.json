{
    "active_lock_reason": null,
    "assignee": null,
    "assignees": [],
    "author_association": "NONE",
    "body": "### Problem\n\n### Bug: `vim.defer_fn` callbacks may execute after buffer unload, leading to invalid memory access in Lua state\n\n**Neovim version:**\n\n```\nNVIM v0.10.1\nBuild type: Release\nLuaJIT 2.1.1703357835\nCompiled by gcc-13\n```\n\n**Operating system/version:**\nArch Linux (kernel 6.10.8-arch1-1, glibc 2.40)\n\n---\n\n### Description\n\nWhen scheduling a deferred function with `vim.defer_fn`, the callback can still execute **after** its owning buffer or window has been unloaded. This can trigger invalid access on buffer handles or cause segmentation faults if the Lua state references buffer-local variables that no longer exist.\n\nThis appears to occur when the event loop is busy (e.g., heavy LSP activity or async I/O) and `vim.defer_fn` callbacks are queued but not processed before `:bdelete` or `:bwipeout`.\n\n---\n\n### Minimal Reproduction\n\n```lua\n-- steps to reproduce:\nvim.api.nvim_create_autocmd('BufEnter', {\n  buffer = 0,\n  callback = function()\n    vim.defer_fn(function()\n      -- this will execute after buffer is deleted\n      vim.api.nvim_buf_set_lines(0, 0, -1, false, {\"deferred write\"})\n    end, 100)\n  end\n})\n\nvim.api.nvim_command(\"new | bdelete #\")\n```\n\n**Expected behavior:**\nDeferred callback is silently dropped or safely ignored if buffer handle is invalid.\n\n**Actual behavior:**\n\n```\nE5108: Error executing lua ...:0: Invalid buffer id: 1\n```\n\nIn some cases, Neovim crashes with:\n\n```\nPANIC: unprotected error in call to Lua API (attempt to index a nil value)\n```\n\n---\n\n### Technical Notes\n\nAfter digging into `src/nvim/lua/executor.c`, it seems the callback is registered in the main loop timer without buffer ownership context. When the buffer is freed, the Lua reference persists until the timer executes.\n\nA potential fix might involve tagging the `lua_ref` with a buffer handle and validating it before execution, similar to how `nvim_buf_attach` handles dead buffers.\n\nAlternatively, `vim.defer_fn` could be wrapped in a safe check via `nvim_buf_is_valid()` before invoking the callback.\n\n### Steps to reproduce\n\n```lua\n-- steps to reproduce:\nvim.api.nvim_create_autocmd('BufEnter', {\n  buffer = 0,\n  callback = function()\n    vim.defer_fn(function()\n      -- this will execute after buffer is deleted\n      vim.api.nvim_buf_set_lines(0, 0, -1, false, {\"deferred write\"})\n    end, 100)\n  end\n})\n\nvim.api.nvim_command(\"new | bdelete #\")\n```\n\n\n### Expected behavior\n\nWhen scheduling a deferred function with `vim.defer_fn`, the callback can still execute **after** its owning buffer or window has been unloaded. This can trigger invalid access on buffer handles or cause segmentation faults if the Lua state references buffer-local variables that no longer exist.\n\nThis appears to occur when the event loop is busy (e.g., heavy LSP activity or async I/O) and `vim.defer_fn` callbacks are queued but not processed before `:bdelete` or `:bwipeout`.\n\n### Nvim version (nvim -v)\n\n0.10\n\n### Vim (not Nvim) behaves the same?\n\nyes\n\n### Operating system/version\n\nomarchy\n\n### Terminal name/version\n\nxterm\n\n### $TERM environment variable\n\ndefault\n\n### Installation\n\naur",
    "closed_at": "2025-10-23T00:32:44Z",
    "closed_by": {
        "avatar_url": "https://avatars.githubusercontent.com/u/56490555?v=4",
        "events_url": "https://api.github.com/users/ddVital/events{/privacy}",
        "followers_url": "https://api.github.com/users/ddVital/followers",
        "following_url": "https://api.github.com/users/ddVital/following{/other_user}",
        "gists_url": "https://api.github.com/users/ddVital/gists{/gist_id}",
        "gravatar_id": "",
        "html_url": "https://github.com/ddVital",
        "id": 56490555,
        "login": "ddVital",
        "node_id": "MDQ6VXNlcjU2NDkwNTU1",
        "organizations_url": "https://api.github.com/users/ddVital/orgs",
        "received_events_url": "https://api.github.com/users/ddVital/received_events",
        "repos_url": "https://api.github.com/users/ddVital/repos",
        "site_admin": false,
        "starred_url": "https://api.github.com/users/ddVital/starred{/owner}{/repo}",
        "subscriptions_url": "https://api.github.com/users/ddVital/subscriptions",
        "type": "User",
        "url": "https://api.github.com/users/ddVital",
        "user_view_type": "public"
    },
    "comment_data": [
        {
            "author_association": "MEMBER",
            "body": "First step is to update to latest Nvim (0.11.4)",
            "created_at": "2025-10-23T11:20:46Z",
            "html_url": "https://github.com/neovim/neovim/issues/36279#issuecomment-3436418450",
            "id": 3436418450,
            "issue_url": "https://api.github.com/repos/neovim/neovim/issues/36279",
            "node_id": "IC_kwDOAPphoM7M05WS",
            "performed_via_github_app": null,
            "reactions": {
                "+1": 0,
                "-1": 0,
                "confused": 0,
                "eyes": 0,
                "heart": 0,
                "hooray": 0,
                "laugh": 0,
                "rocket": 0,
                "total_count": 0,
                "url": "https://api.github.com/repos/neovim/neovim/issues/comments/3436418450/reactions"
            },
            "updated_at": "2025-10-23T11:20:46Z",
            "url": "https://api.github.com/repos/neovim/neovim/issues/comments/3436418450",
            "user": {
                "avatar_url": "https://avatars.githubusercontent.com/u/1359421?v=4",
                "events_url": "https://api.github.com/users/justinmk/events{/privacy}",
                "followers_url": "https://api.github.com/users/justinmk/followers",
                "following_url": "https://api.github.com/users/justinmk/following{/other_user}",
                "gists_url": "https://api.github.com/users/justinmk/gists{/gist_id}",
                "gravatar_id": "",
                "html_url": "https://github.com/justinmk",
                "id": 1359421,
                "login": "justinmk",
                "node_id": "MDQ6VXNlcjEzNTk0MjE=",
                "organizations_url": "https://api.github.com/users/justinmk/orgs",
                "received_events_url": "https://api.github.com/users/justinmk/received_events",
                "repos_url": "https://api.github.com/users/justinmk/repos",
                "site_admin": false,
                "starred_url": "https://api.github.com/users/justinmk/starred{/owner}{/repo}",
                "subscriptions_url": "https://api.github.com/users/justinmk/subscriptions",
                "type": "User",
                "url": "https://api.github.com/users/justinmk",
                "user_view_type": "public"
            }
        }
    ],
    "comments": 1,
    "comments_url": "https://api.github.com/repos/neovim/neovim/issues/36279/comments",
    "created_at": "2025-10-23T00:31:44Z",
    "events_url": "https://api.github.com/repos/neovim/neovim/issues/36279/events",
    "html_url": "https://github.com/neovim/neovim/issues/36279",
    "id": 3542747483,
    "issue_dependencies_summary": {
        "blocked_by": 0,
        "blocking": 0,
        "total_blocked_by": 0,
        "total_blocking": 0
    },
    "labels": [],
    "labels_url": "https://api.github.com/repos/neovim/neovim/issues/36279/labels{/name}",
    "locked": false,
    "milestone": null,
    "node_id": "I_kwDOAPphoM7TKglb",
    "number": 36279,
    "performed_via_github_app": null,
    "reactions": {
        "+1": 0,
        "-1": 0,
        "confused": 0,
        "eyes": 0,
        "heart": 0,
        "hooray": 0,
        "laugh": 0,
        "rocket": 0,
        "total_count": 0,
        "url": "https://api.github.com/repos/neovim/neovim/issues/36279/reactions"
    },
    "repository_url": "https://api.github.com/repos/neovim/neovim",
    "state": "closed",
    "state_reason": "completed",
    "sub_issues_summary": {
        "completed": 0,
        "percent_completed": 0,
        "total": 0
    },
    "timeline_url": "https://api.github.com/repos/neovim/neovim/issues/36279/timeline",
    "title": "`vim.defer_fn` callbacks may execute after buffer unload, leading to invalid memory access in Lua state",
    "type": {
        "color": "red",
        "created_at": "2024-01-25T10:10:19Z",
        "description": "An unexpected problem or behavior",
        "id": 597163,
        "is_enabled": true,
        "name": "Bug",
        "node_id": "IT_kwDOAGK_Pc4ACRyr",
        "updated_at": "2024-07-26T10:12:30Z"
    },
    "updated_at": "2025-10-23T11:20:46Z",
    "url": "https://api.github.com/repos/neovim/neovim/issues/36279",
    "user": {
        "avatar_url": "https://avatars.githubusercontent.com/u/56490555?v=4",
        "events_url": "https://api.github.com/users/ddVital/events{/privacy}",
        "followers_url": "https://api.github.com/users/ddVital/followers",
        "following_url": "https://api.github.com/users/ddVital/following{/other_user}",
        "gists_url": "https://api.github.com/users/ddVital/gists{/gist_id}",
        "gravatar_id": "",
        "html_url": "https://github.com/ddVital",
        "id": 56490555,
        "login": "ddVital",
        "node_id": "MDQ6VXNlcjU2NDkwNTU1",
        "organizations_url": "https://api.github.com/users/ddVital/orgs",
        "received_events_url": "https://api.github.com/users/ddVital/received_events",
        "repos_url": "https://api.github.com/users/ddVital/repos",
        "site_admin": false,
        "starred_url": "https://api.github.com/users/ddVital/starred{/owner}{/repo}",
        "subscriptions_url": "https://api.github.com/users/ddVital/subscriptions",
        "type": "User",
        "url": "https://api.github.com/users/ddVital",
        "user_view_type": "public"
    }
}