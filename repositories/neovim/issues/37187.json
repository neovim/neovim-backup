{
    "active_lock_reason": null,
    "assignee": null,
    "assignees": [],
    "author_association": "MEMBER",
    "body": "### Problem\n\n`nvim -l` has some baggage that reduces its usefulness as a Lua script runner. \n\nExample: https://github.com/neovim/neovim/pull/37162#issuecomment-3700163952\n\n> For example, `nvim -ll <(echo 'print(\"test\")')` writes to stdout as expected, but `nvim -l <(echo 'print(\"test\")')` writes to stderr. I can work around the discrepancy via `nvim -l <(echo 'io.write(\"test\\\\n\")')` for any scripts I write, but the override makes third-party code I reference that uses `print` harder to work with and in some cases, incompatible.\n\n\n\n### Expected behavior\n\n`print` should write to stdout, not stderr, when running as a `nvim -l` script.",
    "closed_at": null,
    "closed_by": null,
    "comment_data": [
        {
            "author_association": "NONE",
            "body": "I added a small check in `nlua_print` so, when Neovim is started with `-l`, `print()` writes directly to stdout and skips the editor message path. \n\nexecutor.c : \n```c\n  if (nlua_script_mode) {\n    fwrite(msg_ga.ga_data, 1, msg_ga.ga_len - 1, stdout);\n    fputc('\\n', stdout);\n    fflush(stdout);\n    ga_clear(&msg_ga);\n    return 0;\n  }\n```\ntest:\n```bash\nâžœ neovim git:(master) ./build/bin/nvim -l <(echo 'print(\"test\")') >/dev/null\nâžœ neovim git:(master) ./build/bin/nvim -l <(echo 'print(\"test\")') 2>/dev/null\ntest\n```\nDoes this solution suit you?",
            "created_at": "2026-01-04T21:06:15Z",
            "html_url": "https://github.com/neovim/neovim/issues/37187#issuecomment-3708425907",
            "id": 3708425907,
            "issue_url": "https://api.github.com/repos/neovim/neovim/issues/37187",
            "node_id": "IC_kwDOAPphoM7dChaz",
            "performed_via_github_app": null,
            "reactions": {
                "+1": 0,
                "-1": 0,
                "confused": 0,
                "eyes": 0,
                "heart": 0,
                "hooray": 0,
                "laugh": 0,
                "rocket": 0,
                "total_count": 0,
                "url": "https://api.github.com/repos/neovim/neovim/issues/comments/3708425907/reactions"
            },
            "updated_at": "2026-01-04T21:06:15Z",
            "url": "https://api.github.com/repos/neovim/neovim/issues/comments/3708425907",
            "user": {
                "avatar_url": "https://avatars.githubusercontent.com/u/67893205?v=4",
                "events_url": "https://api.github.com/users/kumarvivek1752/events{/privacy}",
                "followers_url": "https://api.github.com/users/kumarvivek1752/followers",
                "following_url": "https://api.github.com/users/kumarvivek1752/following{/other_user}",
                "gists_url": "https://api.github.com/users/kumarvivek1752/gists{/gist_id}",
                "gravatar_id": "",
                "html_url": "https://github.com/kumarvivek1752",
                "id": 67893205,
                "login": "kumarvivek1752",
                "node_id": "MDQ6VXNlcjY3ODkzMjA1",
                "organizations_url": "https://api.github.com/users/kumarvivek1752/orgs",
                "received_events_url": "https://api.github.com/users/kumarvivek1752/received_events",
                "repos_url": "https://api.github.com/users/kumarvivek1752/repos",
                "site_admin": false,
                "starred_url": "https://api.github.com/users/kumarvivek1752/starred{/owner}{/repo}",
                "subscriptions_url": "https://api.github.com/users/kumarvivek1752/subscriptions",
                "type": "User",
                "url": "https://api.github.com/users/kumarvivek1752",
                "user_view_type": "public"
            }
        },
        {
            "author_association": "MEMBER",
            "body": "That seems like a good start. And then to test it, maybe update `assert_l_out` here so that it checks that stdout, not stderr, is used. https://github.com/neovim/neovim/blob/55a0843b7cf73d90024733d243e93876476f1746/test/functional/core/startup_spec.lua#L130-L131",
            "created_at": "2026-01-08T02:58:27Z",
            "html_url": "https://github.com/neovim/neovim/issues/37187#issuecomment-3721674591",
            "id": 3721674591,
            "issue_url": "https://api.github.com/repos/neovim/neovim/issues/37187",
            "node_id": "IC_kwDOAPphoM7d1D9f",
            "performed_via_github_app": null,
            "reactions": {
                "+1": 0,
                "-1": 0,
                "confused": 0,
                "eyes": 0,
                "heart": 0,
                "hooray": 0,
                "laugh": 0,
                "rocket": 0,
                "total_count": 0,
                "url": "https://api.github.com/repos/neovim/neovim/issues/comments/3721674591/reactions"
            },
            "updated_at": "2026-01-08T02:58:27Z",
            "url": "https://api.github.com/repos/neovim/neovim/issues/comments/3721674591",
            "user": {
                "avatar_url": "https://avatars.githubusercontent.com/u/1359421?v=4",
                "events_url": "https://api.github.com/users/justinmk/events{/privacy}",
                "followers_url": "https://api.github.com/users/justinmk/followers",
                "following_url": "https://api.github.com/users/justinmk/following{/other_user}",
                "gists_url": "https://api.github.com/users/justinmk/gists{/gist_id}",
                "gravatar_id": "",
                "html_url": "https://github.com/justinmk",
                "id": 1359421,
                "login": "justinmk",
                "node_id": "MDQ6VXNlcjEzNTk0MjE=",
                "organizations_url": "https://api.github.com/users/justinmk/orgs",
                "received_events_url": "https://api.github.com/users/justinmk/received_events",
                "repos_url": "https://api.github.com/users/justinmk/repos",
                "site_admin": false,
                "starred_url": "https://api.github.com/users/justinmk/starred{/owner}{/repo}",
                "subscriptions_url": "https://api.github.com/users/justinmk/subscriptions",
                "type": "User",
                "url": "https://api.github.com/users/justinmk",
                "user_view_type": "public"
            }
        },
        {
            "author_association": "NONE",
            "body": "`fn.system()` by default captures `stdout` only\nhttps://github.com/neovim/neovim/blob/55a0843b7cf73d90024733d243e93876476f1746/test/functional/core/startup_spec.lua#L136\n\n2 tests are failing because of `\\n`:\n\n```\nRUN      T70 user session loads session from the provided lua file: 7.00 ms OK\nRUN      T71 inccommand on ex mode should not preview: 42.00 ms OK\n-------- 71 tests from test/functional/core/startup_spec.lua (3199.00 ms total)\n\n-------- Global test environment teardown.\n======== 71 tests from 1 test file ran. (3199.00 ms total)\nPASSED   69 tests.\nFAILED   2 tests, listed below:\nFAILED   test/functional/core/startup_spec.lua @ 151: startup -l Lua os.exit() sets Nvim exitcode\ntest/functional/core/startup_spec.lua:161: Expected objects to be the same.\nPassed in:\n(string) 'bufs:\nnvim args: 7\nlua args: { \"-arg1\", \"--exitcode\", \"73\", \"--arg2\",\n  [0] = \"test/functional/fixtures/startup.lua\"\n}\n'\nExpected:\n(string) 'bufs:\nnvim args: 7\nlua args: { \"-arg1\", \"--exitcode\", \"73\", \"--arg2\",\n  [0] = \"test/functional/fixtures/startup.lua\"\n}'\n\nstack traceback:\n\ttest/functional/core/startup_spec.lua:161: in function <test/functional/core/startup_spec.lua:151>\n\nFAILED   test/functional/core/startup_spec.lua @ 210: startup -l Lua does not add newline when unnecessary\ntest/functional/core/startup_spec.lua:212: Expected objects to be the same.\nPassed in:\n(string) 'foobar\n\n'\nExpected:\n(string) 'foobar\n'\n\nstack traceback:\n\ttest/functional/core/startup_spec.lua:212: in function <test/functional/core/startup_spec.lua:210>\n\n\n 2 FAILED TESTS\n------------------------------------------------------------------------------\n\n```\n\nif i conditonally print `\\n` still 1 test failing.\n\n- `startup -l Lua os.exit() sets Nvim exitcode`\n\n```c\n  if (nlua_script_mode) {\n    size_t len = (size_t)msg_ga.ga_len - 1;\n    char *data = (char *)msg_ga.ga_data;\n    fwrite(data, 1, len, stdout);\n    if (len == 0 || data[len - 1] != '\\n') {\n      fputc('\\n', stdout);\n    }\n    fflush(stdout);\n    ga_clear(&msg_ga);\n    return 0;\n  }\n```\n\nany other options??\n",
            "created_at": "2026-01-10T05:32:49Z",
            "html_url": "https://github.com/neovim/neovim/issues/37187#issuecomment-3731856602",
            "id": 3731856602,
            "issue_url": "https://api.github.com/repos/neovim/neovim/issues/37187",
            "node_id": "IC_kwDOAPphoM7eb5za",
            "performed_via_github_app": null,
            "reactions": {
                "+1": 0,
                "-1": 0,
                "confused": 0,
                "eyes": 0,
                "heart": 0,
                "hooray": 0,
                "laugh": 0,
                "rocket": 0,
                "total_count": 0,
                "url": "https://api.github.com/repos/neovim/neovim/issues/comments/3731856602/reactions"
            },
            "updated_at": "2026-01-10T05:34:30Z",
            "url": "https://api.github.com/repos/neovim/neovim/issues/comments/3731856602",
            "user": {
                "avatar_url": "https://avatars.githubusercontent.com/u/67893205?v=4",
                "events_url": "https://api.github.com/users/kumarvivek1752/events{/privacy}",
                "followers_url": "https://api.github.com/users/kumarvivek1752/followers",
                "following_url": "https://api.github.com/users/kumarvivek1752/following{/other_user}",
                "gists_url": "https://api.github.com/users/kumarvivek1752/gists{/gist_id}",
                "gravatar_id": "",
                "html_url": "https://github.com/kumarvivek1752",
                "id": 67893205,
                "login": "kumarvivek1752",
                "node_id": "MDQ6VXNlcjY3ODkzMjA1",
                "organizations_url": "https://api.github.com/users/kumarvivek1752/orgs",
                "received_events_url": "https://api.github.com/users/kumarvivek1752/received_events",
                "repos_url": "https://api.github.com/users/kumarvivek1752/repos",
                "site_admin": false,
                "starred_url": "https://api.github.com/users/kumarvivek1752/starred{/owner}{/repo}",
                "subscriptions_url": "https://api.github.com/users/kumarvivek1752/subscriptions",
                "type": "User",
                "url": "https://api.github.com/users/kumarvivek1752",
                "user_view_type": "public"
            }
        },
        {
            "author_association": "MEMBER",
            "body": "A simple idea: detect -l here and, in that case, do not override print, letting the standard print be used. The standard print uses `\\t` as a separator and adds a newline at the end, which causes 3 tests to fail.  We could probably just adjust the tests slightly to account for this ðŸ¤” \n\nsee `luaB_print` in https://www.lua.org/source/5.1/lbaselib.c.html\n\n```diff\ndiff --git a/src/nvim/lua/executor.c b/src/nvim/lua/executor.c\nindex 181a549e23..6b5402ec4a 100644\n--- a/src/nvim/lua/executor.c\n+++ b/src/nvim/lua/executor.c\n@@ -773,9 +773,11 @@ static int nlua_ui_detach(lua_State *lstate)\n /// Called by lua interpreter itself to initialize state.\n static bool nlua_state_init(lua_State *const lstate) FUNC_ATTR_NONNULL_ALL\n {\n-  // print\n-  lua_pushcfunction(lstate, &nlua_print);\n-  lua_setglobal(lstate, \"print\");\n+  if (!in_script) {\n+    // print\n+    lua_pushcfunction(lstate, &nlua_print);\n+    lua_setglobal(lstate, \"print\");\n+  }\n\n   // debug.debug\n   lua_getglobal(lstate, \"debug\");\n@@ -861,6 +863,9 @@ static bool nlua_state_init(lua_State *const lstate) FUNC_ATTR_NONNULL_ALL\n /// Initializes global Lua interpreter, or exits Nvim on failure.\n void nlua_init(char **argv, int argc, int lua_arg0)\n {\n+  if (lua_arg0 > 0) {\n+    in_script = true;\n+  }\n #ifdef NLUA_TRACK_REFS\n   if (os_env_exists(\"NVIM_LUA_NOTRACK\", true)) {\n     nlua_track_refs = true;\n```",
            "created_at": "2026-01-10T09:01:25Z",
            "html_url": "https://github.com/neovim/neovim/issues/37187#issuecomment-3732197488",
            "id": 3732197488,
            "issue_url": "https://api.github.com/repos/neovim/neovim/issues/37187",
            "node_id": "IC_kwDOAPphoM7edNBw",
            "performed_via_github_app": null,
            "reactions": {
                "+1": 2,
                "-1": 0,
                "confused": 0,
                "eyes": 0,
                "heart": 0,
                "hooray": 0,
                "laugh": 0,
                "rocket": 0,
                "total_count": 2,
                "url": "https://api.github.com/repos/neovim/neovim/issues/comments/3732197488/reactions"
            },
            "updated_at": "2026-01-10T09:01:25Z",
            "url": "https://api.github.com/repos/neovim/neovim/issues/comments/3732197488",
            "user": {
                "avatar_url": "https://avatars.githubusercontent.com/u/41671631?v=4",
                "events_url": "https://api.github.com/users/glepnir/events{/privacy}",
                "followers_url": "https://api.github.com/users/glepnir/followers",
                "following_url": "https://api.github.com/users/glepnir/following{/other_user}",
                "gists_url": "https://api.github.com/users/glepnir/gists{/gist_id}",
                "gravatar_id": "",
                "html_url": "https://github.com/glepnir",
                "id": 41671631,
                "login": "glepnir",
                "node_id": "MDQ6VXNlcjQxNjcxNjMx",
                "organizations_url": "https://api.github.com/users/glepnir/orgs",
                "received_events_url": "https://api.github.com/users/glepnir/received_events",
                "repos_url": "https://api.github.com/users/glepnir/repos",
                "site_admin": false,
                "starred_url": "https://api.github.com/users/glepnir/starred{/owner}{/repo}",
                "subscriptions_url": "https://api.github.com/users/glepnir/subscriptions",
                "type": "User",
                "url": "https://api.github.com/users/glepnir",
                "user_view_type": "public"
            }
        },
        {
            "author_association": "NONE",
            "body": "@glepnir thanks for suggestions",
            "created_at": "2026-01-11T08:50:42Z",
            "html_url": "https://github.com/neovim/neovim/issues/37187#issuecomment-3734259717",
            "id": 3734259717,
            "issue_url": "https://api.github.com/repos/neovim/neovim/issues/37187",
            "node_id": "IC_kwDOAPphoM7elEgF",
            "performed_via_github_app": null,
            "reactions": {
                "+1": 0,
                "-1": 0,
                "confused": 0,
                "eyes": 0,
                "heart": 0,
                "hooray": 0,
                "laugh": 0,
                "rocket": 0,
                "total_count": 0,
                "url": "https://api.github.com/repos/neovim/neovim/issues/comments/3734259717/reactions"
            },
            "updated_at": "2026-01-11T08:50:42Z",
            "url": "https://api.github.com/repos/neovim/neovim/issues/comments/3734259717",
            "user": {
                "avatar_url": "https://avatars.githubusercontent.com/u/67893205?v=4",
                "events_url": "https://api.github.com/users/kumarvivek1752/events{/privacy}",
                "followers_url": "https://api.github.com/users/kumarvivek1752/followers",
                "following_url": "https://api.github.com/users/kumarvivek1752/following{/other_user}",
                "gists_url": "https://api.github.com/users/kumarvivek1752/gists{/gist_id}",
                "gravatar_id": "",
                "html_url": "https://github.com/kumarvivek1752",
                "id": 67893205,
                "login": "kumarvivek1752",
                "node_id": "MDQ6VXNlcjY3ODkzMjA1",
                "organizations_url": "https://api.github.com/users/kumarvivek1752/orgs",
                "received_events_url": "https://api.github.com/users/kumarvivek1752/received_events",
                "repos_url": "https://api.github.com/users/kumarvivek1752/repos",
                "site_admin": false,
                "starred_url": "https://api.github.com/users/kumarvivek1752/starred{/owner}{/repo}",
                "subscriptions_url": "https://api.github.com/users/kumarvivek1752/subscriptions",
                "type": "User",
                "url": "https://api.github.com/users/kumarvivek1752",
                "user_view_type": "public"
            }
        }
    ],
    "comments": 5,
    "comments_url": "https://api.github.com/repos/neovim/neovim/issues/37187/comments",
    "created_at": "2025-12-31T23:03:42Z",
    "events_url": "https://api.github.com/repos/neovim/neovim/issues/37187/events",
    "html_url": "https://github.com/neovim/neovim/issues/37187",
    "id": 3773869149,
    "issue_dependencies_summary": {
        "blocked_by": 0,
        "blocking": 0,
        "total_blocked_by": 0,
        "total_blocking": 0
    },
    "labels": [
        {
            "color": "c5def5",
            "default": false,
            "description": "stdlib",
            "id": 573222693,
            "name": "lua",
            "node_id": "MDU6TGFiZWw1NzMyMjI2OTM=",
            "url": "https://api.github.com/repos/neovim/neovim/labels/lua"
        }
    ],
    "labels_url": "https://api.github.com/repos/neovim/neovim/issues/37187/labels{/name}",
    "locked": false,
    "milestone": {
        "closed_at": null,
        "closed_issues": 766,
        "created_at": "2014-05-10T20:43:04Z",
        "creator": {
            "avatar_url": "https://avatars.githubusercontent.com/u/1359421?v=4",
            "events_url": "https://api.github.com/users/justinmk/events{/privacy}",
            "followers_url": "https://api.github.com/users/justinmk/followers",
            "following_url": "https://api.github.com/users/justinmk/following{/other_user}",
            "gists_url": "https://api.github.com/users/justinmk/gists{/gist_id}",
            "gravatar_id": "",
            "html_url": "https://github.com/justinmk",
            "id": 1359421,
            "login": "justinmk",
            "node_id": "MDQ6VXNlcjEzNTk0MjE=",
            "organizations_url": "https://api.github.com/users/justinmk/orgs",
            "received_events_url": "https://api.github.com/users/justinmk/received_events",
            "repos_url": "https://api.github.com/users/justinmk/repos",
            "site_admin": false,
            "starred_url": "https://api.github.com/users/justinmk/starred{/owner}{/repo}",
            "subscriptions_url": "https://api.github.com/users/justinmk/subscriptions",
            "type": "User",
            "url": "https://api.github.com/users/justinmk",
            "user_view_type": "public"
        },
        "description": "Low priority items. We plan to work on this but don't have a target date.",
        "due_on": null,
        "html_url": "https://github.com/neovim/neovim/milestone/6",
        "id": 655037,
        "labels_url": "https://api.github.com/repos/neovim/neovim/milestones/6/labels",
        "node_id": "MDk6TWlsZXN0b25lNjU1MDM3",
        "number": 6,
        "open_issues": 643,
        "state": "open",
        "title": "backlog",
        "updated_at": "2026-01-11T15:01:35Z",
        "url": "https://api.github.com/repos/neovim/neovim/milestones/6"
    },
    "node_id": "I_kwDOAPphoM7g8Kxd",
    "number": 37187,
    "performed_via_github_app": null,
    "reactions": {
        "+1": 2,
        "-1": 0,
        "confused": 0,
        "eyes": 0,
        "heart": 0,
        "hooray": 0,
        "laugh": 0,
        "rocket": 0,
        "total_count": 2,
        "url": "https://api.github.com/repos/neovim/neovim/issues/37187/reactions"
    },
    "repository_url": "https://api.github.com/repos/neovim/neovim",
    "state": "open",
    "state_reason": null,
    "sub_issues_summary": {
        "completed": 0,
        "percent_completed": 0,
        "total": 0
    },
    "timeline_url": "https://api.github.com/repos/neovim/neovim/issues/37187/timeline",
    "title": "`nvim -l` writes to stdout not stderr",
    "type": {
        "color": "blue",
        "created_at": "2024-01-25T10:10:19Z",
        "description": "A request, idea, or new functionality",
        "id": 597167,
        "is_enabled": true,
        "name": "Enhancement",
        "node_id": "IT_kwDOAGK_Pc4ACRyv",
        "updated_at": "2024-07-26T10:12:30Z"
    },
    "updated_at": "2026-01-11T08:50:42Z",
    "url": "https://api.github.com/repos/neovim/neovim/issues/37187",
    "user": {
        "avatar_url": "https://avatars.githubusercontent.com/u/1359421?v=4",
        "events_url": "https://api.github.com/users/justinmk/events{/privacy}",
        "followers_url": "https://api.github.com/users/justinmk/followers",
        "following_url": "https://api.github.com/users/justinmk/following{/other_user}",
        "gists_url": "https://api.github.com/users/justinmk/gists{/gist_id}",
        "gravatar_id": "",
        "html_url": "https://github.com/justinmk",
        "id": 1359421,
        "login": "justinmk",
        "node_id": "MDQ6VXNlcjEzNTk0MjE=",
        "organizations_url": "https://api.github.com/users/justinmk/orgs",
        "received_events_url": "https://api.github.com/users/justinmk/received_events",
        "repos_url": "https://api.github.com/users/justinmk/repos",
        "site_admin": false,
        "starred_url": "https://api.github.com/users/justinmk/starred{/owner}{/repo}",
        "subscriptions_url": "https://api.github.com/users/justinmk/subscriptions",
        "type": "User",
        "url": "https://api.github.com/users/justinmk",
        "user_view_type": "public"
    }
}