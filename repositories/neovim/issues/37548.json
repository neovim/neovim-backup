{
    "active_lock_reason": null,
    "assignee": null,
    "assignees": [],
    "author_association": "CONTRIBUTOR",
    "body": "### Problem\n\nWhen using the example from `:h diagnostic-on-jump-example` to show virtual lines when jumping to diagnostics, the diagnostic and virtual lines persist even after the diagnostic has been fixed or removed.\n\n![Image](https://github.com/user-attachments/assets/9eae7d41-320d-40a7-b98a-78e99c2e145c)\n\nAs shown in the gif above, the virtual lines persist on the line where the diagnostic was even though trying to jump to it shows 'No more valid diagnostics to move to'.\n\n### Related\n\nThis issue was discovered while working on PR #37516.\n\n### Steps to reproduce\n\n`nvim --clean -u minimal.lua` with the following minimal config using any language server (tested with lua_ls, basedpyright and rust-analyzer):\n\n```lua\nvim.lsp.config.basedpyright = {\n  cmd = { \"basedpyright-langserver\", \"--stdio\" },\n  filetypes = { \"python\" },\n}\n\nvim.lsp.enable({ \"basedpyright\" })\n\nlocal virt_lines_ns = vim.api.nvim_create_namespace \"on_diagnostic_jump\"\n\n--- @param diagnostic? vim.Diagnostic\n--- @param bufnr integer\nlocal function on_jump(diagnostic, bufnr)\n  if not diagnostic then return end\n\n  vim.diagnostic.show(\n    virt_lines_ns,\n    bufnr,\n    { diagnostic },\n    { virtual_lines = { current_line = true }, virtual_text = false }\n  )\nend\n\nvim.diagnostic.config({ jump = { on_jump = on_jump } })\n```\nCreate an error and jump to it with `[d` or `]d`. Then fix/remove the error and move to the line where the diagnostic was.\n\n### Expected behavior\n\nThe virtual lines should clear once the diagnostic has been fixed/removed.\n\n### Nvim version (nvim -v)\n\nv0.12.0-dev-2032+gdddc359213\n\n### Vim (not Nvim) behaves the same?\n\nNo, Vim 9.1\n\n### Operating system/version\n\nFedora Linux 43\n\n### Terminal name/version\n\nGhostty 1.3.0-dev+0000000\n\n### $TERM environment variable\n\nxterm-ghostty\n\n### Installation\n\nBuild from repo",
    "closed_at": null,
    "closed_by": null,
    "comment_data": [
        {
            "author_association": "MEMBER",
            "body": "From the video it seems like the signs diagnostic handler has the same problem of showing stale diagnostic state.",
            "created_at": "2026-01-25T21:36:11Z",
            "html_url": "https://github.com/neovim/neovim/issues/37548#issuecomment-3797272269",
            "id": 3797272269,
            "issue_url": "https://api.github.com/repos/neovim/neovim/issues/37548",
            "node_id": "IC_kwDOAPphoM7iVcbN",
            "performed_via_github_app": null,
            "pin": null,
            "reactions": {
                "+1": 0,
                "-1": 0,
                "confused": 0,
                "eyes": 0,
                "heart": 0,
                "hooray": 0,
                "laugh": 0,
                "rocket": 0,
                "total_count": 0,
                "url": "https://api.github.com/repos/neovim/neovim/issues/comments/3797272269/reactions"
            },
            "updated_at": "2026-01-25T21:36:11Z",
            "url": "https://api.github.com/repos/neovim/neovim/issues/comments/3797272269",
            "user": {
                "avatar_url": "https://avatars.githubusercontent.com/u/62502207?v=4",
                "events_url": "https://api.github.com/users/MariaSolOs/events{/privacy}",
                "followers_url": "https://api.github.com/users/MariaSolOs/followers",
                "following_url": "https://api.github.com/users/MariaSolOs/following{/other_user}",
                "gists_url": "https://api.github.com/users/MariaSolOs/gists{/gist_id}",
                "gravatar_id": "",
                "html_url": "https://github.com/MariaSolOs",
                "id": 62502207,
                "login": "MariaSolOs",
                "node_id": "MDQ6VXNlcjYyNTAyMjA3",
                "organizations_url": "https://api.github.com/users/MariaSolOs/orgs",
                "received_events_url": "https://api.github.com/users/MariaSolOs/received_events",
                "repos_url": "https://api.github.com/users/MariaSolOs/repos",
                "site_admin": false,
                "starred_url": "https://api.github.com/users/MariaSolOs/starred{/owner}{/repo}",
                "subscriptions_url": "https://api.github.com/users/MariaSolOs/subscriptions",
                "type": "User",
                "url": "https://api.github.com/users/MariaSolOs",
                "user_view_type": "public"
            }
        },
        {
            "author_association": "CONTRIBUTOR",
            "body": "Yeah I forgot to mention that. Just checked writing a similar `on_jump` function to show virtual text has the same issue.",
            "created_at": "2026-01-25T21:45:59Z",
            "html_url": "https://github.com/neovim/neovim/issues/37548#issuecomment-3797284694",
            "id": 3797284694,
            "issue_url": "https://api.github.com/repos/neovim/neovim/issues/37548",
            "node_id": "IC_kwDOAPphoM7iVfdW",
            "performed_via_github_app": null,
            "pin": null,
            "reactions": {
                "+1": 0,
                "-1": 0,
                "confused": 0,
                "eyes": 0,
                "heart": 0,
                "hooray": 0,
                "laugh": 0,
                "rocket": 0,
                "total_count": 0,
                "url": "https://api.github.com/repos/neovim/neovim/issues/comments/3797284694/reactions"
            },
            "updated_at": "2026-01-25T21:45:59Z",
            "url": "https://api.github.com/repos/neovim/neovim/issues/comments/3797284694",
            "user": {
                "avatar_url": "https://avatars.githubusercontent.com/u/49293546?v=4",
                "events_url": "https://api.github.com/users/aymenhafeez/events{/privacy}",
                "followers_url": "https://api.github.com/users/aymenhafeez/followers",
                "following_url": "https://api.github.com/users/aymenhafeez/following{/other_user}",
                "gists_url": "https://api.github.com/users/aymenhafeez/gists{/gist_id}",
                "gravatar_id": "",
                "html_url": "https://github.com/aymenhafeez",
                "id": 49293546,
                "login": "aymenhafeez",
                "node_id": "MDQ6VXNlcjQ5MjkzNTQ2",
                "organizations_url": "https://api.github.com/users/aymenhafeez/orgs",
                "received_events_url": "https://api.github.com/users/aymenhafeez/received_events",
                "repos_url": "https://api.github.com/users/aymenhafeez/repos",
                "site_admin": false,
                "starred_url": "https://api.github.com/users/aymenhafeez/starred{/owner}{/repo}",
                "subscriptions_url": "https://api.github.com/users/aymenhafeez/subscriptions",
                "type": "User",
                "url": "https://api.github.com/users/aymenhafeez",
                "user_view_type": "public"
            }
        },
        {
            "author_association": "MEMBER",
            "body": "Just a guess, maybe @faergeek has an idea about this?",
            "created_at": "2026-01-26T13:23:10Z",
            "html_url": "https://github.com/neovim/neovim/issues/37548#issuecomment-3799586773",
            "id": 3799586773,
            "issue_url": "https://api.github.com/repos/neovim/neovim/issues/37548",
            "node_id": "IC_kwDOAPphoM7ieRfV",
            "performed_via_github_app": null,
            "pin": null,
            "reactions": {
                "+1": 0,
                "-1": 0,
                "confused": 0,
                "eyes": 0,
                "heart": 0,
                "hooray": 0,
                "laugh": 0,
                "rocket": 0,
                "total_count": 0,
                "url": "https://api.github.com/repos/neovim/neovim/issues/comments/3799586773/reactions"
            },
            "updated_at": "2026-01-26T13:23:10Z",
            "url": "https://api.github.com/repos/neovim/neovim/issues/comments/3799586773",
            "user": {
                "avatar_url": "https://avatars.githubusercontent.com/u/1359421?v=4",
                "events_url": "https://api.github.com/users/justinmk/events{/privacy}",
                "followers_url": "https://api.github.com/users/justinmk/followers",
                "following_url": "https://api.github.com/users/justinmk/following{/other_user}",
                "gists_url": "https://api.github.com/users/justinmk/gists{/gist_id}",
                "gravatar_id": "",
                "html_url": "https://github.com/justinmk",
                "id": 1359421,
                "login": "justinmk",
                "node_id": "MDQ6VXNlcjEzNTk0MjE=",
                "organizations_url": "https://api.github.com/users/justinmk/orgs",
                "received_events_url": "https://api.github.com/users/justinmk/received_events",
                "repos_url": "https://api.github.com/users/justinmk/repos",
                "site_admin": false,
                "starred_url": "https://api.github.com/users/justinmk/starred{/owner}{/repo}",
                "subscriptions_url": "https://api.github.com/users/justinmk/subscriptions",
                "type": "User",
                "url": "https://api.github.com/users/justinmk",
                "user_view_type": "public"
            }
        },
        {
            "author_association": "CONTRIBUTOR",
            "body": "@justinmk I've bisected between 0.11 and master only to understand that it behaves like that right from the introduction of `on_jump` option c65817774d66ed187a72e449151f6beea1053692, which is before the changes I made about jumping between diagnostics.\n\nBut the reason seems to be basically this line, which allows to just show diagnostics which are not part of diagnostics kept in the cache for a buffer, which are used for jumping between them:\nhttps://github.com/neovim/neovim/blob/543e14d04085c5e8f613220bb39632c822ee8996/runtime/lua/vim/diagnostic.lua#L2351\n\nAnd seems that the fix would be to either `set` absent diagnostics when `show` is called to make jumping work or add validation/filtering to make sure that the diagnostics that are to be shown are present in the cache already.",
            "created_at": "2026-01-26T14:35:40Z",
            "html_url": "https://github.com/neovim/neovim/issues/37548#issuecomment-3799920559",
            "id": 3799920559,
            "issue_url": "https://api.github.com/repos/neovim/neovim/issues/37548",
            "node_id": "IC_kwDOAPphoM7ifi-v",
            "performed_via_github_app": null,
            "pin": null,
            "reactions": {
                "+1": 0,
                "-1": 0,
                "confused": 0,
                "eyes": 0,
                "heart": 1,
                "hooray": 0,
                "laugh": 0,
                "rocket": 0,
                "total_count": 1,
                "url": "https://api.github.com/repos/neovim/neovim/issues/comments/3799920559/reactions"
            },
            "updated_at": "2026-01-26T14:35:40Z",
            "url": "https://api.github.com/repos/neovim/neovim/issues/comments/3799920559",
            "user": {
                "avatar_url": "https://avatars.githubusercontent.com/u/3524621?v=4",
                "events_url": "https://api.github.com/users/faergeek/events{/privacy}",
                "followers_url": "https://api.github.com/users/faergeek/followers",
                "following_url": "https://api.github.com/users/faergeek/following{/other_user}",
                "gists_url": "https://api.github.com/users/faergeek/gists{/gist_id}",
                "gravatar_id": "",
                "html_url": "https://github.com/faergeek",
                "id": 3524621,
                "login": "faergeek",
                "node_id": "MDQ6VXNlcjM1MjQ2MjE=",
                "organizations_url": "https://api.github.com/users/faergeek/orgs",
                "received_events_url": "https://api.github.com/users/faergeek/received_events",
                "repos_url": "https://api.github.com/users/faergeek/repos",
                "site_admin": false,
                "starred_url": "https://api.github.com/users/faergeek/starred{/owner}{/repo}",
                "subscriptions_url": "https://api.github.com/users/faergeek/subscriptions",
                "type": "User",
                "url": "https://api.github.com/users/faergeek",
                "user_view_type": "public"
            }
        },
        {
            "author_association": "NONE",
            "body": "Hi! I would love to take a stab at this if no one else is currently working on it? ",
            "created_at": "2026-02-19T10:18:49Z",
            "html_url": "https://github.com/neovim/neovim/issues/37548#issuecomment-3926215629",
            "id": 3926215629,
            "issue_url": "https://api.github.com/repos/neovim/neovim/issues/37548",
            "node_id": "IC_kwDOAPphoM7qBUvN",
            "performed_via_github_app": null,
            "pin": null,
            "reactions": {
                "+1": 0,
                "-1": 0,
                "confused": 0,
                "eyes": 0,
                "heart": 0,
                "hooray": 0,
                "laugh": 0,
                "rocket": 0,
                "total_count": 0,
                "url": "https://api.github.com/repos/neovim/neovim/issues/comments/3926215629/reactions"
            },
            "updated_at": "2026-02-19T10:18:49Z",
            "url": "https://api.github.com/repos/neovim/neovim/issues/comments/3926215629",
            "user": {
                "avatar_url": "https://avatars.githubusercontent.com/u/19738295?v=4",
                "events_url": "https://api.github.com/users/oskarnurm/events{/privacy}",
                "followers_url": "https://api.github.com/users/oskarnurm/followers",
                "following_url": "https://api.github.com/users/oskarnurm/following{/other_user}",
                "gists_url": "https://api.github.com/users/oskarnurm/gists{/gist_id}",
                "gravatar_id": "",
                "html_url": "https://github.com/oskarnurm",
                "id": 19738295,
                "login": "oskarnurm",
                "node_id": "MDQ6VXNlcjE5NzM4Mjk1",
                "organizations_url": "https://api.github.com/users/oskarnurm/orgs",
                "received_events_url": "https://api.github.com/users/oskarnurm/received_events",
                "repos_url": "https://api.github.com/users/oskarnurm/repos",
                "site_admin": false,
                "starred_url": "https://api.github.com/users/oskarnurm/starred{/owner}{/repo}",
                "subscriptions_url": "https://api.github.com/users/oskarnurm/subscriptions",
                "type": "User",
                "url": "https://api.github.com/users/oskarnurm",
                "user_view_type": "public"
            }
        },
        {
            "author_association": "CONTRIBUTOR",
            "body": "@oskarnurm I guess nobody's working on it yet. It's not clear what the behavior should be.\n\nShould diagnostics that are not already present in the cache be ignored or should they be added to the cache? Or something else?\n\nDocs for `vim.diagnostic.show` say\n\n>can be used to display a list of diagnostics without saving them\n\nhttps://github.com/neovim/neovim/blob/6b4ec2264e1d8ba027b85f3883d532c5068be92a/runtime/doc/diagnostic.txt#L1021-L1026\n\nWhich means it kind of works as described. The only problem is that \"without saving\" also means there's no way to jump to such diagnostics. Doesn't seem like this is explicitly mentioned in the docs. Maybe this should just be documented then?",
            "created_at": "2026-02-20T16:07:21Z",
            "html_url": "https://github.com/neovim/neovim/issues/37548#issuecomment-3935779306",
            "id": 3935779306,
            "issue_url": "https://api.github.com/repos/neovim/neovim/issues/37548",
            "node_id": "IC_kwDOAPphoM7qlznq",
            "performed_via_github_app": null,
            "pin": null,
            "reactions": {
                "+1": 0,
                "-1": 0,
                "confused": 0,
                "eyes": 0,
                "heart": 0,
                "hooray": 0,
                "laugh": 0,
                "rocket": 0,
                "total_count": 0,
                "url": "https://api.github.com/repos/neovim/neovim/issues/comments/3935779306/reactions"
            },
            "updated_at": "2026-02-20T16:07:21Z",
            "url": "https://api.github.com/repos/neovim/neovim/issues/comments/3935779306",
            "user": {
                "avatar_url": "https://avatars.githubusercontent.com/u/3524621?v=4",
                "events_url": "https://api.github.com/users/faergeek/events{/privacy}",
                "followers_url": "https://api.github.com/users/faergeek/followers",
                "following_url": "https://api.github.com/users/faergeek/following{/other_user}",
                "gists_url": "https://api.github.com/users/faergeek/gists{/gist_id}",
                "gravatar_id": "",
                "html_url": "https://github.com/faergeek",
                "id": 3524621,
                "login": "faergeek",
                "node_id": "MDQ6VXNlcjM1MjQ2MjE=",
                "organizations_url": "https://api.github.com/users/faergeek/orgs",
                "received_events_url": "https://api.github.com/users/faergeek/received_events",
                "repos_url": "https://api.github.com/users/faergeek/repos",
                "site_admin": false,
                "starred_url": "https://api.github.com/users/faergeek/starred{/owner}{/repo}",
                "subscriptions_url": "https://api.github.com/users/faergeek/subscriptions",
                "type": "User",
                "url": "https://api.github.com/users/faergeek",
                "user_view_type": "public"
            }
        }
    ],
    "comments": 6,
    "comments_url": "https://api.github.com/repos/neovim/neovim/issues/37548/comments",
    "created_at": "2026-01-25T15:01:16Z",
    "events_url": "https://api.github.com/repos/neovim/neovim/issues/37548/events",
    "html_url": "https://github.com/neovim/neovim/issues/37548",
    "id": 3853379187,
    "issue_dependencies_summary": {
        "blocked_by": 0,
        "blocking": 0,
        "total_blocked_by": 0,
        "total_blocking": 0
    },
    "labels": [
        {
            "color": "0E8A16",
            "default": false,
            "description": "",
            "id": 606691254,
            "name": "has:plan",
            "node_id": "MDU6TGFiZWw2MDY2OTEyNTQ=",
            "url": "https://api.github.com/repos/neovim/neovim/labels/has:plan"
        },
        {
            "color": "C5DEF5",
            "default": false,
            "description": "",
            "id": 3361645105,
            "name": "diagnostic",
            "node_id": "MDU6TGFiZWwzMzYxNjQ1MTA1",
            "url": "https://api.github.com/repos/neovim/neovim/labels/diagnostic"
        }
    ],
    "labels_url": "https://api.github.com/repos/neovim/neovim/issues/37548/labels{/name}",
    "locked": false,
    "milestone": {
        "closed_at": null,
        "closed_issues": 780,
        "created_at": "2014-05-10T20:43:04Z",
        "creator": {
            "avatar_url": "https://avatars.githubusercontent.com/u/1359421?v=4",
            "events_url": "https://api.github.com/users/justinmk/events{/privacy}",
            "followers_url": "https://api.github.com/users/justinmk/followers",
            "following_url": "https://api.github.com/users/justinmk/following{/other_user}",
            "gists_url": "https://api.github.com/users/justinmk/gists{/gist_id}",
            "gravatar_id": "",
            "html_url": "https://github.com/justinmk",
            "id": 1359421,
            "login": "justinmk",
            "node_id": "MDQ6VXNlcjEzNTk0MjE=",
            "organizations_url": "https://api.github.com/users/justinmk/orgs",
            "received_events_url": "https://api.github.com/users/justinmk/received_events",
            "repos_url": "https://api.github.com/users/justinmk/repos",
            "site_admin": false,
            "starred_url": "https://api.github.com/users/justinmk/starred{/owner}{/repo}",
            "subscriptions_url": "https://api.github.com/users/justinmk/subscriptions",
            "type": "User",
            "url": "https://api.github.com/users/justinmk",
            "user_view_type": "public"
        },
        "description": "Low priority items. We plan to work on this but don't have a target date.",
        "due_on": null,
        "html_url": "https://github.com/neovim/neovim/milestone/6",
        "id": 655037,
        "labels_url": "https://api.github.com/repos/neovim/neovim/milestones/6/labels",
        "node_id": "MDk6TWlsZXN0b25lNjU1MDM3",
        "number": 6,
        "open_issues": 637,
        "state": "open",
        "title": "backlog",
        "updated_at": "2026-02-23T20:46:06Z",
        "url": "https://api.github.com/repos/neovim/neovim/milestones/6"
    },
    "node_id": "I_kwDOAPphoM7lreZz",
    "number": 37548,
    "performed_via_github_app": null,
    "pinned_comment": null,
    "reactions": {
        "+1": 0,
        "-1": 0,
        "confused": 0,
        "eyes": 0,
        "heart": 0,
        "hooray": 0,
        "laugh": 0,
        "rocket": 0,
        "total_count": 0,
        "url": "https://api.github.com/repos/neovim/neovim/issues/37548/reactions"
    },
    "repository_url": "https://api.github.com/repos/neovim/neovim",
    "state": "open",
    "state_reason": null,
    "sub_issues_summary": {
        "completed": 0,
        "percent_completed": 0,
        "total": 0
    },
    "timeline_url": "https://api.github.com/repos/neovim/neovim/issues/37548/timeline",
    "title": "Diagnostic virtual_lines persists after diagnostic is fixed/removed",
    "type": {
        "color": "red",
        "created_at": "2024-01-25T10:10:19Z",
        "description": "An unexpected problem or behavior",
        "id": 597163,
        "is_enabled": true,
        "name": "Bug",
        "node_id": "IT_kwDOAGK_Pc4ACRyr",
        "updated_at": "2024-07-26T10:12:30Z"
    },
    "updated_at": "2026-02-20T16:07:21Z",
    "url": "https://api.github.com/repos/neovim/neovim/issues/37548",
    "user": {
        "avatar_url": "https://avatars.githubusercontent.com/u/49293546?v=4",
        "events_url": "https://api.github.com/users/aymenhafeez/events{/privacy}",
        "followers_url": "https://api.github.com/users/aymenhafeez/followers",
        "following_url": "https://api.github.com/users/aymenhafeez/following{/other_user}",
        "gists_url": "https://api.github.com/users/aymenhafeez/gists{/gist_id}",
        "gravatar_id": "",
        "html_url": "https://github.com/aymenhafeez",
        "id": 49293546,
        "login": "aymenhafeez",
        "node_id": "MDQ6VXNlcjQ5MjkzNTQ2",
        "organizations_url": "https://api.github.com/users/aymenhafeez/orgs",
        "received_events_url": "https://api.github.com/users/aymenhafeez/received_events",
        "repos_url": "https://api.github.com/users/aymenhafeez/repos",
        "site_admin": false,
        "starred_url": "https://api.github.com/users/aymenhafeez/starred{/owner}{/repo}",
        "subscriptions_url": "https://api.github.com/users/aymenhafeez/subscriptions",
        "type": "User",
        "url": "https://api.github.com/users/aymenhafeez",
        "user_view_type": "public"
    }
}