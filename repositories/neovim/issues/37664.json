{
    "active_lock_reason": null,
    "assignee": null,
    "assignees": [],
    "author_association": "CONTRIBUTOR",
    "body": "### Problem\n\nGiven a buffer with the following content\n\n```\na(\n  b\n)\n```\n\nwith the cursor located above `b`, doing `vkol` to get the following visual selection\n\n<img width=\"112\" height=\"131\" alt=\"Image\" src=\"https://github.com/user-attachments/assets/ba367bf8-f307-4150-859a-398e279700a5\" />\n\nand then doing `y` will result in the register `\"` containing the trailing newline of the visual selection (i.e. `=vim.fn.getreg('\"')` output will be `\\n  b\\n`).\n\nHowever, given the same buffer and the same visual selection, using the following `operatorfunc` operator\n\n```lua\n---@param type 'line'|'char'|'block'\n_G.my_yank = function(type)\n\tlocal mode = type == \"line\" and \"V\" or type == \"char\" and \"v\" or vim.keycode(\"<c-v>\")\n\tlocal yanked = vim.fn.getregion(vim.fn.getpos(\"'[\"), vim.fn.getpos(\"']\"), { type = mode })\n\tlocal end_mark = vim.api.nvim_buf_get_mark(0, \"]\")\n\t-- __PRINT_VAR_START\n\tprint([==[┆_G.my_yank┆ ╎end_mark╎ ┊1┊:]==], vim.inspect(end_mark)) -- __PRINT_VAR_END\n\t-- __PRINT_VAR_START\n\tprint([==[┆_G.my_yank┆ ╎yanked╎ ┊1┊:]==], vim.inspect(yanked)) -- __PRINT_VAR_END\nend\nvim.keymap.set({ \"x\", \"n\" }, \"<F4>\", function(a)\n\tvim.o.operatorfunc = \"v:lua._G.my_yank\"\n\treturn \"g@\"\nend, { expr = true })\n```\n\nand typing `<F4>` will result in `┆_G.my_yank┆ ╎yanked╎ ┊1┊: { \"\", \"  b\" }` being printed. Note the lack of a trailing empty string representing the trailing newline.\n\nThe same happens for the `operatorfunc` operator when the newline is not selected at all. With the cursor above `b`, doing `k` to get the following visual selection\n\n<img width=\"93\" height=\"118\" alt=\"Image\" src=\"https://github.com/user-attachments/assets/df6adb9c-0698-4d29-bf00-84de0124de19\" />\n\nalso results in `┆_G.my_yank┆ ╎yanked╎ ┊1┊: { \"\", \"  b\" }` being printed.\n\nSo, no matter if the newline if visually selected or not, the `operatorfunc` operator sees the same values for the `[` and `]` marks.\n\nThis happens because builtin operators (like `y`) get to operate on the range defined by `oap`\n\nhttps://github.com/neovim/neovim/blob/a8a097d178414e30ed758d332a74e649e43f105c/src/nvim/register.c#L1065-L1071\n\nbefore its end is adjusted with `decl`\n\nhttps://github.com/neovim/neovim/blob/a8a097d178414e30ed758d332a74e649e43f105c/src/nvim/register.c#L1158-L1161\n\nOn the other hand, `operatorfunc` operators get the value adjusted by `decl` before they can even see it\n\nhttps://github.com/neovim/neovim/blob/a8a097d178414e30ed758d332a74e649e43f105c/src/nvim/ops.c#L3160-L3163\n\nI also found that, with the first visual selection mentioned, doing `y` results in `vim.api.nvim_buf_get_mark(0, ']')` returning `{2,2}` while `vim.api.nvim_buf_get_mark(0, '>')` returns `{2,3}`\n\n### Steps to reproduce\n\n1. `nvim --clean -u minimal.lua`\n\nwhere `minimal.lua` contains\n\n```lua\n---@param type 'line'|'char'|'block'\n_G.my_yank = function(type)\n  local mode = type == \"line\" and \"V\" or type == \"char\" and \"v\" or vim.keycode \"<c-v>\"\n  local yanked = vim.fn.getregion(vim.fn.getpos \"'[\", vim.fn.getpos \"']\", { type = mode })\n  local end_mark = vim.api.nvim_buf_get_mark(0, \"]\")\n  -- __PRINT_VAR_START\n  print([==[┆_G.my_yank┆ ╎end_mark╎ ┊1┊:]==], vim.inspect(end_mark)) -- __PRINT_VAR_END\n  -- __PRINT_VAR_START\n  print([==[┆_G.my_yank┆ ╎yanked╎ ┊1┊:]==], vim.inspect(yanked)) -- __PRINT_VAR_END\nend\nvim.keymap.set({ \"x\", \"n\" }, \"<F4>\", function()\n  vim.o.operatorfunc = \"v:lua._G.my_yank\"\n  return \"g@\"\nend, { expr = true })\n```\n\n3. `ia()<esc>` `i<cr><esc>` `O  b<esc>` to end up with the same buffer mentioned above\n4. `vkol` to end up with a visual selection including a trailing newline\n5. `y` and `:=vim.fn.getreg('\"')` to see that the yanked text contains at trailing newline\n6. `gv` and `<f4>` to see that the text delimited by the `[` and `]` marks does not contain a trailing newline\n\n### Expected behavior\n\n`operatorfunc` operators, just like builtin operators (`d`, `y, etc), should be able to distinguish between regions with and without a trailing newline.\n\n### Nvim version (nvim -v)\n\n0.11.6\n\n### Vim (not Nvim) behaves the same?\n\nYes, VIM - Vi IMproved 9.1\n\n### Operating system/version\n\nArch linux latest\n\n### Terminal name/version\n\nwezterm 20240203-110809-5046fc22\n\n### $TERM environment variable\n\nwezterm\n\n### Installation\n\npacman",
    "closed_at": null,
    "closed_by": null,
    "comment_data": [],
    "comments": 0,
    "comments_url": "https://api.github.com/repos/neovim/neovim/issues/37664/comments",
    "created_at": "2026-02-01T23:49:12Z",
    "events_url": "https://api.github.com/repos/neovim/neovim/issues/37664/events",
    "html_url": "https://github.com/neovim/neovim/issues/37664",
    "id": 3883321295,
    "issue_dependencies_summary": {
        "blocked_by": 0,
        "blocking": 0,
        "total_blocked_by": 0,
        "total_blocking": 0
    },
    "labels": [],
    "labels_url": "https://api.github.com/repos/neovim/neovim/issues/37664/labels{/name}",
    "locked": false,
    "milestone": null,
    "node_id": "I_kwDOAPphoM7ndsfP",
    "number": 37664,
    "performed_via_github_app": null,
    "reactions": {
        "+1": 0,
        "-1": 0,
        "confused": 0,
        "eyes": 0,
        "heart": 0,
        "hooray": 0,
        "laugh": 0,
        "rocket": 0,
        "total_count": 0,
        "url": "https://api.github.com/repos/neovim/neovim/issues/37664/reactions"
    },
    "repository_url": "https://api.github.com/repos/neovim/neovim",
    "state": "open",
    "state_reason": null,
    "sub_issues_summary": {
        "completed": 0,
        "percent_completed": 0,
        "total": 0
    },
    "timeline_url": "https://api.github.com/repos/neovim/neovim/issues/37664/timeline",
    "title": "`operatorfunc` operators can't distinguish between regions ending or not in a newline (builtin operators can)",
    "type": {
        "color": "red",
        "created_at": "2024-01-25T10:10:19Z",
        "description": "An unexpected problem or behavior",
        "id": 597163,
        "is_enabled": true,
        "name": "Bug",
        "node_id": "IT_kwDOAGK_Pc4ACRyr",
        "updated_at": "2024-07-26T10:12:30Z"
    },
    "updated_at": "2026-02-01T23:49:12Z",
    "url": "https://api.github.com/repos/neovim/neovim/issues/37664",
    "user": {
        "avatar_url": "https://avatars.githubusercontent.com/u/53507599?v=4",
        "events_url": "https://api.github.com/users/TheLeoP/events{/privacy}",
        "followers_url": "https://api.github.com/users/TheLeoP/followers",
        "following_url": "https://api.github.com/users/TheLeoP/following{/other_user}",
        "gists_url": "https://api.github.com/users/TheLeoP/gists{/gist_id}",
        "gravatar_id": "",
        "html_url": "https://github.com/TheLeoP",
        "id": 53507599,
        "login": "TheLeoP",
        "node_id": "MDQ6VXNlcjUzNTA3NTk5",
        "organizations_url": "https://api.github.com/users/TheLeoP/orgs",
        "received_events_url": "https://api.github.com/users/TheLeoP/received_events",
        "repos_url": "https://api.github.com/users/TheLeoP/repos",
        "site_admin": false,
        "starred_url": "https://api.github.com/users/TheLeoP/starred{/owner}{/repo}",
        "subscriptions_url": "https://api.github.com/users/TheLeoP/subscriptions",
        "type": "User",
        "url": "https://api.github.com/users/TheLeoP",
        "user_view_type": "public"
    }
}