{
    "_links": {
        "comments": {
            "href": "https://api.github.com/repos/neovim/neovim/issues/31631/comments"
        },
        "commits": {
            "href": "https://api.github.com/repos/neovim/neovim/pulls/31631/commits"
        },
        "html": {
            "href": "https://github.com/neovim/neovim/pull/31631"
        },
        "issue": {
            "href": "https://api.github.com/repos/neovim/neovim/issues/31631"
        },
        "review_comment": {
            "href": "https://api.github.com/repos/neovim/neovim/pulls/comments{/number}"
        },
        "review_comments": {
            "href": "https://api.github.com/repos/neovim/neovim/pulls/31631/comments"
        },
        "self": {
            "href": "https://api.github.com/repos/neovim/neovim/pulls/31631"
        },
        "statuses": {
            "href": "https://api.github.com/repos/neovim/neovim/statuses/c885db4421200a476440ec14ce231bcf922f7248"
        }
    },
    "active_lock_reason": null,
    "assignee": null,
    "assignees": [],
    "author_association": "MEMBER",
    "auto_merge": null,
    "base": {
        "label": "neovim:master",
        "ref": "master",
        "repo": {
            "allow_forking": true,
            "archive_url": "https://api.github.com/repos/neovim/neovim/{archive_format}{/ref}",
            "archived": false,
            "assignees_url": "https://api.github.com/repos/neovim/neovim/assignees{/user}",
            "blobs_url": "https://api.github.com/repos/neovim/neovim/git/blobs{/sha}",
            "branches_url": "https://api.github.com/repos/neovim/neovim/branches{/branch}",
            "clone_url": "https://github.com/neovim/neovim.git",
            "collaborators_url": "https://api.github.com/repos/neovim/neovim/collaborators{/collaborator}",
            "comments_url": "https://api.github.com/repos/neovim/neovim/comments{/number}",
            "commits_url": "https://api.github.com/repos/neovim/neovim/commits{/sha}",
            "compare_url": "https://api.github.com/repos/neovim/neovim/compare/{base}...{head}",
            "contents_url": "https://api.github.com/repos/neovim/neovim/contents/{+path}",
            "contributors_url": "https://api.github.com/repos/neovim/neovim/contributors",
            "created_at": "2014-01-31T13:39:22Z",
            "default_branch": "master",
            "deployments_url": "https://api.github.com/repos/neovim/neovim/deployments",
            "description": "Vim-fork focused on extensibility and usability",
            "disabled": false,
            "downloads_url": "https://api.github.com/repos/neovim/neovim/downloads",
            "events_url": "https://api.github.com/repos/neovim/neovim/events",
            "fork": false,
            "forks": 5766,
            "forks_count": 5766,
            "forks_url": "https://api.github.com/repos/neovim/neovim/forks",
            "full_name": "neovim/neovim",
            "git_commits_url": "https://api.github.com/repos/neovim/neovim/git/commits{/sha}",
            "git_refs_url": "https://api.github.com/repos/neovim/neovim/git/refs{/sha}",
            "git_tags_url": "https://api.github.com/repos/neovim/neovim/git/tags{/sha}",
            "git_url": "git://github.com/neovim/neovim.git",
            "has_discussions": true,
            "has_downloads": true,
            "has_issues": true,
            "has_pages": false,
            "has_projects": true,
            "has_wiki": true,
            "homepage": "https://neovim.io",
            "hooks_url": "https://api.github.com/repos/neovim/neovim/hooks",
            "html_url": "https://github.com/neovim/neovim",
            "id": 16408992,
            "is_template": false,
            "issue_comment_url": "https://api.github.com/repos/neovim/neovim/issues/comments{/number}",
            "issue_events_url": "https://api.github.com/repos/neovim/neovim/issues/events{/number}",
            "issues_url": "https://api.github.com/repos/neovim/neovim/issues{/number}",
            "keys_url": "https://api.github.com/repos/neovim/neovim/keys{/key_id}",
            "labels_url": "https://api.github.com/repos/neovim/neovim/labels{/name}",
            "language": "Vim Script",
            "languages_url": "https://api.github.com/repos/neovim/neovim/languages",
            "license": {
                "key": "other",
                "name": "Other",
                "node_id": "MDc6TGljZW5zZTA=",
                "spdx_id": "NOASSERTION",
                "url": null
            },
            "merges_url": "https://api.github.com/repos/neovim/neovim/merges",
            "milestones_url": "https://api.github.com/repos/neovim/neovim/milestones{/number}",
            "mirror_url": null,
            "name": "neovim",
            "node_id": "MDEwOlJlcG9zaXRvcnkxNjQwODk5Mg==",
            "notifications_url": "https://api.github.com/repos/neovim/neovim/notifications{?since,all,participating}",
            "open_issues": 1818,
            "open_issues_count": 1818,
            "owner": {
                "avatar_url": "https://avatars.githubusercontent.com/u/6471485?v=4",
                "events_url": "https://api.github.com/users/neovim/events{/privacy}",
                "followers_url": "https://api.github.com/users/neovim/followers",
                "following_url": "https://api.github.com/users/neovim/following{/other_user}",
                "gists_url": "https://api.github.com/users/neovim/gists{/gist_id}",
                "gravatar_id": "",
                "html_url": "https://github.com/neovim",
                "id": 6471485,
                "login": "neovim",
                "node_id": "MDEyOk9yZ2FuaXphdGlvbjY0NzE0ODU=",
                "organizations_url": "https://api.github.com/users/neovim/orgs",
                "received_events_url": "https://api.github.com/users/neovim/received_events",
                "repos_url": "https://api.github.com/users/neovim/repos",
                "site_admin": false,
                "starred_url": "https://api.github.com/users/neovim/starred{/owner}{/repo}",
                "subscriptions_url": "https://api.github.com/users/neovim/subscriptions",
                "type": "Organization",
                "url": "https://api.github.com/users/neovim",
                "user_view_type": "public"
            },
            "private": false,
            "pulls_url": "https://api.github.com/repos/neovim/neovim/pulls{/number}",
            "pushed_at": "2024-12-23T21:39:36Z",
            "releases_url": "https://api.github.com/repos/neovim/neovim/releases{/id}",
            "size": 300480,
            "ssh_url": "git@github.com:neovim/neovim.git",
            "stargazers_count": 84495,
            "stargazers_url": "https://api.github.com/repos/neovim/neovim/stargazers",
            "statuses_url": "https://api.github.com/repos/neovim/neovim/statuses/{sha}",
            "subscribers_url": "https://api.github.com/repos/neovim/neovim/subscribers",
            "subscription_url": "https://api.github.com/repos/neovim/neovim/subscription",
            "svn_url": "https://github.com/neovim/neovim",
            "tags_url": "https://api.github.com/repos/neovim/neovim/tags",
            "teams_url": "https://api.github.com/repos/neovim/neovim/teams",
            "topics": [
                "api",
                "c",
                "lua",
                "neovim",
                "nvim",
                "text-editor",
                "vim"
            ],
            "trees_url": "https://api.github.com/repos/neovim/neovim/git/trees{/sha}",
            "updated_at": "2024-12-24T02:11:47Z",
            "url": "https://api.github.com/repos/neovim/neovim",
            "visibility": "public",
            "watchers": 84495,
            "watchers_count": 84495,
            "web_commit_signoff_required": false
        },
        "sha": "c51bf5a6b24928ac04d0bb129b1b424d4c78f28d",
        "user": {
            "avatar_url": "https://avatars.githubusercontent.com/u/6471485?v=4",
            "events_url": "https://api.github.com/users/neovim/events{/privacy}",
            "followers_url": "https://api.github.com/users/neovim/followers",
            "following_url": "https://api.github.com/users/neovim/following{/other_user}",
            "gists_url": "https://api.github.com/users/neovim/gists{/gist_id}",
            "gravatar_id": "",
            "html_url": "https://github.com/neovim",
            "id": 6471485,
            "login": "neovim",
            "node_id": "MDEyOk9yZ2FuaXphdGlvbjY0NzE0ODU=",
            "organizations_url": "https://api.github.com/users/neovim/orgs",
            "received_events_url": "https://api.github.com/users/neovim/received_events",
            "repos_url": "https://api.github.com/users/neovim/repos",
            "site_admin": false,
            "starred_url": "https://api.github.com/users/neovim/starred{/owner}{/repo}",
            "subscriptions_url": "https://api.github.com/users/neovim/subscriptions",
            "type": "Organization",
            "url": "https://api.github.com/users/neovim",
            "user_view_type": "public"
        }
    },
    "body": "**Problem:** Parsing can be slow for large files, and it is a blocking operation which can be disruptive and annoying.\r\n\r\n**Solution:** Provide a function for asynchronous parsing, which accepts a callback to be run after parsing completes.\r\n\r\nThis borrows from #22420 and from the pulsar implementation a bit. It currently works with the big linux file in my local testing, and I think the code is a bit simpler than before.\r\n\r\nThat said, there are still some stutters at times (with the gigantic file), which is disappointing. Start up time is massively improved but cursor movement stalls towards the end of parsing completion. ~If anyone can provide some insights on how to smooth over the asynchronous chunks it would be much appreciated.~\r\n\r\nThanks to some digging by @vanaigr, it is clear that the stutters are due to injection processing, specifically in the `iter_matches()` call in `LanguageTree:_get_injections()`. This is essentially the only highlighting bottleneck now. Deleting injection queries for the language gives no stutter whatsoever, and completely asynchronous highlighting.",
    "closed_at": null,
    "comment_data": [
        {
            "_links": {
                "html": {
                    "href": "https://github.com/neovim/neovim/pull/31631#discussion_r1891086046"
                },
                "pull_request": {
                    "href": "https://api.github.com/repos/neovim/neovim/pulls/31631"
                },
                "self": {
                    "href": "https://api.github.com/repos/neovim/neovim/pulls/comments/1891086046"
                }
            },
            "author_association": "MEMBER",
            "body": "This is a bit dangerous because we return `self` right after this- imo this function should not parse at all but I would like to hear some feedback on this\r\n\r\n(I tested removing `parse()` completely and not many tests failed, but it would mean that uses would have to manually parse in more cases than usual, e.g. when using `get_node()`)",
            "commit_id": "c885db4421200a476440ec14ce231bcf922f7248",
            "created_at": "2024-12-19T03:30:59Z",
            "diff_hunk": "@@ -61,7 +61,7 @@ function M._create_parser(bufnr, lang, opts)\n     { on_bytes = bytes_cb, on_detach = detach_cb, on_reload = reload_cb, preview = true }\n   )\n \n-  self:parse()\n+  self:async_parse()",
            "html_url": "https://github.com/neovim/neovim/pull/31631#discussion_r1891086046",
            "id": 1891086046,
            "line": null,
            "node_id": "PRRC_kwDOAPphoM5wt67e",
            "original_commit_id": "56e5a04f94660c093c40233ac1187827869ebc40",
            "original_line": 64,
            "original_position": 5,
            "original_start_line": null,
            "path": "runtime/lua/vim/treesitter.lua",
            "position": null,
            "pull_request_review_id": 2513242634,
            "pull_request_url": "https://api.github.com/repos/neovim/neovim/pulls/31631",
            "reactions": {
                "+1": 0,
                "-1": 0,
                "confused": 0,
                "eyes": 0,
                "heart": 0,
                "hooray": 0,
                "laugh": 0,
                "rocket": 0,
                "total_count": 0,
                "url": "https://api.github.com/repos/neovim/neovim/pulls/comments/1891086046/reactions"
            },
            "side": "RIGHT",
            "start_line": null,
            "start_side": null,
            "subject_type": "line",
            "updated_at": "2024-12-19T03:30:59Z",
            "url": "https://api.github.com/repos/neovim/neovim/pulls/comments/1891086046",
            "user": {
                "avatar_url": "https://avatars.githubusercontent.com/u/55766287?v=4",
                "events_url": "https://api.github.com/users/ribru17/events{/privacy}",
                "followers_url": "https://api.github.com/users/ribru17/followers",
                "following_url": "https://api.github.com/users/ribru17/following{/other_user}",
                "gists_url": "https://api.github.com/users/ribru17/gists{/gist_id}",
                "gravatar_id": "",
                "html_url": "https://github.com/ribru17",
                "id": 55766287,
                "login": "ribru17",
                "node_id": "MDQ6VXNlcjU1NzY2Mjg3",
                "organizations_url": "https://api.github.com/users/ribru17/orgs",
                "received_events_url": "https://api.github.com/users/ribru17/received_events",
                "repos_url": "https://api.github.com/users/ribru17/repos",
                "site_admin": false,
                "starred_url": "https://api.github.com/users/ribru17/starred{/owner}{/repo}",
                "subscriptions_url": "https://api.github.com/users/ribru17/subscriptions",
                "type": "User",
                "url": "https://api.github.com/users/ribru17",
                "user_view_type": "public"
            }
        },
        {
            "_links": {
                "html": {
                    "href": "https://github.com/neovim/neovim/pull/31631#discussion_r1891101316"
                },
                "pull_request": {
                    "href": "https://api.github.com/repos/neovim/neovim/pulls/31631"
                },
                "self": {
                    "href": "https://api.github.com/repos/neovim/neovim/pulls/comments/1891101316"
                }
            },
            "author_association": "CONTRIBUTOR",
            "body": "Is it possible for this parse to change the tree outside the provided range (e.g. a full reparse, combined injections)?\r\n\r\nIn that case, If the user scrolls up/down before the parse finishes, these newly visible lines would need to be redrawn as well when it does finish.\r\n\r\nUPD: I guess not, since a new parse will be requested for them as well.\r\n\r\n[Sorry, didn't highlight the lines below]",
            "commit_id": "c885db4421200a476440ec14ce231bcf922f7248",
            "created_at": "2024-12-19T04:01:00Z",
            "diff_hunk": "@@ -391,12 +388,22 @@ function TSHighlighter._on_win(_, _win, buf, topline, botline)\n   if not self then\n     return false\n   end\n-  self.tree:parse({ topline, botline + 1 })\n-  self:prepare_highlight_states(topline, botline + 1)\n-  self.redraw_count = self.redraw_count + 1\n+  local range = { topline, botline + 1 }",
            "html_url": "https://github.com/neovim/neovim/pull/31631#discussion_r1891101316",
            "id": 1891101316,
            "line": null,
            "node_id": "PRRC_kwDOAPphoM5wt-qE",
            "original_commit_id": "56e5a04f94660c093c40233ac1187827869ebc40",
            "original_line": 391,
            "original_position": 26,
            "original_start_line": null,
            "path": "runtime/lua/vim/treesitter/highlighter.lua",
            "position": null,
            "pull_request_review_id": 2513264187,
            "pull_request_url": "https://api.github.com/repos/neovim/neovim/pulls/31631",
            "reactions": {
                "+1": 0,
                "-1": 0,
                "confused": 0,
                "eyes": 0,
                "heart": 0,
                "hooray": 0,
                "laugh": 0,
                "rocket": 0,
                "total_count": 0,
                "url": "https://api.github.com/repos/neovim/neovim/pulls/comments/1891101316/reactions"
            },
            "side": "RIGHT",
            "start_line": null,
            "start_side": null,
            "subject_type": "line",
            "updated_at": "2024-12-19T04:18:28Z",
            "url": "https://api.github.com/repos/neovim/neovim/pulls/comments/1891101316",
            "user": {
                "avatar_url": "https://avatars.githubusercontent.com/u/65824523?v=4",
                "events_url": "https://api.github.com/users/vanaigr/events{/privacy}",
                "followers_url": "https://api.github.com/users/vanaigr/followers",
                "following_url": "https://api.github.com/users/vanaigr/following{/other_user}",
                "gists_url": "https://api.github.com/users/vanaigr/gists{/gist_id}",
                "gravatar_id": "",
                "html_url": "https://github.com/vanaigr",
                "id": 65824523,
                "login": "vanaigr",
                "node_id": "MDQ6VXNlcjY1ODI0NTIz",
                "organizations_url": "https://api.github.com/users/vanaigr/orgs",
                "received_events_url": "https://api.github.com/users/vanaigr/received_events",
                "repos_url": "https://api.github.com/users/vanaigr/repos",
                "site_admin": false,
                "starred_url": "https://api.github.com/users/vanaigr/starred{/owner}{/repo}",
                "subscriptions_url": "https://api.github.com/users/vanaigr/subscriptions",
                "type": "User",
                "url": "https://api.github.com/users/vanaigr",
                "user_view_type": "public"
            }
        },
        {
            "_links": {
                "html": {
                    "href": "https://github.com/neovim/neovim/pull/31631#discussion_r1891123444"
                },
                "pull_request": {
                    "href": "https://api.github.com/repos/neovim/neovim/pulls/31631"
                },
                "self": {
                    "href": "https://api.github.com/repos/neovim/neovim/pulls/comments/1891123444"
                }
            },
            "author_association": "CONTRIBUTOR",
            "body": "Though this does happen if there are 2 windows:\r\n<details>\r\n<summary>image</summary>\r\n\r\n![image](https://github.com/user-attachments/assets/1dc6e484-7a61-4bfd-9f2b-80f513c07520)\r\n\r\n</details>\r\n",
            "commit_id": "c885db4421200a476440ec14ce231bcf922f7248",
            "created_at": "2024-12-19T04:26:58Z",
            "diff_hunk": "@@ -391,12 +388,22 @@ function TSHighlighter._on_win(_, _win, buf, topline, botline)\n   if not self then\n     return false\n   end\n-  self.tree:parse({ topline, botline + 1 })\n-  self:prepare_highlight_states(topline, botline + 1)\n-  self.redraw_count = self.redraw_count + 1\n+  local range = { topline, botline + 1 }",
            "html_url": "https://github.com/neovim/neovim/pull/31631#discussion_r1891123444",
            "id": 1891123444,
            "in_reply_to_id": 1891101316,
            "line": null,
            "node_id": "PRRC_kwDOAPphoM5wuED0",
            "original_commit_id": "56e5a04f94660c093c40233ac1187827869ebc40",
            "original_line": 391,
            "original_position": 26,
            "original_start_line": null,
            "path": "runtime/lua/vim/treesitter/highlighter.lua",
            "position": null,
            "pull_request_review_id": 2513295283,
            "pull_request_url": "https://api.github.com/repos/neovim/neovim/pulls/31631",
            "reactions": {
                "+1": 0,
                "-1": 0,
                "confused": 0,
                "eyes": 1,
                "heart": 0,
                "hooray": 0,
                "laugh": 0,
                "rocket": 0,
                "total_count": 1,
                "url": "https://api.github.com/repos/neovim/neovim/pulls/comments/1891123444/reactions"
            },
            "side": "RIGHT",
            "start_line": null,
            "start_side": null,
            "subject_type": "line",
            "updated_at": "2024-12-19T05:31:36Z",
            "url": "https://api.github.com/repos/neovim/neovim/pulls/comments/1891123444",
            "user": {
                "avatar_url": "https://avatars.githubusercontent.com/u/65824523?v=4",
                "events_url": "https://api.github.com/users/vanaigr/events{/privacy}",
                "followers_url": "https://api.github.com/users/vanaigr/followers",
                "following_url": "https://api.github.com/users/vanaigr/following{/other_user}",
                "gists_url": "https://api.github.com/users/vanaigr/gists{/gist_id}",
                "gravatar_id": "",
                "html_url": "https://github.com/vanaigr",
                "id": 65824523,
                "login": "vanaigr",
                "node_id": "MDQ6VXNlcjY1ODI0NTIz",
                "organizations_url": "https://api.github.com/users/vanaigr/orgs",
                "received_events_url": "https://api.github.com/users/vanaigr/received_events",
                "repos_url": "https://api.github.com/users/vanaigr/repos",
                "site_admin": false,
                "starred_url": "https://api.github.com/users/vanaigr/starred{/owner}{/repo}",
                "subscriptions_url": "https://api.github.com/users/vanaigr/subscriptions",
                "type": "User",
                "url": "https://api.github.com/users/vanaigr",
                "user_view_type": "public"
            }
        },
        {
            "_links": {
                "html": {
                    "href": "https://github.com/neovim/neovim/pull/31631#discussion_r1891171204"
                },
                "pull_request": {
                    "href": "https://api.github.com/repos/neovim/neovim/pulls/31631"
                },
                "self": {
                    "href": "https://api.github.com/repos/neovim/neovim/pulls/comments/1891171204"
                }
            },
            "author_association": "CONTRIBUTOR",
            "body": "It seems that the parser becomes desynchronized from the buffer. Not sure what I did to make this happen\r\n<details>\r\n<summary>image</summary>\r\n\r\n![image](https://github.com/user-attachments/assets/612ccf5f-625d-4d0f-8560-33f18e10d047)\r\n\r\n</details>",
            "commit_id": "c885db4421200a476440ec14ce231bcf922f7248",
            "created_at": "2024-12-19T05:21:52Z",
            "diff_hunk": "@@ -391,12 +388,22 @@ function TSHighlighter._on_win(_, _win, buf, topline, botline)\n   if not self then\n     return false\n   end\n-  self.tree:parse({ topline, botline + 1 })\n-  self:prepare_highlight_states(topline, botline + 1)\n-  self.redraw_count = self.redraw_count + 1\n+  local range = { topline, botline + 1 }",
            "html_url": "https://github.com/neovim/neovim/pull/31631#discussion_r1891171204",
            "id": 1891171204,
            "in_reply_to_id": 1891101316,
            "line": null,
            "node_id": "PRRC_kwDOAPphoM5wuPuE",
            "original_commit_id": "56e5a04f94660c093c40233ac1187827869ebc40",
            "original_line": 391,
            "original_position": 26,
            "original_start_line": null,
            "path": "runtime/lua/vim/treesitter/highlighter.lua",
            "position": null,
            "pull_request_review_id": 2513374949,
            "pull_request_url": "https://api.github.com/repos/neovim/neovim/pulls/31631",
            "reactions": {
                "+1": 0,
                "-1": 0,
                "confused": 0,
                "eyes": 0,
                "heart": 0,
                "hooray": 0,
                "laugh": 0,
                "rocket": 0,
                "total_count": 0,
                "url": "https://api.github.com/repos/neovim/neovim/pulls/comments/1891171204/reactions"
            },
            "side": "RIGHT",
            "start_line": null,
            "start_side": null,
            "subject_type": "line",
            "updated_at": "2024-12-19T05:31:22Z",
            "url": "https://api.github.com/repos/neovim/neovim/pulls/comments/1891171204",
            "user": {
                "avatar_url": "https://avatars.githubusercontent.com/u/65824523?v=4",
                "events_url": "https://api.github.com/users/vanaigr/events{/privacy}",
                "followers_url": "https://api.github.com/users/vanaigr/followers",
                "following_url": "https://api.github.com/users/vanaigr/following{/other_user}",
                "gists_url": "https://api.github.com/users/vanaigr/gists{/gist_id}",
                "gravatar_id": "",
                "html_url": "https://github.com/vanaigr",
                "id": 65824523,
                "login": "vanaigr",
                "node_id": "MDQ6VXNlcjY1ODI0NTIz",
                "organizations_url": "https://api.github.com/users/vanaigr/orgs",
                "received_events_url": "https://api.github.com/users/vanaigr/received_events",
                "repos_url": "https://api.github.com/users/vanaigr/repos",
                "site_admin": false,
                "starred_url": "https://api.github.com/users/vanaigr/starred{/owner}{/repo}",
                "subscriptions_url": "https://api.github.com/users/vanaigr/subscriptions",
                "type": "User",
                "url": "https://api.github.com/users/vanaigr",
                "user_view_type": "public"
            }
        },
        {
            "_links": {
                "html": {
                    "href": "https://github.com/neovim/neovim/pull/31631#discussion_r1891217040"
                },
                "pull_request": {
                    "href": "https://api.github.com/repos/neovim/neovim/pulls/31631"
                },
                "self": {
                    "href": "https://api.github.com/repos/neovim/neovim/pulls/comments/1891217040"
                }
            },
            "author_association": "MEMBER",
            "body": "Ah, thanks so much for the thorough testing. I can't find how to replicate this, do you mind if I ask what you did for the buffer split one? That one looks bad lol",
            "commit_id": "c885db4421200a476440ec14ce231bcf922f7248",
            "created_at": "2024-12-19T06:25:24Z",
            "diff_hunk": "@@ -391,12 +388,22 @@ function TSHighlighter._on_win(_, _win, buf, topline, botline)\n   if not self then\n     return false\n   end\n-  self.tree:parse({ topline, botline + 1 })\n-  self:prepare_highlight_states(topline, botline + 1)\n-  self.redraw_count = self.redraw_count + 1\n+  local range = { topline, botline + 1 }",
            "html_url": "https://github.com/neovim/neovim/pull/31631#discussion_r1891217040",
            "id": 1891217040,
            "in_reply_to_id": 1891101316,
            "line": null,
            "node_id": "PRRC_kwDOAPphoM5wua6Q",
            "original_commit_id": "56e5a04f94660c093c40233ac1187827869ebc40",
            "original_line": 391,
            "original_position": 26,
            "original_start_line": null,
            "path": "runtime/lua/vim/treesitter/highlighter.lua",
            "position": null,
            "pull_request_review_id": 2513456799,
            "pull_request_url": "https://api.github.com/repos/neovim/neovim/pulls/31631",
            "reactions": {
                "+1": 0,
                "-1": 0,
                "confused": 0,
                "eyes": 0,
                "heart": 0,
                "hooray": 0,
                "laugh": 0,
                "rocket": 0,
                "total_count": 0,
                "url": "https://api.github.com/repos/neovim/neovim/pulls/comments/1891217040/reactions"
            },
            "side": "RIGHT",
            "start_line": null,
            "start_side": null,
            "subject_type": "line",
            "updated_at": "2024-12-19T06:25:24Z",
            "url": "https://api.github.com/repos/neovim/neovim/pulls/comments/1891217040",
            "user": {
                "avatar_url": "https://avatars.githubusercontent.com/u/55766287?v=4",
                "events_url": "https://api.github.com/users/ribru17/events{/privacy}",
                "followers_url": "https://api.github.com/users/ribru17/followers",
                "following_url": "https://api.github.com/users/ribru17/following{/other_user}",
                "gists_url": "https://api.github.com/users/ribru17/gists{/gist_id}",
                "gravatar_id": "",
                "html_url": "https://github.com/ribru17",
                "id": 55766287,
                "login": "ribru17",
                "node_id": "MDQ6VXNlcjU1NzY2Mjg3",
                "organizations_url": "https://api.github.com/users/ribru17/orgs",
                "received_events_url": "https://api.github.com/users/ribru17/received_events",
                "repos_url": "https://api.github.com/users/ribru17/repos",
                "site_admin": false,
                "starred_url": "https://api.github.com/users/ribru17/starred{/owner}{/repo}",
                "subscriptions_url": "https://api.github.com/users/ribru17/subscriptions",
                "type": "User",
                "url": "https://api.github.com/users/ribru17",
                "user_view_type": "public"
            }
        },
        {
            "_links": {
                "html": {
                    "href": "https://github.com/neovim/neovim/pull/31631#discussion_r1891237615"
                },
                "pull_request": {
                    "href": "https://api.github.com/repos/neovim/neovim/pulls/31631"
                },
                "self": {
                    "href": "https://api.github.com/repos/neovim/neovim/pulls/comments/1891237615"
                }
            },
            "author_association": "CONTRIBUTOR",
            "body": "test.lua:\r\n```\r\nlocal _ = \"\r\nvim.api.nvim_set_hl(0, 'Test2', { bg = 'green' }) --repeated until line 50'000\r\nvim.api.nvim_set_hl(0, 'Test3', { bg = 'blue' })\r\n```\r\n\r\n1. Open a split window.\r\n2. Place the cursor on `\"`\r\n3. Enter insert mode and hold `\"` for ~5sec",
            "commit_id": "c885db4421200a476440ec14ce231bcf922f7248",
            "created_at": "2024-12-19T06:52:11Z",
            "diff_hunk": "@@ -391,12 +388,22 @@ function TSHighlighter._on_win(_, _win, buf, topline, botline)\n   if not self then\n     return false\n   end\n-  self.tree:parse({ topline, botline + 1 })\n-  self:prepare_highlight_states(topline, botline + 1)\n-  self.redraw_count = self.redraw_count + 1\n+  local range = { topline, botline + 1 }",
            "html_url": "https://github.com/neovim/neovim/pull/31631#discussion_r1891237615",
            "id": 1891237615,
            "in_reply_to_id": 1891101316,
            "line": null,
            "node_id": "PRRC_kwDOAPphoM5wuf7v",
            "original_commit_id": "56e5a04f94660c093c40233ac1187827869ebc40",
            "original_line": 391,
            "original_position": 26,
            "original_start_line": null,
            "path": "runtime/lua/vim/treesitter/highlighter.lua",
            "position": null,
            "pull_request_review_id": 2513489164,
            "pull_request_url": "https://api.github.com/repos/neovim/neovim/pulls/31631",
            "reactions": {
                "+1": 0,
                "-1": 0,
                "confused": 0,
                "eyes": 0,
                "heart": 1,
                "hooray": 0,
                "laugh": 0,
                "rocket": 0,
                "total_count": 1,
                "url": "https://api.github.com/repos/neovim/neovim/pulls/comments/1891237615/reactions"
            },
            "side": "RIGHT",
            "start_line": null,
            "start_side": null,
            "subject_type": "line",
            "updated_at": "2024-12-19T07:06:21Z",
            "url": "https://api.github.com/repos/neovim/neovim/pulls/comments/1891237615",
            "user": {
                "avatar_url": "https://avatars.githubusercontent.com/u/65824523?v=4",
                "events_url": "https://api.github.com/users/vanaigr/events{/privacy}",
                "followers_url": "https://api.github.com/users/vanaigr/followers",
                "following_url": "https://api.github.com/users/vanaigr/following{/other_user}",
                "gists_url": "https://api.github.com/users/vanaigr/gists{/gist_id}",
                "gravatar_id": "",
                "html_url": "https://github.com/vanaigr",
                "id": 65824523,
                "login": "vanaigr",
                "node_id": "MDQ6VXNlcjY1ODI0NTIz",
                "organizations_url": "https://api.github.com/users/vanaigr/orgs",
                "received_events_url": "https://api.github.com/users/vanaigr/received_events",
                "repos_url": "https://api.github.com/users/vanaigr/repos",
                "site_admin": false,
                "starred_url": "https://api.github.com/users/vanaigr/starred{/owner}{/repo}",
                "subscriptions_url": "https://api.github.com/users/vanaigr/subscriptions",
                "type": "User",
                "url": "https://api.github.com/users/vanaigr",
                "user_view_type": "public"
            }
        },
        {
            "_links": {
                "html": {
                    "href": "https://github.com/neovim/neovim/pull/31631#discussion_r1892856406"
                },
                "pull_request": {
                    "href": "https://api.github.com/repos/neovim/neovim/pulls/31631"
                },
                "self": {
                    "href": "https://api.github.com/repos/neovim/neovim/pulls/comments/1892856406"
                }
            },
            "author_association": "MEMBER",
            "body": "For the two windows case I have noticed that after a few seconds for another reparse, the windows again come into sync with their highlighting despite the initial loss of sync due to parser lag. Are you able to confirm this happening?\r\n\r\nAs for the `:InspectTree` weirdness my guess is maybe that since the parser there is parsing synchronously it interferes/is different from the main highlighter parsing which runs async?",
            "commit_id": "c885db4421200a476440ec14ce231bcf922f7248",
            "created_at": "2024-12-19T17:37:58Z",
            "diff_hunk": "@@ -391,12 +388,22 @@ function TSHighlighter._on_win(_, _win, buf, topline, botline)\n   if not self then\n     return false\n   end\n-  self.tree:parse({ topline, botline + 1 })\n-  self:prepare_highlight_states(topline, botline + 1)\n-  self.redraw_count = self.redraw_count + 1\n+  local range = { topline, botline + 1 }",
            "html_url": "https://github.com/neovim/neovim/pull/31631#discussion_r1892856406",
            "id": 1892856406,
            "in_reply_to_id": 1891101316,
            "line": null,
            "node_id": "PRRC_kwDOAPphoM5w0rJW",
            "original_commit_id": "56e5a04f94660c093c40233ac1187827869ebc40",
            "original_line": 391,
            "original_position": 26,
            "original_start_line": null,
            "path": "runtime/lua/vim/treesitter/highlighter.lua",
            "position": null,
            "pull_request_review_id": 2515739274,
            "pull_request_url": "https://api.github.com/repos/neovim/neovim/pulls/31631",
            "reactions": {
                "+1": 0,
                "-1": 0,
                "confused": 0,
                "eyes": 0,
                "heart": 0,
                "hooray": 0,
                "laugh": 0,
                "rocket": 0,
                "total_count": 0,
                "url": "https://api.github.com/repos/neovim/neovim/pulls/comments/1892856406/reactions"
            },
            "side": "RIGHT",
            "start_line": null,
            "start_side": null,
            "subject_type": "line",
            "updated_at": "2024-12-19T17:37:58Z",
            "url": "https://api.github.com/repos/neovim/neovim/pulls/comments/1892856406",
            "user": {
                "avatar_url": "https://avatars.githubusercontent.com/u/55766287?v=4",
                "events_url": "https://api.github.com/users/ribru17/events{/privacy}",
                "followers_url": "https://api.github.com/users/ribru17/followers",
                "following_url": "https://api.github.com/users/ribru17/following{/other_user}",
                "gists_url": "https://api.github.com/users/ribru17/gists{/gist_id}",
                "gravatar_id": "",
                "html_url": "https://github.com/ribru17",
                "id": 55766287,
                "login": "ribru17",
                "node_id": "MDQ6VXNlcjU1NzY2Mjg3",
                "organizations_url": "https://api.github.com/users/ribru17/orgs",
                "received_events_url": "https://api.github.com/users/ribru17/received_events",
                "repos_url": "https://api.github.com/users/ribru17/repos",
                "site_admin": false,
                "starred_url": "https://api.github.com/users/ribru17/starred{/owner}{/repo}",
                "subscriptions_url": "https://api.github.com/users/ribru17/subscriptions",
                "type": "User",
                "url": "https://api.github.com/users/ribru17",
                "user_view_type": "public"
            }
        },
        {
            "_links": {
                "html": {
                    "href": "https://github.com/neovim/neovim/pull/31631#discussion_r1892892023"
                },
                "pull_request": {
                    "href": "https://api.github.com/repos/neovim/neovim/pulls/31631"
                },
                "self": {
                    "href": "https://api.github.com/repos/neovim/neovim/pulls/comments/1892892023"
                }
            },
            "author_association": "CONTRIBUTOR",
            "body": "> For the two windows case I have noticed that after a few seconds for another reparse, the windows again come into sync with their highlighting despite the initial loss of sync due to parser lag. Are you able to confirm this happening?\r\n> \r\n> As for the `:InspectTree` weirdness my guess is maybe that since the parser there is parsing synchronously it interferes/is different from the main highlighter parsing which runs async?\r\n\r\nYes, they almost always synchronize if not many actions are performed. I typed and removed the `\"` quickly and this happened. \r\n\r\nI assume both are essentially the same issue. When multiple parses are requested and the buffer is modified, sometimes the parser state becomes desynchronized.\r\n\r\nIn the `:InspectTree` case, I opened the preview to show that the root chunk is broken. The menu was opened after the fact. Before the issue happened, I also had the 2 windows.",
            "commit_id": "c885db4421200a476440ec14ce231bcf922f7248",
            "created_at": "2024-12-19T17:49:15Z",
            "diff_hunk": "@@ -391,12 +388,22 @@ function TSHighlighter._on_win(_, _win, buf, topline, botline)\n   if not self then\n     return false\n   end\n-  self.tree:parse({ topline, botline + 1 })\n-  self:prepare_highlight_states(topline, botline + 1)\n-  self.redraw_count = self.redraw_count + 1\n+  local range = { topline, botline + 1 }",
            "html_url": "https://github.com/neovim/neovim/pull/31631#discussion_r1892892023",
            "id": 1892892023,
            "in_reply_to_id": 1891101316,
            "line": null,
            "node_id": "PRRC_kwDOAPphoM5w0z13",
            "original_commit_id": "56e5a04f94660c093c40233ac1187827869ebc40",
            "original_line": 391,
            "original_position": 26,
            "original_start_line": null,
            "path": "runtime/lua/vim/treesitter/highlighter.lua",
            "position": null,
            "pull_request_review_id": 2515785262,
            "pull_request_url": "https://api.github.com/repos/neovim/neovim/pulls/31631",
            "reactions": {
                "+1": 0,
                "-1": 0,
                "confused": 0,
                "eyes": 0,
                "heart": 0,
                "hooray": 0,
                "laugh": 0,
                "rocket": 0,
                "total_count": 0,
                "url": "https://api.github.com/repos/neovim/neovim/pulls/comments/1892892023/reactions"
            },
            "side": "RIGHT",
            "start_line": null,
            "start_side": null,
            "subject_type": "line",
            "updated_at": "2024-12-19T17:53:02Z",
            "url": "https://api.github.com/repos/neovim/neovim/pulls/comments/1892892023",
            "user": {
                "avatar_url": "https://avatars.githubusercontent.com/u/65824523?v=4",
                "events_url": "https://api.github.com/users/vanaigr/events{/privacy}",
                "followers_url": "https://api.github.com/users/vanaigr/followers",
                "following_url": "https://api.github.com/users/vanaigr/following{/other_user}",
                "gists_url": "https://api.github.com/users/vanaigr/gists{/gist_id}",
                "gravatar_id": "",
                "html_url": "https://github.com/vanaigr",
                "id": 65824523,
                "login": "vanaigr",
                "node_id": "MDQ6VXNlcjY1ODI0NTIz",
                "organizations_url": "https://api.github.com/users/vanaigr/orgs",
                "received_events_url": "https://api.github.com/users/vanaigr/received_events",
                "repos_url": "https://api.github.com/users/vanaigr/repos",
                "site_admin": false,
                "starred_url": "https://api.github.com/users/vanaigr/starred{/owner}{/repo}",
                "subscriptions_url": "https://api.github.com/users/vanaigr/subscriptions",
                "type": "User",
                "url": "https://api.github.com/users/vanaigr",
                "user_view_type": "public"
            }
        },
        {
            "_links": {
                "html": {
                    "href": "https://github.com/neovim/neovim/pull/31631#discussion_r1892915270"
                },
                "pull_request": {
                    "href": "https://api.github.com/repos/neovim/neovim/pulls/31631"
                },
                "self": {
                    "href": "https://api.github.com/repos/neovim/neovim/pulls/comments/1892915270"
                }
            },
            "author_association": "MEMBER",
            "body": "Thanks, that makes sense. I am realizing now how nice it would be to have first class async support in nvim",
            "commit_id": "c885db4421200a476440ec14ce231bcf922f7248",
            "created_at": "2024-12-19T17:56:52Z",
            "diff_hunk": "@@ -391,12 +388,22 @@ function TSHighlighter._on_win(_, _win, buf, topline, botline)\n   if not self then\n     return false\n   end\n-  self.tree:parse({ topline, botline + 1 })\n-  self:prepare_highlight_states(topline, botline + 1)\n-  self.redraw_count = self.redraw_count + 1\n+  local range = { topline, botline + 1 }",
            "html_url": "https://github.com/neovim/neovim/pull/31631#discussion_r1892915270",
            "id": 1892915270,
            "in_reply_to_id": 1891101316,
            "line": null,
            "node_id": "PRRC_kwDOAPphoM5w05hG",
            "original_commit_id": "56e5a04f94660c093c40233ac1187827869ebc40",
            "original_line": 391,
            "original_position": 26,
            "original_start_line": null,
            "path": "runtime/lua/vim/treesitter/highlighter.lua",
            "position": null,
            "pull_request_review_id": 2515816343,
            "pull_request_url": "https://api.github.com/repos/neovim/neovim/pulls/31631",
            "reactions": {
                "+1": 0,
                "-1": 0,
                "confused": 0,
                "eyes": 0,
                "heart": 0,
                "hooray": 0,
                "laugh": 0,
                "rocket": 0,
                "total_count": 0,
                "url": "https://api.github.com/repos/neovim/neovim/pulls/comments/1892915270/reactions"
            },
            "side": "RIGHT",
            "start_line": null,
            "start_side": null,
            "subject_type": "line",
            "updated_at": "2024-12-19T17:56:53Z",
            "url": "https://api.github.com/repos/neovim/neovim/pulls/comments/1892915270",
            "user": {
                "avatar_url": "https://avatars.githubusercontent.com/u/55766287?v=4",
                "events_url": "https://api.github.com/users/ribru17/events{/privacy}",
                "followers_url": "https://api.github.com/users/ribru17/followers",
                "following_url": "https://api.github.com/users/ribru17/following{/other_user}",
                "gists_url": "https://api.github.com/users/ribru17/gists{/gist_id}",
                "gravatar_id": "",
                "html_url": "https://github.com/ribru17",
                "id": 55766287,
                "login": "ribru17",
                "node_id": "MDQ6VXNlcjU1NzY2Mjg3",
                "organizations_url": "https://api.github.com/users/ribru17/orgs",
                "received_events_url": "https://api.github.com/users/ribru17/received_events",
                "repos_url": "https://api.github.com/users/ribru17/repos",
                "site_admin": false,
                "starred_url": "https://api.github.com/users/ribru17/starred{/owner}{/repo}",
                "subscriptions_url": "https://api.github.com/users/ribru17/subscriptions",
                "type": "User",
                "url": "https://api.github.com/users/ribru17",
                "user_view_type": "public"
            }
        },
        {
            "_links": {
                "html": {
                    "href": "https://github.com/neovim/neovim/pull/31631#discussion_r1892921767"
                },
                "pull_request": {
                    "href": "https://api.github.com/repos/neovim/neovim/pulls/31631"
                },
                "self": {
                    "href": "https://api.github.com/repos/neovim/neovim/pulls/comments/1892921767"
                }
            },
            "author_association": "MEMBER",
            "body": "In your opinion, should this issue block this PR? I'm unaware how much of this is just a natural result of using async functionality vs true edge cases I still need to account for",
            "commit_id": "c885db4421200a476440ec14ce231bcf922f7248",
            "created_at": "2024-12-19T17:58:55Z",
            "diff_hunk": "@@ -391,12 +388,22 @@ function TSHighlighter._on_win(_, _win, buf, topline, botline)\n   if not self then\n     return false\n   end\n-  self.tree:parse({ topline, botline + 1 })\n-  self:prepare_highlight_states(topline, botline + 1)\n-  self.redraw_count = self.redraw_count + 1\n+  local range = { topline, botline + 1 }",
            "html_url": "https://github.com/neovim/neovim/pull/31631#discussion_r1892921767",
            "id": 1892921767,
            "in_reply_to_id": 1891101316,
            "line": null,
            "node_id": "PRRC_kwDOAPphoM5w07Gn",
            "original_commit_id": "56e5a04f94660c093c40233ac1187827869ebc40",
            "original_line": 391,
            "original_position": 26,
            "original_start_line": null,
            "path": "runtime/lua/vim/treesitter/highlighter.lua",
            "position": null,
            "pull_request_review_id": 2515824960,
            "pull_request_url": "https://api.github.com/repos/neovim/neovim/pulls/31631",
            "reactions": {
                "+1": 0,
                "-1": 0,
                "confused": 0,
                "eyes": 0,
                "heart": 0,
                "hooray": 0,
                "laugh": 0,
                "rocket": 0,
                "total_count": 0,
                "url": "https://api.github.com/repos/neovim/neovim/pulls/comments/1892921767/reactions"
            },
            "side": "RIGHT",
            "start_line": null,
            "start_side": null,
            "subject_type": "line",
            "updated_at": "2024-12-19T17:59:04Z",
            "url": "https://api.github.com/repos/neovim/neovim/pulls/comments/1892921767",
            "user": {
                "avatar_url": "https://avatars.githubusercontent.com/u/55766287?v=4",
                "events_url": "https://api.github.com/users/ribru17/events{/privacy}",
                "followers_url": "https://api.github.com/users/ribru17/followers",
                "following_url": "https://api.github.com/users/ribru17/following{/other_user}",
                "gists_url": "https://api.github.com/users/ribru17/gists{/gist_id}",
                "gravatar_id": "",
                "html_url": "https://github.com/ribru17",
                "id": 55766287,
                "login": "ribru17",
                "node_id": "MDQ6VXNlcjU1NzY2Mjg3",
                "organizations_url": "https://api.github.com/users/ribru17/orgs",
                "received_events_url": "https://api.github.com/users/ribru17/received_events",
                "repos_url": "https://api.github.com/users/ribru17/repos",
                "site_admin": false,
                "starred_url": "https://api.github.com/users/ribru17/starred{/owner}{/repo}",
                "subscriptions_url": "https://api.github.com/users/ribru17/subscriptions",
                "type": "User",
                "url": "https://api.github.com/users/ribru17",
                "user_view_type": "public"
            }
        },
        {
            "_links": {
                "html": {
                    "href": "https://github.com/neovim/neovim/pull/31631#discussion_r1893854340"
                },
                "pull_request": {
                    "href": "https://api.github.com/repos/neovim/neovim/pulls/31631"
                },
                "self": {
                    "href": "https://api.github.com/repos/neovim/neovim/pulls/comments/1893854340"
                }
            },
            "author_association": "MEMBER",
            "body": "Seems natural for this to be on the existing `:parse()`. If a callback isn't provided then it's synchronous. Don't think we what `async_` variants of functions everywhere.\r\n\r\n```suggestion\r\n       {opts}   (`ParseOpts?`) Options:\r\n      * {on_parse} (fun(trees: table<integer, TSTree>)?)\r\n```",
            "commit_id": "c885db4421200a476440ec14ce231bcf922f7248",
            "created_at": "2024-12-20T11:59:12Z",
            "diff_hunk": "@@ -1479,6 +1482,21 @@ anyway as they will be very frequent. Rather a plugin that does any kind of\n analysis on a tree should use a timer to throttle too frequent updates.\n \n \n+LanguageTree:async_parse({range}, {opts})         *LanguageTree:async_parse()*\n+    Like |LanguageTree:parse()|, but asynchronous.\n+\n+    Parameters: ~\n+       {range}  (`boolean|Range?`) Parse this range in the parser's source.\n+                 Set to `true` to run a complete parse of the source (Note:\n+                 Can be slow!) Set to `false|nil` to only parse regions with\n+                 empty ranges (typically only the root tree without\n+                 injections).\n+       {opts}   (`AsyncParseOpts?`) Options:",
            "html_url": "https://github.com/neovim/neovim/pull/31631#discussion_r1893854340",
            "id": 1893854340,
            "line": null,
            "node_id": "PRRC_kwDOAPphoM5w4eyE",
            "original_commit_id": "5df81d70ae5d3bd4ff9894855dd126261f77f227",
            "original_line": 1494,
            "original_position": 23,
            "original_start_line": null,
            "path": "runtime/doc/treesitter.txt",
            "position": null,
            "pull_request_review_id": 2517404917,
            "pull_request_url": "https://api.github.com/repos/neovim/neovim/pulls/31631",
            "reactions": {
                "+1": 0,
                "-1": 0,
                "confused": 0,
                "eyes": 0,
                "heart": 0,
                "hooray": 0,
                "laugh": 0,
                "rocket": 0,
                "total_count": 0,
                "url": "https://api.github.com/repos/neovim/neovim/pulls/comments/1893854340/reactions"
            },
            "side": "RIGHT",
            "start_line": null,
            "start_side": null,
            "subject_type": "line",
            "updated_at": "2024-12-20T12:09:09Z",
            "url": "https://api.github.com/repos/neovim/neovim/pulls/comments/1893854340",
            "user": {
                "avatar_url": "https://avatars.githubusercontent.com/u/1359421?v=4",
                "events_url": "https://api.github.com/users/justinmk/events{/privacy}",
                "followers_url": "https://api.github.com/users/justinmk/followers",
                "following_url": "https://api.github.com/users/justinmk/following{/other_user}",
                "gists_url": "https://api.github.com/users/justinmk/gists{/gist_id}",
                "gravatar_id": "",
                "html_url": "https://github.com/justinmk",
                "id": 1359421,
                "login": "justinmk",
                "node_id": "MDQ6VXNlcjEzNTk0MjE=",
                "organizations_url": "https://api.github.com/users/justinmk/orgs",
                "received_events_url": "https://api.github.com/users/justinmk/received_events",
                "repos_url": "https://api.github.com/users/justinmk/repos",
                "site_admin": false,
                "starred_url": "https://api.github.com/users/justinmk/starred{/owner}{/repo}",
                "subscriptions_url": "https://api.github.com/users/justinmk/subscriptions",
                "type": "User",
                "url": "https://api.github.com/users/justinmk",
                "user_view_type": "public"
            }
        },
        {
            "_links": {
                "html": {
                    "href": "https://github.com/neovim/neovim/pull/31631#discussion_r1893855406"
                },
                "pull_request": {
                    "href": "https://api.github.com/repos/neovim/neovim/pulls/31631"
                },
                "self": {
                    "href": "https://api.github.com/repos/neovim/neovim/pulls/comments/1893855406"
                }
            },
            "author_association": "MEMBER",
            "body": "Yes, that's what I originally did.",
            "commit_id": "c885db4421200a476440ec14ce231bcf922f7248",
            "created_at": "2024-12-20T12:00:24Z",
            "diff_hunk": "@@ -1479,6 +1482,21 @@ anyway as they will be very frequent. Rather a plugin that does any kind of\n analysis on a tree should use a timer to throttle too frequent updates.\n \n \n+LanguageTree:async_parse({range}, {opts})         *LanguageTree:async_parse()*\n+    Like |LanguageTree:parse()|, but asynchronous.\n+\n+    Parameters: ~\n+       {range}  (`boolean|Range?`) Parse this range in the parser's source.\n+                 Set to `true` to run a complete parse of the source (Note:\n+                 Can be slow!) Set to `false|nil` to only parse regions with\n+                 empty ranges (typically only the root tree without\n+                 injections).\n+       {opts}   (`AsyncParseOpts?`) Options:",
            "html_url": "https://github.com/neovim/neovim/pull/31631#discussion_r1893855406",
            "id": 1893855406,
            "in_reply_to_id": 1893854340,
            "line": null,
            "node_id": "PRRC_kwDOAPphoM5w4fCu",
            "original_commit_id": "5df81d70ae5d3bd4ff9894855dd126261f77f227",
            "original_line": 1494,
            "original_position": 23,
            "original_start_line": null,
            "path": "runtime/doc/treesitter.txt",
            "position": null,
            "pull_request_review_id": 2517407039,
            "pull_request_url": "https://api.github.com/repos/neovim/neovim/pulls/31631",
            "reactions": {
                "+1": 0,
                "-1": 0,
                "confused": 0,
                "eyes": 0,
                "heart": 0,
                "hooray": 0,
                "laugh": 0,
                "rocket": 0,
                "total_count": 0,
                "url": "https://api.github.com/repos/neovim/neovim/pulls/comments/1893855406/reactions"
            },
            "side": "RIGHT",
            "start_line": null,
            "start_side": null,
            "subject_type": "line",
            "updated_at": "2024-12-20T12:00:24Z",
            "url": "https://api.github.com/repos/neovim/neovim/pulls/comments/1893855406",
            "user": {
                "avatar_url": "https://avatars.githubusercontent.com/u/7904185?v=4",
                "events_url": "https://api.github.com/users/lewis6991/events{/privacy}",
                "followers_url": "https://api.github.com/users/lewis6991/followers",
                "following_url": "https://api.github.com/users/lewis6991/following{/other_user}",
                "gists_url": "https://api.github.com/users/lewis6991/gists{/gist_id}",
                "gravatar_id": "",
                "html_url": "https://github.com/lewis6991",
                "id": 7904185,
                "login": "lewis6991",
                "node_id": "MDQ6VXNlcjc5MDQxODU=",
                "organizations_url": "https://api.github.com/users/lewis6991/orgs",
                "received_events_url": "https://api.github.com/users/lewis6991/received_events",
                "repos_url": "https://api.github.com/users/lewis6991/repos",
                "site_admin": false,
                "starred_url": "https://api.github.com/users/lewis6991/starred{/owner}{/repo}",
                "subscriptions_url": "https://api.github.com/users/lewis6991/subscriptions",
                "type": "User",
                "url": "https://api.github.com/users/lewis6991",
                "user_view_type": "public"
            }
        },
        {
            "_links": {
                "html": {
                    "href": "https://github.com/neovim/neovim/pull/31631#discussion_r1893858657"
                },
                "pull_request": {
                    "href": "https://api.github.com/repos/neovim/neovim/pulls/31631"
                },
                "self": {
                    "href": "https://api.github.com/repos/neovim/neovim/pulls/comments/1893858657"
                }
            },
            "author_association": "MEMBER",
            "body": "> This is a bit dangerous because we return `self` right after this\r\n\r\nWhat is the worst case scenario?\r\n\r\nIf we want to make it safe, we could proxy the self methods to force waiting on the parse result. But I guess that could force synchronous behavior in more places than we want? Or throw an error if a self method is called before parse is finished.",
            "commit_id": "c885db4421200a476440ec14ce231bcf922f7248",
            "created_at": "2024-12-20T12:03:53Z",
            "diff_hunk": "@@ -61,7 +61,7 @@ function M._create_parser(bufnr, lang, opts)\n     { on_bytes = bytes_cb, on_detach = detach_cb, on_reload = reload_cb, preview = true }\n   )\n \n-  self:parse()\n+  self:async_parse()",
            "html_url": "https://github.com/neovim/neovim/pull/31631#discussion_r1893858657",
            "id": 1893858657,
            "in_reply_to_id": 1891086046,
            "line": null,
            "node_id": "PRRC_kwDOAPphoM5w4f1h",
            "original_commit_id": "56e5a04f94660c093c40233ac1187827869ebc40",
            "original_line": 64,
            "original_position": 5,
            "original_start_line": null,
            "path": "runtime/lua/vim/treesitter.lua",
            "position": null,
            "pull_request_review_id": 2517414431,
            "pull_request_url": "https://api.github.com/repos/neovim/neovim/pulls/31631",
            "reactions": {
                "+1": 0,
                "-1": 0,
                "confused": 0,
                "eyes": 0,
                "heart": 0,
                "hooray": 0,
                "laugh": 0,
                "rocket": 0,
                "total_count": 0,
                "url": "https://api.github.com/repos/neovim/neovim/pulls/comments/1893858657/reactions"
            },
            "side": "RIGHT",
            "start_line": null,
            "start_side": null,
            "subject_type": "line",
            "updated_at": "2024-12-20T12:03:53Z",
            "url": "https://api.github.com/repos/neovim/neovim/pulls/comments/1893858657",
            "user": {
                "avatar_url": "https://avatars.githubusercontent.com/u/1359421?v=4",
                "events_url": "https://api.github.com/users/justinmk/events{/privacy}",
                "followers_url": "https://api.github.com/users/justinmk/followers",
                "following_url": "https://api.github.com/users/justinmk/following{/other_user}",
                "gists_url": "https://api.github.com/users/justinmk/gists{/gist_id}",
                "gravatar_id": "",
                "html_url": "https://github.com/justinmk",
                "id": 1359421,
                "login": "justinmk",
                "node_id": "MDQ6VXNlcjEzNTk0MjE=",
                "organizations_url": "https://api.github.com/users/justinmk/orgs",
                "received_events_url": "https://api.github.com/users/justinmk/received_events",
                "repos_url": "https://api.github.com/users/justinmk/repos",
                "site_admin": false,
                "starred_url": "https://api.github.com/users/justinmk/starred{/owner}{/repo}",
                "subscriptions_url": "https://api.github.com/users/justinmk/subscriptions",
                "type": "User",
                "url": "https://api.github.com/users/justinmk",
                "user_view_type": "public"
            }
        },
        {
            "_links": {
                "html": {
                    "href": "https://github.com/neovim/neovim/pull/31631#discussion_r1893859656"
                },
                "pull_request": {
                    "href": "https://api.github.com/repos/neovim/neovim/pulls/31631"
                },
                "self": {
                    "href": "https://api.github.com/repos/neovim/neovim/pulls/comments/1893859656"
                }
            },
            "author_association": "MEMBER",
            "body": "```suggestion\r\nlocal default_parse_timeout_ms = 3\r\n```",
            "commit_id": "c885db4421200a476440ec14ce231bcf922f7248",
            "created_at": "2024-12-20T12:05:01Z",
            "diff_hunk": "@@ -44,6 +44,8 @@ local query = require('vim.treesitter.query')\n local language = require('vim.treesitter.language')\n local Range = require('vim.treesitter._range')\n \n+local DEFAULT_PARSE_TIMEOUT_MS = 3",
            "html_url": "https://github.com/neovim/neovim/pull/31631#discussion_r1893859656",
            "id": 1893859656,
            "line": null,
            "node_id": "PRRC_kwDOAPphoM5w4gFI",
            "original_commit_id": "5df81d70ae5d3bd4ff9894855dd126261f77f227",
            "original_line": 47,
            "original_position": 4,
            "original_start_line": null,
            "path": "runtime/lua/vim/treesitter/languagetree.lua",
            "position": null,
            "pull_request_review_id": 2517416124,
            "pull_request_url": "https://api.github.com/repos/neovim/neovim/pulls/31631",
            "reactions": {
                "+1": 1,
                "-1": 0,
                "confused": 1,
                "eyes": 0,
                "heart": 0,
                "hooray": 0,
                "laugh": 0,
                "rocket": 0,
                "total_count": 2,
                "url": "https://api.github.com/repos/neovim/neovim/pulls/comments/1893859656/reactions"
            },
            "side": "RIGHT",
            "start_line": null,
            "start_side": null,
            "subject_type": "line",
            "updated_at": "2024-12-20T12:05:02Z",
            "url": "https://api.github.com/repos/neovim/neovim/pulls/comments/1893859656",
            "user": {
                "avatar_url": "https://avatars.githubusercontent.com/u/1359421?v=4",
                "events_url": "https://api.github.com/users/justinmk/events{/privacy}",
                "followers_url": "https://api.github.com/users/justinmk/followers",
                "following_url": "https://api.github.com/users/justinmk/following{/other_user}",
                "gists_url": "https://api.github.com/users/justinmk/gists{/gist_id}",
                "gravatar_id": "",
                "html_url": "https://github.com/justinmk",
                "id": 1359421,
                "login": "justinmk",
                "node_id": "MDQ6VXNlcjEzNTk0MjE=",
                "organizations_url": "https://api.github.com/users/justinmk/orgs",
                "received_events_url": "https://api.github.com/users/justinmk/received_events",
                "repos_url": "https://api.github.com/users/justinmk/repos",
                "site_admin": false,
                "starred_url": "https://api.github.com/users/justinmk/starred{/owner}{/repo}",
                "subscriptions_url": "https://api.github.com/users/justinmk/subscriptions",
                "type": "User",
                "url": "https://api.github.com/users/justinmk",
                "user_view_type": "public"
            }
        },
        {
            "_links": {
                "html": {
                    "href": "https://github.com/neovim/neovim/pull/31631#discussion_r1893860720"
                },
                "pull_request": {
                    "href": "https://api.github.com/repos/neovim/neovim/pulls/31631"
                },
                "self": {
                    "href": "https://api.github.com/repos/neovim/neovim/pulls/comments/1893860720"
                }
            },
            "author_association": "MEMBER",
            "body": "maybe this is generally useful?\r\n```suggestion\r\nfunction LanguageTree:_buf()\r\n  return vim.b[self._source]\r\n```",
            "commit_id": "c885db4421200a476440ec14ce231bcf922f7248",
            "created_at": "2024-12-20T12:06:22Z",
            "diff_hunk": "@@ -98,6 +105,12 @@ local LanguageTree = {}\n \n LanguageTree.__index = LanguageTree\n \n+--- @return integer\n+function LanguageTree:_changedtick()\n+  --- @type integer\n+  return vim.b[self._source].changedtick",
            "html_url": "https://github.com/neovim/neovim/pull/31631#discussion_r1893860720",
            "id": 1893860720,
            "line": null,
            "node_id": "PRRC_kwDOAPphoM5w4gVw",
            "original_commit_id": "5df81d70ae5d3bd4ff9894855dd126261f77f227",
            "original_line": 111,
            "original_position": 28,
            "original_start_line": 109,
            "path": "runtime/lua/vim/treesitter/languagetree.lua",
            "position": null,
            "pull_request_review_id": 2517418144,
            "pull_request_url": "https://api.github.com/repos/neovim/neovim/pulls/31631",
            "reactions": {
                "+1": 1,
                "-1": 0,
                "confused": 0,
                "eyes": 0,
                "heart": 0,
                "hooray": 0,
                "laugh": 0,
                "rocket": 0,
                "total_count": 1,
                "url": "https://api.github.com/repos/neovim/neovim/pulls/comments/1893860720/reactions"
            },
            "side": "RIGHT",
            "start_line": null,
            "start_side": "RIGHT",
            "subject_type": "line",
            "updated_at": "2024-12-20T12:06:22Z",
            "url": "https://api.github.com/repos/neovim/neovim/pulls/comments/1893860720",
            "user": {
                "avatar_url": "https://avatars.githubusercontent.com/u/1359421?v=4",
                "events_url": "https://api.github.com/users/justinmk/events{/privacy}",
                "followers_url": "https://api.github.com/users/justinmk/followers",
                "following_url": "https://api.github.com/users/justinmk/following{/other_user}",
                "gists_url": "https://api.github.com/users/justinmk/gists{/gist_id}",
                "gravatar_id": "",
                "html_url": "https://github.com/justinmk",
                "id": 1359421,
                "login": "justinmk",
                "node_id": "MDQ6VXNlcjEzNTk0MjE=",
                "organizations_url": "https://api.github.com/users/justinmk/orgs",
                "received_events_url": "https://api.github.com/users/justinmk/received_events",
                "repos_url": "https://api.github.com/users/justinmk/repos",
                "site_admin": false,
                "starred_url": "https://api.github.com/users/justinmk/starred{/owner}{/repo}",
                "subscriptions_url": "https://api.github.com/users/justinmk/subscriptions",
                "type": "User",
                "url": "https://api.github.com/users/justinmk",
                "user_view_type": "public"
            }
        },
        {
            "_links": {
                "html": {
                    "href": "https://github.com/neovim/neovim/pull/31631#discussion_r1894169600"
                },
                "pull_request": {
                    "href": "https://api.github.com/repos/neovim/neovim/pulls/31631"
                },
                "self": {
                    "href": "https://api.github.com/repos/neovim/neovim/pulls/comments/1894169600"
                }
            },
            "author_association": "MEMBER",
            "body": "> What is the worst case scenario?\r\n\r\nWorst case scenario, we call this and then call a function which expects parsing to be complete (e.g. `get_node()`) but it is not yet complete (because it is running async) and now an error is thrown\r\n\r\nI think forcing a wait would not be ideal, that was basically what it was before with the sync parse but it destroyed the perf gains of async stuff because just retrieving the parser (which calls this function) would always run a (potentially slow) synchronous parse\r\n\r\nIn my opinion this should be removed, as it is weird (albeit helpful) side effect. Even the swap for `async_parse` is not ideal. I don't think removing this would be terribly breaking (by which I mean I think the breaking scenarios are pretty specific). Maybe we could massage the breaking effects by calling a synchronous parse inside the `get_node()` function (and other places where we deem it necessary)",
            "commit_id": "c885db4421200a476440ec14ce231bcf922f7248",
            "created_at": "2024-12-20T16:54:58Z",
            "diff_hunk": "@@ -61,7 +61,7 @@ function M._create_parser(bufnr, lang, opts)\n     { on_bytes = bytes_cb, on_detach = detach_cb, on_reload = reload_cb, preview = true }\n   )\n \n-  self:parse()\n+  self:async_parse()",
            "html_url": "https://github.com/neovim/neovim/pull/31631#discussion_r1894169600",
            "id": 1894169600,
            "in_reply_to_id": 1891086046,
            "line": null,
            "node_id": "PRRC_kwDOAPphoM5w5rwA",
            "original_commit_id": "56e5a04f94660c093c40233ac1187827869ebc40",
            "original_line": 64,
            "original_position": 5,
            "original_start_line": null,
            "path": "runtime/lua/vim/treesitter.lua",
            "position": null,
            "pull_request_review_id": 2517956562,
            "pull_request_url": "https://api.github.com/repos/neovim/neovim/pulls/31631",
            "reactions": {
                "+1": 0,
                "-1": 0,
                "confused": 0,
                "eyes": 0,
                "heart": 0,
                "hooray": 0,
                "laugh": 0,
                "rocket": 0,
                "total_count": 0,
                "url": "https://api.github.com/repos/neovim/neovim/pulls/comments/1894169600/reactions"
            },
            "side": "RIGHT",
            "start_line": null,
            "start_side": null,
            "subject_type": "line",
            "updated_at": "2024-12-20T16:54:58Z",
            "url": "https://api.github.com/repos/neovim/neovim/pulls/comments/1894169600",
            "user": {
                "avatar_url": "https://avatars.githubusercontent.com/u/55766287?v=4",
                "events_url": "https://api.github.com/users/ribru17/events{/privacy}",
                "followers_url": "https://api.github.com/users/ribru17/followers",
                "following_url": "https://api.github.com/users/ribru17/following{/other_user}",
                "gists_url": "https://api.github.com/users/ribru17/gists{/gist_id}",
                "gravatar_id": "",
                "html_url": "https://github.com/ribru17",
                "id": 55766287,
                "login": "ribru17",
                "node_id": "MDQ6VXNlcjU1NzY2Mjg3",
                "organizations_url": "https://api.github.com/users/ribru17/orgs",
                "received_events_url": "https://api.github.com/users/ribru17/received_events",
                "repos_url": "https://api.github.com/users/ribru17/repos",
                "site_admin": false,
                "starred_url": "https://api.github.com/users/ribru17/starred{/owner}{/repo}",
                "subscriptions_url": "https://api.github.com/users/ribru17/subscriptions",
                "type": "User",
                "url": "https://api.github.com/users/ribru17",
                "user_view_type": "public"
            }
        },
        {
            "_links": {
                "html": {
                    "href": "https://github.com/neovim/neovim/pull/31631#discussion_r1894183319"
                },
                "pull_request": {
                    "href": "https://api.github.com/repos/neovim/neovim/pulls/31631"
                },
                "self": {
                    "href": "https://api.github.com/repos/neovim/neovim/pulls/comments/1894183319"
                }
            },
            "author_association": "MEMBER",
            "body": "Yeah I am fine to change it back but I did make it two separate functions for a few reasons:\r\n\r\n1. Combining them would have to change the function signature of `parse()` from `Trees` to `Trees?`. This is not that intuitive because a sync parse always returns a list of trees and an async parse always returns `nil`. Things are slightly more confusing now, and returning the `Trees` in the async parse (to prevent function signature change) is out of the question because the trees are not yet parsed and it would be bad to return this to a user that might otherwise think async parsing was completed\r\n2. There are times where one might just want to do something like `:async_parse()` (no arguments). If we combine the functions we will have to pass an empty callback `function() end`. Maybe `{ async = true }` would be acceptable actually...\r\n3. If #19624 is ever completed and we want to change the async version to return a promise (or equivalent), it might be preferable to have two different functions (each with different coloring) so we can know exactly when it is safe to, say, `:await()` the result and when we can just use our returned `trees` immediately. Same issue as 1. I guess",
            "commit_id": "c885db4421200a476440ec14ce231bcf922f7248",
            "created_at": "2024-12-20T17:07:11Z",
            "diff_hunk": "@@ -1479,6 +1482,21 @@ anyway as they will be very frequent. Rather a plugin that does any kind of\n analysis on a tree should use a timer to throttle too frequent updates.\n \n \n+LanguageTree:async_parse({range}, {opts})         *LanguageTree:async_parse()*\n+    Like |LanguageTree:parse()|, but asynchronous.\n+\n+    Parameters: ~\n+       {range}  (`boolean|Range?`) Parse this range in the parser's source.\n+                 Set to `true` to run a complete parse of the source (Note:\n+                 Can be slow!) Set to `false|nil` to only parse regions with\n+                 empty ranges (typically only the root tree without\n+                 injections).\n+       {opts}   (`AsyncParseOpts?`) Options:",
            "html_url": "https://github.com/neovim/neovim/pull/31631#discussion_r1894183319",
            "id": 1894183319,
            "in_reply_to_id": 1893854340,
            "line": null,
            "node_id": "PRRC_kwDOAPphoM5w5vGX",
            "original_commit_id": "5df81d70ae5d3bd4ff9894855dd126261f77f227",
            "original_line": 1494,
            "original_position": 23,
            "original_start_line": null,
            "path": "runtime/doc/treesitter.txt",
            "position": null,
            "pull_request_review_id": 2517979578,
            "pull_request_url": "https://api.github.com/repos/neovim/neovim/pulls/31631",
            "reactions": {
                "+1": 0,
                "-1": 0,
                "confused": 0,
                "eyes": 0,
                "heart": 0,
                "hooray": 0,
                "laugh": 0,
                "rocket": 0,
                "total_count": 0,
                "url": "https://api.github.com/repos/neovim/neovim/pulls/comments/1894183319/reactions"
            },
            "side": "RIGHT",
            "start_line": null,
            "start_side": null,
            "subject_type": "line",
            "updated_at": "2024-12-20T17:07:12Z",
            "url": "https://api.github.com/repos/neovim/neovim/pulls/comments/1894183319",
            "user": {
                "avatar_url": "https://avatars.githubusercontent.com/u/55766287?v=4",
                "events_url": "https://api.github.com/users/ribru17/events{/privacy}",
                "followers_url": "https://api.github.com/users/ribru17/followers",
                "following_url": "https://api.github.com/users/ribru17/following{/other_user}",
                "gists_url": "https://api.github.com/users/ribru17/gists{/gist_id}",
                "gravatar_id": "",
                "html_url": "https://github.com/ribru17",
                "id": 55766287,
                "login": "ribru17",
                "node_id": "MDQ6VXNlcjU1NzY2Mjg3",
                "organizations_url": "https://api.github.com/users/ribru17/orgs",
                "received_events_url": "https://api.github.com/users/ribru17/received_events",
                "repos_url": "https://api.github.com/users/ribru17/repos",
                "site_admin": false,
                "starred_url": "https://api.github.com/users/ribru17/starred{/owner}{/repo}",
                "subscriptions_url": "https://api.github.com/users/ribru17/subscriptions",
                "type": "User",
                "url": "https://api.github.com/users/ribru17",
                "user_view_type": "public"
            }
        },
        {
            "_links": {
                "html": {
                    "href": "https://github.com/neovim/neovim/pull/31631#discussion_r1894239060"
                },
                "pull_request": {
                    "href": "https://api.github.com/repos/neovim/neovim/pulls/31631"
                },
                "self": {
                    "href": "https://api.github.com/repos/neovim/neovim/pulls/comments/1894239060"
                }
            },
            "author_association": "MEMBER",
            "body": "I think (at least for now) we need to distinguish between \"background\" processing -- such as highlighting -- and \"on demand\" processing -- such as textobjects. Async is absolutely necessary for the former but can be deferred for the latter.\r\n\r\nSo I'd focus on highlighting performance and everything else not breaking; we can then make those properly async one by one (where it makes sense). This may require duplicating API for a while (with one being private/experimental).",
            "commit_id": "c885db4421200a476440ec14ce231bcf922f7248",
            "created_at": "2024-12-20T18:06:28Z",
            "diff_hunk": "@@ -61,7 +61,7 @@ function M._create_parser(bufnr, lang, opts)\n     { on_bytes = bytes_cb, on_detach = detach_cb, on_reload = reload_cb, preview = true }\n   )\n \n-  self:parse()\n+  self:async_parse()",
            "html_url": "https://github.com/neovim/neovim/pull/31631#discussion_r1894239060",
            "id": 1894239060,
            "in_reply_to_id": 1891086046,
            "line": null,
            "node_id": "PRRC_kwDOAPphoM5w58tU",
            "original_commit_id": "56e5a04f94660c093c40233ac1187827869ebc40",
            "original_line": 64,
            "original_position": 5,
            "original_start_line": null,
            "path": "runtime/lua/vim/treesitter.lua",
            "position": null,
            "pull_request_review_id": 2518075970,
            "pull_request_url": "https://api.github.com/repos/neovim/neovim/pulls/31631",
            "reactions": {
                "+1": 0,
                "-1": 0,
                "confused": 0,
                "eyes": 0,
                "heart": 0,
                "hooray": 0,
                "laugh": 0,
                "rocket": 0,
                "total_count": 0,
                "url": "https://api.github.com/repos/neovim/neovim/pulls/comments/1894239060/reactions"
            },
            "side": "RIGHT",
            "start_line": null,
            "start_side": null,
            "subject_type": "line",
            "updated_at": "2024-12-20T18:07:15Z",
            "url": "https://api.github.com/repos/neovim/neovim/pulls/comments/1894239060",
            "user": {
                "avatar_url": "https://avatars.githubusercontent.com/u/2361214?v=4",
                "events_url": "https://api.github.com/users/clason/events{/privacy}",
                "followers_url": "https://api.github.com/users/clason/followers",
                "following_url": "https://api.github.com/users/clason/following{/other_user}",
                "gists_url": "https://api.github.com/users/clason/gists{/gist_id}",
                "gravatar_id": "",
                "html_url": "https://github.com/clason",
                "id": 2361214,
                "login": "clason",
                "node_id": "MDQ6VXNlcjIzNjEyMTQ=",
                "organizations_url": "https://api.github.com/users/clason/orgs",
                "received_events_url": "https://api.github.com/users/clason/received_events",
                "repos_url": "https://api.github.com/users/clason/repos",
                "site_admin": false,
                "starred_url": "https://api.github.com/users/clason/starred{/owner}{/repo}",
                "subscriptions_url": "https://api.github.com/users/clason/subscriptions",
                "type": "User",
                "url": "https://api.github.com/users/clason",
                "user_view_type": "public"
            }
        },
        {
            "_links": {
                "html": {
                    "href": "https://github.com/neovim/neovim/pull/31631#discussion_r1894272506"
                },
                "pull_request": {
                    "href": "https://api.github.com/repos/neovim/neovim/pulls/31631"
                },
                "self": {
                    "href": "https://api.github.com/repos/neovim/neovim/pulls/comments/1894272506"
                }
            },
            "author_association": "MEMBER",
            "body": "I agree. In this case the bare minimum to allow async highlighting is this change (in `_create_parser`, either running an async parse or removing that parse step altogether) and then the other one I have in `highlighter.new`",
            "commit_id": "c885db4421200a476440ec14ce231bcf922f7248",
            "created_at": "2024-12-20T18:43:13Z",
            "diff_hunk": "@@ -61,7 +61,7 @@ function M._create_parser(bufnr, lang, opts)\n     { on_bytes = bytes_cb, on_detach = detach_cb, on_reload = reload_cb, preview = true }\n   )\n \n-  self:parse()\n+  self:async_parse()",
            "html_url": "https://github.com/neovim/neovim/pull/31631#discussion_r1894272506",
            "id": 1894272506,
            "in_reply_to_id": 1891086046,
            "line": null,
            "node_id": "PRRC_kwDOAPphoM5w6E36",
            "original_commit_id": "56e5a04f94660c093c40233ac1187827869ebc40",
            "original_line": 64,
            "original_position": 5,
            "original_start_line": null,
            "path": "runtime/lua/vim/treesitter.lua",
            "position": null,
            "pull_request_review_id": 2518132466,
            "pull_request_url": "https://api.github.com/repos/neovim/neovim/pulls/31631",
            "reactions": {
                "+1": 1,
                "-1": 0,
                "confused": 0,
                "eyes": 0,
                "heart": 0,
                "hooray": 0,
                "laugh": 0,
                "rocket": 0,
                "total_count": 1,
                "url": "https://api.github.com/repos/neovim/neovim/pulls/comments/1894272506/reactions"
            },
            "side": "RIGHT",
            "start_line": null,
            "start_side": null,
            "subject_type": "line",
            "updated_at": "2024-12-20T18:43:13Z",
            "url": "https://api.github.com/repos/neovim/neovim/pulls/comments/1894272506",
            "user": {
                "avatar_url": "https://avatars.githubusercontent.com/u/55766287?v=4",
                "events_url": "https://api.github.com/users/ribru17/events{/privacy}",
                "followers_url": "https://api.github.com/users/ribru17/followers",
                "following_url": "https://api.github.com/users/ribru17/following{/other_user}",
                "gists_url": "https://api.github.com/users/ribru17/gists{/gist_id}",
                "gravatar_id": "",
                "html_url": "https://github.com/ribru17",
                "id": 55766287,
                "login": "ribru17",
                "node_id": "MDQ6VXNlcjU1NzY2Mjg3",
                "organizations_url": "https://api.github.com/users/ribru17/orgs",
                "received_events_url": "https://api.github.com/users/ribru17/received_events",
                "repos_url": "https://api.github.com/users/ribru17/repos",
                "site_admin": false,
                "starred_url": "https://api.github.com/users/ribru17/starred{/owner}{/repo}",
                "subscriptions_url": "https://api.github.com/users/ribru17/subscriptions",
                "type": "User",
                "url": "https://api.github.com/users/ribru17",
                "user_view_type": "public"
            }
        },
        {
            "_links": {
                "html": {
                    "href": "https://github.com/neovim/neovim/pull/31631#discussion_r1894523909"
                },
                "pull_request": {
                    "href": "https://api.github.com/repos/neovim/neovim/pulls/31631"
                },
                "self": {
                    "href": "https://api.github.com/repos/neovim/neovim/pulls/comments/1894523909"
                }
            },
            "author_association": "MEMBER",
            "body": "Most of the UV functions combine sync and async into the same signature and it's generally been a well received design. Changing the static signature to return `tree?` isn't a big deal. If no callback is given then it still always returns `tree`. I also don't think passing an empty callback is a big deal either, or passing `{ async = true }` would be fine too.\n\nI'd also consider making the callback a positional parameter at the end instead of an option (as Justin has suggested). UV functions also do this, and will make wrapping functions nicer when we add `vim.async`.",
            "commit_id": "c885db4421200a476440ec14ce231bcf922f7248",
            "created_at": "2024-12-21T01:00:24Z",
            "diff_hunk": "@@ -1479,6 +1482,21 @@ anyway as they will be very frequent. Rather a plugin that does any kind of\n analysis on a tree should use a timer to throttle too frequent updates.\n \n \n+LanguageTree:async_parse({range}, {opts})         *LanguageTree:async_parse()*\n+    Like |LanguageTree:parse()|, but asynchronous.\n+\n+    Parameters: ~\n+       {range}  (`boolean|Range?`) Parse this range in the parser's source.\n+                 Set to `true` to run a complete parse of the source (Note:\n+                 Can be slow!) Set to `false|nil` to only parse regions with\n+                 empty ranges (typically only the root tree without\n+                 injections).\n+       {opts}   (`AsyncParseOpts?`) Options:",
            "html_url": "https://github.com/neovim/neovim/pull/31631#discussion_r1894523909",
            "id": 1894523909,
            "in_reply_to_id": 1893854340,
            "line": null,
            "node_id": "PRRC_kwDOAPphoM5w7CQF",
            "original_commit_id": "5df81d70ae5d3bd4ff9894855dd126261f77f227",
            "original_line": 1494,
            "original_position": 23,
            "original_start_line": null,
            "path": "runtime/doc/treesitter.txt",
            "position": null,
            "pull_request_review_id": 2518539993,
            "pull_request_url": "https://api.github.com/repos/neovim/neovim/pulls/31631",
            "reactions": {
                "+1": 2,
                "-1": 0,
                "confused": 0,
                "eyes": 0,
                "heart": 0,
                "hooray": 0,
                "laugh": 0,
                "rocket": 0,
                "total_count": 2,
                "url": "https://api.github.com/repos/neovim/neovim/pulls/comments/1894523909/reactions"
            },
            "side": "RIGHT",
            "start_line": null,
            "start_side": null,
            "subject_type": "line",
            "updated_at": "2024-12-21T01:03:19Z",
            "url": "https://api.github.com/repos/neovim/neovim/pulls/comments/1894523909",
            "user": {
                "avatar_url": "https://avatars.githubusercontent.com/u/7904185?v=4",
                "events_url": "https://api.github.com/users/lewis6991/events{/privacy}",
                "followers_url": "https://api.github.com/users/lewis6991/followers",
                "following_url": "https://api.github.com/users/lewis6991/following{/other_user}",
                "gists_url": "https://api.github.com/users/lewis6991/gists{/gist_id}",
                "gravatar_id": "",
                "html_url": "https://github.com/lewis6991",
                "id": 7904185,
                "login": "lewis6991",
                "node_id": "MDQ6VXNlcjc5MDQxODU=",
                "organizations_url": "https://api.github.com/users/lewis6991/orgs",
                "received_events_url": "https://api.github.com/users/lewis6991/received_events",
                "repos_url": "https://api.github.com/users/lewis6991/repos",
                "site_admin": false,
                "starred_url": "https://api.github.com/users/lewis6991/starred{/owner}{/repo}",
                "subscriptions_url": "https://api.github.com/users/lewis6991/subscriptions",
                "type": "User",
                "url": "https://api.github.com/users/lewis6991",
                "user_view_type": "public"
            }
        },
        {
            "_links": {
                "html": {
                    "href": "https://github.com/neovim/neovim/pull/31631#discussion_r1894526087"
                },
                "pull_request": {
                    "href": "https://api.github.com/repos/neovim/neovim/pulls/31631"
                },
                "self": {
                    "href": "https://api.github.com/repos/neovim/neovim/pulls/comments/1894526087"
                }
            },
            "author_association": "MEMBER",
            "body": "Ok that sounds perfect, thanks a ton :+1: ",
            "commit_id": "c885db4421200a476440ec14ce231bcf922f7248",
            "created_at": "2024-12-21T01:12:30Z",
            "diff_hunk": "@@ -1479,6 +1482,21 @@ anyway as they will be very frequent. Rather a plugin that does any kind of\n analysis on a tree should use a timer to throttle too frequent updates.\n \n \n+LanguageTree:async_parse({range}, {opts})         *LanguageTree:async_parse()*\n+    Like |LanguageTree:parse()|, but asynchronous.\n+\n+    Parameters: ~\n+       {range}  (`boolean|Range?`) Parse this range in the parser's source.\n+                 Set to `true` to run a complete parse of the source (Note:\n+                 Can be slow!) Set to `false|nil` to only parse regions with\n+                 empty ranges (typically only the root tree without\n+                 injections).\n+       {opts}   (`AsyncParseOpts?`) Options:",
            "html_url": "https://github.com/neovim/neovim/pull/31631#discussion_r1894526087",
            "id": 1894526087,
            "in_reply_to_id": 1893854340,
            "line": null,
            "node_id": "PRRC_kwDOAPphoM5w7CyH",
            "original_commit_id": "5df81d70ae5d3bd4ff9894855dd126261f77f227",
            "original_line": 1494,
            "original_position": 23,
            "original_start_line": null,
            "path": "runtime/doc/treesitter.txt",
            "position": null,
            "pull_request_review_id": 2518543029,
            "pull_request_url": "https://api.github.com/repos/neovim/neovim/pulls/31631",
            "reactions": {
                "+1": 0,
                "-1": 0,
                "confused": 0,
                "eyes": 0,
                "heart": 0,
                "hooray": 0,
                "laugh": 0,
                "rocket": 0,
                "total_count": 0,
                "url": "https://api.github.com/repos/neovim/neovim/pulls/comments/1894526087/reactions"
            },
            "side": "RIGHT",
            "start_line": null,
            "start_side": null,
            "subject_type": "line",
            "updated_at": "2024-12-21T01:12:30Z",
            "url": "https://api.github.com/repos/neovim/neovim/pulls/comments/1894526087",
            "user": {
                "avatar_url": "https://avatars.githubusercontent.com/u/55766287?v=4",
                "events_url": "https://api.github.com/users/ribru17/events{/privacy}",
                "followers_url": "https://api.github.com/users/ribru17/followers",
                "following_url": "https://api.github.com/users/ribru17/following{/other_user}",
                "gists_url": "https://api.github.com/users/ribru17/gists{/gist_id}",
                "gravatar_id": "",
                "html_url": "https://github.com/ribru17",
                "id": 55766287,
                "login": "ribru17",
                "node_id": "MDQ6VXNlcjU1NzY2Mjg3",
                "organizations_url": "https://api.github.com/users/ribru17/orgs",
                "received_events_url": "https://api.github.com/users/ribru17/received_events",
                "repos_url": "https://api.github.com/users/ribru17/repos",
                "site_admin": false,
                "starred_url": "https://api.github.com/users/ribru17/starred{/owner}{/repo}",
                "subscriptions_url": "https://api.github.com/users/ribru17/subscriptions",
                "type": "User",
                "url": "https://api.github.com/users/ribru17",
                "user_view_type": "public"
            }
        },
        {
            "_links": {
                "html": {
                    "href": "https://github.com/neovim/neovim/pull/31631#discussion_r1894626464"
                },
                "pull_request": {
                    "href": "https://api.github.com/repos/neovim/neovim/pulls/31631"
                },
                "self": {
                    "href": "https://api.github.com/repos/neovim/neovim/pulls/comments/1894626464"
                }
            },
            "author_association": "MEMBER",
            "body": "If we need {opts} later it can be an overload  ",
            "commit_id": "c885db4421200a476440ec14ce231bcf922f7248",
            "created_at": "2024-12-21T13:10:34Z",
            "diff_hunk": "@@ -1594,7 +1597,7 @@ LanguageTree:node_for_range({range}, {opts})\n     Return: ~\n         (`TSNode?`)\n \n-LanguageTree:parse({range})                             *LanguageTree:parse()*\n+LanguageTree:parse({range}, {callback})                 *LanguageTree:parse()*",
            "html_url": "https://github.com/neovim/neovim/pull/31631#discussion_r1894626464",
            "id": 1894626464,
            "line": null,
            "node_id": "PRRC_kwDOAPphoM5w7bSg",
            "original_commit_id": "45591027cc852a1c0cf3c2ea0bc416cb64a725af",
            "original_line": 1600,
            "original_position": 15,
            "original_start_line": null,
            "path": "runtime/doc/treesitter.txt",
            "position": null,
            "pull_request_review_id": 2518656859,
            "pull_request_url": "https://api.github.com/repos/neovim/neovim/pulls/31631",
            "reactions": {
                "+1": 1,
                "-1": 0,
                "confused": 0,
                "eyes": 0,
                "heart": 0,
                "hooray": 0,
                "laugh": 0,
                "rocket": 0,
                "total_count": 1,
                "url": "https://api.github.com/repos/neovim/neovim/pulls/comments/1894626464/reactions"
            },
            "side": "RIGHT",
            "start_line": null,
            "start_side": null,
            "subject_type": "line",
            "updated_at": "2024-12-21T13:10:34Z",
            "url": "https://api.github.com/repos/neovim/neovim/pulls/comments/1894626464",
            "user": {
                "avatar_url": "https://avatars.githubusercontent.com/u/1359421?v=4",
                "events_url": "https://api.github.com/users/justinmk/events{/privacy}",
                "followers_url": "https://api.github.com/users/justinmk/followers",
                "following_url": "https://api.github.com/users/justinmk/following{/other_user}",
                "gists_url": "https://api.github.com/users/justinmk/gists{/gist_id}",
                "gravatar_id": "",
                "html_url": "https://github.com/justinmk",
                "id": 1359421,
                "login": "justinmk",
                "node_id": "MDQ6VXNlcjEzNTk0MjE=",
                "organizations_url": "https://api.github.com/users/justinmk/orgs",
                "received_events_url": "https://api.github.com/users/justinmk/received_events",
                "repos_url": "https://api.github.com/users/justinmk/repos",
                "site_admin": false,
                "starred_url": "https://api.github.com/users/justinmk/starred{/owner}{/repo}",
                "subscriptions_url": "https://api.github.com/users/justinmk/subscriptions",
                "type": "User",
                "url": "https://api.github.com/users/justinmk",
                "user_view_type": "public"
            }
        },
        {
            "_links": {
                "html": {
                    "href": "https://github.com/neovim/neovim/pull/31631#discussion_r1894626691"
                },
                "pull_request": {
                    "href": "https://api.github.com/repos/neovim/neovim/pulls/31631"
                },
                "self": {
                    "href": "https://api.github.com/repos/neovim/neovim/pulls/comments/1894626691"
                }
            },
            "author_association": "MEMBER",
            "body": "Use `on_` prefix for callbacks. I'm being a bit dogmatic about this because people copy existing things, so every case matters.\r\n\r\n```suggestion\r\n       {on_parse}  (`fun(trees: Trees)?`) Function invoked when parsing\r\n```",
            "commit_id": "c885db4421200a476440ec14ce231bcf922f7248",
            "created_at": "2024-12-21T13:12:21Z",
            "diff_hunk": "@@ -1605,14 +1608,16 @@ LanguageTree:parse({range})                             *LanguageTree:parse()*\n     if {range} is `true`).\n \n     Parameters: ~\n-       {range}  (`boolean|Range?`) Parse this range in the parser's source.\n-                 Set to `true` to run a complete parse of the source (Note:\n-                 Can be slow!) Set to `false|nil` to only parse regions with\n-                 empty ranges (typically only the root tree without\n-                 injections).\n+       {range}     (`boolean|Range?`) Parse this range in the parser's\n+                    source. Set to `true` to run a complete parse of the\n+                    source (Note: Can be slow!) Set to `false|nil` to only\n+                    parse regions with empty ranges (typically only the root\n+                    tree without injections).\n+       {callback}  (`fun(trees: Trees)?`) A callback to be run when parsing",
            "html_url": "https://github.com/neovim/neovim/pull/31631#discussion_r1894626691",
            "id": 1894626691,
            "line": null,
            "node_id": "PRRC_kwDOAPphoM5w7bWD",
            "original_commit_id": "45591027cc852a1c0cf3c2ea0bc416cb64a725af",
            "original_line": 1616,
            "original_position": 33,
            "original_start_line": null,
            "path": "runtime/doc/treesitter.txt",
            "position": null,
            "pull_request_review_id": 2518657094,
            "pull_request_url": "https://api.github.com/repos/neovim/neovim/pulls/31631",
            "reactions": {
                "+1": 1,
                "-1": 0,
                "confused": 0,
                "eyes": 0,
                "heart": 0,
                "hooray": 0,
                "laugh": 0,
                "rocket": 0,
                "total_count": 1,
                "url": "https://api.github.com/repos/neovim/neovim/pulls/comments/1894626691/reactions"
            },
            "side": "RIGHT",
            "start_line": null,
            "start_side": null,
            "subject_type": "line",
            "updated_at": "2024-12-21T13:13:16Z",
            "url": "https://api.github.com/repos/neovim/neovim/pulls/comments/1894626691",
            "user": {
                "avatar_url": "https://avatars.githubusercontent.com/u/1359421?v=4",
                "events_url": "https://api.github.com/users/justinmk/events{/privacy}",
                "followers_url": "https://api.github.com/users/justinmk/followers",
                "following_url": "https://api.github.com/users/justinmk/following{/other_user}",
                "gists_url": "https://api.github.com/users/justinmk/gists{/gist_id}",
                "gravatar_id": "",
                "html_url": "https://github.com/justinmk",
                "id": 1359421,
                "login": "justinmk",
                "node_id": "MDQ6VXNlcjEzNTk0MjE=",
                "organizations_url": "https://api.github.com/users/justinmk/orgs",
                "received_events_url": "https://api.github.com/users/justinmk/received_events",
                "repos_url": "https://api.github.com/users/justinmk/repos",
                "site_admin": false,
                "starred_url": "https://api.github.com/users/justinmk/starred{/owner}{/repo}",
                "subscriptions_url": "https://api.github.com/users/justinmk/subscriptions",
                "type": "User",
                "url": "https://api.github.com/users/justinmk",
                "user_view_type": "public"
            }
        },
        {
            "_links": {
                "html": {
                    "href": "https://github.com/neovim/neovim/pull/31631#discussion_r1894627380"
                },
                "pull_request": {
                    "href": "https://api.github.com/repos/neovim/neovim/pulls/31631"
                },
                "self": {
                    "href": "https://api.github.com/repos/neovim/neovim/pulls/comments/1894627380"
                }
            },
            "author_association": "MEMBER",
            "body": "This is a good thread to leave un-resolved, so it can be found in the future.",
            "commit_id": "c885db4421200a476440ec14ce231bcf922f7248",
            "created_at": "2024-12-21T13:16:31Z",
            "diff_hunk": "@@ -61,7 +61,7 @@ function M._create_parser(bufnr, lang, opts)\n     { on_bytes = bytes_cb, on_detach = detach_cb, on_reload = reload_cb, preview = true }\n   )\n \n-  self:parse()\n+  self:async_parse()",
            "html_url": "https://github.com/neovim/neovim/pull/31631#discussion_r1894627380",
            "id": 1894627380,
            "in_reply_to_id": 1891086046,
            "line": null,
            "node_id": "PRRC_kwDOAPphoM5w7bg0",
            "original_commit_id": "56e5a04f94660c093c40233ac1187827869ebc40",
            "original_line": 64,
            "original_position": 5,
            "original_start_line": null,
            "path": "runtime/lua/vim/treesitter.lua",
            "position": null,
            "pull_request_review_id": 2518658063,
            "pull_request_url": "https://api.github.com/repos/neovim/neovim/pulls/31631",
            "reactions": {
                "+1": 1,
                "-1": 0,
                "confused": 0,
                "eyes": 0,
                "heart": 0,
                "hooray": 0,
                "laugh": 0,
                "rocket": 0,
                "total_count": 1,
                "url": "https://api.github.com/repos/neovim/neovim/pulls/comments/1894627380/reactions"
            },
            "side": "RIGHT",
            "start_line": null,
            "start_side": null,
            "subject_type": "line",
            "updated_at": "2024-12-21T13:16:52Z",
            "url": "https://api.github.com/repos/neovim/neovim/pulls/comments/1894627380",
            "user": {
                "avatar_url": "https://avatars.githubusercontent.com/u/1359421?v=4",
                "events_url": "https://api.github.com/users/justinmk/events{/privacy}",
                "followers_url": "https://api.github.com/users/justinmk/followers",
                "following_url": "https://api.github.com/users/justinmk/following{/other_user}",
                "gists_url": "https://api.github.com/users/justinmk/gists{/gist_id}",
                "gravatar_id": "",
                "html_url": "https://github.com/justinmk",
                "id": 1359421,
                "login": "justinmk",
                "node_id": "MDQ6VXNlcjEzNTk0MjE=",
                "organizations_url": "https://api.github.com/users/justinmk/orgs",
                "received_events_url": "https://api.github.com/users/justinmk/received_events",
                "repos_url": "https://api.github.com/users/justinmk/repos",
                "site_admin": false,
                "starred_url": "https://api.github.com/users/justinmk/starred{/owner}{/repo}",
                "subscriptions_url": "https://api.github.com/users/justinmk/subscriptions",
                "type": "User",
                "url": "https://api.github.com/users/justinmk",
                "user_view_type": "public"
            }
        },
        {
            "_links": {
                "html": {
                    "href": "https://github.com/neovim/neovim/pull/31631#discussion_r1894652410"
                },
                "pull_request": {
                    "href": "https://api.github.com/repos/neovim/neovim/pulls/31631"
                },
                "self": {
                    "href": "https://api.github.com/repos/neovim/neovim/pulls/comments/1894652410"
                }
            },
            "author_association": "MEMBER",
            "body": "This should be called outside of the loop as the final statement. Also we need to make sure this isn't called in the coroutine so should probably wrap with vim.schedule.",
            "commit_id": "c885db4421200a476440ec14ce231bcf922f7248",
            "created_at": "2024-12-21T16:15:03Z",
            "diff_hunk": "@@ -409,6 +428,46 @@ function LanguageTree:_add_injections()\n   return query_time\n end\n \n+--- Run an asynchronous parse, calling {on_parse} when complete.\n+---\n+--- @param range boolean|Range|nil\n+--- @param on_parse fun(trees: TSTrees)\n+function LanguageTree:_async_parse(range, on_parse)\n+  coroutine.resume(\n+    --- @param co_range boolean|Range|nil\n+    --- @param co_cb fun(trees: TSTrees)\n+    coroutine.create(function(co_range, co_cb)\n+      local co = coroutine.running()\n+      local ct = self:_buf().changedtick\n+      local unfinished = true\n+      --- @type TSTrees\n+      local trees\n+\n+      while unfinished do\n+        -- If buffer was changed in the middle of parsing, reset parse state\n+        if self:_buf().changedtick ~= ct then\n+          self._parser:reset()\n+          self:invalidate()\n+          coroutine.yield()\n+        end\n+\n+        trees, unfinished = self:_parse(co_range, default_parse_timeout_ms)\n+\n+        if unfinished then\n+          vim.schedule(function()\n+            coroutine.resume(co)\n+          end)\n+          coroutine.yield()\n+        else\n+          co_cb(trees)",
            "html_url": "https://github.com/neovim/neovim/pull/31631#discussion_r1894652410",
            "id": 1894652410,
            "line": null,
            "node_id": "PRRC_kwDOAPphoM5w7hn6",
            "original_commit_id": "733dddd6cf742fc06d8e369f78f665c170fa1eef",
            "original_line": 462,
            "original_position": 124,
            "original_start_line": null,
            "path": "runtime/lua/vim/treesitter/languagetree.lua",
            "position": null,
            "pull_request_review_id": 2518684265,
            "pull_request_url": "https://api.github.com/repos/neovim/neovim/pulls/31631",
            "reactions": {
                "+1": 0,
                "-1": 0,
                "confused": 0,
                "eyes": 0,
                "heart": 0,
                "hooray": 0,
                "laugh": 0,
                "rocket": 0,
                "total_count": 0,
                "url": "https://api.github.com/repos/neovim/neovim/pulls/comments/1894652410/reactions"
            },
            "side": "RIGHT",
            "start_line": null,
            "start_side": null,
            "subject_type": "line",
            "updated_at": "2024-12-21T16:21:46Z",
            "url": "https://api.github.com/repos/neovim/neovim/pulls/comments/1894652410",
            "user": {
                "avatar_url": "https://avatars.githubusercontent.com/u/7904185?v=4",
                "events_url": "https://api.github.com/users/lewis6991/events{/privacy}",
                "followers_url": "https://api.github.com/users/lewis6991/followers",
                "following_url": "https://api.github.com/users/lewis6991/following{/other_user}",
                "gists_url": "https://api.github.com/users/lewis6991/gists{/gist_id}",
                "gravatar_id": "",
                "html_url": "https://github.com/lewis6991",
                "id": 7904185,
                "login": "lewis6991",
                "node_id": "MDQ6VXNlcjc5MDQxODU=",
                "organizations_url": "https://api.github.com/users/lewis6991/orgs",
                "received_events_url": "https://api.github.com/users/lewis6991/received_events",
                "repos_url": "https://api.github.com/users/lewis6991/repos",
                "site_admin": false,
                "starred_url": "https://api.github.com/users/lewis6991/starred{/owner}{/repo}",
                "subscriptions_url": "https://api.github.com/users/lewis6991/subscriptions",
                "type": "User",
                "url": "https://api.github.com/users/lewis6991",
                "user_view_type": "public"
            }
        },
        {
            "_links": {
                "html": {
                    "href": "https://github.com/neovim/neovim/pull/31631#discussion_r1894652456"
                },
                "pull_request": {
                    "href": "https://api.github.com/repos/neovim/neovim/pulls/31631"
                },
                "self": {
                    "href": "https://api.github.com/repos/neovim/neovim/pulls/comments/1894652456"
                }
            },
            "author_association": "MEMBER",
            "body": "Would it be simpler to remove this and just break from the loop when it's finished?",
            "commit_id": "c885db4421200a476440ec14ce231bcf922f7248",
            "created_at": "2024-12-21T16:15:37Z",
            "diff_hunk": "@@ -409,6 +428,46 @@ function LanguageTree:_add_injections()\n   return query_time\n end\n \n+--- Run an asynchronous parse, calling {on_parse} when complete.\n+---\n+--- @param range boolean|Range|nil\n+--- @param on_parse fun(trees: TSTrees)\n+function LanguageTree:_async_parse(range, on_parse)\n+  coroutine.resume(\n+    --- @param co_range boolean|Range|nil\n+    --- @param co_cb fun(trees: TSTrees)\n+    coroutine.create(function(co_range, co_cb)\n+      local co = coroutine.running()\n+      local ct = self:_buf().changedtick\n+      local unfinished = true",
            "html_url": "https://github.com/neovim/neovim/pull/31631#discussion_r1894652456",
            "id": 1894652456,
            "line": null,
            "node_id": "PRRC_kwDOAPphoM5w7hoo",
            "original_commit_id": "733dddd6cf742fc06d8e369f78f665c170fa1eef",
            "original_line": 442,
            "original_position": 104,
            "original_start_line": null,
            "path": "runtime/lua/vim/treesitter/languagetree.lua",
            "position": null,
            "pull_request_review_id": 2518684265,
            "pull_request_url": "https://api.github.com/repos/neovim/neovim/pulls/31631",
            "reactions": {
                "+1": 1,
                "-1": 0,
                "confused": 0,
                "eyes": 0,
                "heart": 0,
                "hooray": 0,
                "laugh": 0,
                "rocket": 0,
                "total_count": 1,
                "url": "https://api.github.com/repos/neovim/neovim/pulls/comments/1894652456/reactions"
            },
            "side": "RIGHT",
            "start_line": null,
            "start_side": null,
            "subject_type": "line",
            "updated_at": "2024-12-21T16:22:08Z",
            "url": "https://api.github.com/repos/neovim/neovim/pulls/comments/1894652456",
            "user": {
                "avatar_url": "https://avatars.githubusercontent.com/u/7904185?v=4",
                "events_url": "https://api.github.com/users/lewis6991/events{/privacy}",
                "followers_url": "https://api.github.com/users/lewis6991/followers",
                "following_url": "https://api.github.com/users/lewis6991/following{/other_user}",
                "gists_url": "https://api.github.com/users/lewis6991/gists{/gist_id}",
                "gravatar_id": "",
                "html_url": "https://github.com/lewis6991",
                "id": 7904185,
                "login": "lewis6991",
                "node_id": "MDQ6VXNlcjc5MDQxODU=",
                "organizations_url": "https://api.github.com/users/lewis6991/orgs",
                "received_events_url": "https://api.github.com/users/lewis6991/received_events",
                "repos_url": "https://api.github.com/users/lewis6991/repos",
                "site_admin": false,
                "starred_url": "https://api.github.com/users/lewis6991/starred{/owner}{/repo}",
                "subscriptions_url": "https://api.github.com/users/lewis6991/subscriptions",
                "type": "User",
                "url": "https://api.github.com/users/lewis6991",
                "user_view_type": "public"
            }
        },
        {
            "_links": {
                "html": {
                    "href": "https://github.com/neovim/neovim/pull/31631#discussion_r1894652582"
                },
                "pull_request": {
                    "href": "https://api.github.com/repos/neovim/neovim/pulls/31631"
                },
                "self": {
                    "href": "https://api.github.com/repos/neovim/neovim/pulls/comments/1894652582"
                }
            },
            "author_association": "MEMBER",
            "body": "We should add some loop protection to avoid cases that hang or take too long to parse. For now we can just have a hard coded timeout which we may expose as an option in the future.",
            "commit_id": "c885db4421200a476440ec14ce231bcf922f7248",
            "created_at": "2024-12-21T16:16:41Z",
            "diff_hunk": "@@ -409,6 +428,46 @@ function LanguageTree:_add_injections()\n   return query_time\n end\n \n+--- Run an asynchronous parse, calling {on_parse} when complete.\n+---\n+--- @param range boolean|Range|nil\n+--- @param on_parse fun(trees: TSTrees)\n+function LanguageTree:_async_parse(range, on_parse)\n+  coroutine.resume(\n+    --- @param co_range boolean|Range|nil\n+    --- @param co_cb fun(trees: TSTrees)\n+    coroutine.create(function(co_range, co_cb)\n+      local co = coroutine.running()\n+      local ct = self:_buf().changedtick\n+      local unfinished = true\n+      --- @type TSTrees\n+      local trees\n+\n+      while unfinished do",
            "html_url": "https://github.com/neovim/neovim/pull/31631#discussion_r1894652582",
            "id": 1894652582,
            "line": null,
            "node_id": "PRRC_kwDOAPphoM5w7hqm",
            "original_commit_id": "733dddd6cf742fc06d8e369f78f665c170fa1eef",
            "original_line": 446,
            "original_position": 108,
            "original_start_line": null,
            "path": "runtime/lua/vim/treesitter/languagetree.lua",
            "position": null,
            "pull_request_review_id": 2518684265,
            "pull_request_url": "https://api.github.com/repos/neovim/neovim/pulls/31631",
            "reactions": {
                "+1": 2,
                "-1": 0,
                "confused": 0,
                "eyes": 0,
                "heart": 0,
                "hooray": 0,
                "laugh": 0,
                "rocket": 0,
                "total_count": 2,
                "url": "https://api.github.com/repos/neovim/neovim/pulls/comments/1894652582/reactions"
            },
            "side": "RIGHT",
            "start_line": null,
            "start_side": null,
            "subject_type": "line",
            "updated_at": "2024-12-21T16:22:27Z",
            "url": "https://api.github.com/repos/neovim/neovim/pulls/comments/1894652582",
            "user": {
                "avatar_url": "https://avatars.githubusercontent.com/u/7904185?v=4",
                "events_url": "https://api.github.com/users/lewis6991/events{/privacy}",
                "followers_url": "https://api.github.com/users/lewis6991/followers",
                "following_url": "https://api.github.com/users/lewis6991/following{/other_user}",
                "gists_url": "https://api.github.com/users/lewis6991/gists{/gist_id}",
                "gravatar_id": "",
                "html_url": "https://github.com/lewis6991",
                "id": 7904185,
                "login": "lewis6991",
                "node_id": "MDQ6VXNlcjc5MDQxODU=",
                "organizations_url": "https://api.github.com/users/lewis6991/orgs",
                "received_events_url": "https://api.github.com/users/lewis6991/received_events",
                "repos_url": "https://api.github.com/users/lewis6991/repos",
                "site_admin": false,
                "starred_url": "https://api.github.com/users/lewis6991/starred{/owner}{/repo}",
                "subscriptions_url": "https://api.github.com/users/lewis6991/subscriptions",
                "type": "User",
                "url": "https://api.github.com/users/lewis6991",
                "user_view_type": "public"
            }
        },
        {
            "_links": {
                "html": {
                    "href": "https://github.com/neovim/neovim/pull/31631#discussion_r1894652716"
                },
                "pull_request": {
                    "href": "https://api.github.com/repos/neovim/neovim/pulls/31631"
                },
                "self": {
                    "href": "https://api.github.com/repos/neovim/neovim/pulls/comments/1894652716"
                }
            },
            "author_association": "MEMBER",
            "body": "Since this coroutine is a closure, wouldn't it be better to not pass these in and use upvalues?",
            "commit_id": "c885db4421200a476440ec14ce231bcf922f7248",
            "created_at": "2024-12-21T16:17:34Z",
            "diff_hunk": "@@ -409,6 +428,46 @@ function LanguageTree:_add_injections()\n   return query_time\n end\n \n+--- Run an asynchronous parse, calling {on_parse} when complete.\n+---\n+--- @param range boolean|Range|nil\n+--- @param on_parse fun(trees: TSTrees)\n+function LanguageTree:_async_parse(range, on_parse)\n+  coroutine.resume(\n+    --- @param co_range boolean|Range|nil\n+    --- @param co_cb fun(trees: TSTrees)\n+    coroutine.create(function(co_range, co_cb)\n+      local co = coroutine.running()\n+      local ct = self:_buf().changedtick\n+      local unfinished = true\n+      --- @type TSTrees\n+      local trees\n+\n+      while unfinished do\n+        -- If buffer was changed in the middle of parsing, reset parse state\n+        if self:_buf().changedtick ~= ct then\n+          self._parser:reset()\n+          self:invalidate()\n+          coroutine.yield()\n+        end\n+\n+        trees, unfinished = self:_parse(co_range, default_parse_timeout_ms)\n+\n+        if unfinished then\n+          vim.schedule(function()\n+            coroutine.resume(co)\n+          end)\n+          coroutine.yield()\n+        else\n+          co_cb(trees)\n+        end\n+      end\n+    end),\n+    range,",
            "html_url": "https://github.com/neovim/neovim/pull/31631#discussion_r1894652716",
            "id": 1894652716,
            "line": null,
            "node_id": "PRRC_kwDOAPphoM5w7hss",
            "original_commit_id": "733dddd6cf742fc06d8e369f78f665c170fa1eef",
            "original_line": 466,
            "original_position": 128,
            "original_start_line": null,
            "path": "runtime/lua/vim/treesitter/languagetree.lua",
            "position": null,
            "pull_request_review_id": 2518684265,
            "pull_request_url": "https://api.github.com/repos/neovim/neovim/pulls/31631",
            "reactions": {
                "+1": 1,
                "-1": 0,
                "confused": 0,
                "eyes": 0,
                "heart": 0,
                "hooray": 0,
                "laugh": 0,
                "rocket": 0,
                "total_count": 1,
                "url": "https://api.github.com/repos/neovim/neovim/pulls/comments/1894652716/reactions"
            },
            "side": "RIGHT",
            "start_line": null,
            "start_side": null,
            "subject_type": "line",
            "updated_at": "2024-12-21T16:21:46Z",
            "url": "https://api.github.com/repos/neovim/neovim/pulls/comments/1894652716",
            "user": {
                "avatar_url": "https://avatars.githubusercontent.com/u/7904185?v=4",
                "events_url": "https://api.github.com/users/lewis6991/events{/privacy}",
                "followers_url": "https://api.github.com/users/lewis6991/followers",
                "following_url": "https://api.github.com/users/lewis6991/following{/other_user}",
                "gists_url": "https://api.github.com/users/lewis6991/gists{/gist_id}",
                "gravatar_id": "",
                "html_url": "https://github.com/lewis6991",
                "id": 7904185,
                "login": "lewis6991",
                "node_id": "MDQ6VXNlcjc5MDQxODU=",
                "organizations_url": "https://api.github.com/users/lewis6991/orgs",
                "received_events_url": "https://api.github.com/users/lewis6991/received_events",
                "repos_url": "https://api.github.com/users/lewis6991/repos",
                "site_admin": false,
                "starred_url": "https://api.github.com/users/lewis6991/starred{/owner}{/repo}",
                "subscriptions_url": "https://api.github.com/users/lewis6991/subscriptions",
                "type": "User",
                "url": "https://api.github.com/users/lewis6991",
                "user_view_type": "public"
            }
        },
        {
            "_links": {
                "html": {
                    "href": "https://github.com/neovim/neovim/pull/31631#discussion_r1894652869"
                },
                "pull_request": {
                    "href": "https://api.github.com/repos/neovim/neovim/pulls/31631"
                },
                "self": {
                    "href": "https://api.github.com/repos/neovim/neovim/pulls/comments/1894652869"
                }
            },
            "author_association": "MEMBER",
            "body": "Would coroutine.wrap be applicable here?",
            "commit_id": "c885db4421200a476440ec14ce231bcf922f7248",
            "created_at": "2024-12-21T16:18:31Z",
            "diff_hunk": "@@ -409,6 +428,46 @@ function LanguageTree:_add_injections()\n   return query_time\n end\n \n+--- Run an asynchronous parse, calling {on_parse} when complete.\n+---\n+--- @param range boolean|Range|nil\n+--- @param on_parse fun(trees: TSTrees)\n+function LanguageTree:_async_parse(range, on_parse)\n+  coroutine.resume(\n+    --- @param co_range boolean|Range|nil\n+    --- @param co_cb fun(trees: TSTrees)\n+    coroutine.create(function(co_range, co_cb)",
            "html_url": "https://github.com/neovim/neovim/pull/31631#discussion_r1894652869",
            "id": 1894652869,
            "line": null,
            "node_id": "PRRC_kwDOAPphoM5w7hvF",
            "original_commit_id": "733dddd6cf742fc06d8e369f78f665c170fa1eef",
            "original_line": 439,
            "original_position": 101,
            "original_start_line": null,
            "path": "runtime/lua/vim/treesitter/languagetree.lua",
            "position": null,
            "pull_request_review_id": 2518684265,
            "pull_request_url": "https://api.github.com/repos/neovim/neovim/pulls/31631",
            "reactions": {
                "+1": 0,
                "-1": 0,
                "confused": 0,
                "eyes": 0,
                "heart": 0,
                "hooray": 0,
                "laugh": 0,
                "rocket": 0,
                "total_count": 0,
                "url": "https://api.github.com/repos/neovim/neovim/pulls/comments/1894652869/reactions"
            },
            "side": "RIGHT",
            "start_line": null,
            "start_side": null,
            "subject_type": "line",
            "updated_at": "2024-12-21T16:21:46Z",
            "url": "https://api.github.com/repos/neovim/neovim/pulls/comments/1894652869",
            "user": {
                "avatar_url": "https://avatars.githubusercontent.com/u/7904185?v=4",
                "events_url": "https://api.github.com/users/lewis6991/events{/privacy}",
                "followers_url": "https://api.github.com/users/lewis6991/followers",
                "following_url": "https://api.github.com/users/lewis6991/following{/other_user}",
                "gists_url": "https://api.github.com/users/lewis6991/gists{/gist_id}",
                "gravatar_id": "",
                "html_url": "https://github.com/lewis6991",
                "id": 7904185,
                "login": "lewis6991",
                "node_id": "MDQ6VXNlcjc5MDQxODU=",
                "organizations_url": "https://api.github.com/users/lewis6991/orgs",
                "received_events_url": "https://api.github.com/users/lewis6991/received_events",
                "repos_url": "https://api.github.com/users/lewis6991/repos",
                "site_admin": false,
                "starred_url": "https://api.github.com/users/lewis6991/starred{/owner}{/repo}",
                "subscriptions_url": "https://api.github.com/users/lewis6991/subscriptions",
                "type": "User",
                "url": "https://api.github.com/users/lewis6991",
                "user_view_type": "public"
            }
        },
        {
            "_links": {
                "html": {
                    "href": "https://github.com/neovim/neovim/pull/31631#discussion_r1894654592"
                },
                "pull_request": {
                    "href": "https://api.github.com/repos/neovim/neovim/pulls/31631"
                },
                "self": {
                    "href": "https://api.github.com/repos/neovim/neovim/pulls/comments/1894654592"
                }
            },
            "author_association": "MEMBER",
            "body": "could we use ['redrawtime'](https://github.com/neovim/neovim/pull/22420#issuecomment-1446362921) for that?",
            "commit_id": "c885db4421200a476440ec14ce231bcf922f7248",
            "created_at": "2024-12-21T16:32:42Z",
            "diff_hunk": "@@ -409,6 +428,46 @@ function LanguageTree:_add_injections()\n   return query_time\n end\n \n+--- Run an asynchronous parse, calling {on_parse} when complete.\n+---\n+--- @param range boolean|Range|nil\n+--- @param on_parse fun(trees: TSTrees)\n+function LanguageTree:_async_parse(range, on_parse)\n+  coroutine.resume(\n+    --- @param co_range boolean|Range|nil\n+    --- @param co_cb fun(trees: TSTrees)\n+    coroutine.create(function(co_range, co_cb)\n+      local co = coroutine.running()\n+      local ct = self:_buf().changedtick\n+      local unfinished = true\n+      --- @type TSTrees\n+      local trees\n+\n+      while unfinished do",
            "html_url": "https://github.com/neovim/neovim/pull/31631#discussion_r1894654592",
            "id": 1894654592,
            "in_reply_to_id": 1894652582,
            "line": null,
            "node_id": "PRRC_kwDOAPphoM5w7iKA",
            "original_commit_id": "733dddd6cf742fc06d8e369f78f665c170fa1eef",
            "original_line": 446,
            "original_position": 108,
            "original_start_line": null,
            "path": "runtime/lua/vim/treesitter/languagetree.lua",
            "position": null,
            "pull_request_review_id": 2518686498,
            "pull_request_url": "https://api.github.com/repos/neovim/neovim/pulls/31631",
            "reactions": {
                "+1": 2,
                "-1": 0,
                "confused": 0,
                "eyes": 0,
                "heart": 0,
                "hooray": 0,
                "laugh": 0,
                "rocket": 0,
                "total_count": 2,
                "url": "https://api.github.com/repos/neovim/neovim/pulls/comments/1894654592/reactions"
            },
            "side": "RIGHT",
            "start_line": null,
            "start_side": null,
            "subject_type": "line",
            "updated_at": "2024-12-21T16:33:00Z",
            "url": "https://api.github.com/repos/neovim/neovim/pulls/comments/1894654592",
            "user": {
                "avatar_url": "https://avatars.githubusercontent.com/u/1359421?v=4",
                "events_url": "https://api.github.com/users/justinmk/events{/privacy}",
                "followers_url": "https://api.github.com/users/justinmk/followers",
                "following_url": "https://api.github.com/users/justinmk/following{/other_user}",
                "gists_url": "https://api.github.com/users/justinmk/gists{/gist_id}",
                "gravatar_id": "",
                "html_url": "https://github.com/justinmk",
                "id": 1359421,
                "login": "justinmk",
                "node_id": "MDQ6VXNlcjEzNTk0MjE=",
                "organizations_url": "https://api.github.com/users/justinmk/orgs",
                "received_events_url": "https://api.github.com/users/justinmk/received_events",
                "repos_url": "https://api.github.com/users/justinmk/repos",
                "site_admin": false,
                "starred_url": "https://api.github.com/users/justinmk/starred{/owner}{/repo}",
                "subscriptions_url": "https://api.github.com/users/justinmk/subscriptions",
                "type": "User",
                "url": "https://api.github.com/users/justinmk",
                "user_view_type": "public"
            }
        },
        {
            "_links": {
                "html": {
                    "href": "https://github.com/neovim/neovim/pull/31631#discussion_r1894654870"
                },
                "pull_request": {
                    "href": "https://api.github.com/repos/neovim/neovim/pulls/31631"
                },
                "self": {
                    "href": "https://api.github.com/repos/neovim/neovim/pulls/comments/1894654870"
                }
            },
            "author_association": "MEMBER",
            "body": "~~No, I'd say this is different.~~ `redrawtime` is a timeout (\"stop doing anything after x ms\"), while this is chunking (\"don't block for more than x ms\"). In particular, if we get things right, I don't expect anybody (reasonable) to have to adjust this. (And a global value might not even make sense.)",
            "commit_id": "c885db4421200a476440ec14ce231bcf922f7248",
            "created_at": "2024-12-21T16:35:09Z",
            "diff_hunk": "@@ -409,6 +428,46 @@ function LanguageTree:_add_injections()\n   return query_time\n end\n \n+--- Run an asynchronous parse, calling {on_parse} when complete.\n+---\n+--- @param range boolean|Range|nil\n+--- @param on_parse fun(trees: TSTrees)\n+function LanguageTree:_async_parse(range, on_parse)\n+  coroutine.resume(\n+    --- @param co_range boolean|Range|nil\n+    --- @param co_cb fun(trees: TSTrees)\n+    coroutine.create(function(co_range, co_cb)\n+      local co = coroutine.running()\n+      local ct = self:_buf().changedtick\n+      local unfinished = true\n+      --- @type TSTrees\n+      local trees\n+\n+      while unfinished do",
            "html_url": "https://github.com/neovim/neovim/pull/31631#discussion_r1894654870",
            "id": 1894654870,
            "in_reply_to_id": 1894652582,
            "line": null,
            "node_id": "PRRC_kwDOAPphoM5w7iOW",
            "original_commit_id": "733dddd6cf742fc06d8e369f78f665c170fa1eef",
            "original_line": 446,
            "original_position": 108,
            "original_start_line": null,
            "path": "runtime/lua/vim/treesitter/languagetree.lua",
            "position": null,
            "pull_request_review_id": 2518686826,
            "pull_request_url": "https://api.github.com/repos/neovim/neovim/pulls/31631",
            "reactions": {
                "+1": 1,
                "-1": 0,
                "confused": 0,
                "eyes": 0,
                "heart": 0,
                "hooray": 0,
                "laugh": 0,
                "rocket": 0,
                "total_count": 1,
                "url": "https://api.github.com/repos/neovim/neovim/pulls/comments/1894654870/reactions"
            },
            "side": "RIGHT",
            "start_line": null,
            "start_side": null,
            "subject_type": "line",
            "updated_at": "2024-12-21T16:49:42Z",
            "url": "https://api.github.com/repos/neovim/neovim/pulls/comments/1894654870",
            "user": {
                "avatar_url": "https://avatars.githubusercontent.com/u/2361214?v=4",
                "events_url": "https://api.github.com/users/clason/events{/privacy}",
                "followers_url": "https://api.github.com/users/clason/followers",
                "following_url": "https://api.github.com/users/clason/following{/other_user}",
                "gists_url": "https://api.github.com/users/clason/gists{/gist_id}",
                "gravatar_id": "",
                "html_url": "https://github.com/clason",
                "id": 2361214,
                "login": "clason",
                "node_id": "MDQ6VXNlcjIzNjEyMTQ=",
                "organizations_url": "https://api.github.com/users/clason/orgs",
                "received_events_url": "https://api.github.com/users/clason/received_events",
                "repos_url": "https://api.github.com/users/clason/repos",
                "site_admin": false,
                "starred_url": "https://api.github.com/users/clason/starred{/owner}{/repo}",
                "subscriptions_url": "https://api.github.com/users/clason/subscriptions",
                "type": "User",
                "url": "https://api.github.com/users/clason",
                "user_view_type": "public"
            }
        },
        {
            "_links": {
                "html": {
                    "href": "https://github.com/neovim/neovim/pull/31631#discussion_r1894654924"
                },
                "pull_request": {
                    "href": "https://api.github.com/repos/neovim/neovim/pulls/31631"
                },
                "self": {
                    "href": "https://api.github.com/repos/neovim/neovim/pulls/comments/1894654924"
                }
            },
            "author_association": "MEMBER",
            "body": "I had wrapped in `vim.schedule` initially and noticed lots of highlight flickering due to the slow injection code which takes place (I can upload a screencast). Running without schedule removes all flicker. Is it not safe to just run immediately here (no schedule) since we assume we got here by a `vim.schedule` in the first place, and we ensure that there are no more `coroutine.yield()`s after this point?\r\n\r\n[Screencast_20241221_083605.webm](https://github.com/user-attachments/assets/d00c09c8-3323-4faa-ac93-90256d809ebf)\r\n\r\n(With vim.schedule; there is also a quick flicker when editing which didn't show up well on the recording)",
            "commit_id": "c885db4421200a476440ec14ce231bcf922f7248",
            "created_at": "2024-12-21T16:35:39Z",
            "diff_hunk": "@@ -409,6 +428,46 @@ function LanguageTree:_add_injections()\n   return query_time\n end\n \n+--- Run an asynchronous parse, calling {on_parse} when complete.\n+---\n+--- @param range boolean|Range|nil\n+--- @param on_parse fun(trees: TSTrees)\n+function LanguageTree:_async_parse(range, on_parse)\n+  coroutine.resume(\n+    --- @param co_range boolean|Range|nil\n+    --- @param co_cb fun(trees: TSTrees)\n+    coroutine.create(function(co_range, co_cb)\n+      local co = coroutine.running()\n+      local ct = self:_buf().changedtick\n+      local unfinished = true\n+      --- @type TSTrees\n+      local trees\n+\n+      while unfinished do\n+        -- If buffer was changed in the middle of parsing, reset parse state\n+        if self:_buf().changedtick ~= ct then\n+          self._parser:reset()\n+          self:invalidate()\n+          coroutine.yield()\n+        end\n+\n+        trees, unfinished = self:_parse(co_range, default_parse_timeout_ms)\n+\n+        if unfinished then\n+          vim.schedule(function()\n+            coroutine.resume(co)\n+          end)\n+          coroutine.yield()\n+        else\n+          co_cb(trees)",
            "html_url": "https://github.com/neovim/neovim/pull/31631#discussion_r1894654924",
            "id": 1894654924,
            "in_reply_to_id": 1894652410,
            "line": null,
            "node_id": "PRRC_kwDOAPphoM5w7iPM",
            "original_commit_id": "733dddd6cf742fc06d8e369f78f665c170fa1eef",
            "original_line": 462,
            "original_position": 124,
            "original_start_line": null,
            "path": "runtime/lua/vim/treesitter/languagetree.lua",
            "position": null,
            "pull_request_review_id": 2518686883,
            "pull_request_url": "https://api.github.com/repos/neovim/neovim/pulls/31631",
            "reactions": {
                "+1": 0,
                "-1": 0,
                "confused": 0,
                "eyes": 0,
                "heart": 0,
                "hooray": 0,
                "laugh": 0,
                "rocket": 0,
                "total_count": 0,
                "url": "https://api.github.com/repos/neovim/neovim/pulls/comments/1894654924/reactions"
            },
            "side": "RIGHT",
            "start_line": null,
            "start_side": null,
            "subject_type": "line",
            "updated_at": "2024-12-21T16:41:04Z",
            "url": "https://api.github.com/repos/neovim/neovim/pulls/comments/1894654924",
            "user": {
                "avatar_url": "https://avatars.githubusercontent.com/u/55766287?v=4",
                "events_url": "https://api.github.com/users/ribru17/events{/privacy}",
                "followers_url": "https://api.github.com/users/ribru17/followers",
                "following_url": "https://api.github.com/users/ribru17/following{/other_user}",
                "gists_url": "https://api.github.com/users/ribru17/gists{/gist_id}",
                "gravatar_id": "",
                "html_url": "https://github.com/ribru17",
                "id": 55766287,
                "login": "ribru17",
                "node_id": "MDQ6VXNlcjU1NzY2Mjg3",
                "organizations_url": "https://api.github.com/users/ribru17/orgs",
                "received_events_url": "https://api.github.com/users/ribru17/received_events",
                "repos_url": "https://api.github.com/users/ribru17/repos",
                "site_admin": false,
                "starred_url": "https://api.github.com/users/ribru17/starred{/owner}{/repo}",
                "subscriptions_url": "https://api.github.com/users/ribru17/subscriptions",
                "type": "User",
                "url": "https://api.github.com/users/ribru17",
                "user_view_type": "public"
            }
        },
        {
            "_links": {
                "html": {
                    "href": "https://github.com/neovim/neovim/pull/31631#discussion_r1894655257"
                },
                "pull_request": {
                    "href": "https://api.github.com/repos/neovim/neovim/pulls/31631"
                },
                "self": {
                    "href": "https://api.github.com/repos/neovim/neovim/pulls/comments/1894655257"
                }
            },
            "author_association": "MEMBER",
            "body": "I could be wrong but I think here `redrawtime` *would* mean a timeout; the chunking would be the segment parse time, no?",
            "commit_id": "c885db4421200a476440ec14ce231bcf922f7248",
            "created_at": "2024-12-21T16:39:06Z",
            "diff_hunk": "@@ -409,6 +428,46 @@ function LanguageTree:_add_injections()\n   return query_time\n end\n \n+--- Run an asynchronous parse, calling {on_parse} when complete.\n+---\n+--- @param range boolean|Range|nil\n+--- @param on_parse fun(trees: TSTrees)\n+function LanguageTree:_async_parse(range, on_parse)\n+  coroutine.resume(\n+    --- @param co_range boolean|Range|nil\n+    --- @param co_cb fun(trees: TSTrees)\n+    coroutine.create(function(co_range, co_cb)\n+      local co = coroutine.running()\n+      local ct = self:_buf().changedtick\n+      local unfinished = true\n+      --- @type TSTrees\n+      local trees\n+\n+      while unfinished do",
            "html_url": "https://github.com/neovim/neovim/pull/31631#discussion_r1894655257",
            "id": 1894655257,
            "in_reply_to_id": 1894652582,
            "line": null,
            "node_id": "PRRC_kwDOAPphoM5w7iUZ",
            "original_commit_id": "733dddd6cf742fc06d8e369f78f665c170fa1eef",
            "original_line": 446,
            "original_position": 108,
            "original_start_line": null,
            "path": "runtime/lua/vim/treesitter/languagetree.lua",
            "position": null,
            "pull_request_review_id": 2518687288,
            "pull_request_url": "https://api.github.com/repos/neovim/neovim/pulls/31631",
            "reactions": {
                "+1": 2,
                "-1": 0,
                "confused": 0,
                "eyes": 0,
                "heart": 0,
                "hooray": 0,
                "laugh": 0,
                "rocket": 0,
                "total_count": 2,
                "url": "https://api.github.com/repos/neovim/neovim/pulls/comments/1894655257/reactions"
            },
            "side": "RIGHT",
            "start_line": null,
            "start_side": null,
            "subject_type": "line",
            "updated_at": "2024-12-21T16:39:06Z",
            "url": "https://api.github.com/repos/neovim/neovim/pulls/comments/1894655257",
            "user": {
                "avatar_url": "https://avatars.githubusercontent.com/u/55766287?v=4",
                "events_url": "https://api.github.com/users/ribru17/events{/privacy}",
                "followers_url": "https://api.github.com/users/ribru17/followers",
                "following_url": "https://api.github.com/users/ribru17/following{/other_user}",
                "gists_url": "https://api.github.com/users/ribru17/gists{/gist_id}",
                "gravatar_id": "",
                "html_url": "https://github.com/ribru17",
                "id": 55766287,
                "login": "ribru17",
                "node_id": "MDQ6VXNlcjU1NzY2Mjg3",
                "organizations_url": "https://api.github.com/users/ribru17/orgs",
                "received_events_url": "https://api.github.com/users/ribru17/received_events",
                "repos_url": "https://api.github.com/users/ribru17/repos",
                "site_admin": false,
                "starred_url": "https://api.github.com/users/ribru17/starred{/owner}{/repo}",
                "subscriptions_url": "https://api.github.com/users/ribru17/subscriptions",
                "type": "User",
                "url": "https://api.github.com/users/ribru17",
                "user_view_type": "public"
            }
        },
        {
            "_links": {
                "html": {
                    "href": "https://github.com/neovim/neovim/pull/31631#discussion_r1894656690"
                },
                "pull_request": {
                    "href": "https://api.github.com/repos/neovim/neovim/pulls/31631"
                },
                "self": {
                    "href": "https://api.github.com/repos/neovim/neovim/pulls/comments/1894656690"
                }
            },
            "author_association": "MEMBER",
            "body": "Oops, sorry, I misread. Yes, a hard \"bailout\" timeout as in Lewis' comment would make sense to tie to `redrawtime`.",
            "commit_id": "c885db4421200a476440ec14ce231bcf922f7248",
            "created_at": "2024-12-21T16:50:19Z",
            "diff_hunk": "@@ -409,6 +428,46 @@ function LanguageTree:_add_injections()\n   return query_time\n end\n \n+--- Run an asynchronous parse, calling {on_parse} when complete.\n+---\n+--- @param range boolean|Range|nil\n+--- @param on_parse fun(trees: TSTrees)\n+function LanguageTree:_async_parse(range, on_parse)\n+  coroutine.resume(\n+    --- @param co_range boolean|Range|nil\n+    --- @param co_cb fun(trees: TSTrees)\n+    coroutine.create(function(co_range, co_cb)\n+      local co = coroutine.running()\n+      local ct = self:_buf().changedtick\n+      local unfinished = true\n+      --- @type TSTrees\n+      local trees\n+\n+      while unfinished do",
            "html_url": "https://github.com/neovim/neovim/pull/31631#discussion_r1894656690",
            "id": 1894656690,
            "in_reply_to_id": 1894652582,
            "line": null,
            "node_id": "PRRC_kwDOAPphoM5w7iqy",
            "original_commit_id": "733dddd6cf742fc06d8e369f78f665c170fa1eef",
            "original_line": 446,
            "original_position": 108,
            "original_start_line": null,
            "path": "runtime/lua/vim/treesitter/languagetree.lua",
            "position": null,
            "pull_request_review_id": 2518688887,
            "pull_request_url": "https://api.github.com/repos/neovim/neovim/pulls/31631",
            "reactions": {
                "+1": 2,
                "-1": 0,
                "confused": 0,
                "eyes": 0,
                "heart": 0,
                "hooray": 0,
                "laugh": 0,
                "rocket": 0,
                "total_count": 2,
                "url": "https://api.github.com/repos/neovim/neovim/pulls/comments/1894656690/reactions"
            },
            "side": "RIGHT",
            "start_line": null,
            "start_side": null,
            "subject_type": "line",
            "updated_at": "2024-12-21T16:50:19Z",
            "url": "https://api.github.com/repos/neovim/neovim/pulls/comments/1894656690",
            "user": {
                "avatar_url": "https://avatars.githubusercontent.com/u/2361214?v=4",
                "events_url": "https://api.github.com/users/clason/events{/privacy}",
                "followers_url": "https://api.github.com/users/clason/followers",
                "following_url": "https://api.github.com/users/clason/following{/other_user}",
                "gists_url": "https://api.github.com/users/clason/gists{/gist_id}",
                "gravatar_id": "",
                "html_url": "https://github.com/clason",
                "id": 2361214,
                "login": "clason",
                "node_id": "MDQ6VXNlcjIzNjEyMTQ=",
                "organizations_url": "https://api.github.com/users/clason/orgs",
                "received_events_url": "https://api.github.com/users/clason/received_events",
                "repos_url": "https://api.github.com/users/clason/repos",
                "site_admin": false,
                "starred_url": "https://api.github.com/users/clason/starred{/owner}{/repo}",
                "subscriptions_url": "https://api.github.com/users/clason/subscriptions",
                "type": "User",
                "url": "https://api.github.com/users/clason",
                "user_view_type": "public"
            }
        },
        {
            "_links": {
                "html": {
                    "href": "https://github.com/neovim/neovim/pull/31631#discussion_r1894657037"
                },
                "pull_request": {
                    "href": "https://api.github.com/repos/neovim/neovim/pulls/31631"
                },
                "self": {
                    "href": "https://api.github.com/repos/neovim/neovim/pulls/comments/1894657037"
                }
            },
            "author_association": "MEMBER",
            "body": "Ah this is because you pass the callback in on_win. In that case if we ever go pass the segment time there will be some stutter, and the common case is we never reach the parse timeout, so there is no stutter.\n\nIn that case can we make it so the first call to parse runs outside of the coroutine and subsequent iterations happen within the coroutine, then we should be able to wrap the callback in schedule. If the first iteration of parse returns a tree then we can call the callback without schedule.\n\nHope that makes sense.\n\nEDIT: or there might be some way to write this so parse is always run on the main thread. Might even be possible to do without a coroutine.",
            "commit_id": "c885db4421200a476440ec14ce231bcf922f7248",
            "created_at": "2024-12-21T16:53:26Z",
            "diff_hunk": "@@ -409,6 +428,46 @@ function LanguageTree:_add_injections()\n   return query_time\n end\n \n+--- Run an asynchronous parse, calling {on_parse} when complete.\n+---\n+--- @param range boolean|Range|nil\n+--- @param on_parse fun(trees: TSTrees)\n+function LanguageTree:_async_parse(range, on_parse)\n+  coroutine.resume(\n+    --- @param co_range boolean|Range|nil\n+    --- @param co_cb fun(trees: TSTrees)\n+    coroutine.create(function(co_range, co_cb)\n+      local co = coroutine.running()\n+      local ct = self:_buf().changedtick\n+      local unfinished = true\n+      --- @type TSTrees\n+      local trees\n+\n+      while unfinished do\n+        -- If buffer was changed in the middle of parsing, reset parse state\n+        if self:_buf().changedtick ~= ct then\n+          self._parser:reset()\n+          self:invalidate()\n+          coroutine.yield()\n+        end\n+\n+        trees, unfinished = self:_parse(co_range, default_parse_timeout_ms)\n+\n+        if unfinished then\n+          vim.schedule(function()\n+            coroutine.resume(co)\n+          end)\n+          coroutine.yield()\n+        else\n+          co_cb(trees)",
            "html_url": "https://github.com/neovim/neovim/pull/31631#discussion_r1894657037",
            "id": 1894657037,
            "in_reply_to_id": 1894652410,
            "line": null,
            "node_id": "PRRC_kwDOAPphoM5w7iwN",
            "original_commit_id": "733dddd6cf742fc06d8e369f78f665c170fa1eef",
            "original_line": 462,
            "original_position": 124,
            "original_start_line": null,
            "path": "runtime/lua/vim/treesitter/languagetree.lua",
            "position": null,
            "pull_request_review_id": 2518689358,
            "pull_request_url": "https://api.github.com/repos/neovim/neovim/pulls/31631",
            "reactions": {
                "+1": 0,
                "-1": 0,
                "confused": 0,
                "eyes": 0,
                "heart": 0,
                "hooray": 0,
                "laugh": 0,
                "rocket": 0,
                "total_count": 0,
                "url": "https://api.github.com/repos/neovim/neovim/pulls/comments/1894657037/reactions"
            },
            "side": "RIGHT",
            "start_line": null,
            "start_side": null,
            "subject_type": "line",
            "updated_at": "2024-12-21T16:57:16Z",
            "url": "https://api.github.com/repos/neovim/neovim/pulls/comments/1894657037",
            "user": {
                "avatar_url": "https://avatars.githubusercontent.com/u/7904185?v=4",
                "events_url": "https://api.github.com/users/lewis6991/events{/privacy}",
                "followers_url": "https://api.github.com/users/lewis6991/followers",
                "following_url": "https://api.github.com/users/lewis6991/following{/other_user}",
                "gists_url": "https://api.github.com/users/lewis6991/gists{/gist_id}",
                "gravatar_id": "",
                "html_url": "https://github.com/lewis6991",
                "id": 7904185,
                "login": "lewis6991",
                "node_id": "MDQ6VXNlcjc5MDQxODU=",
                "organizations_url": "https://api.github.com/users/lewis6991/orgs",
                "received_events_url": "https://api.github.com/users/lewis6991/received_events",
                "repos_url": "https://api.github.com/users/lewis6991/repos",
                "site_admin": false,
                "starred_url": "https://api.github.com/users/lewis6991/starred{/owner}{/repo}",
                "subscriptions_url": "https://api.github.com/users/lewis6991/subscriptions",
                "type": "User",
                "url": "https://api.github.com/users/lewis6991",
                "user_view_type": "public"
            }
        },
        {
            "_links": {
                "html": {
                    "href": "https://github.com/neovim/neovim/pull/31631#discussion_r1894667866"
                },
                "pull_request": {
                    "href": "https://api.github.com/repos/neovim/neovim/pulls/31631"
                },
                "self": {
                    "href": "https://api.github.com/repos/neovim/neovim/pulls/comments/1894667866"
                }
            },
            "author_association": "MEMBER",
            "body": "Question: should the callback still be fired if `redrawtime` is reached before parsing finishes? If so, `trees` will just be an empty list. For whatever reason, in the highlighter callback if we fire it even when `redrawtime` timeout is reached, running `for_each_tree` causes async parsing to continue, which means `redrawtime` is not respected. Of course we can just run a conditional check to only run the highlighter callback if `#trees ~= 0` but it still seems odd that this happens...",
            "commit_id": "c885db4421200a476440ec14ce231bcf922f7248",
            "created_at": "2024-12-21T18:22:18Z",
            "diff_hunk": "@@ -409,6 +428,46 @@ function LanguageTree:_add_injections()\n   return query_time\n end\n \n+--- Run an asynchronous parse, calling {on_parse} when complete.\n+---\n+--- @param range boolean|Range|nil\n+--- @param on_parse fun(trees: TSTrees)\n+function LanguageTree:_async_parse(range, on_parse)\n+  coroutine.resume(\n+    --- @param co_range boolean|Range|nil\n+    --- @param co_cb fun(trees: TSTrees)\n+    coroutine.create(function(co_range, co_cb)\n+      local co = coroutine.running()\n+      local ct = self:_buf().changedtick\n+      local unfinished = true\n+      --- @type TSTrees\n+      local trees\n+\n+      while unfinished do",
            "html_url": "https://github.com/neovim/neovim/pull/31631#discussion_r1894667866",
            "id": 1894667866,
            "in_reply_to_id": 1894652582,
            "line": null,
            "node_id": "PRRC_kwDOAPphoM5w7lZa",
            "original_commit_id": "733dddd6cf742fc06d8e369f78f665c170fa1eef",
            "original_line": 446,
            "original_position": 108,
            "original_start_line": null,
            "path": "runtime/lua/vim/treesitter/languagetree.lua",
            "position": null,
            "pull_request_review_id": 2518778479,
            "pull_request_url": "https://api.github.com/repos/neovim/neovim/pulls/31631",
            "reactions": {
                "+1": 0,
                "-1": 0,
                "confused": 0,
                "eyes": 0,
                "heart": 0,
                "hooray": 0,
                "laugh": 0,
                "rocket": 0,
                "total_count": 0,
                "url": "https://api.github.com/repos/neovim/neovim/pulls/comments/1894667866/reactions"
            },
            "side": "RIGHT",
            "start_line": null,
            "start_side": null,
            "subject_type": "line",
            "updated_at": "2024-12-21T18:22:19Z",
            "url": "https://api.github.com/repos/neovim/neovim/pulls/comments/1894667866",
            "user": {
                "avatar_url": "https://avatars.githubusercontent.com/u/55766287?v=4",
                "events_url": "https://api.github.com/users/ribru17/events{/privacy}",
                "followers_url": "https://api.github.com/users/ribru17/followers",
                "following_url": "https://api.github.com/users/ribru17/following{/other_user}",
                "gists_url": "https://api.github.com/users/ribru17/gists{/gist_id}",
                "gravatar_id": "",
                "html_url": "https://github.com/ribru17",
                "id": 55766287,
                "login": "ribru17",
                "node_id": "MDQ6VXNlcjU1NzY2Mjg3",
                "organizations_url": "https://api.github.com/users/ribru17/orgs",
                "received_events_url": "https://api.github.com/users/ribru17/received_events",
                "repos_url": "https://api.github.com/users/ribru17/repos",
                "site_admin": false,
                "starred_url": "https://api.github.com/users/ribru17/starred{/owner}{/repo}",
                "subscriptions_url": "https://api.github.com/users/ribru17/subscriptions",
                "type": "User",
                "url": "https://api.github.com/users/ribru17",
                "user_view_type": "public"
            }
        },
        {
            "_links": {
                "html": {
                    "href": "https://github.com/neovim/neovim/pull/31631#discussion_r1894668340"
                },
                "pull_request": {
                    "href": "https://api.github.com/repos/neovim/neovim/pulls/31631"
                },
                "self": {
                    "href": "https://api.github.com/repos/neovim/neovim/pulls/comments/1894668340"
                }
            },
            "author_association": "MEMBER",
            "body": "Yes, the callback as a continuation which should always be called. It may be wise to pass back an error argument too which we can set to the timeout error/code.",
            "commit_id": "c885db4421200a476440ec14ce231bcf922f7248",
            "created_at": "2024-12-21T18:25:57Z",
            "diff_hunk": "@@ -409,6 +428,46 @@ function LanguageTree:_add_injections()\n   return query_time\n end\n \n+--- Run an asynchronous parse, calling {on_parse} when complete.\n+---\n+--- @param range boolean|Range|nil\n+--- @param on_parse fun(trees: TSTrees)\n+function LanguageTree:_async_parse(range, on_parse)\n+  coroutine.resume(\n+    --- @param co_range boolean|Range|nil\n+    --- @param co_cb fun(trees: TSTrees)\n+    coroutine.create(function(co_range, co_cb)\n+      local co = coroutine.running()\n+      local ct = self:_buf().changedtick\n+      local unfinished = true\n+      --- @type TSTrees\n+      local trees\n+\n+      while unfinished do",
            "html_url": "https://github.com/neovim/neovim/pull/31631#discussion_r1894668340",
            "id": 1894668340,
            "in_reply_to_id": 1894652582,
            "line": null,
            "node_id": "PRRC_kwDOAPphoM5w7lg0",
            "original_commit_id": "733dddd6cf742fc06d8e369f78f665c170fa1eef",
            "original_line": 446,
            "original_position": 108,
            "original_start_line": null,
            "path": "runtime/lua/vim/treesitter/languagetree.lua",
            "position": null,
            "pull_request_review_id": 2518785758,
            "pull_request_url": "https://api.github.com/repos/neovim/neovim/pulls/31631",
            "reactions": {
                "+1": 0,
                "-1": 0,
                "confused": 0,
                "eyes": 0,
                "heart": 0,
                "hooray": 0,
                "laugh": 0,
                "rocket": 0,
                "total_count": 0,
                "url": "https://api.github.com/repos/neovim/neovim/pulls/comments/1894668340/reactions"
            },
            "side": "RIGHT",
            "start_line": null,
            "start_side": null,
            "subject_type": "line",
            "updated_at": "2024-12-21T18:25:57Z",
            "url": "https://api.github.com/repos/neovim/neovim/pulls/comments/1894668340",
            "user": {
                "avatar_url": "https://avatars.githubusercontent.com/u/7904185?v=4",
                "events_url": "https://api.github.com/users/lewis6991/events{/privacy}",
                "followers_url": "https://api.github.com/users/lewis6991/followers",
                "following_url": "https://api.github.com/users/lewis6991/following{/other_user}",
                "gists_url": "https://api.github.com/users/lewis6991/gists{/gist_id}",
                "gravatar_id": "",
                "html_url": "https://github.com/lewis6991",
                "id": 7904185,
                "login": "lewis6991",
                "node_id": "MDQ6VXNlcjc5MDQxODU=",
                "organizations_url": "https://api.github.com/users/lewis6991/orgs",
                "received_events_url": "https://api.github.com/users/lewis6991/received_events",
                "repos_url": "https://api.github.com/users/lewis6991/repos",
                "site_admin": false,
                "starred_url": "https://api.github.com/users/lewis6991/starred{/owner}{/repo}",
                "subscriptions_url": "https://api.github.com/users/lewis6991/subscriptions",
                "type": "User",
                "url": "https://api.github.com/users/lewis6991",
                "user_view_type": "public"
            }
        },
        {
            "_links": {
                "html": {
                    "href": "https://github.com/neovim/neovim/pull/31631#discussion_r1894668345"
                },
                "pull_request": {
                    "href": "https://api.github.com/repos/neovim/neovim/pulls/31631"
                },
                "self": {
                    "href": "https://api.github.com/repos/neovim/neovim/pulls/comments/1894668345"
                }
            },
            "author_association": "MEMBER",
            "body": "I don't think we have fully solved the \"error\" scenario for this, which this (unlike the async parsing) is part of. (There were some _very_ heated discussions in the past...)",
            "commit_id": "c885db4421200a476440ec14ce231bcf922f7248",
            "created_at": "2024-12-21T18:26:00Z",
            "diff_hunk": "@@ -409,6 +428,46 @@ function LanguageTree:_add_injections()\n   return query_time\n end\n \n+--- Run an asynchronous parse, calling {on_parse} when complete.\n+---\n+--- @param range boolean|Range|nil\n+--- @param on_parse fun(trees: TSTrees)\n+function LanguageTree:_async_parse(range, on_parse)\n+  coroutine.resume(\n+    --- @param co_range boolean|Range|nil\n+    --- @param co_cb fun(trees: TSTrees)\n+    coroutine.create(function(co_range, co_cb)\n+      local co = coroutine.running()\n+      local ct = self:_buf().changedtick\n+      local unfinished = true\n+      --- @type TSTrees\n+      local trees\n+\n+      while unfinished do",
            "html_url": "https://github.com/neovim/neovim/pull/31631#discussion_r1894668345",
            "id": 1894668345,
            "in_reply_to_id": 1894652582,
            "line": null,
            "node_id": "PRRC_kwDOAPphoM5w7lg5",
            "original_commit_id": "733dddd6cf742fc06d8e369f78f665c170fa1eef",
            "original_line": 446,
            "original_position": 108,
            "original_start_line": null,
            "path": "runtime/lua/vim/treesitter/languagetree.lua",
            "position": null,
            "pull_request_review_id": 2518785841,
            "pull_request_url": "https://api.github.com/repos/neovim/neovim/pulls/31631",
            "reactions": {
                "+1": 0,
                "-1": 0,
                "confused": 0,
                "eyes": 0,
                "heart": 0,
                "hooray": 0,
                "laugh": 0,
                "rocket": 0,
                "total_count": 0,
                "url": "https://api.github.com/repos/neovim/neovim/pulls/comments/1894668345/reactions"
            },
            "side": "RIGHT",
            "start_line": null,
            "start_side": null,
            "subject_type": "line",
            "updated_at": "2024-12-21T18:26:00Z",
            "url": "https://api.github.com/repos/neovim/neovim/pulls/comments/1894668345",
            "user": {
                "avatar_url": "https://avatars.githubusercontent.com/u/2361214?v=4",
                "events_url": "https://api.github.com/users/clason/events{/privacy}",
                "followers_url": "https://api.github.com/users/clason/followers",
                "following_url": "https://api.github.com/users/clason/following{/other_user}",
                "gists_url": "https://api.github.com/users/clason/gists{/gist_id}",
                "gravatar_id": "",
                "html_url": "https://github.com/clason",
                "id": 2361214,
                "login": "clason",
                "node_id": "MDQ6VXNlcjIzNjEyMTQ=",
                "organizations_url": "https://api.github.com/users/clason/orgs",
                "received_events_url": "https://api.github.com/users/clason/received_events",
                "repos_url": "https://api.github.com/users/clason/repos",
                "site_admin": false,
                "starred_url": "https://api.github.com/users/clason/starred{/owner}{/repo}",
                "subscriptions_url": "https://api.github.com/users/clason/subscriptions",
                "type": "User",
                "url": "https://api.github.com/users/clason",
                "user_view_type": "public"
            }
        },
        {
            "_links": {
                "html": {
                    "href": "https://github.com/neovim/neovim/pull/31631#discussion_r1894677599"
                },
                "pull_request": {
                    "href": "https://api.github.com/repos/neovim/neovim/pulls/31631"
                },
                "self": {
                    "href": "https://api.github.com/repos/neovim/neovim/pulls/comments/1894677599"
                }
            },
            "author_association": "MEMBER",
            "body": "Maybe, but reading the description it looks like using wrap means calling `parse()` again will resume the coroutine, whereas right now it can only be resumed from within itself after a parsing segment is completed. I modeled the `resume(create(...` after coop.nvim's \"fire and forget\" concept\r\n\r\nAlso why change? I would guess that at best using `coroutine.wrap` is just the same as now",
            "commit_id": "c885db4421200a476440ec14ce231bcf922f7248",
            "created_at": "2024-12-21T19:39:28Z",
            "diff_hunk": "@@ -409,6 +428,46 @@ function LanguageTree:_add_injections()\n   return query_time\n end\n \n+--- Run an asynchronous parse, calling {on_parse} when complete.\n+---\n+--- @param range boolean|Range|nil\n+--- @param on_parse fun(trees: TSTrees)\n+function LanguageTree:_async_parse(range, on_parse)\n+  coroutine.resume(\n+    --- @param co_range boolean|Range|nil\n+    --- @param co_cb fun(trees: TSTrees)\n+    coroutine.create(function(co_range, co_cb)",
            "html_url": "https://github.com/neovim/neovim/pull/31631#discussion_r1894677599",
            "id": 1894677599,
            "in_reply_to_id": 1894652869,
            "line": null,
            "node_id": "PRRC_kwDOAPphoM5w7nxf",
            "original_commit_id": "733dddd6cf742fc06d8e369f78f665c170fa1eef",
            "original_line": 439,
            "original_position": 101,
            "original_start_line": null,
            "path": "runtime/lua/vim/treesitter/languagetree.lua",
            "position": null,
            "pull_request_review_id": 2518929604,
            "pull_request_url": "https://api.github.com/repos/neovim/neovim/pulls/31631",
            "reactions": {
                "+1": 0,
                "-1": 0,
                "confused": 0,
                "eyes": 0,
                "heart": 0,
                "hooray": 0,
                "laugh": 0,
                "rocket": 0,
                "total_count": 0,
                "url": "https://api.github.com/repos/neovim/neovim/pulls/comments/1894677599/reactions"
            },
            "side": "RIGHT",
            "start_line": null,
            "start_side": null,
            "subject_type": "line",
            "updated_at": "2024-12-21T19:39:29Z",
            "url": "https://api.github.com/repos/neovim/neovim/pulls/comments/1894677599",
            "user": {
                "avatar_url": "https://avatars.githubusercontent.com/u/55766287?v=4",
                "events_url": "https://api.github.com/users/ribru17/events{/privacy}",
                "followers_url": "https://api.github.com/users/ribru17/followers",
                "following_url": "https://api.github.com/users/ribru17/following{/other_user}",
                "gists_url": "https://api.github.com/users/ribru17/gists{/gist_id}",
                "gravatar_id": "",
                "html_url": "https://github.com/ribru17",
                "id": 55766287,
                "login": "ribru17",
                "node_id": "MDQ6VXNlcjU1NzY2Mjg3",
                "organizations_url": "https://api.github.com/users/ribru17/orgs",
                "received_events_url": "https://api.github.com/users/ribru17/received_events",
                "repos_url": "https://api.github.com/users/ribru17/repos",
                "site_admin": false,
                "starred_url": "https://api.github.com/users/ribru17/starred{/owner}{/repo}",
                "subscriptions_url": "https://api.github.com/users/ribru17/subscriptions",
                "type": "User",
                "url": "https://api.github.com/users/ribru17",
                "user_view_type": "public"
            }
        },
        {
            "_links": {
                "html": {
                    "href": "https://github.com/neovim/neovim/pull/31631#discussion_r1894678072"
                },
                "pull_request": {
                    "href": "https://api.github.com/repos/neovim/neovim/pulls/31631"
                },
                "self": {
                    "href": "https://api.github.com/repos/neovim/neovim/pulls/comments/1894678072"
                }
            },
            "author_association": "MEMBER",
            "body": "I opted to pass a boolean indicating whether timeout was reached; in treesitter.c if there is a timeout set, then parse() cannot throw a lua error so there are no other codes that could be needed right now",
            "commit_id": "c885db4421200a476440ec14ce231bcf922f7248",
            "created_at": "2024-12-21T19:42:05Z",
            "diff_hunk": "@@ -409,6 +428,46 @@ function LanguageTree:_add_injections()\n   return query_time\n end\n \n+--- Run an asynchronous parse, calling {on_parse} when complete.\n+---\n+--- @param range boolean|Range|nil\n+--- @param on_parse fun(trees: TSTrees)\n+function LanguageTree:_async_parse(range, on_parse)\n+  coroutine.resume(\n+    --- @param co_range boolean|Range|nil\n+    --- @param co_cb fun(trees: TSTrees)\n+    coroutine.create(function(co_range, co_cb)\n+      local co = coroutine.running()\n+      local ct = self:_buf().changedtick\n+      local unfinished = true\n+      --- @type TSTrees\n+      local trees\n+\n+      while unfinished do",
            "html_url": "https://github.com/neovim/neovim/pull/31631#discussion_r1894678072",
            "id": 1894678072,
            "in_reply_to_id": 1894652582,
            "line": null,
            "node_id": "PRRC_kwDOAPphoM5w7n44",
            "original_commit_id": "733dddd6cf742fc06d8e369f78f665c170fa1eef",
            "original_line": 446,
            "original_position": 108,
            "original_start_line": null,
            "path": "runtime/lua/vim/treesitter/languagetree.lua",
            "position": null,
            "pull_request_review_id": 2518934595,
            "pull_request_url": "https://api.github.com/repos/neovim/neovim/pulls/31631",
            "reactions": {
                "+1": 0,
                "-1": 0,
                "confused": 0,
                "eyes": 0,
                "heart": 0,
                "hooray": 0,
                "laugh": 0,
                "rocket": 0,
                "total_count": 0,
                "url": "https://api.github.com/repos/neovim/neovim/pulls/comments/1894678072/reactions"
            },
            "side": "RIGHT",
            "start_line": null,
            "start_side": null,
            "subject_type": "line",
            "updated_at": "2024-12-21T19:42:05Z",
            "url": "https://api.github.com/repos/neovim/neovim/pulls/comments/1894678072",
            "user": {
                "avatar_url": "https://avatars.githubusercontent.com/u/55766287?v=4",
                "events_url": "https://api.github.com/users/ribru17/events{/privacy}",
                "followers_url": "https://api.github.com/users/ribru17/followers",
                "following_url": "https://api.github.com/users/ribru17/following{/other_user}",
                "gists_url": "https://api.github.com/users/ribru17/gists{/gist_id}",
                "gravatar_id": "",
                "html_url": "https://github.com/ribru17",
                "id": 55766287,
                "login": "ribru17",
                "node_id": "MDQ6VXNlcjU1NzY2Mjg3",
                "organizations_url": "https://api.github.com/users/ribru17/orgs",
                "received_events_url": "https://api.github.com/users/ribru17/received_events",
                "repos_url": "https://api.github.com/users/ribru17/repos",
                "site_admin": false,
                "starred_url": "https://api.github.com/users/ribru17/starred{/owner}{/repo}",
                "subscriptions_url": "https://api.github.com/users/ribru17/subscriptions",
                "type": "User",
                "url": "https://api.github.com/users/ribru17",
                "user_view_type": "public"
            }
        },
        {
            "_links": {
                "html": {
                    "href": "https://github.com/neovim/neovim/pull/31631#discussion_r1894680062"
                },
                "pull_request": {
                    "href": "https://api.github.com/repos/neovim/neovim/pulls/31631"
                },
                "self": {
                    "href": "https://api.github.com/repos/neovim/neovim/pulls/comments/1894680062"
                }
            },
            "author_association": "MEMBER",
            "body": "Sorry, it's still not clear to me what problem this is trying to solve. It's an issue if the callback is run within the coroutine? I haven't found any problems so far with the current implementation\r\n\r\n> EDIT: or there might be some way to write this so parse is always run on the main thread. Might even be possible to do without a coroutine.\r\n\r\nIs this not the definition of just running a synchonous parse?\r\n\r\nEdit: I am testing a version which runs the first parse iteration (and callback, if complete) outside the coroutine, then further iterations inside it; both ways cause highlight flickering when using `vim.schedule` for the callback. I again think this is more related to the slow injections. Applying this patch to disable them removes the flicker even when using `vim.schedule`\r\n\r\n```patch\r\ndiff --git a/runtime/lua/vim/treesitter/languagetree.lua b/runtime/lua/vim/treesitter/languagetree.lua\r\nindex 52b1e97ec5..298fcb8a00 100644\r\n--- a/runtime/lua/vim/treesitter/languagetree.lua\r\n+++ b/runtime/lua/vim/treesitter/languagetree.lua\r\n@@ -903,7 +903,7 @@ end\r\n --- @private\r\n --- @return table<string, Range6[][]>\r\n function LanguageTree:_get_injections()\r\n-  if not self._injection_query then\r\n+  if true then\r\n     return {}\r\n   end\r\n ```",
            "commit_id": "c885db4421200a476440ec14ce231bcf922f7248",
            "created_at": "2024-12-21T20:00:44Z",
            "diff_hunk": "@@ -409,6 +428,46 @@ function LanguageTree:_add_injections()\n   return query_time\n end\n \n+--- Run an asynchronous parse, calling {on_parse} when complete.\n+---\n+--- @param range boolean|Range|nil\n+--- @param on_parse fun(trees: TSTrees)\n+function LanguageTree:_async_parse(range, on_parse)\n+  coroutine.resume(\n+    --- @param co_range boolean|Range|nil\n+    --- @param co_cb fun(trees: TSTrees)\n+    coroutine.create(function(co_range, co_cb)\n+      local co = coroutine.running()\n+      local ct = self:_buf().changedtick\n+      local unfinished = true\n+      --- @type TSTrees\n+      local trees\n+\n+      while unfinished do\n+        -- If buffer was changed in the middle of parsing, reset parse state\n+        if self:_buf().changedtick ~= ct then\n+          self._parser:reset()\n+          self:invalidate()\n+          coroutine.yield()\n+        end\n+\n+        trees, unfinished = self:_parse(co_range, default_parse_timeout_ms)\n+\n+        if unfinished then\n+          vim.schedule(function()\n+            coroutine.resume(co)\n+          end)\n+          coroutine.yield()\n+        else\n+          co_cb(trees)",
            "html_url": "https://github.com/neovim/neovim/pull/31631#discussion_r1894680062",
            "id": 1894680062,
            "in_reply_to_id": 1894652410,
            "line": null,
            "node_id": "PRRC_kwDOAPphoM5w7oX-",
            "original_commit_id": "733dddd6cf742fc06d8e369f78f665c170fa1eef",
            "original_line": 462,
            "original_position": 124,
            "original_start_line": null,
            "path": "runtime/lua/vim/treesitter/languagetree.lua",
            "position": null,
            "pull_request_review_id": 2518971064,
            "pull_request_url": "https://api.github.com/repos/neovim/neovim/pulls/31631",
            "reactions": {
                "+1": 0,
                "-1": 0,
                "confused": 0,
                "eyes": 0,
                "heart": 0,
                "hooray": 0,
                "laugh": 0,
                "rocket": 0,
                "total_count": 0,
                "url": "https://api.github.com/repos/neovim/neovim/pulls/comments/1894680062/reactions"
            },
            "side": "RIGHT",
            "start_line": null,
            "start_side": null,
            "subject_type": "line",
            "updated_at": "2024-12-21T20:08:22Z",
            "url": "https://api.github.com/repos/neovim/neovim/pulls/comments/1894680062",
            "user": {
                "avatar_url": "https://avatars.githubusercontent.com/u/55766287?v=4",
                "events_url": "https://api.github.com/users/ribru17/events{/privacy}",
                "followers_url": "https://api.github.com/users/ribru17/followers",
                "following_url": "https://api.github.com/users/ribru17/following{/other_user}",
                "gists_url": "https://api.github.com/users/ribru17/gists{/gist_id}",
                "gravatar_id": "",
                "html_url": "https://github.com/ribru17",
                "id": 55766287,
                "login": "ribru17",
                "node_id": "MDQ6VXNlcjU1NzY2Mjg3",
                "organizations_url": "https://api.github.com/users/ribru17/orgs",
                "received_events_url": "https://api.github.com/users/ribru17/received_events",
                "repos_url": "https://api.github.com/users/ribru17/repos",
                "site_admin": false,
                "starred_url": "https://api.github.com/users/ribru17/starred{/owner}{/repo}",
                "subscriptions_url": "https://api.github.com/users/ribru17/subscriptions",
                "type": "User",
                "url": "https://api.github.com/users/ribru17",
                "user_view_type": "public"
            }
        },
        {
            "_links": {
                "html": {
                    "href": "https://github.com/neovim/neovim/pull/31631#discussion_r1894689459"
                },
                "pull_request": {
                    "href": "https://api.github.com/repos/neovim/neovim/pulls/31631"
                },
                "self": {
                    "href": "https://api.github.com/repos/neovim/neovim/pulls/comments/1894689459"
                }
            },
            "author_association": "MEMBER",
            "body": "I suggested as a potential simplification since you are starting the coroutine directly after creating it. However I think it's probably best to do this without coroutines, I'll post a patch later.",
            "commit_id": "c885db4421200a476440ec14ce231bcf922f7248",
            "created_at": "2024-12-21T21:17:04Z",
            "diff_hunk": "@@ -409,6 +428,46 @@ function LanguageTree:_add_injections()\n   return query_time\n end\n \n+--- Run an asynchronous parse, calling {on_parse} when complete.\n+---\n+--- @param range boolean|Range|nil\n+--- @param on_parse fun(trees: TSTrees)\n+function LanguageTree:_async_parse(range, on_parse)\n+  coroutine.resume(\n+    --- @param co_range boolean|Range|nil\n+    --- @param co_cb fun(trees: TSTrees)\n+    coroutine.create(function(co_range, co_cb)",
            "html_url": "https://github.com/neovim/neovim/pull/31631#discussion_r1894689459",
            "id": 1894689459,
            "in_reply_to_id": 1894652869,
            "line": null,
            "node_id": "PRRC_kwDOAPphoM5w7qqz",
            "original_commit_id": "733dddd6cf742fc06d8e369f78f665c170fa1eef",
            "original_line": 439,
            "original_position": 101,
            "original_start_line": null,
            "path": "runtime/lua/vim/treesitter/languagetree.lua",
            "position": null,
            "pull_request_review_id": 2519113785,
            "pull_request_url": "https://api.github.com/repos/neovim/neovim/pulls/31631",
            "reactions": {
                "+1": 1,
                "-1": 0,
                "confused": 0,
                "eyes": 0,
                "heart": 0,
                "hooray": 0,
                "laugh": 0,
                "rocket": 0,
                "total_count": 1,
                "url": "https://api.github.com/repos/neovim/neovim/pulls/comments/1894689459/reactions"
            },
            "side": "RIGHT",
            "start_line": null,
            "start_side": null,
            "subject_type": "line",
            "updated_at": "2024-12-21T21:17:04Z",
            "url": "https://api.github.com/repos/neovim/neovim/pulls/comments/1894689459",
            "user": {
                "avatar_url": "https://avatars.githubusercontent.com/u/7904185?v=4",
                "events_url": "https://api.github.com/users/lewis6991/events{/privacy}",
                "followers_url": "https://api.github.com/users/lewis6991/followers",
                "following_url": "https://api.github.com/users/lewis6991/following{/other_user}",
                "gists_url": "https://api.github.com/users/lewis6991/gists{/gist_id}",
                "gravatar_id": "",
                "html_url": "https://github.com/lewis6991",
                "id": 7904185,
                "login": "lewis6991",
                "node_id": "MDQ6VXNlcjc5MDQxODU=",
                "organizations_url": "https://api.github.com/users/lewis6991/orgs",
                "received_events_url": "https://api.github.com/users/lewis6991/received_events",
                "repos_url": "https://api.github.com/users/lewis6991/repos",
                "site_admin": false,
                "starred_url": "https://api.github.com/users/lewis6991/starred{/owner}{/repo}",
                "subscriptions_url": "https://api.github.com/users/lewis6991/subscriptions",
                "type": "User",
                "url": "https://api.github.com/users/lewis6991",
                "user_view_type": "public"
            }
        },
        {
            "_links": {
                "html": {
                    "href": "https://github.com/neovim/neovim/pull/31631#discussion_r1894698118"
                },
                "pull_request": {
                    "href": "https://api.github.com/repos/neovim/neovim/pulls/31631"
                },
                "self": {
                    "href": "https://api.github.com/repos/neovim/neovim/pulls/comments/1894698118"
                }
            },
            "author_association": "MEMBER",
            "body": "Also at `:help 'redrawtime'`, would you mind adding `... and async |LanguageTree:parse()|`.",
            "commit_id": "c885db4421200a476440ec14ce231bcf922f7248",
            "created_at": "2024-12-21T22:41:46Z",
            "diff_hunk": "@@ -1605,14 +1608,20 @@ LanguageTree:parse({range})                             *LanguageTree:parse()*\n     if {range} is `true`).\n \n     Parameters: ~\n-       {range}  (`boolean|Range?`) Parse this range in the parser's source.\n-                 Set to `true` to run a complete parse of the source (Note:\n-                 Can be slow!) Set to `false|nil` to only parse regions with\n-                 empty ranges (typically only the root tree without\n-                 injections).\n+       {range}     (`boolean|Range?`) Parse this range in the parser's\n+                    source. Set to `true` to run a complete parse of the\n+                    source (Note: Can be slow!) Set to `false|nil` to only\n+                    parse regions with empty ranges (typically only the root\n+                    tree without injections).\n+       {on_parse}  (`fun(trees: TSTrees, timeout_reached: boolean)?`)\n+                    Function invoked when parsing completes. When provided,\n+                    parsing will run asynchronously. The function is passed\n+                    the list of trees returned by the parse, as well as a\n+                    boolean indicating whether or not the parse timed out,\n+                    determined by 'redrawtime'.",
            "html_url": "https://github.com/neovim/neovim/pull/31631#discussion_r1894698118",
            "id": 1894698118,
            "line": null,
            "node_id": "PRRC_kwDOAPphoM5w7syG",
            "original_commit_id": "5245fe86c51c899500dc8c002a00fc5dd0b0eab0",
            "original_line": 1621,
            "original_position": 38,
            "original_start_line": null,
            "path": "runtime/doc/treesitter.txt",
            "position": null,
            "pull_request_review_id": 2519265480,
            "pull_request_url": "https://api.github.com/repos/neovim/neovim/pulls/31631",
            "reactions": {
                "+1": 1,
                "-1": 0,
                "confused": 0,
                "eyes": 0,
                "heart": 0,
                "hooray": 0,
                "laugh": 0,
                "rocket": 0,
                "total_count": 1,
                "url": "https://api.github.com/repos/neovim/neovim/pulls/comments/1894698118/reactions"
            },
            "side": "RIGHT",
            "start_line": null,
            "start_side": null,
            "subject_type": "line",
            "updated_at": "2024-12-21T22:41:46Z",
            "url": "https://api.github.com/repos/neovim/neovim/pulls/comments/1894698118",
            "user": {
                "avatar_url": "https://avatars.githubusercontent.com/u/1359421?v=4",
                "events_url": "https://api.github.com/users/justinmk/events{/privacy}",
                "followers_url": "https://api.github.com/users/justinmk/followers",
                "following_url": "https://api.github.com/users/justinmk/following{/other_user}",
                "gists_url": "https://api.github.com/users/justinmk/gists{/gist_id}",
                "gravatar_id": "",
                "html_url": "https://github.com/justinmk",
                "id": 1359421,
                "login": "justinmk",
                "node_id": "MDQ6VXNlcjEzNTk0MjE=",
                "organizations_url": "https://api.github.com/users/justinmk/orgs",
                "received_events_url": "https://api.github.com/users/justinmk/received_events",
                "repos_url": "https://api.github.com/users/justinmk/repos",
                "site_admin": false,
                "starred_url": "https://api.github.com/users/justinmk/starred{/owner}{/repo}",
                "subscriptions_url": "https://api.github.com/users/justinmk/subscriptions",
                "type": "User",
                "url": "https://api.github.com/users/justinmk",
                "user_view_type": "public"
            }
        },
        {
            "_links": {
                "html": {
                    "href": "https://github.com/neovim/neovim/pull/31631#discussion_r1894698328"
                },
                "pull_request": {
                    "href": "https://api.github.com/repos/neovim/neovim/pulls/31631"
                },
                "self": {
                    "href": "https://api.github.com/repos/neovim/neovim/pulls/comments/1894698328"
                }
            },
            "author_association": "MEMBER",
            "body": "nit: \"expired\" is the usual term I think\r\n\r\n```suggestion\r\n--- @param on_parse fun(trees: TSTrees, timeout_expired: boolean)\r\n```",
            "commit_id": "c885db4421200a476440ec14ce231bcf922f7248",
            "created_at": "2024-12-21T22:44:43Z",
            "diff_hunk": "@@ -409,6 +428,45 @@ function LanguageTree:_add_injections()\n   return query_time\n end\n \n+--- Run an asynchronous parse, calling {on_parse} when complete.\n+---\n+--- @param range boolean|Range|nil\n+--- @param on_parse fun(trees: TSTrees, timeout_reached: boolean)",
            "html_url": "https://github.com/neovim/neovim/pull/31631#discussion_r1894698328",
            "id": 1894698328,
            "line": null,
            "node_id": "PRRC_kwDOAPphoM5w7s1Y",
            "original_commit_id": "5245fe86c51c899500dc8c002a00fc5dd0b0eab0",
            "original_line": 434,
            "original_position": 96,
            "original_start_line": null,
            "path": "runtime/lua/vim/treesitter/languagetree.lua",
            "position": null,
            "pull_request_review_id": 2519270832,
            "pull_request_url": "https://api.github.com/repos/neovim/neovim/pulls/31631",
            "reactions": {
                "+1": 1,
                "-1": 0,
                "confused": 0,
                "eyes": 0,
                "heart": 0,
                "hooray": 0,
                "laugh": 0,
                "rocket": 0,
                "total_count": 1,
                "url": "https://api.github.com/repos/neovim/neovim/pulls/comments/1894698328/reactions"
            },
            "side": "RIGHT",
            "start_line": null,
            "start_side": null,
            "subject_type": "line",
            "updated_at": "2024-12-21T22:44:43Z",
            "url": "https://api.github.com/repos/neovim/neovim/pulls/comments/1894698328",
            "user": {
                "avatar_url": "https://avatars.githubusercontent.com/u/1359421?v=4",
                "events_url": "https://api.github.com/users/justinmk/events{/privacy}",
                "followers_url": "https://api.github.com/users/justinmk/followers",
                "following_url": "https://api.github.com/users/justinmk/following{/other_user}",
                "gists_url": "https://api.github.com/users/justinmk/gists{/gist_id}",
                "gravatar_id": "",
                "html_url": "https://github.com/justinmk",
                "id": 1359421,
                "login": "justinmk",
                "node_id": "MDQ6VXNlcjEzNTk0MjE=",
                "organizations_url": "https://api.github.com/users/justinmk/orgs",
                "received_events_url": "https://api.github.com/users/justinmk/received_events",
                "repos_url": "https://api.github.com/users/justinmk/repos",
                "site_admin": false,
                "starred_url": "https://api.github.com/users/justinmk/starred{/owner}{/repo}",
                "subscriptions_url": "https://api.github.com/users/justinmk/subscriptions",
                "type": "User",
                "url": "https://api.github.com/users/justinmk",
                "user_view_type": "public"
            }
        },
        {
            "_links": {
                "html": {
                    "href": "https://github.com/neovim/neovim/pull/31631#discussion_r1894698681"
                },
                "pull_request": {
                    "href": "https://api.github.com/repos/neovim/neovim/pulls/31631"
                },
                "self": {
                    "href": "https://api.github.com/repos/neovim/neovim/pulls/comments/1894698681"
                }
            },
            "author_association": "MEMBER",
            "body": "```suggestion\r\n |vim.treesitter.get_parser()| and |vim.treesitter.start()| no longer parse\r\n  the tree before returning. Scripts must call |LanguageTree:parse()| explicitly. >\r\n    local p = vim.treesitter.get_parser(0, 'c')\r\n    p:parse()\r\n<\r\n```",
            "commit_id": "c885db4421200a476440ec14ce231bcf922f7248",
            "created_at": "2024-12-21T22:48:06Z",
            "diff_hunk": "@@ -158,6 +158,9 @@ TREESITTER\n  New |TSNode:child_with_descendant()|, which is nearly identical to\n   |TSNode:child_containing_descendant()| except that it can return the\n   descendant itself.\n+ |vim.treesitter.get_parser()| and |vim.treesitter.start()| no longer parse\n+  the tree before returning. Users must manually ensure that the tree is\n+  parsed after these functions, using |LanguageTree:parse()|.",
            "html_url": "https://github.com/neovim/neovim/pull/31631#discussion_r1894698681",
            "id": 1894698681,
            "line": null,
            "node_id": "PRRC_kwDOAPphoM5w7s65",
            "original_commit_id": "5245fe86c51c899500dc8c002a00fc5dd0b0eab0",
            "original_line": 163,
            "original_position": 6,
            "original_start_line": 161,
            "path": "runtime/doc/news.txt",
            "position": null,
            "pull_request_review_id": 2519276929,
            "pull_request_url": "https://api.github.com/repos/neovim/neovim/pulls/31631",
            "reactions": {
                "+1": 1,
                "-1": 0,
                "confused": 0,
                "eyes": 0,
                "heart": 0,
                "hooray": 0,
                "laugh": 0,
                "rocket": 0,
                "total_count": 1,
                "url": "https://api.github.com/repos/neovim/neovim/pulls/comments/1894698681/reactions"
            },
            "side": "RIGHT",
            "start_line": null,
            "start_side": "RIGHT",
            "subject_type": "line",
            "updated_at": "2024-12-21T22:48:06Z",
            "url": "https://api.github.com/repos/neovim/neovim/pulls/comments/1894698681",
            "user": {
                "avatar_url": "https://avatars.githubusercontent.com/u/1359421?v=4",
                "events_url": "https://api.github.com/users/justinmk/events{/privacy}",
                "followers_url": "https://api.github.com/users/justinmk/followers",
                "following_url": "https://api.github.com/users/justinmk/following{/other_user}",
                "gists_url": "https://api.github.com/users/justinmk/gists{/gist_id}",
                "gravatar_id": "",
                "html_url": "https://github.com/justinmk",
                "id": 1359421,
                "login": "justinmk",
                "node_id": "MDQ6VXNlcjEzNTk0MjE=",
                "organizations_url": "https://api.github.com/users/justinmk/orgs",
                "received_events_url": "https://api.github.com/users/justinmk/received_events",
                "repos_url": "https://api.github.com/users/justinmk/repos",
                "site_admin": false,
                "starred_url": "https://api.github.com/users/justinmk/starred{/owner}{/repo}",
                "subscriptions_url": "https://api.github.com/users/justinmk/subscriptions",
                "type": "User",
                "url": "https://api.github.com/users/justinmk",
                "user_view_type": "public"
            }
        },
        {
            "_links": {
                "html": {
                    "href": "https://github.com/neovim/neovim/pull/31631#discussion_r1894699027"
                },
                "pull_request": {
                    "href": "https://api.github.com/repos/neovim/neovim/pulls/31631"
                },
                "self": {
                    "href": "https://api.github.com/repos/neovim/neovim/pulls/comments/1894699027"
                }
            },
            "author_association": "MEMBER",
            "body": "```suggestion\r\n |LanguageTree:parse()| optionally supports asynchronous invocation, which is\r\n  activated by passing the `on_parse` callback parameter.\r\n```",
            "commit_id": "c885db4421200a476440ec14ce231bcf922f7248",
            "created_at": "2024-12-21T22:51:04Z",
            "diff_hunk": "@@ -303,6 +307,8 @@ TREESITTER\n  |treesitter-directive-trim!| can trim all whitespace (not just empty lines)\n   from both sides of a node.\n  |vim.treesitter.get_captures_at_pos()| now returns the `id` of each capture\n+ |LanguageTree:parse()| can now take a callback which causes the parse to run\n+  asynchronously, running the callback upon completion.",
            "html_url": "https://github.com/neovim/neovim/pull/31631#discussion_r1894699027",
            "id": 1894699027,
            "line": null,
            "node_id": "PRRC_kwDOAPphoM5w7tAT",
            "original_commit_id": "5245fe86c51c899500dc8c002a00fc5dd0b0eab0",
            "original_line": 311,
            "original_position": 23,
            "original_start_line": 310,
            "path": "runtime/doc/news.txt",
            "position": null,
            "pull_request_review_id": 2519282148,
            "pull_request_url": "https://api.github.com/repos/neovim/neovim/pulls/31631",
            "reactions": {
                "+1": 1,
                "-1": 0,
                "confused": 0,
                "eyes": 0,
                "heart": 0,
                "hooray": 0,
                "laugh": 0,
                "rocket": 0,
                "total_count": 1,
                "url": "https://api.github.com/repos/neovim/neovim/pulls/comments/1894699027/reactions"
            },
            "side": "RIGHT",
            "start_line": null,
            "start_side": "RIGHT",
            "subject_type": "line",
            "updated_at": "2024-12-21T22:51:04Z",
            "url": "https://api.github.com/repos/neovim/neovim/pulls/comments/1894699027",
            "user": {
                "avatar_url": "https://avatars.githubusercontent.com/u/1359421?v=4",
                "events_url": "https://api.github.com/users/justinmk/events{/privacy}",
                "followers_url": "https://api.github.com/users/justinmk/followers",
                "following_url": "https://api.github.com/users/justinmk/following{/other_user}",
                "gists_url": "https://api.github.com/users/justinmk/gists{/gist_id}",
                "gravatar_id": "",
                "html_url": "https://github.com/justinmk",
                "id": 1359421,
                "login": "justinmk",
                "node_id": "MDQ6VXNlcjEzNTk0MjE=",
                "organizations_url": "https://api.github.com/users/justinmk/orgs",
                "received_events_url": "https://api.github.com/users/justinmk/received_events",
                "repos_url": "https://api.github.com/users/justinmk/repos",
                "site_admin": false,
                "starred_url": "https://api.github.com/users/justinmk/starred{/owner}{/repo}",
                "subscriptions_url": "https://api.github.com/users/justinmk/subscriptions",
                "type": "User",
                "url": "https://api.github.com/users/justinmk",
                "user_view_type": "public"
            }
        },
        {
            "_links": {
                "html": {
                    "href": "https://github.com/neovim/neovim/pull/31631#discussion_r1894700180"
                },
                "pull_request": {
                    "href": "https://api.github.com/repos/neovim/neovim/pulls/31631"
                },
                "self": {
                    "href": "https://api.github.com/repos/neovim/neovim/pulls/comments/1894700180"
                }
            },
            "author_association": "MEMBER",
            "body": "This is a private variable not used anywhere that likely just exists for debugging purposes? Moving it without renaming doesn't seem to make much sense. The \"redraw count\" increments in the `on_win` callback. I would suggest any of; leaving `redraw_count` in `on_win`, adding `parse_count?` in `_asyn_parse_callback`, removing both?",
            "commit_id": "c885db4421200a476440ec14ce231bcf922f7248",
            "created_at": "2024-12-21T23:03:14Z",
            "diff_hunk": "@@ -391,12 +388,22 @@ function TSHighlighter._on_win(_, _win, buf, topline, botline)\n   if not self then\n     return false\n   end\n-  self.tree:parse({ topline, botline + 1 })\n-  self:prepare_highlight_states(topline, botline + 1)\n-  self.redraw_count = self.redraw_count + 1\n+  local range = { topline, botline + 1 }\n+  self.tree:parse(range, function(_, timeout_reached)\n+    if not timeout_reached then\n+      self:_async_parse_callback(range)\n+    end\n+  end)\n   return true\n end\n \n+--- @param range [integer, integer]\n+function TSHighlighter:_async_parse_callback(range)\n+  self:prepare_highlight_states(unpack(range))\n+  self.redraw_count = self.redraw_count + 1",
            "html_url": "https://github.com/neovim/neovim/pull/31631#discussion_r1894700180",
            "id": 1894700180,
            "line": null,
            "node_id": "PRRC_kwDOAPphoM5w7tSU",
            "original_commit_id": "5245fe86c51c899500dc8c002a00fc5dd0b0eab0",
            "original_line": 403,
            "original_position": 36,
            "original_start_line": null,
            "path": "runtime/lua/vim/treesitter/highlighter.lua",
            "position": null,
            "pull_request_review_id": 2519303617,
            "pull_request_url": "https://api.github.com/repos/neovim/neovim/pulls/31631",
            "reactions": {
                "+1": 1,
                "-1": 0,
                "confused": 0,
                "eyes": 0,
                "heart": 0,
                "hooray": 0,
                "laugh": 0,
                "rocket": 0,
                "total_count": 1,
                "url": "https://api.github.com/repos/neovim/neovim/pulls/comments/1894700180/reactions"
            },
            "side": "RIGHT",
            "start_line": null,
            "start_side": null,
            "subject_type": "line",
            "updated_at": "2024-12-21T23:03:15Z",
            "url": "https://api.github.com/repos/neovim/neovim/pulls/comments/1894700180",
            "user": {
                "avatar_url": "https://avatars.githubusercontent.com/u/31730729?v=4",
                "events_url": "https://api.github.com/users/luukvbaal/events{/privacy}",
                "followers_url": "https://api.github.com/users/luukvbaal/followers",
                "following_url": "https://api.github.com/users/luukvbaal/following{/other_user}",
                "gists_url": "https://api.github.com/users/luukvbaal/gists{/gist_id}",
                "gravatar_id": "",
                "html_url": "https://github.com/luukvbaal",
                "id": 31730729,
                "login": "luukvbaal",
                "node_id": "MDQ6VXNlcjMxNzMwNzI5",
                "organizations_url": "https://api.github.com/users/luukvbaal/orgs",
                "received_events_url": "https://api.github.com/users/luukvbaal/received_events",
                "repos_url": "https://api.github.com/users/luukvbaal/repos",
                "site_admin": false,
                "starred_url": "https://api.github.com/users/luukvbaal/starred{/owner}{/repo}",
                "subscriptions_url": "https://api.github.com/users/luukvbaal/subscriptions",
                "type": "User",
                "url": "https://api.github.com/users/luukvbaal",
                "user_view_type": "public"
            }
        },
        {
            "_links": {
                "html": {
                    "href": "https://github.com/neovim/neovim/pull/31631#discussion_r1894710811"
                },
                "pull_request": {
                    "href": "https://api.github.com/repos/neovim/neovim/pulls/31631"
                },
                "self": {
                    "href": "https://api.github.com/repos/neovim/neovim/pulls/comments/1894710811"
                }
            },
            "author_association": "MEMBER",
            "body": "Can this be `>lua ...`?",
            "commit_id": "c885db4421200a476440ec14ce231bcf922f7248",
            "created_at": "2024-12-22T01:00:17Z",
            "diff_hunk": "@@ -158,6 +158,9 @@ TREESITTER\n  New |TSNode:child_with_descendant()|, which is nearly identical to\n   |TSNode:child_containing_descendant()| except that it can return the\n   descendant itself.\n+ |vim.treesitter.get_parser()| and |vim.treesitter.start()| no longer parse\n+  the tree before returning. Users must manually ensure that the tree is\n+  parsed after these functions, using |LanguageTree:parse()|.",
            "html_url": "https://github.com/neovim/neovim/pull/31631#discussion_r1894710811",
            "id": 1894710811,
            "in_reply_to_id": 1894698681,
            "line": null,
            "node_id": "PRRC_kwDOAPphoM5w7v4b",
            "original_commit_id": "5245fe86c51c899500dc8c002a00fc5dd0b0eab0",
            "original_line": 163,
            "original_position": 6,
            "original_start_line": 161,
            "path": "runtime/doc/news.txt",
            "position": null,
            "pull_request_review_id": 2519509511,
            "pull_request_url": "https://api.github.com/repos/neovim/neovim/pulls/31631",
            "reactions": {
                "+1": 1,
                "-1": 0,
                "confused": 0,
                "eyes": 0,
                "heart": 0,
                "hooray": 0,
                "laugh": 0,
                "rocket": 0,
                "total_count": 1,
                "url": "https://api.github.com/repos/neovim/neovim/pulls/comments/1894710811/reactions"
            },
            "side": "RIGHT",
            "start_line": null,
            "start_side": "RIGHT",
            "subject_type": "line",
            "updated_at": "2024-12-22T01:00:17Z",
            "url": "https://api.github.com/repos/neovim/neovim/pulls/comments/1894710811",
            "user": {
                "avatar_url": "https://avatars.githubusercontent.com/u/55766287?v=4",
                "events_url": "https://api.github.com/users/ribru17/events{/privacy}",
                "followers_url": "https://api.github.com/users/ribru17/followers",
                "following_url": "https://api.github.com/users/ribru17/following{/other_user}",
                "gists_url": "https://api.github.com/users/ribru17/gists{/gist_id}",
                "gravatar_id": "",
                "html_url": "https://github.com/ribru17",
                "id": 55766287,
                "login": "ribru17",
                "node_id": "MDQ6VXNlcjU1NzY2Mjg3",
                "organizations_url": "https://api.github.com/users/ribru17/orgs",
                "received_events_url": "https://api.github.com/users/ribru17/received_events",
                "repos_url": "https://api.github.com/users/ribru17/repos",
                "site_admin": false,
                "starred_url": "https://api.github.com/users/ribru17/starred{/owner}{/repo}",
                "subscriptions_url": "https://api.github.com/users/ribru17/subscriptions",
                "type": "User",
                "url": "https://api.github.com/users/ribru17",
                "user_view_type": "public"
            }
        },
        {
            "_links": {
                "html": {
                    "href": "https://github.com/neovim/neovim/pull/31631#discussion_r1894747953"
                },
                "pull_request": {
                    "href": "https://api.github.com/repos/neovim/neovim/pulls/31631"
                },
                "self": {
                    "href": "https://api.github.com/repos/neovim/neovim/pulls/comments/1894747953"
                }
            },
            "author_association": "CONTRIBUTOR",
            "body": "\r\n\r\nI think that `'redrawtime'` is not the right option for limiting the total time of the parse.\r\n\r\nThe total time an async parse takes doesn't, in a major way, influence how responsive the editor is: the parse blocks for only 3ms and can execute during idle periods. Parsing a file even for 2 seconds is barely noticeable (ignoring the final parse with injections and the bug), so the limit should probably be much higher.\r\n\r\nAll other features that respect `'redrawtime'` can block the editor for an unknown amount of time, (and are not interruptible in any other way?). ",
            "commit_id": "c885db4421200a476440ec14ce231bcf922f7248",
            "created_at": "2024-12-22T03:09:40Z",
            "diff_hunk": "@@ -409,6 +428,46 @@ function LanguageTree:_add_injections()\n   return query_time\n end\n \n+--- Run an asynchronous parse, calling {on_parse} when complete.\n+---\n+--- @param range boolean|Range|nil\n+--- @param on_parse fun(trees: TSTrees)\n+function LanguageTree:_async_parse(range, on_parse)\n+  coroutine.resume(\n+    --- @param co_range boolean|Range|nil\n+    --- @param co_cb fun(trees: TSTrees)\n+    coroutine.create(function(co_range, co_cb)\n+      local co = coroutine.running()\n+      local ct = self:_buf().changedtick\n+      local unfinished = true\n+      --- @type TSTrees\n+      local trees\n+\n+      while unfinished do",
            "html_url": "https://github.com/neovim/neovim/pull/31631#discussion_r1894747953",
            "id": 1894747953,
            "in_reply_to_id": 1894652582,
            "line": null,
            "node_id": "PRRC_kwDOAPphoM5w748x",
            "original_commit_id": "733dddd6cf742fc06d8e369f78f665c170fa1eef",
            "original_line": 446,
            "original_position": 108,
            "original_start_line": null,
            "path": "runtime/lua/vim/treesitter/languagetree.lua",
            "position": null,
            "pull_request_review_id": 2519539301,
            "pull_request_url": "https://api.github.com/repos/neovim/neovim/pulls/31631",
            "reactions": {
                "+1": 0,
                "-1": 0,
                "confused": 0,
                "eyes": 0,
                "heart": 0,
                "hooray": 0,
                "laugh": 0,
                "rocket": 0,
                "total_count": 0,
                "url": "https://api.github.com/repos/neovim/neovim/pulls/comments/1894747953/reactions"
            },
            "side": "RIGHT",
            "start_line": null,
            "start_side": null,
            "subject_type": "line",
            "updated_at": "2024-12-22T03:09:47Z",
            "url": "https://api.github.com/repos/neovim/neovim/pulls/comments/1894747953",
            "user": {
                "avatar_url": "https://avatars.githubusercontent.com/u/65824523?v=4",
                "events_url": "https://api.github.com/users/vanaigr/events{/privacy}",
                "followers_url": "https://api.github.com/users/vanaigr/followers",
                "following_url": "https://api.github.com/users/vanaigr/following{/other_user}",
                "gists_url": "https://api.github.com/users/vanaigr/gists{/gist_id}",
                "gravatar_id": "",
                "html_url": "https://github.com/vanaigr",
                "id": 65824523,
                "login": "vanaigr",
                "node_id": "MDQ6VXNlcjY1ODI0NTIz",
                "organizations_url": "https://api.github.com/users/vanaigr/orgs",
                "received_events_url": "https://api.github.com/users/vanaigr/received_events",
                "repos_url": "https://api.github.com/users/vanaigr/repos",
                "site_admin": false,
                "starred_url": "https://api.github.com/users/vanaigr/starred{/owner}{/repo}",
                "subscriptions_url": "https://api.github.com/users/vanaigr/subscriptions",
                "type": "User",
                "url": "https://api.github.com/users/vanaigr",
                "user_view_type": "public"
            }
        },
        {
            "_links": {
                "html": {
                    "href": "https://github.com/neovim/neovim/pull/31631#discussion_r1894955052"
                },
                "pull_request": {
                    "href": "https://api.github.com/repos/neovim/neovim/pulls/31631"
                },
                "self": {
                    "href": "https://api.github.com/repos/neovim/neovim/pulls/comments/1894955052"
                }
            },
            "author_association": "MEMBER",
            "body": "Here's an implementation that doesn't use coroutines.\r\n\r\n```lua\r\n--- Run an asynchronous parse, calling {on_parse} when complete.\r\n---\r\n--- @param range boolean|Range?\r\n--- @param on_parse fun(trees?: TSTrees, err?: string)\r\nfunction LanguageTree:_async_parse(range, on_parse)\r\n  local ct = self:_buf().changedtick\r\n  local total_parse_time = 0\r\n  local redrawtime = vim.o.redrawtime\r\n\r\n  local function step()\r\n    -- If buffer was changed in the middle of parsing, reset parse state\r\n    if self:_buf().changedtick ~= ct then\r\n      self._parser:reset()\r\n      self:invalidate()\r\n      ct = self:_buf().changedtick\r\n      total_parse_time = 0\r\n    end\r\n\r\n    local parse_time, trees, finished = tcall(self._parse, self, range, default_parse_timeout_ms)\r\n    total_parse_time = total_parse_time + parse_time\r\n\r\n    if finished then\r\n      on_parse(trees)\r\n    elseif total_parse_time > redrawtime then\r\n      on_parse(nil, 'TIMEOUT')\r\n    else\r\n      vim.schedule(step)\r\n    end\r\n  end\r\n\r\n  step()\r\nend\r\n```\r\n\r\nNote I've changes the signature of `on_parse` to match the UV style more.",
            "commit_id": "c885db4421200a476440ec14ce231bcf922f7248",
            "created_at": "2024-12-22T14:40:25Z",
            "diff_hunk": "@@ -409,6 +428,46 @@ function LanguageTree:_add_injections()\n   return query_time\n end\n \n+--- Run an asynchronous parse, calling {on_parse} when complete.\n+---\n+--- @param range boolean|Range|nil\n+--- @param on_parse fun(trees: TSTrees)\n+function LanguageTree:_async_parse(range, on_parse)\n+  coroutine.resume(\n+    --- @param co_range boolean|Range|nil\n+    --- @param co_cb fun(trees: TSTrees)\n+    coroutine.create(function(co_range, co_cb)\n+      local co = coroutine.running()\n+      local ct = self:_buf().changedtick\n+      local unfinished = true\n+      --- @type TSTrees\n+      local trees\n+\n+      while unfinished do\n+        -- If buffer was changed in the middle of parsing, reset parse state\n+        if self:_buf().changedtick ~= ct then\n+          self._parser:reset()\n+          self:invalidate()\n+          coroutine.yield()\n+        end\n+\n+        trees, unfinished = self:_parse(co_range, default_parse_timeout_ms)\n+\n+        if unfinished then\n+          vim.schedule(function()\n+            coroutine.resume(co)\n+          end)\n+          coroutine.yield()\n+        else\n+          co_cb(trees)",
            "html_url": "https://github.com/neovim/neovim/pull/31631#discussion_r1894955052",
            "id": 1894955052,
            "in_reply_to_id": 1894652410,
            "line": null,
            "node_id": "PRRC_kwDOAPphoM5w8rgs",
            "original_commit_id": "733dddd6cf742fc06d8e369f78f665c170fa1eef",
            "original_line": 462,
            "original_position": 124,
            "original_start_line": null,
            "path": "runtime/lua/vim/treesitter/languagetree.lua",
            "position": null,
            "pull_request_review_id": 2519643854,
            "pull_request_url": "https://api.github.com/repos/neovim/neovim/pulls/31631",
            "reactions": {
                "+1": 0,
                "-1": 0,
                "confused": 0,
                "eyes": 0,
                "heart": 0,
                "hooray": 0,
                "laugh": 0,
                "rocket": 1,
                "total_count": 1,
                "url": "https://api.github.com/repos/neovim/neovim/pulls/comments/1894955052/reactions"
            },
            "side": "RIGHT",
            "start_line": null,
            "start_side": null,
            "subject_type": "line",
            "updated_at": "2024-12-22T15:17:06Z",
            "url": "https://api.github.com/repos/neovim/neovim/pulls/comments/1894955052",
            "user": {
                "avatar_url": "https://avatars.githubusercontent.com/u/7904185?v=4",
                "events_url": "https://api.github.com/users/lewis6991/events{/privacy}",
                "followers_url": "https://api.github.com/users/lewis6991/followers",
                "following_url": "https://api.github.com/users/lewis6991/following{/other_user}",
                "gists_url": "https://api.github.com/users/lewis6991/gists{/gist_id}",
                "gravatar_id": "",
                "html_url": "https://github.com/lewis6991",
                "id": 7904185,
                "login": "lewis6991",
                "node_id": "MDQ6VXNlcjc5MDQxODU=",
                "organizations_url": "https://api.github.com/users/lewis6991/orgs",
                "received_events_url": "https://api.github.com/users/lewis6991/received_events",
                "repos_url": "https://api.github.com/users/lewis6991/repos",
                "site_admin": false,
                "starred_url": "https://api.github.com/users/lewis6991/starred{/owner}{/repo}",
                "subscriptions_url": "https://api.github.com/users/lewis6991/subscriptions",
                "type": "User",
                "url": "https://api.github.com/users/lewis6991",
                "user_view_type": "public"
            }
        },
        {
            "_links": {
                "html": {
                    "href": "https://github.com/neovim/neovim/pull/31631#discussion_r1894955580"
                },
                "pull_request": {
                    "href": "https://api.github.com/repos/neovim/neovim/pulls/31631"
                },
                "self": {
                    "href": "https://api.github.com/repos/neovim/neovim/pulls/comments/1894955580"
                }
            },
            "author_association": "MEMBER",
            "body": "See https://github.com/neovim/neovim/pull/31631#discussion_r1894955052",
            "commit_id": "c885db4421200a476440ec14ce231bcf922f7248",
            "created_at": "2024-12-22T14:41:57Z",
            "diff_hunk": "@@ -409,6 +428,46 @@ function LanguageTree:_add_injections()\n   return query_time\n end\n \n+--- Run an asynchronous parse, calling {on_parse} when complete.\n+---\n+--- @param range boolean|Range|nil\n+--- @param on_parse fun(trees: TSTrees)\n+function LanguageTree:_async_parse(range, on_parse)\n+  coroutine.resume(\n+    --- @param co_range boolean|Range|nil\n+    --- @param co_cb fun(trees: TSTrees)\n+    coroutine.create(function(co_range, co_cb)",
            "html_url": "https://github.com/neovim/neovim/pull/31631#discussion_r1894955580",
            "id": 1894955580,
            "in_reply_to_id": 1894652869,
            "line": null,
            "node_id": "PRRC_kwDOAPphoM5w8ro8",
            "original_commit_id": "733dddd6cf742fc06d8e369f78f665c170fa1eef",
            "original_line": 439,
            "original_position": 101,
            "original_start_line": null,
            "path": "runtime/lua/vim/treesitter/languagetree.lua",
            "position": null,
            "pull_request_review_id": 2519644209,
            "pull_request_url": "https://api.github.com/repos/neovim/neovim/pulls/31631",
            "reactions": {
                "+1": 0,
                "-1": 0,
                "confused": 0,
                "eyes": 0,
                "heart": 0,
                "hooray": 0,
                "laugh": 0,
                "rocket": 0,
                "total_count": 0,
                "url": "https://api.github.com/repos/neovim/neovim/pulls/comments/1894955580/reactions"
            },
            "side": "RIGHT",
            "start_line": null,
            "start_side": null,
            "subject_type": "line",
            "updated_at": "2024-12-22T14:41:57Z",
            "url": "https://api.github.com/repos/neovim/neovim/pulls/comments/1894955580",
            "user": {
                "avatar_url": "https://avatars.githubusercontent.com/u/7904185?v=4",
                "events_url": "https://api.github.com/users/lewis6991/events{/privacy}",
                "followers_url": "https://api.github.com/users/lewis6991/followers",
                "following_url": "https://api.github.com/users/lewis6991/following{/other_user}",
                "gists_url": "https://api.github.com/users/lewis6991/gists{/gist_id}",
                "gravatar_id": "",
                "html_url": "https://github.com/lewis6991",
                "id": 7904185,
                "login": "lewis6991",
                "node_id": "MDQ6VXNlcjc5MDQxODU=",
                "organizations_url": "https://api.github.com/users/lewis6991/orgs",
                "received_events_url": "https://api.github.com/users/lewis6991/received_events",
                "repos_url": "https://api.github.com/users/lewis6991/repos",
                "site_admin": false,
                "starred_url": "https://api.github.com/users/lewis6991/starred{/owner}{/repo}",
                "subscriptions_url": "https://api.github.com/users/lewis6991/subscriptions",
                "type": "User",
                "url": "https://api.github.com/users/lewis6991",
                "user_view_type": "public"
            }
        },
        {
            "_links": {
                "html": {
                    "href": "https://github.com/neovim/neovim/pull/31631#discussion_r1894970989"
                },
                "pull_request": {
                    "href": "https://api.github.com/repos/neovim/neovim/pulls/31631"
                },
                "self": {
                    "href": "https://api.github.com/repos/neovim/neovim/pulls/comments/1894970989"
                }
            },
            "author_association": "MEMBER",
            "body": "> Parsing a file even for 2 seconds is barely noticeable\r\n\r\nFair point, but nevertheless if a parse takes >2 seconds this is not something we should casually accept. So for now, 'redrawtime' is a reasonable limit.",
            "commit_id": "c885db4421200a476440ec14ce231bcf922f7248",
            "created_at": "2024-12-22T15:32:19Z",
            "diff_hunk": "@@ -409,6 +428,46 @@ function LanguageTree:_add_injections()\n   return query_time\n end\n \n+--- Run an asynchronous parse, calling {on_parse} when complete.\n+---\n+--- @param range boolean|Range|nil\n+--- @param on_parse fun(trees: TSTrees)\n+function LanguageTree:_async_parse(range, on_parse)\n+  coroutine.resume(\n+    --- @param co_range boolean|Range|nil\n+    --- @param co_cb fun(trees: TSTrees)\n+    coroutine.create(function(co_range, co_cb)\n+      local co = coroutine.running()\n+      local ct = self:_buf().changedtick\n+      local unfinished = true\n+      --- @type TSTrees\n+      local trees\n+\n+      while unfinished do",
            "html_url": "https://github.com/neovim/neovim/pull/31631#discussion_r1894970989",
            "id": 1894970989,
            "in_reply_to_id": 1894652582,
            "line": null,
            "node_id": "PRRC_kwDOAPphoM5w8vZt",
            "original_commit_id": "733dddd6cf742fc06d8e369f78f665c170fa1eef",
            "original_line": 446,
            "original_position": 108,
            "original_start_line": null,
            "path": "runtime/lua/vim/treesitter/languagetree.lua",
            "position": null,
            "pull_request_review_id": 2519653576,
            "pull_request_url": "https://api.github.com/repos/neovim/neovim/pulls/31631",
            "reactions": {
                "+1": 0,
                "-1": 0,
                "confused": 0,
                "eyes": 0,
                "heart": 0,
                "hooray": 0,
                "laugh": 0,
                "rocket": 0,
                "total_count": 0,
                "url": "https://api.github.com/repos/neovim/neovim/pulls/comments/1894970989/reactions"
            },
            "side": "RIGHT",
            "start_line": null,
            "start_side": null,
            "subject_type": "line",
            "updated_at": "2024-12-22T15:32:34Z",
            "url": "https://api.github.com/repos/neovim/neovim/pulls/comments/1894970989",
            "user": {
                "avatar_url": "https://avatars.githubusercontent.com/u/1359421?v=4",
                "events_url": "https://api.github.com/users/justinmk/events{/privacy}",
                "followers_url": "https://api.github.com/users/justinmk/followers",
                "following_url": "https://api.github.com/users/justinmk/following{/other_user}",
                "gists_url": "https://api.github.com/users/justinmk/gists{/gist_id}",
                "gravatar_id": "",
                "html_url": "https://github.com/justinmk",
                "id": 1359421,
                "login": "justinmk",
                "node_id": "MDQ6VXNlcjEzNTk0MjE=",
                "organizations_url": "https://api.github.com/users/justinmk/orgs",
                "received_events_url": "https://api.github.com/users/justinmk/received_events",
                "repos_url": "https://api.github.com/users/justinmk/repos",
                "site_admin": false,
                "starred_url": "https://api.github.com/users/justinmk/starred{/owner}{/repo}",
                "subscriptions_url": "https://api.github.com/users/justinmk/subscriptions",
                "type": "User",
                "url": "https://api.github.com/users/justinmk",
                "user_view_type": "public"
            }
        },
        {
            "_links": {
                "html": {
                    "href": "https://github.com/neovim/neovim/pull/31631#discussion_r1894996174"
                },
                "pull_request": {
                    "href": "https://api.github.com/repos/neovim/neovim/pulls/31631"
                },
                "self": {
                    "href": "https://api.github.com/repos/neovim/neovim/pulls/comments/1894996174"
                }
            },
            "author_association": "MEMBER",
            "body": "```suggestion\r\n--- @private\r\nfunction LanguageTree:_buf()\r\n```",
            "commit_id": "c885db4421200a476440ec14ce231bcf922f7248",
            "created_at": "2024-12-22T17:03:14Z",
            "diff_hunk": "@@ -98,6 +102,10 @@ local LanguageTree = {}\n \n LanguageTree.__index = LanguageTree\n \n+function LanguageTree:_buf()",
            "html_url": "https://github.com/neovim/neovim/pull/31631#discussion_r1894996174",
            "id": 1894996174,
            "line": 104,
            "node_id": "PRRC_kwDOAPphoM5w81jO",
            "original_commit_id": "7cfba422a89936daf7ba887a07e707b76dae6e6c",
            "original_line": 104,
            "original_position": 31,
            "original_start_line": null,
            "path": "runtime/lua/vim/treesitter/languagetree.lua",
            "position": 14,
            "pull_request_review_id": 2519668310,
            "pull_request_url": "https://api.github.com/repos/neovim/neovim/pulls/31631",
            "reactions": {
                "+1": 1,
                "-1": 0,
                "confused": 0,
                "eyes": 0,
                "heart": 0,
                "hooray": 0,
                "laugh": 0,
                "rocket": 0,
                "total_count": 1,
                "url": "https://api.github.com/repos/neovim/neovim/pulls/comments/1894996174/reactions"
            },
            "side": "RIGHT",
            "start_line": null,
            "start_side": null,
            "subject_type": "line",
            "updated_at": "2024-12-22T17:18:43Z",
            "url": "https://api.github.com/repos/neovim/neovim/pulls/comments/1894996174",
            "user": {
                "avatar_url": "https://avatars.githubusercontent.com/u/7904185?v=4",
                "events_url": "https://api.github.com/users/lewis6991/events{/privacy}",
                "followers_url": "https://api.github.com/users/lewis6991/followers",
                "following_url": "https://api.github.com/users/lewis6991/following{/other_user}",
                "gists_url": "https://api.github.com/users/lewis6991/gists{/gist_id}",
                "gravatar_id": "",
                "html_url": "https://github.com/lewis6991",
                "id": 7904185,
                "login": "lewis6991",
                "node_id": "MDQ6VXNlcjc5MDQxODU=",
                "organizations_url": "https://api.github.com/users/lewis6991/orgs",
                "received_events_url": "https://api.github.com/users/lewis6991/received_events",
                "repos_url": "https://api.github.com/users/lewis6991/repos",
                "site_admin": false,
                "starred_url": "https://api.github.com/users/lewis6991/starred{/owner}{/repo}",
                "subscriptions_url": "https://api.github.com/users/lewis6991/subscriptions",
                "type": "User",
                "url": "https://api.github.com/users/lewis6991",
                "user_view_type": "public"
            }
        },
        {
            "_links": {
                "html": {
                    "href": "https://github.com/neovim/neovim/pull/31631#discussion_r1894996407"
                },
                "pull_request": {
                    "href": "https://api.github.com/repos/neovim/neovim/pulls/31631"
                },
                "self": {
                    "href": "https://api.github.com/repos/neovim/neovim/pulls/comments/1894996407"
                }
            },
            "author_association": "MEMBER",
            "body": "Awesome, super cool that you got this working without coroutines, I couldn't figure it out myself.\r\n\r\nOne thing to bring up: do you think it's fine to have the tcall here as a time measurement? This will account for e.g. the slow injection processing taking ~1.5 seconds for the big linux file, whereas the parse time would still be on average 3ms. Before I had each iteration only add the parse timeout so as to not skew the time from other processing noise. Do you think we should include this additional timing data?",
            "commit_id": "c885db4421200a476440ec14ce231bcf922f7248",
            "created_at": "2024-12-22T17:04:01Z",
            "diff_hunk": "@@ -409,6 +428,46 @@ function LanguageTree:_add_injections()\n   return query_time\n end\n \n+--- Run an asynchronous parse, calling {on_parse} when complete.\n+---\n+--- @param range boolean|Range|nil\n+--- @param on_parse fun(trees: TSTrees)\n+function LanguageTree:_async_parse(range, on_parse)\n+  coroutine.resume(\n+    --- @param co_range boolean|Range|nil\n+    --- @param co_cb fun(trees: TSTrees)\n+    coroutine.create(function(co_range, co_cb)\n+      local co = coroutine.running()\n+      local ct = self:_buf().changedtick\n+      local unfinished = true\n+      --- @type TSTrees\n+      local trees\n+\n+      while unfinished do\n+        -- If buffer was changed in the middle of parsing, reset parse state\n+        if self:_buf().changedtick ~= ct then\n+          self._parser:reset()\n+          self:invalidate()\n+          coroutine.yield()\n+        end\n+\n+        trees, unfinished = self:_parse(co_range, default_parse_timeout_ms)\n+\n+        if unfinished then\n+          vim.schedule(function()\n+            coroutine.resume(co)\n+          end)\n+          coroutine.yield()\n+        else\n+          co_cb(trees)",
            "html_url": "https://github.com/neovim/neovim/pull/31631#discussion_r1894996407",
            "id": 1894996407,
            "in_reply_to_id": 1894652410,
            "line": null,
            "node_id": "PRRC_kwDOAPphoM5w81m3",
            "original_commit_id": "733dddd6cf742fc06d8e369f78f665c170fa1eef",
            "original_line": 462,
            "original_position": 124,
            "original_start_line": null,
            "path": "runtime/lua/vim/treesitter/languagetree.lua",
            "position": null,
            "pull_request_review_id": 2519668426,
            "pull_request_url": "https://api.github.com/repos/neovim/neovim/pulls/31631",
            "reactions": {
                "+1": 0,
                "-1": 0,
                "confused": 0,
                "eyes": 0,
                "heart": 0,
                "hooray": 0,
                "laugh": 0,
                "rocket": 0,
                "total_count": 0,
                "url": "https://api.github.com/repos/neovim/neovim/pulls/comments/1894996407/reactions"
            },
            "side": "RIGHT",
            "start_line": null,
            "start_side": null,
            "subject_type": "line",
            "updated_at": "2024-12-22T17:11:25Z",
            "url": "https://api.github.com/repos/neovim/neovim/pulls/comments/1894996407",
            "user": {
                "avatar_url": "https://avatars.githubusercontent.com/u/55766287?v=4",
                "events_url": "https://api.github.com/users/ribru17/events{/privacy}",
                "followers_url": "https://api.github.com/users/ribru17/followers",
                "following_url": "https://api.github.com/users/ribru17/following{/other_user}",
                "gists_url": "https://api.github.com/users/ribru17/gists{/gist_id}",
                "gravatar_id": "",
                "html_url": "https://github.com/ribru17",
                "id": 55766287,
                "login": "ribru17",
                "node_id": "MDQ6VXNlcjU1NzY2Mjg3",
                "organizations_url": "https://api.github.com/users/ribru17/orgs",
                "received_events_url": "https://api.github.com/users/ribru17/received_events",
                "repos_url": "https://api.github.com/users/ribru17/repos",
                "site_admin": false,
                "starred_url": "https://api.github.com/users/ribru17/starred{/owner}{/repo}",
                "subscriptions_url": "https://api.github.com/users/ribru17/subscriptions",
                "type": "User",
                "url": "https://api.github.com/users/ribru17",
                "user_view_type": "public"
            }
        },
        {
            "_links": {
                "html": {
                    "href": "https://github.com/neovim/neovim/pull/31631#discussion_r1894996452"
                },
                "pull_request": {
                    "href": "https://api.github.com/repos/neovim/neovim/pulls/31631"
                },
                "self": {
                    "href": "https://api.github.com/repos/neovim/neovim/pulls/comments/1894996452"
                }
            },
            "author_association": "MEMBER",
            "body": "I'd prefer if we remove this alias if that's ok?\r\n\r\nWe need to rename all the ts types anyway so they have a `vim.treesitter.*` prefix.",
            "commit_id": "c885db4421200a476440ec14ce231bcf922f7248",
            "created_at": "2024-12-22T17:04:08Z",
            "diff_hunk": "@@ -58,6 +60,8 @@ local Range = require('vim.treesitter._range')\n ---| 'on_child_added'\n ---| 'on_child_removed'\n \n+---@alias TSTrees table<integer, TSTree>",
            "html_url": "https://github.com/neovim/neovim/pull/31631#discussion_r1894996452",
            "id": 1894996452,
            "line": null,
            "node_id": "PRRC_kwDOAPphoM5w81nk",
            "original_commit_id": "7cfba422a89936daf7ba887a07e707b76dae6e6c",
            "original_line": 63,
            "original_position": 13,
            "original_start_line": null,
            "path": "runtime/lua/vim/treesitter/languagetree.lua",
            "position": null,
            "pull_request_review_id": 2519668310,
            "pull_request_url": "https://api.github.com/repos/neovim/neovim/pulls/31631",
            "reactions": {
                "+1": 1,
                "-1": 0,
                "confused": 0,
                "eyes": 0,
                "heart": 0,
                "hooray": 0,
                "laugh": 0,
                "rocket": 0,
                "total_count": 1,
                "url": "https://api.github.com/repos/neovim/neovim/pulls/comments/1894996452/reactions"
            },
            "side": "RIGHT",
            "start_line": null,
            "start_side": null,
            "subject_type": "line",
            "updated_at": "2024-12-22T17:19:39Z",
            "url": "https://api.github.com/repos/neovim/neovim/pulls/comments/1894996452",
            "user": {
                "avatar_url": "https://avatars.githubusercontent.com/u/7904185?v=4",
                "events_url": "https://api.github.com/users/lewis6991/events{/privacy}",
                "followers_url": "https://api.github.com/users/lewis6991/followers",
                "following_url": "https://api.github.com/users/lewis6991/following{/other_user}",
                "gists_url": "https://api.github.com/users/lewis6991/gists{/gist_id}",
                "gravatar_id": "",
                "html_url": "https://github.com/lewis6991",
                "id": 7904185,
                "login": "lewis6991",
                "node_id": "MDQ6VXNlcjc5MDQxODU=",
                "organizations_url": "https://api.github.com/users/lewis6991/orgs",
                "received_events_url": "https://api.github.com/users/lewis6991/received_events",
                "repos_url": "https://api.github.com/users/lewis6991/repos",
                "site_admin": false,
                "starred_url": "https://api.github.com/users/lewis6991/starred{/owner}{/repo}",
                "subscriptions_url": "https://api.github.com/users/lewis6991/subscriptions",
                "type": "User",
                "url": "https://api.github.com/users/lewis6991",
                "user_view_type": "public"
            }
        },
        {
            "_links": {
                "html": {
                    "href": "https://github.com/neovim/neovim/pull/31631#discussion_r1894997244"
                },
                "pull_request": {
                    "href": "https://api.github.com/repos/neovim/neovim/pulls/31631"
                },
                "self": {
                    "href": "https://api.github.com/repos/neovim/neovim/pulls/comments/1894997244"
                }
            },
            "author_association": "MEMBER",
            "body": "```suggestion\r\n      self._parser:set_timeout(timeout and timeout * 1000 or 0) -- ms -> micros\r\n\r\n```",
            "commit_id": "c885db4421200a476440ec14ce231bcf922f7248",
            "created_at": "2024-12-22T17:06:19Z",
            "diff_hunk": "@@ -357,9 +367,18 @@ function LanguageTree:_parse_regions(range)\n       )\n     then\n       self._parser:set_included_ranges(ranges)\n+      if timeout then\n+        self._parser:set_timeout(timeout * 1000) -- ms -> micros\n+      else\n+        self._parser:set_timeout(0)\n+      end",
            "html_url": "https://github.com/neovim/neovim/pull/31631#discussion_r1894997244",
            "id": 1894997244,
            "line": null,
            "node_id": "PRRC_kwDOAPphoM5w81z8",
            "original_commit_id": "7cfba422a89936daf7ba887a07e707b76dae6e6c",
            "original_line": 374,
            "original_position": 69,
            "original_start_line": 370,
            "path": "runtime/lua/vim/treesitter/languagetree.lua",
            "position": null,
            "pull_request_review_id": 2519668310,
            "pull_request_url": "https://api.github.com/repos/neovim/neovim/pulls/31631",
            "reactions": {
                "+1": 1,
                "-1": 0,
                "confused": 0,
                "eyes": 0,
                "heart": 0,
                "hooray": 0,
                "laugh": 0,
                "rocket": 0,
                "total_count": 1,
                "url": "https://api.github.com/repos/neovim/neovim/pulls/comments/1894997244/reactions"
            },
            "side": "RIGHT",
            "start_line": null,
            "start_side": "RIGHT",
            "subject_type": "line",
            "updated_at": "2024-12-22T17:18:43Z",
            "url": "https://api.github.com/repos/neovim/neovim/pulls/comments/1894997244",
            "user": {
                "avatar_url": "https://avatars.githubusercontent.com/u/7904185?v=4",
                "events_url": "https://api.github.com/users/lewis6991/events{/privacy}",
                "followers_url": "https://api.github.com/users/lewis6991/followers",
                "following_url": "https://api.github.com/users/lewis6991/following{/other_user}",
                "gists_url": "https://api.github.com/users/lewis6991/gists{/gist_id}",
                "gravatar_id": "",
                "html_url": "https://github.com/lewis6991",
                "id": 7904185,
                "login": "lewis6991",
                "node_id": "MDQ6VXNlcjc5MDQxODU=",
                "organizations_url": "https://api.github.com/users/lewis6991/orgs",
                "received_events_url": "https://api.github.com/users/lewis6991/received_events",
                "repos_url": "https://api.github.com/users/lewis6991/repos",
                "site_admin": false,
                "starred_url": "https://api.github.com/users/lewis6991/starred{/owner}{/repo}",
                "subscriptions_url": "https://api.github.com/users/lewis6991/subscriptions",
                "type": "User",
                "url": "https://api.github.com/users/lewis6991",
                "user_view_type": "public"
            }
        },
        {
            "_links": {
                "html": {
                    "href": "https://github.com/neovim/neovim/pull/31631#discussion_r1894997406"
                },
                "pull_request": {
                    "href": "https://api.github.com/repos/neovim/neovim/pulls/31631"
                },
                "self": {
                    "href": "https://api.github.com/repos/neovim/neovim/pulls/comments/1894997406"
                }
            },
            "author_association": "MEMBER",
            "body": "I think the logic works out a bit better if you invert this (to `finished`).",
            "commit_id": "c885db4421200a476440ec14ce231bcf922f7248",
            "created_at": "2024-12-22T17:07:06Z",
            "diff_hunk": "@@ -334,10 +342,12 @@ end\n \n --- @private\n --- @param range boolean|Range?\n+--- @param timeout integer?\n --- @return Range6[] changes\n --- @return integer no_regions_parsed\n --- @return number total_parse_time\n-function LanguageTree:_parse_regions(range)\n+--- @return boolean is_unfinished whether async parsing still needs time",
            "html_url": "https://github.com/neovim/neovim/pull/31631#discussion_r1894997406",
            "id": 1894997406,
            "line": null,
            "node_id": "PRRC_kwDOAPphoM5w812e",
            "original_commit_id": "7cfba422a89936daf7ba887a07e707b76dae6e6c",
            "original_line": 349,
            "original_position": 56,
            "original_start_line": null,
            "path": "runtime/lua/vim/treesitter/languagetree.lua",
            "position": null,
            "pull_request_review_id": 2519668310,
            "pull_request_url": "https://api.github.com/repos/neovim/neovim/pulls/31631",
            "reactions": {
                "+1": 1,
                "-1": 0,
                "confused": 0,
                "eyes": 0,
                "heart": 0,
                "hooray": 0,
                "laugh": 0,
                "rocket": 0,
                "total_count": 1,
                "url": "https://api.github.com/repos/neovim/neovim/pulls/comments/1894997406/reactions"
            },
            "side": "RIGHT",
            "start_line": null,
            "start_side": null,
            "subject_type": "line",
            "updated_at": "2024-12-22T17:18:44Z",
            "url": "https://api.github.com/repos/neovim/neovim/pulls/comments/1894997406",
            "user": {
                "avatar_url": "https://avatars.githubusercontent.com/u/7904185?v=4",
                "events_url": "https://api.github.com/users/lewis6991/events{/privacy}",
                "followers_url": "https://api.github.com/users/lewis6991/followers",
                "following_url": "https://api.github.com/users/lewis6991/following{/other_user}",
                "gists_url": "https://api.github.com/users/lewis6991/gists{/gist_id}",
                "gravatar_id": "",
                "html_url": "https://github.com/lewis6991",
                "id": 7904185,
                "login": "lewis6991",
                "node_id": "MDQ6VXNlcjc5MDQxODU=",
                "organizations_url": "https://api.github.com/users/lewis6991/orgs",
                "received_events_url": "https://api.github.com/users/lewis6991/received_events",
                "repos_url": "https://api.github.com/users/lewis6991/repos",
                "site_admin": false,
                "starred_url": "https://api.github.com/users/lewis6991/starred{/owner}{/repo}",
                "subscriptions_url": "https://api.github.com/users/lewis6991/subscriptions",
                "type": "User",
                "url": "https://api.github.com/users/lewis6991",
                "user_view_type": "public"
            }
        },
        {
            "_links": {
                "html": {
                    "href": "https://github.com/neovim/neovim/pull/31631#discussion_r1894997647"
                },
                "pull_request": {
                    "href": "https://api.github.com/repos/neovim/neovim/pulls/31631"
                },
                "self": {
                    "href": "https://api.github.com/repos/neovim/neovim/pulls/comments/1894997647"
                }
            },
            "author_association": "MEMBER",
            "body": "This `yield` looks wrong to me since we don't `resume` before. I would have thought this works properly without the yields.",
            "commit_id": "c885db4421200a476440ec14ce231bcf922f7248",
            "created_at": "2024-12-22T17:08:08Z",
            "diff_hunk": "@@ -409,6 +428,45 @@ function LanguageTree:_add_injections()\n   return query_time\n end\n \n+--- Run an asynchronous parse, calling {on_parse} when complete.\n+---\n+--- @param range boolean|Range|nil\n+--- @param on_parse fun(trees: TSTrees, timeout_expired: boolean)\n+function LanguageTree:_async_parse(range, on_parse)\n+  coroutine.resume(coroutine.create(function()\n+    local co = coroutine.running()\n+    local ct = self:_buf().changedtick\n+    local total_parse_time = 0\n+    local redrawtime = vim.o.redrawtime\n+    ---@type TSTrees, boolean\n+    local trees, unfinished\n+\n+    while total_parse_time <= redrawtime do\n+      -- If buffer was changed in the middle of parsing, reset parse state\n+      if self:_buf().changedtick ~= ct then\n+        self._parser:reset()\n+        self:invalidate()\n+        total_parse_time = 0\n+        coroutine.yield()",
            "html_url": "https://github.com/neovim/neovim/pull/31631#discussion_r1894997647",
            "id": 1894997647,
            "line": null,
            "node_id": "PRRC_kwDOAPphoM5w816P",
            "original_commit_id": "7cfba422a89936daf7ba887a07e707b76dae6e6c",
            "original_line": 450,
            "original_position": 112,
            "original_start_line": null,
            "path": "runtime/lua/vim/treesitter/languagetree.lua",
            "position": null,
            "pull_request_review_id": 2519668310,
            "pull_request_url": "https://api.github.com/repos/neovim/neovim/pulls/31631",
            "reactions": {
                "+1": 0,
                "-1": 0,
                "confused": 0,
                "eyes": 1,
                "heart": 0,
                "hooray": 0,
                "laugh": 0,
                "rocket": 0,
                "total_count": 1,
                "url": "https://api.github.com/repos/neovim/neovim/pulls/comments/1894997647/reactions"
            },
            "side": "RIGHT",
            "start_line": null,
            "start_side": null,
            "subject_type": "line",
            "updated_at": "2024-12-22T17:18:44Z",
            "url": "https://api.github.com/repos/neovim/neovim/pulls/comments/1894997647",
            "user": {
                "avatar_url": "https://avatars.githubusercontent.com/u/7904185?v=4",
                "events_url": "https://api.github.com/users/lewis6991/events{/privacy}",
                "followers_url": "https://api.github.com/users/lewis6991/followers",
                "following_url": "https://api.github.com/users/lewis6991/following{/other_user}",
                "gists_url": "https://api.github.com/users/lewis6991/gists{/gist_id}",
                "gravatar_id": "",
                "html_url": "https://github.com/lewis6991",
                "id": 7904185,
                "login": "lewis6991",
                "node_id": "MDQ6VXNlcjc5MDQxODU=",
                "organizations_url": "https://api.github.com/users/lewis6991/orgs",
                "received_events_url": "https://api.github.com/users/lewis6991/received_events",
                "repos_url": "https://api.github.com/users/lewis6991/repos",
                "site_admin": false,
                "starred_url": "https://api.github.com/users/lewis6991/starred{/owner}{/repo}",
                "subscriptions_url": "https://api.github.com/users/lewis6991/subscriptions",
                "type": "User",
                "url": "https://api.github.com/users/lewis6991",
                "user_view_type": "public"
            }
        },
        {
            "_links": {
                "html": {
                    "href": "https://github.com/neovim/neovim/pull/31631#discussion_r1894997842"
                },
                "pull_request": {
                    "href": "https://api.github.com/repos/neovim/neovim/pulls/31631"
                },
                "self": {
                    "href": "https://api.github.com/repos/neovim/neovim/pulls/comments/1894997842"
                }
            },
            "author_association": "MEMBER",
            "body": "We should add the time it actually took to parse rather than adding the timeout value. We can use `tcall()` for that.",
            "commit_id": "c885db4421200a476440ec14ce231bcf922f7248",
            "created_at": "2024-12-22T17:08:47Z",
            "diff_hunk": "@@ -409,6 +428,45 @@ function LanguageTree:_add_injections()\n   return query_time\n end\n \n+--- Run an asynchronous parse, calling {on_parse} when complete.\n+---\n+--- @param range boolean|Range|nil\n+--- @param on_parse fun(trees: TSTrees, timeout_expired: boolean)\n+function LanguageTree:_async_parse(range, on_parse)\n+  coroutine.resume(coroutine.create(function()\n+    local co = coroutine.running()\n+    local ct = self:_buf().changedtick\n+    local total_parse_time = 0\n+    local redrawtime = vim.o.redrawtime\n+    ---@type TSTrees, boolean\n+    local trees, unfinished\n+\n+    while total_parse_time <= redrawtime do\n+      -- If buffer was changed in the middle of parsing, reset parse state\n+      if self:_buf().changedtick ~= ct then\n+        self._parser:reset()\n+        self:invalidate()\n+        total_parse_time = 0\n+        coroutine.yield()\n+      end\n+\n+      trees, unfinished = self:_parse(range, default_parse_timeout_ms)\n+      total_parse_time = total_parse_time + default_parse_timeout_ms",
            "html_url": "https://github.com/neovim/neovim/pull/31631#discussion_r1894997842",
            "id": 1894997842,
            "line": null,
            "node_id": "PRRC_kwDOAPphoM5w819S",
            "original_commit_id": "7cfba422a89936daf7ba887a07e707b76dae6e6c",
            "original_line": 454,
            "original_position": 116,
            "original_start_line": null,
            "path": "runtime/lua/vim/treesitter/languagetree.lua",
            "position": null,
            "pull_request_review_id": 2519668310,
            "pull_request_url": "https://api.github.com/repos/neovim/neovim/pulls/31631",
            "reactions": {
                "+1": 0,
                "-1": 0,
                "confused": 0,
                "eyes": 0,
                "heart": 0,
                "hooray": 0,
                "laugh": 0,
                "rocket": 0,
                "total_count": 0,
                "url": "https://api.github.com/repos/neovim/neovim/pulls/comments/1894997842/reactions"
            },
            "side": "RIGHT",
            "start_line": null,
            "start_side": null,
            "subject_type": "line",
            "updated_at": "2024-12-22T17:18:44Z",
            "url": "https://api.github.com/repos/neovim/neovim/pulls/comments/1894997842",
            "user": {
                "avatar_url": "https://avatars.githubusercontent.com/u/7904185?v=4",
                "events_url": "https://api.github.com/users/lewis6991/events{/privacy}",
                "followers_url": "https://api.github.com/users/lewis6991/followers",
                "following_url": "https://api.github.com/users/lewis6991/following{/other_user}",
                "gists_url": "https://api.github.com/users/lewis6991/gists{/gist_id}",
                "gravatar_id": "",
                "html_url": "https://github.com/lewis6991",
                "id": 7904185,
                "login": "lewis6991",
                "node_id": "MDQ6VXNlcjc5MDQxODU=",
                "organizations_url": "https://api.github.com/users/lewis6991/orgs",
                "received_events_url": "https://api.github.com/users/lewis6991/received_events",
                "repos_url": "https://api.github.com/users/lewis6991/repos",
                "site_admin": false,
                "starred_url": "https://api.github.com/users/lewis6991/starred{/owner}{/repo}",
                "subscriptions_url": "https://api.github.com/users/lewis6991/subscriptions",
                "type": "User",
                "url": "https://api.github.com/users/lewis6991",
                "user_view_type": "public"
            }
        },
        {
            "_links": {
                "html": {
                    "href": "https://github.com/neovim/neovim/pull/31631#discussion_r1895002474"
                },
                "pull_request": {
                    "href": "https://api.github.com/repos/neovim/neovim/pulls/31631"
                },
                "self": {
                    "href": "https://api.github.com/repos/neovim/neovim/pulls/comments/1895002474"
                }
            },
            "author_association": "MEMBER",
            "body": "I had a question about this actually, in [this comment](https://github.com/neovim/neovim/pull/31631#discussion_r1894996407)",
            "commit_id": "c885db4421200a476440ec14ce231bcf922f7248",
            "created_at": "2024-12-22T17:27:00Z",
            "diff_hunk": "@@ -409,6 +428,45 @@ function LanguageTree:_add_injections()\n   return query_time\n end\n \n+--- Run an asynchronous parse, calling {on_parse} when complete.\n+---\n+--- @param range boolean|Range|nil\n+--- @param on_parse fun(trees: TSTrees, timeout_expired: boolean)\n+function LanguageTree:_async_parse(range, on_parse)\n+  coroutine.resume(coroutine.create(function()\n+    local co = coroutine.running()\n+    local ct = self:_buf().changedtick\n+    local total_parse_time = 0\n+    local redrawtime = vim.o.redrawtime\n+    ---@type TSTrees, boolean\n+    local trees, unfinished\n+\n+    while total_parse_time <= redrawtime do\n+      -- If buffer was changed in the middle of parsing, reset parse state\n+      if self:_buf().changedtick ~= ct then\n+        self._parser:reset()\n+        self:invalidate()\n+        total_parse_time = 0\n+        coroutine.yield()\n+      end\n+\n+      trees, unfinished = self:_parse(range, default_parse_timeout_ms)\n+      total_parse_time = total_parse_time + default_parse_timeout_ms",
            "html_url": "https://github.com/neovim/neovim/pull/31631#discussion_r1895002474",
            "id": 1895002474,
            "in_reply_to_id": 1894997842,
            "line": null,
            "node_id": "PRRC_kwDOAPphoM5w83Fq",
            "original_commit_id": "7cfba422a89936daf7ba887a07e707b76dae6e6c",
            "original_line": 454,
            "original_position": 116,
            "original_start_line": null,
            "path": "runtime/lua/vim/treesitter/languagetree.lua",
            "position": null,
            "pull_request_review_id": 2519671662,
            "pull_request_url": "https://api.github.com/repos/neovim/neovim/pulls/31631",
            "reactions": {
                "+1": 0,
                "-1": 0,
                "confused": 0,
                "eyes": 0,
                "heart": 0,
                "hooray": 0,
                "laugh": 0,
                "rocket": 0,
                "total_count": 0,
                "url": "https://api.github.com/repos/neovim/neovim/pulls/comments/1895002474/reactions"
            },
            "side": "RIGHT",
            "start_line": null,
            "start_side": null,
            "subject_type": "line",
            "updated_at": "2024-12-22T17:27:01Z",
            "url": "https://api.github.com/repos/neovim/neovim/pulls/comments/1895002474",
            "user": {
                "avatar_url": "https://avatars.githubusercontent.com/u/55766287?v=4",
                "events_url": "https://api.github.com/users/ribru17/events{/privacy}",
                "followers_url": "https://api.github.com/users/ribru17/followers",
                "following_url": "https://api.github.com/users/ribru17/following{/other_user}",
                "gists_url": "https://api.github.com/users/ribru17/gists{/gist_id}",
                "gravatar_id": "",
                "html_url": "https://github.com/ribru17",
                "id": 55766287,
                "login": "ribru17",
                "node_id": "MDQ6VXNlcjU1NzY2Mjg3",
                "organizations_url": "https://api.github.com/users/ribru17/orgs",
                "received_events_url": "https://api.github.com/users/ribru17/received_events",
                "repos_url": "https://api.github.com/users/ribru17/repos",
                "site_admin": false,
                "starred_url": "https://api.github.com/users/ribru17/starred{/owner}{/repo}",
                "subscriptions_url": "https://api.github.com/users/ribru17/subscriptions",
                "type": "User",
                "url": "https://api.github.com/users/ribru17",
                "user_view_type": "public"
            }
        },
        {
            "_links": {
                "html": {
                    "href": "https://github.com/neovim/neovim/pull/31631#discussion_r1895007317"
                },
                "pull_request": {
                    "href": "https://api.github.com/repos/neovim/neovim/pulls/31631"
                },
                "self": {
                    "href": "https://api.github.com/repos/neovim/neovim/pulls/comments/1895007317"
                }
            },
            "author_association": "CONTRIBUTOR",
            "body": "Would it cause an infinite number of parses to be called if a user holds a key in a big file? \r\n\r\nThe old parser doesn't finish under 3ms and goes to the next iteration, sees that the buffer has changed, resets the state and continues to parse (instead of being suspended indefinitely). Meanwhile the new parser (called in `on_win()`) also starts to parse. And this happens every time a key is typed.\r\n",
            "commit_id": "c885db4421200a476440ec14ce231bcf922f7248",
            "created_at": "2024-12-22T17:46:57Z",
            "diff_hunk": "@@ -409,6 +428,45 @@ function LanguageTree:_add_injections()\n   return query_time\n end\n \n+--- Run an asynchronous parse, calling {on_parse} when complete.\n+---\n+--- @param range boolean|Range|nil\n+--- @param on_parse fun(trees: TSTrees, timeout_expired: boolean)\n+function LanguageTree:_async_parse(range, on_parse)\n+  coroutine.resume(coroutine.create(function()\n+    local co = coroutine.running()\n+    local ct = self:_buf().changedtick\n+    local total_parse_time = 0\n+    local redrawtime = vim.o.redrawtime\n+    ---@type TSTrees, boolean\n+    local trees, unfinished\n+\n+    while total_parse_time <= redrawtime do\n+      -- If buffer was changed in the middle of parsing, reset parse state\n+      if self:_buf().changedtick ~= ct then\n+        self._parser:reset()\n+        self:invalidate()\n+        total_parse_time = 0\n+        coroutine.yield()",
            "html_url": "https://github.com/neovim/neovim/pull/31631#discussion_r1895007317",
            "id": 1895007317,
            "in_reply_to_id": 1894997647,
            "line": null,
            "node_id": "PRRC_kwDOAPphoM5w84RV",
            "original_commit_id": "7cfba422a89936daf7ba887a07e707b76dae6e6c",
            "original_line": 450,
            "original_position": 112,
            "original_start_line": null,
            "path": "runtime/lua/vim/treesitter/languagetree.lua",
            "position": null,
            "pull_request_review_id": 2519674302,
            "pull_request_url": "https://api.github.com/repos/neovim/neovim/pulls/31631",
            "reactions": {
                "+1": 0,
                "-1": 0,
                "confused": 0,
                "eyes": 0,
                "heart": 0,
                "hooray": 0,
                "laugh": 0,
                "rocket": 0,
                "total_count": 0,
                "url": "https://api.github.com/repos/neovim/neovim/pulls/comments/1895007317/reactions"
            },
            "side": "RIGHT",
            "start_line": null,
            "start_side": null,
            "subject_type": "line",
            "updated_at": "2024-12-22T17:48:08Z",
            "url": "https://api.github.com/repos/neovim/neovim/pulls/comments/1895007317",
            "user": {
                "avatar_url": "https://avatars.githubusercontent.com/u/65824523?v=4",
                "events_url": "https://api.github.com/users/vanaigr/events{/privacy}",
                "followers_url": "https://api.github.com/users/vanaigr/followers",
                "following_url": "https://api.github.com/users/vanaigr/following{/other_user}",
                "gists_url": "https://api.github.com/users/vanaigr/gists{/gist_id}",
                "gravatar_id": "",
                "html_url": "https://github.com/vanaigr",
                "id": 65824523,
                "login": "vanaigr",
                "node_id": "MDQ6VXNlcjY1ODI0NTIz",
                "organizations_url": "https://api.github.com/users/vanaigr/orgs",
                "received_events_url": "https://api.github.com/users/vanaigr/received_events",
                "repos_url": "https://api.github.com/users/vanaigr/repos",
                "site_admin": false,
                "starred_url": "https://api.github.com/users/vanaigr/starred{/owner}{/repo}",
                "subscriptions_url": "https://api.github.com/users/vanaigr/subscriptions",
                "type": "User",
                "url": "https://api.github.com/users/vanaigr",
                "user_view_type": "public"
            }
        },
        {
            "_links": {
                "html": {
                    "href": "https://github.com/neovim/neovim/pull/31631#discussion_r1895010301"
                },
                "pull_request": {
                    "href": "https://api.github.com/repos/neovim/neovim/pulls/31631"
                },
                "self": {
                    "href": "https://api.github.com/repos/neovim/neovim/pulls/comments/1895010301"
                }
            },
            "author_association": "MEMBER",
            "body": "Yes I think we should. The goal here is to limit the amount of time parsing blocks the main thread for, so this must included everything. Just doing it for `TSParser:parse()` is just the first step.",
            "commit_id": "c885db4421200a476440ec14ce231bcf922f7248",
            "created_at": "2024-12-22T17:58:20Z",
            "diff_hunk": "@@ -409,6 +428,46 @@ function LanguageTree:_add_injections()\n   return query_time\n end\n \n+--- Run an asynchronous parse, calling {on_parse} when complete.\n+---\n+--- @param range boolean|Range|nil\n+--- @param on_parse fun(trees: TSTrees)\n+function LanguageTree:_async_parse(range, on_parse)\n+  coroutine.resume(\n+    --- @param co_range boolean|Range|nil\n+    --- @param co_cb fun(trees: TSTrees)\n+    coroutine.create(function(co_range, co_cb)\n+      local co = coroutine.running()\n+      local ct = self:_buf().changedtick\n+      local unfinished = true\n+      --- @type TSTrees\n+      local trees\n+\n+      while unfinished do\n+        -- If buffer was changed in the middle of parsing, reset parse state\n+        if self:_buf().changedtick ~= ct then\n+          self._parser:reset()\n+          self:invalidate()\n+          coroutine.yield()\n+        end\n+\n+        trees, unfinished = self:_parse(co_range, default_parse_timeout_ms)\n+\n+        if unfinished then\n+          vim.schedule(function()\n+            coroutine.resume(co)\n+          end)\n+          coroutine.yield()\n+        else\n+          co_cb(trees)",
            "html_url": "https://github.com/neovim/neovim/pull/31631#discussion_r1895010301",
            "id": 1895010301,
            "in_reply_to_id": 1894652410,
            "line": null,
            "node_id": "PRRC_kwDOAPphoM5w84_9",
            "original_commit_id": "733dddd6cf742fc06d8e369f78f665c170fa1eef",
            "original_line": 462,
            "original_position": 124,
            "original_start_line": null,
            "path": "runtime/lua/vim/treesitter/languagetree.lua",
            "position": null,
            "pull_request_review_id": 2519675777,
            "pull_request_url": "https://api.github.com/repos/neovim/neovim/pulls/31631",
            "reactions": {
                "+1": 0,
                "-1": 0,
                "confused": 0,
                "eyes": 0,
                "heart": 0,
                "hooray": 0,
                "laugh": 0,
                "rocket": 0,
                "total_count": 0,
                "url": "https://api.github.com/repos/neovim/neovim/pulls/comments/1895010301/reactions"
            },
            "side": "RIGHT",
            "start_line": null,
            "start_side": null,
            "subject_type": "line",
            "updated_at": "2024-12-22T17:58:20Z",
            "url": "https://api.github.com/repos/neovim/neovim/pulls/comments/1895010301",
            "user": {
                "avatar_url": "https://avatars.githubusercontent.com/u/7904185?v=4",
                "events_url": "https://api.github.com/users/lewis6991/events{/privacy}",
                "followers_url": "https://api.github.com/users/lewis6991/followers",
                "following_url": "https://api.github.com/users/lewis6991/following{/other_user}",
                "gists_url": "https://api.github.com/users/lewis6991/gists{/gist_id}",
                "gravatar_id": "",
                "html_url": "https://github.com/lewis6991",
                "id": 7904185,
                "login": "lewis6991",
                "node_id": "MDQ6VXNlcjc5MDQxODU=",
                "organizations_url": "https://api.github.com/users/lewis6991/orgs",
                "received_events_url": "https://api.github.com/users/lewis6991/received_events",
                "repos_url": "https://api.github.com/users/lewis6991/repos",
                "site_admin": false,
                "starred_url": "https://api.github.com/users/lewis6991/starred{/owner}{/repo}",
                "subscriptions_url": "https://api.github.com/users/lewis6991/subscriptions",
                "type": "User",
                "url": "https://api.github.com/users/lewis6991",
                "user_view_type": "public"
            }
        },
        {
            "_links": {
                "html": {
                    "href": "https://github.com/neovim/neovim/pull/31631#discussion_r1895019023"
                },
                "pull_request": {
                    "href": "https://api.github.com/repos/neovim/neovim/pulls/31631"
                },
                "self": {
                    "href": "https://api.github.com/repos/neovim/neovim/pulls/comments/1895019023"
                }
            },
            "author_association": "MEMBER",
            "body": "Pulled in the version that does not use coroutines, so this yield isn't needed",
            "commit_id": "c885db4421200a476440ec14ce231bcf922f7248",
            "created_at": "2024-12-22T18:31:11Z",
            "diff_hunk": "@@ -409,6 +428,45 @@ function LanguageTree:_add_injections()\n   return query_time\n end\n \n+--- Run an asynchronous parse, calling {on_parse} when complete.\n+---\n+--- @param range boolean|Range|nil\n+--- @param on_parse fun(trees: TSTrees, timeout_expired: boolean)\n+function LanguageTree:_async_parse(range, on_parse)\n+  coroutine.resume(coroutine.create(function()\n+    local co = coroutine.running()\n+    local ct = self:_buf().changedtick\n+    local total_parse_time = 0\n+    local redrawtime = vim.o.redrawtime\n+    ---@type TSTrees, boolean\n+    local trees, unfinished\n+\n+    while total_parse_time <= redrawtime do\n+      -- If buffer was changed in the middle of parsing, reset parse state\n+      if self:_buf().changedtick ~= ct then\n+        self._parser:reset()\n+        self:invalidate()\n+        total_parse_time = 0\n+        coroutine.yield()",
            "html_url": "https://github.com/neovim/neovim/pull/31631#discussion_r1895019023",
            "id": 1895019023,
            "in_reply_to_id": 1894997647,
            "line": null,
            "node_id": "PRRC_kwDOAPphoM5w87IP",
            "original_commit_id": "7cfba422a89936daf7ba887a07e707b76dae6e6c",
            "original_line": 450,
            "original_position": 112,
            "original_start_line": null,
            "path": "runtime/lua/vim/treesitter/languagetree.lua",
            "position": null,
            "pull_request_review_id": 2519679954,
            "pull_request_url": "https://api.github.com/repos/neovim/neovim/pulls/31631",
            "reactions": {
                "+1": 0,
                "-1": 0,
                "confused": 0,
                "eyes": 0,
                "heart": 0,
                "hooray": 0,
                "laugh": 0,
                "rocket": 0,
                "total_count": 0,
                "url": "https://api.github.com/repos/neovim/neovim/pulls/comments/1895019023/reactions"
            },
            "side": "RIGHT",
            "start_line": null,
            "start_side": null,
            "subject_type": "line",
            "updated_at": "2024-12-22T18:31:11Z",
            "url": "https://api.github.com/repos/neovim/neovim/pulls/comments/1895019023",
            "user": {
                "avatar_url": "https://avatars.githubusercontent.com/u/55766287?v=4",
                "events_url": "https://api.github.com/users/ribru17/events{/privacy}",
                "followers_url": "https://api.github.com/users/ribru17/followers",
                "following_url": "https://api.github.com/users/ribru17/following{/other_user}",
                "gists_url": "https://api.github.com/users/ribru17/gists{/gist_id}",
                "gravatar_id": "",
                "html_url": "https://github.com/ribru17",
                "id": 55766287,
                "login": "ribru17",
                "node_id": "MDQ6VXNlcjU1NzY2Mjg3",
                "organizations_url": "https://api.github.com/users/ribru17/orgs",
                "received_events_url": "https://api.github.com/users/ribru17/received_events",
                "repos_url": "https://api.github.com/users/ribru17/repos",
                "site_admin": false,
                "starred_url": "https://api.github.com/users/ribru17/starred{/owner}{/repo}",
                "subscriptions_url": "https://api.github.com/users/ribru17/subscriptions",
                "type": "User",
                "url": "https://api.github.com/users/ribru17",
                "user_view_type": "public"
            }
        },
        {
            "_links": {
                "html": {
                    "href": "https://github.com/neovim/neovim/pull/31631#discussion_r1896170488"
                },
                "pull_request": {
                    "href": "https://api.github.com/repos/neovim/neovim/pulls/31631"
                },
                "self": {
                    "href": "https://api.github.com/repos/neovim/neovim/pulls/comments/1896170488"
                }
            },
            "author_association": "CONTRIBUTOR",
            "body": "This line causes the crash. Parser reset frees up the old subtree with some of its children, and then the child is used by query cursor somehow.",
            "commit_id": "c885db4421200a476440ec14ce231bcf922f7248",
            "created_at": "2024-12-23T22:32:32Z",
            "diff_hunk": "@@ -409,6 +423,39 @@ function LanguageTree:_add_injections()\n   return query_time\n end\n \n+--- Run an asynchronous parse, calling {on_parse} when complete.\n+---\n+--- @param range boolean|Range?\n+--- @param on_parse fun(trees?: table<integer, TSTree>, err?: string)\n+function LanguageTree:_async_parse(range, on_parse)\n+  local ct = self:_buf().changedtick\n+  local total_parse_time = 0\n+  local redrawtime = vim.o.redrawtime\n+\n+  local function step()\n+    -- If buffer was changed in the middle of parsing, reset parse state\n+    if self:_buf().changedtick ~= ct then\n+      self._parser:reset()",
            "html_url": "https://github.com/neovim/neovim/pull/31631#discussion_r1896170488",
            "id": 1896170488,
            "line": 439,
            "node_id": "PRRC_kwDOAPphoM5xBUP4",
            "original_commit_id": "9131d42b1b12ca2d6005f012b1fd3b60d53f0d03",
            "original_line": 439,
            "original_position": 75,
            "original_start_line": null,
            "path": "runtime/lua/vim/treesitter/languagetree.lua",
            "position": 76,
            "pull_request_review_id": 2521214648,
            "pull_request_url": "https://api.github.com/repos/neovim/neovim/pulls/31631",
            "reactions": {
                "+1": 0,
                "-1": 0,
                "confused": 0,
                "eyes": 0,
                "heart": 0,
                "hooray": 0,
                "laugh": 0,
                "rocket": 0,
                "total_count": 0,
                "url": "https://api.github.com/repos/neovim/neovim/pulls/comments/1896170488/reactions"
            },
            "side": "RIGHT",
            "start_line": null,
            "start_side": null,
            "subject_type": "line",
            "updated_at": "2024-12-23T22:43:15Z",
            "url": "https://api.github.com/repos/neovim/neovim/pulls/comments/1896170488",
            "user": {
                "avatar_url": "https://avatars.githubusercontent.com/u/65824523?v=4",
                "events_url": "https://api.github.com/users/vanaigr/events{/privacy}",
                "followers_url": "https://api.github.com/users/vanaigr/followers",
                "following_url": "https://api.github.com/users/vanaigr/following{/other_user}",
                "gists_url": "https://api.github.com/users/vanaigr/gists{/gist_id}",
                "gravatar_id": "",
                "html_url": "https://github.com/vanaigr",
                "id": 65824523,
                "login": "vanaigr",
                "node_id": "MDQ6VXNlcjY1ODI0NTIz",
                "organizations_url": "https://api.github.com/users/vanaigr/orgs",
                "received_events_url": "https://api.github.com/users/vanaigr/received_events",
                "repos_url": "https://api.github.com/users/vanaigr/repos",
                "site_admin": false,
                "starred_url": "https://api.github.com/users/vanaigr/starred{/owner}{/repo}",
                "subscriptions_url": "https://api.github.com/users/vanaigr/subscriptions",
                "type": "User",
                "url": "https://api.github.com/users/vanaigr",
                "user_view_type": "public"
            }
        },
        {
            "_links": {
                "html": {
                    "href": "https://github.com/neovim/neovim/pull/31631#discussion_r1896182648"
                },
                "pull_request": {
                    "href": "https://api.github.com/repos/neovim/neovim/pulls/31631"
                },
                "self": {
                    "href": "https://api.github.com/repos/neovim/neovim/pulls/comments/1896182648"
                }
            },
            "author_association": "CONTRIBUTOR",
            "body": "My hypothesis is that:\r\n1. Redraw starts (`_highlight_states` contain query cursor from previous redraw)\r\n2. `Languagetree` resets the current parser, it frees the old tree (used by query cursor from previous redraw)\r\n3. Parse times out, callback is never called. `_highlight_states` aren't cleared.\r\n4. `on_line()` tries to use cursor from previous redraw. Cursor tries to read from the old tree. It is freed",
            "commit_id": "c885db4421200a476440ec14ce231bcf922f7248",
            "created_at": "2024-12-23T22:51:14Z",
            "diff_hunk": "@@ -409,6 +423,39 @@ function LanguageTree:_add_injections()\n   return query_time\n end\n \n+--- Run an asynchronous parse, calling {on_parse} when complete.\n+---\n+--- @param range boolean|Range?\n+--- @param on_parse fun(trees?: table<integer, TSTree>, err?: string)\n+function LanguageTree:_async_parse(range, on_parse)\n+  local ct = self:_buf().changedtick\n+  local total_parse_time = 0\n+  local redrawtime = vim.o.redrawtime\n+\n+  local function step()\n+    -- If buffer was changed in the middle of parsing, reset parse state\n+    if self:_buf().changedtick ~= ct then\n+      self._parser:reset()",
            "html_url": "https://github.com/neovim/neovim/pull/31631#discussion_r1896182648",
            "id": 1896182648,
            "in_reply_to_id": 1896170488,
            "line": 439,
            "node_id": "PRRC_kwDOAPphoM5xBXN4",
            "original_commit_id": "9131d42b1b12ca2d6005f012b1fd3b60d53f0d03",
            "original_line": 439,
            "original_position": 75,
            "original_start_line": null,
            "path": "runtime/lua/vim/treesitter/languagetree.lua",
            "position": 76,
            "pull_request_review_id": 2521230252,
            "pull_request_url": "https://api.github.com/repos/neovim/neovim/pulls/31631",
            "reactions": {
                "+1": 0,
                "-1": 0,
                "confused": 0,
                "eyes": 0,
                "heart": 0,
                "hooray": 0,
                "laugh": 0,
                "rocket": 0,
                "total_count": 0,
                "url": "https://api.github.com/repos/neovim/neovim/pulls/comments/1896182648/reactions"
            },
            "side": "RIGHT",
            "start_line": null,
            "start_side": null,
            "subject_type": "line",
            "updated_at": "2024-12-23T22:57:06Z",
            "url": "https://api.github.com/repos/neovim/neovim/pulls/comments/1896182648",
            "user": {
                "avatar_url": "https://avatars.githubusercontent.com/u/65824523?v=4",
                "events_url": "https://api.github.com/users/vanaigr/events{/privacy}",
                "followers_url": "https://api.github.com/users/vanaigr/followers",
                "following_url": "https://api.github.com/users/vanaigr/following{/other_user}",
                "gists_url": "https://api.github.com/users/vanaigr/gists{/gist_id}",
                "gravatar_id": "",
                "html_url": "https://github.com/vanaigr",
                "id": 65824523,
                "login": "vanaigr",
                "node_id": "MDQ6VXNlcjY1ODI0NTIz",
                "organizations_url": "https://api.github.com/users/vanaigr/orgs",
                "received_events_url": "https://api.github.com/users/vanaigr/received_events",
                "repos_url": "https://api.github.com/users/vanaigr/repos",
                "site_admin": false,
                "starred_url": "https://api.github.com/users/vanaigr/starred{/owner}{/repo}",
                "subscriptions_url": "https://api.github.com/users/vanaigr/subscriptions",
                "type": "User",
                "url": "https://api.github.com/users/vanaigr",
                "user_view_type": "public"
            }
        },
        {
            "_links": {
                "html": {
                    "href": "https://github.com/neovim/neovim/pull/31631#discussion_r1896185160"
                },
                "pull_request": {
                    "href": "https://api.github.com/repos/neovim/neovim/pulls/31631"
                },
                "self": {
                    "href": "https://api.github.com/repos/neovim/neovim/pulls/comments/1896185160"
                }
            },
            "author_association": "CONTRIBUTOR",
            "body": "@ribru17 ",
            "commit_id": "c885db4421200a476440ec14ce231bcf922f7248",
            "created_at": "2024-12-23T22:56:14Z",
            "diff_hunk": "@@ -409,6 +423,39 @@ function LanguageTree:_add_injections()\n   return query_time\n end\n \n+--- Run an asynchronous parse, calling {on_parse} when complete.\n+---\n+--- @param range boolean|Range?\n+--- @param on_parse fun(trees?: table<integer, TSTree>, err?: string)\n+function LanguageTree:_async_parse(range, on_parse)\n+  local ct = self:_buf().changedtick\n+  local total_parse_time = 0\n+  local redrawtime = vim.o.redrawtime\n+\n+  local function step()\n+    -- If buffer was changed in the middle of parsing, reset parse state\n+    if self:_buf().changedtick ~= ct then\n+      self._parser:reset()",
            "html_url": "https://github.com/neovim/neovim/pull/31631#discussion_r1896185160",
            "id": 1896185160,
            "in_reply_to_id": 1896170488,
            "line": 439,
            "node_id": "PRRC_kwDOAPphoM5xBX1I",
            "original_commit_id": "9131d42b1b12ca2d6005f012b1fd3b60d53f0d03",
            "original_line": 439,
            "original_position": 75,
            "original_start_line": null,
            "path": "runtime/lua/vim/treesitter/languagetree.lua",
            "position": 76,
            "pull_request_review_id": 2521232777,
            "pull_request_url": "https://api.github.com/repos/neovim/neovim/pulls/31631",
            "reactions": {
                "+1": 0,
                "-1": 0,
                "confused": 0,
                "eyes": 0,
                "heart": 0,
                "hooray": 0,
                "laugh": 0,
                "rocket": 0,
                "total_count": 0,
                "url": "https://api.github.com/repos/neovim/neovim/pulls/comments/1896185160/reactions"
            },
            "side": "RIGHT",
            "start_line": null,
            "start_side": null,
            "subject_type": "line",
            "updated_at": "2024-12-23T22:56:14Z",
            "url": "https://api.github.com/repos/neovim/neovim/pulls/comments/1896185160",
            "user": {
                "avatar_url": "https://avatars.githubusercontent.com/u/65824523?v=4",
                "events_url": "https://api.github.com/users/vanaigr/events{/privacy}",
                "followers_url": "https://api.github.com/users/vanaigr/followers",
                "following_url": "https://api.github.com/users/vanaigr/following{/other_user}",
                "gists_url": "https://api.github.com/users/vanaigr/gists{/gist_id}",
                "gravatar_id": "",
                "html_url": "https://github.com/vanaigr",
                "id": 65824523,
                "login": "vanaigr",
                "node_id": "MDQ6VXNlcjY1ODI0NTIz",
                "organizations_url": "https://api.github.com/users/vanaigr/orgs",
                "received_events_url": "https://api.github.com/users/vanaigr/received_events",
                "repos_url": "https://api.github.com/users/vanaigr/repos",
                "site_admin": false,
                "starred_url": "https://api.github.com/users/vanaigr/starred{/owner}{/repo}",
                "subscriptions_url": "https://api.github.com/users/vanaigr/subscriptions",
                "type": "User",
                "url": "https://api.github.com/users/vanaigr",
                "user_view_type": "public"
            }
        },
        {
            "_links": {
                "html": {
                    "href": "https://github.com/neovim/neovim/pull/31631#discussion_r1896191731"
                },
                "pull_request": {
                    "href": "https://api.github.com/repos/neovim/neovim/pulls/31631"
                },
                "self": {
                    "href": "https://api.github.com/repos/neovim/neovim/pulls/comments/1896191731"
                }
            },
            "author_association": "CONTRIBUTOR",
            "body": "Also, does this mean anyone can trigger this from lua by using a stale `iter_captures()` iterator? \r\n\r\nAll APIs are public",
            "commit_id": "c885db4421200a476440ec14ce231bcf922f7248",
            "created_at": "2024-12-23T23:09:15Z",
            "diff_hunk": "@@ -409,6 +423,39 @@ function LanguageTree:_add_injections()\n   return query_time\n end\n \n+--- Run an asynchronous parse, calling {on_parse} when complete.\n+---\n+--- @param range boolean|Range?\n+--- @param on_parse fun(trees?: table<integer, TSTree>, err?: string)\n+function LanguageTree:_async_parse(range, on_parse)\n+  local ct = self:_buf().changedtick\n+  local total_parse_time = 0\n+  local redrawtime = vim.o.redrawtime\n+\n+  local function step()\n+    -- If buffer was changed in the middle of parsing, reset parse state\n+    if self:_buf().changedtick ~= ct then\n+      self._parser:reset()",
            "html_url": "https://github.com/neovim/neovim/pull/31631#discussion_r1896191731",
            "id": 1896191731,
            "in_reply_to_id": 1896170488,
            "line": 439,
            "node_id": "PRRC_kwDOAPphoM5xBZbz",
            "original_commit_id": "9131d42b1b12ca2d6005f012b1fd3b60d53f0d03",
            "original_line": 439,
            "original_position": 75,
            "original_start_line": null,
            "path": "runtime/lua/vim/treesitter/languagetree.lua",
            "position": 76,
            "pull_request_review_id": 2521241690,
            "pull_request_url": "https://api.github.com/repos/neovim/neovim/pulls/31631",
            "reactions": {
                "+1": 0,
                "-1": 0,
                "confused": 0,
                "eyes": 0,
                "heart": 0,
                "hooray": 0,
                "laugh": 0,
                "rocket": 0,
                "total_count": 0,
                "url": "https://api.github.com/repos/neovim/neovim/pulls/comments/1896191731/reactions"
            },
            "side": "RIGHT",
            "start_line": null,
            "start_side": null,
            "subject_type": "line",
            "updated_at": "2024-12-23T23:18:16Z",
            "url": "https://api.github.com/repos/neovim/neovim/pulls/comments/1896191731",
            "user": {
                "avatar_url": "https://avatars.githubusercontent.com/u/65824523?v=4",
                "events_url": "https://api.github.com/users/vanaigr/events{/privacy}",
                "followers_url": "https://api.github.com/users/vanaigr/followers",
                "following_url": "https://api.github.com/users/vanaigr/following{/other_user}",
                "gists_url": "https://api.github.com/users/vanaigr/gists{/gist_id}",
                "gravatar_id": "",
                "html_url": "https://github.com/vanaigr",
                "id": 65824523,
                "login": "vanaigr",
                "node_id": "MDQ6VXNlcjY1ODI0NTIz",
                "organizations_url": "https://api.github.com/users/vanaigr/orgs",
                "received_events_url": "https://api.github.com/users/vanaigr/received_events",
                "repos_url": "https://api.github.com/users/vanaigr/repos",
                "site_admin": false,
                "starred_url": "https://api.github.com/users/vanaigr/starred{/owner}{/repo}",
                "subscriptions_url": "https://api.github.com/users/vanaigr/subscriptions",
                "type": "User",
                "url": "https://api.github.com/users/vanaigr",
                "user_view_type": "public"
            }
        },
        {
            "_links": {
                "html": {
                    "href": "https://github.com/neovim/neovim/pull/31631#discussion_r1896195929"
                },
                "pull_request": {
                    "href": "https://api.github.com/repos/neovim/neovim/pulls/31631"
                },
                "self": {
                    "href": "https://api.github.com/repos/neovim/neovim/pulls/comments/1896195929"
                }
            },
            "author_association": "MEMBER",
            "body": "> My hypothesis is that:\r\n> \r\n> 1. Redraw starts (`_highlight_states` contain query cursor from previous redraw)\r\n> 2. `Languagetree` resets the current parser, it frees the old tree (used by query cursor from previous redraw)\r\n> 3. Parse times out, callback is never called. `_highlight_states` aren't cleared.\r\n> 4. `on_line()` tries to use cursor from previous redraw. Cursor tries to read from the old tree. It is freed\r\n\r\nNice, yeah I believe this is exactly the issue\r\n\r\n> Also, does this mean anyone can trigger this from lua by using a stale `iter_captures()` iterator?\r\n\r\nI worried the same thing, and I believe it is possible but very unlikely, since most of the time you parse right before getting the root node, and then pass that node into the iterator. But that said this *really* should be fixed on the TS side of things, and I am surprised other editors have not raised this issue yet\r\n\r\nIs there a way we can guard against this in neovim, maybe with `TSNode:has_changes()`?",
            "commit_id": "c885db4421200a476440ec14ce231bcf922f7248",
            "created_at": "2024-12-23T23:18:36Z",
            "diff_hunk": "@@ -409,6 +423,39 @@ function LanguageTree:_add_injections()\n   return query_time\n end\n \n+--- Run an asynchronous parse, calling {on_parse} when complete.\n+---\n+--- @param range boolean|Range?\n+--- @param on_parse fun(trees?: table<integer, TSTree>, err?: string)\n+function LanguageTree:_async_parse(range, on_parse)\n+  local ct = self:_buf().changedtick\n+  local total_parse_time = 0\n+  local redrawtime = vim.o.redrawtime\n+\n+  local function step()\n+    -- If buffer was changed in the middle of parsing, reset parse state\n+    if self:_buf().changedtick ~= ct then\n+      self._parser:reset()",
            "html_url": "https://github.com/neovim/neovim/pull/31631#discussion_r1896195929",
            "id": 1896195929,
            "in_reply_to_id": 1896170488,
            "line": 439,
            "node_id": "PRRC_kwDOAPphoM5xBadZ",
            "original_commit_id": "9131d42b1b12ca2d6005f012b1fd3b60d53f0d03",
            "original_line": 439,
            "original_position": 75,
            "original_start_line": null,
            "path": "runtime/lua/vim/treesitter/languagetree.lua",
            "position": 76,
            "pull_request_review_id": 2521246811,
            "pull_request_url": "https://api.github.com/repos/neovim/neovim/pulls/31631",
            "reactions": {
                "+1": 0,
                "-1": 0,
                "confused": 0,
                "eyes": 0,
                "heart": 0,
                "hooray": 0,
                "laugh": 0,
                "rocket": 0,
                "total_count": 0,
                "url": "https://api.github.com/repos/neovim/neovim/pulls/comments/1896195929/reactions"
            },
            "side": "RIGHT",
            "start_line": null,
            "start_side": null,
            "subject_type": "line",
            "updated_at": "2024-12-23T23:18:36Z",
            "url": "https://api.github.com/repos/neovim/neovim/pulls/comments/1896195929",
            "user": {
                "avatar_url": "https://avatars.githubusercontent.com/u/55766287?v=4",
                "events_url": "https://api.github.com/users/ribru17/events{/privacy}",
                "followers_url": "https://api.github.com/users/ribru17/followers",
                "following_url": "https://api.github.com/users/ribru17/following{/other_user}",
                "gists_url": "https://api.github.com/users/ribru17/gists{/gist_id}",
                "gravatar_id": "",
                "html_url": "https://github.com/ribru17",
                "id": 55766287,
                "login": "ribru17",
                "node_id": "MDQ6VXNlcjU1NzY2Mjg3",
                "organizations_url": "https://api.github.com/users/ribru17/orgs",
                "received_events_url": "https://api.github.com/users/ribru17/received_events",
                "repos_url": "https://api.github.com/users/ribru17/repos",
                "site_admin": false,
                "starred_url": "https://api.github.com/users/ribru17/starred{/owner}{/repo}",
                "subscriptions_url": "https://api.github.com/users/ribru17/subscriptions",
                "type": "User",
                "url": "https://api.github.com/users/ribru17",
                "user_view_type": "public"
            }
        },
        {
            "_links": {
                "html": {
                    "href": "https://github.com/neovim/neovim/pull/31631#discussion_r1896199127"
                },
                "pull_request": {
                    "href": "https://api.github.com/repos/neovim/neovim/pulls/31631"
                },
                "self": {
                    "href": "https://api.github.com/repos/neovim/neovim/pulls/comments/1896199127"
                }
            },
            "author_association": "CONTRIBUTOR",
            "body": "Keep changetick for a parser and check each call to the iterator that it is the same. ",
            "commit_id": "c885db4421200a476440ec14ce231bcf922f7248",
            "created_at": "2024-12-23T23:25:36Z",
            "diff_hunk": "@@ -409,6 +423,39 @@ function LanguageTree:_add_injections()\n   return query_time\n end\n \n+--- Run an asynchronous parse, calling {on_parse} when complete.\n+---\n+--- @param range boolean|Range?\n+--- @param on_parse fun(trees?: table<integer, TSTree>, err?: string)\n+function LanguageTree:_async_parse(range, on_parse)\n+  local ct = self:_buf().changedtick\n+  local total_parse_time = 0\n+  local redrawtime = vim.o.redrawtime\n+\n+  local function step()\n+    -- If buffer was changed in the middle of parsing, reset parse state\n+    if self:_buf().changedtick ~= ct then\n+      self._parser:reset()",
            "html_url": "https://github.com/neovim/neovim/pull/31631#discussion_r1896199127",
            "id": 1896199127,
            "in_reply_to_id": 1896170488,
            "line": 439,
            "node_id": "PRRC_kwDOAPphoM5xBbPX",
            "original_commit_id": "9131d42b1b12ca2d6005f012b1fd3b60d53f0d03",
            "original_line": 439,
            "original_position": 75,
            "original_start_line": null,
            "path": "runtime/lua/vim/treesitter/languagetree.lua",
            "position": 76,
            "pull_request_review_id": 2521250584,
            "pull_request_url": "https://api.github.com/repos/neovim/neovim/pulls/31631",
            "reactions": {
                "+1": 0,
                "-1": 0,
                "confused": 0,
                "eyes": 0,
                "heart": 0,
                "hooray": 0,
                "laugh": 0,
                "rocket": 0,
                "total_count": 0,
                "url": "https://api.github.com/repos/neovim/neovim/pulls/comments/1896199127/reactions"
            },
            "side": "RIGHT",
            "start_line": null,
            "start_side": null,
            "subject_type": "line",
            "updated_at": "2024-12-23T23:25:36Z",
            "url": "https://api.github.com/repos/neovim/neovim/pulls/comments/1896199127",
            "user": {
                "avatar_url": "https://avatars.githubusercontent.com/u/65824523?v=4",
                "events_url": "https://api.github.com/users/vanaigr/events{/privacy}",
                "followers_url": "https://api.github.com/users/vanaigr/followers",
                "following_url": "https://api.github.com/users/vanaigr/following{/other_user}",
                "gists_url": "https://api.github.com/users/vanaigr/gists{/gist_id}",
                "gravatar_id": "",
                "html_url": "https://github.com/vanaigr",
                "id": 65824523,
                "login": "vanaigr",
                "node_id": "MDQ6VXNlcjY1ODI0NTIz",
                "organizations_url": "https://api.github.com/users/vanaigr/orgs",
                "received_events_url": "https://api.github.com/users/vanaigr/received_events",
                "repos_url": "https://api.github.com/users/vanaigr/repos",
                "site_admin": false,
                "starred_url": "https://api.github.com/users/vanaigr/starred{/owner}{/repo}",
                "subscriptions_url": "https://api.github.com/users/vanaigr/subscriptions",
                "type": "User",
                "url": "https://api.github.com/users/vanaigr",
                "user_view_type": "public"
            }
        },
        {
            "_links": {
                "html": {
                    "href": "https://github.com/neovim/neovim/pull/31631#discussion_r1896200254"
                },
                "pull_request": {
                    "href": "https://api.github.com/repos/neovim/neovim/pulls/31631"
                },
                "self": {
                    "href": "https://api.github.com/repos/neovim/neovim/pulls/comments/1896200254"
                }
            },
            "author_association": "MEMBER",
            "body": "~~Interestingly, this `nvim__redraw()` seems to be redundant, seemingly all we need to do in this callback is to unset `self.parsing`. (Currently) the `on_changedtree` callback already triggers a sufficient redraw during parsing. The code responsible has a TODO note attached to it though so maybe that will change:~~\r\n\r\n~~In which case maybe we should keep this anyhow~~ not sure about the arguments though.\r\nIf other redraws are likely, `flush`ing here is actually unwanted so maybe should be set to `false`.\r\n\r\nI used `valid = false` as opposed to a `topline/botline` range which we could still pass here, because there there is no guarantee that the topline will still be the same. IDK if this makes a difference in practice, (currently it doesn't because of the above).",
            "commit_id": "c885db4421200a476440ec14ce231bcf922f7248",
            "created_at": "2024-12-23T23:28:08Z",
            "diff_hunk": "@@ -382,21 +380,35 @@ function TSHighlighter._on_spell_nav(_, _, buf, srow, _, erow, _)\n end\n \n ---@private\n----@param _win integer\n ---@param buf integer\n ---@param topline integer\n ---@param botline integer\n-function TSHighlighter._on_win(_, _win, buf, topline, botline)\n+function TSHighlighter._on_win(_, _, buf, topline, botline)\n   local self = TSHighlighter.active[buf]\n-  if not self then\n+  if not self or self.parsing then\n+    return false\n+  end\n+  self.parsing = self.tree:parse({ topline, botline + 1 }, function(trees)\n+    if trees then\n+      self:_async_parse_callback(buf)\n+    end\n+  end) --[[@as boolean]]\n+  if self.parsing then\n     return false\n   end\n-  self.tree:parse({ topline, botline + 1 })\n-  self:prepare_highlight_states(topline, botline + 1)\n   self.redraw_count = self.redraw_count + 1\n+  self:prepare_highlight_states(topline, botline)\n   return true\n end\n \n+---@param buf integer\n+function TSHighlighter:_async_parse_callback(buf)\n+  if self.parsing then\n+    self.parsing = false\n+    api.nvim__redraw({ buf = buf, valid = false, flush = true })",
            "html_url": "https://github.com/neovim/neovim/pull/31631#discussion_r1896200254",
            "id": 1896200254,
            "line": null,
            "node_id": "PRRC_kwDOAPphoM5xBbg-",
            "original_commit_id": "2a43a2c0f7b03f6f35886ee6b2a6f934f5f2a0cb",
            "original_line": 408,
            "original_position": 59,
            "original_start_line": null,
            "path": "runtime/lua/vim/treesitter/highlighter.lua",
            "position": null,
            "pull_request_review_id": 2521251843,
            "pull_request_url": "https://api.github.com/repos/neovim/neovim/pulls/31631",
            "reactions": {
                "+1": 1,
                "-1": 0,
                "confused": 0,
                "eyes": 0,
                "heart": 0,
                "hooray": 0,
                "laugh": 0,
                "rocket": 0,
                "total_count": 1,
                "url": "https://api.github.com/repos/neovim/neovim/pulls/comments/1896200254/reactions"
            },
            "side": "RIGHT",
            "start_line": null,
            "start_side": null,
            "subject_type": "line",
            "updated_at": "2024-12-23T23:46:49Z",
            "url": "https://api.github.com/repos/neovim/neovim/pulls/comments/1896200254",
            "user": {
                "avatar_url": "https://avatars.githubusercontent.com/u/31730729?v=4",
                "events_url": "https://api.github.com/users/luukvbaal/events{/privacy}",
                "followers_url": "https://api.github.com/users/luukvbaal/followers",
                "following_url": "https://api.github.com/users/luukvbaal/following{/other_user}",
                "gists_url": "https://api.github.com/users/luukvbaal/gists{/gist_id}",
                "gravatar_id": "",
                "html_url": "https://github.com/luukvbaal",
                "id": 31730729,
                "login": "luukvbaal",
                "node_id": "MDQ6VXNlcjMxNzMwNzI5",
                "organizations_url": "https://api.github.com/users/luukvbaal/orgs",
                "received_events_url": "https://api.github.com/users/luukvbaal/received_events",
                "repos_url": "https://api.github.com/users/luukvbaal/repos",
                "site_admin": false,
                "starred_url": "https://api.github.com/users/luukvbaal/starred{/owner}{/repo}",
                "subscriptions_url": "https://api.github.com/users/luukvbaal/subscriptions",
                "type": "User",
                "url": "https://api.github.com/users/luukvbaal",
                "user_view_type": "public"
            }
        },
        {
            "_links": {
                "html": {
                    "href": "https://github.com/neovim/neovim/pull/31631#discussion_r1896205222"
                },
                "pull_request": {
                    "href": "https://api.github.com/repos/neovim/neovim/pulls/31631"
                },
                "self": {
                    "href": "https://api.github.com/repos/neovim/neovim/pulls/comments/1896205222"
                }
            },
            "author_association": "MEMBER",
            "body": "Interesting... have you noticed this for large files as well? For me removing the redraw is the same for small files that can presumably get parsed synchronously, but with large files my highlights will not apply without the redraw",
            "commit_id": "c885db4421200a476440ec14ce231bcf922f7248",
            "created_at": "2024-12-23T23:39:41Z",
            "diff_hunk": "@@ -382,21 +380,35 @@ function TSHighlighter._on_spell_nav(_, _, buf, srow, _, erow, _)\n end\n \n ---@private\n----@param _win integer\n ---@param buf integer\n ---@param topline integer\n ---@param botline integer\n-function TSHighlighter._on_win(_, _win, buf, topline, botline)\n+function TSHighlighter._on_win(_, _, buf, topline, botline)\n   local self = TSHighlighter.active[buf]\n-  if not self then\n+  if not self or self.parsing then\n+    return false\n+  end\n+  self.parsing = self.tree:parse({ topline, botline + 1 }, function(trees)\n+    if trees then\n+      self:_async_parse_callback(buf)\n+    end\n+  end) --[[@as boolean]]\n+  if self.parsing then\n     return false\n   end\n-  self.tree:parse({ topline, botline + 1 })\n-  self:prepare_highlight_states(topline, botline + 1)\n   self.redraw_count = self.redraw_count + 1\n+  self:prepare_highlight_states(topline, botline)\n   return true\n end\n \n+---@param buf integer\n+function TSHighlighter:_async_parse_callback(buf)\n+  if self.parsing then\n+    self.parsing = false\n+    api.nvim__redraw({ buf = buf, valid = false, flush = true })",
            "html_url": "https://github.com/neovim/neovim/pull/31631#discussion_r1896205222",
            "id": 1896205222,
            "in_reply_to_id": 1896200254,
            "line": null,
            "node_id": "PRRC_kwDOAPphoM5xBcum",
            "original_commit_id": "2a43a2c0f7b03f6f35886ee6b2a6f934f5f2a0cb",
            "original_line": 408,
            "original_position": 59,
            "original_start_line": null,
            "path": "runtime/lua/vim/treesitter/highlighter.lua",
            "position": null,
            "pull_request_review_id": 2521257376,
            "pull_request_url": "https://api.github.com/repos/neovim/neovim/pulls/31631",
            "reactions": {
                "+1": 0,
                "-1": 0,
                "confused": 0,
                "eyes": 0,
                "heart": 0,
                "hooray": 0,
                "laugh": 0,
                "rocket": 0,
                "total_count": 0,
                "url": "https://api.github.com/repos/neovim/neovim/pulls/comments/1896205222/reactions"
            },
            "side": "RIGHT",
            "start_line": null,
            "start_side": null,
            "subject_type": "line",
            "updated_at": "2024-12-23T23:39:41Z",
            "url": "https://api.github.com/repos/neovim/neovim/pulls/comments/1896205222",
            "user": {
                "avatar_url": "https://avatars.githubusercontent.com/u/55766287?v=4",
                "events_url": "https://api.github.com/users/ribru17/events{/privacy}",
                "followers_url": "https://api.github.com/users/ribru17/followers",
                "following_url": "https://api.github.com/users/ribru17/following{/other_user}",
                "gists_url": "https://api.github.com/users/ribru17/gists{/gist_id}",
                "gravatar_id": "",
                "html_url": "https://github.com/ribru17",
                "id": 55766287,
                "login": "ribru17",
                "node_id": "MDQ6VXNlcjU1NzY2Mjg3",
                "organizations_url": "https://api.github.com/users/ribru17/orgs",
                "received_events_url": "https://api.github.com/users/ribru17/received_events",
                "repos_url": "https://api.github.com/users/ribru17/repos",
                "site_admin": false,
                "starred_url": "https://api.github.com/users/ribru17/starred{/owner}{/repo}",
                "subscriptions_url": "https://api.github.com/users/ribru17/subscriptions",
                "type": "User",
                "url": "https://api.github.com/users/ribru17",
                "user_view_type": "public"
            }
        },
        {
            "_links": {
                "html": {
                    "href": "https://github.com/neovim/neovim/pull/31631#discussion_r1896207841"
                },
                "pull_request": {
                    "href": "https://api.github.com/repos/neovim/neovim/pulls/31631"
                },
                "self": {
                    "href": "https://api.github.com/repos/neovim/neovim/pulls/comments/1896207841"
                }
            },
            "author_association": "MEMBER",
            "body": "Ah you're right, I was testing in a large file but small window\r\nIn that case, I think this is the best we can do:\r\n```suggestion\r\n    api.nvim__redraw({ buf = buf, valid = false, flush = false })\r\n```\r\n\r\nUnless if we keep track of what lines are actually drawn since the `on_win` call associated with the async callback. Then we could limit the range to those lines and redraw only those that would have been redrawn originally...",
            "commit_id": "c885db4421200a476440ec14ce231bcf922f7248",
            "created_at": "2024-12-23T23:45:43Z",
            "diff_hunk": "@@ -382,21 +380,35 @@ function TSHighlighter._on_spell_nav(_, _, buf, srow, _, erow, _)\n end\n \n ---@private\n----@param _win integer\n ---@param buf integer\n ---@param topline integer\n ---@param botline integer\n-function TSHighlighter._on_win(_, _win, buf, topline, botline)\n+function TSHighlighter._on_win(_, _, buf, topline, botline)\n   local self = TSHighlighter.active[buf]\n-  if not self then\n+  if not self or self.parsing then\n+    return false\n+  end\n+  self.parsing = self.tree:parse({ topline, botline + 1 }, function(trees)\n+    if trees then\n+      self:_async_parse_callback(buf)\n+    end\n+  end) --[[@as boolean]]\n+  if self.parsing then\n     return false\n   end\n-  self.tree:parse({ topline, botline + 1 })\n-  self:prepare_highlight_states(topline, botline + 1)\n   self.redraw_count = self.redraw_count + 1\n+  self:prepare_highlight_states(topline, botline)\n   return true\n end\n \n+---@param buf integer\n+function TSHighlighter:_async_parse_callback(buf)\n+  if self.parsing then\n+    self.parsing = false\n+    api.nvim__redraw({ buf = buf, valid = false, flush = true })",
            "html_url": "https://github.com/neovim/neovim/pull/31631#discussion_r1896207841",
            "id": 1896207841,
            "in_reply_to_id": 1896200254,
            "line": null,
            "node_id": "PRRC_kwDOAPphoM5xBdXh",
            "original_commit_id": "2a43a2c0f7b03f6f35886ee6b2a6f934f5f2a0cb",
            "original_line": 408,
            "original_position": 59,
            "original_start_line": null,
            "path": "runtime/lua/vim/treesitter/highlighter.lua",
            "position": null,
            "pull_request_review_id": 2521260341,
            "pull_request_url": "https://api.github.com/repos/neovim/neovim/pulls/31631",
            "reactions": {
                "+1": 0,
                "-1": 0,
                "confused": 0,
                "eyes": 0,
                "heart": 0,
                "hooray": 0,
                "laugh": 0,
                "rocket": 0,
                "total_count": 0,
                "url": "https://api.github.com/repos/neovim/neovim/pulls/comments/1896207841/reactions"
            },
            "side": "RIGHT",
            "start_line": null,
            "start_side": null,
            "subject_type": "line",
            "updated_at": "2024-12-23T23:47:45Z",
            "url": "https://api.github.com/repos/neovim/neovim/pulls/comments/1896207841",
            "user": {
                "avatar_url": "https://avatars.githubusercontent.com/u/31730729?v=4",
                "events_url": "https://api.github.com/users/luukvbaal/events{/privacy}",
                "followers_url": "https://api.github.com/users/luukvbaal/followers",
                "following_url": "https://api.github.com/users/luukvbaal/following{/other_user}",
                "gists_url": "https://api.github.com/users/luukvbaal/gists{/gist_id}",
                "gravatar_id": "",
                "html_url": "https://github.com/luukvbaal",
                "id": 31730729,
                "login": "luukvbaal",
                "node_id": "MDQ6VXNlcjMxNzMwNzI5",
                "organizations_url": "https://api.github.com/users/luukvbaal/orgs",
                "received_events_url": "https://api.github.com/users/luukvbaal/received_events",
                "repos_url": "https://api.github.com/users/luukvbaal/repos",
                "site_admin": false,
                "starred_url": "https://api.github.com/users/luukvbaal/starred{/owner}{/repo}",
                "subscriptions_url": "https://api.github.com/users/luukvbaal/subscriptions",
                "type": "User",
                "url": "https://api.github.com/users/luukvbaal",
                "user_view_type": "public"
            }
        },
        {
            "_links": {
                "html": {
                    "href": "https://github.com/neovim/neovim/pull/31631#discussion_r1896249595"
                },
                "pull_request": {
                    "href": "https://api.github.com/repos/neovim/neovim/pulls/31631"
                },
                "self": {
                    "href": "https://api.github.com/repos/neovim/neovim/pulls/comments/1896249595"
                }
            },
            "author_association": "CONTRIBUTOR",
            "body": "@lewis6991\r\n\r\nDoes everything that depend on the tree (e.g. nodes and iterators) get invalidated after a reparse? How do the nodes/iterators check if the subtree they are referencing hasn't been freed? \r\n\r\nI tried changing the entire buffer buffer, reparsing, and then querying e.g. a child from an old node or the next capture from an old iterator. But they just return empty nodes and don't crash. \r\n\r\nIt ssems strange that it only crashes when explicitly resetting the parser.",
            "commit_id": "c885db4421200a476440ec14ce231bcf922f7248",
            "created_at": "2024-12-24T00:59:00Z",
            "diff_hunk": "@@ -409,6 +423,39 @@ function LanguageTree:_add_injections()\n   return query_time\n end\n \n+--- Run an asynchronous parse, calling {on_parse} when complete.\n+---\n+--- @param range boolean|Range?\n+--- @param on_parse fun(trees?: table<integer, TSTree>, err?: string)\n+function LanguageTree:_async_parse(range, on_parse)\n+  local ct = self:_buf().changedtick\n+  local total_parse_time = 0\n+  local redrawtime = vim.o.redrawtime\n+\n+  local function step()\n+    -- If buffer was changed in the middle of parsing, reset parse state\n+    if self:_buf().changedtick ~= ct then\n+      self._parser:reset()",
            "html_url": "https://github.com/neovim/neovim/pull/31631#discussion_r1896249595",
            "id": 1896249595,
            "in_reply_to_id": 1896170488,
            "line": 439,
            "node_id": "PRRC_kwDOAPphoM5xBnj7",
            "original_commit_id": "9131d42b1b12ca2d6005f012b1fd3b60d53f0d03",
            "original_line": 439,
            "original_position": 75,
            "original_start_line": null,
            "path": "runtime/lua/vim/treesitter/languagetree.lua",
            "position": 76,
            "pull_request_review_id": 2521310828,
            "pull_request_url": "https://api.github.com/repos/neovim/neovim/pulls/31631",
            "reactions": {
                "+1": 0,
                "-1": 0,
                "confused": 0,
                "eyes": 0,
                "heart": 0,
                "hooray": 0,
                "laugh": 0,
                "rocket": 0,
                "total_count": 0,
                "url": "https://api.github.com/repos/neovim/neovim/pulls/comments/1896249595/reactions"
            },
            "side": "RIGHT",
            "start_line": null,
            "start_side": null,
            "subject_type": "line",
            "updated_at": "2024-12-24T00:59:01Z",
            "url": "https://api.github.com/repos/neovim/neovim/pulls/comments/1896249595",
            "user": {
                "avatar_url": "https://avatars.githubusercontent.com/u/65824523?v=4",
                "events_url": "https://api.github.com/users/vanaigr/events{/privacy}",
                "followers_url": "https://api.github.com/users/vanaigr/followers",
                "following_url": "https://api.github.com/users/vanaigr/following{/other_user}",
                "gists_url": "https://api.github.com/users/vanaigr/gists{/gist_id}",
                "gravatar_id": "",
                "html_url": "https://github.com/vanaigr",
                "id": 65824523,
                "login": "vanaigr",
                "node_id": "MDQ6VXNlcjY1ODI0NTIz",
                "organizations_url": "https://api.github.com/users/vanaigr/orgs",
                "received_events_url": "https://api.github.com/users/vanaigr/received_events",
                "repos_url": "https://api.github.com/users/vanaigr/repos",
                "site_admin": false,
                "starred_url": "https://api.github.com/users/vanaigr/starred{/owner}{/repo}",
                "subscriptions_url": "https://api.github.com/users/vanaigr/subscriptions",
                "type": "User",
                "url": "https://api.github.com/users/vanaigr",
                "user_view_type": "public"
            }
        },
        {
            "_links": {
                "html": {
                    "href": "https://github.com/neovim/neovim/pull/31631#discussion_r1896279784"
                },
                "pull_request": {
                    "href": "https://api.github.com/repos/neovim/neovim/pulls/31631"
                },
                "self": {
                    "href": "https://api.github.com/repos/neovim/neovim/pulls/comments/1896279784"
                }
            },
            "author_association": "MEMBER",
            "body": "Perfect, I'll update it :+1:  Out of curiosity, what is the difference here between `buf = buf` and `win = win`, or `valid = false` and `range = ...`?",
            "commit_id": "c885db4421200a476440ec14ce231bcf922f7248",
            "created_at": "2024-12-24T01:54:46Z",
            "diff_hunk": "@@ -382,21 +380,35 @@ function TSHighlighter._on_spell_nav(_, _, buf, srow, _, erow, _)\n end\n \n ---@private\n----@param _win integer\n ---@param buf integer\n ---@param topline integer\n ---@param botline integer\n-function TSHighlighter._on_win(_, _win, buf, topline, botline)\n+function TSHighlighter._on_win(_, _, buf, topline, botline)\n   local self = TSHighlighter.active[buf]\n-  if not self then\n+  if not self or self.parsing then\n+    return false\n+  end\n+  self.parsing = self.tree:parse({ topline, botline + 1 }, function(trees)\n+    if trees then\n+      self:_async_parse_callback(buf)\n+    end\n+  end) --[[@as boolean]]\n+  if self.parsing then\n     return false\n   end\n-  self.tree:parse({ topline, botline + 1 })\n-  self:prepare_highlight_states(topline, botline + 1)\n   self.redraw_count = self.redraw_count + 1\n+  self:prepare_highlight_states(topline, botline)\n   return true\n end\n \n+---@param buf integer\n+function TSHighlighter:_async_parse_callback(buf)\n+  if self.parsing then\n+    self.parsing = false\n+    api.nvim__redraw({ buf = buf, valid = false, flush = true })",
            "html_url": "https://github.com/neovim/neovim/pull/31631#discussion_r1896279784",
            "id": 1896279784,
            "in_reply_to_id": 1896200254,
            "line": null,
            "node_id": "PRRC_kwDOAPphoM5xBu7o",
            "original_commit_id": "2a43a2c0f7b03f6f35886ee6b2a6f934f5f2a0cb",
            "original_line": 408,
            "original_position": 59,
            "original_start_line": null,
            "path": "runtime/lua/vim/treesitter/highlighter.lua",
            "position": null,
            "pull_request_review_id": 2521344701,
            "pull_request_url": "https://api.github.com/repos/neovim/neovim/pulls/31631",
            "reactions": {
                "+1": 0,
                "-1": 0,
                "confused": 0,
                "eyes": 0,
                "heart": 0,
                "hooray": 0,
                "laugh": 0,
                "rocket": 0,
                "total_count": 0,
                "url": "https://api.github.com/repos/neovim/neovim/pulls/comments/1896279784/reactions"
            },
            "side": "RIGHT",
            "start_line": null,
            "start_side": null,
            "subject_type": "line",
            "updated_at": "2024-12-24T01:54:47Z",
            "url": "https://api.github.com/repos/neovim/neovim/pulls/comments/1896279784",
            "user": {
                "avatar_url": "https://avatars.githubusercontent.com/u/55766287?v=4",
                "events_url": "https://api.github.com/users/ribru17/events{/privacy}",
                "followers_url": "https://api.github.com/users/ribru17/followers",
                "following_url": "https://api.github.com/users/ribru17/following{/other_user}",
                "gists_url": "https://api.github.com/users/ribru17/gists{/gist_id}",
                "gravatar_id": "",
                "html_url": "https://github.com/ribru17",
                "id": 55766287,
                "login": "ribru17",
                "node_id": "MDQ6VXNlcjU1NzY2Mjg3",
                "organizations_url": "https://api.github.com/users/ribru17/orgs",
                "received_events_url": "https://api.github.com/users/ribru17/received_events",
                "repos_url": "https://api.github.com/users/ribru17/repos",
                "site_admin": false,
                "starred_url": "https://api.github.com/users/ribru17/starred{/owner}{/repo}",
                "subscriptions_url": "https://api.github.com/users/ribru17/subscriptions",
                "type": "User",
                "url": "https://api.github.com/users/ribru17",
                "user_view_type": "public"
            }
        }
    ],
    "comment_regular_data": [
        {
            "author_association": "CONTRIBUTOR",
            "body": "> That said, there are still some stutters at times (with the gigantic file), which is disappointing. Start up time is massively improved but cursor movement stalls towards the end of parsing completion. If anyone can provide some insights on how to smooth over the asynchronous chunks it would be much appreciated.\r\n\r\nThis looks to be a treesitter issue. `ts_subtree_balance()` called [here](https://github.com/tree-sitter/tree-sitter/blob/7d3dbc062d8be6575f8e6e4ada18af989ba4e6ef/lib/src/parser.c#L2112) exceeds the time limit. From the arguments, it looks like it doesn't have access to the timeout, so I assume it doesn't check it.\r\n",
            "created_at": "2024-12-19T07:00:32Z",
            "html_url": "https://github.com/neovim/neovim/pull/31631#issuecomment-2552928482",
            "id": 2552928482,
            "issue_url": "https://api.github.com/repos/neovim/neovim/issues/31631",
            "node_id": "IC_kwDOAPphoM6YKpji",
            "performed_via_github_app": null,
            "reactions": {
                "+1": 0,
                "-1": 0,
                "confused": 0,
                "eyes": 0,
                "heart": 0,
                "hooray": 0,
                "laugh": 0,
                "rocket": 3,
                "total_count": 3,
                "url": "https://api.github.com/repos/neovim/neovim/issues/comments/2552928482/reactions"
            },
            "updated_at": "2024-12-19T07:00:32Z",
            "url": "https://api.github.com/repos/neovim/neovim/issues/comments/2552928482",
            "user": {
                "avatar_url": "https://avatars.githubusercontent.com/u/65824523?v=4",
                "events_url": "https://api.github.com/users/vanaigr/events{/privacy}",
                "followers_url": "https://api.github.com/users/vanaigr/followers",
                "following_url": "https://api.github.com/users/vanaigr/following{/other_user}",
                "gists_url": "https://api.github.com/users/vanaigr/gists{/gist_id}",
                "gravatar_id": "",
                "html_url": "https://github.com/vanaigr",
                "id": 65824523,
                "login": "vanaigr",
                "node_id": "MDQ6VXNlcjY1ODI0NTIz",
                "organizations_url": "https://api.github.com/users/vanaigr/orgs",
                "received_events_url": "https://api.github.com/users/vanaigr/received_events",
                "repos_url": "https://api.github.com/users/vanaigr/repos",
                "site_admin": false,
                "starred_url": "https://api.github.com/users/vanaigr/starred{/owner}{/repo}",
                "subscriptions_url": "https://api.github.com/users/vanaigr/subscriptions",
                "type": "User",
                "url": "https://api.github.com/users/vanaigr",
                "user_view_type": "public"
            }
        },
        {
            "author_association": "CONTRIBUTOR",
            "body": "made a patch that tries (poorly) to make parsing respect the timeout:\r\n\r\n<details>\r\n\r\n<summary>patch</summary>\r\n\r\n```diff\r\ndiff --git a/lib/src/parser.c b/lib/src/parser.c\r\nindex 5fccc2ec..c76bb160 100644\r\n--- a/lib/src/parser.c\r\n+++ b/lib/src/parser.c\r\n@@ -115,6 +115,7 @@ struct TSParser {\r\n   TSRangeArray included_range_differences;\r\n   unsigned included_range_difference_index;\r\n   bool has_scanner_error;\r\n+  bool finished_parsing;\r\n };\r\n \r\n typedef struct {\r\n@@ -1990,6 +1991,7 @@ void ts_parser_reset(TSParser *self) {\r\n   }\r\n   self->accept_count = 0;\r\n   self->has_scanner_error = false;\r\n+  self->finished_parsing = false;\r\n }\r\n \r\n TSTree *ts_parser_parse(\r\n@@ -2000,6 +2002,7 @@ TSTree *ts_parser_parse(\r\n   TSTree *result = NULL;\r\n   if (!self->language || !input.read) return NULL;\r\n \r\n+  if (!self->finished_parsing) {\r\n   if (ts_language_is_wasm(self->language)) {\r\n     if (!self->wasm_store) return NULL;\r\n     ts_wasm_store_start(self->wasm_store, &self->lexer.data, self->language);\r\n@@ -2100,8 +2103,24 @@ TSTree *ts_parser_parse(\r\n     }\r\n   } while (version_count != 0);\r\n \r\n+    array_clear(&self->tree_pool.tree_stack);\r\n+\r\n+    if (ts_subtree_child_count(self->finished_tree) > 0 && self->finished_tree.ptr->ref_count == 1) {\r\n+      array_push(&self->tree_pool.tree_stack, ts_subtree_to_mut_unsafe(self->finished_tree));\r\n+    }\r\n+    self->finished_parsing = true;\r\n+  }\r\n+\r\n   ts_assert(self->finished_tree.ptr);\r\n-  ts_subtree_balance(self->finished_tree, &self->tree_pool, self->language);\r\n+  while (true) {\r\n+    if(ts_subtree_balance(&self->tree_pool, self->language)) break;\r\n+    if (\r\n+      ((self->cancellation_flag && atomic_load(self->cancellation_flag)) ||\r\n+       (!clock_is_null(self->end_clock) && clock_is_gt(clock_now(), self->end_clock)))\r\n+    ) {\r\n+      return false;\r\n+    }\r\n+  }\r\n   LOG(\"done\");\r\n   LOG_TREE(self->finished_tree);\r\n \r\ndiff --git a/lib/src/subtree.c b/lib/src/subtree.c\r\nindex 069f0467..1322d249 100644\r\n--- a/lib/src/subtree.c\r\n+++ b/lib/src/subtree.c\r\n@@ -334,14 +334,12 @@ static void ts_subtree__compress(\r\n   }\r\n }\r\n \r\n-void ts_subtree_balance(Subtree self, SubtreePool *pool, const TSLanguage *language) {\r\n-  array_clear(&pool->tree_stack);\r\n-\r\n-  if (ts_subtree_child_count(self) > 0 && self.ptr->ref_count == 1) {\r\n-    array_push(&pool->tree_stack, ts_subtree_to_mut_unsafe(self));\r\n-  }\r\n-\r\n+bool ts_subtree_balance(SubtreePool *pool, const TSLanguage *language) {\r\n+  int ops_count = 0;\r\n   while (pool->tree_stack.size > 0) {\r\n+    if (ops_count >= 1000) return false;\r\n+    ops_count++;\r\n+\r\n     MutableSubtree tree = array_pop(&pool->tree_stack);\r\n \r\n     if (tree.ptr->repeat_depth > 0) {\r\n@@ -351,6 +349,7 @@ void ts_subtree_balance(Subtree self, SubtreePool *pool, const TSLanguage *langu\r\n       if (repeat_delta > 0) {\r\n         unsigned n = (unsigned)repeat_delta;\r\n         for (unsigned i = n / 2; i > 0; i /= 2) {\r\n+          ops_count += i * 10;\r\n           ts_subtree__compress(tree, i, language, &pool->tree_stack);\r\n           n -= i;\r\n         }\r\n@@ -359,11 +358,13 @@ void ts_subtree_balance(Subtree self, SubtreePool *pool, const TSLanguage *langu\r\n \r\n     for (uint32_t i = 0; i < tree.ptr->child_count; i++) {\r\n       Subtree child = ts_subtree_children(tree)[i];\r\n+      ops_count += 1;\r\n       if (ts_subtree_child_count(child) > 0 && child.ptr->ref_count == 1) {\r\n         array_push(&pool->tree_stack, ts_subtree_to_mut_unsafe(child));\r\n       }\r\n     }\r\n   }\r\n+  return true;\r\n }\r\n \r\n // Assign all of the node's properties that depend on its children.\r\ndiff --git a/lib/src/subtree.h b/lib/src/subtree.h\r\nindex f140ecdb..83e829ef 100644\r\n--- a/lib/src/subtree.h\r\n+++ b/lib/src/subtree.h\r\n@@ -204,7 +204,7 @@ int ts_subtree_compare(Subtree, Subtree, SubtreePool *);\r\n void ts_subtree_set_symbol(MutableSubtree *, TSSymbol, const TSLanguage *);\r\n void ts_subtree_summarize(MutableSubtree, const Subtree *, uint32_t, const TSLanguage *);\r\n void ts_subtree_summarize_children(MutableSubtree, const TSLanguage *);\r\n-void ts_subtree_balance(Subtree, SubtreePool *, const TSLanguage *);\r\n+bool ts_subtree_balance(SubtreePool *, const TSLanguage *);\r\n Subtree ts_subtree_edit(Subtree, const TSInputEdit *edit, SubtreePool *);\r\n char *ts_subtree_string(Subtree, TSSymbol, bool, const TSLanguage *, bool include_all);\r\n void ts_subtree_print_dot_graph(Subtree, const TSLanguage *, FILE *);\r\n```\r\n\r\n</details>\r\n\r\nApplies to https://github.com/tree-sitter/tree-sitter/commit/1a983b7e2c45d9b9f45b2133a4e3a829f7e961be\r\n\r\nAfter building tree-sitter, I copy `libtree-sitter.*` into neovim's `.deps/usr/lib/` and build neovim. ",
            "created_at": "2024-12-19T10:06:06Z",
            "html_url": "https://github.com/neovim/neovim/pull/31631#issuecomment-2553305889",
            "id": 2553305889,
            "issue_url": "https://api.github.com/repos/neovim/neovim/issues/31631",
            "node_id": "IC_kwDOAPphoM6YMFsh",
            "performed_via_github_app": null,
            "reactions": {
                "+1": 0,
                "-1": 0,
                "confused": 0,
                "eyes": 0,
                "heart": 2,
                "hooray": 0,
                "laugh": 0,
                "rocket": 0,
                "total_count": 2,
                "url": "https://api.github.com/repos/neovim/neovim/issues/comments/2553305889/reactions"
            },
            "updated_at": "2024-12-19T10:07:26Z",
            "url": "https://api.github.com/repos/neovim/neovim/issues/comments/2553305889",
            "user": {
                "avatar_url": "https://avatars.githubusercontent.com/u/65824523?v=4",
                "events_url": "https://api.github.com/users/vanaigr/events{/privacy}",
                "followers_url": "https://api.github.com/users/vanaigr/followers",
                "following_url": "https://api.github.com/users/vanaigr/following{/other_user}",
                "gists_url": "https://api.github.com/users/vanaigr/gists{/gist_id}",
                "gravatar_id": "",
                "html_url": "https://github.com/vanaigr",
                "id": 65824523,
                "login": "vanaigr",
                "node_id": "MDQ6VXNlcjY1ODI0NTIz",
                "organizations_url": "https://api.github.com/users/vanaigr/orgs",
                "received_events_url": "https://api.github.com/users/vanaigr/received_events",
                "repos_url": "https://api.github.com/users/vanaigr/repos",
                "site_admin": false,
                "starred_url": "https://api.github.com/users/vanaigr/starred{/owner}{/repo}",
                "subscriptions_url": "https://api.github.com/users/vanaigr/subscriptions",
                "type": "User",
                "url": "https://api.github.com/users/vanaigr",
                "user_view_type": "public"
            }
        },
        {
            "author_association": "CONTRIBUTOR",
            "body": "> That said, there are still some stutters at times (with the gigantic file), which is disappointing. \r\n\r\nThis may also be cause by injections, since injection queries run on the whole file after each change (related https://github.com/neovim/neovim/pull/26827).\r\n\r\nDeleting the `queries/<filetype>/injections.scm` file in e.g. nvim-treesitter should disable injections.",
            "created_at": "2024-12-19T19:06:11Z",
            "html_url": "https://github.com/neovim/neovim/pull/31631#issuecomment-2555578395",
            "id": 2555578395,
            "issue_url": "https://api.github.com/repos/neovim/neovim/issues/31631",
            "node_id": "IC_kwDOAPphoM6YUwgb",
            "performed_via_github_app": null,
            "reactions": {
                "+1": 0,
                "-1": 0,
                "confused": 0,
                "eyes": 0,
                "heart": 0,
                "hooray": 0,
                "laugh": 0,
                "rocket": 0,
                "total_count": 0,
                "url": "https://api.github.com/repos/neovim/neovim/issues/comments/2555578395/reactions"
            },
            "updated_at": "2024-12-19T19:06:35Z",
            "url": "https://api.github.com/repos/neovim/neovim/issues/comments/2555578395",
            "user": {
                "avatar_url": "https://avatars.githubusercontent.com/u/65824523?v=4",
                "events_url": "https://api.github.com/users/vanaigr/events{/privacy}",
                "followers_url": "https://api.github.com/users/vanaigr/followers",
                "following_url": "https://api.github.com/users/vanaigr/following{/other_user}",
                "gists_url": "https://api.github.com/users/vanaigr/gists{/gist_id}",
                "gravatar_id": "",
                "html_url": "https://github.com/vanaigr",
                "id": 65824523,
                "login": "vanaigr",
                "node_id": "MDQ6VXNlcjY1ODI0NTIz",
                "organizations_url": "https://api.github.com/users/vanaigr/orgs",
                "received_events_url": "https://api.github.com/users/vanaigr/received_events",
                "repos_url": "https://api.github.com/users/vanaigr/repos",
                "site_admin": false,
                "starred_url": "https://api.github.com/users/vanaigr/starred{/owner}{/repo}",
                "subscriptions_url": "https://api.github.com/users/vanaigr/subscriptions",
                "type": "User",
                "url": "https://api.github.com/users/vanaigr",
                "user_view_type": "public"
            }
        },
        {
            "author_association": "MEMBER",
            "body": "You are right, this makes editing much snappier :tada: There is still a bit of stuttering (likely due to the subtree balancing you mention above) but the effect is a lot less severe",
            "created_at": "2024-12-19T19:15:28Z",
            "html_url": "https://github.com/neovim/neovim/pull/31631#issuecomment-2555593943",
            "id": 2555593943,
            "issue_url": "https://api.github.com/repos/neovim/neovim/issues/31631",
            "node_id": "IC_kwDOAPphoM6YU0TX",
            "performed_via_github_app": null,
            "reactions": {
                "+1": 0,
                "-1": 0,
                "confused": 0,
                "eyes": 0,
                "heart": 0,
                "hooray": 0,
                "laugh": 0,
                "rocket": 0,
                "total_count": 0,
                "url": "https://api.github.com/repos/neovim/neovim/issues/comments/2555593943/reactions"
            },
            "updated_at": "2024-12-19T19:16:59Z",
            "url": "https://api.github.com/repos/neovim/neovim/issues/comments/2555593943",
            "user": {
                "avatar_url": "https://avatars.githubusercontent.com/u/55766287?v=4",
                "events_url": "https://api.github.com/users/ribru17/events{/privacy}",
                "followers_url": "https://api.github.com/users/ribru17/followers",
                "following_url": "https://api.github.com/users/ribru17/following{/other_user}",
                "gists_url": "https://api.github.com/users/ribru17/gists{/gist_id}",
                "gravatar_id": "",
                "html_url": "https://github.com/ribru17",
                "id": 55766287,
                "login": "ribru17",
                "node_id": "MDQ6VXNlcjU1NzY2Mjg3",
                "organizations_url": "https://api.github.com/users/ribru17/orgs",
                "received_events_url": "https://api.github.com/users/ribru17/received_events",
                "repos_url": "https://api.github.com/users/ribru17/repos",
                "site_admin": false,
                "starred_url": "https://api.github.com/users/ribru17/starred{/owner}{/repo}",
                "subscriptions_url": "https://api.github.com/users/ribru17/subscriptions",
                "type": "User",
                "url": "https://api.github.com/users/ribru17",
                "user_view_type": "public"
            }
        },
        {
            "author_association": "MEMBER",
            "body": "Just tried this locally, wow, this kicks ass. \r\n\r\n(For anyone testing: be sure to use `VIMRUNTIME=./runtime/ ./build/bin/nvim --luamod-dev`)\r\n\r\nNotes:\r\n\r\n- Mention in \"Performance\" section of news.txt\r\n- Would be nice to [respect 'redrawtime' somehow](https://github.com/neovim/neovim/pull/22420#issuecomment-1446362921), but could track that as a backlog issue.",
            "created_at": "2024-12-20T11:52:40Z",
            "html_url": "https://github.com/neovim/neovim/pull/31631#issuecomment-2556853291",
            "id": 2556853291,
            "issue_url": "https://api.github.com/repos/neovim/neovim/issues/31631",
            "node_id": "IC_kwDOAPphoM6YZnwr",
            "performed_via_github_app": null,
            "reactions": {
                "+1": 3,
                "-1": 0,
                "confused": 0,
                "eyes": 0,
                "heart": 0,
                "hooray": 0,
                "laugh": 2,
                "rocket": 8,
                "total_count": 13,
                "url": "https://api.github.com/repos/neovim/neovim/issues/comments/2556853291/reactions"
            },
            "updated_at": "2024-12-20T12:11:34Z",
            "url": "https://api.github.com/repos/neovim/neovim/issues/comments/2556853291",
            "user": {
                "avatar_url": "https://avatars.githubusercontent.com/u/1359421?v=4",
                "events_url": "https://api.github.com/users/justinmk/events{/privacy}",
                "followers_url": "https://api.github.com/users/justinmk/followers",
                "following_url": "https://api.github.com/users/justinmk/following{/other_user}",
                "gists_url": "https://api.github.com/users/justinmk/gists{/gist_id}",
                "gravatar_id": "",
                "html_url": "https://github.com/justinmk",
                "id": 1359421,
                "login": "justinmk",
                "node_id": "MDQ6VXNlcjEzNTk0MjE=",
                "organizations_url": "https://api.github.com/users/justinmk/orgs",
                "received_events_url": "https://api.github.com/users/justinmk/received_events",
                "repos_url": "https://api.github.com/users/justinmk/repos",
                "site_admin": false,
                "starred_url": "https://api.github.com/users/justinmk/starred{/owner}{/repo}",
                "subscriptions_url": "https://api.github.com/users/justinmk/subscriptions",
                "type": "User",
                "url": "https://api.github.com/users/justinmk",
                "user_view_type": "public"
            }
        },
        {
            "author_association": "MEMBER",
            "body": "I don't know if all edge cases are handled by applying this patch, but it completely removes all stutter. Opening the big linux file and large lua file are both instant with no stutters ever. Works wonderfully, hopefully we can get a followup PR for this soon. Basically just a poor man's #26827\r\n\r\n```patch\r\ndiff --git a/runtime/lua/vim/treesitter/languagetree.lua b/runtime/lua/vim/treesitter/languagetree.lua\r\nindex 171baebd48..026fd84473 100644\r\n--- a/runtime/lua/vim/treesitter/languagetree.lua\r\n+++ b/runtime/lua/vim/treesitter/languagetree.lua\r\n@@ -917,16 +917,18 @@ function LanguageTree:_get_injections()\r\n \r\n   for index, tree in pairs(self._trees) do\r\n     local root_node = tree:root()\r\n-    local start_line, _, end_line, _ = root_node:range()\r\n-\r\n-    for pattern, match, metadata in\r\n-      self._injection_query:iter_matches(root_node, self._source, start_line, end_line + 1)\r\n-    do\r\n-      local lang, combined, ranges = self:_get_injection(match, metadata)\r\n-      if lang then\r\n-        add_injection(injections, index, pattern, lang, combined, ranges)\r\n-      else\r\n-        self:_log('match from injection query failed for pattern', pattern)\r\n+\r\n+    for _, win in pairs(vim.api.nvim_tabpage_list_wins(0)) do\r\n+      local topline, botline = vim.fn.line('w0', win) - 1, vim.fn.line('w$', win)\r\n+      for pattern, match, metadata in\r\n+        self._injection_query:iter_matches(root_node, self._source, topline, botline)\r\n+      do\r\n+        local lang, combined, ranges = self:_get_injection(match, metadata)\r\n+        if lang then\r\n+          add_injection(injections, index, pattern, lang, combined, ranges)\r\n+        else\r\n+          self:_log('match from injection query failed for pattern', pattern)\r\n+        end\r\n       end\r\n     end\r\n   end\r\n```",
            "created_at": "2024-12-20T21:31:39Z",
            "html_url": "https://github.com/neovim/neovim/pull/31631#issuecomment-2557742970",
            "id": 2557742970,
            "issue_url": "https://api.github.com/repos/neovim/neovim/issues/31631",
            "node_id": "IC_kwDOAPphoM6YdA96",
            "performed_via_github_app": null,
            "reactions": {
                "+1": 0,
                "-1": 0,
                "confused": 0,
                "eyes": 0,
                "heart": 0,
                "hooray": 0,
                "laugh": 0,
                "rocket": 0,
                "total_count": 0,
                "url": "https://api.github.com/repos/neovim/neovim/issues/comments/2557742970/reactions"
            },
            "updated_at": "2024-12-20T21:31:39Z",
            "url": "https://api.github.com/repos/neovim/neovim/issues/comments/2557742970",
            "user": {
                "avatar_url": "https://avatars.githubusercontent.com/u/55766287?v=4",
                "events_url": "https://api.github.com/users/ribru17/events{/privacy}",
                "followers_url": "https://api.github.com/users/ribru17/followers",
                "following_url": "https://api.github.com/users/ribru17/following{/other_user}",
                "gists_url": "https://api.github.com/users/ribru17/gists{/gist_id}",
                "gravatar_id": "",
                "html_url": "https://github.com/ribru17",
                "id": 55766287,
                "login": "ribru17",
                "node_id": "MDQ6VXNlcjU1NzY2Mjg3",
                "organizations_url": "https://api.github.com/users/ribru17/orgs",
                "received_events_url": "https://api.github.com/users/ribru17/received_events",
                "repos_url": "https://api.github.com/users/ribru17/repos",
                "site_admin": false,
                "starred_url": "https://api.github.com/users/ribru17/starred{/owner}{/repo}",
                "subscriptions_url": "https://api.github.com/users/ribru17/subscriptions",
                "type": "User",
                "url": "https://api.github.com/users/ribru17",
                "user_view_type": "public"
            }
        },
        {
            "author_association": "MEMBER",
            "body": "Have you tested this change on https://raw.githubusercontent.com/torvalds/linux/master/drivers/gpu/drm/amd/include/asic_reg/dcn/dcn_3_2_0_sh_mask.h ?\n\nLast time I tried there was a bug in treesitter which meant it never parsed and just hung. That's kinda what derailed me working on the PR.",
            "created_at": "2024-12-21T00:54:14Z",
            "html_url": "https://github.com/neovim/neovim/pull/31631#issuecomment-2557925416",
            "id": 2557925416,
            "issue_url": "https://api.github.com/repos/neovim/neovim/issues/31631",
            "node_id": "IC_kwDOAPphoM6Ydtgo",
            "performed_via_github_app": null,
            "reactions": {
                "+1": 0,
                "-1": 0,
                "confused": 0,
                "eyes": 0,
                "heart": 0,
                "hooray": 0,
                "laugh": 0,
                "rocket": 0,
                "total_count": 0,
                "url": "https://api.github.com/repos/neovim/neovim/issues/comments/2557925416/reactions"
            },
            "updated_at": "2024-12-21T00:54:14Z",
            "url": "https://api.github.com/repos/neovim/neovim/issues/comments/2557925416",
            "user": {
                "avatar_url": "https://avatars.githubusercontent.com/u/7904185?v=4",
                "events_url": "https://api.github.com/users/lewis6991/events{/privacy}",
                "followers_url": "https://api.github.com/users/lewis6991/followers",
                "following_url": "https://api.github.com/users/lewis6991/following{/other_user}",
                "gists_url": "https://api.github.com/users/lewis6991/gists{/gist_id}",
                "gravatar_id": "",
                "html_url": "https://github.com/lewis6991",
                "id": 7904185,
                "login": "lewis6991",
                "node_id": "MDQ6VXNlcjc5MDQxODU=",
                "organizations_url": "https://api.github.com/users/lewis6991/orgs",
                "received_events_url": "https://api.github.com/users/lewis6991/received_events",
                "repos_url": "https://api.github.com/users/lewis6991/repos",
                "site_admin": false,
                "starred_url": "https://api.github.com/users/lewis6991/starred{/owner}{/repo}",
                "subscriptions_url": "https://api.github.com/users/lewis6991/subscriptions",
                "type": "User",
                "url": "https://api.github.com/users/lewis6991",
                "user_view_type": "public"
            }
        },
        {
            "author_association": "MEMBER",
            "body": "Yea that was the main file I tested this PR with, it works with that file. Not sure why yours didn't- I remember months ago when I tested it, setting a very low segment time like 1ms also meant it did not work with smaller files so I had wondered at the time if that PR for some reason didn't continue parsing if it exceeded the segment time, but I didn't dig deep enough then\r\n\r\nThe only real bottleneck now for files like that is the injection stuff",
            "created_at": "2024-12-21T01:02:37Z",
            "html_url": "https://github.com/neovim/neovim/pull/31631#issuecomment-2557928916",
            "id": 2557928916,
            "issue_url": "https://api.github.com/repos/neovim/neovim/issues/31631",
            "node_id": "IC_kwDOAPphoM6YduXU",
            "performed_via_github_app": null,
            "reactions": {
                "+1": 0,
                "-1": 0,
                "confused": 0,
                "eyes": 0,
                "heart": 0,
                "hooray": 0,
                "laugh": 0,
                "rocket": 0,
                "total_count": 0,
                "url": "https://api.github.com/repos/neovim/neovim/issues/comments/2557928916/reactions"
            },
            "updated_at": "2024-12-21T01:02:37Z",
            "url": "https://api.github.com/repos/neovim/neovim/issues/comments/2557928916",
            "user": {
                "avatar_url": "https://avatars.githubusercontent.com/u/55766287?v=4",
                "events_url": "https://api.github.com/users/ribru17/events{/privacy}",
                "followers_url": "https://api.github.com/users/ribru17/followers",
                "following_url": "https://api.github.com/users/ribru17/following{/other_user}",
                "gists_url": "https://api.github.com/users/ribru17/gists{/gist_id}",
                "gravatar_id": "",
                "html_url": "https://github.com/ribru17",
                "id": 55766287,
                "login": "ribru17",
                "node_id": "MDQ6VXNlcjU1NzY2Mjg3",
                "organizations_url": "https://api.github.com/users/ribru17/orgs",
                "received_events_url": "https://api.github.com/users/ribru17/received_events",
                "repos_url": "https://api.github.com/users/ribru17/repos",
                "site_admin": false,
                "starred_url": "https://api.github.com/users/ribru17/starred{/owner}{/repo}",
                "subscriptions_url": "https://api.github.com/users/ribru17/subscriptions",
                "type": "User",
                "url": "https://api.github.com/users/ribru17",
                "user_view_type": "public"
            }
        },
        {
            "author_association": "MEMBER",
            "body": "Does 1ms work with this PR?\n\nAt the time I did debug it and was confident it was a treesitter bug.\n\n> The only real bottleneck now for files like that is the injection stuff\n\n#26827 will be the way to go I think, however I think the code in that PR needs a little more abstraction to make it more maintainable. The languagetree is already quite complicated.",
            "created_at": "2024-12-21T01:04:26Z",
            "html_url": "https://github.com/neovim/neovim/pull/31631#issuecomment-2557929605",
            "id": 2557929605,
            "issue_url": "https://api.github.com/repos/neovim/neovim/issues/31631",
            "node_id": "IC_kwDOAPphoM6YduiF",
            "performed_via_github_app": null,
            "reactions": {
                "+1": 1,
                "-1": 0,
                "confused": 0,
                "eyes": 0,
                "heart": 0,
                "hooray": 0,
                "laugh": 0,
                "rocket": 0,
                "total_count": 1,
                "url": "https://api.github.com/repos/neovim/neovim/issues/comments/2557929605/reactions"
            },
            "updated_at": "2024-12-21T01:07:43Z",
            "url": "https://api.github.com/repos/neovim/neovim/issues/comments/2557929605",
            "user": {
                "avatar_url": "https://avatars.githubusercontent.com/u/7904185?v=4",
                "events_url": "https://api.github.com/users/lewis6991/events{/privacy}",
                "followers_url": "https://api.github.com/users/lewis6991/followers",
                "following_url": "https://api.github.com/users/lewis6991/following{/other_user}",
                "gists_url": "https://api.github.com/users/lewis6991/gists{/gist_id}",
                "gravatar_id": "",
                "html_url": "https://github.com/lewis6991",
                "id": 7904185,
                "login": "lewis6991",
                "node_id": "MDQ6VXNlcjc5MDQxODU=",
                "organizations_url": "https://api.github.com/users/lewis6991/orgs",
                "received_events_url": "https://api.github.com/users/lewis6991/received_events",
                "repos_url": "https://api.github.com/users/lewis6991/repos",
                "site_admin": false,
                "starred_url": "https://api.github.com/users/lewis6991/starred{/owner}{/repo}",
                "subscriptions_url": "https://api.github.com/users/lewis6991/subscriptions",
                "type": "User",
                "url": "https://api.github.com/users/lewis6991",
                "user_view_type": "public"
            }
        },
        {
            "author_association": "MEMBER",
            "body": "1ms does work with this one, maybe the bug was fixed in TS side?\r\n\r\nMaybe unrelated, but I also have a hunch that the `check_timeout()` function from the previous PR was problematic; currently there is a bug in TS reported by vanaigr that the subtree balancing does not respect the timeout. So maybe `check_timeout()` expects parsing to fall within e.g. a 10ms range but the very last call to `parse()` takes 24ms due to this bug, which maybe was the root bug you encountered",
            "created_at": "2024-12-21T01:10:18Z",
            "html_url": "https://github.com/neovim/neovim/pull/31631#issuecomment-2557932035",
            "id": 2557932035,
            "issue_url": "https://api.github.com/repos/neovim/neovim/issues/31631",
            "node_id": "IC_kwDOAPphoM6YdvID",
            "performed_via_github_app": null,
            "reactions": {
                "+1": 0,
                "-1": 0,
                "confused": 0,
                "eyes": 0,
                "heart": 0,
                "hooray": 0,
                "laugh": 0,
                "rocket": 0,
                "total_count": 0,
                "url": "https://api.github.com/repos/neovim/neovim/issues/comments/2557932035/reactions"
            },
            "updated_at": "2024-12-21T01:10:18Z",
            "url": "https://api.github.com/repos/neovim/neovim/issues/comments/2557932035",
            "user": {
                "avatar_url": "https://avatars.githubusercontent.com/u/55766287?v=4",
                "events_url": "https://api.github.com/users/ribru17/events{/privacy}",
                "followers_url": "https://api.github.com/users/ribru17/followers",
                "following_url": "https://api.github.com/users/ribru17/following{/other_user}",
                "gists_url": "https://api.github.com/users/ribru17/gists{/gist_id}",
                "gravatar_id": "",
                "html_url": "https://github.com/ribru17",
                "id": 55766287,
                "login": "ribru17",
                "node_id": "MDQ6VXNlcjU1NzY2Mjg3",
                "organizations_url": "https://api.github.com/users/ribru17/orgs",
                "received_events_url": "https://api.github.com/users/ribru17/received_events",
                "repos_url": "https://api.github.com/users/ribru17/repos",
                "site_admin": false,
                "starred_url": "https://api.github.com/users/ribru17/starred{/owner}{/repo}",
                "subscriptions_url": "https://api.github.com/users/ribru17/subscriptions",
                "type": "User",
                "url": "https://api.github.com/users/ribru17",
                "user_view_type": "public"
            }
        },
        {
            "author_association": "MEMBER",
            "body": "Maybe, but I definitely remember just trying to force the thing to parse, regardless of any code I had. I even remember digging into the C code on the treesitter side to see what was happening. This is also the time I added the logging integration into treesitter.c, but by then I'd had enough. This was a while ago so hopefully it has been fixed since, which is good.\n\nReally pleased to hear that issue seems to have gone.",
            "created_at": "2024-12-21T01:16:22Z",
            "html_url": "https://github.com/neovim/neovim/pull/31631#issuecomment-2557934182",
            "id": 2557934182,
            "issue_url": "https://api.github.com/repos/neovim/neovim/issues/31631",
            "node_id": "IC_kwDOAPphoM6Ydvpm",
            "performed_via_github_app": null,
            "reactions": {
                "+1": 0,
                "-1": 0,
                "confused": 0,
                "eyes": 0,
                "heart": 3,
                "hooray": 0,
                "laugh": 0,
                "rocket": 0,
                "total_count": 3,
                "url": "https://api.github.com/repos/neovim/neovim/issues/comments/2557934182/reactions"
            },
            "updated_at": "2024-12-21T01:16:22Z",
            "url": "https://api.github.com/repos/neovim/neovim/issues/comments/2557934182",
            "user": {
                "avatar_url": "https://avatars.githubusercontent.com/u/7904185?v=4",
                "events_url": "https://api.github.com/users/lewis6991/events{/privacy}",
                "followers_url": "https://api.github.com/users/lewis6991/followers",
                "following_url": "https://api.github.com/users/lewis6991/following{/other_user}",
                "gists_url": "https://api.github.com/users/lewis6991/gists{/gist_id}",
                "gravatar_id": "",
                "html_url": "https://github.com/lewis6991",
                "id": 7904185,
                "login": "lewis6991",
                "node_id": "MDQ6VXNlcjc5MDQxODU=",
                "organizations_url": "https://api.github.com/users/lewis6991/orgs",
                "received_events_url": "https://api.github.com/users/lewis6991/received_events",
                "repos_url": "https://api.github.com/users/lewis6991/repos",
                "site_admin": false,
                "starred_url": "https://api.github.com/users/lewis6991/starred{/owner}{/repo}",
                "subscriptions_url": "https://api.github.com/users/lewis6991/subscriptions",
                "type": "User",
                "url": "https://api.github.com/users/lewis6991",
                "user_view_type": "public"
            }
        },
        {
            "author_association": "MEMBER",
            "body": "Ugh that sounds awful :laughing: I really appreciate all the work you've put into this, thanks so much",
            "created_at": "2024-12-21T01:18:40Z",
            "html_url": "https://github.com/neovim/neovim/pull/31631#issuecomment-2557934989",
            "id": 2557934989,
            "issue_url": "https://api.github.com/repos/neovim/neovim/issues/31631",
            "node_id": "IC_kwDOAPphoM6Ydv2N",
            "performed_via_github_app": null,
            "reactions": {
                "+1": 0,
                "-1": 0,
                "confused": 0,
                "eyes": 0,
                "heart": 0,
                "hooray": 0,
                "laugh": 0,
                "rocket": 0,
                "total_count": 0,
                "url": "https://api.github.com/repos/neovim/neovim/issues/comments/2557934989/reactions"
            },
            "updated_at": "2024-12-21T01:18:40Z",
            "url": "https://api.github.com/repos/neovim/neovim/issues/comments/2557934989",
            "user": {
                "avatar_url": "https://avatars.githubusercontent.com/u/55766287?v=4",
                "events_url": "https://api.github.com/users/ribru17/events{/privacy}",
                "followers_url": "https://api.github.com/users/ribru17/followers",
                "following_url": "https://api.github.com/users/ribru17/following{/other_user}",
                "gists_url": "https://api.github.com/users/ribru17/gists{/gist_id}",
                "gravatar_id": "",
                "html_url": "https://github.com/ribru17",
                "id": 55766287,
                "login": "ribru17",
                "node_id": "MDQ6VXNlcjU1NzY2Mjg3",
                "organizations_url": "https://api.github.com/users/ribru17/orgs",
                "received_events_url": "https://api.github.com/users/ribru17/received_events",
                "repos_url": "https://api.github.com/users/ribru17/repos",
                "site_admin": false,
                "starred_url": "https://api.github.com/users/ribru17/starred{/owner}{/repo}",
                "subscriptions_url": "https://api.github.com/users/ribru17/subscriptions",
                "type": "User",
                "url": "https://api.github.com/users/ribru17",
                "user_view_type": "public"
            }
        },
        {
            "author_association": "MEMBER",
            "body": "I would also like to add a test for editing before an async parse has finished, as well as one for the `redrawtime` timeout, but maybe this can be done in a follow up? :)",
            "created_at": "2024-12-22T16:31:23Z",
            "html_url": "https://github.com/neovim/neovim/pull/31631#issuecomment-2558511560",
            "id": 2558511560,
            "issue_url": "https://api.github.com/repos/neovim/neovim/issues/31631",
            "node_id": "IC_kwDOAPphoM6Yf8nI",
            "performed_via_github_app": null,
            "reactions": {
                "+1": 2,
                "-1": 0,
                "confused": 0,
                "eyes": 0,
                "heart": 0,
                "hooray": 0,
                "laugh": 0,
                "rocket": 0,
                "total_count": 2,
                "url": "https://api.github.com/repos/neovim/neovim/issues/comments/2558511560/reactions"
            },
            "updated_at": "2024-12-22T16:31:23Z",
            "url": "https://api.github.com/repos/neovim/neovim/issues/comments/2558511560",
            "user": {
                "avatar_url": "https://avatars.githubusercontent.com/u/55766287?v=4",
                "events_url": "https://api.github.com/users/ribru17/events{/privacy}",
                "followers_url": "https://api.github.com/users/ribru17/followers",
                "following_url": "https://api.github.com/users/ribru17/following{/other_user}",
                "gists_url": "https://api.github.com/users/ribru17/gists{/gist_id}",
                "gravatar_id": "",
                "html_url": "https://github.com/ribru17",
                "id": 55766287,
                "login": "ribru17",
                "node_id": "MDQ6VXNlcjU1NzY2Mjg3",
                "organizations_url": "https://api.github.com/users/ribru17/orgs",
                "received_events_url": "https://api.github.com/users/ribru17/received_events",
                "repos_url": "https://api.github.com/users/ribru17/repos",
                "site_admin": false,
                "starred_url": "https://api.github.com/users/ribru17/starred{/owner}{/repo}",
                "subscriptions_url": "https://api.github.com/users/ribru17/subscriptions",
                "type": "User",
                "url": "https://api.github.com/users/ribru17",
                "user_view_type": "public"
            }
        },
        {
            "author_association": "CONTRIBUTOR",
            "body": "I managed to crash neovim with this PR and find a reproduction.\r\n\r\n1. `make distclean && make`\r\n2. `VIMRUNTIME=./runtime/ ./build/bin/nvim --clean -u minimal.lua file.lua`\r\n3. Wait until the parse finishes (highlighting is visible)\r\n4. Open a new window (CTRL-W s). No need to switch into it\r\n5. Repeatedly press `xj`\r\n\r\nNeovim should crash.\r\n\r\nVersion:\r\n```console\r\nNVIM v0.11.0-dev-1385+g400ce42d0\r\nBuild type: Debug\r\nLuaJIT 2.1.1734355927\r\n```\r\n\r\nminimal.lua:\r\n```lua\r\nfor name, url in pairs {\r\n  nvim_treesitter = 'https://github.com/nvim-treesitter/nvim-treesitter.git'\r\n} do\r\n  local install_path = vim.fn.fnamemodify('nvim_issue/' .. name, ':p')\r\n  if vim.fn.isdirectory(install_path) == 0 then\r\n    vim.fn.system { 'git', 'clone', '--depth=1', url, install_path }\r\n  end\r\n  vim.opt.runtimepath:append(install_path)\r\nend\r\n\r\nrequire'nvim-treesitter.configs'.setup {\r\n  ensure_installed = { \"lua\" },\r\n  highlight = { enable = true },\r\n}\r\n```\r\n\r\nfile.lua:\r\n```lua\r\nvim.api.nvim_win_set_var('string') \r\n```\r\nrepeated 20'000 times",
            "created_at": "2024-12-22T18:34:31Z",
            "html_url": "https://github.com/neovim/neovim/pull/31631#issuecomment-2558550960",
            "id": 2558550960,
            "issue_url": "https://api.github.com/repos/neovim/neovim/issues/31631",
            "node_id": "IC_kwDOAPphoM6YgGOw",
            "performed_via_github_app": null,
            "reactions": {
                "+1": 3,
                "-1": 0,
                "confused": 0,
                "eyes": 0,
                "heart": 0,
                "hooray": 0,
                "laugh": 0,
                "rocket": 0,
                "total_count": 3,
                "url": "https://api.github.com/repos/neovim/neovim/issues/comments/2558550960/reactions"
            },
            "updated_at": "2024-12-22T18:43:04Z",
            "url": "https://api.github.com/repos/neovim/neovim/issues/comments/2558550960",
            "user": {
                "avatar_url": "https://avatars.githubusercontent.com/u/65824523?v=4",
                "events_url": "https://api.github.com/users/vanaigr/events{/privacy}",
                "followers_url": "https://api.github.com/users/vanaigr/followers",
                "following_url": "https://api.github.com/users/vanaigr/following{/other_user}",
                "gists_url": "https://api.github.com/users/vanaigr/gists{/gist_id}",
                "gravatar_id": "",
                "html_url": "https://github.com/vanaigr",
                "id": 65824523,
                "login": "vanaigr",
                "node_id": "MDQ6VXNlcjY1ODI0NTIz",
                "organizations_url": "https://api.github.com/users/vanaigr/orgs",
                "received_events_url": "https://api.github.com/users/vanaigr/received_events",
                "repos_url": "https://api.github.com/users/vanaigr/repos",
                "site_admin": false,
                "starred_url": "https://api.github.com/users/vanaigr/starred{/owner}{/repo}",
                "subscriptions_url": "https://api.github.com/users/vanaigr/subscriptions",
                "type": "User",
                "url": "https://api.github.com/users/vanaigr",
                "user_view_type": "public"
            }
        },
        {
            "author_association": "MEMBER",
            "body": "This looks like an issue when changing the last visible line: even without opening a new window just opening a file, waiting for highlighting to apply, then `L` and `xj` a few times also crashes...\r\n\r\nbacktrace:\r\n\r\n```\r\n           PID: 106353 (nvim)\r\n           UID: 1000 (whoami)\r\n           GID: 100 (users)\r\n        Signal: 11 (SEGV)\r\n     Timestamp: Sun 2024-12-22 10:59:58 PST (10min ago)\r\n  Command Line: /home/whoami/neovim/bin/nvim --embed --luamod-dev --clean large_file.lua\r\n    Executable: /home/whoami/neovim/bin/nvim\r\n Control Group: /user.slice/user-1000.slice/user@1000.service/app.slice/kitty-3051-11.scope\r\n          Unit: user@1000.service\r\n     User Unit: kitty-3051-11.scope\r\n         Slice: user-1000.slice\r\n     Owner UID: 1000 (whoami)\r\n       Boot ID: 824b443d7c1e415298ffd5832121e1f4\r\n    Machine ID: 6541f6ca719247c8b00690cbc51ddae1\r\n      Hostname: frametop\r\n       Storage: /var/lib/systemd/coredump/core.nvim.1000.824b443d7c1e415298ffd5832121e1f4.106353.1734893998000000.zst (present)\r\n  Size on Disk: 8.9M\r\n       Message: Process 106353 (nvim) of user 1000 dumped core.\r\n                \r\n                Module libgcc_s.so.1 without build-id.\r\n                Stack trace of thread 106353:\r\n                #0  0x000000000084a760 n/a (n/a + 0x0)\r\n                #1  0x000000000084a8f9 n/a (n/a + 0x0)\r\n                #2  0x000000000084b7eb n/a (n/a + 0x0)\r\n                #3  0x000000000084b997 n/a (n/a + 0x0)\r\n                #4  0x000000000083f394 n/a (n/a + 0x0)\r\n                #5  0x0000000000840fa7 n/a (n/a + 0x0)\r\n                #6  0x000000000061907a n/a (n/a + 0x0)\r\n                #7  0x00000000008775d6 n/a (n/a + 0x0)\r\n                ELF object binary architecture: AMD x86-64\r\n\r\nGNU gdb (GDB) 15.2\r\nCopyright (C) 2024 Free Software Foundation, Inc.\r\nLicense GPLv3+: GNU GPL version 3 or later <http://gnu.org/licenses/gpl.html>\r\nThis is free software: you are free to change and redistribute it.\r\nThere is NO WARRANTY, to the extent permitted by law.\r\nType \"show copying\" and \"show warranty\" for details.\r\nThis GDB was configured as \"x86_64-unknown-linux-gnu\".\r\nType \"show configuration\" for configuration details.\r\nFor bug reporting instructions, please see:\r\n<https://www.gnu.org/software/gdb/bugs/>.\r\nFind the GDB manual and other documentation resources online at:\r\n    <http://www.gnu.org/software/gdb/documentation/>.\r\n\r\nFor help, type \"help\".\r\nType \"apropos word\" to search for commands related to \"word\"...\r\nReading symbols from /home/whoami/neovim/bin/nvim...\r\n\r\nwarning: Can't open file anon_inode:[io_uring] which was expanded to anon_inode:[io_uring] during file-backed mapping note processing\r\n[New LWP 106353]\r\n[Thread debugging using libthread_db enabled]\r\nUsing host libthread_db library \"/nix/store/wn7v2vhyyyi6clcyn0s9ixvl7d4d87ic-glibc-2.40-36/lib/libthread_db.so.1\".\r\nCore was generated by `/home/whoami/neovim/bin/nvim --embed --luamod-dev --clean large_file.lua'.\r\nProgram terminated with signal SIGSEGV, Segmentation fault.\r\n#0  ts_tree_cursor_is_entry_visible (self=0x11d23738, index=14)\r\n    at /home/whoami/Documents/CodeProjects/neovim/.deps/build/src/treesitter/lib/src/tree_cursor.c:26\r\n26\t      parent_entry->subtree->ptr->production_id,\r\n\u001b[?2004h\u001b[5 q(gdb) exit\r\n\u001b[?2004l\r\n```",
            "created_at": "2024-12-22T18:48:58Z",
            "html_url": "https://github.com/neovim/neovim/pull/31631#issuecomment-2558555543",
            "id": 2558555543,
            "issue_url": "https://api.github.com/repos/neovim/neovim/issues/31631",
            "node_id": "IC_kwDOAPphoM6YgHWX",
            "performed_via_github_app": null,
            "reactions": {
                "+1": 2,
                "-1": 0,
                "confused": 0,
                "eyes": 1,
                "heart": 0,
                "hooray": 0,
                "laugh": 0,
                "rocket": 0,
                "total_count": 3,
                "url": "https://api.github.com/repos/neovim/neovim/issues/comments/2558555543/reactions"
            },
            "updated_at": "2024-12-22T19:11:06Z",
            "url": "https://api.github.com/repos/neovim/neovim/issues/comments/2558555543",
            "user": {
                "avatar_url": "https://avatars.githubusercontent.com/u/55766287?v=4",
                "events_url": "https://api.github.com/users/ribru17/events{/privacy}",
                "followers_url": "https://api.github.com/users/ribru17/followers",
                "following_url": "https://api.github.com/users/ribru17/following{/other_user}",
                "gists_url": "https://api.github.com/users/ribru17/gists{/gist_id}",
                "gravatar_id": "",
                "html_url": "https://github.com/ribru17",
                "id": 55766287,
                "login": "ribru17",
                "node_id": "MDQ6VXNlcjU1NzY2Mjg3",
                "organizations_url": "https://api.github.com/users/ribru17/orgs",
                "received_events_url": "https://api.github.com/users/ribru17/received_events",
                "repos_url": "https://api.github.com/users/ribru17/repos",
                "site_admin": false,
                "starred_url": "https://api.github.com/users/ribru17/starred{/owner}{/repo}",
                "subscriptions_url": "https://api.github.com/users/ribru17/subscriptions",
                "type": "User",
                "url": "https://api.github.com/users/ribru17",
                "user_view_type": "public"
            }
        },
        {
            "author_association": "CONTRIBUTOR",
            "body": "gdb backtrace:\r\n\r\n```console\r\n#0  0x00005555559faca7 in ts_tree_cursor_parent_node ()\r\n#1  0x00005555559ee971 in ts_query_cursor.advance ()\r\n#2  0x00005555559f02e5 in ts_query_cursor_next_capture ()\r\n#3  0x00005555557b6c57 in querycursor_next_capture (L=0x7ffff7e6b380)\r\n#4  0x0000555555a24d56 in lj_BC_FUNCC ()\r\n#5  0x0000555555a10da9 in lua_pcall (L=0x7ffff7e6b380, nargs=<optimized out>, nresults=1, errfunc=<optimized out>) at lj_api.c:1122\r\n#6  0x00005555557a8ef8 in nlua_pcall (lstate=0x7ffff7e6b380, nargs=4, nresults=1)\r\n#7  0x00005555557acdc0 in nlua_call_ref_ctx (fast=false, ref=65, name=0x555555aa7b93 \"line\", args=..., mode=kRetNilBool, arena=0x0, err=0x7fffffffbea0)\r\n#8  0x00005555557acc7f in nlua_call_ref (ref=65, name=0x555555aa7b93 \"line\", args=..., mode=kRetNilBool, arena=0x0, err=0x7fffffffbea0)\r\n#9  0x000055555567b06d in decor_provider_invoke (provider_idx=0, name=0x555555aa7b93 \"line\", ref=65, args=..., default_true=true)\r\n#10 0x000055555567bb2e in decor_providers_invoke_line (wp=0x555555c4a820, row=47, has_decor=0x7fffffffc030)\r\n#11 0x00005555556886ba in win_line (wp=0x555555c4a820, lnum=48, startrow=40, endrow=41, col_rows=0, spv=0x7fffffffd970, foldinfo=...)\r\n#12 0x0000555555694be3 in win_update (wp=0x555555c4a820)\r\n#13 0x000055555569011a in update_screen ()\r\n#14 0x0000555555818b7b in normal_redraw (s=0x7fffffffdb10)\r\n#15 0x0000555555818dfb in normal_check (state=0x7fffffffdb10)\r\n#16 0x00005555558f8458 in state_enter (s=0x7fffffffdb10)\r\n#17 0x00005555558168c2 in normal_enter (cmdwin=false, noexmode=false)\r\n#18 0x00005555557b9c44 in main (argc=6, argv=0x7fffffffdf18)\r\n```\r\n",
            "created_at": "2024-12-22T19:24:57Z",
            "html_url": "https://github.com/neovim/neovim/pull/31631#issuecomment-2558567331",
            "id": 2558567331,
            "issue_url": "https://api.github.com/repos/neovim/neovim/issues/31631",
            "node_id": "IC_kwDOAPphoM6YgKOj",
            "performed_via_github_app": null,
            "reactions": {
                "+1": 1,
                "-1": 0,
                "confused": 0,
                "eyes": 0,
                "heart": 0,
                "hooray": 0,
                "laugh": 0,
                "rocket": 0,
                "total_count": 1,
                "url": "https://api.github.com/repos/neovim/neovim/issues/comments/2558567331/reactions"
            },
            "updated_at": "2024-12-22T19:24:57Z",
            "url": "https://api.github.com/repos/neovim/neovim/issues/comments/2558567331",
            "user": {
                "avatar_url": "https://avatars.githubusercontent.com/u/65824523?v=4",
                "events_url": "https://api.github.com/users/vanaigr/events{/privacy}",
                "followers_url": "https://api.github.com/users/vanaigr/followers",
                "following_url": "https://api.github.com/users/vanaigr/following{/other_user}",
                "gists_url": "https://api.github.com/users/vanaigr/gists{/gist_id}",
                "gravatar_id": "",
                "html_url": "https://github.com/vanaigr",
                "id": 65824523,
                "login": "vanaigr",
                "node_id": "MDQ6VXNlcjY1ODI0NTIz",
                "organizations_url": "https://api.github.com/users/vanaigr/orgs",
                "received_events_url": "https://api.github.com/users/vanaigr/received_events",
                "repos_url": "https://api.github.com/users/vanaigr/repos",
                "site_admin": false,
                "starred_url": "https://api.github.com/users/vanaigr/starred{/owner}{/repo}",
                "subscriptions_url": "https://api.github.com/users/vanaigr/subscriptions",
                "type": "User",
                "url": "https://api.github.com/users/vanaigr",
                "user_view_type": "public"
            }
        },
        {
            "author_association": "MEMBER",
            "body": "We shouldn't be running the `on_line` callback before the async parse is done in `on_win`. This prob should be handled on ts side so as to not segfault, but this is a working (I think) patch in the meantime:\r\n\r\n```patch\r\ndiff --git a/runtime/lua/vim/treesitter/highlighter.lua b/runtime/lua/vim/treesitter/highlighter.lua\r\nindex 22fadf7490..125e112380 100644\r\n--- a/runtime/lua/vim/treesitter/highlighter.lua\r\n+++ b/runtime/lua/vim/treesitter/highlighter.lua\r\n@@ -381,11 +381,11 @@ function TSHighlighter._on_spell_nav(_, _, buf, srow, _, erow, _)\r\n end\r\n \r\n ---@private\r\n----@param _win integer\r\n+---@param win integer\r\n ---@param buf integer\r\n ---@param topline integer\r\n ---@param botline integer\r\n-function TSHighlighter._on_win(_, _win, buf, topline, botline)\r\n+function TSHighlighter._on_win(_, win, buf, topline, botline)\r\n   local self = TSHighlighter.active[buf]\r\n   if not self then\r\n     return false\r\n@@ -393,17 +393,23 @@ function TSHighlighter._on_win(_, _win, buf, topline, botline)\r\n   local range = { topline, botline + 1 }\r\n   self.tree:parse(range, function(trees)\r\n     if trees then\r\n-      self:_async_parse_callback(range)\r\n+      self:_async_parse_callback(win, buf, topline, botline + 1)\r\n     end\r\n   end)\r\n   self.redraw_count = self.redraw_count + 1\r\n-  return true\r\n+  return false\r\n end\r\n \r\n---- @param range [integer, integer]\r\n-function TSHighlighter:_async_parse_callback(range)\r\n-  self:prepare_highlight_states(unpack(range))\r\n-  api.nvim__redraw({ buf = self.bufnr, range = range, flush = false })\r\n+---@param win integer\r\n+---@param buf integer\r\n+---@param topline integer\r\n+---@param botline integer\r\n+function TSHighlighter:_async_parse_callback(win, buf, topline, botline)\r\n+  self:prepare_highlight_states(topline, botline)\r\n+  for line = topline, botline do\r\n+    self:_on_line(win, buf, line)\r\n+  end\r\n+  api.nvim__redraw({ buf = self.bufnr, range = { topline, botline }, flush = false })\r\n end\r\n \r\n api.nvim_set_decoration_provider(ns, {\r\n```",
            "created_at": "2024-12-22T21:28:45Z",
            "html_url": "https://github.com/neovim/neovim/pull/31631#issuecomment-2558607030",
            "id": 2558607030,
            "issue_url": "https://api.github.com/repos/neovim/neovim/issues/31631",
            "node_id": "IC_kwDOAPphoM6YgT62",
            "performed_via_github_app": null,
            "reactions": {
                "+1": 1,
                "-1": 0,
                "confused": 0,
                "eyes": 0,
                "heart": 0,
                "hooray": 0,
                "laugh": 0,
                "rocket": 0,
                "total_count": 1,
                "url": "https://api.github.com/repos/neovim/neovim/issues/comments/2558607030/reactions"
            },
            "updated_at": "2024-12-22T21:28:45Z",
            "url": "https://api.github.com/repos/neovim/neovim/issues/comments/2558607030",
            "user": {
                "avatar_url": "https://avatars.githubusercontent.com/u/55766287?v=4",
                "events_url": "https://api.github.com/users/ribru17/events{/privacy}",
                "followers_url": "https://api.github.com/users/ribru17/followers",
                "following_url": "https://api.github.com/users/ribru17/following{/other_user}",
                "gists_url": "https://api.github.com/users/ribru17/gists{/gist_id}",
                "gravatar_id": "",
                "html_url": "https://github.com/ribru17",
                "id": 55766287,
                "login": "ribru17",
                "node_id": "MDQ6VXNlcjU1NzY2Mjg3",
                "organizations_url": "https://api.github.com/users/ribru17/orgs",
                "received_events_url": "https://api.github.com/users/ribru17/received_events",
                "repos_url": "https://api.github.com/users/ribru17/repos",
                "site_admin": false,
                "starred_url": "https://api.github.com/users/ribru17/starred{/owner}{/repo}",
                "subscriptions_url": "https://api.github.com/users/ribru17/subscriptions",
                "type": "User",
                "url": "https://api.github.com/users/ribru17",
                "user_view_type": "public"
            }
        },
        {
            "author_association": "MEMBER",
            "body": "For incremental parses, it's likely the parse will happen without a single schedule. In such cases we should avoid calling nvim_redraw if we can since we will technically still be in the `on_win` handler.",
            "created_at": "2024-12-22T21:57:56Z",
            "html_url": "https://github.com/neovim/neovim/pull/31631#issuecomment-2558616947",
            "id": 2558616947,
            "issue_url": "https://api.github.com/repos/neovim/neovim/issues/31631",
            "node_id": "IC_kwDOAPphoM6YgWVz",
            "performed_via_github_app": null,
            "reactions": {
                "+1": 1,
                "-1": 0,
                "confused": 0,
                "eyes": 0,
                "heart": 0,
                "hooray": 0,
                "laugh": 0,
                "rocket": 0,
                "total_count": 1,
                "url": "https://api.github.com/repos/neovim/neovim/issues/comments/2558616947/reactions"
            },
            "updated_at": "2024-12-22T21:57:56Z",
            "url": "https://api.github.com/repos/neovim/neovim/issues/comments/2558616947",
            "user": {
                "avatar_url": "https://avatars.githubusercontent.com/u/7904185?v=4",
                "events_url": "https://api.github.com/users/lewis6991/events{/privacy}",
                "followers_url": "https://api.github.com/users/lewis6991/followers",
                "following_url": "https://api.github.com/users/lewis6991/following{/other_user}",
                "gists_url": "https://api.github.com/users/lewis6991/gists{/gist_id}",
                "gravatar_id": "",
                "html_url": "https://github.com/lewis6991",
                "id": 7904185,
                "login": "lewis6991",
                "node_id": "MDQ6VXNlcjc5MDQxODU=",
                "organizations_url": "https://api.github.com/users/lewis6991/orgs",
                "received_events_url": "https://api.github.com/users/lewis6991/received_events",
                "repos_url": "https://api.github.com/users/lewis6991/repos",
                "site_admin": false,
                "starred_url": "https://api.github.com/users/lewis6991/starred{/owner}{/repo}",
                "subscriptions_url": "https://api.github.com/users/lewis6991/subscriptions",
                "type": "User",
                "url": "https://api.github.com/users/lewis6991",
                "user_view_type": "public"
            }
        },
        {
            "author_association": "MEMBER",
            "body": "Great point- is there a more elegant solution than just giving the callback another parameter indicating whether or not it ran with 1+ schedules?",
            "created_at": "2024-12-23T02:07:24Z",
            "html_url": "https://github.com/neovim/neovim/pull/31631#issuecomment-2558762550",
            "id": 2558762550,
            "issue_url": "https://api.github.com/repos/neovim/neovim/issues/31631",
            "node_id": "IC_kwDOAPphoM6Yg542",
            "performed_via_github_app": null,
            "reactions": {
                "+1": 0,
                "-1": 0,
                "confused": 0,
                "eyes": 0,
                "heart": 0,
                "hooray": 0,
                "laugh": 0,
                "rocket": 0,
                "total_count": 0,
                "url": "https://api.github.com/repos/neovim/neovim/issues/comments/2558762550/reactions"
            },
            "updated_at": "2024-12-23T02:07:24Z",
            "url": "https://api.github.com/repos/neovim/neovim/issues/comments/2558762550",
            "user": {
                "avatar_url": "https://avatars.githubusercontent.com/u/55766287?v=4",
                "events_url": "https://api.github.com/users/ribru17/events{/privacy}",
                "followers_url": "https://api.github.com/users/ribru17/followers",
                "following_url": "https://api.github.com/users/ribru17/following{/other_user}",
                "gists_url": "https://api.github.com/users/ribru17/gists{/gist_id}",
                "gravatar_id": "",
                "html_url": "https://github.com/ribru17",
                "id": 55766287,
                "login": "ribru17",
                "node_id": "MDQ6VXNlcjU1NzY2Mjg3",
                "organizations_url": "https://api.github.com/users/ribru17/orgs",
                "received_events_url": "https://api.github.com/users/ribru17/received_events",
                "repos_url": "https://api.github.com/users/ribru17/repos",
                "site_admin": false,
                "starred_url": "https://api.github.com/users/ribru17/starred{/owner}{/repo}",
                "subscriptions_url": "https://api.github.com/users/ribru17/subscriptions",
                "type": "User",
                "url": "https://api.github.com/users/ribru17",
                "user_view_type": "public"
            }
        },
        {
            "author_association": "CONTRIBUTOR",
            "body": "> Great point- is there a more elegant solution than just giving the callback another parameter indicating whether or not it ran with 1+ schedules?\r\n\r\nOne solution would be to make `parse()` accept a timeout and make async parse schedule a parse.\r\nThis way the highlighter can call the first parse itself and decide what to do based on the result.\r\n\r\n\r\n\r\n\r\n\r\n",
            "created_at": "2024-12-23T03:49:34Z",
            "html_url": "https://github.com/neovim/neovim/pull/31631#issuecomment-2558852568",
            "id": 2558852568,
            "issue_url": "https://api.github.com/repos/neovim/neovim/issues/31631",
            "node_id": "IC_kwDOAPphoM6YhP3Y",
            "performed_via_github_app": null,
            "reactions": {
                "+1": 0,
                "-1": 0,
                "confused": 0,
                "eyes": 0,
                "heart": 0,
                "hooray": 0,
                "laugh": 0,
                "rocket": 0,
                "total_count": 0,
                "url": "https://api.github.com/repos/neovim/neovim/issues/comments/2558852568/reactions"
            },
            "updated_at": "2024-12-23T03:50:42Z",
            "url": "https://api.github.com/repos/neovim/neovim/issues/comments/2558852568",
            "user": {
                "avatar_url": "https://avatars.githubusercontent.com/u/65824523?v=4",
                "events_url": "https://api.github.com/users/vanaigr/events{/privacy}",
                "followers_url": "https://api.github.com/users/vanaigr/followers",
                "following_url": "https://api.github.com/users/vanaigr/following{/other_user}",
                "gists_url": "https://api.github.com/users/vanaigr/gists{/gist_id}",
                "gravatar_id": "",
                "html_url": "https://github.com/vanaigr",
                "id": 65824523,
                "login": "vanaigr",
                "node_id": "MDQ6VXNlcjY1ODI0NTIz",
                "organizations_url": "https://api.github.com/users/vanaigr/orgs",
                "received_events_url": "https://api.github.com/users/vanaigr/received_events",
                "repos_url": "https://api.github.com/users/vanaigr/repos",
                "site_admin": false,
                "starred_url": "https://api.github.com/users/vanaigr/starred{/owner}{/repo}",
                "subscriptions_url": "https://api.github.com/users/vanaigr/subscriptions",
                "type": "User",
                "url": "https://api.github.com/users/vanaigr",
                "user_view_type": "public"
            }
        },
        {
            "author_association": "MEMBER",
            "body": "But if we schedule the parse from the start, the callback will be scheduled as well which will cause the highlight flickering",
            "created_at": "2024-12-23T04:03:02Z",
            "html_url": "https://github.com/neovim/neovim/pull/31631#issuecomment-2558864202",
            "id": 2558864202,
            "issue_url": "https://api.github.com/repos/neovim/neovim/issues/31631",
            "node_id": "IC_kwDOAPphoM6YhStK",
            "performed_via_github_app": null,
            "reactions": {
                "+1": 0,
                "-1": 0,
                "confused": 0,
                "eyes": 0,
                "heart": 0,
                "hooray": 0,
                "laugh": 0,
                "rocket": 0,
                "total_count": 0,
                "url": "https://api.github.com/repos/neovim/neovim/issues/comments/2558864202/reactions"
            },
            "updated_at": "2024-12-23T04:03:02Z",
            "url": "https://api.github.com/repos/neovim/neovim/issues/comments/2558864202",
            "user": {
                "avatar_url": "https://avatars.githubusercontent.com/u/55766287?v=4",
                "events_url": "https://api.github.com/users/ribru17/events{/privacy}",
                "followers_url": "https://api.github.com/users/ribru17/followers",
                "following_url": "https://api.github.com/users/ribru17/following{/other_user}",
                "gists_url": "https://api.github.com/users/ribru17/gists{/gist_id}",
                "gravatar_id": "",
                "html_url": "https://github.com/ribru17",
                "id": 55766287,
                "login": "ribru17",
                "node_id": "MDQ6VXNlcjU1NzY2Mjg3",
                "organizations_url": "https://api.github.com/users/ribru17/orgs",
                "received_events_url": "https://api.github.com/users/ribru17/received_events",
                "repos_url": "https://api.github.com/users/ribru17/repos",
                "site_admin": false,
                "starred_url": "https://api.github.com/users/ribru17/starred{/owner}{/repo}",
                "subscriptions_url": "https://api.github.com/users/ribru17/subscriptions",
                "type": "User",
                "url": "https://api.github.com/users/ribru17",
                "user_view_type": "public"
            }
        },
        {
            "author_association": "CONTRIBUTOR",
            "body": "First parse will be called synchronously by the highlighter. If it finishes, the redrawing proceeds as normal. Otherwise the highlighter schedules an async parse. ",
            "created_at": "2024-12-23T04:06:19Z",
            "html_url": "https://github.com/neovim/neovim/pull/31631#issuecomment-2558867151",
            "id": 2558867151,
            "issue_url": "https://api.github.com/repos/neovim/neovim/issues/31631",
            "node_id": "IC_kwDOAPphoM6YhTbP",
            "performed_via_github_app": null,
            "reactions": {
                "+1": 0,
                "-1": 0,
                "confused": 0,
                "eyes": 0,
                "heart": 0,
                "hooray": 0,
                "laugh": 0,
                "rocket": 0,
                "total_count": 0,
                "url": "https://api.github.com/repos/neovim/neovim/issues/comments/2558867151/reactions"
            },
            "updated_at": "2024-12-23T04:08:27Z",
            "url": "https://api.github.com/repos/neovim/neovim/issues/comments/2558867151",
            "user": {
                "avatar_url": "https://avatars.githubusercontent.com/u/65824523?v=4",
                "events_url": "https://api.github.com/users/vanaigr/events{/privacy}",
                "followers_url": "https://api.github.com/users/vanaigr/followers",
                "following_url": "https://api.github.com/users/vanaigr/following{/other_user}",
                "gists_url": "https://api.github.com/users/vanaigr/gists{/gist_id}",
                "gravatar_id": "",
                "html_url": "https://github.com/vanaigr",
                "id": 65824523,
                "login": "vanaigr",
                "node_id": "MDQ6VXNlcjY1ODI0NTIz",
                "organizations_url": "https://api.github.com/users/vanaigr/orgs",
                "received_events_url": "https://api.github.com/users/vanaigr/received_events",
                "repos_url": "https://api.github.com/users/vanaigr/repos",
                "site_admin": false,
                "starred_url": "https://api.github.com/users/vanaigr/starred{/owner}{/repo}",
                "subscriptions_url": "https://api.github.com/users/vanaigr/subscriptions",
                "type": "User",
                "url": "https://api.github.com/users/vanaigr",
                "user_view_type": "public"
            }
        },
        {
            "author_association": "MEMBER",
            "body": "Ah I see. I worry that this solution might make for a less simplistic api though",
            "created_at": "2024-12-23T04:38:52Z",
            "html_url": "https://github.com/neovim/neovim/pull/31631#issuecomment-2558894614",
            "id": 2558894614,
            "issue_url": "https://api.github.com/repos/neovim/neovim/issues/31631",
            "node_id": "IC_kwDOAPphoM6YhaIW",
            "performed_via_github_app": null,
            "reactions": {
                "+1": 0,
                "-1": 0,
                "confused": 0,
                "eyes": 0,
                "heart": 0,
                "hooray": 0,
                "laugh": 0,
                "rocket": 0,
                "total_count": 0,
                "url": "https://api.github.com/repos/neovim/neovim/issues/comments/2558894614/reactions"
            },
            "updated_at": "2024-12-23T04:38:52Z",
            "url": "https://api.github.com/repos/neovim/neovim/issues/comments/2558894614",
            "user": {
                "avatar_url": "https://avatars.githubusercontent.com/u/55766287?v=4",
                "events_url": "https://api.github.com/users/ribru17/events{/privacy}",
                "followers_url": "https://api.github.com/users/ribru17/followers",
                "following_url": "https://api.github.com/users/ribru17/following{/other_user}",
                "gists_url": "https://api.github.com/users/ribru17/gists{/gist_id}",
                "gravatar_id": "",
                "html_url": "https://github.com/ribru17",
                "id": 55766287,
                "login": "ribru17",
                "node_id": "MDQ6VXNlcjU1NzY2Mjg3",
                "organizations_url": "https://api.github.com/users/ribru17/orgs",
                "received_events_url": "https://api.github.com/users/ribru17/received_events",
                "repos_url": "https://api.github.com/users/ribru17/repos",
                "site_admin": false,
                "starred_url": "https://api.github.com/users/ribru17/starred{/owner}{/repo}",
                "subscriptions_url": "https://api.github.com/users/ribru17/subscriptions",
                "type": "User",
                "url": "https://api.github.com/users/ribru17",
                "user_view_type": "public"
            }
        },
        {
            "author_association": "CONTRIBUTOR",
            "body": "Can `uv` functions call the callback before returning? Since the signature was modeled after them, I think it should match their behavior",
            "created_at": "2024-12-23T04:58:18Z",
            "html_url": "https://github.com/neovim/neovim/pull/31631#issuecomment-2558910672",
            "id": 2558910672,
            "issue_url": "https://api.github.com/repos/neovim/neovim/issues/31631",
            "node_id": "IC_kwDOAPphoM6YheDQ",
            "performed_via_github_app": null,
            "reactions": {
                "+1": 0,
                "-1": 0,
                "confused": 0,
                "eyes": 0,
                "heart": 0,
                "hooray": 0,
                "laugh": 0,
                "rocket": 0,
                "total_count": 0,
                "url": "https://api.github.com/repos/neovim/neovim/issues/comments/2558910672/reactions"
            },
            "updated_at": "2024-12-23T04:58:18Z",
            "url": "https://api.github.com/repos/neovim/neovim/issues/comments/2558910672",
            "user": {
                "avatar_url": "https://avatars.githubusercontent.com/u/65824523?v=4",
                "events_url": "https://api.github.com/users/vanaigr/events{/privacy}",
                "followers_url": "https://api.github.com/users/vanaigr/followers",
                "following_url": "https://api.github.com/users/vanaigr/following{/other_user}",
                "gists_url": "https://api.github.com/users/vanaigr/gists{/gist_id}",
                "gravatar_id": "",
                "html_url": "https://github.com/vanaigr",
                "id": 65824523,
                "login": "vanaigr",
                "node_id": "MDQ6VXNlcjY1ODI0NTIz",
                "organizations_url": "https://api.github.com/users/vanaigr/orgs",
                "received_events_url": "https://api.github.com/users/vanaigr/received_events",
                "repos_url": "https://api.github.com/users/vanaigr/repos",
                "site_admin": false,
                "starred_url": "https://api.github.com/users/vanaigr/starred{/owner}{/repo}",
                "subscriptions_url": "https://api.github.com/users/vanaigr/subscriptions",
                "type": "User",
                "url": "https://api.github.com/users/vanaigr",
                "user_view_type": "public"
            }
        },
        {
            "author_association": "MEMBER",
            "body": "They don't, but that doesn't mean they can't or shouldn't. UV functions run their callbacks in fast events if they return immediately which can happen during the same event loop iteration, but at a later point.",
            "created_at": "2024-12-23T07:20:28Z",
            "html_url": "https://github.com/neovim/neovim/pull/31631#issuecomment-2559057442",
            "id": 2559057442,
            "issue_url": "https://api.github.com/repos/neovim/neovim/issues/31631",
            "node_id": "IC_kwDOAPphoM6YiB4i",
            "performed_via_github_app": null,
            "reactions": {
                "+1": 0,
                "-1": 0,
                "confused": 0,
                "eyes": 0,
                "heart": 0,
                "hooray": 0,
                "laugh": 0,
                "rocket": 0,
                "total_count": 0,
                "url": "https://api.github.com/repos/neovim/neovim/issues/comments/2559057442/reactions"
            },
            "updated_at": "2024-12-23T07:20:28Z",
            "url": "https://api.github.com/repos/neovim/neovim/issues/comments/2559057442",
            "user": {
                "avatar_url": "https://avatars.githubusercontent.com/u/7904185?v=4",
                "events_url": "https://api.github.com/users/lewis6991/events{/privacy}",
                "followers_url": "https://api.github.com/users/lewis6991/followers",
                "following_url": "https://api.github.com/users/lewis6991/following{/other_user}",
                "gists_url": "https://api.github.com/users/lewis6991/gists{/gist_id}",
                "gravatar_id": "",
                "html_url": "https://github.com/lewis6991",
                "id": 7904185,
                "login": "lewis6991",
                "node_id": "MDQ6VXNlcjc5MDQxODU=",
                "organizations_url": "https://api.github.com/users/lewis6991/orgs",
                "received_events_url": "https://api.github.com/users/lewis6991/received_events",
                "repos_url": "https://api.github.com/users/lewis6991/repos",
                "site_admin": false,
                "starred_url": "https://api.github.com/users/lewis6991/starred{/owner}{/repo}",
                "subscriptions_url": "https://api.github.com/users/lewis6991/subscriptions",
                "type": "User",
                "url": "https://api.github.com/users/lewis6991",
                "user_view_type": "public"
            }
        },
        {
            "author_association": "MEMBER",
            "body": "I think this works.\r\n\r\n```lua\r\n---@private\r\n---@param _win integer\r\n---@param buf integer\r\n---@param topline integer\r\n---@param botline integer\r\nfunction TSHighlighter._on_win(_, _win, buf, topline, botline)\r\n  local self = TSHighlighter.active[buf]\r\n  if not self then\r\n    return false\r\n  end\r\n  local range = { topline, botline + 1 }\r\n\r\n  local did_schedule = nil\r\n\r\n  self.tree:parse(range, function(trees)\r\n    if did_schedule == nil then\r\n      -- Callback executed immediately so it must not have scheduled\r\n      did_schedule = false\r\n    elseif trees then\r\n      self:_async_parse_callback(range)\r\n    end\r\n  end)\r\n\r\n  self.redraw_count = self.redraw_count + 1\r\n\r\n  if did_schedule == nil then\r\n    -- Callback didn't execute immediately so it must have scheduled\r\n    did_schedule = true\r\n    return false\r\n  end\r\n\r\n  return true\r\nend\r\n```",
            "created_at": "2024-12-23T08:54:12Z",
            "html_url": "https://github.com/neovim/neovim/pull/31631#issuecomment-2559235353",
            "id": 2559235353,
            "issue_url": "https://api.github.com/repos/neovim/neovim/issues/31631",
            "node_id": "IC_kwDOAPphoM6YitUZ",
            "performed_via_github_app": null,
            "reactions": {
                "+1": 0,
                "-1": 0,
                "confused": 0,
                "eyes": 0,
                "heart": 0,
                "hooray": 0,
                "laugh": 0,
                "rocket": 0,
                "total_count": 0,
                "url": "https://api.github.com/repos/neovim/neovim/issues/comments/2559235353/reactions"
            },
            "updated_at": "2024-12-23T08:54:35Z",
            "url": "https://api.github.com/repos/neovim/neovim/issues/comments/2559235353",
            "user": {
                "avatar_url": "https://avatars.githubusercontent.com/u/7904185?v=4",
                "events_url": "https://api.github.com/users/lewis6991/events{/privacy}",
                "followers_url": "https://api.github.com/users/lewis6991/followers",
                "following_url": "https://api.github.com/users/lewis6991/following{/other_user}",
                "gists_url": "https://api.github.com/users/lewis6991/gists{/gist_id}",
                "gravatar_id": "",
                "html_url": "https://github.com/lewis6991",
                "id": 7904185,
                "login": "lewis6991",
                "node_id": "MDQ6VXNlcjc5MDQxODU=",
                "organizations_url": "https://api.github.com/users/lewis6991/orgs",
                "received_events_url": "https://api.github.com/users/lewis6991/received_events",
                "repos_url": "https://api.github.com/users/lewis6991/repos",
                "site_admin": false,
                "starred_url": "https://api.github.com/users/lewis6991/starred{/owner}{/repo}",
                "subscriptions_url": "https://api.github.com/users/lewis6991/subscriptions",
                "type": "User",
                "url": "https://api.github.com/users/lewis6991",
                "user_view_type": "public"
            }
        },
        {
            "author_association": "MEMBER",
            "body": "> For incremental parses, it's likely the parse will happen without a single schedule. In such cases we should avoid calling nvim_redraw if we can since we will technically still be in the on_win handler.\r\n\r\nConversely, I think we also need avoid calling the `on_line` method for lines that haven't been parsed yet (so not from `topline` until `botline` but only the parsed range), and avoid calling `on_line` at all from scheduled `_async_parse_callback()`, which should call `nvim__redraw` instead.\r\n\r\n> I think this works.\r\n\r\nShould `LanguageTree:_async_parse` return whether it `finished`?",
            "created_at": "2024-12-23T10:21:17Z",
            "html_url": "https://github.com/neovim/neovim/pull/31631#issuecomment-2559378214",
            "id": 2559378214,
            "issue_url": "https://api.github.com/repos/neovim/neovim/issues/31631",
            "node_id": "IC_kwDOAPphoM6YjQMm",
            "performed_via_github_app": null,
            "reactions": {
                "+1": 0,
                "-1": 0,
                "confused": 0,
                "eyes": 0,
                "heart": 0,
                "hooray": 0,
                "laugh": 0,
                "rocket": 0,
                "total_count": 0,
                "url": "https://api.github.com/repos/neovim/neovim/issues/comments/2559378214/reactions"
            },
            "updated_at": "2024-12-23T10:21:17Z",
            "url": "https://api.github.com/repos/neovim/neovim/issues/comments/2559378214",
            "user": {
                "avatar_url": "https://avatars.githubusercontent.com/u/31730729?v=4",
                "events_url": "https://api.github.com/users/luukvbaal/events{/privacy}",
                "followers_url": "https://api.github.com/users/luukvbaal/followers",
                "following_url": "https://api.github.com/users/luukvbaal/following{/other_user}",
                "gists_url": "https://api.github.com/users/luukvbaal/gists{/gist_id}",
                "gravatar_id": "",
                "html_url": "https://github.com/luukvbaal",
                "id": 31730729,
                "login": "luukvbaal",
                "node_id": "MDQ6VXNlcjMxNzMwNzI5",
                "organizations_url": "https://api.github.com/users/luukvbaal/orgs",
                "received_events_url": "https://api.github.com/users/luukvbaal/received_events",
                "repos_url": "https://api.github.com/users/luukvbaal/repos",
                "site_admin": false,
                "starred_url": "https://api.github.com/users/luukvbaal/starred{/owner}{/repo}",
                "subscriptions_url": "https://api.github.com/users/luukvbaal/subscriptions",
                "type": "User",
                "url": "https://api.github.com/users/luukvbaal",
                "user_view_type": "public"
            }
        },
        {
            "author_association": "MEMBER",
            "body": "Putting this here for the record: would https://github.com/tree-sitter/tree-sitter/pull/3843 help with this in any way?",
            "created_at": "2024-12-23T11:09:51Z",
            "html_url": "https://github.com/neovim/neovim/pull/31631#issuecomment-2559473648",
            "id": 2559473648,
            "issue_url": "https://api.github.com/repos/neovim/neovim/issues/31631",
            "node_id": "IC_kwDOAPphoM6Yjnfw",
            "performed_via_github_app": null,
            "reactions": {
                "+1": 2,
                "-1": 0,
                "confused": 0,
                "eyes": 0,
                "heart": 0,
                "hooray": 0,
                "laugh": 0,
                "rocket": 0,
                "total_count": 2,
                "url": "https://api.github.com/repos/neovim/neovim/issues/comments/2559473648/reactions"
            },
            "updated_at": "2024-12-23T11:09:51Z",
            "url": "https://api.github.com/repos/neovim/neovim/issues/comments/2559473648",
            "user": {
                "avatar_url": "https://avatars.githubusercontent.com/u/2361214?v=4",
                "events_url": "https://api.github.com/users/clason/events{/privacy}",
                "followers_url": "https://api.github.com/users/clason/followers",
                "following_url": "https://api.github.com/users/clason/following{/other_user}",
                "gists_url": "https://api.github.com/users/clason/gists{/gist_id}",
                "gravatar_id": "",
                "html_url": "https://github.com/clason",
                "id": 2361214,
                "login": "clason",
                "node_id": "MDQ6VXNlcjIzNjEyMTQ=",
                "organizations_url": "https://api.github.com/users/clason/orgs",
                "received_events_url": "https://api.github.com/users/clason/received_events",
                "repos_url": "https://api.github.com/users/clason/repos",
                "site_admin": false,
                "starred_url": "https://api.github.com/users/clason/starred{/owner}{/repo}",
                "subscriptions_url": "https://api.github.com/users/clason/subscriptions",
                "type": "User",
                "url": "https://api.github.com/users/clason",
                "user_view_type": "public"
            }
        },
        {
            "author_association": "MEMBER",
            "body": "> I think this works.\r\n> \r\n> ```lua\r\n> -- ...\r\n> ```\r\n\r\nFor some reason, for me this doesn't redraw small files (that didn't require `vim.schedule`). Doing some debugging shows all the expected variable values/correct return values in `on_win` but my screen doesn't get colorful still. Works for large files that do need `vim.schedule` though\r\n\r\n> Should `LanguageTree:_async_parse` return whether it `finished`?\r\n\r\nI just tested this (along with passing whether it called `vim.schedule` into its own callback) and the result works for schedule and no-schedule cases, but there are not enough redraws. For example with the repeated `xj` example, every line where we press `x` does not get redrawn until the cursor moves down *after* waiting ~1.5 seconds for a parse refresh.\r\n\r\nWhat are the downsides of calling `nvim__redraw` in the callback no matter what, and always returning false in `on_win`? Are they disastrous or can they be accepted, given that (currently) my patch from [this comment](https://github.com/neovim/neovim/pull/31631#issuecomment-2558607030) seems to be the only thing working for all these cases (in my observations anyway)\r\n",
            "created_at": "2024-12-23T16:02:52Z",
            "html_url": "https://github.com/neovim/neovim/pull/31631#issuecomment-2559953976",
            "id": 2559953976,
            "issue_url": "https://api.github.com/repos/neovim/neovim/issues/31631",
            "node_id": "IC_kwDOAPphoM6Ylcw4",
            "performed_via_github_app": null,
            "reactions": {
                "+1": 0,
                "-1": 0,
                "confused": 0,
                "eyes": 0,
                "heart": 0,
                "hooray": 0,
                "laugh": 0,
                "rocket": 0,
                "total_count": 0,
                "url": "https://api.github.com/repos/neovim/neovim/issues/comments/2559953976/reactions"
            },
            "updated_at": "2024-12-23T16:02:52Z",
            "url": "https://api.github.com/repos/neovim/neovim/issues/comments/2559953976",
            "user": {
                "avatar_url": "https://avatars.githubusercontent.com/u/55766287?v=4",
                "events_url": "https://api.github.com/users/ribru17/events{/privacy}",
                "followers_url": "https://api.github.com/users/ribru17/followers",
                "following_url": "https://api.github.com/users/ribru17/following{/other_user}",
                "gists_url": "https://api.github.com/users/ribru17/gists{/gist_id}",
                "gravatar_id": "",
                "html_url": "https://github.com/ribru17",
                "id": 55766287,
                "login": "ribru17",
                "node_id": "MDQ6VXNlcjU1NzY2Mjg3",
                "organizations_url": "https://api.github.com/users/ribru17/orgs",
                "received_events_url": "https://api.github.com/users/ribru17/received_events",
                "repos_url": "https://api.github.com/users/ribru17/repos",
                "site_admin": false,
                "starred_url": "https://api.github.com/users/ribru17/starred{/owner}{/repo}",
                "subscriptions_url": "https://api.github.com/users/ribru17/subscriptions",
                "type": "User",
                "url": "https://api.github.com/users/ribru17",
                "user_view_type": "public"
            }
        },
        {
            "author_association": "MEMBER",
            "body": "> What are the downsides of calling nvim__redraw in the callback no matter what, and always returning false in on_win?\n\nThe downsides don't matter. If on_win isn't working as it is expected/designed to, then we should ideally resolve/debug that.\n\nIf you haven't already, maybe update the PR with the code you are running and lost the testcase that's failing for you. May even be worth adding that as an actual testcase into the testsuite.",
            "created_at": "2024-12-23T16:07:14Z",
            "html_url": "https://github.com/neovim/neovim/pull/31631#issuecomment-2559959857",
            "id": 2559959857,
            "issue_url": "https://api.github.com/repos/neovim/neovim/issues/31631",
            "node_id": "IC_kwDOAPphoM6YleMx",
            "performed_via_github_app": null,
            "reactions": {
                "+1": 1,
                "-1": 0,
                "confused": 0,
                "eyes": 0,
                "heart": 0,
                "hooray": 0,
                "laugh": 0,
                "rocket": 0,
                "total_count": 1,
                "url": "https://api.github.com/repos/neovim/neovim/issues/comments/2559959857/reactions"
            },
            "updated_at": "2024-12-23T16:07:14Z",
            "url": "https://api.github.com/repos/neovim/neovim/issues/comments/2559959857",
            "user": {
                "avatar_url": "https://avatars.githubusercontent.com/u/7904185?v=4",
                "events_url": "https://api.github.com/users/lewis6991/events{/privacy}",
                "followers_url": "https://api.github.com/users/lewis6991/followers",
                "following_url": "https://api.github.com/users/lewis6991/following{/other_user}",
                "gists_url": "https://api.github.com/users/lewis6991/gists{/gist_id}",
                "gravatar_id": "",
                "html_url": "https://github.com/lewis6991",
                "id": 7904185,
                "login": "lewis6991",
                "node_id": "MDQ6VXNlcjc5MDQxODU=",
                "organizations_url": "https://api.github.com/users/lewis6991/orgs",
                "received_events_url": "https://api.github.com/users/lewis6991/received_events",
                "repos_url": "https://api.github.com/users/lewis6991/repos",
                "site_admin": false,
                "starred_url": "https://api.github.com/users/lewis6991/starred{/owner}{/repo}",
                "subscriptions_url": "https://api.github.com/users/lewis6991/subscriptions",
                "type": "User",
                "url": "https://api.github.com/users/lewis6991",
                "user_view_type": "public"
            }
        },
        {
            "author_association": "MEMBER",
            "body": "I have been trying to add this test case, but it doesn't catch segfault errors as it always passes:\r\n\r\n```lua\r\n  it('does not crash when editing large files', function()\r\n    insert([[printf(\"%s\", \"some text\");]])\r\n    feed('yy49999p')\r\n\r\n    exec_lua(function()\r\n      _G.parser = vim.treesitter.get_parser(0, 'c')\r\n      _G.done = false\r\n      -- vim.treesitter.start(0, 'c')\r\n      _G.parser:parse(nil, function()\r\n        _G.done = true\r\n      end)\r\n      while not _G.done do\r\n        -- Busy wait until async parsing has completed\r\n        vim.wait(100, function() end)\r\n      end\r\n      -- vim.wait(3000, function() end)\r\n      -- vim.treesitter.start(0, 'c')\r\n    end)\r\n\r\n    eq(true, exec_lua([[return done]]))\r\n    -- feed_command('norm Lxjxjxjxj')\r\n    -- feed('Lxjxjxjxj') -- this should not segfault\r\n    feed('Lxj')\r\n    exec_lua(function()\r\n      _G.done = false\r\n      _G.parser:parse(nil, function()\r\n        _G.done = true\r\n      end)\r\n    end)\r\n    eq(false, exec_lua([[return done]]))\r\n    feed('xj')\r\n    eq(false, exec_lua([[return done]]))\r\n    feed('xj')\r\n    eq(false, exec_lua([[return done]]))\r\n    feed('xj')\r\n    assert_alive()\r\n    -- exec_lua(function()\r\n    --   vim.wait(20)\r\n    -- end)\r\n    -- feed('xj')\r\n    -- exec_lua(function()\r\n    --   vim.wait(20)\r\n    -- end)\r\n    -- feed('xj')\r\n    -- exec_lua(function()\r\n    --   vim.wait(20)\r\n    -- end)\r\n    -- feed('xj')\r\n    -- exec_lua(function()\r\n    --   vim.wait(20)\r\n    -- end)\r\n    assert_alive()\r\n  end)\r\n```",
            "created_at": "2024-12-23T16:53:36Z",
            "html_url": "https://github.com/neovim/neovim/pull/31631#issuecomment-2560023316",
            "id": 2560023316,
            "issue_url": "https://api.github.com/repos/neovim/neovim/issues/31631",
            "node_id": "IC_kwDOAPphoM6YltsU",
            "performed_via_github_app": null,
            "reactions": {
                "+1": 0,
                "-1": 0,
                "confused": 0,
                "eyes": 0,
                "heart": 0,
                "hooray": 0,
                "laugh": 0,
                "rocket": 0,
                "total_count": 0,
                "url": "https://api.github.com/repos/neovim/neovim/issues/comments/2560023316/reactions"
            },
            "updated_at": "2024-12-23T16:53:36Z",
            "url": "https://api.github.com/repos/neovim/neovim/issues/comments/2560023316",
            "user": {
                "avatar_url": "https://avatars.githubusercontent.com/u/55766287?v=4",
                "events_url": "https://api.github.com/users/ribru17/events{/privacy}",
                "followers_url": "https://api.github.com/users/ribru17/followers",
                "following_url": "https://api.github.com/users/ribru17/following{/other_user}",
                "gists_url": "https://api.github.com/users/ribru17/gists{/gist_id}",
                "gravatar_id": "",
                "html_url": "https://github.com/ribru17",
                "id": 55766287,
                "login": "ribru17",
                "node_id": "MDQ6VXNlcjU1NzY2Mjg3",
                "organizations_url": "https://api.github.com/users/ribru17/orgs",
                "received_events_url": "https://api.github.com/users/ribru17/received_events",
                "repos_url": "https://api.github.com/users/ribru17/repos",
                "site_admin": false,
                "starred_url": "https://api.github.com/users/ribru17/starred{/owner}{/repo}",
                "subscriptions_url": "https://api.github.com/users/ribru17/subscriptions",
                "type": "User",
                "url": "https://api.github.com/users/ribru17",
                "user_view_type": "public"
            }
        },
        {
            "author_association": "MEMBER",
            "body": "Based on the time it takes for the test to run, my theory is that `nvim_feed` waits until all `vim.schedule` type code has run until sending keys, so my test isn't properly spamming edits which is what segfaults",
            "created_at": "2024-12-23T16:56:24Z",
            "html_url": "https://github.com/neovim/neovim/pull/31631#issuecomment-2560026637",
            "id": 2560026637,
            "issue_url": "https://api.github.com/repos/neovim/neovim/issues/31631",
            "node_id": "IC_kwDOAPphoM6YlugN",
            "performed_via_github_app": null,
            "reactions": {
                "+1": 0,
                "-1": 0,
                "confused": 0,
                "eyes": 0,
                "heart": 0,
                "hooray": 0,
                "laugh": 0,
                "rocket": 0,
                "total_count": 0,
                "url": "https://api.github.com/repos/neovim/neovim/issues/comments/2560026637/reactions"
            },
            "updated_at": "2024-12-23T16:56:24Z",
            "url": "https://api.github.com/repos/neovim/neovim/issues/comments/2560026637",
            "user": {
                "avatar_url": "https://avatars.githubusercontent.com/u/55766287?v=4",
                "events_url": "https://api.github.com/users/ribru17/events{/privacy}",
                "followers_url": "https://api.github.com/users/ribru17/followers",
                "following_url": "https://api.github.com/users/ribru17/following{/other_user}",
                "gists_url": "https://api.github.com/users/ribru17/gists{/gist_id}",
                "gravatar_id": "",
                "html_url": "https://github.com/ribru17",
                "id": 55766287,
                "login": "ribru17",
                "node_id": "MDQ6VXNlcjU1NzY2Mjg3",
                "organizations_url": "https://api.github.com/users/ribru17/orgs",
                "received_events_url": "https://api.github.com/users/ribru17/received_events",
                "repos_url": "https://api.github.com/users/ribru17/repos",
                "site_admin": false,
                "starred_url": "https://api.github.com/users/ribru17/starred{/owner}{/repo}",
                "subscriptions_url": "https://api.github.com/users/ribru17/subscriptions",
                "type": "User",
                "url": "https://api.github.com/users/ribru17",
                "user_view_type": "public"
            }
        },
        {
            "author_association": "MEMBER",
            "body": "> Conversely, I think we also need avoid calling the `on_line` method for lines that haven't been parsed yet (so not from `topline` until `botline` but only the parsed range), and avoid calling `on_line` at all from scheduled `_async_parse_callback()`, which should call `nvim__redraw` instead.\r\n\r\nI thought topline to botline would be the parsed range? Also would it be acceptable to add a TODO for this, or is this critical enough that it should be done now",
            "created_at": "2024-12-23T17:20:40Z",
            "html_url": "https://github.com/neovim/neovim/pull/31631#issuecomment-2560059305",
            "id": 2560059305,
            "issue_url": "https://api.github.com/repos/neovim/neovim/issues/31631",
            "node_id": "IC_kwDOAPphoM6Yl2ep",
            "performed_via_github_app": null,
            "reactions": {
                "+1": 0,
                "-1": 0,
                "confused": 0,
                "eyes": 0,
                "heart": 0,
                "hooray": 0,
                "laugh": 0,
                "rocket": 0,
                "total_count": 0,
                "url": "https://api.github.com/repos/neovim/neovim/issues/comments/2560059305/reactions"
            },
            "updated_at": "2024-12-23T17:20:40Z",
            "url": "https://api.github.com/repos/neovim/neovim/issues/comments/2560059305",
            "user": {
                "avatar_url": "https://avatars.githubusercontent.com/u/55766287?v=4",
                "events_url": "https://api.github.com/users/ribru17/events{/privacy}",
                "followers_url": "https://api.github.com/users/ribru17/followers",
                "following_url": "https://api.github.com/users/ribru17/following{/other_user}",
                "gists_url": "https://api.github.com/users/ribru17/gists{/gist_id}",
                "gravatar_id": "",
                "html_url": "https://github.com/ribru17",
                "id": 55766287,
                "login": "ribru17",
                "node_id": "MDQ6VXNlcjU1NzY2Mjg3",
                "organizations_url": "https://api.github.com/users/ribru17/orgs",
                "received_events_url": "https://api.github.com/users/ribru17/received_events",
                "repos_url": "https://api.github.com/users/ribru17/repos",
                "site_admin": false,
                "starred_url": "https://api.github.com/users/ribru17/starred{/owner}{/repo}",
                "subscriptions_url": "https://api.github.com/users/ribru17/subscriptions",
                "type": "User",
                "url": "https://api.github.com/users/ribru17",
                "user_view_type": "public"
            }
        },
        {
            "author_association": "CONTRIBUTOR",
            "body": "This crashes when I run it in the editor, but not in functional test:\r\n```lua\r\nlocal line = [[printf(\"%s\", \"some text\");]]\r\nlocal lines = {}\r\nfor _ = 1, 50000 do\r\n  table.insert(lines, line)\r\nend\r\nvim.api.nvim_buf_set_lines(0, 0, -1, true, lines)\r\nvim.api.nvim_win_set_cursor(0, { 1, 7 })\r\n\r\nvim.treesitter.start(0, 'c')\r\nlocal parser = vim.treesitter.get_parser(0, 'c')\r\nparser:parse(true)\r\nvim.cmd('redraw!')\r\n\r\nvim.api.nvim_input('L')\r\n\r\nlocal i = 1\r\nlocal function step()\r\n  i = i + 1\r\n  if i > 1000 then\r\n    return\r\n  end\r\n  vim.api.nvim_input('xj')\r\n  vim.cmd('redraw!')\r\n  vim.defer_fn(step, 10)\r\nend\r\n\r\nvim.defer_fn(step, 10)\r\n```\r\n\r\nseems that `defer_fn()` doesn't defer in tests; setting timeout to 1000 doesn't slow down the test\r\n\r\nTest version:\r\n\r\n<details>\r\n\r\n<summary>test code</summary>\r\n\r\n```lua\r\n  it('does not crash when editing large files', function()\r\n    exec_lua(function()\r\n      local line = [[printf(\"%s\", \"some text\");]]\r\n      local lines = {}\r\n      for _ = 1, 50000 do\r\n        table.insert(lines, line)\r\n      end\r\n      vim.api.nvim_buf_set_lines(0, 0, -1, true, lines)\r\n      vim.api.nvim_win_set_cursor(0, { 1, 7 })\r\n\r\n      vim.treesitter.start(0, 'c')\r\n      local parser = vim.treesitter.get_parser(0, 'c')\r\n      parser:parse(true)\r\n      vim.cmd('redraw!')\r\n\r\n      vim.api.nvim_input('L')\r\n\r\n      local i = 1\r\n      local function step()\r\n        i = i + 1\r\n        if i > 1000 then\r\n          return\r\n        end\r\n        vim.api.nvim_input('xj')\r\n        vim.cmd('redraw!')\r\n        vim.defer_fn(step, 10)\r\n      end\r\n\r\n      vim.defer_fn(step, 10)\r\n    end)\r\n\r\n    assert_alive()\r\n  end)\r\n```\r\n\r\n</details>\r\n\r\nUPD: does this crash for the right reason?\r\n\r\n```lua\r\n  it('does not crash when editing large files', function()\r\n    exec_lua(function()\r\n      local line = [[printf(\"%s\", \"some text\");]]\r\n      local lines = {}\r\n      for _ = 1, 50000 do\r\n        table.insert(lines, line)\r\n      end\r\n      vim.api.nvim_buf_set_lines(0, 0, -1, true, lines)\r\n      vim.api.nvim_win_set_cursor(0, { 1, 7 })\r\n\r\n      vim.treesitter.start(0, 'c')\r\n      local parser = vim.treesitter.get_parser(0, 'c')\r\n      parser:parse(true)\r\n      vim.cmd('redraw!')\r\n\r\n      vim.api.nvim_input('L')\r\n\r\n      local i = 1\r\n      local function step()\r\n        i = i + 1\r\n        if i > 1000 then\r\n          return\r\n        end\r\n        vim.api.nvim_input('xj')\r\n        vim.cmd('redraw!')\r\n        vim.defer_fn(step, 10)\r\n      end\r\n\r\n      vim.defer_fn(step, 10)\r\n    end)\r\n\r\n    -- wait until the test above finishes...\r\n    local found = false\r\n    local a = ('_'):rep(1000000)\r\n    for i = 1, 1000000 do\r\n      local new_found = a:find('1', i)\r\n      found = found or new_found\r\n    end\r\n    print(found)\r\n\r\n    assert_alive()\r\n  end)\r\n```",
            "created_at": "2024-12-23T18:26:29Z",
            "html_url": "https://github.com/neovim/neovim/pull/31631#issuecomment-2560134154",
            "id": 2560134154,
            "issue_url": "https://api.github.com/repos/neovim/neovim/issues/31631",
            "node_id": "IC_kwDOAPphoM6YmIwK",
            "performed_via_github_app": null,
            "reactions": {
                "+1": 0,
                "-1": 0,
                "confused": 0,
                "eyes": 0,
                "heart": 0,
                "hooray": 0,
                "laugh": 0,
                "rocket": 0,
                "total_count": 0,
                "url": "https://api.github.com/repos/neovim/neovim/issues/comments/2560134154/reactions"
            },
            "updated_at": "2024-12-23T18:41:51Z",
            "url": "https://api.github.com/repos/neovim/neovim/issues/comments/2560134154",
            "user": {
                "avatar_url": "https://avatars.githubusercontent.com/u/65824523?v=4",
                "events_url": "https://api.github.com/users/vanaigr/events{/privacy}",
                "followers_url": "https://api.github.com/users/vanaigr/followers",
                "following_url": "https://api.github.com/users/vanaigr/following{/other_user}",
                "gists_url": "https://api.github.com/users/vanaigr/gists{/gist_id}",
                "gravatar_id": "",
                "html_url": "https://github.com/vanaigr",
                "id": 65824523,
                "login": "vanaigr",
                "node_id": "MDQ6VXNlcjY1ODI0NTIz",
                "organizations_url": "https://api.github.com/users/vanaigr/orgs",
                "received_events_url": "https://api.github.com/users/vanaigr/received_events",
                "repos_url": "https://api.github.com/users/vanaigr/repos",
                "site_admin": false,
                "starred_url": "https://api.github.com/users/vanaigr/starred{/owner}{/repo}",
                "subscriptions_url": "https://api.github.com/users/vanaigr/subscriptions",
                "type": "User",
                "url": "https://api.github.com/users/vanaigr",
                "user_view_type": "public"
            }
        },
        {
            "author_association": "MEMBER",
            "body": "Nice, I didn't know about `nvim_input`. This test successfully reproduces the crash for me:\r\n\r\n```lua\r\n  it('does not crash when editing large files', function()\r\n    insert([[printf(\"%s\", \"some text\");]])\r\n    feed('yy49999p')\r\n\r\n    exec_lua(function()\r\n      _G.parser = vim.treesitter.get_parser(0, 'c')\r\n      _G.done = false\r\n      vim.treesitter.start(0, 'c')\r\n      _G.parser:parse(nil, function()\r\n        _G.done = true\r\n      end)\r\n      while not _G.done do\r\n        -- Busy wait until async parsing has completed\r\n        vim.wait(100, function() end)\r\n      end\r\n    end)\r\n\r\n    eq(true, exec_lua([[return done]]))\r\n    exec_lua(function()\r\n      vim.api.nvim_input('Lxj')\r\n    end)\r\n    exec_lua(function()\r\n      vim.api.nvim_input('xj')\r\n    end)\r\n    exec_lua(function()\r\n      vim.api.nvim_input('xj')\r\n    end)\r\n    assert_alive()\r\n  end)\r\n```",
            "created_at": "2024-12-23T18:42:52Z",
            "html_url": "https://github.com/neovim/neovim/pull/31631#issuecomment-2560152124",
            "id": 2560152124,
            "issue_url": "https://api.github.com/repos/neovim/neovim/issues/31631",
            "node_id": "IC_kwDOAPphoM6YmNI8",
            "performed_via_github_app": null,
            "reactions": {
                "+1": 1,
                "-1": 0,
                "confused": 0,
                "eyes": 0,
                "heart": 0,
                "hooray": 0,
                "laugh": 0,
                "rocket": 0,
                "total_count": 1,
                "url": "https://api.github.com/repos/neovim/neovim/issues/comments/2560152124/reactions"
            },
            "updated_at": "2024-12-23T18:42:52Z",
            "url": "https://api.github.com/repos/neovim/neovim/issues/comments/2560152124",
            "user": {
                "avatar_url": "https://avatars.githubusercontent.com/u/55766287?v=4",
                "events_url": "https://api.github.com/users/ribru17/events{/privacy}",
                "followers_url": "https://api.github.com/users/ribru17/followers",
                "following_url": "https://api.github.com/users/ribru17/following{/other_user}",
                "gists_url": "https://api.github.com/users/ribru17/gists{/gist_id}",
                "gravatar_id": "",
                "html_url": "https://github.com/ribru17",
                "id": 55766287,
                "login": "ribru17",
                "node_id": "MDQ6VXNlcjU1NzY2Mjg3",
                "organizations_url": "https://api.github.com/users/ribru17/orgs",
                "received_events_url": "https://api.github.com/users/ribru17/received_events",
                "repos_url": "https://api.github.com/users/ribru17/repos",
                "site_admin": false,
                "starred_url": "https://api.github.com/users/ribru17/starred{/owner}{/repo}",
                "subscriptions_url": "https://api.github.com/users/ribru17/subscriptions",
                "type": "User",
                "url": "https://api.github.com/users/ribru17",
                "user_view_type": "public"
            }
        },
        {
            "author_association": "MEMBER",
            "body": "> I thought topline to botline would be the parsed range\r\n\r\nSorry, yes that seems right, I hadn't looked at the PR in detail yet and had a wrong picture of how this actually works. I thought there could be a situation where `async_parse_callback` could be called for a partially parsed range.\r\n\r\nFrom my understanding of `drawscreen.c` and the decor provider mechanism, the way this is currently implemented does still seem like we are misusing it a bit. Something like this seems better to me:\r\n```diff\r\n+++ b/runtime/lua/vim/treesitter/highlighter.lua\r\n@@ -394,7 +394,7 @@ function TSHighlighter._on_win(_, win, buf, topline, botline)\r\n     end\r\n   end)\r\n   self.redraw_count = self.redraw_count + 1\r\n-  return false\r\n+  return true\r\n end\r\n\r\n ---@param win integer\r\n@@ -403,10 +403,7 @@ end\r\n ---@param botline integer\r\n function TSHighlighter:_async_parse_callback(win, buf, topline, botline)\r\n   self:prepare_highlight_states(topline, botline)\r\n-  for line = topline, botline do\r\n-    self:_on_line(win, buf, line)\r\n-  end\r\n-  api.nvim__redraw({ buf = self.bufnr, range = { topline, botline + 1 }, flush = false })\r\n+  api.nvim__redraw({ buf = self.bufnr, flush = true })\r\n end\r\n\r\n api.nvim_set_decoration_provider(ns, {\r\n```\r\nThat seems to work on my end, with seemingly better performance too. (Didn't check the issue you are currently investigating).\r\n\r\nBut don't look to me to block this, as you can tell my own understanding is lacking\r\n\r\n\r\n",
            "created_at": "2024-12-23T18:47:40Z",
            "html_url": "https://github.com/neovim/neovim/pull/31631#issuecomment-2560156803",
            "id": 2560156803,
            "issue_url": "https://api.github.com/repos/neovim/neovim/issues/31631",
            "node_id": "IC_kwDOAPphoM6YmOSD",
            "performed_via_github_app": null,
            "reactions": {
                "+1": 1,
                "-1": 0,
                "confused": 0,
                "eyes": 0,
                "heart": 0,
                "hooray": 0,
                "laugh": 0,
                "rocket": 0,
                "total_count": 1,
                "url": "https://api.github.com/repos/neovim/neovim/issues/comments/2560156803/reactions"
            },
            "updated_at": "2024-12-23T18:47:40Z",
            "url": "https://api.github.com/repos/neovim/neovim/issues/comments/2560156803",
            "user": {
                "avatar_url": "https://avatars.githubusercontent.com/u/31730729?v=4",
                "events_url": "https://api.github.com/users/luukvbaal/events{/privacy}",
                "followers_url": "https://api.github.com/users/luukvbaal/followers",
                "following_url": "https://api.github.com/users/luukvbaal/following{/other_user}",
                "gists_url": "https://api.github.com/users/luukvbaal/gists{/gist_id}",
                "gravatar_id": "",
                "html_url": "https://github.com/luukvbaal",
                "id": 31730729,
                "login": "luukvbaal",
                "node_id": "MDQ6VXNlcjMxNzMwNzI5",
                "organizations_url": "https://api.github.com/users/luukvbaal/orgs",
                "received_events_url": "https://api.github.com/users/luukvbaal/received_events",
                "repos_url": "https://api.github.com/users/luukvbaal/repos",
                "site_admin": false,
                "starred_url": "https://api.github.com/users/luukvbaal/starred{/owner}{/repo}",
                "subscriptions_url": "https://api.github.com/users/luukvbaal/subscriptions",
                "type": "User",
                "url": "https://api.github.com/users/luukvbaal",
                "user_view_type": "public"
            }
        },
        {
            "author_association": "MEMBER",
            "body": "Ah ok I will try that. Thanks, I really appreciate the input :D\r\n\r\nEdit: unfortunately still causes the segfault: I think we can never `return true` from on_win when using async stuff, because it means trying to iterate captures of a stale tree. I think we must move it into the callback to ensure that the parse is complete first",
            "created_at": "2024-12-23T18:49:35Z",
            "html_url": "https://github.com/neovim/neovim/pull/31631#issuecomment-2560158791",
            "id": 2560158791,
            "issue_url": "https://api.github.com/repos/neovim/neovim/issues/31631",
            "node_id": "IC_kwDOAPphoM6YmOxH",
            "performed_via_github_app": null,
            "reactions": {
                "+1": 0,
                "-1": 0,
                "confused": 0,
                "eyes": 0,
                "heart": 0,
                "hooray": 0,
                "laugh": 0,
                "rocket": 0,
                "total_count": 0,
                "url": "https://api.github.com/repos/neovim/neovim/issues/comments/2560158791/reactions"
            },
            "updated_at": "2024-12-23T19:05:26Z",
            "url": "https://api.github.com/repos/neovim/neovim/issues/comments/2560158791",
            "user": {
                "avatar_url": "https://avatars.githubusercontent.com/u/55766287?v=4",
                "events_url": "https://api.github.com/users/ribru17/events{/privacy}",
                "followers_url": "https://api.github.com/users/ribru17/followers",
                "following_url": "https://api.github.com/users/ribru17/following{/other_user}",
                "gists_url": "https://api.github.com/users/ribru17/gists{/gist_id}",
                "gravatar_id": "",
                "html_url": "https://github.com/ribru17",
                "id": 55766287,
                "login": "ribru17",
                "node_id": "MDQ6VXNlcjU1NzY2Mjg3",
                "organizations_url": "https://api.github.com/users/ribru17/orgs",
                "received_events_url": "https://api.github.com/users/ribru17/received_events",
                "repos_url": "https://api.github.com/users/ribru17/repos",
                "site_admin": false,
                "starred_url": "https://api.github.com/users/ribru17/starred{/owner}{/repo}",
                "subscriptions_url": "https://api.github.com/users/ribru17/subscriptions",
                "type": "User",
                "url": "https://api.github.com/users/ribru17",
                "user_view_type": "public"
            }
        },
        {
            "author_association": "MEMBER",
            "body": "> unfortunately still causes the segfault: I think we can never return true from on_win when using async stuff\r\n\r\nYeah sorry, I think conditionally returning `true/false` (like in @lewis6991's patch) should still be applied as well.\r\n\r\nMy main point was that calling `on_line` explicitly from the callback seems off, especially in the scheduled context. That places ephemeral marks that will be cleared again before the window is redrawn. It seems to me that in scheduled context we should only prepare the highlight state, and trigger a redraw. In unscheduled context, where we are still in `on_win`, we should make sure `on_win` returns `true` and have the decor provider invoke its `on_line` callbacks as intended.",
            "created_at": "2024-12-23T19:22:19Z",
            "html_url": "https://github.com/neovim/neovim/pull/31631#issuecomment-2560194963",
            "id": 2560194963,
            "issue_url": "https://api.github.com/repos/neovim/neovim/issues/31631",
            "node_id": "IC_kwDOAPphoM6YmXmT",
            "performed_via_github_app": null,
            "reactions": {
                "+1": 1,
                "-1": 0,
                "confused": 0,
                "eyes": 0,
                "heart": 0,
                "hooray": 0,
                "laugh": 0,
                "rocket": 0,
                "total_count": 1,
                "url": "https://api.github.com/repos/neovim/neovim/issues/comments/2560194963/reactions"
            },
            "updated_at": "2024-12-23T19:27:06Z",
            "url": "https://api.github.com/repos/neovim/neovim/issues/comments/2560194963",
            "user": {
                "avatar_url": "https://avatars.githubusercontent.com/u/31730729?v=4",
                "events_url": "https://api.github.com/users/luukvbaal/events{/privacy}",
                "followers_url": "https://api.github.com/users/luukvbaal/followers",
                "following_url": "https://api.github.com/users/luukvbaal/following{/other_user}",
                "gists_url": "https://api.github.com/users/luukvbaal/gists{/gist_id}",
                "gravatar_id": "",
                "html_url": "https://github.com/luukvbaal",
                "id": 31730729,
                "login": "luukvbaal",
                "node_id": "MDQ6VXNlcjMxNzMwNzI5",
                "organizations_url": "https://api.github.com/users/luukvbaal/orgs",
                "received_events_url": "https://api.github.com/users/luukvbaal/received_events",
                "repos_url": "https://api.github.com/users/luukvbaal/repos",
                "site_admin": false,
                "starred_url": "https://api.github.com/users/luukvbaal/starred{/owner}{/repo}",
                "subscriptions_url": "https://api.github.com/users/luukvbaal/subscriptions",
                "type": "User",
                "url": "https://api.github.com/users/luukvbaal",
                "user_view_type": "public"
            }
        },
        {
            "author_association": "MEMBER",
            "body": "Hmm. Lewis' patch still doesn't apply highlighting to small files (non scheduled parse), even with the on_line change. In fact, with that one, highlighting doesn't apply to any files for some reason. This is also reflected by `highlight_spec.lua`",
            "created_at": "2024-12-23T19:34:03Z",
            "html_url": "https://github.com/neovim/neovim/pull/31631#issuecomment-2560206914",
            "id": 2560206914,
            "issue_url": "https://api.github.com/repos/neovim/neovim/issues/31631",
            "node_id": "IC_kwDOAPphoM6YmahC",
            "performed_via_github_app": null,
            "reactions": {
                "+1": 0,
                "-1": 0,
                "confused": 0,
                "eyes": 0,
                "heart": 0,
                "hooray": 0,
                "laugh": 0,
                "rocket": 0,
                "total_count": 0,
                "url": "https://api.github.com/repos/neovim/neovim/issues/comments/2560206914/reactions"
            },
            "updated_at": "2024-12-23T19:34:12Z",
            "url": "https://api.github.com/repos/neovim/neovim/issues/comments/2560206914",
            "user": {
                "avatar_url": "https://avatars.githubusercontent.com/u/55766287?v=4",
                "events_url": "https://api.github.com/users/ribru17/events{/privacy}",
                "followers_url": "https://api.github.com/users/ribru17/followers",
                "following_url": "https://api.github.com/users/ribru17/following{/other_user}",
                "gists_url": "https://api.github.com/users/ribru17/gists{/gist_id}",
                "gravatar_id": "",
                "html_url": "https://github.com/ribru17",
                "id": 55766287,
                "login": "ribru17",
                "node_id": "MDQ6VXNlcjU1NzY2Mjg3",
                "organizations_url": "https://api.github.com/users/ribru17/orgs",
                "received_events_url": "https://api.github.com/users/ribru17/received_events",
                "repos_url": "https://api.github.com/users/ribru17/repos",
                "site_admin": false,
                "starred_url": "https://api.github.com/users/ribru17/starred{/owner}{/repo}",
                "subscriptions_url": "https://api.github.com/users/ribru17/subscriptions",
                "type": "User",
                "url": "https://api.github.com/users/ribru17",
                "user_view_type": "public"
            }
        },
        {
            "author_association": "CONTRIBUTOR",
            "body": "https://github.com/neovim/neovim/pull/31631#issuecomment-2559057442\r\n> They don't, but that doesn't mean they can't or shouldn't. \r\n\r\nI assumed that \"asynchronous\" implies that the work executes after the current code finishes running (similar to JS). \r\nBut this is not the direction Neovim is going, correct?\r\n\r\n",
            "created_at": "2024-12-23T19:49:46Z",
            "html_url": "https://github.com/neovim/neovim/pull/31631#issuecomment-2560222417",
            "id": 2560222417,
            "issue_url": "https://api.github.com/repos/neovim/neovim/issues/31631",
            "node_id": "IC_kwDOAPphoM6YmeTR",
            "performed_via_github_app": null,
            "reactions": {
                "+1": 0,
                "-1": 0,
                "confused": 0,
                "eyes": 0,
                "heart": 0,
                "hooray": 0,
                "laugh": 0,
                "rocket": 0,
                "total_count": 0,
                "url": "https://api.github.com/repos/neovim/neovim/issues/comments/2560222417/reactions"
            },
            "updated_at": "2024-12-23T19:49:46Z",
            "url": "https://api.github.com/repos/neovim/neovim/issues/comments/2560222417",
            "user": {
                "avatar_url": "https://avatars.githubusercontent.com/u/65824523?v=4",
                "events_url": "https://api.github.com/users/vanaigr/events{/privacy}",
                "followers_url": "https://api.github.com/users/vanaigr/followers",
                "following_url": "https://api.github.com/users/vanaigr/following{/other_user}",
                "gists_url": "https://api.github.com/users/vanaigr/gists{/gist_id}",
                "gravatar_id": "",
                "html_url": "https://github.com/vanaigr",
                "id": 65824523,
                "login": "vanaigr",
                "node_id": "MDQ6VXNlcjY1ODI0NTIz",
                "organizations_url": "https://api.github.com/users/vanaigr/orgs",
                "received_events_url": "https://api.github.com/users/vanaigr/received_events",
                "repos_url": "https://api.github.com/users/vanaigr/repos",
                "site_admin": false,
                "starred_url": "https://api.github.com/users/vanaigr/starred{/owner}{/repo}",
                "subscriptions_url": "https://api.github.com/users/vanaigr/subscriptions",
                "type": "User",
                "url": "https://api.github.com/users/vanaigr",
                "user_view_type": "public"
            }
        },
        {
            "author_association": "MEMBER",
            "body": "\"asynchronous\" implies that the work _can_ execute after the current code finishes running, but nothing requires it can't finish immediately.",
            "created_at": "2024-12-23T19:59:34Z",
            "html_url": "https://github.com/neovim/neovim/pull/31631#issuecomment-2560232245",
            "id": 2560232245,
            "issue_url": "https://api.github.com/repos/neovim/neovim/issues/31631",
            "node_id": "IC_kwDOAPphoM6Ymgs1",
            "performed_via_github_app": null,
            "reactions": {
                "+1": 1,
                "-1": 0,
                "confused": 0,
                "eyes": 0,
                "heart": 0,
                "hooray": 0,
                "laugh": 0,
                "rocket": 0,
                "total_count": 1,
                "url": "https://api.github.com/repos/neovim/neovim/issues/comments/2560232245/reactions"
            },
            "updated_at": "2024-12-23T19:59:34Z",
            "url": "https://api.github.com/repos/neovim/neovim/issues/comments/2560232245",
            "user": {
                "avatar_url": "https://avatars.githubusercontent.com/u/7904185?v=4",
                "events_url": "https://api.github.com/users/lewis6991/events{/privacy}",
                "followers_url": "https://api.github.com/users/lewis6991/followers",
                "following_url": "https://api.github.com/users/lewis6991/following{/other_user}",
                "gists_url": "https://api.github.com/users/lewis6991/gists{/gist_id}",
                "gravatar_id": "",
                "html_url": "https://github.com/lewis6991",
                "id": 7904185,
                "login": "lewis6991",
                "node_id": "MDQ6VXNlcjc5MDQxODU=",
                "organizations_url": "https://api.github.com/users/lewis6991/orgs",
                "received_events_url": "https://api.github.com/users/lewis6991/received_events",
                "repos_url": "https://api.github.com/users/lewis6991/repos",
                "site_admin": false,
                "starred_url": "https://api.github.com/users/lewis6991/starred{/owner}{/repo}",
                "subscriptions_url": "https://api.github.com/users/lewis6991/subscriptions",
                "type": "User",
                "url": "https://api.github.com/users/lewis6991",
                "user_view_type": "public"
            }
        },
        {
            "author_association": "MEMBER",
            "body": "This PR is good to go from my end. If there is anything I missed that would get the above changes to work let me know, maybe I could just make a follow up PR for them if they aren't too critical",
            "created_at": "2024-12-23T20:21:52Z",
            "html_url": "https://github.com/neovim/neovim/pull/31631#issuecomment-2560255057",
            "id": 2560255057,
            "issue_url": "https://api.github.com/repos/neovim/neovim/issues/31631",
            "node_id": "IC_kwDOAPphoM6YmmRR",
            "performed_via_github_app": null,
            "reactions": {
                "+1": 0,
                "-1": 0,
                "confused": 0,
                "eyes": 0,
                "heart": 0,
                "hooray": 0,
                "laugh": 0,
                "rocket": 0,
                "total_count": 0,
                "url": "https://api.github.com/repos/neovim/neovim/issues/comments/2560255057/reactions"
            },
            "updated_at": "2024-12-23T20:21:52Z",
            "url": "https://api.github.com/repos/neovim/neovim/issues/comments/2560255057",
            "user": {
                "avatar_url": "https://avatars.githubusercontent.com/u/55766287?v=4",
                "events_url": "https://api.github.com/users/ribru17/events{/privacy}",
                "followers_url": "https://api.github.com/users/ribru17/followers",
                "following_url": "https://api.github.com/users/ribru17/following{/other_user}",
                "gists_url": "https://api.github.com/users/ribru17/gists{/gist_id}",
                "gravatar_id": "",
                "html_url": "https://github.com/ribru17",
                "id": 55766287,
                "login": "ribru17",
                "node_id": "MDQ6VXNlcjU1NzY2Mjg3",
                "organizations_url": "https://api.github.com/users/ribru17/orgs",
                "received_events_url": "https://api.github.com/users/ribru17/received_events",
                "repos_url": "https://api.github.com/users/ribru17/repos",
                "site_admin": false,
                "starred_url": "https://api.github.com/users/ribru17/starred{/owner}{/repo}",
                "subscriptions_url": "https://api.github.com/users/ribru17/subscriptions",
                "type": "User",
                "url": "https://api.github.com/users/ribru17",
                "user_view_type": "public"
            }
        },
        {
            "author_association": "MEMBER",
            "body": "I'll push a fixup when I get a chance. We need to do what @luukvbaal mentioned as the current code is really working against the decoration provider and I don't think strictly speaking it should work since you are adding ephemeral marks and then triggering a redraw, which then calls `on_win` again, and somehow still has the information for those ephemeral marks, which I'm pretty sure the API doesn't guarantee. The implementation may allow that now, but could change in the future.\n\nTo be strict about this, I think ephemeral marks should only be added during the provider callbacks and never via a scheduled event.",
            "created_at": "2024-12-23T20:32:54Z",
            "html_url": "https://github.com/neovim/neovim/pull/31631#issuecomment-2560265265",
            "id": 2560265265,
            "issue_url": "https://api.github.com/repos/neovim/neovim/issues/31631",
            "node_id": "IC_kwDOAPphoM6Ymowx",
            "performed_via_github_app": null,
            "reactions": {
                "+1": 1,
                "-1": 0,
                "confused": 0,
                "eyes": 0,
                "heart": 0,
                "hooray": 0,
                "laugh": 0,
                "rocket": 0,
                "total_count": 1,
                "url": "https://api.github.com/repos/neovim/neovim/issues/comments/2560265265/reactions"
            },
            "updated_at": "2024-12-23T20:33:57Z",
            "url": "https://api.github.com/repos/neovim/neovim/issues/comments/2560265265",
            "user": {
                "avatar_url": "https://avatars.githubusercontent.com/u/7904185?v=4",
                "events_url": "https://api.github.com/users/lewis6991/events{/privacy}",
                "followers_url": "https://api.github.com/users/lewis6991/followers",
                "following_url": "https://api.github.com/users/lewis6991/following{/other_user}",
                "gists_url": "https://api.github.com/users/lewis6991/gists{/gist_id}",
                "gravatar_id": "",
                "html_url": "https://github.com/lewis6991",
                "id": 7904185,
                "login": "lewis6991",
                "node_id": "MDQ6VXNlcjc5MDQxODU=",
                "organizations_url": "https://api.github.com/users/lewis6991/orgs",
                "received_events_url": "https://api.github.com/users/lewis6991/received_events",
                "repos_url": "https://api.github.com/users/lewis6991/repos",
                "site_admin": false,
                "starred_url": "https://api.github.com/users/lewis6991/starred{/owner}{/repo}",
                "subscriptions_url": "https://api.github.com/users/lewis6991/subscriptions",
                "type": "User",
                "url": "https://api.github.com/users/lewis6991",
                "user_view_type": "public"
            }
        },
        {
            "author_association": "NONE",
            "body": "I was excited about this so I applied the patch on my MacBook Pro M1 Max. On a ~1000 LOC rust file, while scrolling (C-e/y) I see noticeably more stutter at 120hz than before. Sorry for the lack of metrics, I'm not sure how or what to measure.",
            "created_at": "2024-12-23T21:25:37Z",
            "html_url": "https://github.com/neovim/neovim/pull/31631#issuecomment-2560313783",
            "id": 2560313783,
            "issue_url": "https://api.github.com/repos/neovim/neovim/issues/31631",
            "node_id": "IC_kwDOAPphoM6Ym0m3",
            "performed_via_github_app": null,
            "reactions": {
                "+1": 0,
                "-1": 0,
                "confused": 0,
                "eyes": 0,
                "heart": 0,
                "hooray": 0,
                "laugh": 0,
                "rocket": 0,
                "total_count": 0,
                "url": "https://api.github.com/repos/neovim/neovim/issues/comments/2560313783/reactions"
            },
            "updated_at": "2024-12-23T21:25:37Z",
            "url": "https://api.github.com/repos/neovim/neovim/issues/comments/2560313783",
            "user": {
                "avatar_url": "https://avatars.githubusercontent.com/u/14058796?v=4",
                "events_url": "https://api.github.com/users/diocletiann/events{/privacy}",
                "followers_url": "https://api.github.com/users/diocletiann/followers",
                "following_url": "https://api.github.com/users/diocletiann/following{/other_user}",
                "gists_url": "https://api.github.com/users/diocletiann/gists{/gist_id}",
                "gravatar_id": "",
                "html_url": "https://github.com/diocletiann",
                "id": 14058796,
                "login": "diocletiann",
                "node_id": "MDQ6VXNlcjE0MDU4Nzk2",
                "organizations_url": "https://api.github.com/users/diocletiann/orgs",
                "received_events_url": "https://api.github.com/users/diocletiann/received_events",
                "repos_url": "https://api.github.com/users/diocletiann/repos",
                "site_admin": false,
                "starred_url": "https://api.github.com/users/diocletiann/starred{/owner}{/repo}",
                "subscriptions_url": "https://api.github.com/users/diocletiann/subscriptions",
                "type": "User",
                "url": "https://api.github.com/users/diocletiann",
                "user_view_type": "public"
            }
        },
        {
            "author_association": "MEMBER",
            "body": "Weird, I don't see any stutter at all (1800 lines rust), I am on 60hz though. Maybe lewis' patch will improve things. Have you pulled from the latest changes in this PR?\r\n\r\nAlso stutters as in lag when scrolling, or lag when highlights show up on lines?\r\n\r\nNote: I ran without applying highlights with `nvim-treesitter`, only used `nvim-treesitter` for queries and parser shared object. Then ran `vim.treesitter.start()` with `--clean`",
            "created_at": "2024-12-23T21:35:02Z",
            "html_url": "https://github.com/neovim/neovim/pull/31631#issuecomment-2560322469",
            "id": 2560322469,
            "issue_url": "https://api.github.com/repos/neovim/neovim/issues/31631",
            "node_id": "IC_kwDOAPphoM6Ym2ul",
            "performed_via_github_app": null,
            "reactions": {
                "+1": 0,
                "-1": 0,
                "confused": 0,
                "eyes": 0,
                "heart": 0,
                "hooray": 0,
                "laugh": 0,
                "rocket": 0,
                "total_count": 0,
                "url": "https://api.github.com/repos/neovim/neovim/issues/comments/2560322469/reactions"
            },
            "updated_at": "2024-12-23T21:37:46Z",
            "url": "https://api.github.com/repos/neovim/neovim/issues/comments/2560322469",
            "user": {
                "avatar_url": "https://avatars.githubusercontent.com/u/55766287?v=4",
                "events_url": "https://api.github.com/users/ribru17/events{/privacy}",
                "followers_url": "https://api.github.com/users/ribru17/followers",
                "following_url": "https://api.github.com/users/ribru17/following{/other_user}",
                "gists_url": "https://api.github.com/users/ribru17/gists{/gist_id}",
                "gravatar_id": "",
                "html_url": "https://github.com/ribru17",
                "id": 55766287,
                "login": "ribru17",
                "node_id": "MDQ6VXNlcjU1NzY2Mjg3",
                "organizations_url": "https://api.github.com/users/ribru17/orgs",
                "received_events_url": "https://api.github.com/users/ribru17/received_events",
                "repos_url": "https://api.github.com/users/ribru17/repos",
                "site_admin": false,
                "starred_url": "https://api.github.com/users/ribru17/starred{/owner}{/repo}",
                "subscriptions_url": "https://api.github.com/users/ribru17/subscriptions",
                "type": "User",
                "url": "https://api.github.com/users/ribru17",
                "user_view_type": "public"
            }
        },
        {
            "author_association": "MEMBER",
            "body": "> Note: I ran without applying highlights with nvim-treesitter, only used nvim-treesitter for queries and parser shared object. Then ran vim.treesitter.start() \r\n\r\n... which is all nvim-treesitter does (regarding highlighting; anything else -- such as indents -- are not touched by this PR so irrelevant).",
            "created_at": "2024-12-23T21:41:53Z",
            "html_url": "https://github.com/neovim/neovim/pull/31631#issuecomment-2560328136",
            "id": 2560328136,
            "issue_url": "https://api.github.com/repos/neovim/neovim/issues/31631",
            "node_id": "IC_kwDOAPphoM6Ym4HI",
            "performed_via_github_app": null,
            "reactions": {
                "+1": 0,
                "-1": 0,
                "confused": 0,
                "eyes": 0,
                "heart": 0,
                "hooray": 0,
                "laugh": 0,
                "rocket": 0,
                "total_count": 0,
                "url": "https://api.github.com/repos/neovim/neovim/issues/comments/2560328136/reactions"
            },
            "updated_at": "2024-12-23T21:42:37Z",
            "url": "https://api.github.com/repos/neovim/neovim/issues/comments/2560328136",
            "user": {
                "avatar_url": "https://avatars.githubusercontent.com/u/2361214?v=4",
                "events_url": "https://api.github.com/users/clason/events{/privacy}",
                "followers_url": "https://api.github.com/users/clason/followers",
                "following_url": "https://api.github.com/users/clason/following{/other_user}",
                "gists_url": "https://api.github.com/users/clason/gists{/gist_id}",
                "gravatar_id": "",
                "html_url": "https://github.com/clason",
                "id": 2361214,
                "login": "clason",
                "node_id": "MDQ6VXNlcjIzNjEyMTQ=",
                "organizations_url": "https://api.github.com/users/clason/orgs",
                "received_events_url": "https://api.github.com/users/clason/received_events",
                "repos_url": "https://api.github.com/users/clason/repos",
                "site_admin": false,
                "starred_url": "https://api.github.com/users/clason/starred{/owner}{/repo}",
                "subscriptions_url": "https://api.github.com/users/clason/subscriptions",
                "type": "User",
                "url": "https://api.github.com/users/clason",
                "user_view_type": "public"
            }
        },
        {
            "author_association": "NONE",
            "body": "> Weird, I don't see any stutter at all (1800 lines rust), I am on 60hz though. Maybe lewis' patch will improve things. Have you pulled from the latest changes in this PR?\r\n> \r\n> Also stutters as in lag when scrolling, or lag when highlights show up on lines?\r\n> \r\n> Note: I ran without applying highlights with `nvim-treesitter`, only used `nvim-treesitter` for queries and parser shared object. Then ran `vim.treesitter.start()` with `--clean`\r\n\r\nYes I merged this PR. The stutter while scrolling (with maxed out macOS repeat rate) is subtle, but more frequent. I can see it in Ghostty, Kitty, and Neovide (`termsync` is disabled). Wanted to let you know just in case something regressed between 60 and 120hz.",
            "created_at": "2024-12-23T21:44:53Z",
            "html_url": "https://github.com/neovim/neovim/pull/31631#issuecomment-2560331392",
            "id": 2560331392,
            "issue_url": "https://api.github.com/repos/neovim/neovim/issues/31631",
            "node_id": "IC_kwDOAPphoM6Ym46A",
            "performed_via_github_app": null,
            "reactions": {
                "+1": 1,
                "-1": 0,
                "confused": 0,
                "eyes": 0,
                "heart": 0,
                "hooray": 0,
                "laugh": 0,
                "rocket": 0,
                "total_count": 1,
                "url": "https://api.github.com/repos/neovim/neovim/issues/comments/2560331392/reactions"
            },
            "updated_at": "2024-12-23T21:44:53Z",
            "url": "https://api.github.com/repos/neovim/neovim/issues/comments/2560331392",
            "user": {
                "avatar_url": "https://avatars.githubusercontent.com/u/14058796?v=4",
                "events_url": "https://api.github.com/users/diocletiann/events{/privacy}",
                "followers_url": "https://api.github.com/users/diocletiann/followers",
                "following_url": "https://api.github.com/users/diocletiann/following{/other_user}",
                "gists_url": "https://api.github.com/users/diocletiann/gists{/gist_id}",
                "gravatar_id": "",
                "html_url": "https://github.com/diocletiann",
                "id": 14058796,
                "login": "diocletiann",
                "node_id": "MDQ6VXNlcjE0MDU4Nzk2",
                "organizations_url": "https://api.github.com/users/diocletiann/orgs",
                "received_events_url": "https://api.github.com/users/diocletiann/received_events",
                "repos_url": "https://api.github.com/users/diocletiann/repos",
                "site_admin": false,
                "starred_url": "https://api.github.com/users/diocletiann/starred{/owner}{/repo}",
                "subscriptions_url": "https://api.github.com/users/diocletiann/subscriptions",
                "type": "User",
                "url": "https://api.github.com/users/diocletiann",
                "user_view_type": "public"
            }
        },
        {
            "author_association": "MEMBER",
            "body": "Does it not also use its own implementation of certain predicates, like a slower `has-ancestor?`, as well as some functions from `nvim-treesitter.utils` rather than newer core functions?\r\n\r\nJust checked and I guess a lot of that stuff is gone, including the old `has-ancestor?`",
            "created_at": "2024-12-23T21:45:42Z",
            "html_url": "https://github.com/neovim/neovim/pull/31631#issuecomment-2560332162",
            "id": 2560332162,
            "issue_url": "https://api.github.com/repos/neovim/neovim/issues/31631",
            "node_id": "IC_kwDOAPphoM6Ym5GC",
            "performed_via_github_app": null,
            "reactions": {
                "+1": 0,
                "-1": 0,
                "confused": 0,
                "eyes": 0,
                "heart": 0,
                "hooray": 0,
                "laugh": 0,
                "rocket": 0,
                "total_count": 0,
                "url": "https://api.github.com/repos/neovim/neovim/issues/comments/2560332162/reactions"
            },
            "updated_at": "2024-12-23T21:45:42Z",
            "url": "https://api.github.com/repos/neovim/neovim/issues/comments/2560332162",
            "user": {
                "avatar_url": "https://avatars.githubusercontent.com/u/55766287?v=4",
                "events_url": "https://api.github.com/users/ribru17/events{/privacy}",
                "followers_url": "https://api.github.com/users/ribru17/followers",
                "following_url": "https://api.github.com/users/ribru17/following{/other_user}",
                "gists_url": "https://api.github.com/users/ribru17/gists{/gist_id}",
                "gravatar_id": "",
                "html_url": "https://github.com/ribru17",
                "id": 55766287,
                "login": "ribru17",
                "node_id": "MDQ6VXNlcjU1NzY2Mjg3",
                "organizations_url": "https://api.github.com/users/ribru17/orgs",
                "received_events_url": "https://api.github.com/users/ribru17/received_events",
                "repos_url": "https://api.github.com/users/ribru17/repos",
                "site_admin": false,
                "starred_url": "https://api.github.com/users/ribru17/starred{/owner}{/repo}",
                "subscriptions_url": "https://api.github.com/users/ribru17/subscriptions",
                "type": "User",
                "url": "https://api.github.com/users/ribru17",
                "user_view_type": "public"
            }
        },
        {
            "author_association": "MEMBER",
            "body": "Not anymore.\r\n\r\nPlease, provide reproducible examples; simply commenting \"I noticed _bad_!\" without details is chaff and  not helpful.",
            "created_at": "2024-12-23T21:47:09Z",
            "html_url": "https://github.com/neovim/neovim/pull/31631#issuecomment-2560333375",
            "id": 2560333375,
            "issue_url": "https://api.github.com/repos/neovim/neovim/issues/31631",
            "node_id": "IC_kwDOAPphoM6Ym5Y_",
            "performed_via_github_app": null,
            "reactions": {
                "+1": 2,
                "-1": 0,
                "confused": 0,
                "eyes": 0,
                "heart": 0,
                "hooray": 0,
                "laugh": 0,
                "rocket": 0,
                "total_count": 2,
                "url": "https://api.github.com/repos/neovim/neovim/issues/comments/2560333375/reactions"
            },
            "updated_at": "2024-12-23T21:48:20Z",
            "url": "https://api.github.com/repos/neovim/neovim/issues/comments/2560333375",
            "user": {
                "avatar_url": "https://avatars.githubusercontent.com/u/2361214?v=4",
                "events_url": "https://api.github.com/users/clason/events{/privacy}",
                "followers_url": "https://api.github.com/users/clason/followers",
                "following_url": "https://api.github.com/users/clason/following{/other_user}",
                "gists_url": "https://api.github.com/users/clason/gists{/gist_id}",
                "gravatar_id": "",
                "html_url": "https://github.com/clason",
                "id": 2361214,
                "login": "clason",
                "node_id": "MDQ6VXNlcjIzNjEyMTQ=",
                "organizations_url": "https://api.github.com/users/clason/orgs",
                "received_events_url": "https://api.github.com/users/clason/received_events",
                "repos_url": "https://api.github.com/users/clason/repos",
                "site_admin": false,
                "starred_url": "https://api.github.com/users/clason/starred{/owner}{/repo}",
                "subscriptions_url": "https://api.github.com/users/clason/subscriptions",
                "type": "User",
                "url": "https://api.github.com/users/clason",
                "user_view_type": "public"
            }
        },
        {
            "author_association": "MEMBER",
            "body": "Gotcha. Also while investigating this I noticed `:h treesitter.txt` gives\r\n```\r\nError executing vim.schedule lua callback: ...jects/neovim/runtime//lua/vim/treesitter/highlighter.lua:327: not yet implemented\r\n```\r\n\r\nlooks like this needs more time in the oven ",
            "created_at": "2024-12-23T21:49:20Z",
            "html_url": "https://github.com/neovim/neovim/pull/31631#issuecomment-2560335209",
            "id": 2560335209,
            "issue_url": "https://api.github.com/repos/neovim/neovim/issues/31631",
            "node_id": "IC_kwDOAPphoM6Ym51p",
            "performed_via_github_app": null,
            "reactions": {
                "+1": 0,
                "-1": 0,
                "confused": 0,
                "eyes": 0,
                "heart": 0,
                "hooray": 0,
                "laugh": 0,
                "rocket": 0,
                "total_count": 0,
                "url": "https://api.github.com/repos/neovim/neovim/issues/comments/2560335209/reactions"
            },
            "updated_at": "2024-12-23T21:49:20Z",
            "url": "https://api.github.com/repos/neovim/neovim/issues/comments/2560335209",
            "user": {
                "avatar_url": "https://avatars.githubusercontent.com/u/55766287?v=4",
                "events_url": "https://api.github.com/users/ribru17/events{/privacy}",
                "followers_url": "https://api.github.com/users/ribru17/followers",
                "following_url": "https://api.github.com/users/ribru17/following{/other_user}",
                "gists_url": "https://api.github.com/users/ribru17/gists{/gist_id}",
                "gravatar_id": "",
                "html_url": "https://github.com/ribru17",
                "id": 55766287,
                "login": "ribru17",
                "node_id": "MDQ6VXNlcjU1NzY2Mjg3",
                "organizations_url": "https://api.github.com/users/ribru17/orgs",
                "received_events_url": "https://api.github.com/users/ribru17/received_events",
                "repos_url": "https://api.github.com/users/ribru17/repos",
                "site_admin": false,
                "starred_url": "https://api.github.com/users/ribru17/starred{/owner}{/repo}",
                "subscriptions_url": "https://api.github.com/users/ribru17/subscriptions",
                "type": "User",
                "url": "https://api.github.com/users/ribru17",
                "user_view_type": "public"
            }
        },
        {
            "author_association": "MEMBER",
            "body": "I took a stab at it; I think something like this is closer to what we need:\r\nhttps://github.com/luukvbaal/neovim/commit/35663ac09a2fb47f16d4c70aaa6ac2c03e91b38f.",
            "created_at": "2024-12-23T22:43:38Z",
            "html_url": "https://github.com/neovim/neovim/pull/31631#issuecomment-2560395054",
            "id": 2560395054,
            "issue_url": "https://api.github.com/repos/neovim/neovim/issues/31631",
            "node_id": "IC_kwDOAPphoM6YnIcu",
            "performed_via_github_app": null,
            "reactions": {
                "+1": 0,
                "-1": 0,
                "confused": 0,
                "eyes": 0,
                "heart": 0,
                "hooray": 1,
                "laugh": 0,
                "rocket": 0,
                "total_count": 1,
                "url": "https://api.github.com/repos/neovim/neovim/issues/comments/2560395054/reactions"
            },
            "updated_at": "2024-12-23T22:43:38Z",
            "url": "https://api.github.com/repos/neovim/neovim/issues/comments/2560395054",
            "user": {
                "avatar_url": "https://avatars.githubusercontent.com/u/31730729?v=4",
                "events_url": "https://api.github.com/users/luukvbaal/events{/privacy}",
                "followers_url": "https://api.github.com/users/luukvbaal/followers",
                "following_url": "https://api.github.com/users/luukvbaal/following{/other_user}",
                "gists_url": "https://api.github.com/users/luukvbaal/gists{/gist_id}",
                "gravatar_id": "",
                "html_url": "https://github.com/luukvbaal",
                "id": 31730729,
                "login": "luukvbaal",
                "node_id": "MDQ6VXNlcjMxNzMwNzI5",
                "organizations_url": "https://api.github.com/users/luukvbaal/orgs",
                "received_events_url": "https://api.github.com/users/luukvbaal/received_events",
                "repos_url": "https://api.github.com/users/luukvbaal/repos",
                "site_admin": false,
                "starred_url": "https://api.github.com/users/luukvbaal/starred{/owner}{/repo}",
                "subscriptions_url": "https://api.github.com/users/luukvbaal/subscriptions",
                "type": "User",
                "url": "https://api.github.com/users/luukvbaal",
                "user_view_type": "public"
            }
        },
        {
            "author_association": "MEMBER",
            "body": "Beautiful, this works wonderfully (and solves the `not yet implemented` bug from above), thank you @luukvbaal !! Pulling these changes in now",
            "created_at": "2024-12-23T22:59:37Z",
            "html_url": "https://github.com/neovim/neovim/pull/31631#issuecomment-2560407570",
            "id": 2560407570,
            "issue_url": "https://api.github.com/repos/neovim/neovim/issues/31631",
            "node_id": "IC_kwDOAPphoM6YnLgS",
            "performed_via_github_app": null,
            "reactions": {
                "+1": 0,
                "-1": 0,
                "confused": 0,
                "eyes": 0,
                "heart": 0,
                "hooray": 0,
                "laugh": 1,
                "rocket": 0,
                "total_count": 1,
                "url": "https://api.github.com/repos/neovim/neovim/issues/comments/2560407570/reactions"
            },
            "updated_at": "2024-12-23T22:59:37Z",
            "url": "https://api.github.com/repos/neovim/neovim/issues/comments/2560407570",
            "user": {
                "avatar_url": "https://avatars.githubusercontent.com/u/55766287?v=4",
                "events_url": "https://api.github.com/users/ribru17/events{/privacy}",
                "followers_url": "https://api.github.com/users/ribru17/followers",
                "following_url": "https://api.github.com/users/ribru17/following{/other_user}",
                "gists_url": "https://api.github.com/users/ribru17/gists{/gist_id}",
                "gravatar_id": "",
                "html_url": "https://github.com/ribru17",
                "id": 55766287,
                "login": "ribru17",
                "node_id": "MDQ6VXNlcjU1NzY2Mjg3",
                "organizations_url": "https://api.github.com/users/ribru17/orgs",
                "received_events_url": "https://api.github.com/users/ribru17/received_events",
                "repos_url": "https://api.github.com/users/ribru17/repos",
                "site_admin": false,
                "starred_url": "https://api.github.com/users/ribru17/starred{/owner}{/repo}",
                "subscriptions_url": "https://api.github.com/users/ribru17/subscriptions",
                "type": "User",
                "url": "https://api.github.com/users/ribru17",
                "user_view_type": "public"
            }
        }
    ],
    "comments_url": "https://api.github.com/repos/neovim/neovim/issues/31631/comments",
    "commits_url": "https://api.github.com/repos/neovim/neovim/pulls/31631/commits",
    "created_at": "2024-12-19T03:16:09Z",
    "diff_url": "https://github.com/neovim/neovim/pull/31631.diff",
    "draft": false,
    "head": {
        "label": "ribru17:async_parse_attempt_2",
        "ref": "async_parse_attempt_2",
        "repo": {
            "allow_forking": true,
            "archive_url": "https://api.github.com/repos/ribru17/neovim/{archive_format}{/ref}",
            "archived": false,
            "assignees_url": "https://api.github.com/repos/ribru17/neovim/assignees{/user}",
            "blobs_url": "https://api.github.com/repos/ribru17/neovim/git/blobs{/sha}",
            "branches_url": "https://api.github.com/repos/ribru17/neovim/branches{/branch}",
            "clone_url": "https://github.com/ribru17/neovim.git",
            "collaborators_url": "https://api.github.com/repos/ribru17/neovim/collaborators{/collaborator}",
            "comments_url": "https://api.github.com/repos/ribru17/neovim/comments{/number}",
            "commits_url": "https://api.github.com/repos/ribru17/neovim/commits{/sha}",
            "compare_url": "https://api.github.com/repos/ribru17/neovim/compare/{base}...{head}",
            "contents_url": "https://api.github.com/repos/ribru17/neovim/contents/{+path}",
            "contributors_url": "https://api.github.com/repos/ribru17/neovim/contributors",
            "created_at": "2023-12-31T05:02:30Z",
            "default_branch": "master",
            "deployments_url": "https://api.github.com/repos/ribru17/neovim/deployments",
            "description": "Vim-fork focused on extensibility and usability",
            "disabled": false,
            "downloads_url": "https://api.github.com/repos/ribru17/neovim/downloads",
            "events_url": "https://api.github.com/repos/ribru17/neovim/events",
            "fork": true,
            "forks": 0,
            "forks_count": 0,
            "forks_url": "https://api.github.com/repos/ribru17/neovim/forks",
            "full_name": "ribru17/neovim",
            "git_commits_url": "https://api.github.com/repos/ribru17/neovim/git/commits{/sha}",
            "git_refs_url": "https://api.github.com/repos/ribru17/neovim/git/refs{/sha}",
            "git_tags_url": "https://api.github.com/repos/ribru17/neovim/git/tags{/sha}",
            "git_url": "git://github.com/ribru17/neovim.git",
            "has_discussions": false,
            "has_downloads": true,
            "has_issues": false,
            "has_pages": false,
            "has_projects": true,
            "has_wiki": true,
            "homepage": "https://neovim.io",
            "hooks_url": "https://api.github.com/repos/ribru17/neovim/hooks",
            "html_url": "https://github.com/ribru17/neovim",
            "id": 737455179,
            "is_template": false,
            "issue_comment_url": "https://api.github.com/repos/ribru17/neovim/issues/comments{/number}",
            "issue_events_url": "https://api.github.com/repos/ribru17/neovim/issues/events{/number}",
            "issues_url": "https://api.github.com/repos/ribru17/neovim/issues{/number}",
            "keys_url": "https://api.github.com/repos/ribru17/neovim/keys{/key_id}",
            "labels_url": "https://api.github.com/repos/ribru17/neovim/labels{/name}",
            "language": "Vim Script",
            "languages_url": "https://api.github.com/repos/ribru17/neovim/languages",
            "license": {
                "key": "other",
                "name": "Other",
                "node_id": "MDc6TGljZW5zZTA=",
                "spdx_id": "NOASSERTION",
                "url": null
            },
            "merges_url": "https://api.github.com/repos/ribru17/neovim/merges",
            "milestones_url": "https://api.github.com/repos/ribru17/neovim/milestones{/number}",
            "mirror_url": null,
            "name": "neovim",
            "node_id": "R_kgDOK_SsSw",
            "notifications_url": "https://api.github.com/repos/ribru17/neovim/notifications{?since,all,participating}",
            "open_issues": 0,
            "open_issues_count": 0,
            "owner": {
                "avatar_url": "https://avatars.githubusercontent.com/u/55766287?v=4",
                "events_url": "https://api.github.com/users/ribru17/events{/privacy}",
                "followers_url": "https://api.github.com/users/ribru17/followers",
                "following_url": "https://api.github.com/users/ribru17/following{/other_user}",
                "gists_url": "https://api.github.com/users/ribru17/gists{/gist_id}",
                "gravatar_id": "",
                "html_url": "https://github.com/ribru17",
                "id": 55766287,
                "login": "ribru17",
                "node_id": "MDQ6VXNlcjU1NzY2Mjg3",
                "organizations_url": "https://api.github.com/users/ribru17/orgs",
                "received_events_url": "https://api.github.com/users/ribru17/received_events",
                "repos_url": "https://api.github.com/users/ribru17/repos",
                "site_admin": false,
                "starred_url": "https://api.github.com/users/ribru17/starred{/owner}{/repo}",
                "subscriptions_url": "https://api.github.com/users/ribru17/subscriptions",
                "type": "User",
                "url": "https://api.github.com/users/ribru17",
                "user_view_type": "public"
            },
            "private": false,
            "pulls_url": "https://api.github.com/repos/ribru17/neovim/pulls{/number}",
            "pushed_at": "2024-12-24T01:55:48Z",
            "releases_url": "https://api.github.com/repos/ribru17/neovim/releases{/id}",
            "size": 292082,
            "ssh_url": "git@github.com:ribru17/neovim.git",
            "stargazers_count": 0,
            "stargazers_url": "https://api.github.com/repos/ribru17/neovim/stargazers",
            "statuses_url": "https://api.github.com/repos/ribru17/neovim/statuses/{sha}",
            "subscribers_url": "https://api.github.com/repos/ribru17/neovim/subscribers",
            "subscription_url": "https://api.github.com/repos/ribru17/neovim/subscription",
            "svn_url": "https://github.com/ribru17/neovim",
            "tags_url": "https://api.github.com/repos/ribru17/neovim/tags",
            "teams_url": "https://api.github.com/repos/ribru17/neovim/teams",
            "topics": [],
            "trees_url": "https://api.github.com/repos/ribru17/neovim/git/trees{/sha}",
            "updated_at": "2024-12-19T03:08:30Z",
            "url": "https://api.github.com/repos/ribru17/neovim",
            "visibility": "public",
            "watchers": 0,
            "watchers_count": 0,
            "web_commit_signoff_required": false
        },
        "sha": "c885db4421200a476440ec14ce231bcf922f7248",
        "user": {
            "avatar_url": "https://avatars.githubusercontent.com/u/55766287?v=4",
            "events_url": "https://api.github.com/users/ribru17/events{/privacy}",
            "followers_url": "https://api.github.com/users/ribru17/followers",
            "following_url": "https://api.github.com/users/ribru17/following{/other_user}",
            "gists_url": "https://api.github.com/users/ribru17/gists{/gist_id}",
            "gravatar_id": "",
            "html_url": "https://github.com/ribru17",
            "id": 55766287,
            "login": "ribru17",
            "node_id": "MDQ6VXNlcjU1NzY2Mjg3",
            "organizations_url": "https://api.github.com/users/ribru17/orgs",
            "received_events_url": "https://api.github.com/users/ribru17/received_events",
            "repos_url": "https://api.github.com/users/ribru17/repos",
            "site_admin": false,
            "starred_url": "https://api.github.com/users/ribru17/starred{/owner}{/repo}",
            "subscriptions_url": "https://api.github.com/users/ribru17/subscriptions",
            "type": "User",
            "url": "https://api.github.com/users/ribru17",
            "user_view_type": "public"
        }
    },
    "html_url": "https://github.com/neovim/neovim/pull/31631",
    "id": 2243447503,
    "issue_url": "https://api.github.com/repos/neovim/neovim/issues/31631",
    "labels": [
        {
            "color": "c5def5",
            "default": false,
            "description": "",
            "id": 1799626557,
            "name": "treesitter",
            "node_id": "MDU6TGFiZWwxNzk5NjI2NTU3",
            "url": "https://api.github.com/repos/neovim/neovim/labels/treesitter"
        }
    ],
    "locked": false,
    "merge_commit_sha": "0b0645aceead4264b761891b2d9d36f6a81a4b64",
    "merged_at": null,
    "milestone": null,
    "node_id": "PR_kwDOAPphoM6FuErP",
    "number": 31631,
    "patch_url": "https://github.com/neovim/neovim/pull/31631.patch",
    "requested_reviewers": [
        {
            "avatar_url": "https://avatars.githubusercontent.com/u/1363104?v=4",
            "events_url": "https://api.github.com/users/bfredl/events{/privacy}",
            "followers_url": "https://api.github.com/users/bfredl/followers",
            "following_url": "https://api.github.com/users/bfredl/following{/other_user}",
            "gists_url": "https://api.github.com/users/bfredl/gists{/gist_id}",
            "gravatar_id": "",
            "html_url": "https://github.com/bfredl",
            "id": 1363104,
            "login": "bfredl",
            "node_id": "MDQ6VXNlcjEzNjMxMDQ=",
            "organizations_url": "https://api.github.com/users/bfredl/orgs",
            "received_events_url": "https://api.github.com/users/bfredl/received_events",
            "repos_url": "https://api.github.com/users/bfredl/repos",
            "site_admin": false,
            "starred_url": "https://api.github.com/users/bfredl/starred{/owner}{/repo}",
            "subscriptions_url": "https://api.github.com/users/bfredl/subscriptions",
            "type": "User",
            "url": "https://api.github.com/users/bfredl",
            "user_view_type": "public"
        },
        {
            "avatar_url": "https://avatars.githubusercontent.com/u/2361214?v=4",
            "events_url": "https://api.github.com/users/clason/events{/privacy}",
            "followers_url": "https://api.github.com/users/clason/followers",
            "following_url": "https://api.github.com/users/clason/following{/other_user}",
            "gists_url": "https://api.github.com/users/clason/gists{/gist_id}",
            "gravatar_id": "",
            "html_url": "https://github.com/clason",
            "id": 2361214,
            "login": "clason",
            "node_id": "MDQ6VXNlcjIzNjEyMTQ=",
            "organizations_url": "https://api.github.com/users/clason/orgs",
            "received_events_url": "https://api.github.com/users/clason/received_events",
            "repos_url": "https://api.github.com/users/clason/repos",
            "site_admin": false,
            "starred_url": "https://api.github.com/users/clason/starred{/owner}{/repo}",
            "subscriptions_url": "https://api.github.com/users/clason/subscriptions",
            "type": "User",
            "url": "https://api.github.com/users/clason",
            "user_view_type": "public"
        },
        {
            "avatar_url": "https://avatars.githubusercontent.com/u/1009873?v=4",
            "events_url": "https://api.github.com/users/wookayin/events{/privacy}",
            "followers_url": "https://api.github.com/users/wookayin/followers",
            "following_url": "https://api.github.com/users/wookayin/following{/other_user}",
            "gists_url": "https://api.github.com/users/wookayin/gists{/gist_id}",
            "gravatar_id": "",
            "html_url": "https://github.com/wookayin",
            "id": 1009873,
            "login": "wookayin",
            "node_id": "MDQ6VXNlcjEwMDk4NzM=",
            "organizations_url": "https://api.github.com/users/wookayin/orgs",
            "received_events_url": "https://api.github.com/users/wookayin/received_events",
            "repos_url": "https://api.github.com/users/wookayin/repos",
            "site_admin": false,
            "starred_url": "https://api.github.com/users/wookayin/starred{/owner}{/repo}",
            "subscriptions_url": "https://api.github.com/users/wookayin/subscriptions",
            "type": "User",
            "url": "https://api.github.com/users/wookayin",
            "user_view_type": "public"
        }
    ],
    "requested_teams": [],
    "review_comment_url": "https://api.github.com/repos/neovim/neovim/pulls/comments{/number}",
    "review_comments_url": "https://api.github.com/repos/neovim/neovim/pulls/31631/comments",
    "state": "open",
    "statuses_url": "https://api.github.com/repos/neovim/neovim/statuses/c885db4421200a476440ec14ce231bcf922f7248",
    "title": "feat(treesitter): async parsing",
    "updated_at": "2024-12-24T01:55:51Z",
    "url": "https://api.github.com/repos/neovim/neovim/pulls/31631",
    "user": {
        "avatar_url": "https://avatars.githubusercontent.com/u/55766287?v=4",
        "events_url": "https://api.github.com/users/ribru17/events{/privacy}",
        "followers_url": "https://api.github.com/users/ribru17/followers",
        "following_url": "https://api.github.com/users/ribru17/following{/other_user}",
        "gists_url": "https://api.github.com/users/ribru17/gists{/gist_id}",
        "gravatar_id": "",
        "html_url": "https://github.com/ribru17",
        "id": 55766287,
        "login": "ribru17",
        "node_id": "MDQ6VXNlcjU1NzY2Mjg3",
        "organizations_url": "https://api.github.com/users/ribru17/orgs",
        "received_events_url": "https://api.github.com/users/ribru17/received_events",
        "repos_url": "https://api.github.com/users/ribru17/repos",
        "site_admin": false,
        "starred_url": "https://api.github.com/users/ribru17/starred{/owner}{/repo}",
        "subscriptions_url": "https://api.github.com/users/ribru17/subscriptions",
        "type": "User",
        "url": "https://api.github.com/users/ribru17",
        "user_view_type": "public"
    }
}