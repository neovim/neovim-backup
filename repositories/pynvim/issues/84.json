{
    "active_lock_reason": null,
    "assignee": null,
    "assignees": [],
    "author_association": "NONE",
    "body": "Consider the following script:\n\n```\npython import sys; print sys.modules['__main__'].__dict__ is globals()\n```\n\n. In Vim this code prints `True`, in NeoVim it prints `False`. Using `import __main__` can be (and is actually used in powerline) to put some variable into global environment without requiring to specify `globals()` dictionary, so that code that user needs to run to use powerline is simply\n\n```\npython from powerline.vim import setup as powerline_setup\npython powerline_setup()\npython del powerline_setup\n```\n\nwhich is simple and easy.\n",
    "closed_at": null,
    "closed_by": null,
    "comment_data": [
        {
            "author_association": "MEMBER",
            "body": "I'm not sure what can be done, I've tried setting the **main** module in the compatibility module setup:\n\n``` diff\ndiff --git a/runtime/autoload/provider/script_host.py b/runtime/autoload/provider/script_host.py\nindex 1420831..dddded8 100644\n--- a/runtime/autoload/provider/script_host.py\n+++ b/runtime/autoload/provider/script_host.py\n@@ -37,6 +37,7 @@ class ScriptHost(object):\n                 neovim.DecodeHook(\n                     encoding=nvim.options['encoding'].decode('ascii')))\n         sys.modules['vim'] = self.legacy_vim\n+        sys.modules['__main__'] = self.legacy_vim\n\n     def setup(self, nvim):\n         \"\"\"Setup import hooks and global streams.\n```\n\nbut it doesn't work as expected. Do you have any ideas on how to fix this?\n",
            "created_at": "2015-02-09T13:58:46Z",
            "html_url": "https://github.com/neovim/pynvim/issues/84#issuecomment-73512099",
            "id": 73512099,
            "issue_url": "https://api.github.com/repos/neovim/pynvim/issues/84",
            "node_id": "MDEyOklzc3VlQ29tbWVudDczNTEyMDk5",
            "performed_via_github_app": null,
            "reactions": {
                "+1": 0,
                "-1": 0,
                "confused": 0,
                "eyes": 0,
                "heart": 0,
                "hooray": 0,
                "laugh": 0,
                "rocket": 0,
                "total_count": 0,
                "url": "https://api.github.com/repos/neovim/pynvim/issues/comments/73512099/reactions"
            },
            "updated_at": "2015-02-09T13:58:46Z",
            "url": "https://api.github.com/repos/neovim/pynvim/issues/comments/73512099",
            "user": {
                "avatar_url": "https://avatars.githubusercontent.com/u/842846?v=4",
                "events_url": "https://api.github.com/users/tarruda/events{/privacy}",
                "followers_url": "https://api.github.com/users/tarruda/followers",
                "following_url": "https://api.github.com/users/tarruda/following{/other_user}",
                "gists_url": "https://api.github.com/users/tarruda/gists{/gist_id}",
                "gravatar_id": "",
                "html_url": "https://github.com/tarruda",
                "id": 842846,
                "login": "tarruda",
                "node_id": "MDQ6VXNlcjg0Mjg0Ng==",
                "organizations_url": "https://api.github.com/users/tarruda/orgs",
                "received_events_url": "https://api.github.com/users/tarruda/received_events",
                "repos_url": "https://api.github.com/users/tarruda/repos",
                "site_admin": false,
                "starred_url": "https://api.github.com/users/tarruda/starred{/owner}{/repo}",
                "subscriptions_url": "https://api.github.com/users/tarruda/subscriptions",
                "type": "User",
                "url": "https://api.github.com/users/tarruda",
                "user_view_type": "public"
            }
        },
        {
            "author_association": "NONE",
            "body": "@tarruda ?! `vim` module and `__main__` are completely different things. To create needed module you may follow two paths:\n1. Create `*.py` file in `sys.path` and import it.\n2. Use `imp.new_module('__main__')` and assign it to `sys.modules` directly.\n\nI would highly suggest to use the second variant and do two things:\n1. Assign newly created module to `sys.modules`.\n2. Use `__main__.__dict__` as `globals` argument to `exec` and `eval`.\n\nYou already do the second thing. But you are not doing the first which is why my script fails:\n\n``` Diff\ndiff --git a/runtime/autoload/provider/script_host.py b/runtime/autoload/provider/script_host.py\nindex 1420831..0abb0ae 100644\n--- a/runtime/autoload/provider/script_host.py\n+++ b/runtime/autoload/provider/script_host.py\n@@ -28,6 +28,7 @@ class ScriptHost(object):\n         self.setup(nvim)\n         # context where all code will run\n         self.module = imp.new_module('__main__')\n+        sys.modules['__main__'] = self.module\n         nvim.script_context = self.module\n         # it seems some plugins assume 'sys' is already imported, so do it now\n         exec('import sys', self.module.__dict__)\n```\n",
            "created_at": "2015-02-09T17:00:58Z",
            "html_url": "https://github.com/neovim/pynvim/issues/84#issuecomment-73545802",
            "id": 73545802,
            "issue_url": "https://api.github.com/repos/neovim/pynvim/issues/84",
            "node_id": "MDEyOklzc3VlQ29tbWVudDczNTQ1ODAy",
            "performed_via_github_app": null,
            "reactions": {
                "+1": 0,
                "-1": 0,
                "confused": 0,
                "eyes": 0,
                "heart": 0,
                "hooray": 0,
                "laugh": 0,
                "rocket": 0,
                "total_count": 0,
                "url": "https://api.github.com/repos/neovim/pynvim/issues/comments/73545802/reactions"
            },
            "updated_at": "2015-02-09T17:01:15Z",
            "url": "https://api.github.com/repos/neovim/pynvim/issues/comments/73545802",
            "user": {
                "avatar_url": "https://avatars.githubusercontent.com/u/322097?v=4",
                "events_url": "https://api.github.com/users/ZyX-I/events{/privacy}",
                "followers_url": "https://api.github.com/users/ZyX-I/followers",
                "following_url": "https://api.github.com/users/ZyX-I/following{/other_user}",
                "gists_url": "https://api.github.com/users/ZyX-I/gists{/gist_id}",
                "gravatar_id": "",
                "html_url": "https://github.com/ZyX-I",
                "id": 322097,
                "login": "ZyX-I",
                "node_id": "MDQ6VXNlcjMyMjA5Nw==",
                "organizations_url": "https://api.github.com/users/ZyX-I/orgs",
                "received_events_url": "https://api.github.com/users/ZyX-I/received_events",
                "repos_url": "https://api.github.com/users/ZyX-I/repos",
                "site_admin": false,
                "starred_url": "https://api.github.com/users/ZyX-I/starred{/owner}{/repo}",
                "subscriptions_url": "https://api.github.com/users/ZyX-I/subscriptions",
                "type": "User",
                "url": "https://api.github.com/users/ZyX-I",
                "user_view_type": "public"
            }
        },
        {
            "author_association": "NONE",
            "body": "By the way, `imp.new_module` is deprecated since 3.4. Thus\n\n``` Diff\ndiff --git a/runtime/autoload/provider/script_host.py b/runtime/autoload/provider/script_host.py\nindex 1420831..df3906e 100644\n--- a/runtime/autoload/provider/script_host.py\n+++ b/runtime/autoload/provider/script_host.py\n@@ -4,6 +4,8 @@ import logging\n import os\n import sys\n\n+from types import ModuleType\n+\n import neovim\n\n __all__ = ('ScriptHost',)\n@@ -27,7 +29,8 @@ class ScriptHost(object):\n         \"\"\"Initialize the legacy python-vim environment.\"\"\"\n         self.setup(nvim)\n         # context where all code will run\n-        self.module = imp.new_module('__main__')\n+        self.module = ModuleType('__main__')\n+        sys.modules['__main__'] = self.module\n         nvim.script_context = self.module\n         # it seems some plugins assume 'sys' is already imported, so do it now\n         exec('import sys', self.module.__dict__)\n```\n\nThis works at least starting from Python-2.6.\n",
            "created_at": "2015-02-09T17:04:27Z",
            "html_url": "https://github.com/neovim/pynvim/issues/84#issuecomment-73546480",
            "id": 73546480,
            "issue_url": "https://api.github.com/repos/neovim/pynvim/issues/84",
            "node_id": "MDEyOklzc3VlQ29tbWVudDczNTQ2NDgw",
            "performed_via_github_app": null,
            "reactions": {
                "+1": 0,
                "-1": 0,
                "confused": 0,
                "eyes": 0,
                "heart": 0,
                "hooray": 0,
                "laugh": 0,
                "rocket": 0,
                "total_count": 0,
                "url": "https://api.github.com/repos/neovim/pynvim/issues/comments/73546480/reactions"
            },
            "updated_at": "2015-02-09T17:04:27Z",
            "url": "https://api.github.com/repos/neovim/pynvim/issues/comments/73546480",
            "user": {
                "avatar_url": "https://avatars.githubusercontent.com/u/322097?v=4",
                "events_url": "https://api.github.com/users/ZyX-I/events{/privacy}",
                "followers_url": "https://api.github.com/users/ZyX-I/followers",
                "following_url": "https://api.github.com/users/ZyX-I/following{/other_user}",
                "gists_url": "https://api.github.com/users/ZyX-I/gists{/gist_id}",
                "gravatar_id": "",
                "html_url": "https://github.com/ZyX-I",
                "id": 322097,
                "login": "ZyX-I",
                "node_id": "MDQ6VXNlcjMyMjA5Nw==",
                "organizations_url": "https://api.github.com/users/ZyX-I/orgs",
                "received_events_url": "https://api.github.com/users/ZyX-I/received_events",
                "repos_url": "https://api.github.com/users/ZyX-I/repos",
                "site_admin": false,
                "starred_url": "https://api.github.com/users/ZyX-I/starred{/owner}{/repo}",
                "subscriptions_url": "https://api.github.com/users/ZyX-I/subscriptions",
                "type": "User",
                "url": "https://api.github.com/users/ZyX-I",
                "user_view_type": "public"
            }
        },
        {
            "author_association": "NONE",
            "body": "And the whole `imp` thing is deprecated as well. But new replacements  for `find_module` and `load_module` are not that compatible.\n",
            "created_at": "2015-02-09T17:07:43Z",
            "html_url": "https://github.com/neovim/pynvim/issues/84#issuecomment-73547114",
            "id": 73547114,
            "issue_url": "https://api.github.com/repos/neovim/pynvim/issues/84",
            "node_id": "MDEyOklzc3VlQ29tbWVudDczNTQ3MTE0",
            "performed_via_github_app": null,
            "reactions": {
                "+1": 0,
                "-1": 0,
                "confused": 0,
                "eyes": 0,
                "heart": 0,
                "hooray": 0,
                "laugh": 0,
                "rocket": 0,
                "total_count": 0,
                "url": "https://api.github.com/repos/neovim/pynvim/issues/comments/73547114/reactions"
            },
            "updated_at": "2015-02-09T17:07:43Z",
            "url": "https://api.github.com/repos/neovim/pynvim/issues/comments/73547114",
            "user": {
                "avatar_url": "https://avatars.githubusercontent.com/u/322097?v=4",
                "events_url": "https://api.github.com/users/ZyX-I/events{/privacy}",
                "followers_url": "https://api.github.com/users/ZyX-I/followers",
                "following_url": "https://api.github.com/users/ZyX-I/following{/other_user}",
                "gists_url": "https://api.github.com/users/ZyX-I/gists{/gist_id}",
                "gravatar_id": "",
                "html_url": "https://github.com/ZyX-I",
                "id": 322097,
                "login": "ZyX-I",
                "node_id": "MDQ6VXNlcjMyMjA5Nw==",
                "organizations_url": "https://api.github.com/users/ZyX-I/orgs",
                "received_events_url": "https://api.github.com/users/ZyX-I/received_events",
                "repos_url": "https://api.github.com/users/ZyX-I/repos",
                "site_admin": false,
                "starred_url": "https://api.github.com/users/ZyX-I/starred{/owner}{/repo}",
                "subscriptions_url": "https://api.github.com/users/ZyX-I/subscriptions",
                "type": "User",
                "url": "https://api.github.com/users/ZyX-I",
                "user_view_type": "public"
            }
        }
    ],
    "comments": 4,
    "comments_url": "https://api.github.com/repos/neovim/pynvim/issues/84/comments",
    "created_at": "2015-02-08T17:06:52Z",
    "events_url": "https://api.github.com/repos/neovim/pynvim/issues/84/events",
    "html_url": "https://github.com/neovim/pynvim/issues/84",
    "id": 56958661,
    "issue_dependencies_summary": {
        "blocked_by": 0,
        "blocking": 0,
        "total_blocked_by": 0,
        "total_blocking": 0
    },
    "labels": [],
    "labels_url": "https://api.github.com/repos/neovim/pynvim/issues/84/labels{/name}",
    "locked": false,
    "milestone": null,
    "node_id": "MDU6SXNzdWU1Njk1ODY2MQ==",
    "number": 84,
    "performed_via_github_app": null,
    "reactions": {
        "+1": 0,
        "-1": 0,
        "confused": 0,
        "eyes": 0,
        "heart": 0,
        "hooray": 0,
        "laugh": 0,
        "rocket": 0,
        "total_count": 0,
        "url": "https://api.github.com/repos/neovim/pynvim/issues/84/reactions"
    },
    "repository_url": "https://api.github.com/repos/neovim/pynvim",
    "state": "open",
    "state_reason": null,
    "sub_issues_summary": {
        "completed": 0,
        "percent_completed": 0,
        "total": 0
    },
    "timeline_url": "https://api.github.com/repos/neovim/pynvim/issues/84/timeline",
    "title": "Code is run not in __main__ module",
    "type": {
        "color": "red",
        "created_at": "2024-01-25T10:10:19Z",
        "description": "An unexpected problem or behavior",
        "id": 597163,
        "is_enabled": true,
        "name": "Bug",
        "node_id": "IT_kwDOAGK_Pc4ACRyr",
        "updated_at": "2024-07-26T10:12:30Z"
    },
    "updated_at": "2025-09-22T19:35:53Z",
    "url": "https://api.github.com/repos/neovim/pynvim/issues/84",
    "user": {
        "avatar_url": "https://avatars.githubusercontent.com/u/322097?v=4",
        "events_url": "https://api.github.com/users/ZyX-I/events{/privacy}",
        "followers_url": "https://api.github.com/users/ZyX-I/followers",
        "following_url": "https://api.github.com/users/ZyX-I/following{/other_user}",
        "gists_url": "https://api.github.com/users/ZyX-I/gists{/gist_id}",
        "gravatar_id": "",
        "html_url": "https://github.com/ZyX-I",
        "id": 322097,
        "login": "ZyX-I",
        "node_id": "MDQ6VXNlcjMyMjA5Nw==",
        "organizations_url": "https://api.github.com/users/ZyX-I/orgs",
        "received_events_url": "https://api.github.com/users/ZyX-I/received_events",
        "repos_url": "https://api.github.com/users/ZyX-I/repos",
        "site_admin": false,
        "starred_url": "https://api.github.com/users/ZyX-I/starred{/owner}{/repo}",
        "subscriptions_url": "https://api.github.com/users/ZyX-I/subscriptions",
        "type": "User",
        "url": "https://api.github.com/users/ZyX-I",
        "user_view_type": "public"
    }
}