{
    "active_lock_reason": null,
    "assignee": null,
    "assignees": [],
    "author_association": "NONE",
    "body": "I'm profiling/debugging performance bottlenecks in the python client.\r\n\r\nTwo things stuck out so far.\r\n\r\n- ~~Calls to BufferedFormatter in logging, when logging was disabled. This can be fixed by gating any `debug()`, `warn()` etc calls behind an `if _debug` statement as shown in asyncio.~~ \r\n  - (**Edit:** fixed, see below)\r\n- `walk(to_nvim)` and `walk(from_nvim)` are extremely expensive calls on nested object trees. For example, if I have a 5000 line buffer and get/set the entire thing, these calls seem to account for at least 80% of the 20ms spent. I fixed this by adding the following functions on the `Remote` and `Nvim` classes and invoking it for `buf_get_lines` and `buf_set_lines` instead of request_raw:\r\n\r\n```\r\nclass Remote:\r\n    def request_raw(self, name, *args, **kwargs):\r\n        return self._session.request_raw(name, self._session._to_nvim(self), *args, **kwargs)\r\n\r\nclass Nvim:\r\n    def request_raw(self, name, *args, **kwargs):\r\n        return self._session.request(name, *args, **kwargs)\r\n```\r\n\r\nProfiling data generated with yappi on Python 3.3 and my test script are attached.\r\n[after.txt](https://github.com/neovim/python-client/files/811433/after.txt)\r\n[before.txt](https://github.com/neovim/python-client/files/811432/before.txt)\r\n\r\n```\r\nimport neovim\r\n\r\nsample = ['a'] * 10000\r\n\r\ndef setup():\r\n    n = neovim.attach('child', argv=['/Users/aegis/build/neovim/build/bin/nvim', '--embed'])\r\n    buf = n.current.buffer\r\n    buf[:] = sample\r\n    return buf\r\n\r\ndef bufeq(buf):\r\n    buf[:] = sample\r\n\r\ndef eqbuf(buf):\r\n    _ = buf[:]\r\n\r\nbuf = setup()\r\nfor i in range(10):\r\n    bufeq(buf)\r\n\r\nfor i in range(10):\r\n    eqbuf(buf)\r\n\r\nimport sys\r\nsys.exceptionhandler = lambda *a: 0\r\n```\r\n\r\n",
    "closed_at": "2025-01-08T01:46:00Z",
    "closed_by": {
        "avatar_url": "https://avatars.githubusercontent.com/u/1359421?v=4",
        "events_url": "https://api.github.com/users/justinmk/events{/privacy}",
        "followers_url": "https://api.github.com/users/justinmk/followers",
        "following_url": "https://api.github.com/users/justinmk/following{/other_user}",
        "gists_url": "https://api.github.com/users/justinmk/gists{/gist_id}",
        "gravatar_id": "",
        "html_url": "https://github.com/justinmk",
        "id": 1359421,
        "login": "justinmk",
        "node_id": "MDQ6VXNlcjEzNTk0MjE=",
        "organizations_url": "https://api.github.com/users/justinmk/orgs",
        "received_events_url": "https://api.github.com/users/justinmk/received_events",
        "repos_url": "https://api.github.com/users/justinmk/repos",
        "site_admin": false,
        "starred_url": "https://api.github.com/users/justinmk/starred{/owner}{/repo}",
        "subscriptions_url": "https://api.github.com/users/justinmk/subscriptions",
        "type": "User",
        "url": "https://api.github.com/users/justinmk",
        "user_view_type": "public"
    },
    "comment_data": [
        {
            "author_association": "MEMBER",
            "body": "ref: https://github.com/liuchengxu/vim-clap/commit/75eb77ec5b6c0263cbfb55a90865234a3eafbf3d#r36434357",
            "created_at": "2019-12-16T22:45:00Z",
            "html_url": "https://github.com/neovim/pynvim/issues/250#issuecomment-566281402",
            "id": 566281402,
            "issue_url": "https://api.github.com/repos/neovim/pynvim/issues/250",
            "node_id": "MDEyOklzc3VlQ29tbWVudDU2NjI4MTQwMg==",
            "performed_via_github_app": null,
            "reactions": {
                "+1": 0,
                "-1": 0,
                "confused": 0,
                "eyes": 0,
                "heart": 0,
                "hooray": 0,
                "laugh": 0,
                "rocket": 0,
                "total_count": 0,
                "url": "https://api.github.com/repos/neovim/pynvim/issues/comments/566281402/reactions"
            },
            "updated_at": "2019-12-16T22:45:00Z",
            "url": "https://api.github.com/repos/neovim/pynvim/issues/comments/566281402",
            "user": {
                "avatar_url": "https://avatars.githubusercontent.com/u/1359421?v=4",
                "events_url": "https://api.github.com/users/justinmk/events{/privacy}",
                "followers_url": "https://api.github.com/users/justinmk/followers",
                "following_url": "https://api.github.com/users/justinmk/following{/other_user}",
                "gists_url": "https://api.github.com/users/justinmk/gists{/gist_id}",
                "gravatar_id": "",
                "html_url": "https://github.com/justinmk",
                "id": 1359421,
                "login": "justinmk",
                "node_id": "MDQ6VXNlcjEzNTk0MjE=",
                "organizations_url": "https://api.github.com/users/justinmk/orgs",
                "received_events_url": "https://api.github.com/users/justinmk/received_events",
                "repos_url": "https://api.github.com/users/justinmk/repos",
                "site_admin": false,
                "starred_url": "https://api.github.com/users/justinmk/starred{/owner}{/repo}",
                "subscriptions_url": "https://api.github.com/users/justinmk/subscriptions",
                "type": "User",
                "url": "https://api.github.com/users/justinmk",
                "user_view_type": "public"
            }
        },
        {
            "author_association": "MEMBER",
            "body": "> This can be fixed by gating any `debug()`, `warn()` etc calls behind an `if _debug` statement as shown in asyncio.\r\n\r\n@lunixbochs logging is now removed in the \"dist\" package (i.e. what we publish to pypi), try Pynvim 0.4.1. https://github.com/neovim/pynvim/commit/dd45f83c798fcb5bbb5be4a0843f6e0b47e06bd0\r\n\r\n",
            "created_at": "2020-01-25T22:48:06Z",
            "html_url": "https://github.com/neovim/pynvim/issues/250#issuecomment-578450211",
            "id": 578450211,
            "issue_url": "https://api.github.com/repos/neovim/pynvim/issues/250",
            "node_id": "MDEyOklzc3VlQ29tbWVudDU3ODQ1MDIxMQ==",
            "performed_via_github_app": null,
            "reactions": {
                "+1": 0,
                "-1": 0,
                "confused": 0,
                "eyes": 0,
                "heart": 0,
                "hooray": 0,
                "laugh": 0,
                "rocket": 0,
                "total_count": 0,
                "url": "https://api.github.com/repos/neovim/pynvim/issues/comments/578450211/reactions"
            },
            "updated_at": "2020-01-25T22:48:34Z",
            "url": "https://api.github.com/repos/neovim/pynvim/issues/comments/578450211",
            "user": {
                "avatar_url": "https://avatars.githubusercontent.com/u/1359421?v=4",
                "events_url": "https://api.github.com/users/justinmk/events{/privacy}",
                "followers_url": "https://api.github.com/users/justinmk/followers",
                "following_url": "https://api.github.com/users/justinmk/following{/other_user}",
                "gists_url": "https://api.github.com/users/justinmk/gists{/gist_id}",
                "gravatar_id": "",
                "html_url": "https://github.com/justinmk",
                "id": 1359421,
                "login": "justinmk",
                "node_id": "MDQ6VXNlcjEzNTk0MjE=",
                "organizations_url": "https://api.github.com/users/justinmk/orgs",
                "received_events_url": "https://api.github.com/users/justinmk/received_events",
                "repos_url": "https://api.github.com/users/justinmk/repos",
                "site_admin": false,
                "starred_url": "https://api.github.com/users/justinmk/starred{/owner}{/repo}",
                "subscriptions_url": "https://api.github.com/users/justinmk/subscriptions",
                "type": "User",
                "url": "https://api.github.com/users/justinmk",
                "user_view_type": "public"
            }
        }
    ],
    "comments": 2,
    "comments_url": "https://api.github.com/repos/neovim/pynvim/issues/250/comments",
    "created_at": "2017-03-01T16:55:35Z",
    "events_url": "https://api.github.com/repos/neovim/pynvim/issues/250/events",
    "html_url": "https://github.com/neovim/pynvim/issues/250",
    "id": 211142698,
    "labels": [
        {
            "color": "c2e0c6",
            "default": true,
            "description": null,
            "id": 97892278,
            "name": "enhancement",
            "node_id": "MDU6TGFiZWw5Nzg5MjI3OA==",
            "url": "https://api.github.com/repos/neovim/pynvim/labels/enhancement"
        }
    ],
    "labels_url": "https://api.github.com/repos/neovim/pynvim/issues/250/labels{/name}",
    "locked": false,
    "milestone": null,
    "node_id": "MDU6SXNzdWUyMTExNDI2OTg=",
    "number": 250,
    "performed_via_github_app": null,
    "reactions": {
        "+1": 0,
        "-1": 0,
        "confused": 0,
        "eyes": 0,
        "heart": 0,
        "hooray": 0,
        "laugh": 0,
        "rocket": 0,
        "total_count": 0,
        "url": "https://api.github.com/repos/neovim/pynvim/issues/250/reactions"
    },
    "repository_url": "https://api.github.com/repos/neovim/pynvim",
    "state": "closed",
    "state_reason": "completed",
    "sub_issues_summary": {
        "completed": 0,
        "percent_completed": 0,
        "total": 0
    },
    "timeline_url": "https://api.github.com/repos/neovim/pynvim/issues/250/timeline",
    "title": "performance issues",
    "updated_at": "2025-01-08T01:46:01Z",
    "url": "https://api.github.com/repos/neovim/pynvim/issues/250",
    "user": {
        "avatar_url": "https://avatars.githubusercontent.com/u/117642?v=4",
        "events_url": "https://api.github.com/users/lunixbochs/events{/privacy}",
        "followers_url": "https://api.github.com/users/lunixbochs/followers",
        "following_url": "https://api.github.com/users/lunixbochs/following{/other_user}",
        "gists_url": "https://api.github.com/users/lunixbochs/gists{/gist_id}",
        "gravatar_id": "",
        "html_url": "https://github.com/lunixbochs",
        "id": 117642,
        "login": "lunixbochs",
        "node_id": "MDQ6VXNlcjExNzY0Mg==",
        "organizations_url": "https://api.github.com/users/lunixbochs/orgs",
        "received_events_url": "https://api.github.com/users/lunixbochs/received_events",
        "repos_url": "https://api.github.com/users/lunixbochs/repos",
        "site_admin": false,
        "starred_url": "https://api.github.com/users/lunixbochs/starred{/owner}{/repo}",
        "subscriptions_url": "https://api.github.com/users/lunixbochs/subscriptions",
        "type": "User",
        "url": "https://api.github.com/users/lunixbochs",
        "user_view_type": "public"
    }
}